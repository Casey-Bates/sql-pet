# Simple queries (11)

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
# These packages are called in almost every chapter of the book:
library(tidyverse)
library(DBI)
library(RPostgres)
library(glue)
library(here)
require(knitr)
library(dbplyr)
library(sqlpetr)
library(bookdown)
MODE <- 'BOOK' # Either DEMO or BOOK
```
Assume that the Docker container with PostgreSQL and the dvdrental database are ready to go. 
```{r}
sp_docker_start("sql-pet")
```
Connect to the database:
```{r}
con <- sp_get_postgres_connection(user = Sys.getenv("DEFAULT_POSTGRES_USER_NAME"),
                         password = Sys.getenv("DEFAULT_POSTGRES_PASSWORD"),
                         dbname = "dvdrental",
                         seconds_to_test = 10)

```

## Some extra handy libraries

https://dbplyr.tidyverse.org/articles/sql-translation.html 

Here are some packages that we find handy in the preliminary investigation of a database (or a problem that involves data from a database).
```{r}
library(glue)
library(skimr)
library(DT)
```

## Basic investigation

We've already seen the simplest way of getting a list of tables in a database with `DBI` functions to list tables and fields:
```{r}
DBI::dbListTables(con)

DBI::dbListFields(con, "rental")

```

### Using `dplyr` as the main tool

methods for referencing a table

```{r}
rental_table <- tbl(con, "rental")  # requires collect() function
rental_tibble <- dbReadTable(con, "rental") # downloads the whole table into a data frame
```


We already started, but that's OK.

### Other R tools for data investigation
  + str
  + glimpse
  + skimr
  + View, datatable and kable

```{r}
str(rental_tibble)
glimpse(rental_tibble)
skim(rental_tibble)
```


### Finding out what's in the database

#### List the tables and fields that are available

#### ERD Diagram

This tutorial uses [the Postgres version of "dvd rental" database](http://www.postgresqltutorial.com/postgresql-sample-database/), which can be  [downloaded here](http://www.postgresqltutorial.com/wp-content/uploads/2017/10/dvdrental.zip).  Here's a glimpse of it's structure:
    
![Entity Relationship diagram for the dvdrental database](./screenshots/dvdrental-er-diagram.png)


### Sample query

* rental 
* date subset

### Subset: only retrieve what you need

* Columns
* Rows
  + number of row
  + specific rows
* Counts & stats

### Make the server do as much work as you can

discuss this simple example? http://www.postgresqltutorial.com/postgresql-left-join/ 

* `dplyr` joins on the server side
* Where you put `(collect(n = Inf))` really matters

## What is `dplyr` sending to the server?

* show_query as a first draft

## Writing SQL queries directly to the DBMS

* dbquery
* Glue for constructing SQL statements
  + parameterizing SQL queries

## Choosing between `dplyr` and native SQL

* performance considerations: first get the right data, then worry about performance
* Trade offs between leaving the data in PostgreSQL vs what's kept in R: 
  + browsing the data
  + larger samples and complete tables
  + using what you know to write efficient queries that do most of the work on the server
----
```{r}
dplyr_summary_df <-
    read.delim(
    '11-dplyr_sql_summary_table.tsv',
    header = TRUE,
    sep = '\t',
    as.is = TRUE
    )

if (MODE == 'DEMO') {
    View(dplyr_summary_df)
} else {
    kable(head(dplyr_summary_df))
    # DT::datatable(dplyr_summary_df)  # a very nice display in some cases, but not in a PDF
}    
```

----
* left join staff
* left join customer

* dplyr joins in the R
```{r}
sp_docker_stop("sql-pet")
```

## Other resources

* Tutorials like: https://suzan.rbind.io/tags/dplyr/ 
* Benjamin S. Baumer, A Grammar for Reproducible and Painless Extract-Transform-Load Operations on Medium Data: https://arxiv.org/pdf/1708.07073 
