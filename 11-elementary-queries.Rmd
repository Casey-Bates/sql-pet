# Simple queries (11)

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
# These packages are called in almost every chapter of the book:
library(tidyverse)
library(DBI)
library(RPostgres)
library(glue)
library(here)
require(knitr)
library(dbplyr)
library(sqlpetr)
library(bookdown)
```
Assume that the Docker container with PostgreSQL and the dvdrental database are ready to go. 
```{r}
sp_docker_start("sql-pet")
```
Connect to the database:
```{r}
con <- sp_get_postgres_connection(user = Sys.getenv("DEFAULT_POSTGRES_USER_NAME"),
                         password = Sys.getenv("DEFAULT_POSTGRES_PASSWORD"),
                         dbname = "dvdrental",
                         seconds_to_test = 10)

```

## Downloading the data from the database

We've already seen the simplest way of getting a list of tables in a database with `DBI` functions to list tables and fields:
```{r}
DBI::dbListTables(con)

```
Later on we'll discuss how to get more extensive data about each table from the database's own store of metadata.


List the fields in a specific table:
```{r}
DBI::dbListFields(con, "rental")

```

### Using `dplyr` as the main tool

methods for referencing a table

`DBI::dbReadTable` will download an entire table into an R data frame.
```{r}

rental_tibble <- DBI::dbReadTable(con, "rental") 
str(rental_tibble)
```

### Adventures in lazy evaluation
```{r}
rental_table <- dplyr::tbl(con, "rental")  # requires collect() function
str(rental_table)

head(rental_table)
```

```{r}
rental_table %>% 
  count(staff_id, inventory_id) %>% 
  head

rental_table %>% 
  count(staff_id, inventory_id) %>% 
  show_query()


```

We already started, but that's OK.

### Other R tools for data investigation
  + str
  + glimpse
  + skimr
  + View, datatable and kable

## Some extra handy libraries

[https://dbplyr.tidyverse.org/articles/sql-translation.html](https://dbplyr.tidyverse.org/articles/sql-translation.html) 

Here are some packages that we find handy in the preliminary investigation of a database (or a problem that involves data from a database).
```{r}
library(glue)
library(skimr)
```


```{r}
str(rental_tibble)
glimpse(rental_tibble)
skim(rental_tibble)
```


### Finding out what's in the database

#### List the tables and fields that are available

#### ERD Diagram

This tutorial uses [the Postgres version of "dvd rental" database](http://www.postgresqltutorial.com/postgresql-sample-database/), which can be  [downloaded here](http://www.postgresqltutorial.com/wp-content/uploads/2017/10/dvdrental.zip).  Here's a glimpse of it's structure:
    
![Entity Relationship diagram for the dvdrental database](./screenshots/dvdrental-er-diagram.png)


### Sample query

* rental 
* date subset

### Subset: only retrieve what you need

* Columns
* Rows
  + number of row
  + specific rows
* Counts & stats

### Make the server do as much work as you can

discuss this simple example? http://www.postgresqltutorial.com/postgresql-left-join/ 

* `dplyr` joins on the server side
* Where you put `(collect(n = Inf))` really matters

## What is `dplyr` sending to the server?

* show_query as a first draft

## Writing SQL queries directly to the DBMS

* dbquery
* Glue for constructing SQL statements
  + parameterizing SQL queries

## Choosing between `dplyr` and native SQL

* performance considerations: first get the right data, then worry about performance
* Trade offs between leaving the data in PostgreSQL vs what's kept in R: 
  + browsing the data
  + larger samples and complete tables
  + using what you know to write efficient queries that do most of the work on the server


```{r}
dplyr_summary_df <-
    read.delim(
    '11-dplyr_sql_summary_table.tsv',
    header = TRUE,
    sep = '\t',
    as.is = TRUE
    )

head(dplyr_summary_df)

```


  * left join staff
  * left join customer

  * dplyr joins in the R
```{r}
dbDisconnect(con)
sp_docker_stop("sql-pet")
```

## Other resources

  * Tutorials like: [https://suzan.rbind.io/tags/dplyr/](https://suzan.rbind.io/tags/dplyr/) 
  * Benjamin S. Baumer, A Grammar for Reproducible and Painless Extract-Transform-Load Operations on Medium Data: [https://arxiv.org/pdf/1708.07073](https://arxiv.org/pdf/1708.07073) 

