---
title: "Docker postgress test"
author: "John D. Smith"
date: "7/19/2018"
output: html_document
---

Trying to improve upon:
  https://github.com/Cascadia-R/Using_R_With_Databases/blob/master/Intro_To_R_With_Databases.Rmd

Using tips provided by Noam Ross:
  https://github.com/noamross/nyhackr-docker-talk

Install stevedore with:
  devtools::install_github("richfitz/stevedore", upgrade_dependencies = FALSE)
  
General documentation is here:
  https://richfitz.github.io/stevedore/articles/stevedore.html

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(DBI)
library(RPostgres)
```

This demonstrates connecting, reading and writing to postgres -- using the default database.

Most useful if you run a line or two at a time, rather than the chunks in their entirety.

```{r}
# First bring up the docker container with Postgres running in it

system("docker-compose up -d")
```

Connect with Postgres
 
```{r}
con <- DBI::dbConnect(RPostgres::Postgres(),
                      host = "localhost",
                      port = "5432",
                      user = "postgres",
                      password = "postgres")

# At first Postgres won't contain any tables:
dbListTables(con)

dbWriteTable(con, "mtcars", mtcars)

dbListTables(con)

# demonstrate that mtcars is really there:
dbListFields(con, "mtcars")
dbReadTable(con, "mtcars")

# be sure to disconnect from Postgres before shutting down
dbDisconnect(con)

# close down the Docker container
system("docker-compose stop")

```

Now verify that tables persist in the Postgres database when Docker has shut down and then started up.
```{r}
# Bring up Docker-compose and Postgres:

system("docker-compose up -d")
```

Connect to Postgres
```{r}

con <- DBI::dbConnect(RPostgres::Postgres(),
                      host = "localhost",
                      port = "5432",
                      user = "postgres",
                      password = "postgres")

# Postgres should still have mtcars in it:
dbListTables(con)

# Might as well delete mtcars, since there are enough copies of it in the world.
dbRemoveTable(con, "mtcars")
dbExistsTable(con, "mtcars")

dbDisconnect(con)
system("docker-compose stop")
```
