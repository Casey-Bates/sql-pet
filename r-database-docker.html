<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>R, Databases, and Docker</title>
  <meta name="description" content="An introduction to Docker and PostgreSQL for R users to simulate use cases behind corporate walls.">
  <meta name="generator" content="bookdown <!--bookdown:version--> and GitBook 2.6.7">

  <meta property="og:title" content="R, Databases, and Docker" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="An introduction to Docker and PostgreSQL for R users to simulate use cases behind corporate walls." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="R, Databases, and Docker" />
  
  <meta name="twitter:description" content="An introduction to Docker and PostgreSQL for R users to simulate use cases behind corporate walls." />
  

<meta name="author" content="John David Smith, Sophie Yang, M. Edward (Ed) Borasky, Jim Tyhurst, Scott Came, Mary Anne Thygesen, Ian Frantz, and Dipti Muni">


<meta name="date" content="2019-03-03">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<!--bookdown:link_prev-->
<!--bookdown:link_next-->
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/htmlwidgets-1.3/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.5/datatables.js"></script>
<link href="libs/dt-core-1.10.16/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.16/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.16/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.0.0/js/crosstalk.min.js"></script>
<script src="libs/viz-0.3/viz.js"></script>
<link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet" />
<script src="libs/grViz-binding-1.0.0/grViz.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



<!--bookdown:title:start-->
<div id="header">
<h1 class="title">R, Databases, and Docker</h1>
<p class="author"><em>John David Smith, Sophie Yang, M. Edward (Ed) Borasky, Jim Tyhurst, Scott Came, Mary Anne Thygesen, Ian Frantz, and Dipti Muni</em></p>
<p class="date"><em>2019-03-03</em></p>
</div>
<!--bookdown:title:end-->

<!--bookdown:toc:start-->
  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">
<!--bookdown:toc2:start-->
<ul>
<li><a href="#chapter_introduction"><span class="toc-section-number">1</span> Introduction</a><ul>
<li><a href="#using-r-to-query-a-dbms-in-your-organization"><span class="toc-section-number">1.1</span> Using R to query a DBMS in your organization</a></li>
<li><a href="#docker-as-a-tool-for-users"><span class="toc-section-number">1.2</span> Docker as a tool for UseRs</a></li>
<li><a href="#who-are-we"><span class="toc-section-number">1.3</span> Who are we?</a></li>
<li><a href="#how-did-this-project-come-about"><span class="toc-section-number">1.4</span> How did this project come about?</a></li>
<li><a href="#navigation"><span class="toc-section-number">1.5</span> Navigation</a></li>
</ul></li>
<li><a href="#chapter_basic-concepts"><span class="toc-section-number">2</span> Basic Concepts</a><ul>
<li><a href="#the-big-picture-r-and-the-docker-postgresql-playground-on-your-machine"><span class="toc-section-number">2.1</span> The big picture: R and the Docker / PostgreSQL playground on your machine</a></li>
<li><a href="#your-computer-and-its-operating-system"><span class="toc-section-number">2.2</span> Your computer and its operating system</a></li>
<li><a href="#r"><span class="toc-section-number">2.3</span> R</a></li>
<li><a href="#our-sqlpetr-package"><span class="toc-section-number">2.4</span> Our <code>sqlpetr</code> package</a></li>
<li><a href="#docker"><span class="toc-section-number">2.5</span> Docker</a><ul>
<li><a href="#virtual-machines-and-hypervisors"><span class="toc-section-number">2.5.1</span> Virtual machines and hypervisors</a></li>
<li><a href="#containers"><span class="toc-section-number">2.5.2</span> Containers</a></li>
<li><a href="#docker-itself"><span class="toc-section-number">2.5.3</span> Docker itself</a></li>
<li><a href="#docker-objects"><span class="toc-section-number">2.5.4</span> Docker objects</a></li>
<li><a href="#hosting-docker-on-windows-machines"><span class="toc-section-number">2.5.5</span> Hosting Docker on Windows machines</a></li>
<li><a href="#hosting-docker-on-macos-machines"><span class="toc-section-number">2.5.6</span> Hosting Docker on macOS machines</a></li>
<li><a href="#hosting-docker-on-unix-machines"><span class="toc-section-number">2.5.7</span> Hosting Docker on UNIX machines</a></li>
</ul></li>
<li><a href="#normal-and-normalized-data"><span class="toc-section-number">2.6</span> ‘Normal’ and ‘normalized’ data</a><ul>
<li><a href="#tidy-data"><span class="toc-section-number">2.6.1</span> Tidy data</a></li>
<li><a href="#design-of-normal-data"><span class="toc-section-number">2.6.2</span> Design of “normal data”</a></li>
</ul></li>
<li><a href="#organizational-dbms"><span class="toc-section-number">2.7</span> Organizational dbms</a></li>
<li><a href="#sql"><span class="toc-section-number">2.8</span> SQL</a><ul>
<li><a href="#data-mapping-between-r-vs-sql-data-types"><span class="toc-section-number">2.8.1</span> Data mapping between R vs SQL data types</a></li>
<li><a href="#postgresql-and-connection-parameters"><span class="toc-section-number">2.8.2</span> PostgreSQL and connection parameters</a></li>
</ul></li>
</ul></li>
<li><a href="#chapter_how-to-use-this-book"><span class="toc-section-number">3</span> How to use this book</a><ul>
<li><a href="#retrieve-the-code-from-github"><span class="toc-section-number">3.1</span> Retrieve the code from GitHub</a></li>
<li><a href="#read-along-experiment-as-you-go"><span class="toc-section-number">3.2</span> Read along, experiment as you go</a></li>
<li><a href="#participating"><span class="toc-section-number">3.3</span> Participating</a><ul>
<li><a href="#browsing-the-book"><span class="toc-section-number">3.3.1</span> Browsing the book</a></li>
<li><a href="#diving-in"><span class="toc-section-number">3.3.2</span> Diving in</a></li>
</ul></li>
</ul></li>
<li><a href="#chapter_learning-goals"><span class="toc-section-number">4</span> Learning Goals and Use Cases</a><ul>
<li><a href="#ask-yourself-what-are-you-aiming-for"><span class="toc-section-number">4.1</span> Ask yourself, what are you aiming for?</a></li>
<li><a href="#learning-goals"><span class="toc-section-number">4.2</span> Learning Goals</a></li>
<li><a href="#imagining-a-dvd-rental-business"><span class="toc-section-number">4.3</span> Imagining a DVD rental business</a></li>
<li><a href="#use-cases"><span class="toc-section-number">4.4</span> Use cases</a></li>
<li><a href="#investigating-a-question-using-an-organizations-database"><span class="toc-section-number">4.5</span> Investigating a question using an organization’s database</a></li>
</ul></li>
<li><a href="#chapter_connect-docker-postgresql-r"><span class="toc-section-number">5</span> Connecting Docker, PostgreSQL, and R</a><ul>
<li><a href="#verify-that-docker-is-running"><span class="toc-section-number">5.1</span> Verify that Docker is running</a><ul>
<li><a href="#check-that-docker-is-up-and-running"><span class="toc-section-number">5.1.1</span> Check that Docker is up and running</a></li>
</ul></li>
<li><a href="#remove-previous-containers-if-they-exist"><span class="toc-section-number">5.2</span> Remove previous containers if they exist</a></li>
<li><a href="#connecting-reading-and-writing-to-postgresql-from-r"><span class="toc-section-number">5.3</span> Connecting, reading and writing to PostgreSQL from R</a><ul>
<li><a href="#connecting-to-postgresql"><span class="toc-section-number">5.3.1</span> Connecting to PostgreSQL</a></li>
<li><a href="#interact-with-postgresql"><span class="toc-section-number">5.3.2</span> Interact with PostgreSQL</a></li>
</ul></li>
<li><a href="#clean-up"><span class="toc-section-number">5.4</span> Clean up</a></li>
</ul></li>
<li><a href="#chapter_setup-dvdrental-db"><span class="toc-section-number">6</span> Create the dvdrental database in PostgreSQL in Docker</a><ul>
<li><a href="#overview"><span class="toc-section-number">6.1</span> Overview</a></li>
<li><a href="#verify-that-docker-is-up-and-running"><span class="toc-section-number">6.2</span> Verify that Docker is up and running</a></li>
<li><a href="#clean-up-if-appropriate"><span class="toc-section-number">6.3</span> Clean up if appropriate</a></li>
<li><a href="#build-the-pet-sql-docker-image"><span class="toc-section-number">6.4</span> Build the pet-sql Docker image</a></li>
<li><a href="#run-the-pet-sql-docker-image"><span class="toc-section-number">6.5</span> Run the pet-sql Docker Image</a></li>
<li><a href="#connect-to-postgresql-with-r"><span class="toc-section-number">6.6</span> Connect to PostgreSQL with R</a></li>
<li><a href="#stop-and-start-to-demonstrate-persistence"><span class="toc-section-number">6.7</span> Stop and start to demonstrate persistence</a></li>
<li><a href="#cleaning-up"><span class="toc-section-number">6.8</span> Cleaning up</a></li>
<li><a href="#using-the-sql-pet-container-in-the-rest-of-the-book"><span class="toc-section-number">6.9</span> Using the <code>sql-pet</code> container in the rest of the book</a></li>
</ul></li>
<li><a href="#chapter_dbms-login-credentials"><span class="toc-section-number">7</span> Securing and using your dbms log-in credentials</a><ul>
<li><a href="#set-up-the-sql-pet-docker-container"><span class="toc-section-number">7.1</span> Set up the sql-pet Docker container</a><ul>
<li><a href="#verify-that-docker-is-running-1"><span class="toc-section-number">7.1.1</span> Verify that Docker is running</a></li>
<li><a href="#start-the-docker-container"><span class="toc-section-number">7.1.2</span> Start the Docker container:</a></li>
</ul></li>
<li><a href="#storing-your-dbms-credentials"><span class="toc-section-number">7.2</span> Storing your dbms credentials</a><ul>
<li><a href="#connect-with-postgres-using-the-sys.getenv-function"><span class="toc-section-number">7.2.1</span> Connect with Postgres using the Sys.getenv function</a></li>
</ul></li>
<li><a href="#clean-up-1"><span class="toc-section-number">7.3</span> Clean up</a></li>
</ul></li>
<li><a href="#chapter_your-local-environment"><span class="toc-section-number">8</span> Mapping your local environment</a><ul>
<li><a href="#set-up-our-standard-pet-sql-environment"><span class="toc-section-number">8.1</span> Set up our standard pet-sql environment</a></li>
<li><a href="#sandbox-environment"><span class="toc-section-number">8.2</span> Sandbox Environment</a><ul>
<li><a href="#sandbox-entities-and-their-roles"><span class="toc-section-number">8.2.1</span> Sandbox entities and their roles</a></li>
<li><a href="#rstudio"><span class="toc-section-number">8.2.2</span> RStudio</a></li>
<li><a href="#os-local-command-line-interface"><span class="toc-section-number">8.2.3</span> OS / local command line interface</a></li>
<li><a href="#r-1"><span class="toc-section-number">8.2.4</span> R</a></li>
<li><a href="#docker-client"><span class="toc-section-number">8.2.5</span> Docker client</a></li>
<li><a href="#in-docker-linux"><span class="toc-section-number">8.2.6</span> In Docker: Linux</a></li>
<li><a href="#in-docker-psql"><span class="toc-section-number">8.2.7</span> In Docker: <code>psql</code></a></li>
<li><a href="#in-docker-postgresql"><span class="toc-section-number">8.2.8</span> In Docker: <code>PostgreSQL</code></a></li>
</ul></li>
<li><a href="#getting-there-from-here-entity-connections-equivalence-and-commands"><span class="toc-section-number">8.3</span> Getting there from here: entity connections, equivalence, and commands</a><ul>
<li><a href="#get-info-on-a-local-file-from-r-code"><span class="toc-section-number">8.3.1</span> Get info on a local file from R code</a></li>
<li><a href="#get-info-on-the-same-os-file-inside-docker-from-r-code"><span class="toc-section-number">8.3.2</span> Get info on the same OS file inside Docker from R Code</a></li>
<li><a href="#docker-and-psql-together-from-r-or-your-cli"><span class="toc-section-number">8.3.3</span> Docker and psql together from R or your CLI</a></li>
<li><a href="#nesting-commands-illustrates-how-entities-are-connected"><span class="toc-section-number">8.3.4</span> Nesting commands illustrates how entities are connected</a></li>
</ul></li>
<li><a href="#exercises"><span class="toc-section-number">8.4</span> Exercises</a></li>
</ul></li>
<li><a href="#chapter_dbms-queries-intro"><span class="toc-section-number">9</span> Introduction to DBMS queries</a><ul>
<li><a href="#setup"><span class="toc-section-number">9.1</span> Setup</a></li>
<li><a href="#getting-data-from-the-database"><span class="toc-section-number">9.2</span> Getting data from the database</a><ul>
<li><a href="#finding-out-whats-there"><span class="toc-section-number">9.2.1</span> Finding out what’s there</a></li>
<li><a href="#listing-all-the-fields-for-all-the-tables"><span class="toc-section-number">9.2.2</span> Listing all the fields for all the tables</a></li>
<li><a href="#downloading-an-entire-table"><span class="toc-section-number">9.2.3</span> Downloading an entire table</a></li>
<li><a href="#a-table-object-that-can-be-reused"><span class="toc-section-number">9.2.4</span> A table object that can be reused</a></li>
<li><a href="#controlling-the-number-of-rows-returned"><span class="toc-section-number">9.2.5</span> Controlling the number of rows returned</a></li>
<li><a href="#random-rows-from-the-dbms"><span class="toc-section-number">9.2.6</span> Random rows from the dbms</a></li>
<li><a href="#sub-setting-variables"><span class="toc-section-number">9.2.7</span> Sub-setting variables</a></li>
<li><a href="#translating-dplyr-code-to-sql-queries"><span class="toc-section-number">9.2.8</span> Translating <code>dplyr</code> code to <code>SQL</code> queries</a></li>
</ul></li>
<li><a href="#mixing-dplyr-and-sql"><span class="toc-section-number">9.3</span> Mixing dplyr and SQL</a></li>
<li><a href="#examining-a-single-table-with-r"><span class="toc-section-number">9.4</span> Examining a single table with R</a><ul>
<li><a href="#str---a-base-package-workhorse"><span class="toc-section-number">9.4.1</span> <code>str</code> - a base package workhorse</a></li>
<li><a href="#always-look-at-your-data-with-head-view-or-kable"><span class="toc-section-number">9.4.2</span> Always <strong>look</strong> at your data with <code>head</code>, <code>View</code>, or <code>kable</code></a></li>
<li><a href="#the-summary-function-in-base"><span class="toc-section-number">9.4.3</span> The <code>summary</code> function in <code>base</code></a></li>
<li><a href="#the-glimpse-function-in-the-tibble-package"><span class="toc-section-number">9.4.4</span> The <code>glimpse</code> function in the <code>tibble</code> package</a></li>
<li><a href="#the-skim-function-in-the-skimr-package"><span class="toc-section-number">9.4.5</span> The <code>skim</code> function in the <code>skimr</code> package</a></li>
<li><a href="#close-the-connection-and-shut-down-sql-pet"><span class="toc-section-number">9.4.6</span> Close the connection and shut down sql-pet</a></li>
</ul></li>
<li><a href="#additional-reading"><span class="toc-section-number">9.5</span> Additional reading</a></li>
</ul></li>
<li><a href="#chapter_lazy-evaluation-queries"><span class="toc-section-number">10</span> Lazy Evaluation and Lazy Queries</a><ul>
<li><a href="#setup-1"><span class="toc-section-number">10.1</span> Setup</a></li>
<li><a href="#r-is-lazy-and-comes-with-guardrails"><span class="toc-section-number">10.2</span> R is lazy and comes with guardrails</a><ul>
<li><a href="#lazy-loading"><span class="toc-section-number">10.2.1</span> Lazy loading</a></li>
<li><a href="#lazy-evaluation"><span class="toc-section-number">10.2.2</span> Lazy evaluation</a></li>
<li><a href="#lazy-queries"><span class="toc-section-number">10.2.3</span> Lazy Queries</a></li>
</ul></li>
<li><a href="#lazy-evaluation-and-lazy-queries"><span class="toc-section-number">10.3</span> Lazy evaluation and lazy queries</a><ul>
<li><a href="#dplyr-connection-objects"><span class="toc-section-number">10.3.1</span> <code>dplyr</code> connection objects</a></li>
</ul></li>
<li><a href="#when-does-a-lazy-query-trigger-data-retrieval"><span class="toc-section-number">10.4</span> When does a lazy query trigger data retrieval?</a><ul>
<li><a href="#create-a-black-box-query-for-experimentation"><span class="toc-section-number">10.4.1</span> Create a black box query for experimentation</a></li>
<li><a href="#experiment-overview"><span class="toc-section-number">10.4.2</span> Experiment overview</a></li>
<li><a href="#lazy_q_print"><span class="toc-section-number">10.4.3</span> Q %&gt;% print()</a></li>
<li><a href="#lazy_q_as-tibble"><span class="toc-section-number">10.4.4</span> Q %&gt;% dplyr::as_tibble()</a></li>
<li><a href="#lazy_q_head"><span class="toc-section-number">10.4.5</span> Q %&gt;% head()</a></li>
<li><a href="#lazy_q_tail"><span class="toc-section-number">10.4.6</span> Q %&gt;% tail()</a></li>
<li><a href="#lazy_q_length"><span class="toc-section-number">10.4.7</span> Q %&gt;% length()</a></li>
<li><a href="#lazy_q_str"><span class="toc-section-number">10.4.8</span> Q %&gt;% str()</a></li>
<li><a href="#lazy_q_nrow"><span class="toc-section-number">10.4.9</span> Q %&gt;% nrow()</a></li>
<li><a href="#lazy_q_tally"><span class="toc-section-number">10.4.10</span> Q %&gt;% dplyr::tally()</a></li>
<li><a href="#lazy_q_collect"><span class="toc-section-number">10.4.11</span> Q %&gt;% dplyr::collect()</a></li>
<li><a href="#lazy_q_show-query"><span class="toc-section-number">10.4.12</span> Q %&gt;% dplyr::show_query()</a></li>
<li><a href="#lazy_q_build"><span class="toc-section-number">10.4.13</span> Qc &lt;- Q %&gt;% dplyr::count(customer_email)</a></li>
</ul></li>
<li><a href="#other-resources"><span class="toc-section-number">10.5</span> Other resources</a></li>
</ul></li>
<li><a href="#chapter_dbi-package-sql"><span class="toc-section-number">11</span> DBI package and SQL</a><ul>
<li><a href="#setup-2"><span class="toc-section-number">11.1</span> Setup</a></li>
<li><a href="#sql-in-r-markdown"><span class="toc-section-number">11.2</span> SQL in R Markdown</a></li>
<li><a href="#dbi-package"><span class="toc-section-number">11.3</span> DBI Package</a><ul>
<li><a href="#retrieve-the-whole-table"><span class="toc-section-number">11.3.1</span> Retrieve the whole table</a></li>
<li><a href="#or-a-chunk-at-a-time"><span class="toc-section-number">11.3.2</span> Or a chunk at a time</a></li>
</ul></li>
<li><a href="#dividing-the-work-between-r-on-your-machine-and-the-dbms"><span class="toc-section-number">11.4</span> Dividing the work between R on your machine and the DBMS</a><ul>
<li><a href="#make-the-server-do-as-much-work-as-you-can"><span class="toc-section-number">11.4.1</span> Make the server do as much work as you can</a></li>
<li><a href="#criteria-for-choosing-between-dplyr-and-native-sql"><span class="toc-section-number">11.4.2</span> Criteria for choosing between <code>dplyr</code> and native SQL</a></li>
</ul></li>
</ul></li>
<li><a href="#chapter_sql-inserting-rows"><span class="toc-section-number">12</span> Inserting rows into the DVDRENTAL database</a><ul>
<li><a href="#setup-3"><span class="toc-section-number">12.1</span> Setup</a></li>
<li><a href="#making-up-data-for-join-examples"><span class="toc-section-number">12.2</span> Making up data for Join Examples</a><ul>
<li><a href="#sql-delete-data-syntax"><span class="toc-section-number">12.2.1</span> SQL Delete Data Syntax</a></li>
<li><a href="#delete-new-practice-customers-from-the-customer-table."><span class="toc-section-number">12.2.2</span> Delete New Practice Customers from the Customer table.</a></li>
<li><a href="#delete-new-practice-store-from-the-store-table."><span class="toc-section-number">12.2.3</span> Delete New Practice Store from the Store Table.</a></li>
<li><a href="#sql-single-row-insert-data-syntax"><span class="toc-section-number">12.2.4</span> SQL Single Row Insert Data Syntax</a></li>
<li><a href="#primary-key-constraint-error-message"><span class="toc-section-number">12.2.5</span> Primary Key Constraint Error Message</a></li>
<li><a href="#r-exercise-inserting-a-single-row-via-a-dataframe"><span class="toc-section-number">12.2.6</span> R Exercise: Inserting a Single Row via a Dataframe</a></li>
</ul></li>
<li><a href="#sql-multi-row-insert-data-syntax"><span class="toc-section-number">12.3</span> SQL Multi-Row Insert Data Syntax</a></li>
<li><a href="#sql-multi-row-insert-data-example"><span class="toc-section-number">12.4</span> SQL Multi-Row Insert Data Example</a></li>
<li><a href="#dplyr-multi-row-insert-data-example"><span class="toc-section-number">12.5</span> DPLYR Multi-Row Insert Data Example</a><ul>
<li><a href="#r-exercise-inserting-multiple-rows-via-a-dataframe"><span class="toc-section-number">12.5.1</span> R Exercise: Inserting Multiple Rows via a Dataframe</a></li>
<li><a href="#creating-a-messy-store-row"><span class="toc-section-number">12.5.2</span> Creating a Messy Store Row</a></li>
</ul></li>
</ul></li>
<li><a href="#chapter_sql-dplyr-data"><span class="toc-section-number">13</span> SQL &amp; dplyr joins additional data</a><ul>
<li><a href="#making-up-data-for-join-examples-1"><span class="toc-section-number">13.1</span> Making up data for Join Examples</a><ul>
<li><a href="#sql-delete-data-syntax-1"><span class="toc-section-number">13.1.1</span> SQL Delete Data Syntax</a></li>
<li><a href="#delete-new-practice-store-from-the-store-table.-1"><span class="toc-section-number">13.1.2</span> Delete New Practice Store from the Store Table.</a></li>
<li><a href="#delete-film-1001-sophies-choice-records-in-film_category-rental-inventory-and-film"><span class="toc-section-number">13.1.3</span> Delete film 1001, Sophie’s Choice, records in film_category, rental, inventory, and film</a></li>
<li><a href="#delete-new-practice-customers-from-the-customer-table.-1"><span class="toc-section-number">13.1.4</span> Delete New Practice Customers from the Customer table.</a></li>
<li><a href="#delete-new-practice-customers-from-the-customer-table.-2"><span class="toc-section-number">13.1.5</span> Delete New Practice Customers from the Customer table.</a></li>
<li><a href="#sql-single-row-insert-data-syntax-1"><span class="toc-section-number">13.1.6</span> SQL Single Row Insert Data Syntax</a></li>
<li><a href="#primary-key-constraint-error-message-1"><span class="toc-section-number">13.1.7</span> Primary Key Constraint Error Message</a></li>
<li><a href="#r-exercise-inserting-a-single-row-via-a-dataframe-1"><span class="toc-section-number">13.1.8</span> R Exercise: Inserting a Single Row via a Dataframe</a></li>
</ul></li>
<li><a href="#sql-multi-row-insert-data-syntax-1"><span class="toc-section-number">13.2</span> SQL Multi-Row Insert Data Syntax</a></li>
<li><a href="#sql-multi-row-insert-data-example-1"><span class="toc-section-number">13.3</span> SQL Multi-Row Insert Data Example</a></li>
<li><a href="#dplyr-multi-row-insert-data-example-1"><span class="toc-section-number">13.4</span> DPLYR Multi-Row Insert Data Example</a><ul>
<li><a href="#r-exercise-inserting-multiple-rows-via-a-dataframe-1"><span class="toc-section-number">13.4.1</span> R Exercise: Inserting Multiple Rows via a Dataframe</a></li>
<li><a href="#creating-a-messy-store-row-1"><span class="toc-section-number">13.4.2</span> Creating a Messy Store Row</a></li>
</ul></li>
<li><a href="#create-a-film-record"><span class="toc-section-number">13.5</span> Create a film record</a></li>
</ul></li>
<li><a href="#chapter_sql-dplyr-joins"><span class="toc-section-number">14</span> SQL &amp; dplyr joins</a><ul>
<li><a href="#joins"><span class="toc-section-number">14.1</span> Joins</a><ul>
<li><a href="#join-types"><span class="toc-section-number">14.1.1</span> Join Types</a></li>
<li><a href="#valentines-party"><span class="toc-section-number">14.1.2</span> Valentines Party</a></li>
<li><a href="#join-syntax"><span class="toc-section-number">14.1.3</span> Join Syntax</a></li>
<li><a href="#join-tables"><span class="toc-section-number">14.1.4</span> Join Tables</a></li>
</ul></li>
<li><a href="#natural-join-delayed-time-bomb"><span class="toc-section-number">14.2</span> Natural Join Delayed Time Bomb</a><ul>
<li><a href="#sql-customer-store_id-distribution"><span class="toc-section-number">14.2.1</span> SQL Customer store_id Distribution</a></li>
<li><a href="#sample-customer-and-store-join-data"><span class="toc-section-number">14.2.2</span> Sample Customer and Store Join Data</a></li>
<li><a href="#dplyr-store_id-distribution-exercise"><span class="toc-section-number">14.2.3</span> dplyr store_id distribution Exercise</a></li>
</ul></li>
<li><a href="#join-templates"><span class="toc-section-number">14.3</span> Join Templates</a></li>
<li><a href="#inner-joins"><span class="toc-section-number">14.4</span> Inner Joins</a><ul>
<li><a href="#example_140_inner-join-details-sql"><span class="toc-section-number">14.4.1</span> SQL Inner Join Details</a></li>
<li><a href="#example_140_inner-join-details-dplyr"><span class="toc-section-number">14.4.2</span> Dplyr Inner Join Details</a></li>
<li><a href="#example_140_inner-join-summary-sql"><span class="toc-section-number">14.4.3</span> SQL Inner Join Summary</a></li>
<li><a href="#example_140_inner-join-summary_dplyr"><span class="toc-section-number">14.4.4</span> Dplyr Inner Join Summary</a></li>
</ul></li>
<li><a href="#left-joins"><span class="toc-section-number">14.5</span> Left Joins</a><ul>
<li><a href="#example_140_left-join-details-sql"><span class="toc-section-number">14.5.1</span> SQL Left Join Details</a></li>
<li><a href="#example_140_left-join-details-dplyr"><span class="toc-section-number">14.5.2</span> Dplyr Left Join Details</a></li>
<li><a href="#example_140_left-join-summary-sql"><span class="toc-section-number">14.5.3</span> SQL Left Join Summary</a></li>
<li><a href="#example_140_left-join-summary-dplyr"><span class="toc-section-number">14.5.4</span> Dplyr Left Join Summary</a></li>
</ul></li>
<li><a href="#why-include-one-of-the-inner-join-key-columns"><span class="toc-section-number">14.6</span> Why Include one of the Inner Join Key columns?</a></li>
<li><a href="#right-joins"><span class="toc-section-number">14.7</span> Right Joins</a><ul>
<li><a href="#example_140_right-join-details-sql"><span class="toc-section-number">14.7.1</span> SQL Right Join Details</a></li>
<li><a href="#example_140_right-join-details-dplyr"><span class="toc-section-number">14.7.2</span> Dplyr Right Join Details</a></li>
<li><a href="#example_140_right-join-summary-sql"><span class="toc-section-number">14.7.3</span> SQL Right Outer Join Summary</a></li>
<li><a href="#example_140_right-join-summary-dplyr"><span class="toc-section-number">14.7.4</span> dplyr Right Join Summary</a></li>
</ul></li>
<li><a href="#full-join"><span class="toc-section-number">14.8</span> Full Join</a><ul>
<li><a href="#example_140_full-join-details-sql-a"><span class="toc-section-number">14.8.1</span> SQL Full Join Details</a></li>
<li><a href="#example_140_full-join-details-sql-b"><span class="toc-section-number">14.8.2</span> Dplyr Full Join Details</a></li>
<li><a href="#example_140_full-join-summary-sql"><span class="toc-section-number">14.8.3</span> SQL Full Join Summary</a></li>
<li><a href="#example_140_full-join-summary-dplyr"><span class="toc-section-number">14.8.4</span> Dplyr Full Join Summary</a></li>
</ul></li>
<li><a href="#semi-join"><span class="toc-section-number">14.9</span> Semi Join</a><ul>
<li><a href="#example_140_semi-join-sql-1"><span class="toc-section-number">14.9.1</span> SQL Semi Join Customer to Store</a></li>
<li><a href="#example_140_semi-join-dplyr-1"><span class="toc-section-number">14.9.2</span> Dplyr Semi Join Customer to Store</a></li>
<li><a href="#example_140_semi-join-sql-2"><span class="toc-section-number">14.9.3</span> SQL Semi Join Store to Customer</a></li>
<li><a href="#example_140_semi-join-dplyr-2"><span class="toc-section-number">14.9.4</span> Dplyr Semi Join Store to Customer</a></li>
<li><a href="#example_140_semi-join-sql-3"><span class="toc-section-number">14.9.5</span> SQL Semi Join Store to Customer Take 2</a></li>
</ul></li>
<li><a href="#anti-joins"><span class="toc-section-number">14.10</span> Anti Joins</a></li>
<li><a href="#non-equa-join-example"><span class="toc-section-number">14.11</span> Non-Equa-Join Example</a><ul>
<li><a href="#example_140_inner-join-dplyr"><span class="toc-section-number">14.11.1</span> Dplyr Non-equa Join</a></li>
</ul></li>
</ul></li>
<li><a href="#chapter_sql-metadata-exercises"><span class="toc-section-number">15</span> SQL Metadata exercises</a><ul>
<li><a href="#table-structures"><span class="toc-section-number">15.1</span> Table Structures</a><ul>
<li><a href="#customer-columns"><span class="toc-section-number">15.1.1</span> Customer Columns</a></li>
</ul></li>
<li><a href="#table-column-metadata"><span class="toc-section-number">15.2</span> Table Column Metadata</a><ul>
<li><a href="#sp_tbl_descr-parameterized-table-description-function"><span class="toc-section-number">15.2.1</span> sp_tbl_descr – Parameterized Table Description Function</a></li>
</ul></li>
<li><a href="#primary-and-foreign-key-constraints"><span class="toc-section-number">15.3</span> Primary and Foreign Key Constraints</a><ul>
<li><a href="#sp_tbl_pk_fk-parameterized-table-primary-foreign-keys-function"><span class="toc-section-number">15.3.1</span> sp_tbl_pk_fk – Parameterized Table Primary Foreign Key(s) Function</a></li>
<li><a href="#customer-primary-and-foreign-key-constraints"><span class="toc-section-number">15.3.2</span> Customer primary and foreign key constraints</a></li>
</ul></li>
<li><a href="#we-need-documentation-andor-a-dba."><span class="toc-section-number">15.4</span> We need documentation and/or a DBA.</a><ul>
<li><a href="#other-table-column-metadata"><span class="toc-section-number">15.4.1</span> Other Table Column Metadata</a></li>
<li><a href="#other-table-pk-fk"><span class="toc-section-number">15.4.2</span> Other Table PK FK</a></li>
</ul></li>
</ul></li>
<li><a href="#chapter_sql-joins-exercises"><span class="toc-section-number">16</span> SQL Joins exercises</a></li>
<li><a href="#exercise-instructions"><span class="toc-section-number">17</span> Exercise Instructions</a></li>
<li><a href="#dplyr-tables"><span class="toc-section-number">18</span> Dplyr tables</a></li>
<li><a href="#sql-union-exercise"><span class="toc-section-number">19</span> SQL Union Exercise</a><ul>
<li><a href="#how-many-rows-are-in-each-table"><span class="toc-section-number">19.1</span> 1. How many rows are in each table?</a></li>
</ul></li>
<li><a href="#exercises-1"><span class="toc-section-number">20</span> Exercises</a><ul>
<li><a href="#where-is-the-dvd-rental-business-located"><span class="toc-section-number">20.1</span> 1. Where is the DVD Rental Business located?</a><ul>
<li><a href="#list-each-store-and-the-staff-contact-information"><span class="toc-section-number">20.1.1</span> 2. List Each Store and the Staff Contact Information?</a></li>
<li><a href="#how-many-active-inactive-and-total-customers-does-the-dvd-rental-business-have"><span class="toc-section-number">20.1.2</span> 3. How Many Active, Inactive, and Total Customers Does the DVD Rental Business Have?</a></li>
<li><a href="#how-many-and-what-percent-of-customers-are-from-each-country"><span class="toc-section-number">20.1.3</span> 4. How Many and What Percent of Customers Are From Each Country?</a></li>
<li><a href="#what-countries-constitute-the-top-25-of-the-customer-base"><span class="toc-section-number">20.1.4</span> 5 What Countries Constitute the Top 25% of the Customer Base?</a></li>
<li><a href="#how-many-customers-are-in-australia-and-canada"><span class="toc-section-number">20.1.5</span> 6. How many customers are in Australia and Canada?</a></li>
<li><a href="#how-many-languages"><span class="toc-section-number">20.1.6</span> 7. How Many Languages?</a></li>
<li><a href="#what-is-the-distribution-of-dvds-by-language"><span class="toc-section-number">20.1.7</span> 8. What is the distribution of DVD’s by Language</a></li>
<li><a href="#what-are-the-number-of-rentals-and-rented-amount-by-store-by-month"><span class="toc-section-number">20.1.8</span> 9. What are the number of rentals and rented amount by store, by month?</a></li>
<li><a href="#rank-films-based-on-the-number-of-times-rented-and-associated-revenue"><span class="toc-section-number">20.1.9</span> 10. Rank Films Based on the Number of Times Rented and Associated Revenue</a></li>
<li><a href="#what-is-the-rental-distributiondvd-for-the-top-two-rented-films"><span class="toc-section-number">20.1.10</span> 11 What is the rental distribution/DVD for the top two rented films?</a></li>
<li><a href="#list-staffing-information-for-store-1-associated-with-the-bucket-brother-rentals"><span class="toc-section-number">20.1.11</span> 12. List staffing information for store 1 associated with the <code>Bucket Brother</code> rentals?</a></li>
<li><a href="#which-films-have-never-been-rented"><span class="toc-section-number">20.1.12</span> 13. Which film(s) have never been rented</a></li>
<li><a href="#how-many-films-are-in-each-film-rating"><span class="toc-section-number">20.1.13</span> 14. How many films are in each film rating?</a></li>
<li><a href="#what-are-the-different-film-categories"><span class="toc-section-number">20.1.14</span> 15. What are the different film categories?</a></li>
<li><a href="#how-many-dvds-are-in-each-film-categeory"><span class="toc-section-number">20.1.15</span> 16. How many DVD’s are in each film categeory?</a></li>
<li><a href="#which-films-are-listed-in-multiple-categories"><span class="toc-section-number">20.1.16</span> 17. Which films are listed in multiple categories?</a></li>
<li><a href="#which-dvds-are-in-one-stores-inventory-but-not-the-other"><span class="toc-section-number">20.1.17</span> 18. Which DVD’s are in one store’s inventory but not the other</a></li>
<li><a href="#which-films-are-not-tracked-in-inventory"><span class="toc-section-number">20.1.18</span> 19. Which films are not tracked in inventory?</a></li>
<li><a href="#list-film-categories-in-descending-accounts-receivable."><span class="toc-section-number">20.1.19</span> 20 List film categories in descending accounts receivable.</a></li>
<li><a href="#list-film-ratings-in-descending-accounts-receivable-order."><span class="toc-section-number">20.1.20</span> 21. List film ratings in descending accounts receivable order.</a></li>
<li><a href="#how-many-rentals-were-returned-on-time-returned-late-never-returned"><span class="toc-section-number">20.1.21</span> 22. How many rentals were returned on time, returned late, never returned?</a></li>
<li><a href="#are-there-duplicate-customers"><span class="toc-section-number">20.1.22</span> 23. Are there duplicate customers?</a></li>
<li><a href="#which-customers-have-never-rented-a-movie"><span class="toc-section-number">20.1.23</span> 24. Which customers have never rented a movie?</a></li>
<li><a href="#who-are-the-top-5-customers-with-the-most-rentals-and-associated-payments"><span class="toc-section-number">20.1.24</span> 25. Who are the top 5 customers with the most rentals and associated payments?</a></li>
<li><a href="#combine-the-top-5-rental-customers-40-or-more-rentals-and-zero-rental-customers"><span class="toc-section-number">20.1.25</span> 26. Combine the top 5 rental customers, (40 or more rentals), and zero rental customers</a></li>
<li><a href="#who-are-the-top-n1-and-bottom-n2-customers"><span class="toc-section-number">20.1.26</span> 27. Who are the top-n1 and bottom-n2 customers?</a></li>
<li><a href="#how-much-has-each-store-collected"><span class="toc-section-number">20.1.27</span> 28. How much has each store collected?</a></li>
<li><a href="#what-is-the-business-distribution-of-payments"><span class="toc-section-number">20.1.28</span> 29. What is the business’ distribution of payments?</a></li>
<li><a href="#which-customers-have-the-highest-open-amounts"><span class="toc-section-number">20.1.29</span> 30. Which customers have the highest open amounts?</a></li>
<li><a href="#what-is-the-business-cash-flow"><span class="toc-section-number">20.1.30</span> 31. What is the business cash flow?</a></li>
<li><a href="#customer-information"><span class="toc-section-number">20.1.31</span> 32. Customer information</a></li>
</ul></li>
</ul></li>
<li><a href="#chapter_sql-joins-exercises"><span class="toc-section-number">21</span> SQL Joins exercises</a></li>
<li><a href="#exercise-instructions-1"><span class="toc-section-number">22</span> Exercise Instructions</a></li>
<li><a href="#dplyr-tables-1"><span class="toc-section-number">23</span> Dplyr tables</a></li>
<li><a href="#sql-union-exercise-1"><span class="toc-section-number">24</span> SQL Union Exercise</a><ul>
<li><a href="#how-many-rows-are-in-each-table-1"><span class="toc-section-number">24.1</span> 1. How many rows are in each table?</a></li>
</ul></li>
<li><a href="#exercises-2"><span class="toc-section-number">25</span> Exercises</a><ul>
<li><a href="#where-is-the-dvd-rental-business-located-1"><span class="toc-section-number">25.1</span> 1. Where is the DVD Rental Business located?</a><ul>
<li><a href="#list-each-store-and-the-staff-contact-information-1"><span class="toc-section-number">25.1.1</span> 2. List Each Store and the Staff Contact Information?</a></li>
<li><a href="#how-many-active-inactive-and-total-customers-does-the-dvd-rental-business-have-1"><span class="toc-section-number">25.1.2</span> 3. How Many Active, Inactive, and Total Customers Does the DVD Rental Business Have?</a></li>
<li><a href="#how-many-and-what-percent-of-customers-are-from-each-country-1"><span class="toc-section-number">25.1.3</span> 4. How Many and What Percent of Customers Are From Each Country?</a></li>
<li><a href="#what-countries-constitute-the-top-25-of-the-customer-base-1"><span class="toc-section-number">25.1.4</span> 5 What Countries Constitute the Top 25% of the Customer Base?</a></li>
<li><a href="#how-many-customers-are-in-australia-and-canada-1"><span class="toc-section-number">25.1.5</span> 6. How many customers are in Australia and Canada?</a></li>
<li><a href="#how-many-languages-1"><span class="toc-section-number">25.1.6</span> 7. How Many Languages?</a></li>
<li><a href="#what-is-the-distribution-of-dvds-by-language-1"><span class="toc-section-number">25.1.7</span> 8. What is the distribution of DVD’s by Language</a></li>
<li><a href="#what-are-the-number-of-rentals-and-rented-amount-by-store-by-month-1"><span class="toc-section-number">25.1.8</span> 9. What are the number of rentals and rented amount by store, by month?</a></li>
<li><a href="#rank-films-based-on-the-number-of-times-rented-and-associated-revenue-1"><span class="toc-section-number">25.1.9</span> 10. Rank Films Based on the Number of Times Rented and Associated Revenue</a></li>
<li><a href="#what-is-the-rental-distributiondvd-for-the-top-two-rented-films-1"><span class="toc-section-number">25.1.10</span> 11 What is the rental distribution/DVD for the top two rented films?</a></li>
<li><a href="#list-staffing-information-for-store-1-associated-with-the-bucket-brother-rentals-1"><span class="toc-section-number">25.1.11</span> 12. List staffing information for store 1 associated with the <code>Bucket Brother</code> rentals?</a></li>
<li><a href="#which-films-have-never-been-rented-1"><span class="toc-section-number">25.1.12</span> 13. Which film(s) have never been rented</a></li>
<li><a href="#how-many-films-are-in-each-film-rating-1"><span class="toc-section-number">25.1.13</span> 14. How many films are in each film rating?</a></li>
<li><a href="#what-are-the-different-film-categories-1"><span class="toc-section-number">25.1.14</span> 15. What are the different film categories?</a></li>
<li><a href="#how-many-dvds-are-in-each-film-categeory-1"><span class="toc-section-number">25.1.15</span> 16. How many DVD’s are in each film categeory?</a></li>
<li><a href="#which-films-are-listed-in-multiple-categories-1"><span class="toc-section-number">25.1.16</span> 17. Which films are listed in multiple categories?</a></li>
<li><a href="#which-dvds-are-in-one-stores-inventory-but-not-the-other-1"><span class="toc-section-number">25.1.17</span> 18. Which DVD’s are in one store’s inventory but not the other</a></li>
<li><a href="#which-films-are-not-tracked-in-inventory-1"><span class="toc-section-number">25.1.18</span> 19. Which films are not tracked in inventory?</a></li>
<li><a href="#list-film-categories-in-descending-accounts-receivable.-1"><span class="toc-section-number">25.1.19</span> 20 List film categories in descending accounts receivable.</a></li>
<li><a href="#list-film-ratings-in-descending-accounts-receivable-order.-1"><span class="toc-section-number">25.1.20</span> 21. List film ratings in descending accounts receivable order.</a></li>
<li><a href="#how-many-rentals-were-returned-on-time-returned-late-never-returned-1"><span class="toc-section-number">25.1.21</span> 22. How many rentals were returned on time, returned late, never returned?</a></li>
<li><a href="#are-there-duplicate-customers-1"><span class="toc-section-number">25.1.22</span> 23. Are there duplicate customers?</a></li>
<li><a href="#which-customers-have-never-rented-a-movie-1"><span class="toc-section-number">25.1.23</span> 24. Which customers have never rented a movie?</a></li>
<li><a href="#who-are-the-top-5-customers-with-the-most-rentals-and-associated-payments-1"><span class="toc-section-number">25.1.24</span> 25. Who are the top 5 customers with the most rentals and associated payments?</a></li>
<li><a href="#combine-the-top-5-rental-customers-40-or-more-rentals-and-zero-rental-customers-1"><span class="toc-section-number">25.1.25</span> 26. Combine the top 5 rental customers, (40 or more rentals), and zero rental customers</a></li>
<li><a href="#who-are-the-top-n1-and-bottom-n2-customers-1"><span class="toc-section-number">25.1.26</span> 27. Who are the top-n1 and bottom-n2 customers?</a></li>
<li><a href="#how-much-has-each-store-collected-1"><span class="toc-section-number">25.1.27</span> 28. How much has each store collected?</a></li>
<li><a href="#what-is-the-business-distribution-of-payments-1"><span class="toc-section-number">25.1.28</span> 29. What is the business’ distribution of payments?</a></li>
<li><a href="#which-customers-have-the-highest-open-amounts-1"><span class="toc-section-number">25.1.29</span> 30. Which customers have the highest open amounts?</a></li>
<li><a href="#what-is-the-business-cash-flow-1"><span class="toc-section-number">25.1.30</span> 31. What is the business cash flow?</a></li>
<li><a href="#customer-information-1"><span class="toc-section-number">25.1.31</span> 32. Customer information</a></li>
</ul></li>
<li><a href="#different-strategies-for-interacting-with-the-database"><span class="toc-section-number">25.2</span> Different strategies for interacting with the database</a><ul>
<li><a href="#dbgetquery-versus-dbsendquerydbfetchdbclearresult"><span class="toc-section-number">25.2.1</span> dbGetQuery Versus dbSendQuery+dbFetch+dbClearResult</a></li>
</ul></li>
</ul></li>
<li><a href="#chapter_anti-join-cost-comparisons"><span class="toc-section-number">26</span> Anti-join cost comparisons</a><ul>
<li><a href="#sql-anti-join-costs"><span class="toc-section-number">26.1</span> SQL anti join Costs</a></li>
<li><a href="#dplyr-anti-joins"><span class="toc-section-number">26.2</span> dplyr Anti joins</a></li>
</ul></li>
<li><a href="#chapter_sql-quick-start"><span class="toc-section-number">27</span> SQL Quick start - simple retrieval</a><ul>
<li><a href="#intro"><span class="toc-section-number">27.1</span> Intro</a></li>
<li><a href="#databases-and-third-normal-form---3nf"><span class="toc-section-number">27.2</span> Databases and Third Normal Form - 3NF</a></li>
<li><a href="#sql-commands"><span class="toc-section-number">27.3</span> SQL Commands</a></li>
<li><a href="#sql-select-quick-start"><span class="toc-section-number">27.4</span> SQL SELECT Quick Start</a><ul>
<li><a href="#select-clause-column-selection-vertical-partioning-of-data"><span class="toc-section-number">27.4.1</span> SELECT Clause: Column Selection – Vertical Partioning of Data</a></li>
<li><a href="#sql-comments"><span class="toc-section-number">27.4.2</span> SQL Comments</a></li>
<li><a href="#from-clause"><span class="toc-section-number">27.4.3</span> FROM Clause</a></li>
<li><a href="#where-clause-row-selection-horizontal-partitioning-of-data"><span class="toc-section-number">27.4.4</span> WHERE Clause: Row Selection – Horizontal Partitioning of Data</a></li>
</ul></li>
<li><a href="#paradigm-shift-from-r-dplyr-to-sql"><span class="toc-section-number">27.5</span> Paradigm Shift from R-Dplyr to SQL</a><ul>
<li><a href="#big-bang-versus-piped-incremental-steps."><span class="toc-section-number">27.5.1</span> Big bang versus piped incremental steps.</a></li>
<li><a href="#sql-execution-order"><span class="toc-section-number">27.5.2</span> SQL Execution Order</a></li>
</ul></li>
</ul></li>
<li><a href="#chapter_postgresql-metadata"><span class="toc-section-number">28</span> Getting metadata about and from PostgreSQL</a><ul>
<li><a href="#database-contents-and-structure"><span class="toc-section-number">28.1</span> Database contents and structure</a><ul>
<li><a href="#database-structure"><span class="toc-section-number">28.1.1</span> Database structure</a></li>
<li><a href="#contents-of-the-information_schema"><span class="toc-section-number">28.1.2</span> Contents of the <code>information_schema</code></a></li>
<li><a href="#what-tables-are-in-the-database"><span class="toc-section-number">28.1.3</span> What tables are in the database?</a></li>
<li><a href="#digging-into-the-information_schema"><span class="toc-section-number">28.1.4</span> Digging into the <code>information_schema</code></a></li>
</ul></li>
<li><a href="#what-columns-do-those-tables-contain"><span class="toc-section-number">28.2</span> What columns do those tables contain?</a><ul>
<li><a href="#what-is-the-difference-between-a-view-and-a-base-table"><span class="toc-section-number">28.2.1</span> What is the difference between a <code>VIEW</code> and a <code>BASE TABLE</code>?</a></li>
<li><a href="#what-data-types-are-found-in-the-database"><span class="toc-section-number">28.2.2</span> What data types are found in the database?</a></li>
</ul></li>
<li><a href="#characterizing-how-things-are-named"><span class="toc-section-number">28.3</span> Characterizing how things are named</a><ul>
<li><a href="#counting-columns-and-name-reuse"><span class="toc-section-number">28.3.1</span> Counting columns and name reuse</a></li>
</ul></li>
<li><a href="#database-keys"><span class="toc-section-number">28.4</span> Database keys</a><ul>
<li><a href="#direct-sql"><span class="toc-section-number">28.4.1</span> Direct SQL</a></li>
<li><a href="#database-keys-with-dplyr"><span class="toc-section-number">28.4.2</span> Database keys with dplyr</a></li>
</ul></li>
<li><a href="#creating-your-own-data-dictionary"><span class="toc-section-number">28.5</span> Creating your own data dictionary</a></li>
</ul></li>
<li><a href="#chapter_dbms-environment"><span class="toc-section-number">29</span> Drilling into your DBMS environment</a><ul>
<li><a href="#which-database"><span class="toc-section-number">29.1</span> Which database?</a></li>
<li><a href="#how-many-databases-reside-in-the-docker-container"><span class="toc-section-number">29.2</span> How many databases reside in the Docker Container?</a></li>
<li><a href="#which-schema"><span class="toc-section-number">29.3</span> Which Schema?</a></li>
<li><a href="#exercises-3"><span class="toc-section-number">29.4</span> Exercises</a></li>
</ul></li>
<li><a href="#chapter_explain-queries"><span class="toc-section-number">30</span> Explain queries</a><ul>
<li><a href="#performance-considerations"><span class="toc-section-number">30.1</span> Performance considerations</a></li>
<li><a href="#clean-up-2"><span class="toc-section-number">30.2</span> Clean up</a></li>
</ul></li>
<li><a href="#chapter_sql-queries-breakdown"><span class="toc-section-number">31</span> SQL queries broken down</a><ul>
<li><a href="#sql-execution-steps"><span class="toc-section-number">31.1</span> SQL Execution Steps</a></li>
<li><a href="#passing-values-to-sql-statements"><span class="toc-section-number">31.2</span> Passing values to SQL statements</a></li>
<li><a href="#pass-multiple-sets-of-values-with-dbbind"><span class="toc-section-number">31.3</span> Pass multiple sets of values with dbBind():</a></li>
<li><a href="#clean-up-3"><span class="toc-section-number">31.4</span> Clean up</a></li>
</ul></li>
<li><a href="#chapter_writing-to-the-dbms"><span class="toc-section-number">32</span> Writing to the DBMS</a><ul>
<li><a href="#set-up-a-cattle-container"><span class="toc-section-number">32.1</span> Set up a <code>cattle</code> container</a><ul>
<li><a href="#remove-previous-containers-if-they-exist-1"><span class="toc-section-number">32.1.1</span> Remove previous containers if they exist</a></li>
<li><a href="#connect-to-postgresql"><span class="toc-section-number">32.1.2</span> Connect to PostgreSQL</a></li>
</ul></li>
<li><a href="#interact-with-postgresql-1"><span class="toc-section-number">32.2</span> Interact with PostgreSQL</a><ul>
<li><a href="#create-a-new-table-in-the-database"><span class="toc-section-number">32.2.1</span> Create a new table in the database</a></li>
<li><a href="#modify-an-existing-table"><span class="toc-section-number">32.2.2</span> Modify an existing table</a></li>
<li><a href="#remove-the-table"><span class="toc-section-number">32.2.3</span> Remove the table</a></li>
</ul></li>
<li><a href="#clean-up-4"><span class="toc-section-number">32.3</span> Clean up</a></li>
</ul></li>
<li><a href="#appendix-appendices">(APPENDIX) Appendices</a></li>
<li><a href="#chapter_appendix-setup-instructions"><span class="toc-section-number">33</span> Appendix A - Setup instructions</a><ul>
<li><a href="#sandbox-prerequisites"><span class="toc-section-number">33.1</span> Sandbox prerequisites</a></li>
<li><a href="#r-rstudio-and-git"><span class="toc-section-number">33.2</span> R, RStudio and Git</a></li>
<li><a href="#install-docker"><span class="toc-section-number">33.3</span> Install Docker</a></li>
</ul></li>
<li><a href="#chapter_windows-tech-details"><span class="toc-section-number">34</span> Appendix B - Additional technical details for Windows users</a><ul>
<li><a href="#hardware-requirements"><span class="toc-section-number">34.1</span> Hardware requirements</a></li>
<li><a href="#software-requirements"><span class="toc-section-number">34.2</span> Software requirements</a><ul>
<li><a href="#windows-7-8-8.1-and-windows-10-home-64-bit"><span class="toc-section-number">34.2.1</span> Windows 7, 8, 8.1 and Windows 10 Home (64 bit)</a></li>
<li><a href="#windows-10-pro"><span class="toc-section-number">34.2.2</span> Windows 10 Pro</a></li>
</ul></li>
<li><a href="#docker-for-windows-settings"><span class="toc-section-number">34.3</span> Docker for Windows settings</a><ul>
<li><a href="#shared-drives"><span class="toc-section-number">34.3.1</span> Shared drives</a></li>
<li><a href="#kubernetes"><span class="toc-section-number">34.3.2</span> Kubernetes</a></li>
</ul></li>
<li><a href="#git-github-and-line-endings"><span class="toc-section-number">34.4</span> Git, GitHub and line endings</a></li>
</ul></li>
<li><a href="#chapter_appendix-postresql-authentication"><span class="toc-section-number">35</span> Appendix C - PostgreSQL Authentication</a><ul>
<li><a href="#introduction"><span class="toc-section-number">35.1</span> Introduction</a></li>
<li><a href="#password-authentication-on-the-postgresql-docker-image"><span class="toc-section-number">35.2</span> Password authentication on the PostgreSQL Docker image</a></li>
<li><a href="#adding-roles"><span class="toc-section-number">35.3</span> Adding roles</a><ul>
<li><a href="#setting-up-docker"><span class="toc-section-number">35.3.1</span> Setting up Docker</a></li>
<li><a href="#creating-a-new-container"><span class="toc-section-number">35.3.2</span> Creating a new container</a></li>
<li><a href="#adding-a-role"><span class="toc-section-number">35.3.3</span> Adding a role</a></li>
<li><a href="#did-it-work"><span class="toc-section-number">35.3.4</span> Did it work?</a></li>
<li><a href="#remove-the-container"><span class="toc-section-number">35.3.5</span> Remove the container</a></li>
</ul></li>
</ul></li>
<li><a href="#chapter_appendix-sql-quick-guide"><span class="toc-section-number">36</span> APPENDIX D - Quick Guide to SQL</a><ul>
<li><a href="#data-manipulation-langauge-dml"><span class="toc-section-number">36.1</span> Data Manipulation Langauge (DML)</a></li>
<li><a href="#data-definition-langauge-ddl"><span class="toc-section-number">36.2</span> Data Definition Langauge (DDL)</a></li>
<li><a href="#data-control-language-dcl"><span class="toc-section-number">36.3</span> Data Control Language (DCL)</a></li>
<li><a href="#transaction-control-language-tcl"><span class="toc-section-number">36.4</span> Transaction Control Language (TCL)</a></li>
</ul></li>
<li><a href="#chapter_appendix-dplyr-functions"><span class="toc-section-number">37</span> Dplyr functions and SQL cross-walk</a></li>
<li><a href="#chapter_appendix-dbi-functions"><span class="toc-section-number">38</span> DBI package functions - coverage</a></li>
<li><a href="#chapter_appendix-additional-resources"><span class="toc-section-number">39</span> Appendix Additional resources</a><ul>
<li><a href="#editing-this-book"><span class="toc-section-number">39.1</span> Editing this book</a></li>
<li><a href="#docker-alternatives"><span class="toc-section-number">39.2</span> Docker alternatives</a></li>
<li><a href="#docker-and-r"><span class="toc-section-number">39.3</span> Docker and R</a></li>
<li><a href="#documentation-for-docker-and-postgresql"><span class="toc-section-number">39.4</span> Documentation for Docker and PostgreSQL</a></li>
<li><a href="#sql-and-dplyr"><span class="toc-section-number">39.5</span> SQL and dplyr</a></li>
<li><a href="#more-resources"><span class="toc-section-number">39.6</span> More Resources</a></li>
</ul></li>
<li><a href="#references">References</a></li>
</ul>
<!--bookdown:toc2:end-->
      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R, Databases, and Docker</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<!--bookdown:toc:end-->
<!--bookdown:body:start-->
<div id="chapter_introduction" class="section level1">
<h1><span class="header-section-number">1</span> Introduction</h1>
<blockquote>
<p>This chapter introduces:</p>
<ul>
<li>The motivation for this book and the strategies we have adopted</li>
<li>How Docker can be used to set up a dbms to demonstrate access to a service like PostgreSQL from R</li>
<li>Our team and how this project came about</li>
</ul>
</blockquote>
<div id="using-r-to-query-a-dbms-in-your-organization" class="section level2">
<h2><span class="header-section-number">1.1</span> Using R to query a DBMS in your organization</h2>
<p>Many R users (or <em>useRs</em>) live a dual life: in the vibrant open-source R community where R is created, improved, discussed, and taught. And then they go to work in a secured, complex, closed organizational environment where they may be on their own. Here is <a href="https://community.rstudio.com/t/moving-from-rjdbc-to-odbc/22419">a request on the Rstudio community site</a> for help that has been lightly edited to emphasize the generality that we see:</p>
<blockquote>
<p>I’m trying to migrate some inherited scripts that […] to connect to a […] database to […] instead. I’ve reviewed the <a href="https://db.rstudio.com" class="uri">https://db.rstudio.com</a> docs and tried a number of configurations but haven’t been able to connect. <em>I’m in uncharted territory within my org, so haven’t been able to get much help internally.</em></p>
</blockquote>
<p>This book will help you create a hybrid environment on your machine that can mimic some of the uncharted territory in your organization. It goes far beyond the basic connection issues and covers issues that you face when you are finding your way around or writing queries to your organization’s databases, not just when maintaining inherited scripts.</p>
<ul>
<li><p><strong>Technology hurdles</strong>. The interfaces (passwords, packages, etc.) and gaps between R and a back end database are hidden from public view as a matter of security, so pinpointing exactly where a problem is can be difficult. A <strong>simulated</strong> environment such as we offer here can be an important learning resource.</p></li>
<li><p><strong>Scale issues</strong>. We see at least two types of scale issues. Handling large volumes of data so that performance issues must be a consideration requires a basic understanding of what’s happening in “the back end” (which is necessarily hidden from view). Therefore mastering techniques for drawing samples or small batches of data are essential. In addition to their size, your organization’s databases will often have structural characteristics that are complex and obscure. Data documentation is often incomplete and emphasizes operational characteristics, rather than analytic opportunities. A careful useR often needs to confirm the documentation on the fly and de-normalize data carefully.</p></li>
<li><p><strong>Use cases</strong>. R users frequently need to make sense of an organization’s complex data structures and coding schemes to address incompletely formed questions so that informal exploratory data analysis has to be intuitive and fast. The technology details should not get in the way. Sharing and discussing exploratory and diagnostic retrieval techniquesis best in public, but is constrained by organizational requirements.</p></li>
</ul>
<p>We have found that PostgreSQL in a Docker container solves many of the foregoing problems.</p>
</div>
<div id="docker-as-a-tool-for-users" class="section level2">
<h2><span class="header-section-number">1.2</span> Docker as a tool for UseRs</h2>
<p>Noam Ross’s “<a href="https://nyhackr.blob.core.windows.net/presentations/Docker-for-the-UseR_Noam-Ross.pdf">Docker for the UseR</a>” <span class="citation">(Ross <a href="#ref-Ross2018a">2018</a><a href="#ref-Ross2018a">a</a>)</span> suggests that there are four distinct Docker use-cases for useRs.</p>
<ol style="list-style-type: decimal">
<li>Make a fixed working environment for reproducible analysis</li>
<li>Access a service outside of R <strong>(e.g., PostgreSQL)</strong></li>
<li>Create an R based service (e.g., with <code>plumber</code>)</li>
<li>Send our compute jobs to the cloud with minimal reconfiguration or revision</li>
</ol>
<p>This book explores #2 because it allows us to work on the database access issues described above and to practice on an industrial-scale DBMS.</p>
<ul>
<li>Docker is a comparatively easy way to simulate the relationship between an R/RStudio session and a database – all on on your machine (provided you have Docker installed and running).</li>
<li>Running PostgreSQL on a Docker container avoids OS or system dependencies or conflicts that cause confusion and limit reproducibility.</li>
<li>A Docker environment consumes relatively few resources. Our sandbox does much less but only includes PostgreSQL and sample data, so it takes up about 5% of the space taken up by the Vagrant environment that inspired this project. <span class="citation">(Makubuya <a href="#ref-Makubuya2018">2018</a>)</span></li>
<li>A simple Docker container such as the one used in our sandbox is easy to use and could be extended for other uses.</li>
<li>Docker is a widely used technology for deploying applications in the cloud, so for many useRs it’s worth mastering.</li>
</ul>
</div>
<div id="who-are-we" class="section level2">
<h2><span class="header-section-number">1.3</span> Who are we?</h2>
<p>We have been collaborating on this book since the Summer of 2018, each of us chipping into the project as time permits:</p>
<ul>
<li>Dipti Muni - <a href="https://github.com/deemuni">@deemuni</a></li>
<li>Ian Franz - <a href="https://github.com/ianfrantz">@ianfrantz</a></li>
<li>Jim Tyhurst - <a href="https://github.com/jimtyhurst">@jimtyhurst</a></li>
<li>John David Smith - <a href="https://github.com/smithjd">@smithjd</a></li>
<li>M. Edward (Ed) Borasky - <a href="https://github.com/znmeb">@znmeb</a></li>
<li>Maryanne Thygesen <a href="https://github.com/maryannet">@maryannet</a></li>
<li>Scott Came - <a href="https://github.com/scottcame">@scottcame</a></li>
<li>Sophie Yang - <a href="https://github.com/SophieMYang">@SophieMYang</a></li>
</ul>
</div>
<div id="how-did-this-project-come-about" class="section level2">
<h2><span class="header-section-number">1.4</span> How did this project come about?</h2>
<p>We trace this book back to the <a href="https://cascadiarconf.com/">June 2, 2018 Cascadia R Conf</a> where Aaron Makubuya gave <a href="https://github.com/Cascadia-R/Using_R_With_Databases">a presentation using Vagrant hosting</a> <span class="citation">(Makubuya <a href="#ref-Makubuya2018">2018</a>)</span>. After that <a href="https://github.com/smithjd">John Smith</a>, <a href="https://github.com/ianfrantz">Ian Franz</a>, and <a href="https://github.com/SophieMYang">Sophie Yang</a> had discussions after the monthly <a href="https://www.meetup.com/Portland-Data-Science-Group/events/fxvhbnywmbgb/">Data Discussion Meetups</a> about the difficulties around setting up <a href="https://www.vagrantup.com/">Vagrant</a> (a virtual environment), connecting to a corporate database, and having realistic <strong>public</strong> environment to demo or practice the issues that come up behind corporate firewalls. <a href="https://github.com/scottcame">Scott Came’s</a> tutorial on <a href="http://www.cascadia-analytics.com/2018/07/21/docker-r-p1.html">R and Docker</a> <span class="citation">(Came <a href="#ref-Came2018">2018</a>)</span> (an alternative to Vagrant) at the 2018 UseR Conference in Melbourne was provocative and it turned out he lived nearby. We re-connected with <a href="https://github.com/znmeb">M. Edward (Ed) Borasky</a> who had done extensive development for a <a href="https://github.com/hackoregon/data-science-pet-containers">Hack Oregon data science containerization project</a> <span class="citation">(Borasky <a href="#ref-Borasky2018">2018</a>)</span>.</p>
</div>
<div id="navigation" class="section level2">
<h2><span class="header-section-number">1.5</span> Navigation</h2>
<p>If this is the first <code>bookdown</code> <span class="citation">(Xie <a href="#ref-Xie2016">2016</a>)</span> book you’ve read, here’s how to navigate the website.</p>
<ol style="list-style-type: decimal">
<li><p>The controls on the upper left: there are four controls on the upper left.</p>
<ul>
<li>A “hamburger” menu: this toggles the table of contents on the left side of the page on or off.</li>
<li>A magnifying glass: this toggles a search box on or off.</li>
<li>A letter “A”: this lets you pick how you want the site to display. You have your choice of small or large text, a serif or sans-serif font, and a white, sepia or night theme.</li>
<li><p>A pencil: this is the “Edit” button. This will take you to a GitHub edit dialog for the chapter you’re reading. If you’re a committer to the repository, you’ll be able to edit the source directly.</p>
<p>If not, GitHub will fork a copy of the repository to your own account and you’ll be able to edit that version. Then you can make a pull request.</p></li>
</ul></li>
<li><p>The share buttons in the upper right hand corner. There’s one for Twitter, one for Facebook, and one that gives a menu of options, including LinkedIn.</p></li>
</ol>
<!--chapter:end:index.Rmd-->
</div>
</div>
<div id="chapter_basic-concepts" class="section level1">
<h1><span class="header-section-number">2</span> Basic Concepts</h1>
<hr />
<blockquote>
<p>This chapter introduces:</p>
<ul>
<li>The overall structure of our Docker-based PostgreSQL sandbox</li>
<li>Basic concepts around each of the elements that make up our sandbox: tidy data, pipes, Docker, PostgreSQL, data representation, and our <code>petsqlr</code> package.</li>
</ul>
</blockquote>
<hr />
<div id="the-big-picture-r-and-the-docker-postgresql-playground-on-your-machine" class="section level2">
<h2><span class="header-section-number">2.1</span> The big picture: R and the Docker / PostgreSQL playground on your machine</h2>
<p>Here is an overview of how R and Docker fit on your operating system in this book’s sandbox:</p>
<div class="figure">
<img src="screenshots/environment_overview.png" alt="R and Docker" />
<p class="caption">R and Docker</p>
</div>
<p>You run R from RStudio to set up Docker, launch PostgreSQL inside it and then send queries directly to PostgreSQL from R. (We provide more details about our sandbox environment in the chapter on <a href="#chapter_appendix-sandbox-environment">mapping your environment</a>.</p>
</div>
<div id="your-computer-and-its-operating-system" class="section level2">
<h2><span class="header-section-number">2.2</span> Your computer and its operating system</h2>
<p>The playground that we construct in this book is designed so that some of the mysteries of accessing a corporate database are more visible – it’s all happenning on <em>your computer</em>. The challenge, however, is that we know very little about your computer and its operating system. In the workshops we’ve given about this book, the details of individual computers have turned out to be diverse and difficult to pin down in advance. So there can be many issues, but not many basic concepts that we can highlight in advance.</p>
</div>
<div id="r" class="section level2">
<h2><span class="header-section-number">2.3</span> R</h2>
<p>We assume a general familiarity with R and RStudio. RStudio’s Big Data workshop at the 2019 RStudio has an abundance of introductory material <span class="citation">(Ruiz <a href="#ref-Ruiz2019">2019</a>)</span>.</p>
<p>This book is <a href="https://www.tidyverse.org">Tidyverse-oriented</a>, so we assume familiarity with the pipe operator, tidy data <span class="citation">(Wickham <a href="#ref-Wickham2014">2014</a>)</span>, dplyr, and techniques for tidying data <span class="citation">(Wickham <a href="#ref-Wickham2018">2018</a>)</span>.</p>
<p>R connects to a database by means of a series of packages that work together. The follwing diagram from a <a href="https://github.com/rstudio/bigdataclass">big data workshop</a> at the 2019 RStudio conference shows the big picture. The biggest difference in terms of retrieval strategies is between writing <code>dplyr</code> and native <code>SQL</code> code. Dplyr generates <a href="https://en.wikipedia.org/wiki/SQL-92">SQL-92 standard</a> code; whereas you can write SQL code that leverages the specific language features of your dbms when you write SQL code yourself.</p>
<div class="figure">
<img src="screenshots/rstudioconf-2019-big-data-architecture.png" alt="Rstudio’s DBMS architecture - slide # 33" />
<p class="caption">Rstudio’s DBMS architecture - slide # 33</p>
</div>
</div>
<div id="our-sqlpetr-package" class="section level2">
<h2><span class="header-section-number">2.4</span> Our <code>sqlpetr</code> package</h2>
<p>The <code>sqlpetr</code> package is the companion R package for this database tutorial. It has two classes of functions:</p>
<ul>
<li>Functions to install the dependencies needed to build the book and perform the operations covered in the tutorial, and</li>
<li>Utilities for dealing with Docker and the PostgreSQL Docker image we use.
<code>sqlpetr</code> has a pkgdown site at <a href="https://smithjd.github.io/sqlpetr/" class="uri">https://smithjd.github.io/sqlpetr/</a>.</li>
</ul>
</div>
<div id="docker" class="section level2">
<h2><span class="header-section-number">2.5</span> Docker</h2>
<p>Docker and the DevOps tools surrounding it have fostered a revolution in the way services are delivered over the internet. In this book, we’re piggybacking on a small piece of that revolution, Docker on the desktop.</p>
<div id="virtual-machines-and-hypervisors" class="section level3">
<h3><span class="header-section-number">2.5.1</span> Virtual machines and hypervisors</h3>
<p>A <em>virtual machine</em> is a machine that is running purely as software hosted by another real machine. To the user, a virtual machine looks just like a real one. But it has no processors, memory or I/O devices of its own - all of those are supplied and managed by the host.</p>
<p>A virtual machine can run any operating system that will run on the host’s hardware. A Linux host can run a Windows virtual machine and vice versa.</p>
<p>A <em>hypervisor</em> is the component of the host system software that manages virtual machines, usually called <em>guests</em>. Linux systems have a native hypervisor called <em>Kernel Virtual Machine </em> (<code>kvm</code>). And laptop, desktop and server processors from Intel and Advanced Micro Devices (AMD) have hardware that makes this hypervisor more efficient.</p>
<p>Windows servers and Windows 10 Pro have a hypervisor called <em>Hyper-V</em>. Like <code>kvm</code>, <code>Hyper-V</code> can take advantage of the hardware in Intel and AMD processors. On Macintosh, there is a <em>Hypervisor Framework</em> (<a href="https://developer.apple.com/documentation/hypervisor" class="uri">https://developer.apple.com/documentation/hypervisor</a>) and other tools build on that.</p>
<p>If this book is about Docker, why do we care about virtual machines and hypervisors? Docker is a Linux subsystem - it only runs on Linux laptops, desktops and servers. As we’ll see shortly, if we want to run Docker on Windows or MacOS, we’ll need a hypervisor, a Linux virtual machine and some “glue logic” to provide a Docker user experience equivalent to the one on a Linux system.</p>
</div>
<div id="containers" class="section level3">
<h3><span class="header-section-number">2.5.2</span> Containers</h3>
<p>A <em>container</em> is a set of processes running in an operating system. The host operating system is usually Linux, but other operating systems also can host containers.</p>
<p>Unlike a virtual machine, the container has no operating system kernel of its own. If the host is running the Linux kernel, so is the container. And since the container OS is the same as the host OS, there’s no need for a hypervisor or hardware to support the hypervisor. So a container is more efficient than a virtual machine.</p>
<p>A container <strong>does</strong> have its own filesystem. From inside the container, this filesystem looks like a Linux filesystem, but it can use any Linux distro. For example, you can have an Ubuntu 18.04 LTS host running Ubuntu 14.04 LTS or Fedora 28 or CentOS 7 containers. The kernel will always be the host kernel, but the utilities and applications will be those from the container.</p>
</div>
<div id="docker-itself" class="section level3">
<h3><span class="header-section-number">2.5.3</span> Docker itself</h3>
<p>While there are both older (<em>lxc</em>) and newer container tools, the one that has caught on in terms of widespread use is <em>Docker</em> <span class="citation">(Docker <a href="#ref-Docker2019a">2019</a><a href="#ref-Docker2019a">a</a>)</span>. Docker is widely used on cloud providers to deploy services of all kinds. Using Docker on the desktop to deliver standardized packages, as we are doing in this book, is a secondary use case, but a common one.</p>
<p>If you’re using a Linux laptop / desktop, all you need to do is install Docker CE <span class="citation">(Docker <a href="#ref-Docker2018b">2018</a><a href="#ref-Docker2018b">a</a>)</span>. However, most laptops and desktops don’t run Linux - they run Windows or MacOS. As noted above, to use Docker on Windows or MacOS, you need a hypervisor and a Linux virtual machine.</p>
</div>
<div id="docker-objects" class="section level3">
<h3><span class="header-section-number">2.5.4</span> Docker objects</h3>
<p>The Docker subsystem manages several kinds of objects - containers, images, volumes and networks. In this book, we are only using the basic command line tools to manage containers, images and volumes.</p>
<p>Docker <code>images</code> are files that define a container’s initial filesystem. You can find pre-built images on Docker Hub and the Docker Store - the base PostgreSQL image we use comes from Docker Hub (<a href="https://hub.docker.com/_/postgres/" class="uri">https://hub.docker.com/_/postgres/</a>). If there isn’t a Docker image that does exactly what you want, you can build your own by creating a Dockerfile and running <code>docker build</code>. We do this in <a href="#build-the-pet-sql-docker-image">Build the pet-sql Docker Image</a>.</p>
<p>Docker <code>volumes</code> – explain <code>mount</code>.</p>
</div>
<div id="hosting-docker-on-windows-machines" class="section level3">
<h3><span class="header-section-number">2.5.5</span> Hosting Docker on Windows machines</h3>
<p>There are two ways to get Docker on Windows. For Windows 10 Home and older versions of Windows, you need Docker Toolbox <span class="citation">(Docker <a href="#ref-Docker2019b">2019</a><a href="#ref-Docker2019b">e</a>)</span>. Note that for Docker Toolbox, you need a 64-bit AMD or Intel processor with the virtualization hardware installed and enabled in the BIOS.</p>
<p>For Windows 10 Pro, you have the Hyper-V virtualizer as standard equipment, and can use Docker for Windows <span class="citation">(Docker <a href="#ref-Docker2019c">2019</a><a href="#ref-Docker2019c">c</a>)</span>.</p>
</div>
<div id="hosting-docker-on-macos-machines" class="section level3">
<h3><span class="header-section-number">2.5.6</span> Hosting Docker on macOS machines</h3>
<p>As with Windows, there are two ways to get Docker. For older Intel systems, you’ll need Docker Toolbox <span class="citation">(Docker <a href="#ref-Docker2019d">2019</a><a href="#ref-Docker2019d">d</a>)</span>. Newer systems (2010 or later running at least macOS El Capitan 10.11) can run Docker for Mac <span class="citation">(Docker <a href="#ref-Docker2019e">2019</a><a href="#ref-Docker2019e">b</a>)</span>.</p>
</div>
<div id="hosting-docker-on-unix-machines" class="section level3">
<h3><span class="header-section-number">2.5.7</span> Hosting Docker on UNIX machines</h3>
<p>Unix was the original host for both R and Docker. Unix-like commands show up.</p>
</div>
</div>
<div id="normal-and-normalized-data" class="section level2">
<h2><span class="header-section-number">2.6</span> ‘Normal’ and ‘normalized’ data</h2>
<div id="tidy-data" class="section level3">
<h3><span class="header-section-number">2.6.1</span> Tidy data</h3>
<p>Tidy data <span class="citation">(Wickham <a href="#ref-Wickham2014">2014</a>)</span> is well behaved from the point of view of analysis and tools in the Tidyverse <span class="citation">(RStudio <a href="#ref-RStudio2019">2019</a>)</span>. Tidy data is easier to think about and it is usually worthwhile to make the data tidy <span class="citation">(Wickham <a href="#ref-Wickham2018">2018</a>)</span>. Tidy data is roughly equivalent to <em>third normal form</em> as discussed below.</p>
</div>
<div id="design-of-normal-data" class="section level3">
<h3><span class="header-section-number">2.6.2</span> Design of “normal data”</h3>
<p>Data in a database is most often optimized to minimize storage space and increase performance while preserving integrity when adding, changing, or deleting data. The Wikipedia article on Database Normalization has a good introduction to the characteristics of “normal” data and the process of re-organizing it to meet those desirable criteria <span class="citation">(Wikipedia <a href="#ref-Wikipedia2019">2019</a>)</span>. The bottom line is that “data normalization is practical” although there are mathematical arguments for normalization based on the preservation of data integrity.</p>
</div>
</div>
<div id="organizational-dbms" class="section level2">
<h2><span class="header-section-number">2.7</span> Organizational dbms</h2>
<p>The organizational context of a database matters just as much as its design characteristics. The design of a database (or <em>data model</em>) may have been purchased from an external vendor or developed in-house. In either case time has a tendency to erode the original design concept so that the data you find in a dbms may not quite match the original design specification. And the original design may or may not be well reflected in the current naming of tables, columns and other objects.</p>
<p>It’s a naive misconception to think that the data you are analyzing “comes from the database” even though you are retrieving it from your organization’s dbms. In fact it comes from the people who design, enter, manage, protect, and use your organization’s data. In practice, a <a href="https://en.wikipedia.org/wiki/Database_administrator">database administrator</a> (DBA) is often a key point of contact in terms of access and may have stringent criteria for query performance. Make friends with your DBA.</p>
</div>
<div id="sql" class="section level2">
<h2><span class="header-section-number">2.8</span> SQL</h2>
<p>Although there are <a href="https://en.wikipedia.org/wiki/SQL#Interoperability_and_standardization">ANSI standards</a> for <a href="https://en.wikipedia.org/wiki/SQL_syntax">SQL syntax</a>, different implementations vary in enough details that R’s ability to customize queries for those implementations is very helpful.</p>
<p>The tables in a dbms correspond to a data frame in R, so interaction with a dbms is fairly natural for useRs.</p>
<p>SQL code is characterized by the fact that it describes <em>what</em> to retrieve, leaving the dbms back end to determine how to do it. Therefore it has a <em>batch</em> feel. The pipe operator (<code>%&gt;%</code>, which is read as <em>and then</em>) is inherently procedural when it’s used with dplyr: it can be used to construct queries step-by-step. Once a test dplyr query has been executed, it is easy to inspect the results and add steps with the pipe operator to refine or expand the query.</p>
<p><a href="#chapter_appendix-sql-quick-guide">APPENDIX D - Quick Guide to SQL</a> lists the different elements of the SQL language.</p>
<div id="data-mapping-between-r-vs-sql-data-types" class="section level3">
<h3><span class="header-section-number">2.8.1</span> Data mapping between R vs SQL data types</h3>
<p>The following code shows how different elements of the R bestiary are translated to and from ANSI standard data types. Note that R factors are translated as <code>TEXT</code> so that missing levels are ignored on the SQL side.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(DBI)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw">dbDataType</span>(<span class="kw">ANSI</span>(), <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>)</a></code></pre></div>
<pre><code>## [1] &quot;INT&quot;</code></pre>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">dbDataType</span>(<span class="kw">ANSI</span>(), <span class="dv">1</span>)</a></code></pre></div>
<pre><code>## [1] &quot;DOUBLE&quot;</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">dbDataType</span>(<span class="kw">ANSI</span>(), <span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>## [1] &quot;SMALLINT&quot;</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">dbDataType</span>(<span class="kw">ANSI</span>(), <span class="kw">Sys.Date</span>())</a></code></pre></div>
<pre><code>## [1] &quot;DATE&quot;</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">dbDataType</span>(<span class="kw">ANSI</span>(), <span class="kw">Sys.time</span>())</a></code></pre></div>
<pre><code>## [1] &quot;TIMESTAMP&quot;</code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">dbDataType</span>(<span class="kw">ANSI</span>(), <span class="kw">Sys.time</span>() <span class="op">-</span><span class="st"> </span><span class="kw">as.POSIXct</span>(<span class="kw">Sys.Date</span>()))</a></code></pre></div>
<pre><code>## [1] &quot;TIME&quot;</code></pre>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw">dbDataType</span>(<span class="kw">ANSI</span>(), <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;abc&quot;</span>))</a></code></pre></div>
<pre><code>## [1] &quot;TEXT&quot;</code></pre>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="kw">dbDataType</span>(<span class="kw">ANSI</span>(), <span class="kw">list</span>(<span class="kw">raw</span>(<span class="dv">10</span>), <span class="kw">raw</span>(<span class="dv">20</span>)))</a></code></pre></div>
<pre><code>## [1] &quot;BLOB&quot;</code></pre>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="kw">dbDataType</span>(<span class="kw">ANSI</span>(), <span class="kw">I</span>(<span class="dv">3</span>))</a></code></pre></div>
<pre><code>## [1] &quot;DOUBLE&quot;</code></pre>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="kw">dbDataType</span>(<span class="kw">ANSI</span>(), iris)</a></code></pre></div>
<pre><code>## Sepal.Length  Sepal.Width Petal.Length  Petal.Width      Species 
##     &quot;DOUBLE&quot;     &quot;DOUBLE&quot;     &quot;DOUBLE&quot;     &quot;DOUBLE&quot;       &quot;TEXT&quot;</code></pre>
<p>The <a href="https://cran.r-project.org/web/packages/DBI/vignettes/spec.html">DBI specification</a> provides extensive documentation that is worth digesting if you intend to work with a dbms from R. As you work through the examples in this book, you will also want to refer to the following resources:</p>
<ul>
<li>RStudio’s <a href="https://db.rstudio.com">Databases using R</a> site describes many of the technical details involved.</li>
<li>The <a href="https://community.rstudio.com/tags/database">RStudio community</a> is an excellent place to ask questions or study what has been discussed previously.</li>
</ul>
</div>
<div id="postgresql-and-connection-parameters" class="section level3">
<h3><span class="header-section-number">2.8.2</span> PostgreSQL and connection parameters</h3>
<p>An <strong>important detail:</strong> We use a PostgreSQL database server running in a Docker container for the database functions. It is installed inside Docker, so you do not have to download or install it yourself. To connect to it, you have to define some parameters. These parameters are used in two places:</p>
<ol style="list-style-type: decimal">
<li>When the Docker container is created, they’re used to initialize the database, and</li>
<li>Whenever we connect to the database, we need to specify them to authenticate.</li>
</ol>
<p>We define the parameters in an environment file that R reads when starting up. The file is called <code>.Renviron</code>, and is located in your home directory. See the discussion of <a href="#chapter_appendix-postresql-authentication">securing and using dbms credentials</a>.</p>
<!--chapter:end:010-basic-concepts.Rmd-->
</div>
</div>
</div>
<div id="chapter_how-to-use-this-book" class="section level1">
<h1><span class="header-section-number">3</span> How to use this book</h1>
<blockquote>
<p>This chapter explains:</p>
<ul>
<li>Getting the code used in this book</li>
<li>How you can contribute to the book project</li>
</ul>
</blockquote>
<p>This book is full of examples that you can replicate on your computer.</p>
<div id="retrieve-the-code-from-github" class="section level2">
<h2><span class="header-section-number">3.1</span> Retrieve the code from GitHub</h2>
<p>The code to generate the book and the exercises it contains can be downloaded from <a href="https://github.com/smithjd/sql-pet">this repo</a>.</p>
</div>
<div id="read-along-experiment-as-you-go" class="section level2">
<h2><span class="header-section-number">3.2</span> Read along, experiment as you go</h2>
<p>We have never been sure whether we’re writing an expository book or a massive tutorial. You may use it either way. The best way to learn the material we cover is to <em>experiment</em>.</p>
<p>After the introductory chapters and the chapter that <a href="#dvdrental-db-setup">creates the persistent database</a>, you can jump around and each chapter stands on its own.</p>
</div>
<div id="participating" class="section level2">
<h2><span class="header-section-number">3.3</span> Participating</h2>
<div id="browsing-the-book" class="section level3">
<h3><span class="header-section-number">3.3.1</span> Browsing the book</h3>
<p>If you just want to read the book and copy / paste code into your working environment, simply browse to <a href="https://smithjd.github.io/sql-pet" class="uri">https://smithjd.github.io/sql-pet</a>. If you get stuck, or find things aren’t working, open an issue at <a href="https://github.com/smithjd/sql-pet/issues/new/" class="uri">https://github.com/smithjd/sql-pet/issues/new/</a>.</p>
</div>
<div id="diving-in" class="section level3">
<h3><span class="header-section-number">3.3.2</span> Diving in</h3>
<p>If you want to experiment with the code in the book, run it in RStudio and interact with it, you’ll need to do two more things:</p>
<ol style="list-style-type: decimal">
<li>Install the <code>sqlpetr</code> R package <span class="citation">(Borasky et al. <a href="#ref-Borasky2018a">2018</a>)</span>. See <a href="https://smithjd.github.io/sqlpetr" class="uri">https://smithjd.github.io/sqlpetr</a> for the package documentation. Installation may take some time if it has to install or update packages not available on your computer.</li>
<li>Clone the Git repository <a href="https://github.com/smithjd/sql-pet.git" class="uri">https://github.com/smithjd/sql-pet.git</a> and open the project file <code>sql-pet.Rproj</code> in RStudio.</li>
</ol>
<p>Enjoy!</p>
<!--chapter:end:020-using-this-book.Rmd-->
</div>
</div>
</div>
<div id="chapter_learning-goals" class="section level1">
<h1><span class="header-section-number">4</span> Learning Goals and Use Cases</h1>
<blockquote>
<p>This chapter sets the context for the book by:</p>
<ul>
<li>Challenging you to think about your goals and expectations</li>
<li>Imagining the setting where our sample database would be used</li>
<li>Posing some imaginary use cases that a data analyst might face</li>
<li>Discussing the different elements involved in answering questions from an organization’s database</li>
</ul>
</blockquote>
<div id="ask-yourself-what-are-you-aiming-for" class="section level2">
<h2><span class="header-section-number">4.1</span> Ask yourself, what are you aiming for?</h2>
<ul>
<li>Differences between production and data warehouse environments.</li>
<li>Learning to keep your DBAs happy:
<ul>
<li>You are your own DBA in this simulation, so you can wreak havoc and learn from it, but you can learn to be DBA-friendly here.</li>
<li>In the end it’s the subject-matter experts that understand your data, but you have to work with your DBAs first.</li>
</ul></li>
</ul>
</div>
<div id="learning-goals" class="section level2">
<h2><span class="header-section-number">4.2</span> Learning Goals</h2>
<p>After working through the code in this book, you can expect to be able to:</p>
<ul>
<li>Set up a PostgreSQL database in a Docker environment.</li>
<li>Gain familiarity with the various ways of interacting with the Docker and PostgreSQL environments</li>
<li>Run queries against PostgreSQL in an environment that simulates what you will find in a corporate setting.</li>
<li>Understand techniques and some of the trade-offs between:
<ul>
<li>queries aimed at exploration or informal investigation using <a href="https://cran.r-project.org/package=dplyr">dplyr</a> <span class="citation">(Wickham <a href="#ref-Wickham2018">2018</a>)</span>; and</li>
<li>queries that should be written in SQL, because performance is important due to the size of the database or the frequency with which a query is to be run.</li>
</ul></li>
<li>Understand the equivalence between <code>dplyr</code> and SQL queries, and how R translates one into the other.</li>
<li>Gain familiarity with techniques that help you explore a database and verify its documentation.</li>
<li>Gain familiarity with the standard metadata that a SQL database contains to describe its own contents.</li>
<li>Understand some advanced SQL techniques.</li>
<li>Gain some understanding of techniques for assessing query structure and performance.</li>
<li>Understand enough about Docker to swap databases, e.g. <a href="http://www.sportsdb.org/sd/samples">Sports DB</a> for the <a href="http://www.postgresqltutorial.com/postgresql-sample-database/">DVD rental database</a> used in this tutorial. Or swap the database management system (DBMS), e.g. <a href="https://www.mysql.com/">MySQL</a> for <a href="https://www.postgresql.org/">PostgreSQL</a>.</li>
</ul>
</div>
<div id="imagining-a-dvd-rental-business" class="section level2">
<h2><span class="header-section-number">4.3</span> Imagining a DVD rental business</h2>
<p>Years ago, people rented videos on DVD disks and video stores were a big business. To understand the data base that we use in this book, try to imagine managing a video rental store <a href="https://en.wikipedia.org/wiki/Movie_Madness_Video">like Movie Madness</a> in Portland, Oregon.
<img src="screenshots/movie-madness-sample.png" style="display: block; margin: auto;" />
<em>What data would be needed and what questions would you have to answer about the business?</em></p>
<p>This tutorial uses <a href="http://www.postgresqltutorial.com/postgresql-sample-database/">the PostgreSQL version of “dvd rental” database</a> which represents the transaction database for running a movie (e.g., dvd) rental business. The database can be <a href="http://www.postgresqltutorial.com/wp-content/uploads/2017/10/dvdrental.zip">downloaded here</a>. Here’s a glimpse of it’s structure, which we explore using several different methods:</p>
<div class="figure">
<img src="screenshots/dvdrental-er-diagram.png" alt="Entity Relationship diagram for the dvdrental database" />
<p class="caption">Entity Relationship diagram for the dvdrental database</p>
</div>
<p>A data analyst uses the database abstraction and the practical business questions to make better decisions and solve problems.</p>
</div>
<div id="use-cases" class="section level2">
<h2><span class="header-section-number">4.4</span> Use cases</h2>
<p>Imagine that you have one of following several roles at our fictional company <strong>DVDs R Us</strong> and you have a following need to be met:</p>
<ul>
<li>As a data scientist, I want to know the distribution of number of rentals per month per customer, so that the Marketing department can create incentives for customers in 3 segments: Frequent Renters, Average Renters, Infrequent Renters.</li>
<li>As the Director of Sales, I want to see the total number of rentals per month for the past 6 months and I want to know how fast our customer base is growing/shrinking per month for the past 6 months.</li>
<li>As the Director of Marketing, I want to know which categories of DVDs are the least popular, so that I can create a campaign to draw attention to rarely used inventory.</li>
<li>As a shipping clerk, I want to add rental information when I fulfill a shipment order.</li>
<li>As the Director of Analytics, I want to test as much of the production R code in my shop as possible against a new release of the DBMS that the IT department is implementing next month.</li>
<li>etc.</li>
</ul>
</div>
<div id="investigating-a-question-using-an-organizations-database" class="section level2">
<h2><span class="header-section-number">4.5</span> Investigating a question using an organization’s database</h2>
<ul>
<li>Need both familiarity with the data and a focus question
<ul>
<li>An iterative process where
<ul>
<li>the data resource can shape your understanding of the question</li>
<li>the question you need to answer will frame how you see the data resource</li>
</ul></li>
<li>You need to go back and forth between the two, asking
<ul>
<li>do I understand the question?</li>
<li>do I understand the data?</li>
</ul></li>
</ul></li>
<li>How well do you understand the data resource (in the DBMS)?
<ul>
<li>Use all available documentation and understand its limits</li>
<li>Use your own tools and skills to examine the data resource</li>
<li>What is <em>missing</em> from the database: (columns, records, cells)</li>
<li>Why is the data missing?</li>
</ul></li>
<li>How well do you understand the question you seek to answer?
<ul>
<li>How general or specific is your question?</li>
<li>How aligned is it with the purpose for which the database was designed and is being operated?</li>
<li>How different are your assumptions and concerns from those of the people who enter and use the data on a day to day basis?</li>
</ul></li>
</ul>
<!--chapter:end:030-learning-goals-use-cases.Rmd-->
</div>
</div>
<div id="chapter_connect-docker-postgresql-r" class="section level1">
<h1><span class="header-section-number">5</span> Connecting Docker, PostgreSQL, and R</h1>
<blockquote>
<p>This chapter demonstrates how to:</p>
<ul>
<li>Run, clean-up and close PostgreSQL in Docker containers.</li>
<li>Keep necessary credentials secret while being available to R when it executes.</li>
<li>Interact with PostgreSQL when it’s running inside a Docker container.</li>
<li>Read and write to PostgreSQL from R.</li>
</ul>
</blockquote>
<p>Please install the <code>sqlpetr</code> package if not already installed:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1"><span class="kw">library</span>(devtools)</a>
<a class="sourceLine" id="cb21-2" data-line-number="2"><span class="cf">if</span> (<span class="op">!</span><span class="kw">require</span>(sqlpetr)) devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&quot;smithjd/sqlpetr&quot;</span>, </a>
<a class="sourceLine" id="cb21-3" data-line-number="3">                                                <span class="dt">build_opts =</span> <span class="st">&quot;&quot;</span>)</a></code></pre></div>
<p>Note that when you install the package the first time, it will ask you to update the packages it uses and that can take some time.</p>
<p>The following packages are used in this chapter:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb22-2" data-line-number="2"><span class="kw">library</span>(DBI)</a>
<a class="sourceLine" id="cb22-3" data-line-number="3"><span class="kw">library</span>(RPostgres)</a>
<a class="sourceLine" id="cb22-4" data-line-number="4"><span class="kw">require</span>(knitr)</a>
<a class="sourceLine" id="cb22-5" data-line-number="5"><span class="kw">library</span>(sqlpetr)</a></code></pre></div>
<div id="verify-that-docker-is-running" class="section level2">
<h2><span class="header-section-number">5.1</span> Verify that Docker is running</h2>
<p>Docker commands can be run from a terminal (e.g., the Rstudio Terminal pane) or with a <code>system2()</code> command. (We discuss the diffeent ways of interacting with Docker and other elements in your environment in a <a href="#your-local-environment">separate chapter</a>.) The necessary functions to start, stop Docker containers and do other busy work are provided in the <code>sqlpetr</code> package. As time permits and curiosity dictates, feel free to look at those functions to see how they work.</p>
<div id="check-that-docker-is-up-and-running" class="section level3">
<h3><span class="header-section-number">5.1.1</span> Check that Docker is up and running</h3>
<blockquote>
<p>Note: The <code>sqlpetr</code> package is written to accompany this book. The functions in the package are designed to help you focus on interacting with a dbms from R. You can ignore how they work until you are ready to delve into the details. They are all named to begin with <code>sp_</code>. The first time a function is called in the book, we provide a note explaining its use.</p>
</blockquote>
<blockquote>
<p>The <code>sp_check_that_docker_is_up</code> function from the <code>sqlpetr</code> package checks whether Docker is up and running. If it’s not, then you need to install, launch or re-install Docker.</p>
</blockquote>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="kw">sp_check_that_docker_is_up</span>()</a></code></pre></div>
<pre><code>## [1] &quot;Docker is up but running no containers&quot;</code></pre>
</div>
</div>
<div id="remove-previous-containers-if-they-exist" class="section level2">
<h2><span class="header-section-number">5.2</span> Remove previous containers if they exist</h2>
<p>Force remove the <code>cattle</code> and <code>sql-pet</code> containers if they exist (e.g., from prior experiments).</p>
<blockquote>
<p>The <code>sp_docker_remove_container</code> function from the <code>sqlpetr</code> package forcibly removes a Docker container. If it is running it will be forcibly terminated and removed. If it doesn’t exist you won’t get an error message. Note that the <code>images</code> out of which a container is built will still exist on your system.</p>
</blockquote>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="kw">sp_docker_remove_container</span>(<span class="st">&quot;cattle&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="kw">sp_docker_remove_container</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<p>We name containers <code>cattle</code> for “throw-aways” and <code>pet</code> for ones we treasure and keep around. :-)</p>
<blockquote>
<p>The <code>sp_docker_remove_container</code> function from the <code>sqlpetr</code> package creates a container and runs the PostgreSQL 10 image (<code>docker.io/postgres:10</code>) in it. The image will be downloaded if it doesn’t exist locally.</p>
</blockquote>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="kw">sp_make_simple_pg</span>(<span class="st">&quot;cattle&quot;</span>)</a></code></pre></div>
<p>The first time you run this, Docker downloads the PostgreSQL image, which takes a bit of time. Did it work? The following command should show that a container named <code>cattle</code> is running <code>postgres:10</code>.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1"><span class="kw">sp_check_that_docker_is_up</span>()</a></code></pre></div>
<pre><code>## [1] &quot;Docker is up, running these containers:&quot;                                                                                                       
## [2] &quot;CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                  PORTS                    NAMES&quot;   
## [3] &quot;bf3972eaa4d8        postgres:10         \&quot;docker-entrypoint.s…\&quot;   1 second ago        Up Less than a second   0.0.0.0:5432-&gt;5432/tcp   cattle&quot;</code></pre>
<blockquote>
<p>The <code>sp_docker_containers_tibble</code> function from the <code>sqlpetr</code> package provides more on the containers that Docker is running. Basically this function creates a tibble of containers using <code>docker ps</code>.</p>
</blockquote>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1"><span class="kw">sp_docker_containers_tibble</span>()</a></code></pre></div>
<pre><code>## # A tibble: 1 x 12
##   container_id image command created_at created ports status size  names
##   &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;
## 1 bf3972eaa4d8 post… docker… 2019-03-0… 1 seco… 0.0.… Up Le… 0B (… catt…
## # … with 3 more variables: labels &lt;chr&gt;, mounts &lt;chr&gt;, networks &lt;chr&gt;</code></pre>
</div>
<div id="connecting-reading-and-writing-to-postgresql-from-r" class="section level2">
<h2><span class="header-section-number">5.3</span> Connecting, reading and writing to PostgreSQL from R</h2>
<div id="connecting-to-postgresql" class="section level3">
<h3><span class="header-section-number">5.3.1</span> Connecting to PostgreSQL</h3>
<p>The <code>sp_make_simple_pg</code> function we called above created a container from the
<code>postgres:10</code> library image downloaded from Docker Hub. As part of the process, it set the password for the PostgreSQL database superuser <code>postgres</code> to the value
“postgres”.</p>
<p>For simplicity, we are using a weak password at this point and it’s shown here
and in the code in plain text. That is bad practice because user credentials
should not be shared in open code like that. A <a href="#dbms-login">subsequent chapter</a>
demonstrates how to store and use credentials to access the DBMS so that they
are kept private.</p>
<blockquote>
<p>The <code>sp_get_postgres_connection</code> function from the <code>sqlpetr</code> package gets a DBI connection string to a PostgreSQL database, waiting if it is not ready. This function connects to an instance of PostgreSQL and we assign it to a symbol, <code>con</code>, for subsequent use.</p>
</blockquote>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1">con &lt;-<span class="st"> </span><span class="kw">sp_get_postgres_connection</span>(</a>
<a class="sourceLine" id="cb34-2" data-line-number="2">  <span class="dt">host =</span> <span class="st">&quot;localhost&quot;</span>,</a>
<a class="sourceLine" id="cb34-3" data-line-number="3">  <span class="dt">port =</span> <span class="dv">5432</span>,</a>
<a class="sourceLine" id="cb34-4" data-line-number="4">  <span class="dt">user =</span> <span class="st">&quot;postgres&quot;</span>,</a>
<a class="sourceLine" id="cb34-5" data-line-number="5">  <span class="dt">password =</span> <span class="st">&quot;postgres&quot;</span>,</a>
<a class="sourceLine" id="cb34-6" data-line-number="6">  <span class="dt">dbname =</span> <span class="st">&quot;postgres&quot;</span>,</a>
<a class="sourceLine" id="cb34-7" data-line-number="7">  <span class="dt">seconds_to_test =</span> <span class="dv">30</span></a>
<a class="sourceLine" id="cb34-8" data-line-number="8">)</a></code></pre></div>
<p>Make sure that you can connect to the PostgreSQL database that you have just started. If you have been executing the code from this tutorial, the database will not contain any tables yet:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1">DBI<span class="op">::</span><span class="kw">dbListTables</span>(con)</a></code></pre></div>
<pre><code>## character(0)</code></pre>
</div>
<div id="interact-with-postgresql" class="section level3">
<h3><span class="header-section-number">5.3.2</span> Interact with PostgreSQL</h3>
<p>Write <code>mtcars</code> to PostgreSQL</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1">DBI<span class="op">::</span><span class="kw">dbWriteTable</span>(con, <span class="st">&quot;mtcars&quot;</span>, mtcars, <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p>List the tables in the PostgreSQL database to show that <code>mtcars</code> is now there:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" data-line-number="1">DBI<span class="op">::</span><span class="kw">dbListTables</span>(con)</a></code></pre></div>
<pre><code>## [1] &quot;mtcars&quot;</code></pre>
<p>List the fields in mtcars:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" data-line-number="1">DBI<span class="op">::</span><span class="kw">dbListFields</span>(con, <span class="st">&quot;mtcars&quot;</span>)</a></code></pre></div>
<pre><code>##  [1] &quot;mpg&quot;  &quot;cyl&quot;  &quot;disp&quot; &quot;hp&quot;   &quot;drat&quot; &quot;wt&quot;   &quot;qsec&quot; &quot;vs&quot;   &quot;am&quot;   &quot;gear&quot;
## [11] &quot;carb&quot;</code></pre>
<p>Download the table from the DBMS to a local data frame:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" data-line-number="1">mtcars_df &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbReadTable</span>(con, <span class="st">&quot;mtcars&quot;</span>)</a></code></pre></div>
<blockquote>
<p>The <code>sp_print_df</code> function from the <code>sqlpetr</code> package shows (or print) a data frame depending on appropriate output type. That is when running interactively or generating HTML it prints a <code>DT::datatable()</code> while it prints a <code>knitr::kable()</code> otherwise.</p>
</blockquote>
<p>Tell Docker to <em>remove</em> the <code>cattle</code> container from it’s library of active containers:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" data-line-number="1"><span class="kw">sp_print_df</span>(<span class="kw">head</span>(mtcars_df))</a></code></pre></div>
<div id="htmlwidget-1d9f9b9fdca3023baa83" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1d9f9b9fdca3023baa83">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],[21,21,22.8,21.4,18.7,18.1],[6,6,4,6,8,6],[160,160,108,258,360,225],[110,110,93,110,175,105],[3.9,3.9,3.85,3.08,3.15,2.76],[2.62,2.875,2.32,3.215,3.44,3.46],[16.46,17.02,18.61,19.44,17.02,20.22],[0,0,1,1,0,1],[1,1,1,0,0,0],[4,4,4,3,3,3],[4,4,1,1,2,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>mpg<\/th>\n      <th>cyl<\/th>\n      <th>disp<\/th>\n      <th>hp<\/th>\n      <th>drat<\/th>\n      <th>wt<\/th>\n      <th>qsec<\/th>\n      <th>vs<\/th>\n      <th>am<\/th>\n      <th>gear<\/th>\n      <th>carb<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,6,7,8,9,10,11]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="clean-up" class="section level2">
<h2><span class="header-section-number">5.4</span> Clean up</h2>
<p>Afterwards, always disconnect from the dbms:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" data-line-number="1">DBI<span class="op">::</span><span class="kw">dbDisconnect</span>(con)</a></code></pre></div>
<blockquote>
<p>The <code>sp_docker_stop</code> function from the <code>sqlpetr</code> package stops the container given by the <code>container_name</code> parameter.</p>
</blockquote>
<p>Tell Docker to stop the <code>cattle</code> container:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" data-line-number="1"><span class="kw">sp_docker_stop</span>(<span class="st">&quot;cattle&quot;</span>)</a></code></pre></div>
<blockquote>
<p>The <code>sp_docker_remove_container</code> function from the <code>sqlpetr</code> package removes the container given by the <code>container_name</code> parameter.</p>
</blockquote>
<p>Tell Docker to <em>remove</em> the <code>cattle</code> container from it’s library of active containers:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" data-line-number="1"><span class="kw">sp_docker_remove_container</span>(<span class="st">&quot;cattle&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<p>Verify that <code>cattle</code> is gone:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb48-1" data-line-number="1"><span class="kw">sp_docker_containers_tibble</span>()</a></code></pre></div>
<pre><code>## # A tibble: 0 x 0</code></pre>
<p>If we just <strong>stop</strong> the Docker container but don’t remove it (as we did with the <code>sp_docker_remove_container(&quot;cattle&quot;)</code> command), the <code>cattle</code> container will persist and we can start it up again later with <code>sp_docker_start(&quot;cattle&quot;)</code>. In that case, <code>mtcars</code> would still be there and we could retrieve it from PostgreSQL again. Since <code>sp_docker_remove_container(&quot;cattle&quot;)</code> has removed it, the updated database has been deleted. (There are enough copies of <code>mtcars</code> in the world, so no great loss.)</p>
<!--chapter:end:040-docker-setup-postgres-connect-with-r.Rmd-->
</div>
</div>
<div id="chapter_setup-dvdrental-db" class="section level1">
<h1><span class="header-section-number">6</span> Create the dvdrental database in PostgreSQL in Docker</h1>
<blockquote>
<p>NOTE: This Chapter walks through the all steps needed to setup the dvdrental database in Docker. All susequent chapters depend on this setup. If for some reason you need to setup the Docker database but don’t want to step through this <em>teaching version</em> of the setup, you can use:</p>
<p><code>source('book-src/setup-dvdrental-docker-container.R')</code></p>
</blockquote>
<blockquote>
<p>This chapter demonstrates how to:</p>
<ul>
<li>Setup the <code>dvdrental</code> database in Docker</li>
<li>Stop and start Docker container to demonstrate persistence</li>
<li>Connect to and disconnect R from the <code>dvdrental</code> database</li>
<li>Set up the environment for subsequent chapters</li>
</ul>
</blockquote>
<div id="overview" class="section level2">
<h2><span class="header-section-number">6.1</span> Overview</h2>
<p>In the last chapter we connected to PostgreSQL from R. Now we set up a “realistic” database named <code>dvdrental</code>. There are different approaches to doing this: this chapter sets it up in a way that doesn’t show all the Docker details.</p>
<p>These packages are called in this Chapter:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb50-1" data-line-number="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb50-2" data-line-number="2"><span class="kw">library</span>(DBI)</a>
<a class="sourceLine" id="cb50-3" data-line-number="3"><span class="kw">library</span>(RPostgres)</a>
<a class="sourceLine" id="cb50-4" data-line-number="4"><span class="kw">library</span>(glue)</a>
<a class="sourceLine" id="cb50-5" data-line-number="5"><span class="kw">require</span>(knitr)</a>
<a class="sourceLine" id="cb50-6" data-line-number="6"><span class="kw">library</span>(dbplyr)</a>
<a class="sourceLine" id="cb50-7" data-line-number="7"><span class="kw">library</span>(sqlpetr)</a>
<a class="sourceLine" id="cb50-8" data-line-number="8"><span class="kw">library</span>(bookdown)</a></code></pre></div>
</div>
<div id="verify-that-docker-is-up-and-running" class="section level2">
<h2><span class="header-section-number">6.2</span> Verify that Docker is up and running</h2>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb51-1" data-line-number="1"><span class="kw">sp_check_that_docker_is_up</span>()</a></code></pre></div>
<pre><code>## [1] &quot;Docker is up but running no containers&quot;</code></pre>
</div>
<div id="clean-up-if-appropriate" class="section level2">
<h2><span class="header-section-number">6.3</span> Clean up if appropriate</h2>
<p>Force-remove the <code>cattle</code> and <code>sql-pet</code> containers if they exist (e.g., from a prior runs):</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb53-1" data-line-number="1"><span class="kw">sp_docker_remove_container</span>(<span class="st">&quot;cattle&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb55-1" data-line-number="1"><span class="kw">sp_docker_remove_container</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
</div>
<div id="build-the-pet-sql-docker-image" class="section level2">
<h2><span class="header-section-number">6.4</span> Build the pet-sql Docker image</h2>
<p>For the rest of the book we will be using a Docker image called
<code>postgres-dvdrental</code>. To save space here in the book, we’ve created a function
in <code>sqlpetr</code> to build this image, called <a href="https://smithjd.github.io/sqlpetr/reference/sp_make_dvdrental_image.html"><code>sp_make_dvdrental_image</code></a>. Vignette <a href="https://smithjd.github.io/sqlpetr/articles/building-the-dvdrental-docker-image.html">Building the <code>dvdrental</code> Docker Image</a> describes the build process.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb57-1" data-line-number="1"><span class="kw">sp_make_dvdrental_image</span>(<span class="st">&quot;postgres-dvdrental&quot;</span>)</a></code></pre></div>
<p>Did it work? We have a function that lists the images into a tibble!</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb58-1" data-line-number="1"><span class="kw">sp_docker_images_tibble</span>()</a></code></pre></div>
<pre><code>## # A tibble: 6 x 7
##   image_id  repository   tag    digest           created created_at   size 
##   &lt;chr&gt;     &lt;chr&gt;        &lt;chr&gt;  &lt;chr&gt;            &lt;chr&gt;   &lt;chr&gt;        &lt;chr&gt;
## 1 22e0c193… postgres-dv… latest &lt;none&gt;           3 days… 2019-02-28 … 251MB
## 2 ac25c2ba… postgres     10     sha256:b5f07874… 6 mont… 2018-09-04 … 228MB
## 3 93ca3834… r-base       latest sha256:3801677d… 7 mont… 2018-07-16 … 678MB
## 4 23e8b4b8… postgres     latest sha256:d8011033… 7 mont… 2018-07-16 … 236MB
## 5 74f8760a… ubuntu       latest sha256:30e04dda… 7 mont… 2018-07-16 … 82.4…
## 6 11cd0b38… alpine       latest sha256:70430763… 8 mont… 2018-07-06 … 4.41…</code></pre>
</div>
<div id="run-the-pet-sql-docker-image" class="section level2">
<h2><span class="header-section-number">6.5</span> Run the pet-sql Docker Image</h2>
<p>Now we can run the image in a container and connect to the database. To run the
image we use an <code>sqlpetr</code> function called <a href="https://smithjd.github.io/sqlpetr/reference/sp_pg_docker_run.html"><code>sp_pg_docker_run</code></a></p>
<p>When the image runs in the container, we can mount the current working directory
into a path in the container. You’ll see this in action in a future chapter.
Docker will create this path if it doesn’t exist.</p>
<p>To specify the path, set the parameter <code>mount_here_as</code> to the name you want.
Rules for the name:</p>
<ul>
<li>If you don’t want to mount into the container, specify <code>NULL</code>. This is the
default!</li>
<li>The name must start with a <code>/</code> and be a valid absolute path.
The name should contain only slashes, letters, numbers and underscores. Other characters may or may not work. The <code>snakecase</code> package is your friend.</li>
</ul>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb60-1" data-line-number="1"><span class="kw">sp_pg_docker_run</span>(</a>
<a class="sourceLine" id="cb60-2" data-line-number="2">  <span class="dt">container_name =</span> <span class="st">&quot;sql-pet&quot;</span>,</a>
<a class="sourceLine" id="cb60-3" data-line-number="3">  <span class="dt">image_tag =</span> <span class="st">&quot;postgres-dvdrental&quot;</span>,</a>
<a class="sourceLine" id="cb60-4" data-line-number="4">  <span class="dt">postgres_password =</span> <span class="st">&quot;postgres&quot;</span>,</a>
<a class="sourceLine" id="cb60-5" data-line-number="5">  <span class="dt">mount_here_as =</span> <span class="st">&quot;/petdir&quot;</span></a>
<a class="sourceLine" id="cb60-6" data-line-number="6">)</a></code></pre></div>
<p>Did it work?</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb61-1" data-line-number="1"><span class="kw">sp_docker_containers_tibble</span>()</a></code></pre></div>
<pre><code>## # A tibble: 1 x 12
##   container_id image command created_at created ports status size  names
##   &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;
## 1 ce3accea3583 post… docker… 2019-03-0… 1 seco… 0.0.… Up Le… 0B (… sql-…
## # … with 3 more variables: labels &lt;chr&gt;, mounts &lt;chr&gt;, networks &lt;chr&gt;</code></pre>
</div>
<div id="connect-to-postgresql-with-r" class="section level2">
<h2><span class="header-section-number">6.6</span> Connect to PostgreSQL with R</h2>
<p>Use the DBI package to connect to the <code>dvdrental</code> database in PostgreSQL. Remember the settings discussion about [keeping passwords hidden][Pause for some security considerations]</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb63-1" data-line-number="1">con &lt;-<span class="st"> </span><span class="kw">sp_get_postgres_connection</span>(</a>
<a class="sourceLine" id="cb63-2" data-line-number="2">  <span class="dt">host =</span> <span class="st">&quot;localhost&quot;</span>,</a>
<a class="sourceLine" id="cb63-3" data-line-number="3">  <span class="dt">port =</span> <span class="dv">5432</span>,</a>
<a class="sourceLine" id="cb63-4" data-line-number="4">  <span class="dt">user =</span> <span class="st">&quot;postgres&quot;</span>,</a>
<a class="sourceLine" id="cb63-5" data-line-number="5">  <span class="dt">password =</span> <span class="st">&quot;postgres&quot;</span>,</a>
<a class="sourceLine" id="cb63-6" data-line-number="6">  <span class="dt">dbname =</span> <span class="st">&quot;dvdrental&quot;</span>,</a>
<a class="sourceLine" id="cb63-7" data-line-number="7">  <span class="dt">seconds_to_test =</span> <span class="dv">30</span></a>
<a class="sourceLine" id="cb63-8" data-line-number="8">)</a></code></pre></div>
<p>List the tables in the database and the fields in one of those tables.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb64-1" data-line-number="1"><span class="kw">dbListTables</span>(con)</a></code></pre></div>
<pre><code>##  [1] &quot;actor_info&quot;                 &quot;customer_list&quot;             
##  [3] &quot;film_list&quot;                  &quot;nicer_but_slower_film_list&quot;
##  [5] &quot;sales_by_film_category&quot;     &quot;staff&quot;                     
##  [7] &quot;sales_by_store&quot;             &quot;staff_list&quot;                
##  [9] &quot;category&quot;                   &quot;film_category&quot;             
## [11] &quot;country&quot;                    &quot;actor&quot;                     
## [13] &quot;language&quot;                   &quot;inventory&quot;                 
## [15] &quot;payment&quot;                    &quot;rental&quot;                    
## [17] &quot;city&quot;                       &quot;store&quot;                     
## [19] &quot;film&quot;                       &quot;address&quot;                   
## [21] &quot;film_actor&quot;                 &quot;customer&quot;</code></pre>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb66-1" data-line-number="1"><span class="kw">dbListFields</span>(con, <span class="st">&quot;rental&quot;</span>)</a></code></pre></div>
<pre><code>## [1] &quot;rental_id&quot;    &quot;rental_date&quot;  &quot;inventory_id&quot; &quot;customer_id&quot; 
## [5] &quot;return_date&quot;  &quot;staff_id&quot;     &quot;last_update&quot;</code></pre>
<p>Disconnect from the database:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb68-1" data-line-number="1"><span class="kw">dbDisconnect</span>(con)</a></code></pre></div>
</div>
<div id="stop-and-start-to-demonstrate-persistence" class="section level2">
<h2><span class="header-section-number">6.7</span> Stop and start to demonstrate persistence</h2>
<p>Stop the container:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb69-1" data-line-number="1"><span class="kw">sp_docker_stop</span>(<span class="st">&quot;sql-pet&quot;</span>)</a>
<a class="sourceLine" id="cb69-2" data-line-number="2"><span class="kw">sp_docker_containers_tibble</span>()</a></code></pre></div>
<pre><code>## # A tibble: 0 x 0</code></pre>
<p>When we stopped <code>sql-pet</code>, it no longer appeared in the tibble. But the
container is still there. <code>sp_docker_containers_tibble</code> by default only lists
the <em>running</em> containers. But we can use the <code>list_all</code> option and see it:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb71-1" data-line-number="1"><span class="kw">sp_docker_containers_tibble</span>(<span class="dt">list_all =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>## # A tibble: 1 x 12
##   container_id image command created_at created ports status size  names
##   &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;
## 1 ce3accea3583 post… docker… 2019-03-0… 5 seco… &lt;NA&gt;  Exite… 0B (… sql-…
## # … with 3 more variables: labels &lt;chr&gt;, mounts &lt;chr&gt;, networks &lt;chr&gt;</code></pre>
<p>Restart the container and verify that the dvdrental tables are still there:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb73-1" data-line-number="1"><span class="kw">sp_docker_start</span>(<span class="st">&quot;sql-pet&quot;</span>)</a>
<a class="sourceLine" id="cb73-2" data-line-number="2"><span class="kw">sp_docker_containers_tibble</span>()</a></code></pre></div>
<pre><code>## # A tibble: 1 x 12
##   container_id image command created_at created ports status size  names
##   &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;
## 1 ce3accea3583 post… docker… 2019-03-0… 6 seco… 0.0.… Up Le… 63B … sql-…
## # … with 3 more variables: labels &lt;chr&gt;, mounts &lt;chr&gt;, networks &lt;chr&gt;</code></pre>
<p>Connect to the <code>dvdrental</code> database in PostgreSQL:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb75-1" data-line-number="1">con &lt;-<span class="st"> </span><span class="kw">sp_get_postgres_connection</span>(</a>
<a class="sourceLine" id="cb75-2" data-line-number="2">  <span class="dt">host =</span> <span class="st">&quot;localhost&quot;</span>,</a>
<a class="sourceLine" id="cb75-3" data-line-number="3">  <span class="dt">port =</span> <span class="dv">5432</span>,</a>
<a class="sourceLine" id="cb75-4" data-line-number="4">  <span class="dt">user =</span> <span class="st">&quot;postgres&quot;</span>,</a>
<a class="sourceLine" id="cb75-5" data-line-number="5">  <span class="dt">password =</span> <span class="st">&quot;postgres&quot;</span>,</a>
<a class="sourceLine" id="cb75-6" data-line-number="6">  <span class="dt">dbname =</span> <span class="st">&quot;dvdrental&quot;</span>,</a>
<a class="sourceLine" id="cb75-7" data-line-number="7">  <span class="dt">seconds_to_test =</span> <span class="dv">30</span></a>
<a class="sourceLine" id="cb75-8" data-line-number="8">)</a></code></pre></div>
<p>Check that you can still see the fields in the <code>rental</code> table:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb76-1" data-line-number="1"><span class="kw">dbListFields</span>(con, <span class="st">&quot;rental&quot;</span>)</a></code></pre></div>
<pre><code>## [1] &quot;rental_id&quot;    &quot;rental_date&quot;  &quot;inventory_id&quot; &quot;customer_id&quot; 
## [5] &quot;return_date&quot;  &quot;staff_id&quot;     &quot;last_update&quot;</code></pre>
</div>
<div id="cleaning-up" class="section level2">
<h2><span class="header-section-number">6.8</span> Cleaning up</h2>
<p>Always have R disconnect from the database when you’re done.</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb78-1" data-line-number="1"><span class="kw">dbDisconnect</span>(con)</a></code></pre></div>
<p>Stop the <code>sql-pet</code> container:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb79-1" data-line-number="1"><span class="kw">sp_docker_stop</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<p>Show that the container still exists even though it’s not running</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb80-1" data-line-number="1"><span class="kw">sp_show_all_docker_containers</span>()</a></code></pre></div>
<pre><code>## CONTAINER ID        IMAGE                COMMAND                  CREATED             STATUS                              PORTS               NAMES
## ce3accea3583        postgres-dvdrental   &quot;docker-entrypoint.s…&quot;   7 seconds ago       Exited (0) Less than a second ago                       sql-pet</code></pre>
<p>Next time, you can just use this command to start the container:</p>
<blockquote>
<p><code>sp_docker_start(&quot;sql-pet&quot;)</code></p>
</blockquote>
<p>And once stopped, the container can be removed with:</p>
<blockquote>
<p><code>sp_check_that_docker_is_up(&quot;sql-pet&quot;)</code></p>
</blockquote>
</div>
<div id="using-the-sql-pet-container-in-the-rest-of-the-book" class="section level2">
<h2><span class="header-section-number">6.9</span> Using the <code>sql-pet</code> container in the rest of the book</h2>
<p>After this point in the book, we assume that Docker is up and that we can always start up our <em>sql-pet database</em> with:</p>
<blockquote>
<p><code>sp_docker_start(&quot;sql-pet&quot;)</code></p>
</blockquote>
<!--chapter:end:050-docker-setup-postgres-with-dvdrental.Rmd-->
</div>
</div>
<div id="chapter_dbms-login-credentials" class="section level1">
<h1><span class="header-section-number">7</span> Securing and using your dbms log-in credentials</h1>
<blockquote>
<p>This chapter demonstrates how to:</p>
<ul>
<li>Keep necessary credentials secret or at least invisible</li>
<li>Interact with PostgreSQL using your stored dbms credentials</li>
</ul>
</blockquote>
<p>Connecting to a dbms can be very frustrating at first. In many organizations, simply <strong>getting</strong> access credentials takes time and may involve jumping through multiple hoops. In addition, a dbms is terse or deliberately inscrutable when your credetials are incorrect. That’s a security strategy, not a limitation of your understanding or of your software. When R can’t log you on to a dbms, you usually will have no information as to what went wrong.</p>
<p>There are many different strategies for managing credentials. See <a href="https://db.rstudio.com/best-practices/managing-credentials/">Securing Credentials</a> in RStudio’s <em>Databases using R</em> documentation for some alternatives to the method we adopt in this book. We provide more details about <a href="#chapter_appendix-postresql-authentication">PostgreSQL Authentication</a> in our sandbox environment in an appendix.</p>
<p>The following packages are used in this chapter:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb82-1" data-line-number="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb82-2" data-line-number="2"><span class="kw">library</span>(DBI)</a>
<a class="sourceLine" id="cb82-3" data-line-number="3"><span class="kw">library</span>(RPostgres)</a>
<a class="sourceLine" id="cb82-4" data-line-number="4"><span class="kw">require</span>(knitr)</a>
<a class="sourceLine" id="cb82-5" data-line-number="5"><span class="kw">library</span>(sqlpetr)</a></code></pre></div>
<div id="set-up-the-sql-pet-docker-container" class="section level2">
<h2><span class="header-section-number">7.1</span> Set up the sql-pet Docker container</h2>
<div id="verify-that-docker-is-running-1" class="section level3">
<h3><span class="header-section-number">7.1.1</span> Verify that Docker is running</h3>
<p>Check that Docker is up and running:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb83-1" data-line-number="1"><span class="kw">sp_check_that_docker_is_up</span>()</a></code></pre></div>
<pre><code>## [1] &quot;Docker is up but running no containers&quot;</code></pre>
</div>
<div id="start-the-docker-container" class="section level3">
<h3><span class="header-section-number">7.1.2</span> Start the Docker container:</h3>
<p>Start the sql-pet Docker container:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb85-1" data-line-number="1"><span class="kw">sp_docker_start</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
</div>
</div>
<div id="storing-your-dbms-credentials" class="section level2">
<h2><span class="header-section-number">7.2</span> Storing your dbms credentials</h2>
<p>In previous chapters the connection string for connecting to the dbms has used default credentials specified in plain text as follows:</p>
<p><code>user= 'postgres', password = 'postgres'</code></p>
<p>When we call <code>sp_get_postgres_connection</code> below we’ll use environment variables that R obtains from reading the <em>.Renviron</em> file when R starts up. This approach has two benefits: that file is not uploaded to GitHub and R looks for it in your default directory every time it loads. To see whether you have already created that file, use the R Studio Files tab to look at your <strong>home directory</strong>:</p>
<p><img src="screenshots/locate-renviron-file.png" /></p>
<p>That file should contain lines that <strong>look like</strong> the example below. Although in this example it contains the PostgreSQL <b>default values</b> for the username and password, they are obviously not secret. But this approach demonstrates where you should put secrets that R needs while not risking accidental uploaded to GitHub or some other public location..</p>
<p>Open your <code>.Renviron</code> file with this command:</p>
<blockquote>
<p><code>file.edit(&quot;~/.Renviron&quot;)</code></p>
</blockquote>
<p>Or you can execute <a href="define_postgresql_params.R">define_postgresql_params.R</a> to create the file or you could copy / paste the following into your <strong>.Renviron</strong> file:</p>
<pre><code>DEFAULT_POSTGRES_PASSWORD=postgres
DEFAULT_POSTGRES_USER_NAME=postgres</code></pre>
<p>Once that file is created, restart R, and after that R reads it every time it comes up.</p>
<div id="connect-with-postgres-using-the-sys.getenv-function" class="section level3">
<h3><span class="header-section-number">7.2.1</span> Connect with Postgres using the Sys.getenv function</h3>
<p>Connect to the postgrSQL using the <code>sp_get_postgres_connection</code> function:</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb87-1" data-line-number="1">con &lt;-<span class="st"> </span><span class="kw">sp_get_postgres_connection</span>(<span class="dt">user =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_USER_NAME&quot;</span>),</a>
<a class="sourceLine" id="cb87-2" data-line-number="2">                         <span class="dt">password =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_PASSWORD&quot;</span>),</a>
<a class="sourceLine" id="cb87-3" data-line-number="3">                         <span class="dt">dbname =</span> <span class="st">&quot;dvdrental&quot;</span>,</a>
<a class="sourceLine" id="cb87-4" data-line-number="4">                         <span class="dt">seconds_to_test =</span> <span class="dv">30</span>)</a></code></pre></div>
<p>Once the connection object has been created, you can list all of the tables in the database:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb88-1" data-line-number="1"><span class="kw">dbListTables</span>(con)</a></code></pre></div>
<pre><code>##  [1] &quot;actor_info&quot;                 &quot;customer_list&quot;             
##  [3] &quot;film_list&quot;                  &quot;nicer_but_slower_film_list&quot;
##  [5] &quot;sales_by_film_category&quot;     &quot;staff&quot;                     
##  [7] &quot;sales_by_store&quot;             &quot;staff_list&quot;                
##  [9] &quot;category&quot;                   &quot;film_category&quot;             
## [11] &quot;country&quot;                    &quot;actor&quot;                     
## [13] &quot;language&quot;                   &quot;inventory&quot;                 
## [15] &quot;payment&quot;                    &quot;rental&quot;                    
## [17] &quot;city&quot;                       &quot;store&quot;                     
## [19] &quot;film&quot;                       &quot;address&quot;                   
## [21] &quot;film_actor&quot;                 &quot;customer&quot;</code></pre>
</div>
</div>
<div id="clean-up-1" class="section level2">
<h2><span class="header-section-number">7.3</span> Clean up</h2>
<p>Afterwards, always disconnect from the dbms:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb90-1" data-line-number="1"><span class="kw">dbDisconnect</span>(con)</a></code></pre></div>
<p>Tell Docker to stop the <code>sql-pet</code> container:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb91-1" data-line-number="1"><span class="kw">sp_docker_stop</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<!--chapter:end:060-secure-and-use-dbms-credentials-in-r.Rmd-->
</div>
</div>
<div id="chapter_your-local-environment" class="section level1">
<h1><span class="header-section-number">8</span> Mapping your local environment</h1>
<blockquote>
<p>This chapter explores:</p>
<ul>
<li>The different entities involved in running the examples in this book’s sandbox</li>
<li>The different roles that each entity plays in the sandbox</li>
<li>How those entities are connected and how communication between those entities happens</li>
<li>Pointers to the commands that go with each entity</li>
</ul>
</blockquote>
<p>These packages are used in this chapter:</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb92-1" data-line-number="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb92-2" data-line-number="2"><span class="kw">library</span>(DBI)</a>
<a class="sourceLine" id="cb92-3" data-line-number="3"><span class="kw">library</span>(RPostgres)</a>
<a class="sourceLine" id="cb92-4" data-line-number="4"><span class="kw">require</span>(knitr)</a>
<a class="sourceLine" id="cb92-5" data-line-number="5"><span class="kw">library</span>(dbplyr)</a>
<a class="sourceLine" id="cb92-6" data-line-number="6"><span class="kw">library</span>(sqlpetr)</a>
<a class="sourceLine" id="cb92-7" data-line-number="7"><span class="kw">library</span>(DiagrammeR)</a>
<a class="sourceLine" id="cb92-8" data-line-number="8">display_rows &lt;-<span class="st"> </span><span class="dv">5</span></a></code></pre></div>
<div id="set-up-our-standard-pet-sql-environment" class="section level2">
<h2><span class="header-section-number">8.1</span> Set up our standard pet-sql environment</h2>
<p>Assume that the Docker container with PostgreSQL and the dvdrental database are ready to go. Start up the <code>docker-pet</code> container:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb93-1" data-line-number="1"><span class="kw">sp_docker_start</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<p>Connect to the <code>dvdrental</code> database with R.</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb94-1" data-line-number="1">con &lt;-<span class="st"> </span><span class="kw">sp_get_postgres_connection</span>(</a>
<a class="sourceLine" id="cb94-2" data-line-number="2">  <span class="dt">user =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_USER_NAME&quot;</span>),</a>
<a class="sourceLine" id="cb94-3" data-line-number="3">  <span class="dt">password =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_PASSWORD&quot;</span>),</a>
<a class="sourceLine" id="cb94-4" data-line-number="4">  <span class="dt">dbname =</span> <span class="st">&quot;dvdrental&quot;</span>,</a>
<a class="sourceLine" id="cb94-5" data-line-number="5">  <span class="dt">seconds_to_test =</span> <span class="dv">30</span></a>
<a class="sourceLine" id="cb94-6" data-line-number="6">)</a></code></pre></div>
</div>
<div id="sandbox-environment" class="section level2">
<h2><span class="header-section-number">8.2</span> Sandbox Environment</h2>
<p>Here is an overview of our sandbox environment. In this chapter we explore each of the entities in the sandbox, how they are connected and how they communicate with each other. You can skip this chapter and come back later when you are curious about the setup that we’re using in this book.</p>
<center>
<img src="screenshots/your-environment-diagram.png" />
</center>
<div id="sandbox-entities-and-their-roles" class="section level3">
<h3><span class="header-section-number">8.2.1</span> Sandbox entities and their roles</h3>
</div>
<div id="rstudio" class="section level3">
<h3><span class="header-section-number">8.2.2</span> RStudio</h3>
<p>You communicate with Rstudio, which can send commands to both R and to Unix. Commands to your OS can be entered directly in the terminal pane or via an R function like <code>exec2()</code>. On a Unix or Mac computer, you typically communicate with <code>bash</code>, while you have several choices on a Windows computer.</p>
<p>The following two screenshots show the default options available for the <code>Terminal</code> option in RStudio’s <code>Preferences</code> for Mac and Windows, respectively.</p>
<div class="figure">
<img src="screenshots/rstudio-shell-choices-on-mac.png" alt="Mac choices" />
<p class="caption">Mac choices</p>
</div>
<div class="figure">
<img src="screenshots/rstudio-shell-choices-on-windows.png" alt="Windows choices" />
<p class="caption">Windows choices</p>
</div>
<p>To check on the RStudio version you are using, enter this R command:</p>
<blockquote>
<p><code>require(rstudioapi)</code> <br>
<code>versionInfo()</code></p>
</blockquote>
<p>The <a href="https://www.rstudio.com/resources/cheatsheets/#ide">RStudio IDE cheat sheet</a> (<a href="https://github.com/rstudio/cheatsheets/raw/master/rstudio-ide.pdf">PDF</a>) is handy for learning your way around the IDE.</p>
</div>
<div id="os-local-command-line-interface" class="section level3">
<h3><span class="header-section-number">8.2.3</span> OS / local command line interface</h3>
<p>You can type commands directly into a terminal window on your computer to communicate with your operating system (OS). It will be a <code>bash</code> prompt on a Unix or Mac, but could be one of several flavors on Windows. Our diagram conflates the operating system with the command line interface (CLI) which is a bit of a simplification as discussed below.</p>
<p>In addition to operating system commands, you can communicate with the Docker client through the CLI to start and stop the Docker server, load containers with programs such as Unix, PostgreSQL, communicae with those programs, etc.</p>
<p>To check on the OS version you are using, enter this on your RStudio terminal or local CLI:</p>
<blockquote>
<p><code>uname -a</code></p>
</blockquote>
<p>An OS can contain different comand line interfaces. Check on it with this on your RStudio terminal or local CLI:</p>
<blockquote>
<p><code>echo $0</code></p>
</blockquote>
<p>A <a href="http://cheatsheetworld.com/programming/unix-linux-cheat-sheet/">Unix / Linux command line cheet</a> sheet is a handy reference.</p>
</div>
<div id="r-1" class="section level3">
<h3><span class="header-section-number">8.2.4</span> R</h3>
<p>R processes instructions from Rstudio. It can send instructions to your OS via the <code>system2</code> function. R can also talk directly to PostgreSQL through the DBI package.</p>
<p>R functions like <code>file.info(&quot;file.typ&quot;)</code> communicate with your operating system, but do not visibly issue a command to your CLI. That’s an example of an equivalence that can be useful or confusing (as in our environment diagram): you can get the same information from <code>ls -ql README.md</code> on a Unix command line as <code>file.info(&quot;README.md&quot;)</code> on the R console.</p>
<p>Although this sandbox seeks to make it easy, connecting to the database often involves technical and organizational hurdles like getting authorization. The main purpose of this book is to provide a sandbox for database queries to experiment with sending commands with one of the <em>DBI</em> functions to the dbms directly from R. However, Docker and PostreSQL commands are useful to know and may be necessary in extending the book’s examples.</p>
<p>To check on the version of R that you are using, enter this on your R Console command line:</p>
<blockquote>
<p><code>R.version</code></p>
</blockquote>
<p>The <a href="https://www.rstudio.com/resources/cheatsheets/">growing collection of RStudio cheet sheets</a> is indispensable.</p>
</div>
<div id="docker-client" class="section level3">
<h3><span class="header-section-number">8.2.5</span> Docker client</h3>
<p>The docker client sets up the Docker server, loads containers, and passes instructions from your OS to the programs running in the Docker server. A Docker container will always contain a subset of the Linux operating system, so that it contains a second CLI in your sandbox. See more about the <a href="https://docs.docker.com/engine/docker-overview/#the-docker-platform">Docker environment</a>.</p>
<p>In addition to interaction with Docker through your computer’s CLI or the RStudio Terminal pane, the <a href="https://bhaskarvk.github.io/docker/"><code>docker</code></a> and
<a href="https://richfitz.github.io/stevedore/"><code>stevedore</code></a> packages can communicate with Docker from R. Both packages rely on the <code>reticulate</code> package and python.</p>
<p>For this book, we chose to send instructions to Docker through R’s <code>system2()</code> function calls which do pass commands along to Docker through your computer’s CLI. We chose that route in order to be as transparent as possible and because the book’s sandbox environment is fairly simple. Although Docker has 44 different commands, in this book we only use a subset: <code>ps</code>, <code>build</code>, <code>run</code>, <code>exec</code>, <code>start</code>, <code>stop</code>, and <code>rm</code>. We wrap all of these commands in <code>sqlpetr</code> package functions to encourage you to focus on R and PostgreSQL.</p>
<p>To check on the Docker version you are using, enter this on your RStudio Terminal or local CLI:</p>
<blockquote>
<p><code>docker version</code></p>
</blockquote>
<p>To see what images (if any) are stored locally and available for running in Docker, enter this on your RStudio Terminal or local CLI:</p>
<blockquote>
<p><code>docker image ls</code></p>
</blockquote>
<p>There are many Docker command-line cheat sheets; <a href="https://dockercheatsheet.painlessdocker.com/">this one</a> is recommended.</p>
</div>
<div id="in-docker-linux" class="section level3">
<h3><span class="header-section-number">8.2.6</span> In Docker: Linux</h3>
<p>Docker runs a subset of the Linux operating system that in turn runs other programs like psql or PostgreSQL. You may want to poke around the Linux environment inside Docker. To find what version of Linux Docker is running, enter the following command on your local CLI or in the RStudio Terminal pane:</p>
<blockquote>
<p><code>docker exec -ti sql-pet uname -a</code></p>
</blockquote>
<p>As Linux can itself have different CLIs, enter the following command on your local CLI or in the RStudio Terminal pane to find out which CLI is running inside Docker:</p>
<blockquote>
<p><code>docker exec -ti sql-pet echo $0</code></p>
</blockquote>
<p>To enter an interactive session inside Docker’s Linux environment, enter the following command on your local CLI or in the RStudio Terminal pane:</p>
<blockquote>
<p><code>docker exec -ti sql-pet bash</code></p>
</blockquote>
<p>To exit, enter:</p>
<blockquote>
<p><code>exit</code></p>
</blockquote>
<p>A <a href="http://cheatsheetworld.com/programming/unix-linux-cheat-sheet/">Unix / Linux command line cheet</a> sheet is a handy reference.</p>
</div>
<div id="in-docker-psql" class="section level3">
<h3><span class="header-section-number">8.2.7</span> In Docker: <code>psql</code></h3>
<p>If you are comfortable executing SQL from a command line directly against the database, you can run the <code>psql</code> application in our Docker environment. To start up a <code>psql</code> session to investigate PostgreSQL from a command line enter the following command on your computer’s CLI or the RStudio Terminal pane:</p>
<blockquote>
<p><code>$ docker exec -ti sql-pet psql -a -p 5432 -d dvdrental -U postgres</code></p>
</blockquote>
<p>Exit that environment with:</p>
<blockquote>
<p><code>\q</code></p>
</blockquote>
<p>Us this handy psql cheat sheet (<a href="https://gpdb.docs.pivotal.io/gs/43/pdf/PSQLQuickRef.pdf">PDF</a>) to get around.</p>
</div>
<div id="in-docker-postgresql" class="section level3">
<h3><span class="header-section-number">8.2.8</span> In Docker: <code>PostgreSQL</code></h3>
<p>The PostgreSQL database is a whole environment unto itself. It can receive instructions through bash from <code>psql</code>, and it will respond to <code>DBI</code> queries from R on port 5282.</p>
<p>To check on the version of PostgreSQL <em>client</em> (e.g., <code>psql</code>) you are using, enter this on your RStudio terminal or local command line interface:</p>
<blockquote>
<p><code>docker exec -ti sql-pet psql --version</code></p>
</blockquote>
<p>To check on the version of PostgreSQL <em>server</em> you are running in Docker, enter this on your RStudio Terminal or local command line interface:</p>
<blockquote>
<p><code>docker exec -ti sql-pet psql -U postgres -c 'select version();'</code></p>
</blockquote>
<p>Here’s a recommended PostgreSQL cheat sheet (<a href="http://www.postgresqltutorial.com/wp-content/uploads/2018/03/PostgreSQL-Cheat-Sheet.pdf">PDF</a>).</p>
</div>
</div>
<div id="getting-there-from-here-entity-connections-equivalence-and-commands" class="section level2">
<h2><span class="header-section-number">8.3</span> Getting there from here: entity connections, equivalence, and commands</h2>
<p>pathways, equivalences, command structures.</p>
<p>We use two trivial commands to explore the various <em>interfaces</em>. <code>ls -l</code> is the unix command for listing information about a file and <code>\du</code> is the psql command to list the users that exist in PostgreSQL.</p>
<p>Your OS and the OS inside Docker may be looking at the same file but they are in different time zones.</p>
<div id="get-info-on-a-local-file-from-r-code" class="section level3">
<h3><span class="header-section-number">8.3.1</span> Get info on a local file from R code</h3>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb95-1" data-line-number="1"><span class="kw">file.info</span>(<span class="st">&quot;README.md&quot;</span>)</a></code></pre></div>
<pre><code>##           size isdir mode               mtime               ctime
## README.md 4493 FALSE  644 2019-02-17 13:04:05 2019-02-17 13:04:05
##                         atime uid gid uname grname
## README.md 2019-02-17 13:04:05 502  80   jds  admin</code></pre>
<p>The equivalent information from executing a command on the CLI or Terminal would be</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb97-1" data-line-number="1"><span class="kw">system2</span>(<span class="st">&quot;ls&quot;</span>,  <span class="st">&quot;-l README.md&quot;</span>, <span class="dt">stdout =</span> <span class="ot">TRUE</span>, <span class="dt">stderr =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
</div>
<div id="get-info-on-the-same-os-file-inside-docker-from-r-code" class="section level3">
<h3><span class="header-section-number">8.3.2</span> Get info on the same OS file inside Docker from R Code</h3>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb98-1" data-line-number="1"><span class="kw">system2</span>(<span class="st">&quot;docker&quot;</span>, <span class="st">&quot;exec sql-pet ls -l petdir/README.md&quot;</span>, <span class="dt">stdout =</span> <span class="ot">TRUE</span>, <span class="dt">stderr =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code>## [1] &quot;-rw-r--r-- 1 root root 4493 Feb 17 21:04 petdir/README.md&quot;</code></pre>
</div>
<div id="docker-and-psql-together-from-r-or-your-cli" class="section level3">
<h3><span class="header-section-number">8.3.3</span> Docker and psql together from R or your CLI</h3>
<p>As you become familiar with using Docker, you’ll see that there are various ways to do any given task. Here’s an illustration of how to get a list of users who have access to the PostegreSQL database.</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb100-1" data-line-number="1"><span class="kw">system2</span>(<span class="st">&quot;docker&quot;</span>, <span class="st">&quot;exec sql-pet psql -U postgres -c &#39;</span><span class="ch">\\</span><span class="st">du&#39; &quot;</span>, </a>
<a class="sourceLine" id="cb100-2" data-line-number="2">        <span class="dt">stdout =</span> <span class="ot">TRUE</span>, <span class="dt">stderr =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code>## [1] &quot;                                   List of roles&quot;                                    
## [2] &quot; Role name |                         Attributes                         | Member of &quot;
## [3] &quot;-----------+------------------------------------------------------------+-----------&quot;
## [4] &quot; postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | {}&quot;        
## [5] &quot;&quot;</code></pre>
<p>From the RStudio Terminal window, the equivalent would be a matter of dropping off some of the R code:</p>
<blockquote>
<p><code>docker exec -it sql-pet psql -U postgres -c '\du'</code></p>
</blockquote>
</div>
<div id="nesting-commands-illustrates-how-entities-are-connected" class="section level3">
<h3><span class="header-section-number">8.3.4</span> Nesting commands illustrates how entities are connected</h3>
<p>The following table illustrates how the different entities communicate with each other by decomposing a command from the chapter on <a href="#step-at-a-time-docker">creating a Docker container one step at a time</a>:</p>
<blockquote>
<p><code>system2(&quot;docker&quot;, &quot;exec sql-pet pg_restore -U postgres -d dvdrental petdir/dvdrental.tar&quot;, stdout = TRUE, stderr = TRUE)</code></p>
</blockquote>
<table>
<colgroup>
<col width="57%" />
<col width="42%" />
</colgroup>
<thead>
<tr class="header">
<th>Code element</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>system2(</code></td>
<td>R command to send instructions to your computer’s CLI.</td>
</tr>
<tr class="even">
<td><code>&quot;docker&quot;,</code></td>
<td>The program (docker) on your computer that will interpret the commands passed from the <code>system2</code> function.</td>
</tr>
<tr class="odd">
<td><code>&quot;</code></td>
<td>The entire string within the quotes is passed to docker</td>
</tr>
<tr class="even">
<td><code>exec sql-pet</code></td>
<td><code>exec</code> will pass a command to any program running in the <code>sql-pet</code> container.</td>
</tr>
<tr class="odd">
<td><code>pg_restore</code></td>
<td><code>pg_restore</code> is the program inside the <code>sql-pet</code> container that processes instructions to restore a previously downloaded backup file.</td>
</tr>
<tr class="even">
<td><code>-U postgres -d dvdrental</code> <code>petdir/dvdrental.tar</code></td>
<td>The <code>pg_restore</code> program requires a username, a database and a backup file to be restored.</td>
</tr>
<tr class="odd">
<td><code>&quot;,</code></td>
<td>End of the docker commands passed to the <code>system2</code> function in R.</td>
</tr>
<tr class="even">
<td><code>stdout = TRUE, stderr = TRUE)</code></td>
<td>The <code>system2</code> function needs to know what to do with its output, which in this case is to print all of it.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="exercises" class="section level2">
<h2><span class="header-section-number">8.4</span> Exercises</h2>
<p>Docker containers have a small foot print. In our container, we are running a limited Linux kernel and a PostgreSQL database. To show how tiny the Docker environment is, we will look at all the processes running inside Docker and the top level file structure.</p>
<p>In the following exercises, use the <code>-i</code> option and the CONTAINER = <code>sql-pet</code>.</p>
<p>Start up R/RStudio and convert the CLI command to an R/RStudio command</p>
<table>
<colgroup>
<col width="2%" />
<col width="21%" />
<col width="34%" />
<col width="23%" />
<col width="18%" />
</colgroup>
<thead>
<tr class="header">
<th>#</th>
<th>Question</th>
<th>Docker CLI Command</th>
<th>R RStudio command</th>
<th>Local Command LINE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>How many processes are running inside the Docker container?</td>
<td>docker exec -i sql-pet ps -eF</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>1a</td>
<td>How many process are running on your local machine?</td>
<td></td>
<td></td>
<td>widows: tasklist<b>Mac/Linux: ps -ef</td>
</tr>
<tr class="odd">
<td>2</td>
<td>What is the total number of files and directories in Docker?</td>
<td>docker exec -i sql-pet ls -al</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>2a</td>
<td>What is the total number of files and directories on your local machine?</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>3</td>
<td>Is Docker Running?</td>
<td>docker version</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>3a</td>
<td>What are your Client and Server Versions?</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>4</td>
<td>Does PostgreSQL exist in the container?</td>
<td>docker ps -a</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>4a</td>
<td>What is the status of PostgreSQL?</td>
<td>docker ps -a</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>4b</td>
<td>What is the size of PostgreSQL?</td>
<td>docker images</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>4c</td>
<td>What is the size of your laptop OS</td>
<td></td>
<td></td>
<td><a href="https://www.quora.com/What-is-the-actual-size-of-Windows-10-ISO-file" class="uri">https://www.quora.com/What-is-the-actual-size-of-Windows-10-ISO-file</a></td>
</tr>
<tr class="odd">
<td>5</td>
<td>If sql-pet status is Up, How do I stop it?</td>
<td>docker stop sql-pet</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>5a</td>
<td>If sql-pet status is Exited, How do I start it?</td>
<td>docker start sql-pet</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<!--chapter:end:070-environment-diagram.Rmd-->
</div>
</div>
<div id="chapter_dbms-queries-intro" class="section level1">
<h1><span class="header-section-number">9</span> Introduction to DBMS queries</h1>
<blockquote>
<p>This chapter demonstrates how to:</p>
<ul>
<li>Get a glimpse of what tables are in the database and what fields a table contains</li>
<li>Download all or part of a table from the dbms</li>
<li>See how <code>dplyr</code> code is translated into <code>SQL</code> commands</li>
<li>Get acquainted with some useful tools for investigating a single table</li>
<li>Begin thinking about how to divide the work between your local R session and the dbms</li>
</ul>
</blockquote>
<div id="setup" class="section level2">
<h2><span class="header-section-number">9.1</span> Setup</h2>
<p>The following packages are used in this chapter:</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb102-1" data-line-number="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb102-2" data-line-number="2"><span class="kw">library</span>(DBI)</a>
<a class="sourceLine" id="cb102-3" data-line-number="3"><span class="kw">library</span>(RPostgres)</a>
<a class="sourceLine" id="cb102-4" data-line-number="4"><span class="kw">library</span>(dbplyr)</a>
<a class="sourceLine" id="cb102-5" data-line-number="5"><span class="kw">require</span>(knitr)</a>
<a class="sourceLine" id="cb102-6" data-line-number="6"><span class="kw">library</span>(bookdown)</a>
<a class="sourceLine" id="cb102-7" data-line-number="7"><span class="kw">library</span>(sqlpetr)</a></code></pre></div>
<p>Assume that the Docker container with PostgreSQL and the dvdrental database are ready to go. If not go back to <a href="#build-the-pet-sql-docker-image">Chapter 7</a></p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb103-1" data-line-number="1">sqlpetr<span class="op">::</span><span class="kw">sp_docker_start</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<p>Connect to the database:</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb104-1" data-line-number="1">con &lt;-<span class="st"> </span>sqlpetr<span class="op">::</span><span class="kw">sp_get_postgres_connection</span>(</a>
<a class="sourceLine" id="cb104-2" data-line-number="2">  <span class="dt">user =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_USER_NAME&quot;</span>),</a>
<a class="sourceLine" id="cb104-3" data-line-number="3">  <span class="dt">password =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_PASSWORD&quot;</span>),</a>
<a class="sourceLine" id="cb104-4" data-line-number="4">  <span class="dt">dbname =</span> <span class="st">&quot;dvdrental&quot;</span>,</a>
<a class="sourceLine" id="cb104-5" data-line-number="5">  <span class="dt">seconds_to_test =</span> <span class="dv">30</span></a>
<a class="sourceLine" id="cb104-6" data-line-number="6">)</a></code></pre></div>
</div>
<div id="getting-data-from-the-database" class="section level2">
<h2><span class="header-section-number">9.2</span> Getting data from the database</h2>
<p>As we show later on, the database serves as a store of data and as an engine for sub-setting, joining, and computation on the data. We begin with getting data from the dbms, or “downloading” data.</p>
<div id="finding-out-whats-there" class="section level3">
<h3><span class="header-section-number">9.2.1</span> Finding out what’s there</h3>
<p>We’ve already seen the simplest way of getting a list of tables in a database with <code>DBI</code> functions that list tables and fields. Generate a vector listing the (public) tables in the database:</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb105-1" data-line-number="1">tables &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbListTables</span>(con)</a>
<a class="sourceLine" id="cb105-2" data-line-number="2">tables</a></code></pre></div>
<pre><code>##  [1] &quot;actor_info&quot;                 &quot;customer_list&quot;             
##  [3] &quot;film_list&quot;                  &quot;nicer_but_slower_film_list&quot;
##  [5] &quot;sales_by_film_category&quot;     &quot;staff&quot;                     
##  [7] &quot;sales_by_store&quot;             &quot;staff_list&quot;                
##  [9] &quot;category&quot;                   &quot;film_category&quot;             
## [11] &quot;country&quot;                    &quot;actor&quot;                     
## [13] &quot;language&quot;                   &quot;inventory&quot;                 
## [15] &quot;payment&quot;                    &quot;rental&quot;                    
## [17] &quot;city&quot;                       &quot;store&quot;                     
## [19] &quot;film&quot;                       &quot;address&quot;                   
## [21] &quot;film_actor&quot;                 &quot;customer&quot;</code></pre>
<p>Print a vector with all the fields (or columns or variables) in one specific table:</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb107-1" data-line-number="1">DBI<span class="op">::</span><span class="kw">dbListFields</span>(con, <span class="st">&quot;rental&quot;</span>)</a></code></pre></div>
<pre><code>## [1] &quot;rental_id&quot;    &quot;rental_date&quot;  &quot;inventory_id&quot; &quot;customer_id&quot; 
## [5] &quot;return_date&quot;  &quot;staff_id&quot;     &quot;last_update&quot;</code></pre>
</div>
<div id="listing-all-the-fields-for-all-the-tables" class="section level3">
<h3><span class="header-section-number">9.2.2</span> Listing all the fields for all the tables</h3>
<p>The first example, <code>DBI::dbListTables(con)</code> returned 22 tables and the second example, <code>DBI::dbListFields(con, &quot;rental&quot;)</code> returns 7 fields. Here we combine the two calls to return a list of tables which has a list of all the fields in the table. The code block just shows the first two tables.</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb109-1" data-line-number="1">table_columns &lt;-<span class="st"> </span><span class="kw">lapply</span>(tables, dbListFields, <span class="dt">conn =</span> con)</a></code></pre></div>
<p>Or, using purr:</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb110-1" data-line-number="1">table_columns &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw">map</span>(tables, <span class="op">~</span><span class="st"> </span><span class="kw">dbListFields</span>(.,<span class="dt">conn =</span> con) )</a></code></pre></div>
<p>Rename each list [[1]] … [[22]] to meaningful table name</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb111-1" data-line-number="1"><span class="kw">names</span>(table_columns) &lt;-<span class="st"> </span>tables</a>
<a class="sourceLine" id="cb111-2" data-line-number="2"></a>
<a class="sourceLine" id="cb111-3" data-line-number="3"><span class="kw">head</span>(table_columns)</a></code></pre></div>
<pre><code>## $actor_info
## [1] &quot;actor_id&quot;   &quot;first_name&quot; &quot;last_name&quot;  &quot;film_info&quot; 
## 
## $customer_list
## [1] &quot;id&quot;       &quot;name&quot;     &quot;address&quot;  &quot;zip code&quot; &quot;phone&quot;    &quot;city&quot;    
## [7] &quot;country&quot;  &quot;notes&quot;    &quot;sid&quot;     
## 
## $film_list
## [1] &quot;fid&quot;         &quot;title&quot;       &quot;description&quot; &quot;category&quot;    &quot;price&quot;      
## [6] &quot;length&quot;      &quot;rating&quot;      &quot;actors&quot;     
## 
## $nicer_but_slower_film_list
## [1] &quot;fid&quot;         &quot;title&quot;       &quot;description&quot; &quot;category&quot;    &quot;price&quot;      
## [6] &quot;length&quot;      &quot;rating&quot;      &quot;actors&quot;     
## 
## $sales_by_film_category
## [1] &quot;category&quot;    &quot;total_sales&quot;
## 
## $staff
##  [1] &quot;staff_id&quot;    &quot;first_name&quot;  &quot;last_name&quot;   &quot;address_id&quot;  &quot;email&quot;      
##  [6] &quot;store_id&quot;    &quot;active&quot;      &quot;username&quot;    &quot;password&quot;    &quot;last_update&quot;
## [11] &quot;picture&quot;</code></pre>
<p>Later on we’ll discuss how to get more extensive data about each table and column from the database’s own store of metadata using a similar technique. As we go further the issue of scale will come up again and again: you need to be careful about how much data a call to the dbms will return, whether it’s a list of tables or a table that could have millions of rows.</p>
<p>It’s important to connect with people who own, generate, or are the subjects of the data. A good chat with people who own the data, generate it, or are the subjects can generate insights and set the context for your investigation of the database. The purpose for collecting the data or circumstances where it was collected may be buried far afield in an organization, but <em>usually someone knows</em>. The metadata discussed in a later chapter is essential but will only take you so far.</p>
<p>There are different ways of just <strong>looking at the data</strong>, which we explore below.</p>
</div>
<div id="downloading-an-entire-table" class="section level3">
<h3><span class="header-section-number">9.2.3</span> Downloading an entire table</h3>
<p>There are many different methods of getting data from a DBMS, and we’ll explore the different ways of controlling each one of them.</p>
<p><code>DBI::dbReadTable</code> will download an entire table into an R <a href="https://tibble.tidyverse.org/">tibble</a>.</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb113-1" data-line-number="1">rental_tibble &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbReadTable</span>(con, <span class="st">&quot;rental&quot;</span>)</a>
<a class="sourceLine" id="cb113-2" data-line-number="2"><span class="kw">str</span>(rental_tibble)</a></code></pre></div>
<pre><code>## &#39;data.frame&#39;:    16044 obs. of  7 variables:
##  $ rental_id   : int  2 3 4 5 6 7 8 9 10 11 ...
##  $ rental_date : POSIXct, format: &quot;2005-05-24 22:54:33&quot; &quot;2005-05-24 23:03:39&quot; ...
##  $ inventory_id: int  1525 1711 2452 2079 2792 3995 2346 2580 1824 4443 ...
##  $ customer_id : int  459 408 333 222 549 269 239 126 399 142 ...
##  $ return_date : POSIXct, format: &quot;2005-05-28 19:40:33&quot; &quot;2005-06-01 22:12:39&quot; ...
##  $ staff_id    : int  1 1 2 1 1 2 2 1 2 2 ...
##  $ last_update : POSIXct, format: &quot;2006-02-16 02:30:53&quot; &quot;2006-02-16 02:30:53&quot; ...</code></pre>
<p>That’s very simple, but if the table is large it may not be a good idea, since R is designed to keep the entire table in memory. Note that the first line of the str() output reports the total number of observations.</p>
</div>
<div id="a-table-object-that-can-be-reused" class="section level3">
<h3><span class="header-section-number">9.2.4</span> A table object that can be reused</h3>
<p>The <code>dplyr::tbl</code> function gives us more control over access to a table by enabling control over which columns and rows to download. It creates an object that might <strong>look</strong> like a data frame, but it’s actually a list object that <code>dplyr</code> uses for constructing queries and retrieving data from the DBMS.</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb115-1" data-line-number="1">rental_table &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">tbl</span>(con, <span class="st">&quot;rental&quot;</span>)</a>
<a class="sourceLine" id="cb115-2" data-line-number="2"><span class="kw">class</span>(rental_table)</a></code></pre></div>
<pre><code>## [1] &quot;tbl_PqConnection&quot; &quot;tbl_dbi&quot;          &quot;tbl_sql&quot;         
## [4] &quot;tbl_lazy&quot;         &quot;tbl&quot;</code></pre>
</div>
<div id="controlling-the-number-of-rows-returned" class="section level3">
<h3><span class="header-section-number">9.2.5</span> Controlling the number of rows returned</h3>
<p>The <code>collect</code> function triggers the creation of a tibble and controls the number of rows that the DBMS sends to R.</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb117-1" data-line-number="1">rental_table <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">collect</span>(<span class="dt">n =</span> <span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span>dim</a></code></pre></div>
<pre><code>## [1] 3 7</code></pre>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb119-1" data-line-number="1">rental_table <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">collect</span>(<span class="dt">n =</span> <span class="dv">500</span>) <span class="op">%&gt;%</span><span class="st"> </span>dim</a></code></pre></div>
<pre><code>## [1] 500   7</code></pre>
</div>
<div id="random-rows-from-the-dbms" class="section level3">
<h3><span class="header-section-number">9.2.6</span> Random rows from the dbms</h3>
<p>When the dbms contains many rows, a sample of the data may be plenty for your purposes. Although <code>dplyr</code> has nice functions to sample a data frame that’s already in R (e.g., the <code>sample_n</code> and <code>sample_frac</code> functions), to get a sample from the dbms we have to use <code>dbGetQuery</code> to send native SQL to the database. To peek ahead, here is one example of a query that retrieves 20 rows from a 1% sample:</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb121-1" data-line-number="1">one_percent_sample &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb121-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb121-3" data-line-number="3">  <span class="st">&quot;SELECT rental_id, rental_date, inventory_id, customer_id FROM rental TABLESAMPLE BERNOULLI(1) LIMIT 20;</span></a>
<a class="sourceLine" id="cb121-4" data-line-number="4"><span class="st">  &quot;</span></a>
<a class="sourceLine" id="cb121-5" data-line-number="5">)</a>
<a class="sourceLine" id="cb121-6" data-line-number="6"></a>
<a class="sourceLine" id="cb121-7" data-line-number="7">one_percent_sample</a></code></pre></div>
<pre><code>##    rental_id         rental_date inventory_id customer_id
## 1         22 2005-05-25 02:19:23          727         509
## 2        168 2005-05-26 03:07:43         2714         469
## 3        253 2005-05-26 14:43:14         2969         416
## 4        395 2005-05-27 11:45:49          752         575
## 5        576 2005-05-28 10:56:10         1866         588
## 6        643 2005-05-28 18:52:11         3105         240
## 7        653 2005-05-28 20:12:20          126         327
## 8        676 2005-05-28 22:27:51         2329         490
## 9        916 2005-05-30 11:25:01         1290           6
## 10      1001 2005-05-31 00:46:31         1498          64
## 11      1044 2005-05-31 06:24:44         2574          70
## 12      1114 2005-05-31 16:00:33         2287         117
## 13      1171 2005-06-14 23:50:11         4082         284
## 14      1277 2005-06-15 08:01:29           76         464
## 15      1366 2005-06-15 14:21:00         4238         576
## 16      1375 2005-06-15 14:54:56         3555         500
## 17      1683 2005-06-16 11:54:55         2361         494
## 18      1758 2005-06-16 17:39:39         2654         474
## 19      1797 2005-06-16 20:13:03         3435         275
## 20      1848 2005-06-17 00:07:07         3797         526</code></pre>
<p><strong>Exact sample of 100 records</strong></p>
<p>This technique depends on knowing the range of a record index, such as the <code>rental_id</code> in the <code>rental</code> table of our <code>dvdrental</code> database.</p>
<p>Start by finding the min and max values.</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb123-1" data-line-number="1">DBI<span class="op">::</span><span class="kw">dbListFields</span>(con, <span class="st">&quot;rental&quot;</span>)</a></code></pre></div>
<pre><code>## [1] &quot;rental_id&quot;    &quot;rental_date&quot;  &quot;inventory_id&quot; &quot;customer_id&quot; 
## [5] &quot;return_date&quot;  &quot;staff_id&quot;     &quot;last_update&quot;</code></pre>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb125-1" data-line-number="1">rental_df &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbReadTable</span>(con, <span class="st">&quot;rental&quot;</span>)</a>
<a class="sourceLine" id="cb125-2" data-line-number="2"></a>
<a class="sourceLine" id="cb125-3" data-line-number="3"><span class="kw">max</span>(rental_df<span class="op">$</span>rental_id)</a></code></pre></div>
<pre><code>## [1] 16049</code></pre>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb127-1" data-line-number="1"><span class="kw">min</span>(rental_df<span class="op">$</span>rental_id)</a></code></pre></div>
<pre><code>## [1] 1</code></pre>
<p>Set the random number seed and draw the sample.</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb129-1" data-line-number="1"><span class="kw">set.seed</span>(<span class="dv">123</span>)</a>
<a class="sourceLine" id="cb129-2" data-line-number="2">sample_rows &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">16049</span>, <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb129-3" data-line-number="3">rental_table &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">tbl</span>(con, <span class="st">&quot;rental&quot;</span>)</a></code></pre></div>
<p>Run query with the filter verb listing the randomly sampled rows to be retrieved:</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb130-1" data-line-number="1">rental_sample &lt;-<span class="st"> </span>rental_table <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb130-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(rental_id <span class="op">%in%</span><span class="st"> </span>sample_rows) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb130-3" data-line-number="3"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb130-4" data-line-number="4"></a>
<a class="sourceLine" id="cb130-5" data-line-number="5"><span class="kw">str</span>(rental_sample)</a></code></pre></div>
<pre><code>## Classes &#39;tbl_df&#39;, &#39;tbl&#39; and &#39;data.frame&#39;:    100 obs. of  7 variables:
##  $ rental_id   : int  10 395 675 731 734 1494 1517 1643 1651 1775 ...
##  $ rental_date : POSIXct, format: &quot;2005-05-25 00:02:21&quot; &quot;2005-05-27 11:45:49&quot; ...
##  $ inventory_id: int  1824 752 1273 4124 3084 244 3728 1352 4444 1922 ...
##  $ customer_id : int  399 575 338 5 538 575 148 484 524 123 ...
##  $ return_date : POSIXct, format: &quot;2005-05-31 22:44:21&quot; &quot;2005-05-31 13:42:49&quot; ...
##  $ staff_id    : int  2 1 2 1 2 1 1 2 2 2 ...
##  $ last_update : POSIXct, format: &quot;2006-02-16 02:30:53&quot; &quot;2006-02-16 02:30:53&quot; ...</code></pre>
</div>
<div id="sub-setting-variables" class="section level3">
<h3><span class="header-section-number">9.2.7</span> Sub-setting variables</h3>
<p>A table in the dbms may not only have many more rows than you want, but also many more columns. The <code>select</code> command controls which columns are retrieved.</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb132-1" data-line-number="1">rental_table <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">select</span>(rental_date, return_date) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 2]
## # Database: postgres [postgres@localhost:5432/dvdrental]
##   rental_date         return_date        
##   &lt;dttm&gt;              &lt;dttm&gt;             
## 1 2005-05-24 22:54:33 2005-05-28 19:40:33
## 2 2005-05-24 23:03:39 2005-06-01 22:12:39
## 3 2005-05-24 23:04:41 2005-06-03 01:43:41
## 4 2005-05-24 23:05:21 2005-06-02 04:33:21
## 5 2005-05-24 23:08:07 2005-05-27 01:32:07
## 6 2005-05-24 23:11:53 2005-05-29 20:34:53</code></pre>
<p>That’s exactly equivalent to submitting the following SQL commands dirctly:</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb134-1" data-line-number="1">DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb134-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb134-3" data-line-number="3">  <span class="st">&#39;SELECT &quot;rental_date&quot;, &quot;return_date&quot;</span></a>
<a class="sourceLine" id="cb134-4" data-line-number="4"><span class="st">FROM &quot;rental&quot;</span></a>
<a class="sourceLine" id="cb134-5" data-line-number="5"><span class="st">LIMIT 6&#39;</span>) </a></code></pre></div>
<pre><code>##           rental_date         return_date
## 1 2005-05-24 22:54:33 2005-05-28 19:40:33
## 2 2005-05-24 23:03:39 2005-06-01 22:12:39
## 3 2005-05-24 23:04:41 2005-06-03 01:43:41
## 4 2005-05-24 23:05:21 2005-06-02 04:33:21
## 5 2005-05-24 23:08:07 2005-05-27 01:32:07
## 6 2005-05-24 23:11:53 2005-05-29 20:34:53</code></pre>
<p>We won’t discuss <code>dplyr</code> methods for sub-setting variables, deriving new ones, or sub-setting rows based on the values found in the table, because they are covered well in other places, including:</p>
<ul>
<li>Comprehensive reference: <a href="https://dplyr.tidyverse.org/">https://dplyr.tidyverse.org/</a></li>
<li>Good tutorial: <a href="https://suzan.rbind.io/tags/dplyr/">https://suzan.rbind.io/tags/dplyr/</a></li>
</ul>
<p>In practice we find that, <strong>renaming variables</strong> is often quite important because the names in an SQL database might not meet your needs as an analyst. In “the wild”, you will find names that are ambiguous or overly specified, with spaces in them, and other problems that will make them difficult to use in R. It is good practice to do whatever renaming you are going to do in a predictable place like at the top of your code. The names in the <code>dvdrental</code> database are simple and clear, but if they were not, you might rename them for subsequent use in this way:</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb136-1" data-line-number="1"><span class="kw">tbl</span>(con, <span class="st">&quot;rental&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb136-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">rename</span>(<span class="dt">rental_id_number =</span> rental_id, <span class="dt">inventory_id_number =</span> inventory_id) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb136-3" data-line-number="3"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(rental_id_number, rental_date, inventory_id_number) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb136-4" data-line-number="4"><span class="st">  </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 3]
## # Database: postgres [postgres@localhost:5432/dvdrental]
##   rental_id_number rental_date         inventory_id_number
##              &lt;int&gt; &lt;dttm&gt;                            &lt;int&gt;
## 1                2 2005-05-24 22:54:33                1525
## 2                3 2005-05-24 23:03:39                1711
## 3                4 2005-05-24 23:04:41                2452
## 4                5 2005-05-24 23:05:21                2079
## 5                6 2005-05-24 23:08:07                2792
## 6                7 2005-05-24 23:11:53                3995</code></pre>
<p>That’s equivalent to the following SQL code:</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb138-1" data-line-number="1">DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb138-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb138-3" data-line-number="3">  <span class="st">&#39;SELECT &quot;rental_id_number&quot;, &quot;rental_date&quot;, &quot;inventory_id_number&quot;</span></a>
<a class="sourceLine" id="cb138-4" data-line-number="4"><span class="st">FROM (SELECT &quot;rental_id&quot; AS &quot;rental_id_number&quot;, &quot;rental_date&quot;, &quot;inventory_id&quot; AS &quot;inventory_id_number&quot;, &quot;customer_id&quot;, &quot;return_date&quot;, &quot;staff_id&quot;, &quot;last_update&quot;</span></a>
<a class="sourceLine" id="cb138-5" data-line-number="5"><span class="st">FROM &quot;rental&quot;) &quot;ihebfvnxvb&quot;</span></a>
<a class="sourceLine" id="cb138-6" data-line-number="6"><span class="st">LIMIT 6&#39;</span> )</a></code></pre></div>
<pre><code>##   rental_id_number         rental_date inventory_id_number
## 1                2 2005-05-24 22:54:33                1525
## 2                3 2005-05-24 23:03:39                1711
## 3                4 2005-05-24 23:04:41                2452
## 4                5 2005-05-24 23:05:21                2079
## 5                6 2005-05-24 23:08:07                2792
## 6                7 2005-05-24 23:11:53                3995</code></pre>
<p>The one difference is that the <code>SQL</code> code returns a regular data frame and the <code>dplyr</code> code returns a <code>tibble</code>. Notice that the seconds are greyed out in the <code>tibble</code> display.</p>
</div>
<div id="translating-dplyr-code-to-sql-queries" class="section level3">
<h3><span class="header-section-number">9.2.8</span> Translating <code>dplyr</code> code to <code>SQL</code> queries</h3>
<p>Where did the translations we’ve shown above come from? The <code>show_query</code> function shows how <code>dplyr</code> is translating your query to the dialect of the target dbms:</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb140-1" data-line-number="1">rental_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb140-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">count</span>(staff_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb140-3" data-line-number="3"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">show_query</span>()</a></code></pre></div>
<pre><code>## &lt;SQL&gt;
## SELECT &quot;staff_id&quot;, COUNT(*) AS &quot;n&quot;
## FROM &quot;rental&quot;
## GROUP BY &quot;staff_id&quot;</code></pre>
<p>Here is an extensive discussion of how <code>dplyr</code> code is translated into SQL:</p>
<ul>
<li><a href="https://dbplyr.tidyverse.org/articles/sql-translation.html">https://dbplyr.tidyverse.org/articles/sql-translation.html</a></li>
</ul>
<p>If you prefer to use SQL directly, rather than <code>dplyr</code>, you can submit SQL code to the DBMS through the <code>DBI::dbGetQuery</code> function:</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb142-1" data-line-number="1">DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb142-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb142-3" data-line-number="3">  <span class="st">&#39;SELECT &quot;staff_id&quot;, COUNT(*) AS &quot;n&quot;</span></a>
<a class="sourceLine" id="cb142-4" data-line-number="4"><span class="st">   FROM &quot;rental&quot;</span></a>
<a class="sourceLine" id="cb142-5" data-line-number="5"><span class="st">   GROUP BY &quot;staff_id&quot;;</span></a>
<a class="sourceLine" id="cb142-6" data-line-number="6"><span class="st">  &#39;</span></a>
<a class="sourceLine" id="cb142-7" data-line-number="7">)</a></code></pre></div>
<pre><code>##   staff_id    n
## 1        2 8004
## 2        1 8040</code></pre>
<p>When you create a report to run repeatedly, you might want to put that query into R markdown. That way you can also execute that SQL code in a chunk with the following header:</p>
<p>{<code>sql, connection=con, output.var = &quot;query_results&quot;</code>}</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb144-1" data-line-number="1"><span class="kw">SELECT</span> <span class="ot">&quot;staff_id&quot;</span>, <span class="fu">COUNT</span>(*) <span class="kw">AS</span> <span class="ot">&quot;n&quot;</span></a>
<a class="sourceLine" id="cb144-2" data-line-number="2"><span class="kw">FROM</span> <span class="ot">&quot;rental&quot;</span></a>
<a class="sourceLine" id="cb144-3" data-line-number="3"><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="ot">&quot;staff_id&quot;</span>;</a></code></pre></div>
<p>Rmarkdown stores that query result in a tibble which can be printed by referring to it:</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb145-1" data-line-number="1">query_results</a></code></pre></div>
<pre><code>##   staff_id    n
## 1        2 8004
## 2        1 8040</code></pre>
</div>
</div>
<div id="mixing-dplyr-and-sql" class="section level2">
<h2><span class="header-section-number">9.3</span> Mixing dplyr and SQL</h2>
<p>When dplyr finds code that it does not know how to translate into SQL, it will simply pass it along to the dbms. Therefore you can interleave native commands that your dbms will understand in the middle of dplyr code. Consider this example that’s derived from <span class="citation">(Ruiz <a href="#ref-Ruiz2019">2019</a>)</span>:</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb147-1" data-line-number="1">rental_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select_at</span>(<span class="kw">vars</span>( <span class="op">-</span><span class="kw">contains</span>(<span class="st">&quot;_id&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb147-3" data-line-number="3"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">today =</span> <span class="kw">now</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-4" data-line-number="4"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">show_query</span>()</a></code></pre></div>
<pre><code>## &lt;SQL&gt;
## SELECT &quot;rental_date&quot;, &quot;return_date&quot;, &quot;last_update&quot;, NOW() AS &quot;today&quot;
## FROM (SELECT &quot;rental_date&quot;, &quot;return_date&quot;, &quot;last_update&quot;
## FROM &quot;rental&quot;) &quot;yhbysdoypk&quot;</code></pre>
<p>That is native to PostgreSQL, not <a href="https://en.wikipedia.org/wiki/SQL#Interoperability_and_standardization">ANSI standard</a> SQL.</p>
<p>Verify that it works:</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb149-1" data-line-number="1">rental_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb149-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select_at</span>(<span class="kw">vars</span>( <span class="op">-</span><span class="kw">contains</span>(<span class="st">&quot;_id&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb149-3" data-line-number="3"><span class="st">  </span><span class="kw">head</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb149-4" data-line-number="4"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">today =</span> <span class="kw">now</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb149-5" data-line-number="5"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">collect</span>()</a></code></pre></div>
<pre><code>## # A tibble: 6 x 4
##   rental_date         return_date         last_update        
##   &lt;dttm&gt;              &lt;dttm&gt;              &lt;dttm&gt;             
## 1 2005-05-24 22:54:33 2005-05-28 19:40:33 2006-02-16 02:30:53
## 2 2005-05-24 23:03:39 2005-06-01 22:12:39 2006-02-16 02:30:53
## 3 2005-05-24 23:04:41 2005-06-03 01:43:41 2006-02-16 02:30:53
## 4 2005-05-24 23:05:21 2005-06-02 04:33:21 2006-02-16 02:30:53
## 5 2005-05-24 23:08:07 2005-05-27 01:32:07 2006-02-16 02:30:53
## 6 2005-05-24 23:11:53 2005-05-29 20:34:53 2006-02-16 02:30:53
## # … with 1 more variable: today &lt;dttm&gt;</code></pre>
</div>
<div id="examining-a-single-table-with-r" class="section level2">
<h2><span class="header-section-number">9.4</span> Examining a single table with R</h2>
<p>Dealing with a large, complex database highlights the utility of specific tools in R. We include brief examples that we find to be handy:</p>
<ul>
<li>Base R structure: <code>str</code></li>
<li>Printing out some of the data: <code>datatable</code>, <code>kable</code>, and <code>View</code></li>
<li>Summary statistics: <code>summary</code></li>
<li><code>glimpse</code> in the <code>tibble</code> package, which is included in the <code>tidyverse</code></li>
<li><code>skim</code> in the <code>skimr</code> package</li>
</ul>
<div id="str---a-base-package-workhorse" class="section level3">
<h3><span class="header-section-number">9.4.1</span> <code>str</code> - a base package workhorse</h3>
<p><code>str</code> is a workhorse function that lists variables, their type and a sample of the first few variable values.</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb151-1" data-line-number="1"><span class="kw">str</span>(rental_tibble)</a></code></pre></div>
<pre><code>## &#39;data.frame&#39;:    16044 obs. of  7 variables:
##  $ rental_id   : int  2 3 4 5 6 7 8 9 10 11 ...
##  $ rental_date : POSIXct, format: &quot;2005-05-24 22:54:33&quot; &quot;2005-05-24 23:03:39&quot; ...
##  $ inventory_id: int  1525 1711 2452 2079 2792 3995 2346 2580 1824 4443 ...
##  $ customer_id : int  459 408 333 222 549 269 239 126 399 142 ...
##  $ return_date : POSIXct, format: &quot;2005-05-28 19:40:33&quot; &quot;2005-06-01 22:12:39&quot; ...
##  $ staff_id    : int  1 1 2 1 1 2 2 1 2 2 ...
##  $ last_update : POSIXct, format: &quot;2006-02-16 02:30:53&quot; &quot;2006-02-16 02:30:53&quot; ...</code></pre>
</div>
<div id="always-look-at-your-data-with-head-view-or-kable" class="section level3">
<h3><span class="header-section-number">9.4.2</span> Always <strong>look</strong> at your data with <code>head</code>, <code>View</code>, or <code>kable</code></h3>
<p>There is no substitute for looking at your data and R provides several ways to just browse it. The <code>head</code> function controls the number of rows that are displayed. Note that tail does not work against a database object. In every-day practice you would look at more than the default 6 rows, but here we wrap <code>head</code> around the data frame:</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb153-1" data-line-number="1">sqlpetr<span class="op">::</span><span class="kw">sp_print_df</span>(<span class="kw">head</span>(rental_tibble))</a></code></pre></div>
<div id="htmlwidget-4f68022fd73b3d133ebb" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-4f68022fd73b3d133ebb">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],[2,3,4,5,6,7],["2005-05-25T05:54:33Z","2005-05-25T06:03:39Z","2005-05-25T06:04:41Z","2005-05-25T06:05:21Z","2005-05-25T06:08:07Z","2005-05-25T06:11:53Z"],[1525,1711,2452,2079,2792,3995],[459,408,333,222,549,269],["2005-05-29T02:40:33Z","2005-06-02T05:12:39Z","2005-06-03T08:43:41Z","2005-06-02T11:33:21Z","2005-05-27T08:32:07Z","2005-05-30T03:34:53Z"],[1,1,2,1,1,2],["2006-02-16T10:30:53Z","2006-02-16T10:30:53Z","2006-02-16T10:30:53Z","2006-02-16T10:30:53Z","2006-02-16T10:30:53Z","2006-02-16T10:30:53Z"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>rental_id<\/th>\n      <th>rental_date<\/th>\n      <th>inventory_id<\/th>\n      <th>customer_id<\/th>\n      <th>return_date<\/th>\n      <th>staff_id<\/th>\n      <th>last_update<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3,4,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="the-summary-function-in-base" class="section level3">
<h3><span class="header-section-number">9.4.3</span> The <code>summary</code> function in <code>base</code></h3>
<p>The <code>base</code> package’s <code>summary</code> function provides basic statistics that serve a unique diagnostic purpose in this context. For example, the following output shows that:</p>
<pre><code>* `rental_id` is a number from 1 to 16,049. In a previous section, we ran the `str` function and saw that there are 16,044 observations in this table. Therefore, the `rental_id` seems to be sequential from 1:16049, but there are 5 values missing from that sequence. _Exercise for the Reader_: Which 5 values from 1:16049 are missing from `rental_id` values in the `rental` table? (_Hint_: In the chapter on SQL Joins, you will learn the functions needed to answer this question.)
* The number of NA&#39;s in the `return_date` column is a good first guess as to the number of DVDs rented out or lost as of 2005-09-02 02:35:22.</code></pre>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb155-1" data-line-number="1"><span class="kw">summary</span>(rental_tibble)</a></code></pre></div>
<pre><code>##    rental_id      rental_date                   inventory_id 
##  Min.   :    1   Min.   :2005-05-24 22:53:30   Min.   :   1  
##  1st Qu.: 4014   1st Qu.:2005-07-07 00:58:40   1st Qu.:1154  
##  Median : 8026   Median :2005-07-28 16:04:32   Median :2291  
##  Mean   : 8025   Mean   :2005-07-23 08:13:34   Mean   :2292  
##  3rd Qu.:12037   3rd Qu.:2005-08-17 21:16:23   3rd Qu.:3433  
##  Max.   :16049   Max.   :2006-02-14 15:16:03   Max.   :4581  
##                                                              
##   customer_id     return_date                     staff_id    
##  Min.   :  1.0   Min.   :2005-05-25 23:55:21   Min.   :1.000  
##  1st Qu.:148.0   1st Qu.:2005-07-10 15:49:36   1st Qu.:1.000  
##  Median :296.0   Median :2005-08-01 19:45:29   Median :1.000  
##  Mean   :297.1   Mean   :2005-07-25 23:58:03   Mean   :1.499  
##  3rd Qu.:446.0   3rd Qu.:2005-08-20 23:35:55   3rd Qu.:2.000  
##  Max.   :599.0   Max.   :2005-09-02 02:35:22   Max.   :2.000  
##                  NA&#39;s   :183                                  
##   last_update                 
##  Min.   :2006-02-15 21:30:53  
##  1st Qu.:2006-02-16 02:30:53  
##  Median :2006-02-16 02:30:53  
##  Mean   :2006-02-16 02:31:31  
##  3rd Qu.:2006-02-16 02:30:53  
##  Max.   :2006-02-23 09:12:08  
## </code></pre>
<p>So the <code>summary</code> function is surprisingly useful as we first start to look at the table contents.</p>
</div>
<div id="the-glimpse-function-in-the-tibble-package" class="section level3">
<h3><span class="header-section-number">9.4.4</span> The <code>glimpse</code> function in the <code>tibble</code> package</h3>
<p>The <code>tibble</code> package’s <code>glimpse</code> function is a more compact version of <code>str</code>:</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb157-1" data-line-number="1">tibble<span class="op">::</span><span class="kw">glimpse</span>(rental_tibble)</a></code></pre></div>
<pre><code>## Observations: 16,044
## Variables: 7
## $ rental_id    &lt;int&gt; 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16,…
## $ rental_date  &lt;dttm&gt; 2005-05-24 22:54:33, 2005-05-24 23:03:39, 2005-05-…
## $ inventory_id &lt;int&gt; 1525, 1711, 2452, 2079, 2792, 3995, 2346, 2580, 182…
## $ customer_id  &lt;int&gt; 459, 408, 333, 222, 549, 269, 239, 126, 399, 142, 2…
## $ return_date  &lt;dttm&gt; 2005-05-28 19:40:33, 2005-06-01 22:12:39, 2005-06-…
## $ staff_id     &lt;int&gt; 1, 1, 2, 1, 1, 2, 2, 1, 2, 2, 2, 1, 1, 1, 2, 1, 2, …
## $ last_update  &lt;dttm&gt; 2006-02-16 02:30:53, 2006-02-16 02:30:53, 2006-02-…</code></pre>
</div>
<div id="the-skim-function-in-the-skimr-package" class="section level3">
<h3><span class="header-section-number">9.4.5</span> The <code>skim</code> function in the <code>skimr</code> package</h3>
<p>The <code>skimr</code> package has several functions that make it easy to examine an unknown data frame and assess what it contains. It is also extensible.</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb159-1" data-line-number="1"><span class="kw">library</span>(skimr)</a></code></pre></div>
<pre><code>## 
## Attaching package: &#39;skimr&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:knitr&#39;:
## 
##     kable</code></pre>
<pre><code>## The following object is masked from &#39;package:stats&#39;:
## 
##     filter</code></pre>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb163-1" data-line-number="1">skimr<span class="op">::</span><span class="kw">skim</span>(rental_tibble)</a></code></pre></div>
<pre><code>## Skim summary statistics
##  n obs: 16044 
##  n variables: 7 
## 
## ── Variable type:integer ─────────────────────────────────────────────────────────────────────────────────
##      variable missing complete     n    mean      sd p0     p25    p50
##   customer_id       0    16044 16044  297.14  172.45  1  148     296  
##  inventory_id       0    16044 16044 2291.84 1322.21  1 1154    2291  
##     rental_id       0    16044 16044 8025.37 4632.78  1 4013.75 8025.5
##      staff_id       0    16044 16044    1.5     0.5   1    1       1  
##       p75  p100     hist
##    446      599 ▇▇▇▇▇▇▇▇
##   3433     4581 ▇▇▇▇▇▇▇▇
##  12037.25 16049 ▇▇▇▇▇▇▇▇
##      2        2 ▇▁▁▁▁▁▁▇
## 
## ── Variable type:POSIXct ─────────────────────────────────────────────────────────────────────────────────
##     variable missing complete     n        min        max     median
##  last_update       0    16044 16044 2006-02-15 2006-02-23 2006-02-16
##  rental_date       0    16044 16044 2005-05-24 2006-02-14 2005-07-28
##  return_date     183    15861 16044 2005-05-25 2005-09-02 2005-08-01
##  n_unique
##         3
##     15815
##     15836</code></pre>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb165-1" data-line-number="1">wide_rental_skim &lt;-<span class="st"> </span>skimr<span class="op">::</span><span class="kw">skim_to_wide</span>(rental_tibble)</a></code></pre></div>
</div>
<div id="close-the-connection-and-shut-down-sql-pet" class="section level3">
<h3><span class="header-section-number">9.4.6</span> Close the connection and shut down sql-pet</h3>
<p>Where you place the <code>collect</code> function matters.</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb166-1" data-line-number="1">DBI<span class="op">::</span><span class="kw">dbDisconnect</span>(con)</a>
<a class="sourceLine" id="cb166-2" data-line-number="2">sqlpetr<span class="op">::</span><span class="kw">sp_docker_stop</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
</div>
</div>
<div id="additional-reading" class="section level2">
<h2><span class="header-section-number">9.5</span> Additional reading</h2>
<ul>
<li><span class="citation">(Wickham <a href="#ref-Wickham2018">2018</a>)</span></li>
<li><span class="citation">(Baumer <a href="#ref-Baumer2018">2018</a>)</span></li>
</ul>
<!--chapter:end:080-elementary-queries.Rmd-->
</div>
</div>
<div id="chapter_lazy-evaluation-queries" class="section level1">
<h1><span class="header-section-number">10</span> Lazy Evaluation and Lazy Queries</h1>
<blockquote>
<p>This chapter:</p>
<ul>
<li>Reviews lazy evaluation and discusses its interaction with remote query execution on a dbms</li>
<li>Demonstrates how <code>dplyr</code> queries behave in connection with several different functions</li>
<li>Offers some further resources on lazy loading, evaluation, execution, etc.</li>
</ul>
</blockquote>
<div id="setup-1" class="section level2">
<h2><span class="header-section-number">10.1</span> Setup</h2>
<p>The following packages are used in this chapter:</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb167-1" data-line-number="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb167-2" data-line-number="2"><span class="kw">library</span>(DBI)</a>
<a class="sourceLine" id="cb167-3" data-line-number="3"><span class="kw">library</span>(RPostgres)</a>
<a class="sourceLine" id="cb167-4" data-line-number="4"><span class="kw">library</span>(dbplyr)</a>
<a class="sourceLine" id="cb167-5" data-line-number="5"><span class="kw">require</span>(knitr)</a>
<a class="sourceLine" id="cb167-6" data-line-number="6"><span class="kw">library</span>(bookdown)</a>
<a class="sourceLine" id="cb167-7" data-line-number="7"><span class="kw">library</span>(sqlpetr)</a></code></pre></div>
<p>If you have not yet set up the Docker container with PostgreSQL and the dvdrental database, go back to <a href="#build-the-pet-sql-docker-image">those instructions</a> to configure your environment. Otherwise, start your <code>sql-pet</code> container:</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb168-1" data-line-number="1">sqlpetr<span class="op">::</span><span class="kw">sp_docker_start</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<p>Connect to the database:</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb169-1" data-line-number="1">con &lt;-<span class="st"> </span>sqlpetr<span class="op">::</span><span class="kw">sp_get_postgres_connection</span>(</a>
<a class="sourceLine" id="cb169-2" data-line-number="2">  <span class="dt">user =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_USER_NAME&quot;</span>),</a>
<a class="sourceLine" id="cb169-3" data-line-number="3">  <span class="dt">password =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_PASSWORD&quot;</span>),</a>
<a class="sourceLine" id="cb169-4" data-line-number="4">  <span class="dt">dbname =</span> <span class="st">&quot;dvdrental&quot;</span>,</a>
<a class="sourceLine" id="cb169-5" data-line-number="5">  <span class="dt">seconds_to_test =</span> <span class="dv">30</span></a>
<a class="sourceLine" id="cb169-6" data-line-number="6">)</a></code></pre></div>
</div>
<div id="r-is-lazy-and-comes-with-guardrails" class="section level2">
<h2><span class="header-section-number">10.2</span> R is lazy and comes with guardrails</h2>
<p>By design, R is both a language and an interactive development environment (IDE). As a language, R tries to be as efficient as possible. As an IDE, R creates some guardrails to make it easy and safe to work with your data. For example <code>getOption(&quot;max.print&quot;)</code> prevents R from printing more rows of data than you want to handle in an interactive session, with a default of 99999 lines, which may or may not suit you.</p>
<p>On the other hand SQL is a <em>“Structured Query Language (SQL): a standard computer language for relational database management and data manipulation.”</em>.<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> SQL has various database-specific Interactive Development Environments (IDEs), such as <a href="https://www.pgadmin.org/">pgAdmin</a> for PostgreSQL. Roger Peng explains in <a href="https://bookdown.org/rdpeng/rprogdatascience/history-and-overview-of-r.html#basic-features-of-r">R Programming for Data Science</a> that:</p>
<blockquote>
<p>R has maintained the original S philosophy, which is that it provides a language that is both useful for interactive work, but contains a powerful programming language for developing new tools.</p>
</blockquote>
<p>This is complicated when R interacts with SQL. In a <a href="https://cran.r-project.org/web/packages/dbplyr/vignettes/dbplyr.html">vignette for dbplyr</a> Hadley Wickham explains:</p>
<blockquote>
<p>The most important difference between ordinary data frames and remote database queries is that your R code is translated into SQL and executed in the database on the remote server, not in R on your local machine. When working with databases, dplyr tries to be as lazy as possible:</p>
<ul>
<li><p>It never pulls data into R unless you explicitly ask for it.</p></li>
<li><p>It delays doing any work until the last possible moment: it collects together everything you want to do and then sends it to the database in one step.</p></li>
</ul>
</blockquote>
<p>Exactly when, which, and how much data is returned from the dbms is the topic of this chapter. Exactly how the data is represented in the dbms and then translated to a data frame is discussed in the <a href="https://cran.r-project.org/web/packages/DBI/vignettes/spec.html#_fetch_records_from_a_previously_executed_query_">DBI specification</a>.</p>
<p>Eventually, if you are interacting with a dbms from R you will need to understand the differences between lazy loading, lazy evaluation, and lazy queries.</p>
<div id="lazy-loading" class="section level3">
<h3><span class="header-section-number">10.2.1</span> Lazy loading</h3>
<p>“<em>Lazy loading is always used for code in packages but is optional (selected by the package maintainer) for datasets in packages.</em>”<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a> Lazy loading means that the code for a particular function doesn’t actually get loaded into memory until the last minute – when it’s actually being used.</p>
</div>
<div id="lazy-evaluation" class="section level3">
<h3><span class="header-section-number">10.2.2</span> Lazy evaluation</h3>
<p>Essentially “Lazy evaluation is a programming strategy that allows a symbol to be evaluated only when needed.”<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a> That means that lazy evaluation is about <strong>symbols</strong> such as function arguments<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a> when they are evaluated. Tidy evaluation complicates lazy evaluation.<a href="#fn5" class="footnote-ref" id="fnref5"><sup>5</sup></a></p>
</div>
<div id="lazy-queries" class="section level3">
<h3><span class="header-section-number">10.2.3</span> Lazy Queries</h3>
<p>“<em>When you create a &quot;lazy&quot; query, you’re creating a pointer to a set of conditions on the database, but the query isn’t actually run and the data isn’t actually loaded until you call &quot;next&quot; or some similar method to actually fetch the data and load it into an object.</em>”<a href="#fn6" class="footnote-ref" id="fnref6"><sup>6</sup></a></p>
</div>
</div>
<div id="lazy-evaluation-and-lazy-queries" class="section level2">
<h2><span class="header-section-number">10.3</span> Lazy evaluation and lazy queries</h2>
<div id="dplyr-connection-objects" class="section level3">
<h3><span class="header-section-number">10.3.1</span> <code>dplyr</code> connection objects</h3>
<p>As introduced in the previous chapter, the <code>dplyr::tbl</code> function creates an object that might <strong>look</strong> like a data frame in that when you enter it on the command line, it prints a bunch of rows from the dbms table. But it is actually a <strong>list</strong> object that <code>dplyr</code> uses for constructing queries and retrieving data from the DBMS.</p>
<p>The following code illustrates these issues. The <code>dplyr::tbl</code> function creates the connection object that we store in an object named <code>rental_table</code>:</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb170-1" data-line-number="1">rental_table &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">tbl</span>(con, <span class="st">&quot;rental&quot;</span>)</a></code></pre></div>
<p>At first glance, it <em>acts</em> like a data frame when you print it, although it only prints 10 of the table’s 16,044 rows:</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb171-1" data-line-number="1">rental_table</a></code></pre></div>
<pre><code>## # Source:   table&lt;rental&gt; [?? x 7]
## # Database: postgres [postgres@localhost:5432/dvdrental]
##    rental_id rental_date         inventory_id customer_id
##        &lt;int&gt; &lt;dttm&gt;                     &lt;int&gt;       &lt;int&gt;
##  1         2 2005-05-24 22:54:33         1525         459
##  2         3 2005-05-24 23:03:39         1711         408
##  3         4 2005-05-24 23:04:41         2452         333
##  4         5 2005-05-24 23:05:21         2079         222
##  5         6 2005-05-24 23:08:07         2792         549
##  6         7 2005-05-24 23:11:53         3995         269
##  7         8 2005-05-24 23:31:46         2346         239
##  8         9 2005-05-25 00:00:40         2580         126
##  9        10 2005-05-25 00:02:21         1824         399
## 10        11 2005-05-25 00:09:02         4443         142
## # … with more rows, and 3 more variables: return_date &lt;dttm&gt;,
## #   staff_id &lt;int&gt;, last_update &lt;dttm&gt;</code></pre>
<p>However, notice that the first output line shows <code>??</code>, rather than providing the number of rows in the table. Similarly, the next to last line shows:</p>
<pre><code>    ... with more rows, and 3 more variables</code></pre>
<p>whereas the output for a normal <code>tbl</code> of this rental data would say:</p>
<pre><code>    ... with 16,034 more rows, and 3 more variables</code></pre>
<p>So even though <code>rental_table</code> is a <code>tbl</code>:</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb175-1" data-line-number="1"><span class="kw">class</span>(rental_table)</a></code></pre></div>
<pre><code>## [1] &quot;tbl_PqConnection&quot; &quot;tbl_dbi&quot;          &quot;tbl_sql&quot;         
## [4] &quot;tbl_lazy&quot;         &quot;tbl&quot;</code></pre>
<p>It is not just a normal <code>tbl</code> of data. We can see that from the structure of <code>rental_table</code>:</p>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb177-1" data-line-number="1"><span class="kw">str</span>(rental_table)</a></code></pre></div>
<pre><code>## List of 2
##  $ src:List of 2
##   ..$ con  :Formal class &#39;PqConnection&#39; [package &quot;RPostgres&quot;] with 3 slots
##   .. .. ..@ ptr     :&lt;externalptr&gt; 
##   .. .. ..@ bigint  : chr &quot;integer64&quot;
##   .. .. ..@ typnames:&#39;data.frame&#39;:   437 obs. of  2 variables:
##   .. .. .. ..$ oid    : int [1:437] 16 17 18 19 20 21 22 23 24 25 ...
##   .. .. .. ..$ typname: chr [1:437] &quot;bool&quot; &quot;bytea&quot; &quot;char&quot; &quot;name&quot; ...
##   ..$ disco: NULL
##   ..- attr(*, &quot;class&quot;)= chr [1:4] &quot;src_PqConnection&quot; &quot;src_dbi&quot; &quot;src_sql&quot; &quot;src&quot;
##  $ ops:List of 2
##   ..$ x   : &#39;ident&#39; chr &quot;rental&quot;
##   ..$ vars: chr [1:7] &quot;rental_id&quot; &quot;rental_date&quot; &quot;inventory_id&quot; &quot;customer_id&quot; ...
##   ..- attr(*, &quot;class&quot;)= chr [1:3] &quot;op_base_remote&quot; &quot;op_base&quot; &quot;op&quot;
##  - attr(*, &quot;class&quot;)= chr [1:5] &quot;tbl_PqConnection&quot; &quot;tbl_dbi&quot; &quot;tbl_sql&quot; &quot;tbl_lazy&quot; ...</code></pre>
<p>It has only <em>two</em> rows! The first row contains all the information in the <code>con</code> object, which contains information about all the tables and objects in the database:</p>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb179-1" data-line-number="1">rental_table<span class="op">$</span>src<span class="op">$</span>con<span class="op">@</span>typnames<span class="op">$</span>typname[<span class="dv">380</span><span class="op">:</span><span class="dv">437</span>]</a></code></pre></div>
<pre><code>##  [1] &quot;customer&quot;                    &quot;_customer&quot;                  
##  [3] &quot;actor_actor_id_seq&quot;          &quot;actor&quot;                      
##  [5] &quot;_actor&quot;                      &quot;category_category_id_seq&quot;   
##  [7] &quot;category&quot;                    &quot;_category&quot;                  
##  [9] &quot;film_film_id_seq&quot;            &quot;film&quot;                       
## [11] &quot;_film&quot;                       &quot;pg_toast_16434&quot;             
## [13] &quot;film_actor&quot;                  &quot;_film_actor&quot;                
## [15] &quot;film_category&quot;               &quot;_film_category&quot;             
## [17] &quot;actor_info&quot;                  &quot;_actor_info&quot;                
## [19] &quot;address_address_id_seq&quot;      &quot;address&quot;                    
## [21] &quot;_address&quot;                    &quot;city_city_id_seq&quot;           
## [23] &quot;city&quot;                        &quot;_city&quot;                      
## [25] &quot;country_country_id_seq&quot;      &quot;country&quot;                    
## [27] &quot;_country&quot;                    &quot;customer_list&quot;              
## [29] &quot;_customer_list&quot;              &quot;film_list&quot;                  
## [31] &quot;_film_list&quot;                  &quot;inventory_inventory_id_seq&quot; 
## [33] &quot;inventory&quot;                   &quot;_inventory&quot;                 
## [35] &quot;language_language_id_seq&quot;    &quot;language&quot;                   
## [37] &quot;_language&quot;                   &quot;nicer_but_slower_film_list&quot; 
## [39] &quot;_nicer_but_slower_film_list&quot; &quot;payment_payment_id_seq&quot;     
## [41] &quot;payment&quot;                     &quot;_payment&quot;                   
## [43] &quot;rental_rental_id_seq&quot;        &quot;rental&quot;                     
## [45] &quot;_rental&quot;                     &quot;sales_by_film_category&quot;     
## [47] &quot;_sales_by_film_category&quot;     &quot;staff_staff_id_seq&quot;         
## [49] &quot;staff&quot;                       &quot;_staff&quot;                     
## [51] &quot;pg_toast_16529&quot;              &quot;store_store_id_seq&quot;         
## [53] &quot;store&quot;                       &quot;_store&quot;                     
## [55] &quot;sales_by_store&quot;              &quot;_sales_by_store&quot;            
## [57] &quot;staff_list&quot;                  &quot;_staff_list&quot;</code></pre>
<p>The second row contains a list of the columns in the <code>rental</code> table, among other things:</p>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb181-1" data-line-number="1">rental_table<span class="op">$</span>ops<span class="op">$</span>vars</a></code></pre></div>
<pre><code>## [1] &quot;rental_id&quot;    &quot;rental_date&quot;  &quot;inventory_id&quot; &quot;customer_id&quot; 
## [5] &quot;return_date&quot;  &quot;staff_id&quot;     &quot;last_update&quot;</code></pre>
<p><code>rental_table</code> holds information needed to get the data from the ‘rental’ table, but <code>rental_table</code> does not hold the data itself. In the following sections, we will examine more closely this relationship between the <code>rental_table</code> object and the data in the database’s ‘rental’ table.</p>
</div>
</div>
<div id="when-does-a-lazy-query-trigger-data-retrieval" class="section level2">
<h2><span class="header-section-number">10.4</span> When does a lazy query trigger data retrieval?</h2>
<div id="create-a-black-box-query-for-experimentation" class="section level3">
<h3><span class="header-section-number">10.4.1</span> Create a black box query for experimentation</h3>
<p>To illustrate the different issues involved in data retrieval, we create more connection objects to link to two other tables.</p>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb183-1" data-line-number="1">staff_table &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">tbl</span>(con, <span class="st">&quot;staff&quot;</span>) </a></code></pre></div>
<p>The ‘staff’ table has 2 rows.</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb184-1" data-line-number="1">customer_table &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">tbl</span>(con, <span class="st">&quot;customer&quot;</span>) </a></code></pre></div>
<p>The ‘customer’ table has 599 rows.</p>
<p>Here is a typical string of <code>dplyr</code> verbs strung together with the magrittr <code>%&gt;%</code> pipe command that will be used to tease out the several different behaviors that a lazy query has when passed to different R functions. This query joins three connection objects into a query we’ll call <code>Q</code>:</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb185-1" data-line-number="1">Q &lt;-<span class="st"> </span>rental_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb185-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">left_join</span>(staff_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;staff_id&quot;</span> =<span class="st"> &quot;staff_id&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb185-3" data-line-number="3"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">rename</span>(<span class="dt">staff_email =</span> email) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb185-4" data-line-number="4"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">left_join</span>(customer_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;customer_id&quot;</span> =<span class="st"> &quot;customer_id&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb185-5" data-line-number="5"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">rename</span>(<span class="dt">customer_email =</span> email) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb185-6" data-line-number="6"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(rental_date, staff_email, customer_email)</a></code></pre></div>
</div>
<div id="experiment-overview" class="section level3">
<h3><span class="header-section-number">10.4.2</span> Experiment overview</h3>
<p>Think of <code>Q</code> as a black box for the moment. The following examples will show how <code>Q</code> is interpreted differently by different functions.</p>
<p><strong>Notation</strong></p>
<ul>
<li><img src="screenshots/green-check.png" />: A single green check indicates that some rows are returned.</li>
<li><img src="screenshots/green-check.png" /> <img src="screenshots/green-check.png" />: Two green checks indicate that all the rows are returned.</li>
<li><img src="screenshots/red-x.png" />: The red X indicates that no rows are returned.</li>
</ul>
<blockquote>
<table>
<colgroup>
<col width="33%" />
<col width="66%" />
</colgroup>
<thead>
<tr class="header">
<th>R code</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><a href="#lazy_q_print"><code>Q %&gt;% print()</code></a></td>
<td><img src="screenshots/green-check.png" /> Prints x rows; same as just entering <code>Q</code></td>
</tr>
<tr class="even">
<td><a href="#Q-as-tibble"><code>Q %&gt;% dplyr::as_tibble()</code></a></td>
<td><img src="screenshots/green-check.png" /><img src="screenshots/green-check.png" /> Forces <code>Q</code> to be a tibble</td>
</tr>
<tr class="odd">
<td><a href="#lazy_q_head"><code>Q %&gt;% head()</code></a></td>
<td><img src="screenshots/green-check.png" /> Prints the first 6 rows</td>
</tr>
<tr class="even">
<td><a href="#lazy_q_tail"><code>Q %&gt;% tail()</code></a></td>
<td><img src="screenshots/red-x.png" /> Error: tail() is not supported by sql sources</td>
</tr>
<tr class="odd">
<td><a href="#lazy_q_length"><code>Q %&gt;% length()</code></a></td>
<td><img src="screenshots/red-x.png" /> Counts the rows in <code>Q</code></td>
</tr>
<tr class="even">
<td><a href="#lazy_q_str"><code>Q %&gt;% str()</code></a></td>
<td><img src="screenshots/red-x.png" />Shows the top 3 levels of the <strong>object</strong> <code>Q</code></td>
</tr>
<tr class="odd">
<td><a href="#lazy_q_nrow"><code>Q %&gt;% nrow()</code></a></td>
<td><img src="screenshots/red-x.png" /> <strong>Attempts</strong> to determine the number of rows</td>
</tr>
<tr class="even">
<td><a href="#lazy_q_tally"><code>Q %&gt;% dplyr::tally()</code></a></td>
<td><img src="screenshots/green-check.png" /> <img src="screenshots/green-check.png" /> Counts all the rows – on the dbms side</td>
</tr>
<tr class="odd">
<td><a href="#lazy_q_collect"><code>Q %&gt;% dplyr::collect(n = 20)</code></a></td>
<td><img src="screenshots/green-check.png" /> Prints 20 rows</td>
</tr>
<tr class="even">
<td><a href="#lazy_q_collect"><code>Q %&gt;% dplyr::collect(n = 20) %&gt;% head()</code></a></td>
<td><img src="screenshots/green-check.png" /> Prints 6 rows</td>
</tr>
<tr class="odd">
<td><a href="#lazy-q-show-query"><code>Q %&gt;% dplyr::show_query()</code></a></td>
<td><img src="screenshots/red-x.png" /> <strong>Translates</strong> the lazy query object into SQL</td>
</tr>
<tr class="even">
<td><a href="#lazy_q_build"><code>Qc &lt;- Q %&gt;% dplyr::count(customer_email, sort = TRUE)</code> <br /> <code>Qc</code></a></td>
<td><img src="screenshots/red-x.png" /> <strong>Extends</strong> the lazy query object</td>
</tr>
</tbody>
</table>
</blockquote>
<p>The next chapter will discuss how to build queries and how to explore intermediate steps. But first, the following subsections provide a more detailed discussion of each row in the preceding table.</p>
</div>
<div id="lazy_q_print" class="section level3">
<h3><span class="header-section-number">10.4.3</span> Q %&gt;% print()</h3>
<p>Remember that <code>Q %&gt;% print()</code> is equivalent to <code>print(Q)</code> and the same as just entering <code>Q</code> on the command line. We use the magrittr pipe operator here, because chaining functions highlights how the same object behaves differently in each use.</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb186-1" data-line-number="1">Q <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">print</span>()</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 3]
## # Database: postgres [postgres@localhost:5432/dvdrental]
##    rental_date         staff_email             customer_email              
##    &lt;dttm&gt;              &lt;chr&gt;                   &lt;chr&gt;                       
##  1 2005-05-24 22:54:33 Mike.Hillyer@sakilasta… tommy.collazo@sakilacustome…
##  2 2005-05-24 23:03:39 Mike.Hillyer@sakilasta… manuel.murrell@sakilacustom…
##  3 2005-05-24 23:04:41 Jon.Stephens@sakilasta… andrew.purdy@sakilacustomer…
##  4 2005-05-24 23:05:21 Mike.Hillyer@sakilasta… delores.hansen@sakilacustom…
##  5 2005-05-24 23:08:07 Mike.Hillyer@sakilasta… nelson.christenson@sakilacu…
##  6 2005-05-24 23:11:53 Jon.Stephens@sakilasta… cassandra.walters@sakilacus…
##  7 2005-05-24 23:31:46 Jon.Stephens@sakilasta… minnie.romero@sakilacustome…
##  8 2005-05-25 00:00:40 Mike.Hillyer@sakilasta… ellen.simpson@sakilacustome…
##  9 2005-05-25 00:02:21 Jon.Stephens@sakilasta… danny.isom@sakilacustomer.o…
## 10 2005-05-25 00:09:02 Jon.Stephens@sakilasta… april.burns@sakilacustomer.…
## # … with more rows</code></pre>
<p><img src="screenshots/green-check.png" /> R retrieves 10 observations and 3 columns. In its role as IDE, R has provided nicely formatted output that is similar to what it prints for a tibble, with descriptive information about the dataset and each column:</p>
<blockquote>
<p># Source: lazy query [?? x 3] </br >
# Database: postgres [<a href="mailto:postgres@localhost" class="email">postgres@localhost</a>:5432/dvdrental] </br >
rental_date staff_email customer_email
&lt;dttm&gt; &lt;chr&gt; &lt;chr&gt;</p>
</blockquote>
<p>R has not determined how many rows are left to retrieve as it shows with <code>[?? x 3]</code> and <code>... with more rows</code> in the data summary.</p>
</div>
<div id="lazy_q_as-tibble" class="section level3">
<h3><span class="header-section-number">10.4.4</span> Q %&gt;% dplyr::as_tibble()</h3>
<p><img src="screenshots/green-check.png" /> <img src="screenshots/green-check.png" /> In contrast to <code>print()</code>, the <code>as_tibble()</code> function causes R to download the whole table, using tibble’s default of displaying only the first 10 rows.</p>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb188-1" data-line-number="1">Q <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">as_tibble</span>()</a></code></pre></div>
<pre><code>## # A tibble: 16,044 x 3
##    rental_date         staff_email             customer_email              
##    &lt;dttm&gt;              &lt;chr&gt;                   &lt;chr&gt;                       
##  1 2005-05-24 22:54:33 Mike.Hillyer@sakilasta… tommy.collazo@sakilacustome…
##  2 2005-05-24 23:03:39 Mike.Hillyer@sakilasta… manuel.murrell@sakilacustom…
##  3 2005-05-24 23:04:41 Jon.Stephens@sakilasta… andrew.purdy@sakilacustomer…
##  4 2005-05-24 23:05:21 Mike.Hillyer@sakilasta… delores.hansen@sakilacustom…
##  5 2005-05-24 23:08:07 Mike.Hillyer@sakilasta… nelson.christenson@sakilacu…
##  6 2005-05-24 23:11:53 Jon.Stephens@sakilasta… cassandra.walters@sakilacus…
##  7 2005-05-24 23:31:46 Jon.Stephens@sakilasta… minnie.romero@sakilacustome…
##  8 2005-05-25 00:00:40 Mike.Hillyer@sakilasta… ellen.simpson@sakilacustome…
##  9 2005-05-25 00:02:21 Jon.Stephens@sakilasta… danny.isom@sakilacustomer.o…
## 10 2005-05-25 00:09:02 Jon.Stephens@sakilasta… april.burns@sakilacustomer.…
## # … with 16,034 more rows</code></pre>
</div>
<div id="lazy_q_head" class="section level3">
<h3><span class="header-section-number">10.4.5</span> Q %&gt;% head()</h3>
<p><img src="screenshots/green-check.png" /> The <code>head()</code> function is very similar to print but has a different “<code>max.print</code>” value.</p>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb190-1" data-line-number="1">Q <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 3]
## # Database: postgres [postgres@localhost:5432/dvdrental]
##   rental_date         staff_email             customer_email               
##   &lt;dttm&gt;              &lt;chr&gt;                   &lt;chr&gt;                        
## 1 2005-05-24 22:54:33 Mike.Hillyer@sakilasta… tommy.collazo@sakilacustomer…
## 2 2005-05-24 23:03:39 Mike.Hillyer@sakilasta… manuel.murrell@sakilacustome…
## 3 2005-05-24 23:04:41 Jon.Stephens@sakilasta… andrew.purdy@sakilacustomer.…
## 4 2005-05-24 23:05:21 Mike.Hillyer@sakilasta… delores.hansen@sakilacustome…
## 5 2005-05-24 23:08:07 Mike.Hillyer@sakilasta… nelson.christenson@sakilacus…
## 6 2005-05-24 23:11:53 Jon.Stephens@sakilasta… cassandra.walters@sakilacust…</code></pre>
</div>
<div id="lazy_q_tail" class="section level3">
<h3><span class="header-section-number">10.4.6</span> Q %&gt;% tail()</h3>
<p><img src="screenshots/red-x.png" /> Produces an error, because <code>Q</code> does not hold all of the data, so it is not possible to list the last few items from the table:</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb192-1" data-line-number="1"><span class="kw">try</span>(</a>
<a class="sourceLine" id="cb192-2" data-line-number="2">  Q <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">tail</span>(),</a>
<a class="sourceLine" id="cb192-3" data-line-number="3">  <span class="dt">silent =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb192-4" data-line-number="4">  <span class="dt">outFile =</span> <span class="kw">stdout</span>()</a>
<a class="sourceLine" id="cb192-5" data-line-number="5">)</a></code></pre></div>
<pre><code>## Error : tail() is not supported by sql sources</code></pre>
</div>
<div id="lazy_q_length" class="section level3">
<h3><span class="header-section-number">10.4.7</span> Q %&gt;% length()</h3>
<p><img src="screenshots/red-x.png" /> Because the <code>Q</code> object is relatively complex, using <code>str()</code> on it prints many lines. You can glimpse what’s going on with <code>length()</code>:</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb194-1" data-line-number="1">Q <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">length</span>()</a></code></pre></div>
<pre><code>## [1] 2</code></pre>
</div>
<div id="lazy_q_str" class="section level3">
<h3><span class="header-section-number">10.4.8</span> Q %&gt;% str()</h3>
<p><img src="screenshots/red-x.png" /> Looking inside shows some of what’s going on (three levels deep):</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb196-1" data-line-number="1">Q <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">str</span>(<span class="dt">max.level =</span> <span class="dv">3</span>) </a></code></pre></div>
<pre><code>## List of 2
##  $ src:List of 2
##   ..$ con  :Formal class &#39;PqConnection&#39; [package &quot;RPostgres&quot;] with 3 slots
##   ..$ disco: NULL
##   ..- attr(*, &quot;class&quot;)= chr [1:4] &quot;src_PqConnection&quot; &quot;src_dbi&quot; &quot;src_sql&quot; &quot;src&quot;
##  $ ops:List of 4
##   ..$ name: chr &quot;select&quot;
##   ..$ x   :List of 4
##   .. ..$ name: chr &quot;rename&quot;
##   .. ..$ x   :List of 4
##   .. .. ..- attr(*, &quot;class&quot;)= chr [1:3] &quot;op_join&quot; &quot;op_double&quot; &quot;op&quot;
##   .. ..$ dots:List of 1
##   .. ..$ args: list()
##   .. ..- attr(*, &quot;class&quot;)= chr [1:3] &quot;op_rename&quot; &quot;op_single&quot; &quot;op&quot;
##   ..$ dots:List of 3
##   .. ..$ : language ~rental_date
##   .. .. ..- attr(*, &quot;.Environment&quot;)=&lt;environment: 0x7fc4872a0828&gt; 
##   .. ..$ : language ~staff_email
##   .. .. ..- attr(*, &quot;.Environment&quot;)=&lt;environment: 0x7fc4872a0828&gt; 
##   .. ..$ : language ~customer_email
##   .. .. ..- attr(*, &quot;.Environment&quot;)=&lt;environment: 0x7fc4872a0828&gt; 
##   .. ..- attr(*, &quot;class&quot;)= chr &quot;quosures&quot;
##   ..$ args: list()
##   ..- attr(*, &quot;class&quot;)= chr [1:3] &quot;op_select&quot; &quot;op_single&quot; &quot;op&quot;
##  - attr(*, &quot;class&quot;)= chr [1:5] &quot;tbl_PqConnection&quot; &quot;tbl_dbi&quot; &quot;tbl_sql&quot; &quot;tbl_lazy&quot; ...</code></pre>
</div>
<div id="lazy_q_nrow" class="section level3">
<h3><span class="header-section-number">10.4.9</span> Q %&gt;% nrow()</h3>
<p><img src="screenshots/red-x.png" /> Notice the difference between <code>nrow()</code> and <code>tally()</code>. The <code>nrow</code> functions returns <code>NA</code> and does not execute a query:</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb198-1" data-line-number="1">Q <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">nrow</span>()</a></code></pre></div>
<pre><code>## [1] NA</code></pre>
</div>
<div id="lazy_q_tally" class="section level3">
<h3><span class="header-section-number">10.4.10</span> Q %&gt;% dplyr::tally()</h3>
<p><img src="screenshots/green-check.png" /> The <code>tally</code> function actually counts all the rows.</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb200-1" data-line-number="1">Q <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">tally</span>()</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 1]
## # Database: postgres [postgres@localhost:5432/dvdrental]
##   n              
##   &lt;S3: integer64&gt;
## 1 16044</code></pre>
<p>The <code>nrow()</code> function knows that <code>Q</code> is a list. On the other hand, the <code>tally()</code> function tells SQL to go count all the rows. Notice that <code>Q</code> results in 16,044 rows – the same number of rows as <code>rental</code>.</p>
</div>
<div id="lazy_q_collect" class="section level3">
<h3><span class="header-section-number">10.4.11</span> Q %&gt;% dplyr::collect()</h3>
<p><img src="screenshots/green-check.png" /> The dplyr::<a href="https://dplyr.tidyverse.org/reference/compute.html">collect</a> function triggers a call to the <code>DBI:dbFetch()</code> function behind the scenes, which forces R to download a specified number of rows:</p>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb202-1" data-line-number="1">Q <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">collect</span>(<span class="dt">n =</span> <span class="dv">20</span>)</a></code></pre></div>
<pre><code>## # A tibble: 20 x 3
##    rental_date         staff_email             customer_email              
##    &lt;dttm&gt;              &lt;chr&gt;                   &lt;chr&gt;                       
##  1 2005-05-24 22:54:33 Mike.Hillyer@sakilasta… tommy.collazo@sakilacustome…
##  2 2005-05-24 23:03:39 Mike.Hillyer@sakilasta… manuel.murrell@sakilacustom…
##  3 2005-05-24 23:04:41 Jon.Stephens@sakilasta… andrew.purdy@sakilacustomer…
##  4 2005-05-24 23:05:21 Mike.Hillyer@sakilasta… delores.hansen@sakilacustom…
##  5 2005-05-24 23:08:07 Mike.Hillyer@sakilasta… nelson.christenson@sakilacu…
##  6 2005-05-24 23:11:53 Jon.Stephens@sakilasta… cassandra.walters@sakilacus…
##  7 2005-05-24 23:31:46 Jon.Stephens@sakilasta… minnie.romero@sakilacustome…
##  8 2005-05-25 00:00:40 Mike.Hillyer@sakilasta… ellen.simpson@sakilacustome…
##  9 2005-05-25 00:02:21 Jon.Stephens@sakilasta… danny.isom@sakilacustomer.o…
## 10 2005-05-25 00:09:02 Jon.Stephens@sakilasta… april.burns@sakilacustomer.…
## 11 2005-05-25 00:19:27 Jon.Stephens@sakilasta… deanna.byrd@sakilacustomer.…
## 12 2005-05-25 00:22:55 Mike.Hillyer@sakilasta… raymond.mcwhorter@sakilacus…
## 13 2005-05-25 00:31:15 Mike.Hillyer@sakilasta… theodore.culp@sakilacustome…
## 14 2005-05-25 00:39:22 Mike.Hillyer@sakilasta… ronald.weiner@sakilacustome…
## 15 2005-05-25 00:43:11 Jon.Stephens@sakilasta… steven.curley@sakilacustome…
## 16 2005-05-25 01:06:36 Mike.Hillyer@sakilasta… isaac.oglesby@sakilacustome…
## 17 2005-05-25 01:10:47 Jon.Stephens@sakilasta… ruth.martinez@sakilacustome…
## 18 2005-05-25 01:17:24 Mike.Hillyer@sakilasta… ronnie.ricketts@sakilacusto…
## 19 2005-05-25 01:48:41 Jon.Stephens@sakilasta… roberta.harper@sakilacustom…
## 20 2005-05-25 01:59:46 Jon.Stephens@sakilasta… craig.morrell@sakilacustome…</code></pre>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb204-1" data-line-number="1">Q <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">collect</span>(<span class="dt">n =</span> <span class="dv">20</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # A tibble: 6 x 3
##   rental_date         staff_email             customer_email               
##   &lt;dttm&gt;              &lt;chr&gt;                   &lt;chr&gt;                        
## 1 2005-05-24 22:54:33 Mike.Hillyer@sakilasta… tommy.collazo@sakilacustomer…
## 2 2005-05-24 23:03:39 Mike.Hillyer@sakilasta… manuel.murrell@sakilacustome…
## 3 2005-05-24 23:04:41 Jon.Stephens@sakilasta… andrew.purdy@sakilacustomer.…
## 4 2005-05-24 23:05:21 Mike.Hillyer@sakilasta… delores.hansen@sakilacustome…
## 5 2005-05-24 23:08:07 Mike.Hillyer@sakilasta… nelson.christenson@sakilacus…
## 6 2005-05-24 23:11:53 Jon.Stephens@sakilasta… cassandra.walters@sakilacust…</code></pre>
<p>The <code>dplyr::collect</code> function triggers the creation of a tibble and controls the number of rows that the DBMS sends to R. Notice that <code>head</code> only prints 6 of the 20 rows that R has retrieved.</p>
<p>If you do not provide a value for the <code>n</code> argument, <em>all</em> of the rows will be retrieved into your R workspace.</p>
</div>
<div id="lazy_q_show-query" class="section level3">
<h3><span class="header-section-number">10.4.12</span> Q %&gt;% dplyr::show_query()</h3>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb206-1" data-line-number="1">Q <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">show_query</span>()</a></code></pre></div>
<pre><code>## &lt;SQL&gt;
## SELECT &quot;rental_date&quot;, &quot;staff_email&quot;, &quot;customer_email&quot;
## FROM (SELECT &quot;rental_id&quot;, &quot;rental_date&quot;, &quot;inventory_id&quot;, &quot;customer_id&quot;, &quot;return_date&quot;, &quot;staff_id&quot;, &quot;last_update.x&quot;, &quot;first_name.x&quot;, &quot;last_name.x&quot;, &quot;address_id.x&quot;, &quot;staff_email&quot;, &quot;store_id.x&quot;, &quot;active.x&quot;, &quot;username&quot;, &quot;password&quot;, &quot;last_update.y&quot;, &quot;picture&quot;, &quot;store_id.y&quot;, &quot;first_name.y&quot;, &quot;last_name.y&quot;, &quot;email&quot; AS &quot;customer_email&quot;, &quot;address_id.y&quot;, &quot;activebool&quot;, &quot;create_date&quot;, &quot;last_update&quot;, &quot;active.y&quot;
## FROM (SELECT &quot;TBL_LEFT&quot;.&quot;rental_id&quot; AS &quot;rental_id&quot;, &quot;TBL_LEFT&quot;.&quot;rental_date&quot; AS &quot;rental_date&quot;, &quot;TBL_LEFT&quot;.&quot;inventory_id&quot; AS &quot;inventory_id&quot;, &quot;TBL_LEFT&quot;.&quot;customer_id&quot; AS &quot;customer_id&quot;, &quot;TBL_LEFT&quot;.&quot;return_date&quot; AS &quot;return_date&quot;, &quot;TBL_LEFT&quot;.&quot;staff_id&quot; AS &quot;staff_id&quot;, &quot;TBL_LEFT&quot;.&quot;last_update.x&quot; AS &quot;last_update.x&quot;, &quot;TBL_LEFT&quot;.&quot;first_name&quot; AS &quot;first_name.x&quot;, &quot;TBL_LEFT&quot;.&quot;last_name&quot; AS &quot;last_name.x&quot;, &quot;TBL_LEFT&quot;.&quot;address_id&quot; AS &quot;address_id.x&quot;, &quot;TBL_LEFT&quot;.&quot;staff_email&quot; AS &quot;staff_email&quot;, &quot;TBL_LEFT&quot;.&quot;store_id&quot; AS &quot;store_id.x&quot;, &quot;TBL_LEFT&quot;.&quot;active&quot; AS &quot;active.x&quot;, &quot;TBL_LEFT&quot;.&quot;username&quot; AS &quot;username&quot;, &quot;TBL_LEFT&quot;.&quot;password&quot; AS &quot;password&quot;, &quot;TBL_LEFT&quot;.&quot;last_update.y&quot; AS &quot;last_update.y&quot;, &quot;TBL_LEFT&quot;.&quot;picture&quot; AS &quot;picture&quot;, &quot;TBL_RIGHT&quot;.&quot;store_id&quot; AS &quot;store_id.y&quot;, &quot;TBL_RIGHT&quot;.&quot;first_name&quot; AS &quot;first_name.y&quot;, &quot;TBL_RIGHT&quot;.&quot;last_name&quot; AS &quot;last_name.y&quot;, &quot;TBL_RIGHT&quot;.&quot;email&quot; AS &quot;email&quot;, &quot;TBL_RIGHT&quot;.&quot;address_id&quot; AS &quot;address_id.y&quot;, &quot;TBL_RIGHT&quot;.&quot;activebool&quot; AS &quot;activebool&quot;, &quot;TBL_RIGHT&quot;.&quot;create_date&quot; AS &quot;create_date&quot;, &quot;TBL_RIGHT&quot;.&quot;last_update&quot; AS &quot;last_update&quot;, &quot;TBL_RIGHT&quot;.&quot;active&quot; AS &quot;active.y&quot;
##   FROM (SELECT &quot;rental_id&quot;, &quot;rental_date&quot;, &quot;inventory_id&quot;, &quot;customer_id&quot;, &quot;return_date&quot;, &quot;staff_id&quot;, &quot;last_update.x&quot;, &quot;first_name&quot;, &quot;last_name&quot;, &quot;address_id&quot;, &quot;email&quot; AS &quot;staff_email&quot;, &quot;store_id&quot;, &quot;active&quot;, &quot;username&quot;, &quot;password&quot;, &quot;last_update.y&quot;, &quot;picture&quot;
## FROM (SELECT &quot;TBL_LEFT&quot;.&quot;rental_id&quot; AS &quot;rental_id&quot;, &quot;TBL_LEFT&quot;.&quot;rental_date&quot; AS &quot;rental_date&quot;, &quot;TBL_LEFT&quot;.&quot;inventory_id&quot; AS &quot;inventory_id&quot;, &quot;TBL_LEFT&quot;.&quot;customer_id&quot; AS &quot;customer_id&quot;, &quot;TBL_LEFT&quot;.&quot;return_date&quot; AS &quot;return_date&quot;, &quot;TBL_LEFT&quot;.&quot;staff_id&quot; AS &quot;staff_id&quot;, &quot;TBL_LEFT&quot;.&quot;last_update&quot; AS &quot;last_update.x&quot;, &quot;TBL_RIGHT&quot;.&quot;first_name&quot; AS &quot;first_name&quot;, &quot;TBL_RIGHT&quot;.&quot;last_name&quot; AS &quot;last_name&quot;, &quot;TBL_RIGHT&quot;.&quot;address_id&quot; AS &quot;address_id&quot;, &quot;TBL_RIGHT&quot;.&quot;email&quot; AS &quot;email&quot;, &quot;TBL_RIGHT&quot;.&quot;store_id&quot; AS &quot;store_id&quot;, &quot;TBL_RIGHT&quot;.&quot;active&quot; AS &quot;active&quot;, &quot;TBL_RIGHT&quot;.&quot;username&quot; AS &quot;username&quot;, &quot;TBL_RIGHT&quot;.&quot;password&quot; AS &quot;password&quot;, &quot;TBL_RIGHT&quot;.&quot;last_update&quot; AS &quot;last_update.y&quot;, &quot;TBL_RIGHT&quot;.&quot;picture&quot; AS &quot;picture&quot;
##   FROM &quot;rental&quot; AS &quot;TBL_LEFT&quot;
##   LEFT JOIN &quot;staff&quot; AS &quot;TBL_RIGHT&quot;
##   ON (&quot;TBL_LEFT&quot;.&quot;staff_id&quot; = &quot;TBL_RIGHT&quot;.&quot;staff_id&quot;)
## ) &quot;qzdwvvvtzq&quot;) &quot;TBL_LEFT&quot;
##   LEFT JOIN &quot;customer&quot; AS &quot;TBL_RIGHT&quot;
##   ON (&quot;TBL_LEFT&quot;.&quot;customer_id&quot; = &quot;TBL_RIGHT&quot;.&quot;customer_id&quot;)
## ) &quot;rnitnthkfz&quot;) &quot;ohetoyqsmw&quot;</code></pre>
<p>Hand-written SQL code to do the same job will probably look a lot nicer and could be more efficient, but functionally <code>dplyr</code> does the job.</p>
</div>
<div id="lazy_q_build" class="section level3">
<h3><span class="header-section-number">10.4.13</span> Qc &lt;- Q %&gt;% dplyr::count(customer_email)</h3>
<p><img src="screenshots/red-x.png" /> Until <code>Q</code> is executed, we can add to it. This behavior is the basis for a useful debugging and development process where queries are built up incrementally.</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb208-1" data-line-number="1">Qc &lt;-<span class="st"> </span>Q <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">count</span>(customer_email, <span class="dt">sort =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p><img src="screenshots/green-check.png" /> When all the accumulated <code>dplyr</code> verbs are executed, they are submitted to the dbms and the number of rows that are returned follow the same rules as discussed above.</p>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb209-1" data-line-number="1">Qc</a></code></pre></div>
<pre><code>## # Source:     lazy query [?? x 2]
## # Database:   postgres [postgres@localhost:5432/dvdrental]
## # Ordered by: desc(n)
##    customer_email                    n              
##    &lt;chr&gt;                             &lt;S3: integer64&gt;
##  1 eleanor.hunt@sakilacustomer.org   46             
##  2 karl.seal@sakilacustomer.org      45             
##  3 clara.shaw@sakilacustomer.org     42             
##  4 marcia.dean@sakilacustomer.org    42             
##  5 tammy.sanders@sakilacustomer.org  41             
##  6 wesley.bull@sakilacustomer.org    40             
##  7 sue.peters@sakilacustomer.org     40             
##  8 marion.snyder@sakilacustomer.org  39             
##  9 rhonda.kennedy@sakilacustomer.org 39             
## 10 tim.cary@sakilacustomer.org       39             
## # … with more rows</code></pre>
<p>See more examples of lazy execution <a href="https://datacarpentry.org/R-ecology-lesson/05-r-and-databases.html">here</a>.</p>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb211-1" data-line-number="1">DBI<span class="op">::</span><span class="kw">dbDisconnect</span>(con)</a>
<a class="sourceLine" id="cb211-2" data-line-number="2">sqlpetr<span class="op">::</span><span class="kw">sp_docker_stop</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
</div>
</div>
<div id="other-resources" class="section level2">
<h2><span class="header-section-number">10.5</span> Other resources</h2>
<ul>
<li>Benjamin S. Baumer. 2017. A Grammar for Reproducible and Painless Extract-Transform-Load Operations on Medium Data. <a href="https://arxiv.org/abs/1708.07073">https://arxiv.org/abs/1708.07073</a></li>
<li>dplyr Reference documentation: Remote tables. <a href="https://dplyr.tidyverse.org/reference/index.html#section-remote-tables">https://dplyr.tidyverse.org/reference/index.html#section-remote-tables</a></li>
<li>Data Carpentry. SQL Databases and R. <a href="https://datacarpentry.org/R-ecology-lesson/05-r-and-databases.html">https://datacarpentry.org/R-ecology-lesson/05-r-and-databases.html</a></li>
</ul>
<!--chapter:end:090-lazy-evalutation-and-downloading.Rmd-->
</div>
</div>
<div id="chapter_dbi-package-sql" class="section level1">
<h1><span class="header-section-number">11</span> DBI package and SQL</h1>
<blockquote>
<p>This chapter:</p>
<ul>
<li>Introduces more DBI functions and demonstrates techniques for submitting SQL to the dbms</li>
<li>Illustrates some of the differences between writing <code>dplyr</code> commands and SQL</li>
<li>Suggests some strategies for dividing the work between your local R session and the dbms</li>
</ul>
</blockquote>
<div id="setup-2" class="section level2">
<h2><span class="header-section-number">11.1</span> Setup</h2>
<p>The following packages are used in this chapter:</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb212-1" data-line-number="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb212-2" data-line-number="2"><span class="kw">library</span>(DBI)</a>
<a class="sourceLine" id="cb212-3" data-line-number="3"><span class="kw">library</span>(RPostgres)</a>
<a class="sourceLine" id="cb212-4" data-line-number="4"><span class="kw">library</span>(dbplyr)</a>
<a class="sourceLine" id="cb212-5" data-line-number="5"><span class="kw">require</span>(knitr)</a>
<a class="sourceLine" id="cb212-6" data-line-number="6"><span class="kw">library</span>(bookdown)</a>
<a class="sourceLine" id="cb212-7" data-line-number="7"><span class="kw">library</span>(sqlpetr)</a></code></pre></div>
<p>If you have not yet set up the Docker container with PostgreSQL and the dvdrental database, go back to <a href="#build-the-pet-sql-docker-image">those instructions</a> to configure your environment. Otherwise, start your <code>sql-pet</code> container:</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb213-1" data-line-number="1">sqlpetr<span class="op">::</span><span class="kw">sp_docker_start</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<p>Connect to the database:</p>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb214-1" data-line-number="1">con &lt;-<span class="st"> </span>sqlpetr<span class="op">::</span><span class="kw">sp_get_postgres_connection</span>(</a>
<a class="sourceLine" id="cb214-2" data-line-number="2">  <span class="dt">user =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_USER_NAME&quot;</span>),</a>
<a class="sourceLine" id="cb214-3" data-line-number="3">  <span class="dt">password =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_PASSWORD&quot;</span>),</a>
<a class="sourceLine" id="cb214-4" data-line-number="4">  <span class="dt">dbname =</span> <span class="st">&quot;dvdrental&quot;</span>,</a>
<a class="sourceLine" id="cb214-5" data-line-number="5">  <span class="dt">seconds_to_test =</span> <span class="dv">30</span></a>
<a class="sourceLine" id="cb214-6" data-line-number="6">)</a></code></pre></div>
</div>
<div id="sql-in-r-markdown" class="section level2">
<h2><span class="header-section-number">11.2</span> SQL in R Markdown</h2>
<p>When you create a report to run repeatedly, you might want to put that query into R markdown. See the discussion of <a href="https://bookdown.org/yihui/rmarkdown/language-engines.html#sql">multiple language engines in R Markdown</a>. That way you can also execute that SQL code in a chunk with the following header:</p>
<p>{<code>sql, connection=con, output.var = &quot;query_results&quot;</code>}</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb215-1" data-line-number="1"><span class="kw">SELECT</span> <span class="ot">&quot;staff_id&quot;</span>, <span class="fu">COUNT</span>(*) <span class="kw">AS</span> <span class="ot">&quot;n&quot;</span></a>
<a class="sourceLine" id="cb215-2" data-line-number="2"><span class="kw">FROM</span> <span class="ot">&quot;rental&quot;</span></a>
<a class="sourceLine" id="cb215-3" data-line-number="3"><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="ot">&quot;staff_id&quot;</span>;</a></code></pre></div>
<p>Rmarkdown stored that query result in a tibble:</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb216-1" data-line-number="1">query_results</a></code></pre></div>
<pre><code>##   staff_id    n
## 1        2 8004
## 2        1 8040</code></pre>
</div>
<div id="dbi-package" class="section level2">
<h2><span class="header-section-number">11.3</span> DBI Package</h2>
<p>In this chapter we touched on a number of functions from the DBI Package. The table in file 96b shows other functions in the package. The Chapter column references a section in the book if we have used it.</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb218-1" data-line-number="1">film_table &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;film&quot;</span>)</a></code></pre></div>
<div id="retrieve-the-whole-table" class="section level3">
<h3><span class="header-section-number">11.3.1</span> Retrieve the whole table</h3>
<p>SQL code that is submitted to a database is evaluated all at once<a href="#fn7" class="footnote-ref" id="fnref7"><sup>7</sup></a>. To think through an SQL query, you can use <code>dplyr</code> to build it up step by step and then convert it to SQL code. Or you can use an IDE such as <a href="https://www.pgadmin.org/">pgAdmin</a> to develop your SQL code. Once you have the SQL code, the following R code demonstrates how to use <code>dbSendQuery</code> to submit SQL from your R environment.</p>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb219-1" data-line-number="1">result_set &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbSendQuery</span>(con, <span class="st">&#39;SELECT &quot;title&quot;, &quot;rental_duration&quot;, &quot;length&quot;</span></a>
<a class="sourceLine" id="cb219-2" data-line-number="2"><span class="st">FROM &quot;film&quot;</span></a>
<a class="sourceLine" id="cb219-3" data-line-number="3"><span class="st">WHERE (&quot;rental_duration&quot; &gt; 5.0 AND &quot;length&quot; &gt; 117.0)&#39;</span>)</a>
<a class="sourceLine" id="cb219-4" data-line-number="4"></a>
<a class="sourceLine" id="cb219-5" data-line-number="5">long_rental_films &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbFetch</span>(result_set)</a>
<a class="sourceLine" id="cb219-6" data-line-number="6"><span class="kw">str</span>(long_rental_films)</a></code></pre></div>
<pre><code>## &#39;data.frame&#39;:    202 obs. of  3 variables:
##  $ title          : chr  &quot;African Egg&quot; &quot;Alamo Videotape&quot; &quot;Alaska Phantom&quot; &quot;Alley Evolution&quot; ...
##  $ rental_duration: int  6 6 6 6 6 7 6 7 6 6 ...
##  $ length         : int  130 126 136 180 181 179 119 127 170 162 ...</code></pre>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb221-1" data-line-number="1">DBI<span class="op">::</span><span class="kw">dbClearResult</span>(result_set)</a></code></pre></div>
<p>The <code>dbFetch</code> function returns a <code>data.frame</code>, so you don’t have <code>dplyr</code>’s guardrails that manage the amount of data returned to your workspace. You need to manage the amount of data yourself, using the <code>n =</code> argument of <code>dbFetch</code> to specify the maximum number of records to retrieve per fetch. In the code above, we did not specify <code>n</code>, so <code>dbFetch</code> returned <em>all</em> pending records as the default behavior.</p>
<p>When you are finished using the result set object, remember to free all of the associated resources with <code>dbClearResult</code>, as shown in the code above for the <code>result_set</code> variable.</p>
</div>
<div id="or-a-chunk-at-a-time" class="section level3">
<h3><span class="header-section-number">11.3.2</span> Or a chunk at a time</h3>
<p>The following code demonstrates using the <code>n</code> argument to <code>dbFetch</code> to specify the maximum number of rows to return. Normally, you would pick some fixed number of records to return each time, but this code shows that you can vary the number of records returned by each call to <code>dbFetch</code>.</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb222-1" data-line-number="1">result_set &lt;-<span class="st"> </span><span class="kw">dbSendQuery</span>(con, <span class="st">&#39;SELECT &quot;title&quot;, &quot;rental_duration&quot;, &quot;length&quot;</span></a>
<a class="sourceLine" id="cb222-2" data-line-number="2"><span class="st">FROM &quot;film&quot;</span></a>
<a class="sourceLine" id="cb222-3" data-line-number="3"><span class="st">WHERE (&quot;rental_duration&quot; &gt; 5.0 AND &quot;length&quot; &gt; 117.0)&#39;</span>)</a>
<a class="sourceLine" id="cb222-4" data-line-number="4"></a>
<a class="sourceLine" id="cb222-5" data-line-number="5"><span class="kw">set.seed</span>(<span class="dv">5432</span>)</a>
<a class="sourceLine" id="cb222-6" data-line-number="6"></a>
<a class="sourceLine" id="cb222-7" data-line-number="7">chunk_num &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb222-8" data-line-number="8"><span class="cf">while</span> (<span class="op">!</span><span class="kw">dbHasCompleted</span>(result_set)) {</a>
<a class="sourceLine" id="cb222-9" data-line-number="9">  chunk_num &lt;-<span class="st"> </span>chunk_num <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb222-10" data-line-number="10">  chunk &lt;-<span class="st"> </span><span class="kw">dbFetch</span>(result_set, <span class="dt">n =</span> <span class="kw">sample</span>(<span class="dv">7</span><span class="op">:</span><span class="dv">13</span>,<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb222-11" data-line-number="11">  <span class="co"># print(nrow(chunk))</span></a>
<a class="sourceLine" id="cb222-12" data-line-number="12">  chunk<span class="op">$</span>chunk_num &lt;-<span class="st"> </span>chunk_num</a>
<a class="sourceLine" id="cb222-13" data-line-number="13">  <span class="cf">if</span> (<span class="op">!</span>chunk_num <span class="op">%%</span><span class="st"> </span><span class="dv">9</span>) {<span class="kw">print</span>(chunk)}</a>
<a class="sourceLine" id="cb222-14" data-line-number="14">}</a></code></pre></div>
<pre><code>##                 title rental_duration length chunk_num
## 1      Grinch Massage               7    150         9
## 2     Groundhog Uncut               6    139         9
## 3       Half Outfield               6    146         9
## 4       Hamlet Wisdom               7    146         9
## 5       Harold French               6    168         9
## 6        Hedwig Alter               7    169         9
## 7     Holes Brannigan               7    128         9
## 8     Hollow Jeopardy               7    136         9
## 9  Holocaust Highball               6    149         9
## 10          Home Pity               7    185         9
## 11     Homicide Peach               6    141         9
## 12    Hotel Happiness               6    181         9
##                     title rental_duration length chunk_num
## 1        Towers Hurricane               7    144        18
## 2                Town Ark               6    136        18
## 3       Trading Pinocchio               6    170        18
## 4 Trainspotting Strangers               7    132        18
## 5          Uncut Suicides               7    172        18
## 6    Unforgiven Zoolander               7    129        18
## 7         Uprising Uptown               6    174        18
## 8             Vanilla Day               7    122        18
## 9         Vietnam Smoochy               7    174        18</code></pre>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb224-1" data-line-number="1"><span class="kw">dbClearResult</span>(result_set)</a></code></pre></div>
</div>
</div>
<div id="dividing-the-work-between-r-on-your-machine-and-the-dbms" class="section level2">
<h2><span class="header-section-number">11.4</span> Dividing the work between R on your machine and the DBMS</h2>
<p>They work together.</p>
<div id="make-the-server-do-as-much-work-as-you-can" class="section level3">
<h3><span class="header-section-number">11.4.1</span> Make the server do as much work as you can</h3>
<ul>
<li>show_query as a first draft of SQL. May or may not use SQL code submitted directly.</li>
</ul>
</div>
<div id="criteria-for-choosing-between-dplyr-and-native-sql" class="section level3">
<h3><span class="header-section-number">11.4.2</span> Criteria for choosing between <code>dplyr</code> and native SQL</h3>
<p>This probably belongs later in the book.</p>
<ul>
<li>performance considerations: first get the right data, then worry about performance</li>
<li>Trade offs between leaving the data in PostgreSQL vs what’s kept in R:
<ul>
<li>browsing the data</li>
<li>larger samples and complete tables</li>
<li>using what you know to write efficient queries that do most of the work on the server</li>
</ul></li>
</ul>
<p>Where you place the <code>collect</code> function matters.
Here is a typical string of dplyr verbs strung together with the magrittr <code>%&gt;%</code> pipe command that will be used to tease out the several different behaviors that a lazy query has when passed to different R functions. This query joins three connection objects into a query we’ll call <code>Q</code>:</p>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb225-1" data-line-number="1">rental_table &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">tbl</span>(con, <span class="st">&quot;rental&quot;</span>)</a>
<a class="sourceLine" id="cb225-2" data-line-number="2">staff_table &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">tbl</span>(con, <span class="st">&quot;staff&quot;</span>) </a>
<a class="sourceLine" id="cb225-3" data-line-number="3"><span class="co"># the &#39;staff&#39; table has 2 rows</span></a>
<a class="sourceLine" id="cb225-4" data-line-number="4">customer_table &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">tbl</span>(con, <span class="st">&quot;customer&quot;</span>) </a>
<a class="sourceLine" id="cb225-5" data-line-number="5"><span class="co"># the &#39;customer&#39; table has 599 rows</span></a>
<a class="sourceLine" id="cb225-6" data-line-number="6"></a>
<a class="sourceLine" id="cb225-7" data-line-number="7">Q &lt;-<span class="st"> </span>rental_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb225-8" data-line-number="8"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">left_join</span>(staff_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;staff_id&quot;</span> =<span class="st"> &quot;staff_id&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb225-9" data-line-number="9"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">rename</span>(<span class="dt">staff_email =</span> email) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb225-10" data-line-number="10"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">left_join</span>(customer_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;customer_id&quot;</span> =<span class="st"> &quot;customer_id&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb225-11" data-line-number="11"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">rename</span>(<span class="dt">customer_email =</span> email) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb225-12" data-line-number="12"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(rental_date, staff_email, customer_email)</a></code></pre></div>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb226-1" data-line-number="1">Q <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">show_query</span>()</a></code></pre></div>
<pre><code>## &lt;SQL&gt;
## SELECT &quot;rental_date&quot;, &quot;staff_email&quot;, &quot;customer_email&quot;
## FROM (SELECT &quot;rental_id&quot;, &quot;rental_date&quot;, &quot;inventory_id&quot;, &quot;customer_id&quot;, &quot;return_date&quot;, &quot;staff_id&quot;, &quot;last_update.x&quot;, &quot;first_name.x&quot;, &quot;last_name.x&quot;, &quot;address_id.x&quot;, &quot;staff_email&quot;, &quot;store_id.x&quot;, &quot;active.x&quot;, &quot;username&quot;, &quot;password&quot;, &quot;last_update.y&quot;, &quot;picture&quot;, &quot;store_id.y&quot;, &quot;first_name.y&quot;, &quot;last_name.y&quot;, &quot;email&quot; AS &quot;customer_email&quot;, &quot;address_id.y&quot;, &quot;activebool&quot;, &quot;create_date&quot;, &quot;last_update&quot;, &quot;active.y&quot;
## FROM (SELECT &quot;TBL_LEFT&quot;.&quot;rental_id&quot; AS &quot;rental_id&quot;, &quot;TBL_LEFT&quot;.&quot;rental_date&quot; AS &quot;rental_date&quot;, &quot;TBL_LEFT&quot;.&quot;inventory_id&quot; AS &quot;inventory_id&quot;, &quot;TBL_LEFT&quot;.&quot;customer_id&quot; AS &quot;customer_id&quot;, &quot;TBL_LEFT&quot;.&quot;return_date&quot; AS &quot;return_date&quot;, &quot;TBL_LEFT&quot;.&quot;staff_id&quot; AS &quot;staff_id&quot;, &quot;TBL_LEFT&quot;.&quot;last_update.x&quot; AS &quot;last_update.x&quot;, &quot;TBL_LEFT&quot;.&quot;first_name&quot; AS &quot;first_name.x&quot;, &quot;TBL_LEFT&quot;.&quot;last_name&quot; AS &quot;last_name.x&quot;, &quot;TBL_LEFT&quot;.&quot;address_id&quot; AS &quot;address_id.x&quot;, &quot;TBL_LEFT&quot;.&quot;staff_email&quot; AS &quot;staff_email&quot;, &quot;TBL_LEFT&quot;.&quot;store_id&quot; AS &quot;store_id.x&quot;, &quot;TBL_LEFT&quot;.&quot;active&quot; AS &quot;active.x&quot;, &quot;TBL_LEFT&quot;.&quot;username&quot; AS &quot;username&quot;, &quot;TBL_LEFT&quot;.&quot;password&quot; AS &quot;password&quot;, &quot;TBL_LEFT&quot;.&quot;last_update.y&quot; AS &quot;last_update.y&quot;, &quot;TBL_LEFT&quot;.&quot;picture&quot; AS &quot;picture&quot;, &quot;TBL_RIGHT&quot;.&quot;store_id&quot; AS &quot;store_id.y&quot;, &quot;TBL_RIGHT&quot;.&quot;first_name&quot; AS &quot;first_name.y&quot;, &quot;TBL_RIGHT&quot;.&quot;last_name&quot; AS &quot;last_name.y&quot;, &quot;TBL_RIGHT&quot;.&quot;email&quot; AS &quot;email&quot;, &quot;TBL_RIGHT&quot;.&quot;address_id&quot; AS &quot;address_id.y&quot;, &quot;TBL_RIGHT&quot;.&quot;activebool&quot; AS &quot;activebool&quot;, &quot;TBL_RIGHT&quot;.&quot;create_date&quot; AS &quot;create_date&quot;, &quot;TBL_RIGHT&quot;.&quot;last_update&quot; AS &quot;last_update&quot;, &quot;TBL_RIGHT&quot;.&quot;active&quot; AS &quot;active.y&quot;
##   FROM (SELECT &quot;rental_id&quot;, &quot;rental_date&quot;, &quot;inventory_id&quot;, &quot;customer_id&quot;, &quot;return_date&quot;, &quot;staff_id&quot;, &quot;last_update.x&quot;, &quot;first_name&quot;, &quot;last_name&quot;, &quot;address_id&quot;, &quot;email&quot; AS &quot;staff_email&quot;, &quot;store_id&quot;, &quot;active&quot;, &quot;username&quot;, &quot;password&quot;, &quot;last_update.y&quot;, &quot;picture&quot;
## FROM (SELECT &quot;TBL_LEFT&quot;.&quot;rental_id&quot; AS &quot;rental_id&quot;, &quot;TBL_LEFT&quot;.&quot;rental_date&quot; AS &quot;rental_date&quot;, &quot;TBL_LEFT&quot;.&quot;inventory_id&quot; AS &quot;inventory_id&quot;, &quot;TBL_LEFT&quot;.&quot;customer_id&quot; AS &quot;customer_id&quot;, &quot;TBL_LEFT&quot;.&quot;return_date&quot; AS &quot;return_date&quot;, &quot;TBL_LEFT&quot;.&quot;staff_id&quot; AS &quot;staff_id&quot;, &quot;TBL_LEFT&quot;.&quot;last_update&quot; AS &quot;last_update.x&quot;, &quot;TBL_RIGHT&quot;.&quot;first_name&quot; AS &quot;first_name&quot;, &quot;TBL_RIGHT&quot;.&quot;last_name&quot; AS &quot;last_name&quot;, &quot;TBL_RIGHT&quot;.&quot;address_id&quot; AS &quot;address_id&quot;, &quot;TBL_RIGHT&quot;.&quot;email&quot; AS &quot;email&quot;, &quot;TBL_RIGHT&quot;.&quot;store_id&quot; AS &quot;store_id&quot;, &quot;TBL_RIGHT&quot;.&quot;active&quot; AS &quot;active&quot;, &quot;TBL_RIGHT&quot;.&quot;username&quot; AS &quot;username&quot;, &quot;TBL_RIGHT&quot;.&quot;password&quot; AS &quot;password&quot;, &quot;TBL_RIGHT&quot;.&quot;last_update&quot; AS &quot;last_update.y&quot;, &quot;TBL_RIGHT&quot;.&quot;picture&quot; AS &quot;picture&quot;
##   FROM &quot;rental&quot; AS &quot;TBL_LEFT&quot;
##   LEFT JOIN &quot;staff&quot; AS &quot;TBL_RIGHT&quot;
##   ON (&quot;TBL_LEFT&quot;.&quot;staff_id&quot; = &quot;TBL_RIGHT&quot;.&quot;staff_id&quot;)
## ) &quot;tvnvuviyiw&quot;) &quot;TBL_LEFT&quot;
##   LEFT JOIN &quot;customer&quot; AS &quot;TBL_RIGHT&quot;
##   ON (&quot;TBL_LEFT&quot;.&quot;customer_id&quot; = &quot;TBL_RIGHT&quot;.&quot;customer_id&quot;)
## ) &quot;dkimtwhtoo&quot;) &quot;dkadgsqpgd&quot;</code></pre>
<p>Here is the SQL query formatted for readability:</p>
<pre><code>SELECT &quot;rental_date&quot;, 
       &quot;staff_email&quot;, 
       &quot;customer_email&quot; 
FROM   (SELECT &quot;rental_id&quot;, 
               &quot;rental_date&quot;, 
               &quot;inventory_id&quot;, 
               &quot;customer_id&quot;, 
               &quot;return_date&quot;, 
               &quot;staff_id&quot;, 
               &quot;last_update.x&quot;, 
               &quot;first_name.x&quot;, 
               &quot;last_name.x&quot;, 
               &quot;address_id.x&quot;, 
               &quot;staff_email&quot;, 
               &quot;store_id.x&quot;, 
               &quot;active.x&quot;, 
               &quot;username&quot;, 
               &quot;password&quot;, 
               &quot;last_update.y&quot;, 
               &quot;picture&quot;, 
               &quot;store_id.y&quot;, 
               &quot;first_name.y&quot;, 
               &quot;last_name.y&quot;, 
               &quot;email&quot; AS &quot;customer_email&quot;, 
               &quot;address_id.y&quot;, 
               &quot;activebool&quot;, 
               &quot;create_date&quot;, 
               &quot;last_update&quot;, 
               &quot;active.y&quot; 
        FROM   (SELECT &quot;TBL_LEFT&quot;.&quot;rental_id&quot;     AS &quot;rental_id&quot;, 
                       &quot;TBL_LEFT&quot;.&quot;rental_date&quot;   AS &quot;rental_date&quot;, 
                       &quot;TBL_LEFT&quot;.&quot;inventory_id&quot;  AS &quot;inventory_id&quot;, 
                       &quot;TBL_LEFT&quot;.&quot;customer_id&quot;   AS &quot;customer_id&quot;, 
                       &quot;TBL_LEFT&quot;.&quot;return_date&quot;   AS &quot;return_date&quot;, 
                       &quot;TBL_LEFT&quot;.&quot;staff_id&quot;      AS &quot;staff_id&quot;, 
                       &quot;TBL_LEFT&quot;.&quot;last_update.x&quot; AS &quot;last_update.x&quot;, 
                       &quot;TBL_LEFT&quot;.&quot;first_name&quot;    AS &quot;first_name.x&quot;, 
                       &quot;TBL_LEFT&quot;.&quot;last_name&quot;     AS &quot;last_name.x&quot;, 
                       &quot;TBL_LEFT&quot;.&quot;address_id&quot;    AS &quot;address_id.x&quot;, 
                       &quot;TBL_LEFT&quot;.&quot;staff_email&quot;   AS &quot;staff_email&quot;, 
                       &quot;TBL_LEFT&quot;.&quot;store_id&quot;      AS &quot;store_id.x&quot;, 
                       &quot;TBL_LEFT&quot;.&quot;active&quot;        AS &quot;active.x&quot;, 
                       &quot;TBL_LEFT&quot;.&quot;username&quot;      AS &quot;username&quot;, 
                       &quot;TBL_LEFT&quot;.&quot;password&quot;      AS &quot;password&quot;, 
                       &quot;TBL_LEFT&quot;.&quot;last_update.y&quot; AS &quot;last_update.y&quot;, 
                       &quot;TBL_LEFT&quot;.&quot;picture&quot;       AS &quot;picture&quot;, 
                       &quot;TBL_RIGHT&quot;.&quot;store_id&quot;     AS &quot;store_id.y&quot;, 
                       &quot;TBL_RIGHT&quot;.&quot;first_name&quot;   AS &quot;first_name.y&quot;, 
                       &quot;TBL_RIGHT&quot;.&quot;last_name&quot;    AS &quot;last_name.y&quot;, 
                       &quot;TBL_RIGHT&quot;.&quot;email&quot;        AS &quot;email&quot;, 
                       &quot;TBL_RIGHT&quot;.&quot;address_id&quot;   AS &quot;address_id.y&quot;, 
                       &quot;TBL_RIGHT&quot;.&quot;activebool&quot;   AS &quot;activebool&quot;, 
                       &quot;TBL_RIGHT&quot;.&quot;create_date&quot;  AS &quot;create_date&quot;, 
                       &quot;TBL_RIGHT&quot;.&quot;last_update&quot;  AS &quot;last_update&quot;, 
                       &quot;TBL_RIGHT&quot;.&quot;active&quot;       AS &quot;active.y&quot; 
                FROM   (SELECT &quot;rental_id&quot;, 
                               &quot;rental_date&quot;, 
                               &quot;inventory_id&quot;, 
                               &quot;customer_id&quot;, 
                               &quot;return_date&quot;, 
                               &quot;staff_id&quot;, 
                               &quot;last_update.x&quot;, 
                               &quot;first_name&quot;, 
                               &quot;last_name&quot;, 
                               &quot;address_id&quot;, 
                               &quot;email&quot; AS &quot;staff_email&quot;, 
                               &quot;store_id&quot;, 
                               &quot;active&quot;, 
                               &quot;username&quot;, 
                               &quot;password&quot;, 
                               &quot;last_update.y&quot;, 
                               &quot;picture&quot; 
                        FROM   (SELECT &quot;TBL_LEFT&quot;.&quot;rental_id&quot;    AS &quot;rental_id&quot;, 
                                       &quot;TBL_LEFT&quot;.&quot;rental_date&quot;  AS 
                                       &quot;rental_date&quot;, 
                                       &quot;TBL_LEFT&quot;.&quot;inventory_id&quot; AS 
                                       &quot;inventory_id&quot;, 
                                       &quot;TBL_LEFT&quot;.&quot;customer_id&quot;  AS 
                                       &quot;customer_id&quot;, 
                                       &quot;TBL_LEFT&quot;.&quot;return_date&quot;  AS 
                                       &quot;return_date&quot;, 
                                       &quot;TBL_LEFT&quot;.&quot;staff_id&quot;     AS &quot;staff_id&quot;, 
                                       &quot;TBL_LEFT&quot;.&quot;last_update&quot;  AS 
                                       &quot;last_update.x&quot;, 
                                       &quot;TBL_RIGHT&quot;.&quot;first_name&quot;  AS &quot;first_name&quot; 
                                       , 
                       &quot;TBL_RIGHT&quot;.&quot;last_name&quot;   AS &quot;last_name&quot;, 
                       &quot;TBL_RIGHT&quot;.&quot;address_id&quot;  AS &quot;address_id&quot;, 
                       &quot;TBL_RIGHT&quot;.&quot;email&quot;       AS &quot;email&quot;, 
                       &quot;TBL_RIGHT&quot;.&quot;store_id&quot;    AS &quot;store_id&quot;, 
                       &quot;TBL_RIGHT&quot;.&quot;active&quot;      AS &quot;active&quot;, 
                       &quot;TBL_RIGHT&quot;.&quot;username&quot;    AS &quot;username&quot;, 
                       &quot;TBL_RIGHT&quot;.&quot;password&quot;    AS &quot;password&quot;, 
                       &quot;TBL_RIGHT&quot;.&quot;last_update&quot; AS &quot;last_update.y&quot;, 
                       &quot;TBL_RIGHT&quot;.&quot;picture&quot;     AS &quot;picture&quot; 
                                FROM   &quot;rental&quot; AS &quot;TBL_LEFT&quot; 
                                       LEFT JOIN &quot;staff&quot; AS &quot;TBL_RIGHT&quot; 
                                              ON ( &quot;TBL_LEFT&quot;.&quot;staff_id&quot; = 
                                                   &quot;TBL_RIGHT&quot;.&quot;staff_id&quot; )) 
                               &quot;ymdofxkiex&quot;) &quot;TBL_LEFT&quot; 
                       LEFT JOIN &quot;customer&quot; AS &quot;TBL_RIGHT&quot; 
                              ON ( &quot;TBL_LEFT&quot;.&quot;customer_id&quot; = 
                                 &quot;TBL_RIGHT&quot;.&quot;customer_id&quot; )) 
               &quot;exddcnhait&quot;) &quot;aohfdiedlb&quot; </code></pre>
<p>Hand-written SQL code to do the same job will probably look a lot nicer and could be more efficient, but functionally <code>dplyr</code> does the job.</p>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb229-1" data-line-number="1">GQ &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb229-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb229-3" data-line-number="3">  <span class="st">&quot;select r.rental_date, s.email staff_email,c.email customer_email  </span></a>
<a class="sourceLine" id="cb229-4" data-line-number="4"><span class="st">     from rental r</span></a>
<a class="sourceLine" id="cb229-5" data-line-number="5"><span class="st">          left outer join staff s on r.staff_id = s.staff_id</span></a>
<a class="sourceLine" id="cb229-6" data-line-number="6"><span class="st">          left outer join customer c on r.customer_id = c.customer_id</span></a>
<a class="sourceLine" id="cb229-7" data-line-number="7"><span class="st">  &quot;</span></a>
<a class="sourceLine" id="cb229-8" data-line-number="8">)</a></code></pre></div>
<p>But because <code>Q</code> hasn’t been executed, we can add to it. This behavior is the basis for a useful debugging and development process where queries are built up incrementally.</p>
<p>Where you place the <code>collect</code> function matters.</p>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb230-1" data-line-number="1">DBI<span class="op">::</span><span class="kw">dbDisconnect</span>(con)</a>
<a class="sourceLine" id="cb230-2" data-line-number="2">sqlpetr<span class="op">::</span><span class="kw">sp_docker_stop</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<!--chapter:end:100-dbi-and-sql.Rmd-->
</div>
</div>
</div>
<div id="chapter_sql-inserting-rows" class="section level1">
<h1><span class="header-section-number">12</span> Inserting rows into the DVDRENTAL database</h1>
<blockquote>
<p>This chapter demonstrates how to:</p>
<ul>
<li>Insert rows</li>
<li>do different kinds of join queries</li>
<li>Exercises</li>
<li>Query the database to get basic information about each dvdrental story</li>
<li>How to interact with the database using different strategies</li>
</ul>
</blockquote>
<div id="setup-3" class="section level2">
<h2><span class="header-section-number">12.1</span> Setup</h2>
<p>These packages are called in almost every chapter of the book:</p>
<p>Verify Docker is up and running:</p>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb231-1" data-line-number="1"><span class="kw">sp_check_that_docker_is_up</span>()</a></code></pre></div>
<pre><code>## [1] &quot;Docker is up but running no containers&quot;</code></pre>
<p>Verify pet DB is available, it may be stopped.</p>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb233-1" data-line-number="1"><span class="kw">sp_show_all_docker_containers</span>()</a></code></pre></div>
<pre><code>## CONTAINER ID        IMAGE                COMMAND                  CREATED             STATUS                     PORTS               NAMES
## ce3accea3583        postgres-dvdrental   &quot;docker-entrypoint.s…&quot;   31 seconds ago      Exited (0) 2 seconds ago                       sql-pet</code></pre>
<p>Start up the <code>docker-pet</code> container</p>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb235-1" data-line-number="1"><span class="kw">sp_docker_start</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<p>Now connect to the database with R. Need to wait for Docker &amp; Postgres to come up before connecting.</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb236-1" data-line-number="1">con &lt;-<span class="st"> </span><span class="kw">sp_get_postgres_connection</span>(</a>
<a class="sourceLine" id="cb236-2" data-line-number="2">  <span class="dt">user =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_USER_NAME&quot;</span>),</a>
<a class="sourceLine" id="cb236-3" data-line-number="3">  <span class="dt">password =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_PASSWORD&quot;</span>),</a>
<a class="sourceLine" id="cb236-4" data-line-number="4">  <span class="dt">dbname =</span> <span class="st">&quot;dvdrental&quot;</span>,</a>
<a class="sourceLine" id="cb236-5" data-line-number="5">  <span class="dt">seconds_to_test =</span> <span class="dv">30</span></a>
<a class="sourceLine" id="cb236-6" data-line-number="6">)</a></code></pre></div>
</div>
<div id="making-up-data-for-join-examples" class="section level2">
<h2><span class="header-section-number">12.2</span> Making up data for Join Examples</h2>
<p>Each chapter in the book stands on its own. If you have worked through the code blocks in this chapter in a previous session, you created some new customer records in order to work through material in the rest of the chapter.</p>
<p>The DVD rental database data is too clean to demonstrate some join concepts. To dirty the data, this chapter performs a number of database operations on data tables that a data analyst is typically restricted from doing in the real world.</p>
<ol style="list-style-type: decimal">
<li>Deleting records from tables.</li>
<li>Inserting records from tables.</li>
<li>Enabling and disabling table constraints.</li>
</ol>
<p>In our Docker environment, you have no restrictions on the database operations you can perform.</p>
<p>In the next couple of code blocks, we delete the new data and then recreate the data for the join examples in this next chapter.</p>
<div id="sql-delete-data-syntax" class="section level3">
<h3><span class="header-section-number">12.2.1</span> SQL Delete Data Syntax</h3>
<pre><code>    DELETE FROM &lt;source&gt; WHERE &lt;where_clause&gt;;</code></pre>
</div>
<div id="delete-new-practice-customers-from-the-customer-table." class="section level3">
<h3><span class="header-section-number">12.2.2</span> Delete New Practice Customers from the Customer table.</h3>
<p>In the next code block we delete out the new customers that were added when the book was compliled or added while working through the chapter. Out of the box, the DVD rental database’s highest customer_id = 599.</p>
<pre><code>dbExecute() always returns a scalar numeric that specifies the number of rows affected by the statement. </code></pre>
<div class="sourceCode" id="cb239"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb239-1" data-line-number="1"><span class="kw">dbExecute</span>(</a>
<a class="sourceLine" id="cb239-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb239-3" data-line-number="3">  <span class="st">&quot;delete from customer </span></a>
<a class="sourceLine" id="cb239-4" data-line-number="4"><span class="st">   where customer_id &gt;= 600;</span></a>
<a class="sourceLine" id="cb239-5" data-line-number="5"><span class="st">  &quot;</span></a>
<a class="sourceLine" id="cb239-6" data-line-number="6">)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<p>The number above tells us how many rows were actually deleted from the customer table.</p>
</div>
<div id="delete-new-practice-store-from-the-store-table." class="section level3">
<h3><span class="header-section-number">12.2.3</span> Delete New Practice Store from the Store Table.</h3>
<p>In the next code block we delete out the new stores that were added when the book was compliled or added working through the exercises. Out of the box, the DVD rental database’s highest store_id = 2.</p>
<div class="sourceCode" id="cb241"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb241-1" data-line-number="1"><span class="kw">dbExecute</span>(con, <span class="st">&quot;delete from store where store_id &gt; 2;&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
</div>
<div id="sql-single-row-insert-data-syntax" class="section level3">
<h3><span class="header-section-number">12.2.4</span> SQL Single Row Insert Data Syntax</h3>
<pre><code>    INSERT INTO &lt;target&gt; &lt;column_list&gt; VALUES &lt;values list&gt;;
    &lt;target&gt; : target table/view
    &lt;column list&gt; : csv list of columns
    &lt;values list&gt; : values assoicated with the column list.</code></pre>
<p>The <code>column list</code> is the list of column names on the table and the corresponding list of values must have the correct data type. The following code block returns the <code>CUSTOMER</code> column names and data types.</p>
<div class="sourceCode" id="cb244"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb244-1" data-line-number="1">customer_cols &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb244-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb244-3" data-line-number="3">  <span class="st">&quot;select table_name, column_name, ordinal_position, data_type </span></a>
<a class="sourceLine" id="cb244-4" data-line-number="4"><span class="st">          from information_schema.columns </span></a>
<a class="sourceLine" id="cb244-5" data-line-number="5"><span class="st">         where table_catalog = &#39;dvdrental&#39; </span></a>
<a class="sourceLine" id="cb244-6" data-line-number="6"><span class="st">           and table_name = &#39;customer&#39;</span></a>
<a class="sourceLine" id="cb244-7" data-line-number="7"><span class="st">       ;&quot;</span></a>
<a class="sourceLine" id="cb244-8" data-line-number="8">)</a>
<a class="sourceLine" id="cb244-9" data-line-number="9"></a>
<a class="sourceLine" id="cb244-10" data-line-number="10"><span class="kw">sp_print_df</span>(customer_cols)</a></code></pre></div>
<div id="htmlwidget-1d9f9b9fdca3023baa83" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1d9f9b9fdca3023baa83">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10"],["customer","customer","customer","customer","customer","customer","customer","customer","customer","customer"],["customer_id","store_id","first_name","last_name","email","address_id","activebool","create_date","last_update","active"],[1,2,3,4,5,6,7,8,9,10],["integer","smallint","character varying","character varying","character varying","smallint","boolean","date","timestamp without time zone","integer"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>table_name<\/th>\n      <th>column_name<\/th>\n      <th>ordinal_position<\/th>\n      <th>data_type<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":3},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>In the next code block, we insert Sophie as a new customer into the customer table via a SQL insert statement. The columns list clause has three id columns, customer_id, store_id, and address_id. The customer_id is a primary key column and the other two ‘look like’ foreign key columns.</p>
<p>For now, we are interested in getting some new customers into the customer table. We look at the relations between the customer and the store tables later in this chapter.</p>
<div class="sourceCode" id="cb245"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb245-1" data-line-number="1"><span class="kw">dbExecute</span>(</a>
<a class="sourceLine" id="cb245-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb245-3" data-line-number="3">  <span class="st">&quot;</span></a>
<a class="sourceLine" id="cb245-4" data-line-number="4"><span class="st">insert into customer </span></a>
<a class="sourceLine" id="cb245-5" data-line-number="5"><span class="st">  (customer_id,store_id,first_name,last_name,email,address_id,activebool</span></a>
<a class="sourceLine" id="cb245-6" data-line-number="6"><span class="st">  ,create_date,last_update,active)</span></a>
<a class="sourceLine" id="cb245-7" data-line-number="7"><span class="st">  values(600,3,&#39;Sophie&#39;,&#39;Yang&#39;,&#39;sophie.yang@sakilacustomer.org&#39;,1,TRUE,now(),now()::date,1)</span></a>
<a class="sourceLine" id="cb245-8" data-line-number="8"><span class="st">  &quot;</span></a>
<a class="sourceLine" id="cb245-9" data-line-number="9">)</a></code></pre></div>
<pre><code>## [1] 1</code></pre>
<p>The number above should be 1 indicating that one record was inserted.</p>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb247-1" data-line-number="1">new_customers &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con</a>
<a class="sourceLine" id="cb247-2" data-line-number="2">                ,<span class="st">&quot;select customer_id,store_id,first_name,last_name</span></a>
<a class="sourceLine" id="cb247-3" data-line-number="3"><span class="st">                     from customer where customer_id &gt;= 600;&quot;</span>)</a>
<a class="sourceLine" id="cb247-4" data-line-number="4"><span class="kw">sp_print_df</span>(new_customers)</a></code></pre></div>
<div id="htmlwidget-b18b48ec4ad649442f3b" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-b18b48ec4ad649442f3b">{"x":{"filter":"none","data":[["1"],[600],[3],["Sophie"],["Yang"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>customer_id<\/th>\n      <th>store_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="primary-key-constraint-error-message" class="section level3">
<h3><span class="header-section-number">12.2.5</span> Primary Key Constraint Error Message</h3>
<p>For the new customers, we are concerned with not violating the PK and FK constraints.
In the next SQL code block, we try and reinsert the newly created customer record inserted above. Instead of having the code block fail, it throws a duplicate key exception error message. If you <code>knit</code> the document, the exception error message is thrown to the <code>R Markdown</code> tab.</p>
<div class="sourceCode" id="cb248"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb248-1" data-line-number="1"><span class="kw">dbExecute</span>(con, <span class="st">&quot;</span></a>
<a class="sourceLine" id="cb248-2" data-line-number="2"><span class="st">do $$</span></a>
<a class="sourceLine" id="cb248-3" data-line-number="3"><span class="st">DECLARE v_customer_id INTEGER;</span></a>
<a class="sourceLine" id="cb248-4" data-line-number="4"><span class="st">begin</span></a>
<a class="sourceLine" id="cb248-5" data-line-number="5"><span class="st">    v_customer_id = 600;</span></a>
<a class="sourceLine" id="cb248-6" data-line-number="6"><span class="st">    insert into customer </span></a>
<a class="sourceLine" id="cb248-7" data-line-number="7"><span class="st">    (customer_id,store_id,first_name,last_name,email,address_id,activebool</span></a>
<a class="sourceLine" id="cb248-8" data-line-number="8"><span class="st">    ,create_date,last_update,active)</span></a>
<a class="sourceLine" id="cb248-9" data-line-number="9"><span class="st">     values(v_customer_id,3,&#39;Sophie&#39;,&#39;Yang&#39;,&#39;sophie.yang@sakilacustomer.org&#39;,1,TRUE</span></a>
<a class="sourceLine" id="cb248-10" data-line-number="10"><span class="st">           ,now(),now()::date,1);</span></a>
<a class="sourceLine" id="cb248-11" data-line-number="11"><span class="st">exception</span></a>
<a class="sourceLine" id="cb248-12" data-line-number="12"><span class="st">when unique_violation then</span></a>
<a class="sourceLine" id="cb248-13" data-line-number="13"><span class="st">    raise notice &#39;SQLERRM = %, customer_id = %&#39;, SQLERRM, v_customer_id;</span></a>
<a class="sourceLine" id="cb248-14" data-line-number="14"><span class="st">when others then </span></a>
<a class="sourceLine" id="cb248-15" data-line-number="15"><span class="st">    raise &#39;SQLERRM = % SQLSTATE =%&#39;, SQLERRM, SQLSTATE;</span></a>
<a class="sourceLine" id="cb248-16" data-line-number="16"><span class="st">end;</span></a>
<a class="sourceLine" id="cb248-17" data-line-number="17"><span class="st">$$ language &#39;plpgsql&#39;;&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<p>The number above shows how many rows were inserted. To ensure that the thrown error message is part of the book, the error message is shown below.</p>
<pre><code>NOTICE:  SQLERRM = duplicate key value violates unique constraint &quot;customer_pkey&quot;, customer_id = 600
CONTEXT:  PL/pgSQL function inline_code_block line 12 at RAISE</code></pre>
</div>
<div id="r-exercise-inserting-a-single-row-via-a-dataframe" class="section level3">
<h3><span class="header-section-number">12.2.6</span> R Exercise: Inserting a Single Row via a Dataframe</h3>
<p>In the following code block replace Sophie Yang with your name where appropriate.<br />
Note:</p>
<ol style="list-style-type: decimal">
<li>The last data frame parameter sets the stringsAsFactors is <code>FALSE</code>. Databases do not have a native <code>FACTOR</code> type.</li>
<li>The dataframe column names must match the table column names.</li>
<li>The dbWriteTable function needs <code>append</code> = true to actually insert the new row.</li>
<li>The dbWriteTable function has an option ‘overwrite’. It is set to FALSE by default. If it is set to TRUE, the table is first truncated before the row is inserted.<br />
</li>
<li>No write occurs if both overwrite and append = FALSE.</li>
</ol>
<div class="sourceCode" id="cb251"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb251-1" data-line-number="1">df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</a>
<a class="sourceLine" id="cb251-2" data-line-number="2">  <span class="dt">customer_id =</span> <span class="dv">601</span></a>
<a class="sourceLine" id="cb251-3" data-line-number="3">  , <span class="dt">store_id =</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb251-4" data-line-number="4">  , <span class="dt">first_name =</span> <span class="st">&quot;Sophie&quot;</span></a>
<a class="sourceLine" id="cb251-5" data-line-number="5">  , <span class="dt">last_name =</span> <span class="st">&quot;Yang&quot;</span></a>
<a class="sourceLine" id="cb251-6" data-line-number="6">  , <span class="dt">email =</span> <span class="st">&quot;sophie.yang@sakilacustomer.org&quot;</span></a>
<a class="sourceLine" id="cb251-7" data-line-number="7">  , <span class="dt">address_id =</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb251-8" data-line-number="8">  , <span class="dt">activebool =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb251-9" data-line-number="9">  , <span class="dt">create_date =</span> <span class="kw">Sys.Date</span>()</a>
<a class="sourceLine" id="cb251-10" data-line-number="10">  , <span class="dt">last_update =</span> <span class="kw">Sys.time</span>()</a>
<a class="sourceLine" id="cb251-11" data-line-number="11">  , <span class="dt">active =</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb251-12" data-line-number="12">  , <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb251-13" data-line-number="13">)</a>
<a class="sourceLine" id="cb251-14" data-line-number="14"><span class="kw">dbWriteTable</span>(con, <span class="st">&quot;customer&quot;</span>, <span class="dt">value =</span> df, <span class="dt">append =</span> <span class="ot">TRUE</span>, <span class="dt">row.names =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb251-15" data-line-number="15"></a>
<a class="sourceLine" id="cb251-16" data-line-number="16">new_customers &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con</a>
<a class="sourceLine" id="cb251-17" data-line-number="17">                , <span class="st">&quot;select customer_id,store_id,first_name,last_name</span></a>
<a class="sourceLine" id="cb251-18" data-line-number="18"><span class="st">                     from customer where customer_id &gt;= 600;&quot;</span>)</a>
<a class="sourceLine" id="cb251-19" data-line-number="19"><span class="kw">sp_print_df</span>(new_customers)</a></code></pre></div>
<div id="htmlwidget-514d280a38cf86ead40b" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-514d280a38cf86ead40b">{"x":{"filter":"none","data":[["1","2"],[600,601],[3,2],["Sophie","Sophie"],["Yang","Yang"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>customer_id<\/th>\n      <th>store_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="sql-multi-row-insert-data-syntax" class="section level2">
<h2><span class="header-section-number">12.3</span> SQL Multi-Row Insert Data Syntax</h2>
<pre><code>    INSERT INTO &lt;target&gt; &lt;column_list&gt; VALUES &lt;values list1&gt;, ... &lt;values listn&gt;;
    &lt;target&gt;       : target table/view
    &lt;column list&gt;  : csv list of columns
   (&lt;values list&gt;) : values assoicated with the column list.</code></pre>
<p>Postgres and some other flavors of SQL allow multiple rows to be inserted at a time. The syntax is identical to the Single Row syntax, but includes multiple <code>(&lt;values list&gt;)</code> clauses separated by commas. Note that each value list is enclosed it a set of parenthesis. The following code block illustrates the SQL multi-row insert. Note that the customer_id column takes on sequential values to satisfy the PK constraint.</p>
</div>
<div id="sql-multi-row-insert-data-example" class="section level2">
<h2><span class="header-section-number">12.4</span> SQL Multi-Row Insert Data Example</h2>
<div class="sourceCode" id="cb253"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb253-1" data-line-number="1"><span class="co">#</span></a>
<a class="sourceLine" id="cb253-2" data-line-number="2"><span class="kw">dbExecute</span>(</a>
<a class="sourceLine" id="cb253-3" data-line-number="3">  con,</a>
<a class="sourceLine" id="cb253-4" data-line-number="4">  <span class="st">&quot;insert into customer </span></a>
<a class="sourceLine" id="cb253-5" data-line-number="5"><span class="st">  (customer_id,store_id,first_name,last_name,email,address_id,activebool</span></a>
<a class="sourceLine" id="cb253-6" data-line-number="6"><span class="st">  ,create_date,last_update,active)</span></a>
<a class="sourceLine" id="cb253-7" data-line-number="7"><span class="st">   values(602,4,&#39;John&#39;,&#39;Smith&#39;,&#39;john.smith@sakilacustomer.org&#39;,2,TRUE</span></a>
<a class="sourceLine" id="cb253-8" data-line-number="8"><span class="st">         ,now()::date,now()::date,1)</span></a>
<a class="sourceLine" id="cb253-9" data-line-number="9"><span class="st">         ,(603,5,&#39;Ian&#39;,&#39;Frantz&#39;,&#39;ian.frantz@sakilacustomer.org&#39;,3,TRUE</span></a>
<a class="sourceLine" id="cb253-10" data-line-number="10"><span class="st">         ,now()::date,now()::date,1)</span></a>
<a class="sourceLine" id="cb253-11" data-line-number="11"><span class="st">         ,(604,6,&#39;Ed&#39;,&#39;Borasky&#39;,&#39;ed.borasky@sakilacustomer.org&#39;,4,TRUE</span></a>
<a class="sourceLine" id="cb253-12" data-line-number="12"><span class="st">         ,now()::date,now()::date,1)</span></a>
<a class="sourceLine" id="cb253-13" data-line-number="13"><span class="st">         ;&quot;</span></a>
<a class="sourceLine" id="cb253-14" data-line-number="14">)</a></code></pre></div>
<pre><code>## [1] 3</code></pre>
</div>
<div id="dplyr-multi-row-insert-data-example" class="section level2">
<h2><span class="header-section-number">12.5</span> DPLYR Multi-Row Insert Data Example</h2>
<p>The Postgres R multi-row insert is similar to the single row insert. The single column values are converted to a vector of values.</p>
<div id="r-exercise-inserting-multiple-rows-via-a-dataframe" class="section level3">
<h3><span class="header-section-number">12.5.1</span> R Exercise: Inserting Multiple Rows via a Dataframe</h3>
<p>Replace the two first_name, last_name, and email column values with your own made up values in the following code block. The output should be all of our new customers, customer_id = {600 - 606}.</p>
<div class="sourceCode" id="cb255"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb255-1" data-line-number="1">customer_id &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">605</span>, <span class="dv">606</span>)</a>
<a class="sourceLine" id="cb255-2" data-line-number="2">store_id &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb255-3" data-line-number="3">first_name &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;John&quot;</span>, <span class="st">&quot;Ian&quot;</span>)</a>
<a class="sourceLine" id="cb255-4" data-line-number="4">last_name &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Smith&quot;</span>, <span class="st">&quot;Frantz&quot;</span>)</a>
<a class="sourceLine" id="cb255-5" data-line-number="5">email &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;john.smith@sakilacustomer.org&quot;</span>, <span class="st">&quot;ian.frantz@sakilacustomer.org&quot;</span>)</a>
<a class="sourceLine" id="cb255-6" data-line-number="6">address_id &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb255-7" data-line-number="7">activebool &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="ot">TRUE</span>, <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb255-8" data-line-number="8">create_date &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">Sys.Date</span>(), <span class="kw">Sys.Date</span>())</a>
<a class="sourceLine" id="cb255-9" data-line-number="9">last_update &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">Sys.time</span>(), <span class="kw">Sys.time</span>())</a>
<a class="sourceLine" id="cb255-10" data-line-number="10">active &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb255-11" data-line-number="11"></a>
<a class="sourceLine" id="cb255-12" data-line-number="12">df2 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(customer_id, store_id, first_name, last_name, email,</a>
<a class="sourceLine" id="cb255-13" data-line-number="13">  address_id, activebool, create_date, last_update, active,</a>
<a class="sourceLine" id="cb255-14" data-line-number="14">  <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb255-15" data-line-number="15">)</a>
<a class="sourceLine" id="cb255-16" data-line-number="16"></a>
<a class="sourceLine" id="cb255-17" data-line-number="17"></a>
<a class="sourceLine" id="cb255-18" data-line-number="18"><span class="kw">dbWriteTable</span>(con, <span class="st">&quot;customer&quot;</span>,</a>
<a class="sourceLine" id="cb255-19" data-line-number="19">  <span class="dt">value =</span> df2, <span class="dt">append =</span> <span class="ot">TRUE</span>, <span class="dt">row.names =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb255-20" data-line-number="20">)</a>
<a class="sourceLine" id="cb255-21" data-line-number="21"></a>
<a class="sourceLine" id="cb255-22" data-line-number="22">new_customers &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con</a>
<a class="sourceLine" id="cb255-23" data-line-number="23">                , <span class="st">&quot;select customer_id,store_id,first_name,last_name</span></a>
<a class="sourceLine" id="cb255-24" data-line-number="24"><span class="st">                     from customer where customer_id &gt;= 600;&quot;</span>)</a>
<a class="sourceLine" id="cb255-25" data-line-number="25"><span class="kw">sp_print_df</span>(new_customers)</a></code></pre></div>
<div id="htmlwidget-74434d812ec23342fdce" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-74434d812ec23342fdce">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7"],[600,601,602,603,604,605,606],[3,2,4,5,6,3,4],["Sophie","Sophie","John","Ian","Ed","John","Ian"],["Yang","Yang","Smith","Frantz","Borasky","Smith","Frantz"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>customer_id<\/th>\n      <th>store_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>Confirm that the two new rows, customer_id = { 605, 606} are in the output.</p>
<p>The next two code block show all the rows in the store and staff tables. Notice that neither table has a staff_id or a manager_staff_id = 10. We will attempt to insert such a row in the upcoming code blocks.</p>
<div class="sourceCode" id="cb256"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb256-1" data-line-number="1">stores &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,<span class="st">&quot;select * from store;&quot;</span>)</a>
<a class="sourceLine" id="cb256-2" data-line-number="2"><span class="kw">sp_print_df</span>(stores)</a></code></pre></div>
<div id="htmlwidget-8da54f9f5480ad7c3ec3" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-8da54f9f5480ad7c3ec3">{"x":{"filter":"none","data":[["1","2"],[1,2],[1,2],[1,2],["2006-02-15T17:57:12Z","2006-02-15T17:57:12Z"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>store_id<\/th>\n      <th>manager_staff_id<\/th>\n      <th>address_id<\/th>\n      <th>last_update<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb257"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb257-1" data-line-number="1">staff  &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con</a>
<a class="sourceLine" id="cb257-2" data-line-number="2">            ,<span class="st">&quot;select staff_id, first_name, last_name, address_id, email, store_id</span></a>
<a class="sourceLine" id="cb257-3" data-line-number="3"><span class="st">                from staff;&quot;</span>)</a>
<a class="sourceLine" id="cb257-4" data-line-number="4"><span class="kw">sp_print_df</span>(staff)</a></code></pre></div>
<div id="htmlwidget-124fb78127817ec02cd9" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-124fb78127817ec02cd9">{"x":{"filter":"none","data":[["1","2"],[1,2],["Mike","Jon"],["Hillyer","Stephens"],[3,4],["Mike.Hillyer@sakilastaff.com","Jon.Stephens@sakilastaff.com"],[1,2]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>staff_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>address_id<\/th>\n      <th>email<\/th>\n      <th>store_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,4,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="creating-a-messy-store-row" class="section level3">
<h3><span class="header-section-number">12.5.2</span> Creating a Messy Store Row</h3>
<p>A new store row is needed to illustrate a right outer join in a future code block. However, one cannot insert/update a row into the <code>store</code> table with a manager_staff_id = 10 because of a foreign key constraint on the manager_staff_id column.</p>
<p>The manager_staff_id value must satisfy two conditions before the database will allow the new store row to be inserted into the table when the table constraints are enabled.:</p>
<ol style="list-style-type: decimal">
<li>The manager_staff_id must be unique when inserted into the store table.</li>
<li>The manager_staff_id must match a <code>staff</code> table staff_id value.</li>
</ol>
<p>Next we show both error messages:</p>
<ol style="list-style-type: decimal">
<li>The next code block attempts to insert a new store, <code>store_id = 10</code>, with manager_staff_id = 1, but fails with a unique constraint error message. The manager_staff_id = 1 already exists in the store table.</li>
</ol>
<div class="sourceCode" id="cb258"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb258-1" data-line-number="1"><span class="kw">dbExecute</span>(con, <span class="st">&quot;</span></a>
<a class="sourceLine" id="cb258-2" data-line-number="2"><span class="st">do $$</span></a>
<a class="sourceLine" id="cb258-3" data-line-number="3"><span class="st">DECLARE v_manager_staff_id INTEGER;</span></a>
<a class="sourceLine" id="cb258-4" data-line-number="4"><span class="st">begin</span></a>
<a class="sourceLine" id="cb258-5" data-line-number="5"><span class="st">    v_manager_staff_id = 1;</span></a>
<a class="sourceLine" id="cb258-6" data-line-number="6"><span class="st">    insert into store (store_id,manager_staff_id,address_id,last_update)</span></a>
<a class="sourceLine" id="cb258-7" data-line-number="7"><span class="st">         values (10,v_manager_staff_id,10,now()::date);</span></a>
<a class="sourceLine" id="cb258-8" data-line-number="8"><span class="st">exception</span></a>
<a class="sourceLine" id="cb258-9" data-line-number="9"><span class="st">when foreign_key_violation then</span></a>
<a class="sourceLine" id="cb258-10" data-line-number="10"><span class="st">    raise notice &#39;SQLERRM = %, manager_staff_id = %&#39;, SQLERRM, v_manager_staff_id;</span></a>
<a class="sourceLine" id="cb258-11" data-line-number="11"><span class="st">when others then</span></a>
<a class="sourceLine" id="cb258-12" data-line-number="12"><span class="st">    raise notice &#39;SQLERRM = % SQLSTATE =%&#39;, SQLERRM, SQLSTATE;</span></a>
<a class="sourceLine" id="cb258-13" data-line-number="13"><span class="st">end;</span></a>
<a class="sourceLine" id="cb258-14" data-line-number="14"><span class="st">$$ language &#39;plpgsql&#39;;&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<pre><code>Error in result_create(conn@ptr, statement) : Failed to prepare query: server closed the connection unexpectedly This probably means the server terminated abnormally before or while processing the request.</code></pre>
<p>The number above should be 0 and indicates no row was inserted.</p>
<ol start="2" style="list-style-type: decimal">
<li>The next code block attempts to insert a new store, <code>store_id = 10</code>, with manager_staff_id = 10, but fails with a foreign key constraint error message because there does not exist a staff table row with staff_id = 10.</li>
</ol>
<div class="sourceCode" id="cb261"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb261-1" data-line-number="1"><span class="kw">dbExecute</span>(con, <span class="st">&quot;</span></a>
<a class="sourceLine" id="cb261-2" data-line-number="2"><span class="st">do $$</span></a>
<a class="sourceLine" id="cb261-3" data-line-number="3"><span class="st">DECLARE v_manager_staff_id INTEGER;</span></a>
<a class="sourceLine" id="cb261-4" data-line-number="4"><span class="st">begin</span></a>
<a class="sourceLine" id="cb261-5" data-line-number="5"><span class="st">    v_manager_staff_id = 10;</span></a>
<a class="sourceLine" id="cb261-6" data-line-number="6"><span class="st">    insert into store (store_id,manager_staff_id,address_id,last_update)</span></a>
<a class="sourceLine" id="cb261-7" data-line-number="7"><span class="st">         values (10,v_manager_staff_id,10,now()::date);</span></a>
<a class="sourceLine" id="cb261-8" data-line-number="8"><span class="st">exception</span></a>
<a class="sourceLine" id="cb261-9" data-line-number="9"><span class="st">when foreign_key_violation then</span></a>
<a class="sourceLine" id="cb261-10" data-line-number="10"><span class="st">    raise notice &#39;SQLERRM = %, manager_staff_id = %&#39;, SQLERRM, v_manager_staff_id;</span></a>
<a class="sourceLine" id="cb261-11" data-line-number="11"><span class="st">when others then</span></a>
<a class="sourceLine" id="cb261-12" data-line-number="12"><span class="st">    raise notice &#39;SQLERRM = % SQLSTATE =%&#39;, SQLERRM, SQLSTATE;</span></a>
<a class="sourceLine" id="cb261-13" data-line-number="13"><span class="st">end;</span></a>
<a class="sourceLine" id="cb261-14" data-line-number="14"><span class="st">$$ language &#39;plpgsql&#39;;&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<pre><code>NOTICE:  SQLERRM = insert or update on table &quot;store&quot; violates foreign key constraint &quot;store_manager_staff_id_fkey&quot;, manager_staff_id = 10
CONTEXT:  PL/pgSQL function inline_code_block line 9 at RAISE</code></pre>
<p>Again, the number above should be 0 and indicates no row was inserted.</p>
<p>The following three code blocks</p>
<ol style="list-style-type: decimal">
<li>disables all the database constraints on the <code>store</code> table</li>
<li>Inserts the store row with store_id = 10 via a dataframe.</li>
<li>Re-enabes the database constraints on the store table</li>
</ol>
<div class="sourceCode" id="cb264"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb264-1" data-line-number="1"><span class="co">#</span></a>
<a class="sourceLine" id="cb264-2" data-line-number="2"><span class="kw">dbExecute</span>(con, <span class="st">&quot;ALTER TABLE store DISABLE TRIGGER ALL;&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb266"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb266-1" data-line-number="1">df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</a>
<a class="sourceLine" id="cb266-2" data-line-number="2">    <span class="dt">store_id =</span> <span class="dv">10</span></a>
<a class="sourceLine" id="cb266-3" data-line-number="3">  , <span class="dt">manager_staff_id =</span> <span class="dv">10</span></a>
<a class="sourceLine" id="cb266-4" data-line-number="4">  , <span class="dt">address_id =</span> <span class="dv">10</span></a>
<a class="sourceLine" id="cb266-5" data-line-number="5">  , <span class="dt">last_update =</span> <span class="kw">Sys.time</span>()</a>
<a class="sourceLine" id="cb266-6" data-line-number="6">)</a>
<a class="sourceLine" id="cb266-7" data-line-number="7"><span class="kw">dbWriteTable</span>(con, <span class="st">&quot;store&quot;</span>, <span class="dt">value =</span> df, <span class="dt">append =</span> <span class="ot">TRUE</span>, <span class="dt">row.names =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<div class="sourceCode" id="cb267"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb267-1" data-line-number="1"><span class="kw">dbExecute</span>(con, <span class="st">&quot;ALTER TABLE store ENABLE TRIGGER ALL;&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<p>The zeros after the dbExecute code blocks indicate that the dbExecute calls did not alter any rows on the table.</p>
<p>In the next code block we confirm our new row, store_id = 10, was actually inserted.</p>
<div class="sourceCode" id="cb269"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb269-1" data-line-number="1">stores &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,<span class="st">&quot;select * from store;&quot;</span>)</a>
<a class="sourceLine" id="cb269-2" data-line-number="2"><span class="kw">sp_print_df</span>(stores)</a></code></pre></div>
<div id="htmlwidget-dd0a51033db44e820d90" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-dd0a51033db44e820d90">{"x":{"filter":"none","data":[["1","2","3"],[1,2,10],[1,2,10],[1,2,10],["2006-02-15T17:57:12Z","2006-02-15T17:57:12Z","2019-03-04T02:21:29Z"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>store_id<\/th>\n      <th>manager_staff_id<\/th>\n      <th>address_id<\/th>\n      <th>last_update<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<!--

## Creating Duplicate Customer Rows 

In the next section we create a new table, `smy_customer`.  We will load all customers with customer_id > 594 twice.  The `smy_customer` table will be used in the dplyr semi-join section. 


```r
dbExecute(con,"drop table if exists smy_customer;")
```

```
## [1] 0
```

```r
dbExecute(con,"create table smy_customer 
    as select * 
         from customer  
        where customer_id > 594;")
```

```
## [1] 12
```

```r
dbExecute(con,"insert into smy_customer 
               select * 
                 from customer  
                where customer_id > 594;")
```

```
## [1] 12
```

```r
smy_cust_dupes <- dbGetQuery(con,'select * 
                                    from smy_customer 
                                  order by customer_id')

sp_print_df(smy_cust_dupes)
```

<div id="htmlwidget-1fe403c81784621152ab" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1fe403c81784621152ab">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24"],[595,595,596,596,597,597,598,598,599,599,600,600,601,601,602,602,603,603,604,604,605,605,606,606],[1,1,1,1,1,1,1,1,2,2,3,3,2,2,4,4,5,5,6,6,3,3,4,4],["Terrence","Terrence","Enrique","Enrique","Freddie","Freddie","Wade","Wade","Austin","Austin","Sophie","Sophie","Sophie","Sophie","John","John","Ian","Ian","Ed","Ed","John","John","Ian","Ian"],["Gunderson","Gunderson","Forsythe","Forsythe","Duggan","Duggan","Delvalle","Delvalle","Cintron","Cintron","Yang","Yang","Yang","Yang","Smith","Smith","Frantz","Frantz","Borasky","Borasky","Smith","Smith","Frantz","Frantz"],["terrence.gunderson@sakilacustomer.org","terrence.gunderson@sakilacustomer.org","enrique.forsythe@sakilacustomer.org","enrique.forsythe@sakilacustomer.org","freddie.duggan@sakilacustomer.org","freddie.duggan@sakilacustomer.org","wade.delvalle@sakilacustomer.org","wade.delvalle@sakilacustomer.org","austin.cintron@sakilacustomer.org","austin.cintron@sakilacustomer.org","sophie.yang@sakilacustomer.org","sophie.yang@sakilacustomer.org","sophie.yang@sakilacustomer.org","sophie.yang@sakilacustomer.org","john.smith@sakilacustomer.org","john.smith@sakilacustomer.org","ian.frantz@sakilacustomer.org","ian.frantz@sakilacustomer.org","ed.borasky@sakilacustomer.org","ed.borasky@sakilacustomer.org","john.smith@sakilacustomer.org","john.smith@sakilacustomer.org","ian.frantz@sakilacustomer.org","ian.frantz@sakilacustomer.org"],[601,601,602,602,603,603,604,604,605,605,1,1,1,1,2,2,3,3,4,4,3,3,4,4],[true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true],["2006-02-14","2006-02-14","2006-02-14","2006-02-14","2006-02-14","2006-02-14","2006-02-14","2006-02-14","2006-02-14","2006-02-14","2019-03-04","2019-03-04","2019-03-03","2019-03-03","2019-03-04","2019-03-04","2019-03-04","2019-03-04","2019-03-04","2019-03-04","2019-03-03","2019-03-03","2019-03-03","2019-03-03"],["2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2019-03-04T08:00:00Z","2019-03-04T08:00:00Z","2019-03-04T02:21:29Z","2019-03-04T02:21:29Z","2019-03-04T08:00:00Z","2019-03-04T08:00:00Z","2019-03-04T08:00:00Z","2019-03-04T08:00:00Z","2019-03-04T08:00:00Z","2019-03-04T08:00:00Z","2019-03-04T02:21:29Z","2019-03-04T02:21:29Z","2019-03-04T02:21:29Z","2019-03-04T02:21:29Z"],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>customer_id<\/th>\n      <th>store_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>email<\/th>\n      <th>address_id<\/th>\n      <th>activebool<\/th>\n      <th>create_date<\/th>\n      <th>last_update<\/th>\n      <th>active<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,6,10]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
-->
<p>Diconnect from the db:</p>
<div class="sourceCode" id="cb270"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb270-1" data-line-number="1"> <span class="kw">dbDisconnect</span>(con)</a>
<a class="sourceLine" id="cb270-2" data-line-number="2"></a>
<a class="sourceLine" id="cb270-3" data-line-number="3"> <span class="kw">sp_docker_stop</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="cb271"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb271-1" data-line-number="1">knitr<span class="op">::</span><span class="kw">knit_exit</span>()</a></code></pre></div>
<!--chapter:end:107-sql-insert-rows.Rmd-->
</div>
</div>
</div>
<div id="chapter_sql-dplyr-data" class="section level1">
<h1><span class="header-section-number">13</span> SQL &amp; dplyr joins additional data</h1>
<blockquote>
<p>This chapter demonstrates how to:</p>
<ul>
<li>Use primary and foreign keys to retrieve specific rows of a table</li>
<li>do different kinds of join queries</li>
<li>Exercises</li>
<li>Query the database to get basic information about each dvdrental story</li>
<li>How to interact with the database using different strategies</li>
</ul>
</blockquote>
<p>These packages are called in almost every chapter of the book:</p>
<p>Verify Docker is up and running:</p>
<div class="sourceCode" id="cb272"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb272-1" data-line-number="1"><span class="kw">sp_check_that_docker_is_up</span>()</a></code></pre></div>
<pre><code>## [1] &quot;Docker is up but running no containers&quot;</code></pre>
<p>Verify pet DB is available, it may be stopped.</p>
<div class="sourceCode" id="cb274"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb274-1" data-line-number="1"><span class="kw">sp_show_all_docker_containers</span>()</a></code></pre></div>
<pre><code>## CONTAINER ID        IMAGE                COMMAND                  CREATED             STATUS                     PORTS               NAMES
## ce3accea3583        postgres-dvdrental   &quot;docker-entrypoint.s…&quot;   36 seconds ago      Exited (0) 2 seconds ago                       sql-pet</code></pre>
<p>Start up the <code>docker-pet</code> container</p>
<div class="sourceCode" id="cb276"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb276-1" data-line-number="1"><span class="kw">sp_docker_start</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<p>Now connect to the database with R. Need to wait for Docker &amp; Postgres to come up before connecting.</p>
<div class="sourceCode" id="cb277"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb277-1" data-line-number="1">con &lt;-<span class="st"> </span><span class="kw">sp_get_postgres_connection</span>(</a>
<a class="sourceLine" id="cb277-2" data-line-number="2">  <span class="dt">user =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_USER_NAME&quot;</span>),</a>
<a class="sourceLine" id="cb277-3" data-line-number="3">  <span class="dt">password =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_PASSWORD&quot;</span>),</a>
<a class="sourceLine" id="cb277-4" data-line-number="4">  <span class="dt">dbname =</span> <span class="st">&quot;dvdrental&quot;</span>,</a>
<a class="sourceLine" id="cb277-5" data-line-number="5">  <span class="dt">seconds_to_test =</span> <span class="dv">30</span></a>
<a class="sourceLine" id="cb277-6" data-line-number="6">)</a></code></pre></div>
<div id="making-up-data-for-join-examples-1" class="section level2">
<h2><span class="header-section-number">13.1</span> Making up data for Join Examples</h2>
<p>Each chapter in the book stands on its own. If you have worked through the code blocks in this chapter in a previous session, you created some new customer records in order to work through material in the rest of the chapter.</p>
<p>The DVD rental database data is too clean to demonstrate some join concepts. To dirty the data, this chapter performs a number of database operations on data tables that a data analyst is typically restricted from doing in the real world.</p>
<ol style="list-style-type: decimal">
<li>Deleting records from tables.</li>
<li>Inserting records from tables.</li>
<li>Enabling and disabling table constraints.</li>
</ol>
<p>In our Docker environment, you have no restrictions on the database operations you can perform.</p>
<p>In the next couple of code blocks, we delete the new data and then recreate the data for the join examples in this next chapter.</p>
<div id="sql-delete-data-syntax-1" class="section level3">
<h3><span class="header-section-number">13.1.1</span> SQL Delete Data Syntax</h3>
<pre><code>    DELETE FROM &lt;source&gt; WHERE &lt;where_clause&gt;;</code></pre>
</div>
<div id="delete-new-practice-store-from-the-store-table.-1" class="section level3">
<h3><span class="header-section-number">13.1.2</span> Delete New Practice Store from the Store Table.</h3>
<p>In the next code block we delete out the new stores that were added when the book was compliled or added working through the exercises. Out of the box, the DVD rental database’s highest store_id = 2.</p>
<div class="sourceCode" id="cb279"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb279-1" data-line-number="1"><span class="kw">dbExecute</span>(con, <span class="st">&quot;delete from store where store_id &gt; 2;&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 1</code></pre>
</div>
<div id="delete-film-1001-sophies-choice-records-in-film_category-rental-inventory-and-film" class="section level3">
<h3><span class="header-section-number">13.1.3</span> Delete film 1001, Sophie’s Choice, records in film_category, rental, inventory, and film</h3>
<p>The records need to be deleted in a specific order to not violate constraints.</p>
<div class="sourceCode" id="cb281"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb281-1" data-line-number="1"><span class="kw">dbExecute</span>(con, <span class="st">&quot;delete from film_category where film_id &gt;= 1001;&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb283"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb283-1" data-line-number="1"><span class="kw">dbExecute</span>(con, <span class="st">&quot;delete from rental where rental_id &gt;= 16050;&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb285"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb285-1" data-line-number="1"><span class="kw">dbExecute</span>(con, <span class="st">&quot;delete from inventory where film_id &gt;= 1001;&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb287"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb287-1" data-line-number="1"><span class="kw">dbExecute</span>(con, <span class="st">&quot;delete from film where film_id &gt;= 1001;&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
</div>
<div id="delete-new-practice-customers-from-the-customer-table.-1" class="section level3">
<h3><span class="header-section-number">13.1.4</span> Delete New Practice Customers from the Customer table.</h3>
<p>In the next code block we delete out the new customers that were added when the book was compliled or added while working through the chapter. Out of the box, the DVD rental database’s highest customer_id = 599.</p>
</div>
<div id="delete-new-practice-customers-from-the-customer-table.-2" class="section level3">
<h3><span class="header-section-number">13.1.5</span> Delete New Practice Customers from the Customer table.</h3>
<p>In the next code block we delete out the new customers that were added when the book was compliled or added while working through the chapter. Out of the box, the DVD rental database’s highest customer_id = 599.</p>
<pre><code>dbExecute() always returns a scalar numeric that specifies the number of rows affected by the statement. </code></pre>
<div class="sourceCode" id="cb290"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb290-1" data-line-number="1"><span class="kw">dbExecute</span>(</a>
<a class="sourceLine" id="cb290-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb290-3" data-line-number="3">  <span class="st">&quot;delete from customer </span></a>
<a class="sourceLine" id="cb290-4" data-line-number="4"><span class="st">   where customer_id &gt;= 600;</span></a>
<a class="sourceLine" id="cb290-5" data-line-number="5"><span class="st">  &quot;</span></a>
<a class="sourceLine" id="cb290-6" data-line-number="6">)</a></code></pre></div>
<pre><code>## [1] 7</code></pre>
<p>The number above tells us how many rows were actually deleted from the customer table.</p>
</div>
<div id="sql-single-row-insert-data-syntax-1" class="section level3">
<h3><span class="header-section-number">13.1.6</span> SQL Single Row Insert Data Syntax</h3>
<pre><code>    INSERT INTO &lt;target&gt; &lt;column_list&gt; VALUES &lt;values list&gt;;
    &lt;target&gt; : target table/view
    &lt;column list&gt; : csv list of columns
    &lt;values list&gt; : values assoicated with the column list.</code></pre>
<p>The <code>column list</code> is the list of column names on the table and the corresponding list of values must have the correct data type. The following code block returns the <code>CUSTOMER</code> column names and data types.</p>
<div class="sourceCode" id="cb293"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb293-1" data-line-number="1">customer_cols &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb293-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb293-3" data-line-number="3">  <span class="st">&quot;select table_name, column_name, ordinal_position, data_type </span></a>
<a class="sourceLine" id="cb293-4" data-line-number="4"><span class="st">          from information_schema.columns </span></a>
<a class="sourceLine" id="cb293-5" data-line-number="5"><span class="st">         where table_catalog = &#39;dvdrental&#39; </span></a>
<a class="sourceLine" id="cb293-6" data-line-number="6"><span class="st">           and table_name = &#39;customer&#39;</span></a>
<a class="sourceLine" id="cb293-7" data-line-number="7"><span class="st">       ;&quot;</span></a>
<a class="sourceLine" id="cb293-8" data-line-number="8">)</a>
<a class="sourceLine" id="cb293-9" data-line-number="9"></a>
<a class="sourceLine" id="cb293-10" data-line-number="10"><span class="kw">sp_print_df</span>(customer_cols)</a></code></pre></div>
<div id="htmlwidget-1d9f9b9fdca3023baa83" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1d9f9b9fdca3023baa83">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10"],["customer","customer","customer","customer","customer","customer","customer","customer","customer","customer"],["customer_id","store_id","first_name","last_name","email","address_id","activebool","create_date","last_update","active"],[1,2,3,4,5,6,7,8,9,10],["integer","smallint","character varying","character varying","character varying","smallint","boolean","date","timestamp without time zone","integer"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>table_name<\/th>\n      <th>column_name<\/th>\n      <th>ordinal_position<\/th>\n      <th>data_type<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":3},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>In the next code block, we insert Sophie as a new customer into the customer table via a SQL insert statement. The columns list clause has three id columns, customer_id, store_id, and address_id. The customer_id is a primary key column and the other two ‘look like’ foreign key columns.</p>
<p>For now, we are interested in getting some new customers into the customer table. We look at the relations between the customer and the store tables later in this chapter.</p>
<div class="sourceCode" id="cb294"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb294-1" data-line-number="1"><span class="kw">dbExecute</span>(</a>
<a class="sourceLine" id="cb294-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb294-3" data-line-number="3">  <span class="st">&quot;</span></a>
<a class="sourceLine" id="cb294-4" data-line-number="4"><span class="st">insert into customer </span></a>
<a class="sourceLine" id="cb294-5" data-line-number="5"><span class="st">  (customer_id,store_id,first_name,last_name,email,address_id,activebool</span></a>
<a class="sourceLine" id="cb294-6" data-line-number="6"><span class="st">  ,create_date,last_update,active)</span></a>
<a class="sourceLine" id="cb294-7" data-line-number="7"><span class="st">  values(600,3,&#39;Sophie&#39;,&#39;Yang&#39;,&#39;sophie.yang@sakilacustomer.org&#39;,1,TRUE,now(),now()::date,1)</span></a>
<a class="sourceLine" id="cb294-8" data-line-number="8"><span class="st">  &quot;</span></a>
<a class="sourceLine" id="cb294-9" data-line-number="9">)</a></code></pre></div>
<pre><code>## [1] 1</code></pre>
<p>The number above should be 1 indicating that one record was inserted.</p>
<div class="sourceCode" id="cb296"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb296-1" data-line-number="1">new_customers &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con</a>
<a class="sourceLine" id="cb296-2" data-line-number="2">                ,<span class="st">&quot;select customer_id,store_id,first_name,last_name</span></a>
<a class="sourceLine" id="cb296-3" data-line-number="3"><span class="st">                     from customer where customer_id &gt;= 600;&quot;</span>)</a>
<a class="sourceLine" id="cb296-4" data-line-number="4"><span class="kw">sp_print_df</span>(new_customers)</a></code></pre></div>
<div id="htmlwidget-b18b48ec4ad649442f3b" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-b18b48ec4ad649442f3b">{"x":{"filter":"none","data":[["1"],[600],[3],["Sophie"],["Yang"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>customer_id<\/th>\n      <th>store_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="primary-key-constraint-error-message-1" class="section level3">
<h3><span class="header-section-number">13.1.7</span> Primary Key Constraint Error Message</h3>
<p>For the new customers, we are concerned with not violating the PK and FK constraints.
In the next SQL code block, we try and reinsert the newly created customer record inserted above. Instead of having the code block fail, it throws a duplicate key exception error message. If you <code>knit</code> the document, the exception error message is thrown to the <code>R Markdown</code> tab.</p>
<div class="sourceCode" id="cb297"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb297-1" data-line-number="1"><span class="kw">dbExecute</span>(con, <span class="st">&quot;</span></a>
<a class="sourceLine" id="cb297-2" data-line-number="2"><span class="st">do $$</span></a>
<a class="sourceLine" id="cb297-3" data-line-number="3"><span class="st">DECLARE v_customer_id INTEGER;</span></a>
<a class="sourceLine" id="cb297-4" data-line-number="4"><span class="st">begin</span></a>
<a class="sourceLine" id="cb297-5" data-line-number="5"><span class="st">    v_customer_id = 600;</span></a>
<a class="sourceLine" id="cb297-6" data-line-number="6"><span class="st">    insert into customer </span></a>
<a class="sourceLine" id="cb297-7" data-line-number="7"><span class="st">    (customer_id,store_id,first_name,last_name,email,address_id,activebool</span></a>
<a class="sourceLine" id="cb297-8" data-line-number="8"><span class="st">    ,create_date,last_update,active)</span></a>
<a class="sourceLine" id="cb297-9" data-line-number="9"><span class="st">     values(v_customer_id,3,&#39;Sophie&#39;,&#39;Yang&#39;,&#39;sophie.yang@sakilacustomer.org&#39;,1,TRUE</span></a>
<a class="sourceLine" id="cb297-10" data-line-number="10"><span class="st">           ,now(),now()::date,1);</span></a>
<a class="sourceLine" id="cb297-11" data-line-number="11"><span class="st">exception</span></a>
<a class="sourceLine" id="cb297-12" data-line-number="12"><span class="st">when unique_violation then</span></a>
<a class="sourceLine" id="cb297-13" data-line-number="13"><span class="st">    raise notice &#39;SQLERRM = %, customer_id = %&#39;, SQLERRM, v_customer_id;</span></a>
<a class="sourceLine" id="cb297-14" data-line-number="14"><span class="st">when others then </span></a>
<a class="sourceLine" id="cb297-15" data-line-number="15"><span class="st">    raise &#39;SQLERRM = % SQLSTATE =%&#39;, SQLERRM, SQLSTATE;</span></a>
<a class="sourceLine" id="cb297-16" data-line-number="16"><span class="st">end;</span></a>
<a class="sourceLine" id="cb297-17" data-line-number="17"><span class="st">$$ language &#39;plpgsql&#39;;&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<p>The number above shows how many rows were inserted. To ensure that the thrown error message is part of the book, the error message is shown below.</p>
<pre><code>NOTICE:  SQLERRM = duplicate key value violates unique constraint &quot;customer_pkey&quot;, customer_id = 600
CONTEXT:  PL/pgSQL function inline_code_block line 12 at RAISE</code></pre>
</div>
<div id="r-exercise-inserting-a-single-row-via-a-dataframe-1" class="section level3">
<h3><span class="header-section-number">13.1.8</span> R Exercise: Inserting a Single Row via a Dataframe</h3>
<p>In the following code block replace Sophie Yang with your name where appropriate.<br />
Note:</p>
<ol style="list-style-type: decimal">
<li>The last data frame parameter sets the stringsAsFactors is <code>FALSE</code>. Databases do not have a native <code>FACTOR</code> type.</li>
<li>The dataframe column names must match the table column names.</li>
<li>The dbWriteTable function needs <code>append</code> = true to actually insert the new row.</li>
<li>The dbWriteTable function has an option ‘overwrite’. It is set to FALSE by default. If it is set to TRUE, the table is first truncated before the row is inserted.<br />
</li>
<li>No write occurs if both overwrite and append = FALSE.</li>
</ol>
<div class="sourceCode" id="cb300"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb300-1" data-line-number="1">df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</a>
<a class="sourceLine" id="cb300-2" data-line-number="2">  <span class="dt">customer_id =</span> <span class="dv">601</span></a>
<a class="sourceLine" id="cb300-3" data-line-number="3">  , <span class="dt">store_id =</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb300-4" data-line-number="4">  , <span class="dt">first_name =</span> <span class="st">&quot;Sophie&quot;</span></a>
<a class="sourceLine" id="cb300-5" data-line-number="5">  , <span class="dt">last_name =</span> <span class="st">&quot;Yang&quot;</span></a>
<a class="sourceLine" id="cb300-6" data-line-number="6">  , <span class="dt">email =</span> <span class="st">&quot;sophie.yang@sakilacustomer.org&quot;</span></a>
<a class="sourceLine" id="cb300-7" data-line-number="7">  , <span class="dt">address_id =</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb300-8" data-line-number="8">  , <span class="dt">activebool =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb300-9" data-line-number="9">  , <span class="dt">create_date =</span> <span class="kw">Sys.Date</span>()</a>
<a class="sourceLine" id="cb300-10" data-line-number="10">  , <span class="dt">last_update =</span> <span class="kw">Sys.time</span>()</a>
<a class="sourceLine" id="cb300-11" data-line-number="11">  , <span class="dt">active =</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb300-12" data-line-number="12">  , <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb300-13" data-line-number="13">)</a>
<a class="sourceLine" id="cb300-14" data-line-number="14"><span class="kw">dbWriteTable</span>(con, <span class="st">&quot;customer&quot;</span>, <span class="dt">value =</span> df, <span class="dt">append =</span> <span class="ot">TRUE</span>, <span class="dt">row.names =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb300-15" data-line-number="15"></a>
<a class="sourceLine" id="cb300-16" data-line-number="16">new_customers &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con</a>
<a class="sourceLine" id="cb300-17" data-line-number="17">                , <span class="st">&quot;select customer_id,store_id,first_name,last_name</span></a>
<a class="sourceLine" id="cb300-18" data-line-number="18"><span class="st">                     from customer where customer_id &gt;= 600;&quot;</span>)</a>
<a class="sourceLine" id="cb300-19" data-line-number="19"><span class="kw">sp_print_df</span>(new_customers)</a></code></pre></div>
<div id="htmlwidget-514d280a38cf86ead40b" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-514d280a38cf86ead40b">{"x":{"filter":"none","data":[["1","2"],[600,601],[3,2],["Sophie","Sophie"],["Yang","Yang"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>customer_id<\/th>\n      <th>store_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="sql-multi-row-insert-data-syntax-1" class="section level2">
<h2><span class="header-section-number">13.2</span> SQL Multi-Row Insert Data Syntax</h2>
<pre><code>    INSERT INTO &lt;target&gt; &lt;column_list&gt; VALUES &lt;values list1&gt;, ... &lt;values listn&gt;;
    &lt;target&gt;       : target table/view
    &lt;column list&gt;  : csv list of columns
   (&lt;values list&gt;) : values assoicated with the column list.</code></pre>
<p>Postgres and some other flavors of SQL allow multiple rows to be inserted at a time. The syntax is identical to the Single Row syntax, but includes multiple <code>(&lt;values list&gt;)</code> clauses separated by commas. Note that each value list is enclosed it a set of parenthesis. The following code block illustrates the SQL multi-row insert. Note that the customer_id column takes on sequential values to satisfy the PK constraint.</p>
</div>
<div id="sql-multi-row-insert-data-example-1" class="section level2">
<h2><span class="header-section-number">13.3</span> SQL Multi-Row Insert Data Example</h2>
<div class="sourceCode" id="cb302"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb302-1" data-line-number="1"><span class="co">#</span></a>
<a class="sourceLine" id="cb302-2" data-line-number="2"><span class="kw">dbExecute</span>(</a>
<a class="sourceLine" id="cb302-3" data-line-number="3">  con,</a>
<a class="sourceLine" id="cb302-4" data-line-number="4">  <span class="st">&quot;insert into customer </span></a>
<a class="sourceLine" id="cb302-5" data-line-number="5"><span class="st">  (customer_id,store_id,first_name,last_name,email,address_id,activebool</span></a>
<a class="sourceLine" id="cb302-6" data-line-number="6"><span class="st">  ,create_date,last_update,active)</span></a>
<a class="sourceLine" id="cb302-7" data-line-number="7"><span class="st">   values(602,4,&#39;John&#39;,&#39;Smith&#39;,&#39;john.smith@sakilacustomer.org&#39;,2,TRUE</span></a>
<a class="sourceLine" id="cb302-8" data-line-number="8"><span class="st">         ,now()::date,now()::date,1)</span></a>
<a class="sourceLine" id="cb302-9" data-line-number="9"><span class="st">         ,(603,5,&#39;Ian&#39;,&#39;Frantz&#39;,&#39;ian.frantz@sakilacustomer.org&#39;,3,TRUE</span></a>
<a class="sourceLine" id="cb302-10" data-line-number="10"><span class="st">         ,now()::date,now()::date,1)</span></a>
<a class="sourceLine" id="cb302-11" data-line-number="11"><span class="st">         ,(604,6,&#39;Ed&#39;,&#39;Borasky&#39;,&#39;ed.borasky@sakilacustomer.org&#39;,4,TRUE</span></a>
<a class="sourceLine" id="cb302-12" data-line-number="12"><span class="st">         ,now()::date,now()::date,1)</span></a>
<a class="sourceLine" id="cb302-13" data-line-number="13"><span class="st">         ;&quot;</span></a>
<a class="sourceLine" id="cb302-14" data-line-number="14">)</a></code></pre></div>
<pre><code>## [1] 3</code></pre>
</div>
<div id="dplyr-multi-row-insert-data-example-1" class="section level2">
<h2><span class="header-section-number">13.4</span> DPLYR Multi-Row Insert Data Example</h2>
<p>The Postgres R multi-row insert is similar to the single row insert. The single column values are converted to a vector of values.</p>
<div id="r-exercise-inserting-multiple-rows-via-a-dataframe-1" class="section level3">
<h3><span class="header-section-number">13.4.1</span> R Exercise: Inserting Multiple Rows via a Dataframe</h3>
<p>Replace the two first_name, last_name, and email column values with your own made up values in the following code block. The output should be all of our new customers, customer_id = {600 - 606}.</p>
<div class="sourceCode" id="cb304"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb304-1" data-line-number="1">customer_id &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">605</span>, <span class="dv">606</span>)</a>
<a class="sourceLine" id="cb304-2" data-line-number="2">store_id &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb304-3" data-line-number="3">first_name &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;John&quot;</span>, <span class="st">&quot;Ian&quot;</span>)</a>
<a class="sourceLine" id="cb304-4" data-line-number="4">last_name &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Smith&quot;</span>, <span class="st">&quot;Frantz&quot;</span>)</a>
<a class="sourceLine" id="cb304-5" data-line-number="5">email &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;john.smith@sakilacustomer.org&quot;</span>, <span class="st">&quot;ian.frantz@sakilacustomer.org&quot;</span>)</a>
<a class="sourceLine" id="cb304-6" data-line-number="6">address_id &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb304-7" data-line-number="7">activebool &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="ot">TRUE</span>, <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb304-8" data-line-number="8">create_date &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">Sys.Date</span>(), <span class="kw">Sys.Date</span>())</a>
<a class="sourceLine" id="cb304-9" data-line-number="9">last_update &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">Sys.time</span>(), <span class="kw">Sys.time</span>())</a>
<a class="sourceLine" id="cb304-10" data-line-number="10">active &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb304-11" data-line-number="11"></a>
<a class="sourceLine" id="cb304-12" data-line-number="12">df2 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(customer_id, store_id, first_name, last_name, email,</a>
<a class="sourceLine" id="cb304-13" data-line-number="13">  address_id, activebool, create_date, last_update, active,</a>
<a class="sourceLine" id="cb304-14" data-line-number="14">  <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb304-15" data-line-number="15">)</a>
<a class="sourceLine" id="cb304-16" data-line-number="16"></a>
<a class="sourceLine" id="cb304-17" data-line-number="17"></a>
<a class="sourceLine" id="cb304-18" data-line-number="18"><span class="kw">dbWriteTable</span>(con, <span class="st">&quot;customer&quot;</span>,</a>
<a class="sourceLine" id="cb304-19" data-line-number="19">  <span class="dt">value =</span> df2, <span class="dt">append =</span> <span class="ot">TRUE</span>, <span class="dt">row.names =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb304-20" data-line-number="20">)</a>
<a class="sourceLine" id="cb304-21" data-line-number="21"></a>
<a class="sourceLine" id="cb304-22" data-line-number="22">new_customers &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con</a>
<a class="sourceLine" id="cb304-23" data-line-number="23">                , <span class="st">&quot;select customer_id,store_id,first_name,last_name</span></a>
<a class="sourceLine" id="cb304-24" data-line-number="24"><span class="st">                     from customer where customer_id &gt;= 600;&quot;</span>)</a>
<a class="sourceLine" id="cb304-25" data-line-number="25"><span class="kw">sp_print_df</span>(new_customers)</a></code></pre></div>
<div id="htmlwidget-74434d812ec23342fdce" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-74434d812ec23342fdce">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7"],[600,601,602,603,604,605,606],[3,2,4,5,6,3,4],["Sophie","Sophie","John","Ian","Ed","John","Ian"],["Yang","Yang","Smith","Frantz","Borasky","Smith","Frantz"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>customer_id<\/th>\n      <th>store_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>Confirm that the two new rows, customer_id = { 605, 606} are in the output.</p>
<p>The next two code block show all the rows in the store and staff tables. Notice that neither table has a staff_id or a manager_staff_id = 10. We will attempt to insert such a row in the upcoming code blocks.</p>
<div class="sourceCode" id="cb305"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb305-1" data-line-number="1">stores &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,<span class="st">&quot;select * from store;&quot;</span>)</a>
<a class="sourceLine" id="cb305-2" data-line-number="2"><span class="kw">sp_print_df</span>(stores)</a></code></pre></div>
<div id="htmlwidget-8da54f9f5480ad7c3ec3" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-8da54f9f5480ad7c3ec3">{"x":{"filter":"none","data":[["1","2"],[1,2],[1,2],[1,2],["2006-02-15T17:57:12Z","2006-02-15T17:57:12Z"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>store_id<\/th>\n      <th>manager_staff_id<\/th>\n      <th>address_id<\/th>\n      <th>last_update<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb306"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb306-1" data-line-number="1">staff  &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con</a>
<a class="sourceLine" id="cb306-2" data-line-number="2">            ,<span class="st">&quot;select staff_id, first_name, last_name, address_id, email, store_id</span></a>
<a class="sourceLine" id="cb306-3" data-line-number="3"><span class="st">                from staff;&quot;</span>)</a>
<a class="sourceLine" id="cb306-4" data-line-number="4"><span class="kw">sp_print_df</span>(staff)</a></code></pre></div>
<div id="htmlwidget-124fb78127817ec02cd9" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-124fb78127817ec02cd9">{"x":{"filter":"none","data":[["1","2"],[1,2],["Mike","Jon"],["Hillyer","Stephens"],[3,4],["Mike.Hillyer@sakilastaff.com","Jon.Stephens@sakilastaff.com"],[1,2]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>staff_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>address_id<\/th>\n      <th>email<\/th>\n      <th>store_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,4,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="creating-a-messy-store-row-1" class="section level3">
<h3><span class="header-section-number">13.4.2</span> Creating a Messy Store Row</h3>
<p>A new store row is needed to illustrate a right outer join in a future code block. However, one cannot insert/update a row into the <code>store</code> table with a manager_staff_id = 10 because of a foreign key constraint on the manager_staff_id column.</p>
<p>The manager_staff_id value must satisfy two conditions before the database will allow the new store row to be inserted into the table when the table constraints are enabled.:</p>
<ol style="list-style-type: decimal">
<li>The manager_staff_id must be unique when inserted into the store table.</li>
<li>The manager_staff_id must match a <code>staff</code> table staff_id value.</li>
</ol>
<p>Next we show both error messages:</p>
<ol style="list-style-type: decimal">
<li>The next code block attempts to insert a new store, <code>store_id = 10</code>, with manager_staff_id = 1, but fails with a unique constraint error message. The manager_staff_id = 1 already exists in the store table.</li>
</ol>
<div class="sourceCode" id="cb307"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb307-1" data-line-number="1"><span class="kw">dbExecute</span>(con, <span class="st">&quot;</span></a>
<a class="sourceLine" id="cb307-2" data-line-number="2"><span class="st">do $$</span></a>
<a class="sourceLine" id="cb307-3" data-line-number="3"><span class="st">DECLARE v_manager_staff_id INTEGER;</span></a>
<a class="sourceLine" id="cb307-4" data-line-number="4"><span class="st">begin</span></a>
<a class="sourceLine" id="cb307-5" data-line-number="5"><span class="st">    v_manager_staff_id = 1;</span></a>
<a class="sourceLine" id="cb307-6" data-line-number="6"><span class="st">    insert into store (store_id,manager_staff_id,address_id,last_update)</span></a>
<a class="sourceLine" id="cb307-7" data-line-number="7"><span class="st">         values (10,v_manager_staff_id,10,now()::date);</span></a>
<a class="sourceLine" id="cb307-8" data-line-number="8"><span class="st">exception</span></a>
<a class="sourceLine" id="cb307-9" data-line-number="9"><span class="st">when foreign_key_violation then</span></a>
<a class="sourceLine" id="cb307-10" data-line-number="10"><span class="st">    raise notice &#39;SQLERRM = %, manager_staff_id = %&#39;, SQLERRM, v_manager_staff_id;</span></a>
<a class="sourceLine" id="cb307-11" data-line-number="11"><span class="st">when others then</span></a>
<a class="sourceLine" id="cb307-12" data-line-number="12"><span class="st">    raise notice &#39;SQLERRM = % SQLSTATE =%&#39;, SQLERRM, SQLSTATE;</span></a>
<a class="sourceLine" id="cb307-13" data-line-number="13"><span class="st">end;</span></a>
<a class="sourceLine" id="cb307-14" data-line-number="14"><span class="st">$$ language &#39;plpgsql&#39;;&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<pre><code>Error in result_create(conn@ptr, statement) : Failed to prepare query: server closed the connection unexpectedly This probably means the server terminated abnormally before or while processing the request.</code></pre>
<p>The number above should be 0 and indicates no row was inserted.</p>
<ol start="2" style="list-style-type: decimal">
<li>The next code block attempts to insert a new store, <code>store_id = 10</code>, with manager_staff_id = 10, but fails with a foreign key constraint error message because there does not exist a staff table row with staff_id = 10.</li>
</ol>
<div class="sourceCode" id="cb310"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb310-1" data-line-number="1"><span class="kw">dbExecute</span>(con, <span class="st">&quot;</span></a>
<a class="sourceLine" id="cb310-2" data-line-number="2"><span class="st">do $$</span></a>
<a class="sourceLine" id="cb310-3" data-line-number="3"><span class="st">DECLARE v_manager_staff_id INTEGER;</span></a>
<a class="sourceLine" id="cb310-4" data-line-number="4"><span class="st">begin</span></a>
<a class="sourceLine" id="cb310-5" data-line-number="5"><span class="st">    v_manager_staff_id = 10;</span></a>
<a class="sourceLine" id="cb310-6" data-line-number="6"><span class="st">    insert into store (store_id,manager_staff_id,address_id,last_update)</span></a>
<a class="sourceLine" id="cb310-7" data-line-number="7"><span class="st">         values (10,v_manager_staff_id,10,now()::date);</span></a>
<a class="sourceLine" id="cb310-8" data-line-number="8"><span class="st">exception</span></a>
<a class="sourceLine" id="cb310-9" data-line-number="9"><span class="st">when foreign_key_violation then</span></a>
<a class="sourceLine" id="cb310-10" data-line-number="10"><span class="st">    raise notice &#39;SQLERRM = %, manager_staff_id = %&#39;, SQLERRM, v_manager_staff_id;</span></a>
<a class="sourceLine" id="cb310-11" data-line-number="11"><span class="st">when others then</span></a>
<a class="sourceLine" id="cb310-12" data-line-number="12"><span class="st">    raise notice &#39;SQLERRM = % SQLSTATE =%&#39;, SQLERRM, SQLSTATE;</span></a>
<a class="sourceLine" id="cb310-13" data-line-number="13"><span class="st">end;</span></a>
<a class="sourceLine" id="cb310-14" data-line-number="14"><span class="st">$$ language &#39;plpgsql&#39;;&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<pre><code>NOTICE:  SQLERRM = insert or update on table &quot;store&quot; violates foreign key constraint &quot;store_manager_staff_id_fkey&quot;, manager_staff_id = 10
CONTEXT:  PL/pgSQL function inline_code_block line 9 at RAISE</code></pre>
<p>Again, the number above should be 0 and indicates no row was inserted.</p>
<p>The following three code blocks</p>
<ol style="list-style-type: decimal">
<li>disables all the database constraints on the <code>store</code> table</li>
<li>Inserts the store row with store_id = 10 via a dataframe.</li>
<li>Re-enabes the database constraints on the store table</li>
</ol>
<div class="sourceCode" id="cb313"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb313-1" data-line-number="1"><span class="co">#</span></a>
<a class="sourceLine" id="cb313-2" data-line-number="2"><span class="kw">dbExecute</span>(con, <span class="st">&quot;ALTER TABLE store DISABLE TRIGGER ALL;&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb315"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb315-1" data-line-number="1">df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</a>
<a class="sourceLine" id="cb315-2" data-line-number="2">    <span class="dt">store_id =</span> <span class="dv">10</span></a>
<a class="sourceLine" id="cb315-3" data-line-number="3">  , <span class="dt">manager_staff_id =</span> <span class="dv">10</span></a>
<a class="sourceLine" id="cb315-4" data-line-number="4">  , <span class="dt">address_id =</span> <span class="dv">10</span></a>
<a class="sourceLine" id="cb315-5" data-line-number="5">  , <span class="dt">last_update =</span> <span class="kw">Sys.time</span>()</a>
<a class="sourceLine" id="cb315-6" data-line-number="6">)</a>
<a class="sourceLine" id="cb315-7" data-line-number="7"><span class="kw">dbWriteTable</span>(con, <span class="st">&quot;store&quot;</span>, <span class="dt">value =</span> df, <span class="dt">append =</span> <span class="ot">TRUE</span>, <span class="dt">row.names =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<div class="sourceCode" id="cb316"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb316-1" data-line-number="1"><span class="kw">dbExecute</span>(con, <span class="st">&quot;ALTER TABLE store ENABLE TRIGGER ALL;&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<p>The zeros after the dbExecute code blocks indicate that the dbExecute calls did not alter any rows on the table.</p>
<p>In the next code block we confirm our new row, store_id = 10, was actually inserted.</p>
<div class="sourceCode" id="cb318"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb318-1" data-line-number="1">stores &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,<span class="st">&quot;select * from store;&quot;</span>)</a>
<a class="sourceLine" id="cb318-2" data-line-number="2"><span class="kw">sp_print_df</span>(stores)</a></code></pre></div>
<div id="htmlwidget-dd0a51033db44e820d90" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-dd0a51033db44e820d90">{"x":{"filter":"none","data":[["1","2","3"],[1,2,10],[1,2,10],[1,2,10],["2006-02-15T17:57:12Z","2006-02-15T17:57:12Z","2019-03-04T02:21:34Z"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>store_id<\/th>\n      <th>manager_staff_id<\/th>\n      <th>address_id<\/th>\n      <th>last_update<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="create-a-film-record" class="section level2">
<h2><span class="header-section-number">13.5</span> Create a film record</h2>
<div class="sourceCode" id="cb319"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb319-1" data-line-number="1"><span class="kw">dbExecute</span>(</a>
<a class="sourceLine" id="cb319-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb319-3" data-line-number="3">  <span class="st">&quot;insert into film</span></a>
<a class="sourceLine" id="cb319-4" data-line-number="4"><span class="st">  (film_id,title,description,release_year,language_id</span></a>
<a class="sourceLine" id="cb319-5" data-line-number="5"><span class="st">  ,rental_duration,rental_rate,length,replacement_cost,rating</span></a>
<a class="sourceLine" id="cb319-6" data-line-number="6"><span class="st">   ,last_update,special_features,fulltext)</span></a>
<a class="sourceLine" id="cb319-7" data-line-number="7"><span class="st">  values(1001,&#39;Sophie&#39;&#39;s Choice&#39;,&#39;orphaned language_id=10&#39;,2018,1</span></a>
<a class="sourceLine" id="cb319-8" data-line-number="8"><span class="st">        ,7,4.99,120,14.99,&#39;PG&#39;</span></a>
<a class="sourceLine" id="cb319-9" data-line-number="9"><span class="st">        ,now()::date,&#39;{Trailers}&#39;,&#39;&#39;)</span></a>
<a class="sourceLine" id="cb319-10" data-line-number="10"><span class="st">        ,(1002,&#39;Sophie&#39;&#39;s Choice&#39;,&#39;orphaned language_id=10&#39;,2018,1</span></a>
<a class="sourceLine" id="cb319-11" data-line-number="11"><span class="st">        ,7,4.99,120,14.99,&#39;PG&#39;</span></a>
<a class="sourceLine" id="cb319-12" data-line-number="12"><span class="st">        ,now()::date,&#39;{Trailers}&#39;,&#39;&#39;)</span></a>
<a class="sourceLine" id="cb319-13" data-line-number="13"><span class="st">  ;</span></a>
<a class="sourceLine" id="cb319-14" data-line-number="14"><span class="st">  &quot;</span>)</a></code></pre></div>
<pre><code>## [1] 2</code></pre>
<div class="sourceCode" id="cb321"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb321-1" data-line-number="1"><span class="kw">dbExecute</span>(</a>
<a class="sourceLine" id="cb321-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb321-3" data-line-number="3">  <span class="st">&quot;insert into film_category</span></a>
<a class="sourceLine" id="cb321-4" data-line-number="4"><span class="st">  (film_id,category_id,last_update)</span></a>
<a class="sourceLine" id="cb321-5" data-line-number="5"><span class="st">  values(1001,6,now()::date)</span></a>
<a class="sourceLine" id="cb321-6" data-line-number="6"><span class="st">       ,(1001,7,now()::date)</span></a>
<a class="sourceLine" id="cb321-7" data-line-number="7"><span class="st">       ,(1002,6,now()::date)</span></a>
<a class="sourceLine" id="cb321-8" data-line-number="8"><span class="st">       ,(1002,7,now()::date)</span></a>
<a class="sourceLine" id="cb321-9" data-line-number="9"><span class="st">  ;&quot;</span>)  </a></code></pre></div>
<pre><code>## [1] 4</code></pre>
<div class="sourceCode" id="cb323"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb323-1" data-line-number="1"><span class="kw">dbExecute</span>(</a>
<a class="sourceLine" id="cb323-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb323-3" data-line-number="3">  <span class="st">&quot;insert into inventory</span></a>
<a class="sourceLine" id="cb323-4" data-line-number="4"><span class="st">  (inventory_id,film_id,store_id,last_update)</span></a>
<a class="sourceLine" id="cb323-5" data-line-number="5"><span class="st">  values(4582,1001,1,now()::date)</span></a>
<a class="sourceLine" id="cb323-6" data-line-number="6"><span class="st">       ,(4583,1001,2,now()::date)</span></a>
<a class="sourceLine" id="cb323-7" data-line-number="7"><span class="st">  ;&quot;</span>)  </a></code></pre></div>
<pre><code>## [1] 2</code></pre>
<div class="sourceCode" id="cb325"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb325-1" data-line-number="1"><span class="kw">dbExecute</span>(</a>
<a class="sourceLine" id="cb325-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb325-3" data-line-number="3">  <span class="st">&quot;insert into rental</span></a>
<a class="sourceLine" id="cb325-4" data-line-number="4"><span class="st">  (rental_id,rental_date,inventory_id,customer_id,return_date,staff_id,last_update)</span></a>
<a class="sourceLine" id="cb325-5" data-line-number="5"><span class="st">  values(16050,now()::date - interval &#39;1 week&#39;,4582,600,now()::date,1,now()::date)</span></a>
<a class="sourceLine" id="cb325-6" data-line-number="6"><span class="st">  ;&quot;</span>)  </a></code></pre></div>
<pre><code>## [1] 1</code></pre>
<!--

## Creating Duplicate Customer Rows 

In the next section we create a new table, `smy_customer`.  We will load all customers with customer_id > 594 twice.  The `smy_customer` table will be used in the dplyr semi-join section. 


```r
dbExecute(con,"drop table if exists smy_customer;")
```

```
## [1] 0
```

```r
dbExecute(con,"create table smy_customer 
    as select * 
         from customer  
        where customer_id > 594;")
```

```
## [1] 12
```

```r
dbExecute(con,"insert into smy_customer 
               select * 
                 from customer  
                where customer_id > 594;")
```

```
## [1] 12
```

```r
smy_cust_dupes <- dbGetQuery(con,'select * 
                                    from smy_customer 
                                  order by customer_id')

sp_print_df(smy_cust_dupes)
```

<div id="htmlwidget-1fe403c81784621152ab" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1fe403c81784621152ab">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24"],[595,595,596,596,597,597,598,598,599,599,600,600,601,601,602,602,603,603,604,604,605,605,606,606],[1,1,1,1,1,1,1,1,2,2,3,3,2,2,4,4,5,5,6,6,3,3,4,4],["Terrence","Terrence","Enrique","Enrique","Freddie","Freddie","Wade","Wade","Austin","Austin","Sophie","Sophie","Sophie","Sophie","John","John","Ian","Ian","Ed","Ed","John","John","Ian","Ian"],["Gunderson","Gunderson","Forsythe","Forsythe","Duggan","Duggan","Delvalle","Delvalle","Cintron","Cintron","Yang","Yang","Yang","Yang","Smith","Smith","Frantz","Frantz","Borasky","Borasky","Smith","Smith","Frantz","Frantz"],["terrence.gunderson@sakilacustomer.org","terrence.gunderson@sakilacustomer.org","enrique.forsythe@sakilacustomer.org","enrique.forsythe@sakilacustomer.org","freddie.duggan@sakilacustomer.org","freddie.duggan@sakilacustomer.org","wade.delvalle@sakilacustomer.org","wade.delvalle@sakilacustomer.org","austin.cintron@sakilacustomer.org","austin.cintron@sakilacustomer.org","sophie.yang@sakilacustomer.org","sophie.yang@sakilacustomer.org","sophie.yang@sakilacustomer.org","sophie.yang@sakilacustomer.org","john.smith@sakilacustomer.org","john.smith@sakilacustomer.org","ian.frantz@sakilacustomer.org","ian.frantz@sakilacustomer.org","ed.borasky@sakilacustomer.org","ed.borasky@sakilacustomer.org","john.smith@sakilacustomer.org","john.smith@sakilacustomer.org","ian.frantz@sakilacustomer.org","ian.frantz@sakilacustomer.org"],[601,601,602,602,603,603,604,604,605,605,1,1,1,1,2,2,3,3,4,4,3,3,4,4],[true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true],["2006-02-14","2006-02-14","2006-02-14","2006-02-14","2006-02-14","2006-02-14","2006-02-14","2006-02-14","2006-02-14","2006-02-14","2019-03-04","2019-03-04","2019-03-03","2019-03-03","2019-03-04","2019-03-04","2019-03-04","2019-03-04","2019-03-04","2019-03-04","2019-03-03","2019-03-03","2019-03-03","2019-03-03"],["2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2019-03-04T08:00:00Z","2019-03-04T08:00:00Z","2019-03-04T02:21:34Z","2019-03-04T02:21:34Z","2019-03-04T08:00:00Z","2019-03-04T08:00:00Z","2019-03-04T08:00:00Z","2019-03-04T08:00:00Z","2019-03-04T08:00:00Z","2019-03-04T08:00:00Z","2019-03-04T02:21:34Z","2019-03-04T02:21:34Z","2019-03-04T02:21:34Z","2019-03-04T02:21:34Z"],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>customer_id<\/th>\n      <th>store_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>email<\/th>\n      <th>address_id<\/th>\n      <th>activebool<\/th>\n      <th>create_date<\/th>\n      <th>last_update<\/th>\n      <th>active<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,6,10]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
-->
<p>Diconnect from the db:</p>
<div class="sourceCode" id="cb327"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb327-1" data-line-number="1"> <span class="kw">dbDisconnect</span>(con)</a>
<a class="sourceLine" id="cb327-2" data-line-number="2"></a>
<a class="sourceLine" id="cb327-3" data-line-number="3"> <span class="kw">sp_docker_stop</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="cb328"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb328-1" data-line-number="1">knitr<span class="op">::</span><span class="kw">knit_exit</span>()</a></code></pre></div>
<!--chapter:end:130-sql-dplyr-joins-data.Rmd-->
</div>
</div>
<div id="chapter_sql-dplyr-joins" class="section level1">
<h1><span class="header-section-number">14</span> SQL &amp; dplyr joins</h1>
<blockquote>
<p>This chapter demonstrates how to:</p>
<ul>
<li>Use primary and foreign keys to retrieve specific rows of a table</li>
<li>do different kinds of join queries</li>
<li>Exercises</li>
<li>Query the database to get basic information about each dvdrental story</li>
<li>How to interact with the database using different strategies</li>
</ul>
</blockquote>
<p>Verify Docker is up and running:</p>
<div class="sourceCode" id="cb329"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb329-1" data-line-number="1"><span class="kw">sp_check_that_docker_is_up</span>()</a></code></pre></div>
<pre><code>## [1] &quot;Docker is up but running no containers&quot;</code></pre>
<p>Verify pet DB is available, it may be stopped.</p>
<div class="sourceCode" id="cb331"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb331-1" data-line-number="1"><span class="kw">sp_show_all_docker_containers</span>()</a></code></pre></div>
<pre><code>## CONTAINER ID        IMAGE                COMMAND                  CREATED             STATUS                     PORTS               NAMES
## ce3accea3583        postgres-dvdrental   &quot;docker-entrypoint.s…&quot;   41 seconds ago      Exited (0) 2 seconds ago                       sql-pet</code></pre>
<p>Start up the <code>docker-pet</code> container</p>
<div class="sourceCode" id="cb333"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb333-1" data-line-number="1"><span class="kw">sp_docker_start</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<p>Now connect to the database with R</p>
<div class="sourceCode" id="cb334"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb334-1" data-line-number="1"><span class="co"># need to wait for Docker &amp; Postgres to come up before connecting.</span></a>
<a class="sourceLine" id="cb334-2" data-line-number="2"></a>
<a class="sourceLine" id="cb334-3" data-line-number="3">con &lt;-<span class="st"> </span><span class="kw">sp_get_postgres_connection</span>(</a>
<a class="sourceLine" id="cb334-4" data-line-number="4">  <span class="dt">user =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_USER_NAME&quot;</span>),</a>
<a class="sourceLine" id="cb334-5" data-line-number="5">  <span class="dt">password =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_PASSWORD&quot;</span>),</a>
<a class="sourceLine" id="cb334-6" data-line-number="6">  <span class="dt">dbname =</span> <span class="st">&quot;dvdrental&quot;</span>,</a>
<a class="sourceLine" id="cb334-7" data-line-number="7">  <span class="dt">seconds_to_test =</span> <span class="dv">30</span></a>
<a class="sourceLine" id="cb334-8" data-line-number="8">)</a></code></pre></div>
<div class="sourceCode" id="cb335"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb335-1" data-line-number="1"><span class="kw">source</span>(<span class="dt">file=</span><span class="kw">here</span>(<span class="st">&#39;book-src/sql_pet_data.R&#39;</span>),<span class="dt">echo=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb335-2" data-line-number="2"><span class="co">## </span></a>
<a class="sourceLine" id="cb335-3" data-line-number="3"><span class="co">## &gt; dbExecute(con, &quot;delete from film_category where film_id &gt;= 1001;&quot;)</span></a>
<a class="sourceLine" id="cb335-4" data-line-number="4"><span class="co">## [1] 4</span></a>
<a class="sourceLine" id="cb335-5" data-line-number="5"><span class="co">## </span></a>
<a class="sourceLine" id="cb335-6" data-line-number="6"><span class="co">## &gt; dbExecute(con, &quot;delete from rental where rental_id &gt;= 16050;&quot;)</span></a>
<a class="sourceLine" id="cb335-7" data-line-number="7"><span class="co">## [1] 1</span></a>
<a class="sourceLine" id="cb335-8" data-line-number="8"><span class="co">## </span></a>
<a class="sourceLine" id="cb335-9" data-line-number="9"><span class="co">## &gt; dbExecute(con, &quot;delete from inventory where film_id &gt;= 1001;&quot;)</span></a>
<a class="sourceLine" id="cb335-10" data-line-number="10"><span class="co">## [1] 2</span></a>
<a class="sourceLine" id="cb335-11" data-line-number="11"><span class="co">## </span></a>
<a class="sourceLine" id="cb335-12" data-line-number="12"><span class="co">## &gt; dbExecute(con, &quot;delete from film where film_id &gt;= 1001;&quot;)</span></a>
<a class="sourceLine" id="cb335-13" data-line-number="13"><span class="co">## [1] 2</span></a>
<a class="sourceLine" id="cb335-14" data-line-number="14"><span class="co">## </span></a>
<a class="sourceLine" id="cb335-15" data-line-number="15"><span class="co">## &gt; dbExecute(con, &quot;delete from customer where customer_id &gt;= 600;&quot;)</span></a>
<a class="sourceLine" id="cb335-16" data-line-number="16"><span class="co">## [1] 7</span></a>
<a class="sourceLine" id="cb335-17" data-line-number="17"><span class="co">## </span></a>
<a class="sourceLine" id="cb335-18" data-line-number="18"><span class="co">## &gt; dbExecute(con, &quot;delete from store where store_id &gt; 2;&quot;)</span></a>
<a class="sourceLine" id="cb335-19" data-line-number="19"><span class="co">## [1] 1</span></a>
<a class="sourceLine" id="cb335-20" data-line-number="20"><span class="co">## </span></a>
<a class="sourceLine" id="cb335-21" data-line-number="21"><span class="co">## &gt; dbExecute(con, &quot;insert into customer\n  (customer_id,store_id,first_name,last_name,email,address_id,activebool\n  ,create_date,last_update,active)\n ...&quot; ... [TRUNCATED] </span></a>
<a class="sourceLine" id="cb335-22" data-line-number="22"><span class="co">## [1] 5</span></a>
<a class="sourceLine" id="cb335-23" data-line-number="23"><span class="co">## </span></a>
<a class="sourceLine" id="cb335-24" data-line-number="24"><span class="co">## &gt; dbExecute(con, &quot;ALTER TABLE store DISABLE TRIGGER ALL;&quot;)</span></a>
<a class="sourceLine" id="cb335-25" data-line-number="25"><span class="co">## [1] 0</span></a>
<a class="sourceLine" id="cb335-26" data-line-number="26"><span class="co">## </span></a>
<a class="sourceLine" id="cb335-27" data-line-number="27"><span class="co">## &gt; df &lt;- data.frame(store_id = 10, manager_staff_id = 10, </span></a>
<a class="sourceLine" id="cb335-28" data-line-number="28"><span class="co">## +     address_id = 10, last_update = Sys.time())</span></a>
<a class="sourceLine" id="cb335-29" data-line-number="29"><span class="co">## </span></a>
<a class="sourceLine" id="cb335-30" data-line-number="30"><span class="co">## &gt; dbWriteTable(con, &quot;store&quot;, value = df, append = TRUE, </span></a>
<a class="sourceLine" id="cb335-31" data-line-number="31"><span class="co">## +     row.names = FALSE)</span></a>
<a class="sourceLine" id="cb335-32" data-line-number="32"><span class="co">## </span></a>
<a class="sourceLine" id="cb335-33" data-line-number="33"><span class="co">## &gt; dbExecute(con, &quot;ALTER TABLE store ENABLE TRIGGER ALL;&quot;)</span></a>
<a class="sourceLine" id="cb335-34" data-line-number="34"><span class="co">## [1] 0</span></a>
<a class="sourceLine" id="cb335-35" data-line-number="35"><span class="co">## </span></a>
<a class="sourceLine" id="cb335-36" data-line-number="36"><span class="co">## &gt; dbExecute(con, &quot;insert into film\n  (film_id,title,description,release_year,language_id\n  ,rental_duration,rental_rate,length,replacement_cost,rati ...&quot; ... [TRUNCATED] </span></a>
<a class="sourceLine" id="cb335-37" data-line-number="37"><span class="co">## [1] 1</span></a>
<a class="sourceLine" id="cb335-38" data-line-number="38"><span class="co">## </span></a>
<a class="sourceLine" id="cb335-39" data-line-number="39"><span class="co">## &gt; dbExecute(con, &quot;insert into film_category\n  (film_id,category_id,last_update)\n  values(1001,6,now()::date)\n  ,(1001,7,now()::date)\n  ;&quot;)</span></a>
<a class="sourceLine" id="cb335-40" data-line-number="40"><span class="co">## [1] 2</span></a>
<a class="sourceLine" id="cb335-41" data-line-number="41"><span class="co">## </span></a>
<a class="sourceLine" id="cb335-42" data-line-number="42"><span class="co">## &gt; dbExecute(con, &quot;insert into inventory\n  (inventory_id,film_id,store_id,last_update)\n  values(4582,1001,1,now()::date)\n  ,(4583,1001,2,now()::date ...&quot; ... [TRUNCATED] </span></a>
<a class="sourceLine" id="cb335-43" data-line-number="43"><span class="co">## [1] 2</span></a>
<a class="sourceLine" id="cb335-44" data-line-number="44"><span class="co">## </span></a>
<a class="sourceLine" id="cb335-45" data-line-number="45"><span class="co">## &gt; dbExecute(con, &quot;insert into rental\n  (rental_id,rental_date,inventory_id,customer_id,return_date,staff_id,last_update)\n  values(16050,now()::date  ...&quot; ... [TRUNCATED] </span></a>
<a class="sourceLine" id="cb335-46" data-line-number="46"><span class="co">## [1] 1</span></a></code></pre></div>
<div id="joins" class="section level2">
<h2><span class="header-section-number">14.1</span> Joins</h2>
<p>In section ‘SQL Quick Start Simple Retrieval’, there is a brief discussion of databases and 3NF. One of the goals of normalization is to eliminate redundant data being kept in multiple tables and having each table contain a very granular level of detail. If a record then needs to be updated, it is updated in one table instead of multiple tables improving overall system performance. This also helps simplify and maintain referential integrity between tables.</p>
<p>Normalization breaks data down and JOINs denormalizes the data and builds it back up. The tables are typically related via a primary key - foreign key relationship. The Postgres database enforces the primary and foreign key constraints in the DVD rental database.</p>
<div id="join-types" class="section level3">
<h3><span class="header-section-number">14.1.1</span> Join Types</h3>
<div id="htmlwidget-1d9f9b9fdca3023baa83" style="width:672px;height:480px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-1d9f9b9fdca3023baa83">{"x":{"diagram":"\ndigraph SQL_TYPES {\n\n  # a \"graph\" statement\n  graph [overlap = true, fontsize = 10]\n\n  node [shape = box,\n        fixedsize = false,\n        hegith = 1.5\n        width = 1.50]\n  0[label=\"0.  SQL Joins\"]\n  1[label=\"1.  Inner Join\nL.col1 {<,=,>} R.col2\"]\n  2[label=\"2.  Outer Join\nL.col1=R.col2\"]\n  3[label=\"3.  Self Join\nL.col1=tbl1.col2\"]\n  4[label=\"4.  Cross Join\nL.col1=R.col2\"]\n  5[label=\"5.  Equi Join\nL.col1=R.col2\"] \n  6[label=\"6.  Natural Join\nL.col1=R.col1\"]\n  7[label=\"7.  Left Join\nL.col1=R.col1\"]\n  8[label=\"8.  Right Join\nL.col1=R.col1\"]\n  9[label=\"9.  Full Join\nL.col1=tbl2.col1\"]\n  # several \"edge\" statements\n  0 -> {1,2,3,4} [arrowhead=none]\n  1 -> 5 [arrowhead=none]\n  5 -> 6 [arrowhead=none]\n  2 -> {7,8,9} [arrowhead=none]\n  #3 -> {7,8,9}\n}\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
<p>The diagram above shows the hierarchy of the different types of joins. In the boxes above:</p>
<ul>
<li>The joins are based on a single column from the two tables, the left and right tables. Joins can be based on multiple columns from both tables.</li>
<li>The <code>L.</code> and <code>R.</code> are aliases for the left and right table names.<br />
</li>
<li>Often the joining columns have the same name as in the Natural Join, L.col1 = R.col1</li>
<li>However, the joining column names can be different L.col1 = R.col2.<br />
</li>
<li>All joins are based on equality between the table columns, L.col1 = R.col2, except the inner join which can use non-equality column conditions. Non-equality column conditions are rare. Equa Joins are subset of the Inner Join.</li>
</ul>
<p>For this tutorial, we can think of joins as either an Inner/eqau Join or an Outer Join.</p>
<p>Instead of showing standard Venn diagrams showing the different JOINS, we use an analogy. For those interested though, the typical Venn diagrams can be found <a href="http://www.sql-join.com/sql-join-types/">here</a>.</p>
</div>
<div id="valentines-party" class="section level3">
<h3><span class="header-section-number">14.1.2</span> Valentines Party</h3>
<p>Imagine you are at a large costume Valentine’s Day dance party. The hostess of the party, a data scientist, would like to learn more about the people attending her party. When the band takes a break, she lets everyone know it is time for the judges to evaluate the winners for best costumes and associated prizes.</p>
<div class="figure">
<img src="screenshots/ValentinesDay.PNG" alt="ValentinesDay" />
<p class="caption">ValentinesDay</p>
</div>
<p>She requests the following:</p>
<ol style="list-style-type: decimal">
<li><p>All the couples at the party line up in front of her in a single line with the men on her left and the women on her right, (inner join)</p></li>
<li><p>All the remaining men to form a second line two feet behind the married men, (left outer join, all couples + unattached men)</p></li>
<li><p>All the remaining women to form a third line two feet in front of the married women, (right outer join, all couples + unattached women)</p></li>
</ol>
<p>As our data scientist looks out, she can clearly see the three distinct lines, the single men, the man woman couples, and the single women, a full outer join.</p>
<p>As the three judges start walking down the lines, she makes one more announcement.</p>
<ol start="4" style="list-style-type: decimal">
<li>There is a special prize for the man and woman who can guess the average age of the members of the opposite sex. To give everyone a chance to come up with an average age, she asks the men to stay in line and the women to move down the men’s line in order circling back around until they get back to their starting point in line, (Cartesian join, every man seen by every woman and vice versa).</li>
</ol>
<p>It is hard enough to tell someone’s age when they don’t have a mask, how do you get the average age when people have masks?</p>
<p>The hostess knows that there is usually some data anomalies. As she looks out she sees a small cluster of people who did not line up. Being the hostess with the mostest, she wants to get to know that small cluster better. Since they are far off and in costume, she cannot tell if they are men or women. More importantly, she does not know if they identify as a man or a woman, both – (kind of a stretch for a self join), neither, or something else. Ah, the inquisitive mind wants to know.</p>
</div>
<div id="join-syntax" class="section level3">
<h3><span class="header-section-number">14.1.3</span> Join Syntax</h3>
<p>The table below shows the two R join function call formats, standalone function call and pipe function call and the corresponding SQL join format.</p>
<table>
<colgroup>
<col width="3%" />
<col width="57%" />
<col width="38%" />
</colgroup>
<thead>
<tr class="header">
<th>Join</th>
<th>dplyr</th>
<th>sql</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>inner</td>
<td>inner_join(customer_tbl, rental_tbl, by = ‘customer_id’, suffix = c(“.c”, “.r”))</td>
<td>from customer c join rental r on c.customer_id = r.customer_id</td>
</tr>
<tr class="even">
<td></td>
<td>customer_tbl %&gt;% inner_join(rental_tbl, by = ‘customer_id’, suffix = c(“.c”, “.r”))</td>
<td></td>
</tr>
<tr class="odd">
<td>left</td>
<td>left_join(customer_tbl, rental_tbl, by = ‘customer_id’, suffix = c(“.c”, “.r”))</td>
<td>from customer c left outer join rental r on c.customer_id = r.customer_id</td>
</tr>
<tr class="even">
<td></td>
<td>customer_tbl %&gt;% left_join(rental_tbl, by = ‘customer_id’, suffix = c(“.c”, “.r”))</td>
<td></td>
</tr>
<tr class="odd">
<td>right</td>
<td>right_join(customer_tbl, rental_tbl, by = ‘customer_id’, suffix = c(“.c”, “.r”))</td>
<td>from customer c right outer join rental r on c.customer_id = r.customer_id</td>
</tr>
<tr class="even">
<td></td>
<td>customer_tbl %&gt;% right_join(rental_tbl, by = ‘customer_id’, suffix = c(“.c”, “.r”))</td>
<td></td>
</tr>
<tr class="odd">
<td>full</td>
<td>full_join(customer_tbl, rental_tbl, by = ‘customer_id’, suffix = c(“.c”, “.r”))</td>
<td>from customer c full outer join rental r on c.customer_id = r.customer_id</td>
</tr>
<tr class="even">
<td></td>
<td>customer_tbl %&gt;% full_join(rental_tbl, by = ‘customer_id’, suffix = c(“.c”, “.r”))</td>
<td></td>
</tr>
<tr class="odd">
<td>semi</td>
<td>semi_join(customer_tbl, rental_tbl, by = ‘customer_id’)</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>customer_tbl %&gt;% semi_join(rental_tbl, by = ‘customer_id’)</td>
<td></td>
</tr>
<tr class="odd">
<td>anti</td>
<td>anti_join(customer_tbl, rental_tbl, by = ‘customer_id’)</td>
<td></td>
</tr>
</tbody>
</table>
</div>
<div id="join-tables" class="section level3">
<h3><span class="header-section-number">14.1.4</span> Join Tables</h3>
<p>The dplyr join documentation describes two different types of joins, <code>mutating</code> and <code>filtering</code> joins. For those coming to R with a SQL background, the mutating documentation is misleading in one respect. Here is the inner_join documentation.</p>
<pre><code>    inner_join()
    
    return all rows from x where there are matching values in y, and all columns from x and y. 
    If there are multiple matches between x and y, all combination of the matches are returned.</code></pre>
<p>The misleading part is ‘and all the columns from <em>x</em> and <em>y</em>.’ If the join column is <code>KEY</code>, SQL will return x.KEY and y.KEY. Dplyr returns just KEY, the KEY from the driving table. This is important if you are translating SQL to R because SQL developers will reference both columns x.KEY and y.KEY. One needs to mutate the the y.KEY column. This difference should become clear in the outer join examples.</p>
<p>In the next couple of examples, we will use a small sample of the <code>customer</code> and <code>store</code> table data from the database to illustrate the diffent joins. In the *_join verbs, the <code>by</code> and <code>suffix</code> parameters are included because it helps document the actual join and the source of join columns. If the suffix parameter is excluded, it defaults to .x to refer to the first table and .y for the second table. If the dplyr pipe has many joins, the suffix parameter makes it clearer which table the column came from.</p>
<p>In the next code block, we perform a Cartesian join to illustrate the default suffix behavior. Note that every column that has a suffix of x or y except the key column and that the column values may or may not be the same based on the column name without the suffix. If one has a lot of joins in the piple with tables that have many duplicate column names, it is hard to keep track of the source of the column.</p>
<div class="sourceCode" id="cb337"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb337-1" data-line-number="1">store_table &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbReadTable</span>(con, <span class="st">&quot;store&quot;</span>)</a>
<a class="sourceLine" id="cb337-2" data-line-number="2">store_table<span class="op">$</span>key &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb337-3" data-line-number="3">cartesian_join &lt;-<span class="st"> </span><span class="kw">inner_join</span>(store_table,store_table, <span class="dt">by=</span>(<span class="st">&#39;key&#39;</span>=<span class="st">&#39;key&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb337-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>key,<span class="op">-</span>last_update.x,<span class="op">-</span>last_update.y)</a>
<a class="sourceLine" id="cb337-5" data-line-number="5"><span class="kw">sp_print_df</span>(cartesian_join)</a></code></pre></div>
<div id="htmlwidget-b18b48ec4ad649442f3b" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-b18b48ec4ad649442f3b">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9"],[1,1,1,2,2,2,10,10,10],[1,1,1,2,2,2,10,10,10],[1,1,1,2,2,2,10,10,10],[1,2,10,1,2,10,1,2,10],[1,2,10,1,2,10,1,2,10],[1,2,10,1,2,10,1,2,10]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>store_id.x<\/th>\n      <th>manager_staff_id.x<\/th>\n      <th>address_id.x<\/th>\n      <th>store_id.y<\/th>\n      <th>manager_staff_id.y<\/th>\n      <th>address_id.y<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>The suffix parameter helps distinguish the duplicate column names as shown in next example.</p>
<div class="sourceCode" id="cb338"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb338-1" data-line-number="1">cartesian_join2 &lt;-<span class="st"> </span><span class="kw">inner_join</span>(store_table,store_table, <span class="dt">by=</span>(<span class="st">&#39;key&#39;</span>=<span class="st">&#39;key&#39;</span>)</a>
<a class="sourceLine" id="cb338-2" data-line-number="2">                              , <span class="dt">suffix=</span><span class="kw">c</span>(<span class="st">&#39;.store1&#39;</span>,<span class="st">&#39;.store2&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb338-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>key,<span class="op">-</span>last_update.store1,<span class="op">-</span>last_update.store2)</a>
<a class="sourceLine" id="cb338-4" data-line-number="4">  </a>
<a class="sourceLine" id="cb338-5" data-line-number="5"><span class="kw">sp_print_df</span>(cartesian_join2)</a></code></pre></div>
<div id="htmlwidget-514d280a38cf86ead40b" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-514d280a38cf86ead40b">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9"],[1,1,1,2,2,2,10,10,10],[1,1,1,2,2,2,10,10,10],[1,1,1,2,2,2,10,10,10],[1,2,10,1,2,10,1,2,10],[1,2,10,1,2,10,1,2,10],[1,2,10,1,2,10,1,2,10]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>store_id.store1<\/th>\n      <th>manager_staff_id.store1<\/th>\n      <th>address_id.store1<\/th>\n      <th>store_id.store2<\/th>\n      <th>manager_staff_id.store2<\/th>\n      <th>address_id.store2<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="natural-join-delayed-time-bomb" class="section level2">
<h2><span class="header-section-number">14.2</span> Natural Join Delayed Time Bomb</h2>
<p>The dplyr default join is a natural join, joining tables on common column names. One of many links why one should not use natural joins can be found <a href="http://gplivna.blogspot.com/2007/10/natural-joins-are-evil-motto-if-you.html">here</a>. If two tables are joined via a natural join on column <code>C1</code> the join continues to work as long as no additional common columns are added to either table. If a new new column <code>C2</code> is added to one of the tables and <code>C2</code> already exists in the other table, BOOM, the delayed time bomb goes off. The natural join still executes, doesn’t throw any errors, but the returned result set may be smaller, much smaller, than before the new <code>C2</code> column was added.</p>
<div id="sql-customer-store_id-distribution" class="section level3">
<h3><span class="header-section-number">14.2.1</span> SQL Customer store_id Distribution</h3>
<p>The next code block calculates the <code>store_id</code> distribution in the <code>customer</code> and <code>store</code> tables across all their rows. The results will be used in following sections to validate different join result sets.</p>
<div class="sourceCode" id="cb339"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb339-1" data-line-number="1">store_distribution_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con</a>
<a class="sourceLine" id="cb339-2" data-line-number="2">          ,<span class="st">&quot;select &#39;customer&#39; tbl, store_id,count(*) count </span></a>
<a class="sourceLine" id="cb339-3" data-line-number="3"><span class="st">              from customer group by store_id</span></a>
<a class="sourceLine" id="cb339-4" data-line-number="4"><span class="st">            union</span></a>
<a class="sourceLine" id="cb339-5" data-line-number="5"><span class="st">            select &#39;store&#39; tbl,store_id,count(*) count </span></a>
<a class="sourceLine" id="cb339-6" data-line-number="6"><span class="st">              from store group by store_id</span></a>
<a class="sourceLine" id="cb339-7" data-line-number="7"><span class="st">            order by tbl,store_id;&quot;</span></a>
<a class="sourceLine" id="cb339-8" data-line-number="8">          )</a>
<a class="sourceLine" id="cb339-9" data-line-number="9"><span class="kw">sp_print_df</span>(store_distribution_sql)</a></code></pre></div>
<div id="htmlwidget-74434d812ec23342fdce" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-74434d812ec23342fdce">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9"],["customer","customer","customer","customer","customer","customer","store","store","store"],[1,2,3,4,5,6,1,2,10],[326,274,1,1,1,1,1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>tbl<\/th>\n      <th>store_id<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="sample-customer-and-store-join-data" class="section level3">
<h3><span class="header-section-number">14.2.2</span> Sample Customer and Store Join Data</h3>
<p>The following code block extracts sample customer and the store data. The customer data is restricted to 10 rows to illustrate the different joins. The 10 rows are used in the detail examples in order to perform a sanity check that the join is actually working. Each detail example is followed by an aggregated summary across all rows of <code>customer</code> and <code>store</code> table.</p>
<div class="sourceCode" id="cb340"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb340-1" data-line-number="1">sample_customers &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,<span class="st">&quot;select customer_id,first_name,last_name,store_id</span></a>
<a class="sourceLine" id="cb340-2" data-line-number="2"><span class="st">                                      from customer </span></a>
<a class="sourceLine" id="cb340-3" data-line-number="3"><span class="st">                                     where customer_id between 595 and 604&quot;</span>)</a>
<a class="sourceLine" id="cb340-4" data-line-number="4">stores &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,<span class="st">&quot;select * from store;&quot;</span>)</a>
<a class="sourceLine" id="cb340-5" data-line-number="5"><span class="kw">sp_print_df</span>(sample_customers)</a></code></pre></div>
<div id="htmlwidget-8da54f9f5480ad7c3ec3" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-8da54f9f5480ad7c3ec3">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10"],[595,596,597,598,599,600,601,602,603,604],["Terrence","Enrique","Freddie","Wade","Austin","Sophie","Sophie","John","Ian","Ed"],["Gunderson","Forsythe","Duggan","Delvalle","Cintron","Yang","Yang","Smith","Frantz","Borasky"],[1,1,1,1,2,3,2,4,5,6]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>customer_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>store_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb341"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb341-1" data-line-number="1"><span class="kw">sp_print_df</span>(stores)</a></code></pre></div>
<div id="htmlwidget-124fb78127817ec02cd9" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-124fb78127817ec02cd9">{"x":{"filter":"none","data":[["1","2","3"],[1,2,10],[1,2,10],[1,2,10],["2006-02-15T17:57:12Z","2006-02-15T17:57:12Z","2019-03-04T02:21:39Z"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>store_id<\/th>\n      <th>manager_staff_id<\/th>\n      <th>address_id<\/th>\n      <th>last_update<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="dplyr-store_id-distribution-exercise" class="section level3">
<h3><span class="header-section-number">14.2.3</span> dplyr store_id distribution Exercise</h3>
<p>Execute and Review the output from the code block below. Union and arrange the output to match the SQL output in the previous code block.</p>
<div class="sourceCode" id="cb342"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb342-1" data-line-number="1">customer_table &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbReadTable</span>(con, <span class="st">&quot;customer&quot;</span>)</a>
<a class="sourceLine" id="cb342-2" data-line-number="2">store_table &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbReadTable</span>(con, <span class="st">&quot;store&quot;</span>)</a>
<a class="sourceLine" id="cb342-3" data-line-number="3"></a>
<a class="sourceLine" id="cb342-4" data-line-number="4">customer_summary &lt;-<span class="st"> </span>customer_table <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb342-5" data-line-number="5"><span class="st">  </span><span class="kw">group_by</span>(store_id) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb342-6" data-line-number="6"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">count=</span><span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb342-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">table=</span><span class="st">&#39;customer&#39;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb342-8" data-line-number="8"><span class="st">  </span><span class="kw">select</span>(table,store_id,count)</a>
<a class="sourceLine" id="cb342-9" data-line-number="9"></a>
<a class="sourceLine" id="cb342-10" data-line-number="10">store_summary &lt;-<span class="st"> </span>store_table <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb342-11" data-line-number="11"><span class="st">  </span><span class="kw">group_by</span>(store_id) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb342-12" data-line-number="12"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">count=</span><span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb342-13" data-line-number="13"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">table=</span><span class="st">&#39;store&#39;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb342-14" data-line-number="14"><span class="st">  </span><span class="kw">select</span>(table,store_id,count)</a>
<a class="sourceLine" id="cb342-15" data-line-number="15"></a>
<a class="sourceLine" id="cb342-16" data-line-number="16"><span class="kw">sp_print_df</span>(customer_summary)</a></code></pre></div>
<div id="htmlwidget-dd0a51033db44e820d90" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-dd0a51033db44e820d90">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],["customer","customer","customer","customer","customer","customer"],[1,2,3,4,5,6],[326,274,1,1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>table<\/th>\n      <th>store_id<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb343"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb343-1" data-line-number="1"><span class="kw">sp_print_df</span>(store_summary)</a></code></pre></div>
<div id="htmlwidget-1fe403c81784621152ab" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1fe403c81784621152ab">{"x":{"filter":"none","data":[["1","2","3"],["store","store","store"],[1,2,10],[1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>table<\/th>\n      <th>store_id<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb344"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb344-1" data-line-number="1"><span class="co">## UNION the two summary tables and ARRANGE the output to match the SQL output from the previouse code block</span></a></code></pre></div>
</div>
</div>
<div id="join-templates" class="section level2">
<h2><span class="header-section-number">14.3</span> Join Templates</h2>
<p>In this section we perform various joins using dplyr and SQL. Each dplyr code block has three purposes.</p>
<ol style="list-style-type: decimal">
<li>Show working detail/summary data join examples.<br />
</li>
<li>The code blocks can be used as templates for beginning more complex dplyr pipes.</li>
<li>The code blocks show the number of joins performed.</li>
</ol>
<p>In these examples the ‘customer’ is always the left table and ‘store’ is always the right table. The join condition shown in the <code>by</code> parameter</p>
<pre><code>by = c(&#39;store_id&#39;=&#39;store_id&#39;)</code></pre>
<p>is on the common foreign - primary key column store_id. This is technically an equi-join condition which makes our joins 1-to-1 and keeps the result set small.</p>
<pre><code>In multi-column joins, each language_id would be replaced with a vector of column names used in the join by position.  Note the column names do not need to be identical by position.</code></pre>
<p>The suffix parameter is a way to distinguish the same column name in the joined tables. The suffixes are usually an single letter to represent the name of the table.</p>
</div>
<div id="inner-joins" class="section level2">
<h2><span class="header-section-number">14.4</span> Inner Joins</h2>
<div id="example_140_inner-join-details-sql" class="section level3">
<h3><span class="header-section-number">14.4.1</span> SQL Inner Join Details</h3>
<p>For an inner join between two tables, it doesn’t matter which table is on the left, the first table, and which is on the right, the second table, because join conditions on both tables must be satisfied. Reviewing the table below shows the inner join on our 10 sample customers and 3 store records returned only 6 rows. The inner join detail shows only rows with matching store_id’s.</p>
<div class="sourceCode" id="cb347"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb347-1" data-line-number="1">customer_store_details_sij &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb347-2" data-line-number="2"><span class="st">&quot;select &#39;ij&#39; join_type,customer_id,first_name,last_name,c.store_id c_store_id</span></a>
<a class="sourceLine" id="cb347-3" data-line-number="3"><span class="st">       ,s.store_id s_store_id,s.manager_staff_id, s.address_id</span></a>
<a class="sourceLine" id="cb347-4" data-line-number="4"><span class="st">   from customer c join store s on c.store_id = s.store_id </span></a>
<a class="sourceLine" id="cb347-5" data-line-number="5"><span class="st">  where customer_id between 595 and 604;&quot;</span>)</a>
<a class="sourceLine" id="cb347-6" data-line-number="6"><span class="kw">sp_print_df</span>(customer_store_details_sij)</a></code></pre></div>
<div id="htmlwidget-ed78248b32e6634f28e5" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-ed78248b32e6634f28e5">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],["ij","ij","ij","ij","ij","ij"],[595,596,597,598,599,601],["Terrence","Enrique","Freddie","Wade","Austin","Sophie"],["Gunderson","Forsythe","Duggan","Delvalle","Cintron","Yang"],[1,1,1,1,2,2],[1,1,1,1,2,2],[1,1,1,1,2,2],[1,1,1,1,2,2]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>join_type<\/th>\n      <th>customer_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>c_store_id<\/th>\n      <th>s_store_id<\/th>\n      <th>manager_staff_id<\/th>\n      <th>address_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,5,6,7,8]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="example_140_inner-join-details-dplyr" class="section level3">
<h3><span class="header-section-number">14.4.2</span> Dplyr Inner Join Details</h3>
<div class="sourceCode" id="cb348"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb348-1" data-line-number="1">customer_ij &lt;-<span class="st"> </span>customer_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb348-2" data-line-number="2"><span class="st">  </span><span class="kw">inner_join</span>(store_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;store_id&quot;</span> =<span class="st"> &quot;store_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.c&quot;</span>, <span class="st">&quot;.s&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb348-3" data-line-number="3"><span class="st">    </span><span class="kw">filter</span>(customer_id <span class="op">&gt;=</span><span class="st"> </span><span class="dv">595</span> <span class="op">&amp;</span><span class="st"> </span>customer_id <span class="op">&lt;=</span><span class="st"> </span><span class="dv">604</span> ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb348-4" data-line-number="4"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">join_type =</span> <span class="st">&#39;ij&#39;</span></a>
<a class="sourceLine" id="cb348-5" data-line-number="5">          ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb348-6" data-line-number="6"><span class="st">    </span><span class="kw">rename</span>(<span class="dt">s_address_id =</span> address_id.y) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb348-7" data-line-number="7"><span class="st">    </span><span class="kw">select</span>(join_type,customer_id,first_name,last_name,store_id </a>
<a class="sourceLine" id="cb348-8" data-line-number="8">       ,store_id,manager_staff_id, s_address_id) </a>
<a class="sourceLine" id="cb348-9" data-line-number="9"><span class="kw">sp_print_df</span>(customer_ij)</a></code></pre></div>
<div id="htmlwidget-2ae622211a824c064fbd" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-2ae622211a824c064fbd">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],["ij","ij","ij","ij","ij","ij"],[595,596,597,598,599,601],["Terrence","Enrique","Freddie","Wade","Austin","Sophie"],["Gunderson","Forsythe","Duggan","Delvalle","Cintron","Yang"],[1,1,1,1,2,2],[1,1,1,1,2,2],[1,1,1,1,2,2]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>join_type<\/th>\n      <th>customer_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>store_id<\/th>\n      <th>manager_staff_id<\/th>\n      <th>s_address_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,5,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>Compare the output from the SQL and Dplyr version. The SQL output has a <code>c_store_id</code> and a <code>s_store_id</code> column and the Dplyr output only has <code>store_id</code>. In this case, because it is an inner join, it doesn’t matter because they will always the same.</p>
</div>
<div id="example_140_inner-join-summary-sql" class="section level3">
<h3><span class="header-section-number">14.4.3</span> SQL Inner Join Summary</h3>
<p>Note that both the store_id is available from both the customer and store tables, c.store_id,s.store_id, in the select clause.</p>
<div class="sourceCode" id="cb349"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb349-1" data-line-number="1">customer_store_summay_sij &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb349-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb349-3" data-line-number="3">  <span class="st">&quot;select c.store_id c_store_id,s.store_id s_store_id,count(*) n</span></a>
<a class="sourceLine" id="cb349-4" data-line-number="4"><span class="st">   from customer c join store s on c.store_id = s.store_id</span></a>
<a class="sourceLine" id="cb349-5" data-line-number="5"><span class="st">  group by c.store_id,s.store_id;&quot;</span></a>
<a class="sourceLine" id="cb349-6" data-line-number="6">)</a>
<a class="sourceLine" id="cb349-7" data-line-number="7"></a>
<a class="sourceLine" id="cb349-8" data-line-number="8"><span class="kw">sp_print_df</span>(customer_store_summay_sij)</a></code></pre></div>
<div id="htmlwidget-09904734225327216f09" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-09904734225327216f09">{"x":{"filter":"none","data":[["1","2"],[1,2],[1,2],[326,274]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>c_store_id<\/th>\n      <th>s_store_id<\/th>\n      <th>n<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="example_140_inner-join-summary_dplyr" class="section level3">
<h3><span class="header-section-number">14.4.4</span> Dplyr Inner Join Summary</h3>
<p>In the previous SQL code block, <code>c.</code> and <code>s.</code> were used in the <code>inner join</code> as table aliases. The <code>dplyr</code> suffix is similar to the SQL table alias. The role of the dplyr suffix and the SQL alias is to disambiguate duplicate table and column names referenced.</p>
<div class="sourceCode" id="cb350"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb350-1" data-line-number="1">customer_store_summary_dij &lt;-<span class="st"> </span>customer_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb350-2" data-line-number="2"><span class="st">  </span><span class="kw">inner_join</span>(store_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;store_id&quot;</span> =<span class="st"> &quot;store_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.c&quot;</span>, <span class="st">&quot;.s&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb350-3" data-line-number="3"><span class="st">     </span><span class="kw">mutate</span>( <span class="dt">join_type =</span> <span class="st">&quot;ij&quot;</span></a>
<a class="sourceLine" id="cb350-4" data-line-number="4">        ,<span class="dt">c_store_id =</span> <span class="kw">if_else</span>(<span class="kw">is.na</span>(customer_id),customer_id, store_id)         </a>
<a class="sourceLine" id="cb350-5" data-line-number="5">        ,<span class="dt">s_store_id =</span> <span class="kw">if_else</span>(<span class="kw">is.na</span>(manager_staff_id), manager_staff_id, store_id)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb350-6" data-line-number="6"><span class="st">  </span><span class="kw">group_by</span>(join_type,c_store_id,s_store_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb350-7" data-line-number="7"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">n =</span> <span class="kw">n</span>())</a>
<a class="sourceLine" id="cb350-8" data-line-number="8"></a>
<a class="sourceLine" id="cb350-9" data-line-number="9"><span class="kw">sp_print_df</span>(customer_store_summary_dij)</a></code></pre></div>
<div id="htmlwidget-b619f31f38e9f2471fcc" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-b619f31f38e9f2471fcc">{"x":{"filter":"none","data":[["1","2"],["ij","ij"],[1,2],[1,2],[326,274]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>join_type<\/th>\n      <th>c_store_id<\/th>\n      <th>s_store_id<\/th>\n      <th>n<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="left-joins" class="section level2">
<h2><span class="header-section-number">14.5</span> Left Joins</h2>
<div id="example_140_left-join-details-sql" class="section level3">
<h3><span class="header-section-number">14.5.1</span> SQL Left Join Details</h3>
<p>The SQL block below shows all 10 sample customer rows, the customer table is on the left and is the driving table, in the detail output which join to 2 of the 3 rows in the store table. All the rows with customer store_id greater than 2 have null/blank store column values.</p>
<div class="sourceCode" id="cb351"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb351-1" data-line-number="1">customer_store_details_sloj &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb351-2" data-line-number="2"><span class="st">&quot;select &#39;loj&#39; join_type,customer_id,first_name,last_name,c.store_id c_store_id</span></a>
<a class="sourceLine" id="cb351-3" data-line-number="3"><span class="st">       ,s.store_id s_store_id,s.manager_staff_id, s.address_id</span></a>
<a class="sourceLine" id="cb351-4" data-line-number="4"><span class="st">   from customer c left join store s on c.store_id = s.store_id </span></a>
<a class="sourceLine" id="cb351-5" data-line-number="5"><span class="st">  where customer_id between 595 and 604;&quot;</span>)</a>
<a class="sourceLine" id="cb351-6" data-line-number="6"><span class="kw">sp_print_df</span>(customer_store_details_sloj)</a></code></pre></div>
<div id="htmlwidget-beeafef17c4840807f51" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-beeafef17c4840807f51">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10"],["loj","loj","loj","loj","loj","loj","loj","loj","loj","loj"],[595,596,597,598,599,600,601,602,603,604],["Terrence","Enrique","Freddie","Wade","Austin","Sophie","Sophie","John","Ian","Ed"],["Gunderson","Forsythe","Duggan","Delvalle","Cintron","Yang","Yang","Smith","Frantz","Borasky"],[1,1,1,1,2,3,2,4,5,6],[1,1,1,1,2,null,2,null,null,null],[1,1,1,1,2,null,2,null,null,null],[1,1,1,1,2,null,2,null,null,null]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>join_type<\/th>\n      <th>customer_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>c_store_id<\/th>\n      <th>s_store_id<\/th>\n      <th>manager_staff_id<\/th>\n      <th>address_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,5,6,7,8]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="example_140_left-join-details-dplyr" class="section level3">
<h3><span class="header-section-number">14.5.2</span> Dplyr Left Join Details</h3>
<p>The next code block shows the left join details. Note that the s_store_id column is derived via the mutate function, but not shown in the output below. Without the s_store_id column, it might accidentally be assumed that the store.store_id = customer.store_id when the store.store_id values are actually NULL/NA based on the output without the s_store_id column.</p>
<div class="sourceCode" id="cb352"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb352-1" data-line-number="1">customer_store_detail_dloj &lt;-<span class="st"> </span>customer_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb352-2" data-line-number="2"><span class="st">  </span><span class="kw">left_join</span>(store_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;store_id&quot;</span> =<span class="st"> &quot;store_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.c&quot;</span>, <span class="st">&quot;.s&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb352-3" data-line-number="3"><span class="st">    </span><span class="kw">filter</span>(customer_id <span class="op">&gt;=</span><span class="st"> </span><span class="dv">595</span> <span class="op">&amp;</span><span class="st"> </span>customer_id <span class="op">&lt;=</span><span class="st"> </span><span class="dv">604</span> ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb352-4" data-line-number="4"><span class="st">      </span><span class="kw">mutate</span>(<span class="dt">join_type =</span> <span class="st">&quot;loj&quot;</span></a>
<a class="sourceLine" id="cb352-5" data-line-number="5">             ,<span class="dt">s_store_id =</span> <span class="kw">if_else</span>(<span class="kw">is.na</span>(manager_staff_id), manager_staff_id, store_id)</a>
<a class="sourceLine" id="cb352-6" data-line-number="6">            ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb352-7" data-line-number="7"><span class="st">    </span><span class="kw">rename</span>(<span class="dt">s_address_id =</span> address_id.y) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb352-8" data-line-number="8"><span class="st">    </span><span class="kw">select</span>(join_type,customer_id,first_name,last_name,store_id </a>
<a class="sourceLine" id="cb352-9" data-line-number="9">       ,manager_staff_id, s_address_id) </a>
<a class="sourceLine" id="cb352-10" data-line-number="10"></a>
<a class="sourceLine" id="cb352-11" data-line-number="11"><span class="kw">sp_print_df</span>(customer_store_detail_dloj)</a></code></pre></div>
<div id="htmlwidget-f6a2206cea77e899a1de" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-f6a2206cea77e899a1de">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10"],["loj","loj","loj","loj","loj","loj","loj","loj","loj","loj"],[595,596,597,598,599,600,601,602,603,604],["Terrence","Enrique","Freddie","Wade","Austin","Sophie","Sophie","John","Ian","Ed"],["Gunderson","Forsythe","Duggan","Delvalle","Cintron","Yang","Yang","Smith","Frantz","Borasky"],[1,1,1,1,2,3,2,4,5,6],[1,1,1,1,2,null,2,null,null,null],[1,1,1,1,2,null,2,null,null,null]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>join_type<\/th>\n      <th>customer_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>store_id<\/th>\n      <th>manager_staff_id<\/th>\n      <th>s_address_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,5,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>The following code block includes the derived s_store_id value. The output makes it explicit that the s_store_id value is missing. The sp_print_df function is replaced with the print function to show the actual NA values.</p>
<div class="sourceCode" id="cb353"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb353-1" data-line-number="1">customer_store_detail_dloj &lt;-<span class="st"> </span>customer_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb353-2" data-line-number="2"><span class="st">  </span><span class="kw">left_join</span>(store_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;store_id&quot;</span> =<span class="st"> &quot;store_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.c&quot;</span>, <span class="st">&quot;.s&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb353-3" data-line-number="3"><span class="st">    </span><span class="kw">filter</span>(customer_id <span class="op">&gt;=</span><span class="st"> </span><span class="dv">595</span> <span class="op">&amp;</span><span class="st"> </span>customer_id <span class="op">&lt;=</span><span class="st"> </span><span class="dv">604</span> ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb353-4" data-line-number="4"><span class="st">      </span><span class="kw">mutate</span>(<span class="dt">join_type =</span> <span class="st">&quot;loj&quot;</span></a>
<a class="sourceLine" id="cb353-5" data-line-number="5">             ,<span class="dt">s_store_id =</span> <span class="kw">if_else</span>(<span class="kw">is.na</span>(manager_staff_id), manager_staff_id, store_id)</a>
<a class="sourceLine" id="cb353-6" data-line-number="6">            ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb353-7" data-line-number="7"><span class="st">    </span><span class="kw">rename</span>(<span class="dt">c_store_id =</span> store_id</a>
<a class="sourceLine" id="cb353-8" data-line-number="8">          ,<span class="dt">s_address_id =</span> address_id.y) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb353-9" data-line-number="9"><span class="st">    </span><span class="kw">select</span>(customer_id,first_name,last_name,c_store_id </a>
<a class="sourceLine" id="cb353-10" data-line-number="10">       ,s_store_id,manager_staff_id, s_address_id) </a>
<a class="sourceLine" id="cb353-11" data-line-number="11"></a>
<a class="sourceLine" id="cb353-12" data-line-number="12"><span class="kw">print</span>(customer_store_detail_dloj)</a></code></pre></div>
<pre><code>##    customer_id first_name last_name c_store_id s_store_id manager_staff_id
## 1          595   Terrence Gunderson          1          1                1
## 2          596    Enrique  Forsythe          1          1                1
## 3          597    Freddie    Duggan          1          1                1
## 4          598       Wade  Delvalle          1          1                1
## 5          599     Austin   Cintron          2          2                2
## 6          600     Sophie      Yang          3         NA               NA
## 7          601     Sophie      Yang          2          2                2
## 8          602       John     Smith          4         NA               NA
## 9          603        Ian    Frantz          5         NA               NA
## 10         604         Ed   Borasky          6         NA               NA
##    s_address_id
## 1             1
## 2             1
## 3             1
## 4             1
## 5             2
## 6            NA
## 7             2
## 8            NA
## 9            NA
## 10           NA</code></pre>
<p>In the remaining examples, the <code>dplyr</code> code blocks will show both the customer and store store_id values with the either <code>c_</code> or <code>s_</code> store_id prefix . The sp_print_df function returns the SQL NULL and R NA values as blanks.</p>
</div>
<div id="example_140_left-join-summary-sql" class="section level3">
<h3><span class="header-section-number">14.5.3</span> SQL Left Join Summary</h3>
<p>For a left outer join between two tables, it does matter which table is on the left and which is on the right, because every row in the left table is returned when there is no <code>where/filter</code> condition. The second table returns row column values if the join condition exists or null collumn values if the join condition does not exist. The left join is the most frequently used join type.</p>
<p>Note that SQL returns the store_id from both the customer and store tables, c.store_id,s.store_id, in the select clause.</p>
<div class="sourceCode" id="cb355"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb355-1" data-line-number="1">customer_store_summary_sloj &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb355-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb355-3" data-line-number="3">  <span class="st">&quot;select c.store_id c_store_id,s.store_id s_store_id,count(*) loj</span></a>
<a class="sourceLine" id="cb355-4" data-line-number="4"><span class="st">   from customer c left join store s on c.store_id = s.store_id</span></a>
<a class="sourceLine" id="cb355-5" data-line-number="5"><span class="st">  group by c.store_id,s.store_id</span></a>
<a class="sourceLine" id="cb355-6" data-line-number="6"><span class="st">  order by c.store_id;&quot;</span></a>
<a class="sourceLine" id="cb355-7" data-line-number="7">)</a>
<a class="sourceLine" id="cb355-8" data-line-number="8"></a>
<a class="sourceLine" id="cb355-9" data-line-number="9"><span class="kw">sp_print_df</span>(customer_store_summary_sloj)</a></code></pre></div>
<div id="htmlwidget-80fb537b5ba0bd90fb93" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-80fb537b5ba0bd90fb93">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],[1,2,3,4,5,6],[1,2,null,null,null,null],[326,274,1,1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>c_store_id<\/th>\n      <th>s_store_id<\/th>\n      <th>loj<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>The lojs column returns the number of rows found on the store_id, from the customer table and the store table if on both tables, rows 1 - 2. The right table, the store table returned blank/NA, when the key only exists in the customer table, rows 3 - 6.</p>
<ol style="list-style-type: decimal">
<li>The left outer join always returns all rows from the left table, the driving/key table, if not reduced via a filter()/where clause.<br />
</li>
<li>All inner join rows can reference all columns/derived columns specified in the select clause from both the left and right tables.<br />
</li>
<li>All rows from the left table, the outer table, without a matching row on the right returns all the columns/derived column values specified in the select clause from the left, but the values from right table have all values of NA.</li>
</ol>
</div>
<div id="example_140_left-join-summary-dplyr" class="section level3">
<h3><span class="header-section-number">14.5.4</span> Dplyr Left Join Summary</h3>
<p>The dplyr outer join verbs do not return the non-driving table join values. Compare the mutate verb s_store_id in the code block below with s.store_id in the equivalent SQL code block above.</p>
<div class="sourceCode" id="cb356"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb356-1" data-line-number="1">customer_store_summary_dloj &lt;-<span class="st"> </span>customer_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb356-2" data-line-number="2"><span class="st">  </span><span class="kw">left_join</span>(store_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;store_id&quot;</span>, <span class="st">&quot;store_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.c&quot;</span>, <span class="st">&quot;.s&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb356-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb356-4" data-line-number="4">    <span class="dt">join_type =</span> <span class="st">&quot;loj&quot;</span></a>
<a class="sourceLine" id="cb356-5" data-line-number="5">   ,<span class="dt">s_store_id =</span> <span class="kw">if_else</span>(<span class="kw">is.na</span>(manager_staff_id), manager_staff_id, store_id)</a>
<a class="sourceLine" id="cb356-6" data-line-number="6">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb356-7" data-line-number="7"><span class="st">  </span><span class="kw">group_by</span>(join_type, store_id, s_store_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb356-8" data-line-number="8"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">n =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb356-9" data-line-number="9"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">c_store_id =</span> store_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb356-10" data-line-number="10"><span class="st">  </span><span class="kw">select</span>(join_type, c_store_id, s_store_id, n)</a>
<a class="sourceLine" id="cb356-11" data-line-number="11"></a>
<a class="sourceLine" id="cb356-12" data-line-number="12"><span class="kw">sp_print_df</span>(customer_store_summary_dloj)</a></code></pre></div>
<div id="htmlwidget-703a15d93cfc9aff608e" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-703a15d93cfc9aff608e">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],["loj","loj","loj","loj","loj","loj"],[1,2,3,4,5,6],[1,2,null,null,null,null],[326,274,1,1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>join_type<\/th>\n      <th>c_store_id<\/th>\n      <th>s_store_id<\/th>\n      <th>n<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb357"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb357-1" data-line-number="1"><span class="kw">print</span>(customer_store_summary_dloj)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 4
## # Groups:   join_type, c_store_id [6]
##   join_type c_store_id s_store_id     n
##   &lt;chr&gt;          &lt;int&gt;      &lt;int&gt; &lt;int&gt;
## 1 loj                1          1   326
## 2 loj                2          2   274
## 3 loj                3         NA     1
## 4 loj                4         NA     1
## 5 loj                5         NA     1
## 6 loj                6         NA     1</code></pre>
</div>
</div>
<div id="why-include-one-of-the-inner-join-key-columns" class="section level2">
<h2><span class="header-section-number">14.6</span> Why Include one of the Inner Join Key columns?</h2>
<p>It is not uncommon to have many many tables joined together as a series of left outer joins. If the inner join key column is included in the output, one knows that the inner join condition was met or not. If the key column is not shown and non-key columns are shown from the inner table, they may actually be null. It is often the case that a long series of left outer joins just join on the key column to get one value out of the table to join to the next table in the series.</p>
<p>One can think of the two components of an inner join as a transaction is either in an open state, no matching rows in the inner table or a closed state with one or more matching rows in the inner table. Assume that we have a four DVD rental step process represented via table A, B, C, and D left outer joined together. Summing the null and non-null keys together across all four tables gives a quick snap shot of the business in the four different steps. We will review this concept in some detail in one of the future exercises.</p>
</div>
<div id="right-joins" class="section level2">
<h2><span class="header-section-number">14.7</span> Right Joins</h2>
<div id="example_140_right-join-details-sql" class="section level3">
<h3><span class="header-section-number">14.7.1</span> SQL Right Join Details</h3>
<p>The SQL block below shows only our sample customer rows, (customer_id between 595 and 604). The driving table is on the right, the <code>store</code> table. Only six of the 10 sample customer rows appear which have store_id = {1, 2}. All three <code>store</code> rows appear, row_id = {1,2,10}. The right join is least frequently used join type.</p>
<div class="sourceCode" id="cb359"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb359-1" data-line-number="1">customer_store_detail_sroj &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb359-2" data-line-number="2"><span class="st">&quot;select &#39;roj&#39; join_type,customer_id,first_name,last_name,c.store_id c_store_id</span></a>
<a class="sourceLine" id="cb359-3" data-line-number="3"><span class="st">       ,s.store_id s_store_id,s.manager_staff_id, s.address_id</span></a>
<a class="sourceLine" id="cb359-4" data-line-number="4"><span class="st">   from customer c right join store s on c.store_id = s.store_id </span></a>
<a class="sourceLine" id="cb359-5" data-line-number="5"><span class="st">where coalesce(customer_id,595) between 595 and 604;&quot;</span>)</a>
<a class="sourceLine" id="cb359-6" data-line-number="6"><span class="kw">sp_print_df</span>(customer_store_detail_sroj)</a></code></pre></div>
<div id="htmlwidget-6d936e3915a36e12cd53" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6d936e3915a36e12cd53">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7"],["roj","roj","roj","roj","roj","roj","roj"],[595,596,597,598,599,601,null],["Terrence","Enrique","Freddie","Wade","Austin","Sophie",null],["Gunderson","Forsythe","Duggan","Delvalle","Cintron","Yang",null],[1,1,1,1,2,2,null],[1,1,1,1,2,2,10],[1,1,1,1,2,2,10],[1,1,1,1,2,2,10]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>join_type<\/th>\n      <th>customer_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>c_store_id<\/th>\n      <th>s_store_id<\/th>\n      <th>manager_staff_id<\/th>\n      <th>address_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,5,6,7,8]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>Compare the SQL left join where clause</p>
<pre><code>where customer_id between 595 and 604;&quot;)</code></pre>
<p>with the SQL right join where clause</p>
<pre><code>where coalesce(customer_id,595) between 595 and 604;&quot;)</code></pre>
<p>The <code>customer</code> table is the driving table in the left join and always returns all rows from the <code>customer</code> table on the left that match the join and satisfy the where clause. The <code>store</code> table is the driving table in the right join and always returns all rows from the <code>store</code> table on the right that match the join and satisfy the where clause. The right outer join condition shown always returns the <code>store.store_id=10</code> row. Since the customer table does not have the corresponding row to join to, the right outer join return a customer row with all null column values. The <code>coalesce</code> is a NULL if-then-else test. If the customer_id is null, it returns 595 to prevent the store_id = 10 row from being dropped from the result set.</p>
<p>The right outer join clause can be rewritten as</p>
<pre><code>     where customer_id between 595 and 604 or customer_id is null;</code></pre>
<p>See the next dplyr code block to see the alternative where clause shown above.</p>
</div>
<div id="example_140_right-join-details-dplyr" class="section level3">
<h3><span class="header-section-number">14.7.2</span> Dplyr Right Join Details</h3>
<div class="sourceCode" id="cb363"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb363-1" data-line-number="1">customer_store_detail_droj &lt;-<span class="st"> </span>customer_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb363-2" data-line-number="2"><span class="st">  </span><span class="kw">right_join</span>(store_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;store_id&quot;</span> =<span class="st"> &quot;store_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.c&quot;</span>, <span class="st">&quot;.s&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb363-3" data-line-number="3"><span class="st">    </span><span class="kw">filter</span>((customer_id <span class="op">&gt;=</span><span class="st"> </span><span class="dv">595</span> <span class="op">&amp;</span><span class="st"> </span>customer_id <span class="op">&lt;=</span><span class="st"> </span><span class="dv">604</span>) <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(customer_id)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb363-4" data-line-number="4"><span class="st">      </span><span class="kw">mutate</span>(<span class="dt">join_type =</span> <span class="st">&quot;roj&quot;</span></a>
<a class="sourceLine" id="cb363-5" data-line-number="5">             ,<span class="dt">c_store_id =</span> <span class="kw">if_else</span>(<span class="kw">is.na</span>(customer_id), customer_id, store_id)</a>
<a class="sourceLine" id="cb363-6" data-line-number="6">            ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb363-7" data-line-number="7"><span class="st">    </span><span class="kw">rename</span>(<span class="dt">s_store_id =</span> store_id</a>
<a class="sourceLine" id="cb363-8" data-line-number="8">          ,<span class="dt">s_address_id =</span> address_id.y) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb363-9" data-line-number="9"><span class="st">    </span><span class="kw">select</span>(customer_id,first_name,last_name,s_store_id </a>
<a class="sourceLine" id="cb363-10" data-line-number="10">       ,c_store_id,manager_staff_id, s_address_id) </a>
<a class="sourceLine" id="cb363-11" data-line-number="11"></a>
<a class="sourceLine" id="cb363-12" data-line-number="12"><span class="kw">sp_print_df</span>(customer_store_detail_droj)</a></code></pre></div>
<div id="htmlwidget-c195b56d57c26c8f1d4d" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-c195b56d57c26c8f1d4d">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7"],[595,596,597,598,599,601,null],["Terrence","Enrique","Freddie","Wade","Austin","Sophie",null],["Gunderson","Forsythe","Duggan","Delvalle","Cintron","Yang",null],[1,1,1,1,2,2,10],[1,1,1,1,2,2,null],[1,1,1,1,2,2,10],[1,1,1,1,2,2,10]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>customer_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>s_store_id<\/th>\n      <th>c_store_id<\/th>\n      <th>manager_staff_id<\/th>\n      <th>s_address_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,4,5,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="example_140_right-join-summary-sql" class="section level3">
<h3><span class="header-section-number">14.7.3</span> SQL Right Outer Join Summary</h3>
<div class="sourceCode" id="cb364"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb364-1" data-line-number="1">customer_store_summary_sroj &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb364-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb364-3" data-line-number="3">  <span class="st">&quot;select &#39;roj&#39; join_type,c.store_id c_store_id,s.store_id s_store_id,count(*) rojs</span></a>
<a class="sourceLine" id="cb364-4" data-line-number="4"><span class="st">   from customer c right outer join store s on c.store_id = s.store_id</span></a>
<a class="sourceLine" id="cb364-5" data-line-number="5"><span class="st">  group by c.store_id,s.store_id</span></a>
<a class="sourceLine" id="cb364-6" data-line-number="6"><span class="st">order by s.store_id;&quot;</span></a>
<a class="sourceLine" id="cb364-7" data-line-number="7">)</a>
<a class="sourceLine" id="cb364-8" data-line-number="8"><span class="kw">sp_print_df</span>(customer_store_summary_sroj)</a></code></pre></div>
<div id="htmlwidget-7a589913f405d7a14fbe" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-7a589913f405d7a14fbe">{"x":{"filter":"none","data":[["1","2","3"],["roj","roj","roj"],[1,2,null],[1,2,10],[326,274,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>join_type<\/th>\n      <th>c_store_id<\/th>\n      <th>s_store_id<\/th>\n      <th>rojs<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>The rojs column returns the number of rows found on the keys from the right table, <code>store</code>, and the left table, the <code>customer</code> table.</p>
<ol style="list-style-type: decimal">
<li>The right outer join always returns all rows from the right table, the driving/key table, if not reduced via a filter()/where clause.<br />
</li>
<li>All rows that inner join returns all the columns/derived columns specified in the select clause from both the left and right tables.<br />
</li>
<li>All rows from the right table, the outer table, without a matching row on the left returns all the columns/derived column values specified in the select clause from the right, but the values from left table have all values of NA. This line 3, store.store_id = 10.</li>
</ol>
</div>
<div id="example_140_right-join-summary-dplyr" class="section level3">
<h3><span class="header-section-number">14.7.4</span> dplyr Right Join Summary</h3>
<div class="sourceCode" id="cb365"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb365-1" data-line-number="1">customer_store_summary_droj &lt;-<span class="st"> </span>customer_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb365-2" data-line-number="2"><span class="st">  </span><span class="kw">right_join</span>(store_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;store_id&quot;</span>, <span class="st">&quot;store_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.c&quot;</span>, <span class="st">&quot;.s&quot;</span>)), <span class="dt">all =</span> store_table) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb365-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb365-4" data-line-number="4">    <span class="dt">c_store_id =</span> <span class="kw">if_else</span>(<span class="kw">is.na</span>(customer_id),customer_id, store_id)</a>
<a class="sourceLine" id="cb365-5" data-line-number="5">    , <span class="dt">join_type =</span> <span class="st">&quot;rojs&quot;</span></a>
<a class="sourceLine" id="cb365-6" data-line-number="6">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb365-7" data-line-number="7"><span class="st">    </span><span class="kw">group_by</span>(join_type, store_id,c_store_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb365-8" data-line-number="8"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">n =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb365-9" data-line-number="9"><span class="st">    </span><span class="kw">rename</span>(<span class="dt">s_store_id =</span> store_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb365-10" data-line-number="10"><span class="st">    </span><span class="kw">select</span>(join_type, s_store_id,c_store_id, n)</a>
<a class="sourceLine" id="cb365-11" data-line-number="11"></a>
<a class="sourceLine" id="cb365-12" data-line-number="12"><span class="kw">sp_print_df</span>(customer_store_summary_droj)</a></code></pre></div>
<div id="htmlwidget-a3fe20e2cfd2d5bbfba3" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-a3fe20e2cfd2d5bbfba3">{"x":{"filter":"none","data":[["1","2","3"],["rojs","rojs","rojs"],[1,2,10],[1,2,null],[326,274,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>join_type<\/th>\n      <th>s_store_id<\/th>\n      <th>c_store_id<\/th>\n      <th>n<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="full-join" class="section level2">
<h2><span class="header-section-number">14.8</span> Full Join</h2>
<div id="example_140_full-join-details-sql-a" class="section level3">
<h3><span class="header-section-number">14.8.1</span> SQL Full Join Details</h3>
<p>The full outer join is a conbination of the left and right outer joins and returns all matched and unmatched rows from the <code>ON</code> clause. The matched rows return their table column values and the unmatched rows return NULL column values. This can result in a very large result set.</p>
<p>The next SQL block implements a full outer join and returns 12 rows. Change the <code>Show entries</code> from 10 to 25 to see all the entries.</p>
<div class="sourceCode" id="cb366"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb366-1" data-line-number="1">customer_store_details_sfoj &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb366-2" data-line-number="2">  <span class="st">&quot;select &#39;foj&#39; join_type, c.customer_id,c.first_name,c.last_name,c.store_id c_store_id</span></a>
<a class="sourceLine" id="cb366-3" data-line-number="3"><span class="st">          ,s.store_id s_store_id,s.manager_staff_id,s.address_id</span></a>
<a class="sourceLine" id="cb366-4" data-line-number="4"><span class="st">     from customer c full outer join store s on c.store_id = s.store_id </span></a>
<a class="sourceLine" id="cb366-5" data-line-number="5"><span class="st">    where coalesce(c.customer_id,595) between 595 and 604;&quot;</span>)</a>
<a class="sourceLine" id="cb366-6" data-line-number="6"><span class="kw">sp_print_df</span>(customer_store_details_sfoj)</a></code></pre></div>
<div id="htmlwidget-a98751c486bb4e6734fc" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-a98751c486bb4e6734fc">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11"],["foj","foj","foj","foj","foj","foj","foj","foj","foj","foj","foj"],[595,596,597,598,599,600,601,602,603,604,null],["Terrence","Enrique","Freddie","Wade","Austin","Sophie","Sophie","John","Ian","Ed",null],["Gunderson","Forsythe","Duggan","Delvalle","Cintron","Yang","Yang","Smith","Frantz","Borasky",null],[1,1,1,1,2,3,2,4,5,6,null],[1,1,1,1,2,null,2,null,null,null,10],[1,1,1,1,2,null,2,null,null,null,10],[1,1,1,1,2,null,2,null,null,null,10]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>join_type<\/th>\n      <th>customer_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>c_store_id<\/th>\n      <th>s_store_id<\/th>\n      <th>manager_staff_id<\/th>\n      <th>address_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,5,6,7,8]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="example_140_full-join-details-sql-b" class="section level3">
<h3><span class="header-section-number">14.8.2</span> Dplyr Full Join Details</h3>
<div class="sourceCode" id="cb367"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb367-1" data-line-number="1">customer_store_detail_dfoj &lt;-<span class="st"> </span>customer_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb367-2" data-line-number="2"><span class="st">  </span><span class="kw">full_join</span>(store_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;store_id&quot;</span> =<span class="st"> &quot;store_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.c&quot;</span>, <span class="st">&quot;.s&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb367-3" data-line-number="3"><span class="st">    </span><span class="kw">filter</span>((customer_id <span class="op">&gt;=</span><span class="st"> </span><span class="dv">595</span> <span class="op">&amp;</span><span class="st"> </span>customer_id <span class="op">&lt;=</span><span class="st"> </span><span class="dv">604</span>) <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(customer_id)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb367-4" data-line-number="4"><span class="st">      </span><span class="kw">mutate</span>(<span class="dt">join_type =</span> <span class="st">&quot;roj&quot;</span></a>
<a class="sourceLine" id="cb367-5" data-line-number="5">             ,<span class="dt">c_store_id =</span> <span class="kw">if_else</span>(<span class="kw">is.na</span>(customer_id), customer_id, store_id)</a>
<a class="sourceLine" id="cb367-6" data-line-number="6">            ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb367-7" data-line-number="7"><span class="st">    </span><span class="kw">rename</span>(<span class="dt">s_store_id =</span> store_id</a>
<a class="sourceLine" id="cb367-8" data-line-number="8">          ,<span class="dt">s_address_id =</span> address_id.y) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb367-9" data-line-number="9"><span class="st">    </span><span class="kw">select</span>(customer_id,first_name,last_name,s_store_id </a>
<a class="sourceLine" id="cb367-10" data-line-number="10">       ,c_store_id,manager_staff_id, s_address_id) </a>
<a class="sourceLine" id="cb367-11" data-line-number="11"></a>
<a class="sourceLine" id="cb367-12" data-line-number="12"><span class="kw">sp_print_df</span>(customer_store_detail_dfoj)</a></code></pre></div>
<div id="htmlwidget-90472fc291eea3b37ad9" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-90472fc291eea3b37ad9">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11"],[595,596,597,598,599,600,601,602,603,604,null],["Terrence","Enrique","Freddie","Wade","Austin","Sophie","Sophie","John","Ian","Ed",null],["Gunderson","Forsythe","Duggan","Delvalle","Cintron","Yang","Yang","Smith","Frantz","Borasky",null],[1,1,1,1,2,3,2,4,5,6,10],[1,1,1,1,2,3,2,4,5,6,null],[1,1,1,1,2,null,2,null,null,null,10],[1,1,1,1,2,null,2,null,null,null,10]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>customer_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>s_store_id<\/th>\n      <th>c_store_id<\/th>\n      <th>manager_staff_id<\/th>\n      <th>s_address_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,4,5,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="example_140_full-join-summary-sql" class="section level3">
<h3><span class="header-section-number">14.8.3</span> SQL Full Join Summary</h3>
<p>The result set below is ordered by the store.store_id.</p>
<div class="sourceCode" id="cb368"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb368-1" data-line-number="1">customer_store_summary_sfoj &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb368-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb368-3" data-line-number="3">  <span class="st">&quot;select &#39;foj&#39; join_type,c.store_id c_store_id,s.store_id s_store_id,count(*) fojs</span></a>
<a class="sourceLine" id="cb368-4" data-line-number="4"><span class="st">   from customer c full outer join store s on c.store_id = s.store_id</span></a>
<a class="sourceLine" id="cb368-5" data-line-number="5"><span class="st">  group by c.store_id,s.store_id</span></a>
<a class="sourceLine" id="cb368-6" data-line-number="6"><span class="st">order by s.store_id,c.store_id;&quot;</span></a>
<a class="sourceLine" id="cb368-7" data-line-number="7">)</a>
<a class="sourceLine" id="cb368-8" data-line-number="8"><span class="kw">sp_print_df</span>(customer_store_summary_sfoj)</a></code></pre></div>
<div id="htmlwidget-6c084255227fcd56827e" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6c084255227fcd56827e">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7"],["foj","foj","foj","foj","foj","foj","foj"],[1,2,null,3,4,5,6],[1,2,10,null,null,null,null],[326,274,1,1,1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>join_type<\/th>\n      <th>c_store_id<\/th>\n      <th>s_store_id<\/th>\n      <th>fojs<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="example_140_full-join-summary-dplyr" class="section level3">
<h3><span class="header-section-number">14.8.4</span> Dplyr Full Join Summary</h3>
<p>The full outer join summary seven rows. Store_id = {1,2} appear in both table tables. Store_id = {3 - 6} appear only in the customer table which is on the left. Store_id = 10 appears only in the <code>store</code> table which is on the right.</p>
<div class="sourceCode" id="cb369"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb369-1" data-line-number="1">customer_store_summary_dfoj &lt;-<span class="st"> </span>customer_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb369-2" data-line-number="2"><span class="st">  </span><span class="kw">full_join</span>(store_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;store_id&quot;</span>, <span class="st">&quot;store_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.c&quot;</span>, <span class="st">&quot;.s&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb369-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">join_type =</span> <span class="st">&quot;fojs&quot;</span></a>
<a class="sourceLine" id="cb369-4" data-line-number="4">        ,<span class="dt">c_store_id =</span> <span class="kw">if_else</span>(<span class="kw">is.na</span>(customer_id),customer_id, store_id)         </a>
<a class="sourceLine" id="cb369-5" data-line-number="5">        ,<span class="dt">s_store_id =</span> <span class="kw">if_else</span>(<span class="kw">is.na</span>(manager_staff_id), manager_staff_id, store_id)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb369-6" data-line-number="6"><span class="st">  </span><span class="kw">group_by</span>(join_type,c_store_id, s_store_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb369-7" data-line-number="7"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">n =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb369-8" data-line-number="8"><span class="st">    </span><span class="kw">arrange</span>(s_store_id)</a>
<a class="sourceLine" id="cb369-9" data-line-number="9"></a>
<a class="sourceLine" id="cb369-10" data-line-number="10"><span class="kw">sp_print_df</span>(customer_store_summary_dfoj)</a></code></pre></div>
<div id="htmlwidget-cc911bce9136bf4e7dfd" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-cc911bce9136bf4e7dfd">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7"],["fojs","fojs","fojs","fojs","fojs","fojs","fojs"],[1,2,null,3,4,5,6],[1,2,10,null,null,null,null],[326,274,1,1,1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>join_type<\/th>\n      <th>c_store_id<\/th>\n      <th>s_store_id<\/th>\n      <th>n<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="semi-join" class="section level2">
<h2><span class="header-section-number">14.9</span> Semi Join</h2>
<p>Below is the <code>dplyr</code> semi_join documentation.</p>
<pre><code>semi_join()
return all rows from x where there are matching values in y, keeping just columns from x.

A semi join differs from an inner join because an inner join will return one row of x for each matching row of y, where a semi join will never duplicate rows of x.</code></pre>
<p>The semi join always returns one and only one row from the x table that satisfies the inner join condition. If we look at one key value on both x and y where the x table has 1 x.key row and y and n y.key rows, then the inner join returns n x.key rows, (1-to-n), and the semi-join returns just one x.key row, (1-to-1).</p>
<div id="example_140_semi-join-sql-1" class="section level3">
<h3><span class="header-section-number">14.9.1</span> SQL Semi Join Customer to Store</h3>
<p>SQL does not have an explicity ‘semi join’ key word. The <code>semi join</code> reduces relationships from 1-to-n to 1-to-1. SQL uses an EXISTS - subquery syntax to implement the <code>semi join</code>.</p>
<div id="sql-exists-and-correlated-subquery-syntax" class="section level4">
<h4><span class="header-section-number">14.9.1.1</span> SQL EXISTS and Correlated SubQuery Syntax</h4>
<pre><code>select * 
  FROM table1 l
 WHERE EXISTS(SELECT 1 FROM table2 r where l.c = r.c)
 
The EXISTS keyword checks if one or more rows satsify the SELECT clause enclosed in parenthesis, the correlated subquery.  The r.c column from table2, the inner/right table, is correlated to the l.c column from table1, the outer/left table. </code></pre>
<p>For all the table1 rows where the EXISTS clause returns TRUE, the table1 rows are returned. There is no way to reference table2 columns in the outer select, hence the semi join.</p>
<p>All the previous joins were mutating joins, the joins resulted in a blending of columns from both tables. A semi join only returns rows from a single table and is a filtering join. The mutating examples included a count column to show the 1-to-n relationships. Filtering joins are 1-to-1 and the count column is dropped in the following examples.</p>
<div class="sourceCode" id="cb372"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb372-1" data-line-number="1">customer_store_ssj &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb372-2" data-line-number="2"><span class="st">&quot;select &#39;sj&#39; join_type,customer_id,first_name,last_name,c.store_id c_store_id</span></a>
<a class="sourceLine" id="cb372-3" data-line-number="3"><span class="st">   from customer c </span></a>
<a class="sourceLine" id="cb372-4" data-line-number="4"><span class="st">  where customer_id &gt; 594 </span></a>
<a class="sourceLine" id="cb372-5" data-line-number="5"><span class="st">    and exists( select 1 from store s where c.store_id = s.store_id);</span></a>
<a class="sourceLine" id="cb372-6" data-line-number="6"><span class="st">;&quot;</span>)</a>
<a class="sourceLine" id="cb372-7" data-line-number="7"><span class="kw">sp_print_df</span>(customer_store_ssj)</a></code></pre></div>
<div id="htmlwidget-6c3e37b0fa7ac693f7cc" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6c3e37b0fa7ac693f7cc">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],["sj","sj","sj","sj","sj","sj"],[595,596,597,598,599,601],["Terrence","Enrique","Freddie","Wade","Austin","Sophie"],["Gunderson","Forsythe","Duggan","Delvalle","Cintron","Yang"],[1,1,1,1,2,2]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>join_type<\/th>\n      <th>customer_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>c_store_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>Note that this returned the six rows from the customer table that satisfied the c.store_id = s.store_id join condition. It is the same as the SQL Inner Join example earlier, but without the store columns. All the relationships are 1-to-1.</p>
</div>
</div>
<div id="example_140_semi-join-dplyr-1" class="section level3">
<h3><span class="header-section-number">14.9.2</span> Dplyr Semi Join Customer to Store</h3>
<p>The corresponding Dplyr version is shown in the next code block.</p>
<div class="sourceCode" id="cb373"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb373-1" data-line-number="1">customer_store_dsj &lt;-<span class="st"> </span>customer_table <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb373-2" data-line-number="2"><span class="st">  </span><span class="kw">semi_join</span>(store_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;store_id&quot;</span> =<span class="st"> &quot;store_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.c&quot;</span>, <span class="st">&quot;.s&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb373-3" data-line-number="3"><span class="st">    </span><span class="kw">filter</span>(customer_id <span class="op">&gt;=</span><span class="st"> </span><span class="dv">595</span> <span class="op">&amp;</span><span class="st"> </span>customer_id <span class="op">&lt;=</span><span class="st"> </span><span class="dv">604</span> ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb373-4" data-line-number="4"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">join_type =</span> <span class="st">&#39;sj&#39;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb373-5" data-line-number="5"><span class="st">    </span><span class="kw">select</span>(join_type,customer_id,first_name,last_name,store_id </a>
<a class="sourceLine" id="cb373-6" data-line-number="6">       ,store_id) </a>
<a class="sourceLine" id="cb373-7" data-line-number="7"><span class="kw">sp_print_df</span>(customer_store_dsj)</a></code></pre></div>
<div id="htmlwidget-88984347109043009685" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-88984347109043009685">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],["sj","sj","sj","sj","sj","sj"],[595,596,597,598,599,601],["Terrence","Enrique","Freddie","Wade","Austin","Sophie"],["Gunderson","Forsythe","Duggan","Delvalle","Cintron","Yang"],[1,1,1,1,2,2]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>join_type<\/th>\n      <th>customer_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>store_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="example_140_semi-join-sql-2" class="section level3">
<h3><span class="header-section-number">14.9.3</span> SQL Semi Join Store to Customer</h3>
<p>In the following Semi Join, the driving table is switched to the <code>store</code> table and our 10 sample customers as the right table.</p>
<div class="sourceCode" id="cb374"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb374-1" data-line-number="1">store_customer_detail_ssj &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb374-2" data-line-number="2"><span class="st">&quot;select &#39;sj&#39; join_type,s.store_id s_store_id,s.manager_staff_id, s.address_id</span></a>
<a class="sourceLine" id="cb374-3" data-line-number="3"><span class="st">   from store s</span></a>
<a class="sourceLine" id="cb374-4" data-line-number="4"><span class="st">  where  EXISTS(select 1 </span></a>
<a class="sourceLine" id="cb374-5" data-line-number="5"><span class="st">                 from customer c </span></a>
<a class="sourceLine" id="cb374-6" data-line-number="6"><span class="st">                where c.store_id = s.store_id </span></a>
<a class="sourceLine" id="cb374-7" data-line-number="7"><span class="st">                  and c.customer_id between 595 and 604</span></a>
<a class="sourceLine" id="cb374-8" data-line-number="8"><span class="st">                )</span></a>
<a class="sourceLine" id="cb374-9" data-line-number="9"><span class="st">;&quot;</span>)</a>
<a class="sourceLine" id="cb374-10" data-line-number="10"><span class="kw">sp_print_df</span>(store_customer_detail_ssj)</a></code></pre></div>
<div id="htmlwidget-d80799441e19bf040cbf" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-d80799441e19bf040cbf">{"x":{"filter":"none","data":[["1","2"],["sj","sj"],[1,2],[1,2],[1,2]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>join_type<\/th>\n      <th>s_store_id<\/th>\n      <th>manager_staff_id<\/th>\n      <th>address_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>Here we see that we get the two rows from the store table that satisfy the s.store_id = c.store_id, store_id = {1,2}. In this example the relationship between store and customer is 1-to-n, but we do not know that from the output.</p>
</div>
<div id="example_140_semi-join-dplyr-2" class="section level3">
<h3><span class="header-section-number">14.9.4</span> Dplyr Semi Join Store to Customer</h3>
<p>The corresponding Dplyr version is shown in the next code block. Note that the filter condition on the customer table has been removed because the semi_join does not return any customer columns.</p>
<div class="sourceCode" id="cb375"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb375-1" data-line-number="1">store_customer_dsj &lt;-<span class="st">  </span>store_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb375-2" data-line-number="2"><span class="st">  </span><span class="kw">semi_join</span>(customer_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;store_id&quot;</span> =<span class="st"> &quot;store_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.c&quot;</span>, <span class="st">&quot;.s&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb375-3" data-line-number="3"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">join_type =</span> <span class="st">&#39;sj&#39;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb375-4" data-line-number="4"><span class="st">    </span><span class="kw">select</span>(join_type,store_id,manager_staff_id, address_id) </a>
<a class="sourceLine" id="cb375-5" data-line-number="5"><span class="kw">sp_print_df</span>(store_customer_dsj)</a></code></pre></div>
<div id="htmlwidget-5bc260cc0681d28b4458" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5bc260cc0681d28b4458">{"x":{"filter":"none","data":[["1","2"],["sj","sj"],[1,2],[1,2],[1,2]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>join_type<\/th>\n      <th>store_id<\/th>\n      <th>manager_staff_id<\/th>\n      <th>address_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="example_140_semi-join-sql-3" class="section level3">
<h3><span class="header-section-number">14.9.5</span> SQL Semi Join Store to Customer Take 2</h3>
<p>In the <code>Semi Join Customer to Store</code> examples, we saw four rows with store_id = 1 and two rows with store_id = 2. The EXISTS key word is replaced with a count of the matching rows.</p>
<div class="sourceCode" id="cb376"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb376-1" data-line-number="1">store_customer_detail_ssj2 &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb376-2" data-line-number="2"><span class="st">&quot;select &#39;sj&#39; join_type,s.store_id s_store_id,s.manager_staff_id, s.address_id</span></a>
<a class="sourceLine" id="cb376-3" data-line-number="3"><span class="st">   from store s</span></a>
<a class="sourceLine" id="cb376-4" data-line-number="4"><span class="st">  where (select count(*)</span></a>
<a class="sourceLine" id="cb376-5" data-line-number="5"><span class="st">           from customer c </span></a>
<a class="sourceLine" id="cb376-6" data-line-number="6"><span class="st">          where c.store_id = s.store_id </span></a>
<a class="sourceLine" id="cb376-7" data-line-number="7"><span class="st">            and c.customer_id between 595 and 604</span></a>
<a class="sourceLine" id="cb376-8" data-line-number="8"><span class="st">         ) in (2,4)</span></a>
<a class="sourceLine" id="cb376-9" data-line-number="9"><span class="st">;&quot;</span>)</a>
<a class="sourceLine" id="cb376-10" data-line-number="10"><span class="kw">sp_print_df</span>(store_customer_detail_ssj2)</a></code></pre></div>
<div id="htmlwidget-5e6debc8bc477449b2d2" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5e6debc8bc477449b2d2">{"x":{"filter":"none","data":[["1","2"],["sj","sj"],[1,2],[1,2],[1,2]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>join_type<\/th>\n      <th>s_store_id<\/th>\n      <th>manager_staff_id<\/th>\n      <th>address_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>To generalize the test above, replace <code>in {2,4}</code> with <code>&gt; 0</code>.</p>
</div>
</div>
<div id="anti-joins" class="section level2">
<h2><span class="header-section-number">14.10</span> Anti Joins</h2>
<p>A <code>semi join</code> returns rows from one table that has one or more matching rows in the other table. The <code>anti join</code> returns rows from one table that has no matching rows in the other table.</p>
<div id="example_140_anti-join-dplyr" class="section level4">
<h4><span class="header-section-number">14.10.0.1</span> dplyr anti Join</h4>
<p>The anti join is an outer join without the inner joined rows. It only returns the rows from the driving table that do not have a matching row from the other table.</p>
<div class="sourceCode" id="cb377"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb377-1" data-line-number="1">customer_store_aj &lt;-<span class="st"> </span>customer_table <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb377-2" data-line-number="2"><span class="st">    </span><span class="kw">filter</span>(customer_id <span class="op">&gt;</span><span class="st"> </span><span class="dv">594</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb377-3" data-line-number="3"><span class="st">    </span><span class="kw">anti_join</span>(store_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;store_id&quot;</span>, <span class="st">&quot;store_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.c&quot;</span>, <span class="st">&quot;.s&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb377-4" data-line-number="4"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">join_type =</span> <span class="st">&quot;anti_join&quot;</span>)  </a>
<a class="sourceLine" id="cb377-5" data-line-number="5"></a>
<a class="sourceLine" id="cb377-6" data-line-number="6"><span class="kw">sp_print_df</span>(customer_store_aj)</a></code></pre></div>
<div id="htmlwidget-a769f33e9bc2b11da24f" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-a769f33e9bc2b11da24f">{"x":{"filter":"none","data":[["1","2","3","4"],[600,602,603,604],[3,4,5,6],["Sophie","John","Ian","Ed"],["Yang","Smith","Frantz","Borasky"],["sophie.yang@sakilacustomer.org","john.smith@sakilacustomer.org","ian.frantz@sakilacustomer.org","ed.borasky@sakilacustomer.org"],[1,2,3,4],[true,true,true,true],["2019-03-04","2019-03-04","2019-03-04","2019-03-04"],["2019-03-04T08:00:00Z","2019-03-04T08:00:00Z","2019-03-04T08:00:00Z","2019-03-04T08:00:00Z"],[1,1,1,1],["anti_join","anti_join","anti_join","anti_join"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>customer_id<\/th>\n      <th>store_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>email<\/th>\n      <th>address_id<\/th>\n      <th>activebool<\/th>\n      <th>create_date<\/th>\n      <th>last_update<\/th>\n      <th>active<\/th>\n      <th>join_type<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,6,10]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>All of the rows returned from the customer table have store_id = {3 - 6} which do not exist in the store_id.</p>
</div>
<div id="example_140_anti-join-sql-1-a" class="section level4">
<h4><span class="header-section-number">14.10.0.2</span> SQL anti Join 1, NOT EXISTS and Correlated subquery</h4>
<p>SQL doesn’t have an anti join key word. Here are three different ways to achieve the same result.</p>
<p>This is the negation of the same construct used in the semi join discusion. The anit-join tests for 0 matches instead of 1 or more matches for the semi-join.</p>
<div class="sourceCode" id="cb378"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb378-1" data-line-number="1">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb378-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb378-3" data-line-number="3">  <span class="st">&quot;select &#39;aj&#39; join_type, customer_id, first_name, last_name, c.store_id</span></a>
<a class="sourceLine" id="cb378-4" data-line-number="4"><span class="st">   from customer c </span></a>
<a class="sourceLine" id="cb378-5" data-line-number="5"><span class="st">  where not exists (select 1 from store s where s.store_id = c.store_id)</span></a>
<a class="sourceLine" id="cb378-6" data-line-number="6"><span class="st">order by c.customer_id</span></a>
<a class="sourceLine" id="cb378-7" data-line-number="7"><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb378-8" data-line-number="8">)</a>
<a class="sourceLine" id="cb378-9" data-line-number="9"><span class="kw">sp_print_df</span>(rs)</a></code></pre></div>
<div id="htmlwidget-5afb8971f37330fd8cc4" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5afb8971f37330fd8cc4">{"x":{"filter":"none","data":[["1","2","3","4"],["aj","aj","aj","aj"],[600,602,603,604],["Sophie","John","Ian","Ed"],["Yang","Smith","Frantz","Borasky"],[3,4,5,6]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>join_type<\/th>\n      <th>customer_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>store_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="example_140_anti-join-sql-1-b" class="section level4">
<h4><span class="header-section-number">14.10.0.3</span> SQL anti Join 2, Left Outer Join where NULL on Right</h4>
<div class="sourceCode" id="cb379"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb379-1" data-line-number="1">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb379-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb379-3" data-line-number="3">  <span class="st">&quot;select &#39;aj&#39; join_type, customer_id, first_name, last_name, c.store_id ajs</span></a>
<a class="sourceLine" id="cb379-4" data-line-number="4"><span class="st">   from customer c left outer join store s on c.store_id = s.store_id</span></a>
<a class="sourceLine" id="cb379-5" data-line-number="5"><span class="st">  where s.store_id is null</span></a>
<a class="sourceLine" id="cb379-6" data-line-number="6"><span class="st">order by c.customer_id;&quot;</span></a>
<a class="sourceLine" id="cb379-7" data-line-number="7">)</a>
<a class="sourceLine" id="cb379-8" data-line-number="8"><span class="kw">sp_print_df</span>(rs)</a></code></pre></div>
<div id="htmlwidget-e9ae68682532316859d5" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-e9ae68682532316859d5">{"x":{"filter":"none","data":[["1","2","3","4"],["aj","aj","aj","aj"],[600,602,603,604],["Sophie","John","Ian","Ed"],["Yang","Smith","Frantz","Borasky"],[3,4,5,6]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>join_type<\/th>\n      <th>customer_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>ajs<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="example_140_anti-join-sql-3" class="section level4">
<h4><span class="header-section-number">14.10.0.4</span> SQL anti Join 3, ID in driving table and NOT IN lookup table</h4>
<div class="sourceCode" id="cb380"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb380-1" data-line-number="1">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb380-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb380-3" data-line-number="3">  <span class="st">&quot;select &#39;aj&#39; join_type, customer_id, first_name, last_name, c.store_id</span></a>
<a class="sourceLine" id="cb380-4" data-line-number="4"><span class="st">   from customer c </span></a>
<a class="sourceLine" id="cb380-5" data-line-number="5"><span class="st">  where c.store_id NOT IN (select store_id from store)</span></a>
<a class="sourceLine" id="cb380-6" data-line-number="6"><span class="st">order by c.customer_id;&quot;</span></a>
<a class="sourceLine" id="cb380-7" data-line-number="7">)</a>
<a class="sourceLine" id="cb380-8" data-line-number="8"><span class="kw">sp_print_df</span>(rs)</a></code></pre></div>
<div id="htmlwidget-32dc6527565d6d2fa8eb" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-32dc6527565d6d2fa8eb">{"x":{"filter":"none","data":[["1","2","3","4"],["aj","aj","aj","aj"],[600,602,603,604],["Sophie","John","Ian","Ed"],["Yang","Smith","Frantz","Borasky"],[3,4,5,6]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>join_type<\/th>\n      <th>customer_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>store_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<!-- Show all different joins together with filter to allow comparison between different mutating joins


```r
customer_store_summary_dfoj %>%
    union(customer_store_summary_droj) %>%
    union(customer_store_summary_dloj) %>%
    union(customer_store_summary_dij) %>%
    arrange(join_type,s_store_id,c_store_id)
```


```r
sp_print_df(customer_store_summary_dfoj)
```

<div id="htmlwidget-bbe1f43178625f07ed69" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-bbe1f43178625f07ed69">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7"],["fojs","fojs","fojs","fojs","fojs","fojs","fojs"],[1,2,null,3,4,5,6],[1,2,10,null,null,null,null],[326,274,1,1,1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>join_type<\/th>\n      <th>c_store_id<\/th>\n      <th>s_store_id<\/th>\n      <th>n<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>


```r
customer_store_details_sij %>%
union(customer_store_details_sloj) %>%
union(customer_store_detail_sroj) %>%
union(customer_store_details_sfoj) %>%
arrange(join_type,s_store_id)
```

```r
sp_print_df(customer_store_details_sij)
```

<div id="htmlwidget-f44584fa5e4f08aaeb0b" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-f44584fa5e4f08aaeb0b">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],["ij","ij","ij","ij","ij","ij"],[595,596,597,598,599,601],["Terrence","Enrique","Freddie","Wade","Austin","Sophie"],["Gunderson","Forsythe","Duggan","Delvalle","Cintron","Yang"],[1,1,1,1,2,2],[1,1,1,1,2,2],[1,1,1,1,2,2],[1,1,1,1,2,2]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>join_type<\/th>\n      <th>customer_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>c_store_id<\/th>\n      <th>s_store_id<\/th>\n      <th>manager_staff_id<\/th>\n      <th>address_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,5,6,7,8]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>

--->
</div>
</div>
<div id="non-equa-join-example" class="section level2">
<h2><span class="header-section-number">14.11</span> Non-Equa-Join Example</h2>
<p>All the previous examples are equa-joins and is the most common type of join. The next example is made up and shows a ‘&lt;=’ join. The <code>store</code> table is usd. Assume that the store_id actually represents some distance. The example shows all distances &lt;= to all other distances.</p>
<div class="sourceCode" id="cb381"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb381-1" data-line-number="1">store_store_slej &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb381-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb381-3" data-line-number="3">  <span class="st">&quot;select &#39;lej&#39; join_type,s1.store_id starts,s2.store_id stops, s2.store_id - s1.store_id delta</span></a>
<a class="sourceLine" id="cb381-4" data-line-number="4"><span class="st">   from store s1 join store s2 on s1.store_id &lt;= s2.store_id</span></a>
<a class="sourceLine" id="cb381-5" data-line-number="5"><span class="st">order by s1.store_id;&quot;</span></a>
<a class="sourceLine" id="cb381-6" data-line-number="6">)</a>
<a class="sourceLine" id="cb381-7" data-line-number="7"><span class="kw">sp_print_df</span>(store_store_slej)</a></code></pre></div>
<div id="htmlwidget-33be21b5fff197bb7cc4" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-33be21b5fff197bb7cc4">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],["lej","lej","lej","lej","lej","lej"],[1,1,1,2,2,10],[1,2,10,2,10,10],[0,1,9,0,8,0]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>join_type<\/th>\n      <th>starts<\/th>\n      <th>stops<\/th>\n      <th>delta<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div id="example_140_inner-join-dplyr" class="section level3">
<h3><span class="header-section-number">14.11.1</span> Dplyr Non-equa Join</h3>
<p>Dplyr doesn’t currently support a non-equa join. In the by parameter, one can not change the ‘=’ to ‘&lt;=’ as shown below.</p>
<pre><code>{r}

store_store_slej &lt;- store_table %&gt;%
  inner_join(store_table, by =  c(&quot;store_id&quot; &lt;= &quot;store_id&quot;), suffix(c(&quot;.c&quot;, &quot;.s&quot;))) 
    </code></pre>
<p>The above code block throws the following error message.</p>
<pre><code>Error: `by` must be a (named) character vector, list, or NULL for natural joins (not 
recommended in production code), not logical Call `rlang::last_error()` to see a backtrace</code></pre>
<p>The explaination below is from <a href="https://stackoverflow.com/questions/47485779/dplyr-joins-how-do-you-do-a-non-standard-join-col1-col2-when-working-with">here</a> and it was posted Nov 25 ’17.</p>
<p>In by = c(“col1” = “col2”), = is not and equality operator, but an assignment operator (the equality operator in R is ==). The expression inside c(…) creates a named character vector (name: col1 value: col2) that dplyr uses for the join. Nowhere do you define the kind of comparison that is made during the join, the comparison is hard-coded in dplyr. I don’t think dplyr supports non-equi joins (yet).</p>
<div class="sourceCode" id="cb384"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb384-1" data-line-number="1"><span class="co"># diconnect from the db</span></a>
<a class="sourceLine" id="cb384-2" data-line-number="2"> <span class="kw">dbDisconnect</span>(con)</a>
<a class="sourceLine" id="cb384-3" data-line-number="3"></a>
<a class="sourceLine" id="cb384-4" data-line-number="4"> <span class="kw">sp_docker_stop</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="cb385"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb385-1" data-line-number="1">knitr<span class="op">::</span><span class="kw">knit_exit</span>()</a></code></pre></div>
<!--chapter:end:140-sql-dplyr-joins.Rmd-->
</div>
</div>
</div>
<div id="chapter_sql-metadata-exercises" class="section level1">
<h1><span class="header-section-number">15</span> SQL Metadata exercises</h1>
<!-- 
When vendors implement such changes, their QA team performs rigorous testing before releasing the new functionality to their client base.  Their clients' IT departments also test the new functionality in their own DEV/QA environments before promoting the new functionality into their production environments.

Sometimes the vendors application doesn't quite address a customers need or a new need arises say a new government regulation.  

*  Many database vendor applictions recognize that they cannot address of all their custommers requirements and build in special user defined columns.  The business can activate a column and use it to address some business need not designed into the application.

*  Sometimes business users will a column that doesn't make sense for their business and use it anyway to address a one time business need.  

3.  The business re-purposes a column in a table and the column definition changes.  Again there is a break in the meaning of the new columns between the existing records and new records.
-->
<blockquote>
<p>This chapter demonstrates:</p>
<ul>
<li>Finding table column metadata for any specific table</li>
<li>Finding the primary and foreign keys for any specific table</li>
<li>Reusing SQL via parameterization</li>
<li>Why understanding the contents of a database requires a team approach.</li>
</ul>
</blockquote>
<p>Verify Docker is up and running:</p>
<div class="sourceCode" id="cb386"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb386-1" data-line-number="1"><span class="kw">sp_check_that_docker_is_up</span>()</a></code></pre></div>
<pre><code>## [1] &quot;Docker is up but running no containers&quot;</code></pre>
<p>Verify pet DB is available, it may be stopped.</p>
<div class="sourceCode" id="cb388"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb388-1" data-line-number="1"><span class="kw">sp_show_all_docker_containers</span>()</a></code></pre></div>
<pre><code>## CONTAINER ID        IMAGE                COMMAND                  CREATED             STATUS                     PORTS               NAMES
## ce3accea3583        postgres-dvdrental   &quot;docker-entrypoint.s…&quot;   47 seconds ago      Exited (0) 2 seconds ago                       sql-pet</code></pre>
<p>Start up the <code>docker-pet</code> container</p>
<div class="sourceCode" id="cb390"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb390-1" data-line-number="1"><span class="kw">sp_docker_start</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<p>Now connect to the database with R</p>
<div class="sourceCode" id="cb391"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb391-1" data-line-number="1"><span class="co"># need to wait for Docker &amp; Postgres to come up before connecting.</span></a>
<a class="sourceLine" id="cb391-2" data-line-number="2"></a>
<a class="sourceLine" id="cb391-3" data-line-number="3">con &lt;-<span class="st"> </span><span class="kw">sp_get_postgres_connection</span>(</a>
<a class="sourceLine" id="cb391-4" data-line-number="4">  <span class="dt">user =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_USER_NAME&quot;</span>),</a>
<a class="sourceLine" id="cb391-5" data-line-number="5">  <span class="dt">password =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_PASSWORD&quot;</span>),</a>
<a class="sourceLine" id="cb391-6" data-line-number="6">  <span class="dt">dbname =</span> <span class="st">&quot;dvdrental&quot;</span>,</a>
<a class="sourceLine" id="cb391-7" data-line-number="7">  <span class="dt">seconds_to_test =</span> <span class="dv">30</span></a>
<a class="sourceLine" id="cb391-8" data-line-number="8">)</a></code></pre></div>
<div id="table-structures" class="section level2">
<h2><span class="header-section-number">15.1</span> Table Structures</h2>
<div id="customer-columns" class="section level3">
<h3><span class="header-section-number">15.1.1</span> Customer Columns</h3>
<p>In an earlier chapter we used functions dbListTable and dbListFields from the DBI package to get a list of tables and the fields in a table. Below we list out the columns from the customer table.</p>
<div class="sourceCode" id="cb392"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb392-1" data-line-number="1"><span class="kw">dbListFields</span>(con, <span class="st">&quot;customer&quot;</span>)</a></code></pre></div>
<pre><code>##  [1] &quot;customer_id&quot; &quot;store_id&quot;    &quot;first_name&quot;  &quot;last_name&quot;   &quot;email&quot;      
##  [6] &quot;address_id&quot;  &quot;activebool&quot;  &quot;create_date&quot; &quot;last_update&quot; &quot;active&quot;</code></pre>
<p>A couple of things immediately jump out based on the column names:</p>
<ol style="list-style-type: decimal">
<li>There are three *_id columns, customer_id, store_id, and address_id. ID columns are typically an integer type. It is common convention to have the table primary key column(s) at the beginning of the table or a set of columns at the beginning of the table that make the row unique.</li>
</ol>
<ul>
<li>Just looking at the column names, one cannot tell if the customer is uniquely identified by just the customer_id or the customer_id + store_id. Are there customers who visit both stores?</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>Based on the column names, it looks like there are three string/character columns, first_name, last_name, and email.</li>
</ol>
<ul>
<li>What are the sizes of these colums?</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>There are two dates, create_date and last_update.</li>
<li>There are two active columns, <code>activebool</code> and <code>active</code>. The activebool looks like it is a boolean column. What type of column is active, integer or text?</li>
</ol>
<p>Databases maintains a data dictionary of metadata on all the database objects. SQL databases have two useful tables for getting table and table column information, <code>information_schema.tables</code> and <code>information_schema.columns</code>.</p>
<p>AS an example, the following code block returns a summary of the number of tables and views in the differnt schemas. The tables and views associated with DVD Rentals are in the public table_schema.</p>
<p>The metadata of the tables and views in the public <code>table_schema</code> are contained in the <code>information_schema</code>. The <code>information_schema</code> provides information about all of the tables, views, columns, and procedures in the entire database, not just DVD Rentals. We are interested in the <code>tables</code> and <code>columns</code> views.</p>
<div class="sourceCode" id="cb394"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb394-1" data-line-number="1">info_schema &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con</a>
<a class="sourceLine" id="cb394-2" data-line-number="2">         ,<span class="st">&quot;Select t.table_catalog</span></a>
<a class="sourceLine" id="cb394-3" data-line-number="3"><span class="st">                 ,t.table_schema</span></a>
<a class="sourceLine" id="cb394-4" data-line-number="4"><span class="st">                 ,t.table_name</span></a>
<a class="sourceLine" id="cb394-5" data-line-number="5"><span class="st">                 ,t.table_type</span></a>
<a class="sourceLine" id="cb394-6" data-line-number="6"><span class="st">             from information_schema.tables t</span></a>
<a class="sourceLine" id="cb394-7" data-line-number="7"><span class="st">            where t.table_schema = &#39;information_schema&#39;</span></a>
<a class="sourceLine" id="cb394-8" data-line-number="8"><span class="st">              and table_name in (&#39;tables&#39;,&#39;columns&#39;)</span></a>
<a class="sourceLine" id="cb394-9" data-line-number="9"><span class="st">          &quot;</span>)</a>
<a class="sourceLine" id="cb394-10" data-line-number="10"></a>
<a class="sourceLine" id="cb394-11" data-line-number="11"><span class="kw">sp_print_df</span>(info_schema)</a></code></pre></div>
<div id="htmlwidget-48ec4ad649442f3b514d" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-48ec4ad649442f3b514d">{"x":{"filter":"none","data":[["1","2"],["dvdrental","dvdrental"],["information_schema","information_schema"],["columns","tables"],["VIEW","VIEW"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>table_catalog<\/th>\n      <th>table_schema<\/th>\n      <th>table_name<\/th>\n      <th>table_type<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="table-column-metadata" class="section level2">
<h2><span class="header-section-number">15.2</span> Table Column Metadata</h2>
<p>The next code block uses the <code>information_schema.columns</code> to return column information from any table in the Dvdrental database.</p>
<ul>
<li>This code block is an example of a parameterized R function, sp_tbl_descr, sql pet table description.</li>
<li>Sp_tbl_descr uses the <code>dvdrental.information_schema.columns</code> table to return some of the metadata on a dvdrental table.</li>
<li>The function is restricted to the dvdrenatal database, see the where clause <code>and c.table_catalog = 'dvdrental'</code>.<br />
</li>
<li>The function has one parameter passed it, table_name. Parameter substitution occurs in the where clause, <code>and c.table_name = $1</code>. The paramter substituion variable syntax depends on the vendor.</li>
<li>The dbGetQuery documentation shows</li>
</ul>
<pre><code>con &lt;- dbConnect(RSQLite::SQLite(), &quot;:memory:&quot;)
dbGetQuery(con, &quot;SELECT COUNT(*) FROM mtcars WHERE cyl = ?&quot;, param = list(1:8))</code></pre>
<div id="sp_tbl_descr-parameterized-table-description-function" class="section level3">
<h3><span class="header-section-number">15.2.1</span> sp_tbl_descr – Parameterized Table Description Function</h3>
<div class="sourceCode" id="cb396"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb396-1" data-line-number="1">sp_tbl_descr &lt;-<span class="st"> </span><span class="cf">function</span> (table_name) {</a>
<a class="sourceLine" id="cb396-2" data-line-number="2"><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb396-3" data-line-number="3">       con,</a>
<a class="sourceLine" id="cb396-4" data-line-number="4">       <span class="st">&quot;select btrim(c.table_name) table_name, c.ordinal_position seq</span></a>
<a class="sourceLine" id="cb396-5" data-line-number="5"><span class="st">             , c.column_name COL_NAME</span></a>
<a class="sourceLine" id="cb396-6" data-line-number="6"><span class="st">             , case when c.udt_name = &#39;varchar&#39; </span></a>
<a class="sourceLine" id="cb396-7" data-line-number="7"><span class="st">                    then c.udt_name ||</span></a>
<a class="sourceLine" id="cb396-8" data-line-number="8"><span class="st">                         case when c.character_maximum_length is not null </span></a>
<a class="sourceLine" id="cb396-9" data-line-number="9"><span class="st">                              then &#39;(&#39;||cast(c.character_maximum_length as varchar)||&#39;)&#39;</span></a>
<a class="sourceLine" id="cb396-10" data-line-number="10"><span class="st">                              else &#39;&#39;</span></a>
<a class="sourceLine" id="cb396-11" data-line-number="11"><span class="st">                         end </span></a>
<a class="sourceLine" id="cb396-12" data-line-number="12"><span class="st">                    when c.udt_name like (&#39;int%&#39;)</span></a>
<a class="sourceLine" id="cb396-13" data-line-number="13"><span class="st">                    then c.udt_name ||&#39;-&#39;||cast(c.numeric_precision as varchar)</span></a>
<a class="sourceLine" id="cb396-14" data-line-number="14"><span class="st">                    else c.udt_name </span></a>
<a class="sourceLine" id="cb396-15" data-line-number="15"><span class="st">               end COL_TYPE</span></a>
<a class="sourceLine" id="cb396-16" data-line-number="16"><span class="st">             , c.is_nullable is_null</span></a>
<a class="sourceLine" id="cb396-17" data-line-number="17"><span class="st">--             , c.column_default</span></a>
<a class="sourceLine" id="cb396-18" data-line-number="18"><span class="st">--             , t.table_catalog</span></a>
<a class="sourceLine" id="cb396-19" data-line-number="19"><span class="st">             ,t.table_schema</span></a>
<a class="sourceLine" id="cb396-20" data-line-number="20"><span class="st">          from dvdrental.information_schema.columns c</span></a>
<a class="sourceLine" id="cb396-21" data-line-number="21"><span class="st">               join information_schema.tables t on c.table_name = t.table_name</span></a>
<a class="sourceLine" id="cb396-22" data-line-number="22"><span class="st">         where 1 = 1 </span></a>
<a class="sourceLine" id="cb396-23" data-line-number="23"><span class="st">           and c.table_catalog = &#39;dvdrental&#39; </span></a>
<a class="sourceLine" id="cb396-24" data-line-number="24"><span class="st">           and c.table_name = $1&quot;</span></a>
<a class="sourceLine" id="cb396-25" data-line-number="25">       ,table_name</a>
<a class="sourceLine" id="cb396-26" data-line-number="26">       )</a>
<a class="sourceLine" id="cb396-27" data-line-number="27">}    </a></code></pre></div>
<p>The next code block returns the customer metadata via a call to the previous function.</p>
<div class="sourceCode" id="cb397"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb397-1" data-line-number="1"><span class="kw">sp_tbl_descr</span>(<span class="st">&#39;customer&#39;</span>)</a></code></pre></div>
<pre><code>##    table_name seq    col_name    col_type is_null table_schema
## 1    customer   1 customer_id     int4-32      NO       public
## 2    customer   2    store_id     int2-16      NO       public
## 3    customer   3  first_name varchar(45)      NO       public
## 4    customer   4   last_name varchar(45)      NO       public
## 5    customer   5       email varchar(50)     YES       public
## 6    customer   6  address_id     int2-16      NO       public
## 7    customer   7  activebool        bool      NO       public
## 8    customer   8 create_date        date      NO       public
## 9    customer   9 last_update   timestamp     YES       public
## 10   customer  10      active     int4-32     YES       public</code></pre>
<p>The metadata tells us the length of the three varchar, variable length, columns. We can see that our two date columns are of different types, date and timestamp. <code>is_null=NO</code> tells us the column is required to have a value non-null value. <code>is_null=YES</code>otherwise it can be null.
The <code>activebool</code> is either true or false. Without a definitive description of the column, we will assume that the customer is active, <code>activebool=true</code> or inactive, <code>activebool=false.</code> The active column, an int4 data type, can take on a large set of values.</p>
<ul>
<li>Why would an application need two active indicators?</li>
</ul>
</div>
</div>
<div id="primary-and-foreign-key-constraints" class="section level2">
<h2><span class="header-section-number">15.3</span> Primary and Foreign Key Constraints</h2>
<p>The database or application designers implement constraints to help maintain referential integrity and improve database performance. One is the implementation of a primary key which must be unique for each row in the table. The primary key is usually defined as the first column. On occasion the primary key consists of multiple columns and none of these columns can be null.</p>
<p>Looking back to the customer columns, what is the customer table primary key, customer_id or customer_id + store_id?</p>
<p>The other constraint is a foreign key constraint which is one or more columns in one table that make up a primary key in another table.</p>
<p>From the DVD Rental ERD, <a href="https://www.postgresqltutorial.com/postgresql-sample-database">here</a>, one can see that out of the 15 tables in the ERD, all but two tables have a single column primary key, film_category and the film_actor tables have two columns that define the primary key. The primary key columns have an asterisk to the left of the column name. For the single column keys, the primary key column is the name of the table suffixed with <code>_id.</code></p>
<p>The customer primary key is just customer_id column.</p>
<p>Is the customer.store_id a foreign key to the store table? Based on ERD, the customer.store_id is not a foreign key to the store table.</p>
<p>The next code block uses many <code>information_schema</code> objects to return a table’s primary and foreign keys for any table in the Dvdrental database.</p>
<ul>
<li>This code block is another example of a parameterized R function, sp_tbl_pk_fk, sql pet table primary key and foreign keys.</li>
<li>Not all tables are required to have a primary key. If a table has one
<ul>
<li>The function returns one or more columns that make up the table primary key.<br />
</li>
<li>The function also returns any other table that has a foreign key reference to the table.</li>
</ul></li>
<li>The function is restricted to the Dvdrenatal database, see the where clause <code>and c.table_catalog = 'dvdrental'</code>.<br />
</li>
<li>The function is restricted to the public schema where the Dvd rental table/views are kept, see the where clause c.table_schema = ‘public’.</li>
<li>The function has one parameter passed it, table_name. Parameter substitution occurs in the where clause, <code>AND (c.table_name = $1 or coalesce(c2.table_name, '') = $1)</code>. The paramter substituion occurs to see if the table_name passed has a primary key or refereced as a foreign table.</li>
</ul>
<div id="sp_tbl_pk_fk-parameterized-table-primary-foreign-keys-function" class="section level3">
<h3><span class="header-section-number">15.3.1</span> sp_tbl_pk_fk – Parameterized Table Primary Foreign Key(s) Function</h3>
<div class="sourceCode" id="cb399"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb399-1" data-line-number="1">sp_tbl_pk_fk_sql &lt;-<span class="st"> </span><span class="cf">function</span>(table_name) {</a>
<a class="sourceLine" id="cb399-2" data-line-number="2">    <span class="kw">dbGetQuery</span>(con</a>
<a class="sourceLine" id="cb399-3" data-line-number="3">              ,<span class="st">&quot;SELECT c.table_name</span></a>
<a class="sourceLine" id="cb399-4" data-line-number="4"><span class="st">                      ,kcu.column_name</span></a>
<a class="sourceLine" id="cb399-5" data-line-number="5"><span class="st">                      ,c.constraint_name</span></a>
<a class="sourceLine" id="cb399-6" data-line-number="6"><span class="st">                      ,c.constraint_type</span></a>
<a class="sourceLine" id="cb399-7" data-line-number="7"><span class="st">                      ,coalesce(c2.table_name, &#39;&#39;) ref_table</span></a>
<a class="sourceLine" id="cb399-8" data-line-number="8"><span class="st">                      ,coalesce(kcu2.column_name, &#39;&#39;) ref_table_col</span></a>
<a class="sourceLine" id="cb399-9" data-line-number="9"><span class="st">                  FROM information_schema.tables t</span></a>
<a class="sourceLine" id="cb399-10" data-line-number="10"><span class="st">                       LEFT JOIN information_schema.table_constraints c</span></a>
<a class="sourceLine" id="cb399-11" data-line-number="11"><span class="st">                         ON t.table_catalog = c.table_catalog</span></a>
<a class="sourceLine" id="cb399-12" data-line-number="12"><span class="st">                        AND t.table_schema = c.table_schema</span></a>
<a class="sourceLine" id="cb399-13" data-line-number="13"><span class="st">                        AND t.table_name = c.table_name</span></a>
<a class="sourceLine" id="cb399-14" data-line-number="14"><span class="st">                       LEFT JOIN information_schema.key_column_usage kcu</span></a>
<a class="sourceLine" id="cb399-15" data-line-number="15"><span class="st">                         ON c.constraint_schema = kcu.constraint_schema</span></a>
<a class="sourceLine" id="cb399-16" data-line-number="16"><span class="st">                        AND c.constraint_name = kcu.constraint_name</span></a>
<a class="sourceLine" id="cb399-17" data-line-number="17"><span class="st">                       LEFT JOIN information_schema.referential_constraints rc</span></a>
<a class="sourceLine" id="cb399-18" data-line-number="18"><span class="st">                         ON c.constraint_schema = rc.constraint_schema</span></a>
<a class="sourceLine" id="cb399-19" data-line-number="19"><span class="st">                        AND c.constraint_name = rc.constraint_name</span></a>
<a class="sourceLine" id="cb399-20" data-line-number="20"><span class="st">                       LEFT JOIN information_schema.table_constraints c2</span></a>
<a class="sourceLine" id="cb399-21" data-line-number="21"><span class="st">                         ON rc.unique_constraint_schema = c2.constraint_schema</span></a>
<a class="sourceLine" id="cb399-22" data-line-number="22"><span class="st">                        AND rc.unique_constraint_name = c2.constraint_name</span></a>
<a class="sourceLine" id="cb399-23" data-line-number="23"><span class="st">                       LEFT JOIN information_schema.key_column_usage kcu2</span></a>
<a class="sourceLine" id="cb399-24" data-line-number="24"><span class="st">                         ON c2.constraint_schema = kcu2.constraint_schema</span></a>
<a class="sourceLine" id="cb399-25" data-line-number="25"><span class="st">                        AND c2.constraint_name = kcu2.constraint_name</span></a>
<a class="sourceLine" id="cb399-26" data-line-number="26"><span class="st">                        AND kcu.ordinal_position = kcu2.ordinal_position</span></a>
<a class="sourceLine" id="cb399-27" data-line-number="27"><span class="st">                 WHERE c.constraint_type IN (&#39;PRIMARY KEY&#39;, &#39;FOREIGN KEY&#39;)</span></a>
<a class="sourceLine" id="cb399-28" data-line-number="28"><span class="st">                   AND c.table_catalog = &#39;dvdrental&#39;</span></a>
<a class="sourceLine" id="cb399-29" data-line-number="29"><span class="st">                   AND c.table_schema = &#39;public&#39;</span></a>
<a class="sourceLine" id="cb399-30" data-line-number="30"><span class="st">                   AND (c.table_name = $1 or coalesce(c2.table_name, &#39;&#39;) = $1)</span></a>
<a class="sourceLine" id="cb399-31" data-line-number="31"><span class="st">               ORDER BY c.table_name,c.constraint_type desc&quot;</span></a>
<a class="sourceLine" id="cb399-32" data-line-number="32">              ,<span class="dt">param =</span> <span class="kw">list</span>(table_name)</a>
<a class="sourceLine" id="cb399-33" data-line-number="33">              )</a>
<a class="sourceLine" id="cb399-34" data-line-number="34">}</a></code></pre></div>
</div>
<div id="customer-primary-and-foreign-key-constraints" class="section level3">
<h3><span class="header-section-number">15.3.2</span> Customer primary and foreign key constraints</h3>
<p>The next code block returns the customer primary and foreign key metadata via a call to the previous function.</p>
<div class="sourceCode" id="cb400"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb400-1" data-line-number="1"><span class="kw">sp_tbl_pk_fk_sql</span>(<span class="st">&#39;customer&#39;</span>)</a></code></pre></div>
<pre><code>##   table_name column_name          constraint_name constraint_type
## 1   customer customer_id            customer_pkey     PRIMARY KEY
## 2   customer  address_id customer_address_id_fkey     FOREIGN KEY
## 3    payment customer_id payment_customer_id_fkey     FOREIGN KEY
## 4     rental customer_id  rental_customer_id_fkey     FOREIGN KEY
##   ref_table ref_table_col
## 1                        
## 2   address    address_id
## 3  customer   customer_id
## 4  customer   customer_id</code></pre>
<p>The table above tells us:</p>
<ol style="list-style-type: decimal">
<li>The customer has customer_id as the primary key which matches the ERD.</li>
<li>The customer address_id is a foreign key to the address table, the ref_table column and joins on the ref_table_col, address_id.</li>
<li>The payment and rental tables have customer_id as a foreign key back to the customer table.</li>
</ol>
<p>The ERD matches the Primary and Foreign Key information in the table above.</p>
</div>
</div>
<div id="we-need-documentation-andor-a-dba." class="section level2">
<h2><span class="header-section-number">15.4</span> We need documentation and/or a DBA.</h2>
<p>The output above shows that the store_id column is not part of the customer primary key and it isn’t foreign key to the store table.</p>
<p>Some possible explanations are:</p>
<ol style="list-style-type: decimal">
<li>The ERD is incomplete or it excluded some foreign keys to highlight other relationships.</li>
<li>The SQL above is wrong.</li>
<li>The customer-store foreign key constraint was just missed. On large systems this is not out of the realm of possibilities.</li>
<li>The customer-store foreign key constraint was diabled.</li>
<li>The customer-store foreign key constraint was designed out of the system.</li>
</ol>
<p>The DBA team or project documentation may help explain</p>
<ul>
<li>The true relation between the customer and store tables.<br />
</li>
<li>Why there are two customer active columns, activebool and active.</li>
</ul>
<p>Some possible explanation for the two active columns are:</p>
<ol style="list-style-type: decimal">
<li>The application vendor adds new functionality resulting in</li>
</ol>
<ul>
<li>new columns being added to a table</li>
<li>dropping a table and migrating the old data into one or more new tables</li>
<li>splitting a table into one or more tables</li>
<li>Sometimes applications are migrated from one vendor’s RDBMS to a different vedor’s RDBMS which usually introduces some kind of incompatability.</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>A company has its own DBA’s add columns to a table to reflect new business requirements.</li>
</ol>
<ul>
<li>All the existing records are updated to reconstruct the new data for the new columns or</li>
<li>All the existing columns are defaulted to a single value. There is a break in the meaning of the new columns between the existing records and new records.</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>The business DBA’s add new columns are added to tables to reflect some new business requirements. New columns are typically added to the end of the table. If a table is wide and the new column is at the end, it is very easy to miss the new column when having to scroll across the screen to find it.</li>
</ol>
<p>See figure 1 <a href="https://dev.mysql.com/doc/sakila/en/sakila-structure.html">here</a> for another ERD. What does this ERD tell us about the relationship between the customer and store tables?</p>
<p>See the customer table column description <a href="https://dev.mysql.com/doc/sakila/en/sakila-structure-tables-customer.html">here</a>. What can we learn about the active column from this link?</p>
<div id="other-table-column-metadata" class="section level3">
<h3><span class="header-section-number">15.4.1</span> Other Table Column Metadata</h3>
<p>In the next code block, change the function parameter to different table names to get the associated column metadata. If necessary, uncomment the dbListTable line to get a list of table names.</p>
<div class="sourceCode" id="cb402"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb402-1" data-line-number="1"><span class="co">#dbListTables(con)</span></a>
<a class="sourceLine" id="cb402-2" data-line-number="2"><span class="kw">sp_tbl_descr</span>(<span class="st">&#39;customer&#39;</span>)</a></code></pre></div>
<pre><code>##    table_name seq    col_name    col_type is_null table_schema
## 1    customer   1 customer_id     int4-32      NO       public
## 2    customer   2    store_id     int2-16      NO       public
## 3    customer   3  first_name varchar(45)      NO       public
## 4    customer   4   last_name varchar(45)      NO       public
## 5    customer   5       email varchar(50)     YES       public
## 6    customer   6  address_id     int2-16      NO       public
## 7    customer   7  activebool        bool      NO       public
## 8    customer   8 create_date        date      NO       public
## 9    customer   9 last_update   timestamp     YES       public
## 10   customer  10      active     int4-32     YES       public</code></pre>
</div>
<div id="other-table-pk-fk" class="section level3">
<h3><span class="header-section-number">15.4.2</span> Other Table PK FK</h3>
<p>In the next code block, change the function parameter to different table names to get the associated PK and FK associated wih the table.</p>
<div class="sourceCode" id="cb404"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb404-1" data-line-number="1"><span class="co">#dbListTables(con)</span></a>
<a class="sourceLine" id="cb404-2" data-line-number="2"><span class="kw">sp_tbl_pk_fk_sql</span>(<span class="st">&#39;customer&#39;</span>)</a></code></pre></div>
<pre><code>##   table_name column_name          constraint_name constraint_type
## 1   customer customer_id            customer_pkey     PRIMARY KEY
## 2   customer  address_id customer_address_id_fkey     FOREIGN KEY
## 3    payment customer_id payment_customer_id_fkey     FOREIGN KEY
## 4     rental customer_id  rental_customer_id_fkey     FOREIGN KEY
##   ref_table ref_table_col
## 1                        
## 2   address    address_id
## 3  customer   customer_id
## 4  customer   customer_id</code></pre>
<!--chapter:end:150-sql-joins-exercises.Rmd-->
</div>
</div>
</div>
<div id="chapter_sql-joins-exercises" class="section level1">
<h1><span class="header-section-number">16</span> SQL Joins exercises</h1>
<pre><code>&gt; This chapter contains questions one may be curious about or asked about the DVD Rental business.  
&gt; The goal of the exercises is extracting useful or questionable insights from one or more tables.   Each exercise has has some or all of the following parts.</code></pre>
<blockquote>
<ol style="list-style-type: decimal">
<li>The question.</li>
<li>The tables used to answer the question.</li>
<li>A hidden SQL code block showing the desired output. Click the code button to see the SQL code.<br />
</li>
<li>A table of derived values or renamed columns shown in the SQL block to facilitate replicating the desired dplyr solution. Abbreviated column names are used to squeeze in more columns into the answer to reduce scrolling across the screen.</li>
<li>A replication section where you recreate the desired output using dplyr syntax. Most columns come directly out of the tables. Each replication code block has three commented function calls</li>
</ol>
<ul>
<li>sp_tbl_descr(‘store’) –describes a table, store</li>
<li>sp_tbl_pk_fk(‘table_name’) –shows a table’s primary and foreign keys</li>
<li>sp_print_df(table_rows_sql) –shows table row counts.</li>
</ul>
<ol start="6" style="list-style-type: decimal">
<li>To keep the exercises concentrated on the joins, all derived dates drop their timestamp.
<ul>
<li>SQL syntax: date_column::DATE</li>
<li>Dplyr syntax: as.date(date_colun)</li>
</ul></li>
</ol>
</blockquote>
</div>
<div id="exercise-instructions" class="section level1">
<h1><span class="header-section-number">17</span> Exercise Instructions</h1>
<ol style="list-style-type: decimal">
<li>Manually execute all the code blocks up-to the “SQL Union Exercise.”<br />
</li>
<li>Most of the exercises can be performed in any order.<br />
</li>
</ol>
<ul>
<li>There are function exercises that create a function followed by another code block to call the function in the previous exercise.</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>Use the Show Document Outline, CTL-Shift-O, to navigate to the different exercises.</li>
</ol>
<p>Verify Docker is up and running:</p>
<div class="sourceCode" id="cb407"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb407-1" data-line-number="1"><span class="kw">sp_check_that_docker_is_up</span>()</a></code></pre></div>
<pre><code>## [1] &quot;Docker is up, running these containers:&quot;                                                                                                     
## [2] &quot;CONTAINER ID        IMAGE                COMMAND                  CREATED             STATUS              PORTS                    NAMES&quot;    
## [3] &quot;ce3accea3583        postgres-dvdrental   \&quot;docker-entrypoint.s…\&quot;   51 seconds ago      Up 3 seconds        0.0.0.0:5432-&gt;5432/tcp   sql-pet&quot;</code></pre>
<p>Verify pet DB is available, it may be stopped.</p>
<div class="sourceCode" id="cb409"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb409-1" data-line-number="1"><span class="kw">sp_show_all_docker_containers</span>()</a></code></pre></div>
<pre><code>## CONTAINER ID        IMAGE                COMMAND                  CREATED             STATUS              PORTS                    NAMES
## ce3accea3583        postgres-dvdrental   &quot;docker-entrypoint.s…&quot;   51 seconds ago      Up 3 seconds        0.0.0.0:5432-&gt;5432/tcp   sql-pet</code></pre>
<p>Start up the <code>docker-pet</code> container</p>
<div class="sourceCode" id="cb411"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb411-1" data-line-number="1"><span class="kw">sp_docker_start</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<p>Now connect to the database with R</p>
<div class="sourceCode" id="cb412"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb412-1" data-line-number="1"><span class="co"># need to wait for Docker &amp; Postgres to come up before connecting.</span></a>
<a class="sourceLine" id="cb412-2" data-line-number="2"></a>
<a class="sourceLine" id="cb412-3" data-line-number="3">con &lt;-<span class="st"> </span><span class="kw">sp_get_postgres_connection</span>(</a>
<a class="sourceLine" id="cb412-4" data-line-number="4">  <span class="dt">user =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_USER_NAME&quot;</span>),</a>
<a class="sourceLine" id="cb412-5" data-line-number="5">  <span class="dt">password =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_PASSWORD&quot;</span>),</a>
<a class="sourceLine" id="cb412-6" data-line-number="6">  <span class="dt">dbname =</span> <span class="st">&quot;dvdrental&quot;</span>,</a>
<a class="sourceLine" id="cb412-7" data-line-number="7">  <span class="dt">seconds_to_test =</span> <span class="dv">30</span></a>
<a class="sourceLine" id="cb412-8" data-line-number="8">)</a></code></pre></div>
</div>
<div id="dplyr-tables" class="section level1">
<h1><span class="header-section-number">18</span> Dplyr tables</h1>
<p>All the tables defined in the DVD Rental System will fit into memory which is rarely the case when working with a database. Each table is loaded into an R object named TableName_table, via a DBI::dbReadTable call.</p>
<ul>
<li>actor_table &lt;- DBI::dbReadTable(con,“actor”)</li>
</ul>
<div class="sourceCode" id="cb413"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb413-1" data-line-number="1"><span class="kw">source</span>(<span class="kw">here</span>(<span class="st">&#39;book-src&#39;</span>, <span class="st">&#39;dvdrental-table-declarations.R&#39;</span>),<span class="dt">echo=</span><span class="ot">FALSE</span>)</a></code></pre></div>
<p>The following code block deletes and inserts records into the different tables used in the exercises in this chpater. The techniques used in this code block are discussed in detail in the appendix, ??add link here.??</p>
<div class="sourceCode" id="cb414"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb414-1" data-line-number="1"><span class="kw">source</span>(<span class="dt">file=</span><span class="kw">here</span>(<span class="st">&#39;book-src&#39;</span>, <span class="st">&#39;sql_pet_data.R&#39;</span>),<span class="dt">echo=</span><span class="ot">FALSE</span>)</a></code></pre></div>
</div>
<div id="sql-union-exercise" class="section level1">
<h1><span class="header-section-number">19</span> SQL Union Exercise</h1>
<p>When joining many tables, it is helpful to have the number of rows from each table as an initial sanity check that the joins are returning a reasonable number of rows.</p>
<div id="how-many-rows-are-in-each-table" class="section level2">
<h2><span class="header-section-number">19.1</span> 1. How many rows are in each table?</h2>
<div class="sourceCode" id="cb415"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb415-1" data-line-number="1">table_rows_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb415-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb415-3" data-line-number="3">  <span class="st">&quot;select *</span></a>
<a class="sourceLine" id="cb415-4" data-line-number="4"><span class="st">                 from (      select &#39;actor&#39; tbl_name,count(*) from actor </span></a>
<a class="sourceLine" id="cb415-5" data-line-number="5"><span class="st">                       union select &#39;category&#39; tbl_name,count(*) from category</span></a>
<a class="sourceLine" id="cb415-6" data-line-number="6"><span class="st">                       union select &#39;film&#39; tbl_name,count(*) from film</span></a>
<a class="sourceLine" id="cb415-7" data-line-number="7"><span class="st">                       union select &#39;film_actor&#39; tbl_name,count(*) from film_actor</span></a>
<a class="sourceLine" id="cb415-8" data-line-number="8"><span class="st">                       union select &#39;film_category&#39; tbl_name,count(*) from film_category</span></a>
<a class="sourceLine" id="cb415-9" data-line-number="9"><span class="st">                       union select &#39;language&#39; tbl_name,count(*) from language</span></a>
<a class="sourceLine" id="cb415-10" data-line-number="10"><span class="st">                       union select &#39;inventory&#39; tbl_name,count(*) from inventory</span></a>
<a class="sourceLine" id="cb415-11" data-line-number="11"><span class="st">                       union select &#39;rental&#39; tbl_name,count(*) from rental</span></a>
<a class="sourceLine" id="cb415-12" data-line-number="12"><span class="st">                       union select &#39;payment&#39; tbl_name,count(*) from payment</span></a>
<a class="sourceLine" id="cb415-13" data-line-number="13"><span class="st">                       union select &#39;staff&#39; tbl_name,count(*) from staff</span></a>
<a class="sourceLine" id="cb415-14" data-line-number="14"><span class="st">                       union select &#39;customer&#39; tbl_name,count(*) from customer</span></a>
<a class="sourceLine" id="cb415-15" data-line-number="15"><span class="st">                       union select &#39;address&#39; tbl_name,count(*) from address</span></a>
<a class="sourceLine" id="cb415-16" data-line-number="16"><span class="st">                       union select &#39;city&#39; tbl_name,count(*) from city</span></a>
<a class="sourceLine" id="cb415-17" data-line-number="17"><span class="st">                       union select &#39;country&#39; tbl_name,count(*) from country</span></a>
<a class="sourceLine" id="cb415-18" data-line-number="18"><span class="st">                       union select &#39;store&#39; tbl_name,count(*) from store</span></a>
<a class="sourceLine" id="cb415-19" data-line-number="19"><span class="st">                       ) counts</span></a>
<a class="sourceLine" id="cb415-20" data-line-number="20"><span class="st">                  order by tbl_name</span></a>
<a class="sourceLine" id="cb415-21" data-line-number="21"><span class="st">                 ;</span></a>
<a class="sourceLine" id="cb415-22" data-line-number="22"><span class="st">                &quot;</span></a>
<a class="sourceLine" id="cb415-23" data-line-number="23">)</a>
<a class="sourceLine" id="cb415-24" data-line-number="24"><span class="kw">sp_print_df</span>(table_rows_sql)</a></code></pre></div>
<div id="htmlwidget-1d9f9b9fdca3023baa83" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1d9f9b9fdca3023baa83">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15"],["actor","address","category","city","country","customer","film","film_actor","film_category","inventory","language","payment","rental","staff","store"],[200,603,16,600,109,604,1001,5462,1002,4583,6,14596,16045,2,3]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>tbl_name<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":2},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div id="replicate-the-output-above-using-dplyr-syntax." class="section level4">
<h4><span class="header-section-number">19.1.0.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb416"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb416-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb416-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb416-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb416-4" data-line-number="4"></a>
<a class="sourceLine" id="cb416-5" data-line-number="5">table_rows_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb416-6" data-line-number="6"></a>
<a class="sourceLine" id="cb416-7" data-line-number="7"><span class="kw">sp_print_df</span>(table_rows_dplyr)</a></code></pre></div>
<div id="htmlwidget-b18b48ec4ad649442f3b" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-b18b48ec4ad649442f3b">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</div>
<div id="exercises-1" class="section level1">
<h1><span class="header-section-number">20</span> Exercises</h1>
<div id="where-is-the-dvd-rental-business-located" class="section level2">
<h2><span class="header-section-number">20.1</span> 1. Where is the DVD Rental Business located?</h2>
<p>To answer this question we look at the <code>store</code>, <code>address</code>, <code>city</code>, and <code>country</code> tables to answer this question.</p>
<div class="sourceCode" id="cb417"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb417-1" data-line-number="1">store_locations_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb417-2" data-line-number="2"><span class="st">&quot;select s.store_id</span></a>
<a class="sourceLine" id="cb417-3" data-line-number="3"><span class="st">       ,a.address</span></a>
<a class="sourceLine" id="cb417-4" data-line-number="4"><span class="st">       ,c.city</span></a>
<a class="sourceLine" id="cb417-5" data-line-number="5"><span class="st">       ,a.district</span></a>
<a class="sourceLine" id="cb417-6" data-line-number="6"><span class="st">       ,a.postal_code</span></a>
<a class="sourceLine" id="cb417-7" data-line-number="7"><span class="st">       ,c2.country</span></a>
<a class="sourceLine" id="cb417-8" data-line-number="8"><span class="st">       ,s.last_update</span></a>
<a class="sourceLine" id="cb417-9" data-line-number="9"><span class="st">   from store s </span></a>
<a class="sourceLine" id="cb417-10" data-line-number="10"><span class="st">         join address a on s.address_id = a.address_id</span></a>
<a class="sourceLine" id="cb417-11" data-line-number="11"><span class="st">         join city c on a.city_id = c.city_id</span></a>
<a class="sourceLine" id="cb417-12" data-line-number="12"><span class="st">         join country c2 on c.country_id = c2.country_id</span></a>
<a class="sourceLine" id="cb417-13" data-line-number="13"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb417-14" data-line-number="14"><span class="kw">sp_print_df</span>(store_locations_sql)</a></code></pre></div>
<div id="htmlwidget-514d280a38cf86ead40b" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-514d280a38cf86ead40b">{"x":{"filter":"none","data":[["1","2","3"],[1,2,10],["47 MySakila Drive","28 MySQL Boulevard","1795 Santiago de Compostela Way"],["Lethbridge","Woodridge","Laredo"],["Alberta","QLD","Texas"],["","","18743"],["Canada","Australia","United States"],["2006-02-15T17:57:12Z","2006-02-15T17:57:12Z","2019-03-04T02:21:47Z"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>store_id<\/th>\n      <th>address<\/th>\n      <th>city<\/th>\n      <th>district<\/th>\n      <th>postal_code<\/th>\n      <th>country<\/th>\n      <th>last_update<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":1},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>Our DVD Rental business is international and operates in three countries, Canada, Austraila, and the United States. Each country has one store.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-1" class="section level4">
<h4><span class="header-section-number">20.1.0.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb418"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb418-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb418-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb418-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb418-4" data-line-number="4"></a>
<a class="sourceLine" id="cb418-5" data-line-number="5">store_locations_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb418-6" data-line-number="6"></a>
<a class="sourceLine" id="cb418-7" data-line-number="7"><span class="kw">sp_print_df</span>(store_locations_dplyr)</a></code></pre></div>
<div id="htmlwidget-74434d812ec23342fdce" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-74434d812ec23342fdce">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="list-each-store-and-the-staff-contact-information" class="section level3">
<h3><span class="header-section-number">20.1.1</span> 2. List Each Store and the Staff Contact Information?</h3>
<p>To answer this question we look at the <code>store</code>, <code>staff</code>, <code>address</code>, <code>city</code>, and <code>country</code> tables.</p>
<div class="sourceCode" id="cb419"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb419-1" data-line-number="1">store_employees_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb419-2" data-line-number="2"><span class="st">&quot;select st.store_id</span></a>
<a class="sourceLine" id="cb419-3" data-line-number="3"><span class="st">       ,s.first_name</span></a>
<a class="sourceLine" id="cb419-4" data-line-number="4"><span class="st">       ,s.last_name</span></a>
<a class="sourceLine" id="cb419-5" data-line-number="5"><span class="st">       ,s.email</span></a>
<a class="sourceLine" id="cb419-6" data-line-number="6"><span class="st">       ,a.phone</span></a>
<a class="sourceLine" id="cb419-7" data-line-number="7"><span class="st">       ,a.address</span></a>
<a class="sourceLine" id="cb419-8" data-line-number="8"><span class="st">       ,c.city</span></a>
<a class="sourceLine" id="cb419-9" data-line-number="9"><span class="st">       ,a.district</span></a>
<a class="sourceLine" id="cb419-10" data-line-number="10"><span class="st">       ,a.postal_code</span></a>
<a class="sourceLine" id="cb419-11" data-line-number="11"><span class="st">       ,c2.country</span></a>
<a class="sourceLine" id="cb419-12" data-line-number="12"><span class="st">   from store st left join staff s on st.manager_staff_id = s.staff_id </span></a>
<a class="sourceLine" id="cb419-13" data-line-number="13"><span class="st">         left join address a on s.address_id = a.address_id</span></a>
<a class="sourceLine" id="cb419-14" data-line-number="14"><span class="st">         left join city c on a.city_id = c.city_id</span></a>
<a class="sourceLine" id="cb419-15" data-line-number="15"><span class="st">         left join country c2 on c.country_id = c2.country_id</span></a>
<a class="sourceLine" id="cb419-16" data-line-number="16"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb419-17" data-line-number="17"><span class="kw">sp_print_df</span>(store_employees_sql)</a></code></pre></div>
<div id="htmlwidget-8da54f9f5480ad7c3ec3" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-8da54f9f5480ad7c3ec3">{"x":{"filter":"none","data":[["1","2","3"],[1,2,10],["Mike","Jon",null],["Hillyer","Stephens",null],["Mike.Hillyer@sakilastaff.com","Jon.Stephens@sakilastaff.com",null],["14033335568","6172235589",null],["23 Workhaven Lane","1411 Lillydale Drive",null],["Lethbridge","Woodridge",null],["Alberta","QLD",null],["","",null],["Canada","Australia",null]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>store_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>email<\/th>\n      <th>phone<\/th>\n      <th>address<\/th>\n      <th>city<\/th>\n      <th>district<\/th>\n      <th>postal_code<\/th>\n      <th>country<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":1},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>Our DVD Rental business is international and operates in three countries, Canada, Austraila, and the United States. Each country has one store. The stores in Canada and Austrailia have one employee each, Mike Hillyer and Jon Stephens respectively. The store in the United States has no employees yet.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-2" class="section level4">
<h4><span class="header-section-number">20.1.1.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb420"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb420-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb420-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb420-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb420-4" data-line-number="4"></a>
<a class="sourceLine" id="cb420-5" data-line-number="5">store_employees_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb420-6" data-line-number="6"></a>
<a class="sourceLine" id="cb420-7" data-line-number="7"><span class="kw">sp_print_df</span>(store_employees_dplyr)</a></code></pre></div>
<div id="htmlwidget-124fb78127817ec02cd9" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-124fb78127817ec02cd9">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="how-many-active-inactive-and-total-customers-does-the-dvd-rental-business-have" class="section level3">
<h3><span class="header-section-number">20.1.2</span> 3. How Many Active, Inactive, and Total Customers Does the DVD Rental Business Have?</h3>
<p>To answer this question we look at the <code>customer</code> table. In a previous chapter we observed that there are two columns, <code>activebool</code> and <code>active</code>. We consider <code>active = 1</code> as active.</p>
<div class="sourceCode" id="cb421"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb421-1" data-line-number="1">customer_cnt_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb421-2" data-line-number="2"><span class="st">&quot;SELECT sum(case when active = 1 then 1 else 0 end) active</span></a>
<a class="sourceLine" id="cb421-3" data-line-number="3"><span class="st">       ,sum(case when active = 0 then 1 else 0 end) inactive</span></a>
<a class="sourceLine" id="cb421-4" data-line-number="4"><span class="st">       ,count(*) total</span></a>
<a class="sourceLine" id="cb421-5" data-line-number="5"><span class="st">   from customer</span></a>
<a class="sourceLine" id="cb421-6" data-line-number="6"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb421-7" data-line-number="7"></a>
<a class="sourceLine" id="cb421-8" data-line-number="8"><span class="kw">sp_print_df</span>(customer_cnt_sql)</a></code></pre></div>
<div id="htmlwidget-dd0a51033db44e820d90" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-dd0a51033db44e820d90">{"x":{"filter":"none","data":[["1"],[589],[15],[604]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>active<\/th>\n      <th>inactive<\/th>\n      <th>total<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>
Our DVD Rental business is international and operates in three countries, Canada, Austraila, and the United States. Each country has one store. The stores in Canada and Austrailia have one employee each. The store in the United States has no employees yet.</p>
<p>The business has 604 international customers, 589 are active and 15 inactive.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-3" class="section level4">
<h4><span class="header-section-number">20.1.2.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb422"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb422-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb422-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb422-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb422-4" data-line-number="4"></a>
<a class="sourceLine" id="cb422-5" data-line-number="5">customer_cnt_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb422-6" data-line-number="6"></a>
<a class="sourceLine" id="cb422-7" data-line-number="7"><span class="kw">sp_print_df</span>(customer_cnt_dplyr)</a></code></pre></div>
<div id="htmlwidget-1fe403c81784621152ab" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1fe403c81784621152ab">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="how-many-and-what-percent-of-customers-are-from-each-country" class="section level3">
<h3><span class="header-section-number">20.1.3</span> 4. How Many and What Percent of Customers Are From Each Country?</h3>
<p>To answer this question we look at the <code>customer</code>, <code>address</code>, <code>city</code>, and <code>country</code> tables.</p>
<div class="sourceCode" id="cb423"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb423-1" data-line-number="1">customers_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb423-2" data-line-number="2"><span class="st">&quot;select c.active,country.country,count(*) count</span></a>
<a class="sourceLine" id="cb423-3" data-line-number="3"><span class="st">              ,round(100 * count(*) / sum(count(*)) over(),4) as pct</span></a>
<a class="sourceLine" id="cb423-4" data-line-number="4"><span class="st">         from customer c</span></a>
<a class="sourceLine" id="cb423-5" data-line-number="5"><span class="st">              join address a on c.address_id = a.address_id</span></a>
<a class="sourceLine" id="cb423-6" data-line-number="6"><span class="st">              join city  on a.city_id = city.city_id</span></a>
<a class="sourceLine" id="cb423-7" data-line-number="7"><span class="st">              join country on city.country_id = country.country_id</span></a>
<a class="sourceLine" id="cb423-8" data-line-number="8"><span class="st">         group by c.active,country</span></a>
<a class="sourceLine" id="cb423-9" data-line-number="9"><span class="st">order by count(*) desc</span></a>
<a class="sourceLine" id="cb423-10" data-line-number="10"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb423-11" data-line-number="11"><span class="kw">sp_print_df</span>(customers_sql)</a></code></pre></div>
<div id="htmlwidget-ed78248b32e6634f28e5" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-ed78248b32e6634f28e5">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118"],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,0,0,1,1,0,1,1,1,0,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0],["India","China","United States","Japan","Mexico","Brazil","Russian Federation","Philippines","Indonesia","Turkey","Argentina","Nigeria","South Africa","Taiwan","United Kingdom","Canada","Poland","Germany","Venezuela","Italy","Iran","Ukraine","Colombia","Egypt","Vietnam","Pakistan","Spain","Netherlands","Saudi Arabia","South Korea","Peru","France","Yemen","Malaysia","Morocco","Austria","China","India","Dominican Republic","Chile","United Arab Emirates","Thailand","Algeria","Bangladesh","Israel","Mozambique","Paraguay","Ecuador","Switzerland","Tanzania","Angola","Cambodia","Bolivia","Australia","Romania","Yugoslavia","Bulgaria","Latvia","Oman","Puerto Rico","Congo, The Democratic Republic of the","Kenya","Belarus","Sudan","Cameroon","Kazakstan","Azerbaijan","Myanmar","Greece","French Polynesia","Madagascar","Turkey","Saint Vincent and the Grenadines","Armenia","Gambia","Slovakia","North Korea","Malawi","Sri Lanka","Bahrain","Nauru","Moldova","Finland","Kuwait","Estonia","Hong Kong","Lithuania","Tonga","United Kingdom","Tunisia","American Samoa","Israel","Mexico","Sweden","New Zealand","Iran","Brunei","Greenland","Runion","Virgin Islands, U.S.","Nepal","Zambia","Ethiopia","Hungary","Poland","Chad","French Guiana","Faroe Islands","Turkmenistan","Czech Republic","Anguilla","Iraq","Holy See (Vatican City State)","Senegal","Tuvalu","Liechtenstein","Afghanistan","Russian Federation"],[57,50,36,31,29,28,27,20,14,14,13,13,11,10,8,8,7,7,7,7,7,6,6,6,6,5,5,5,5,5,4,4,4,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[9.4371,8.2781,5.9603,5.1325,4.8013,4.6358,4.4702,3.3113,2.3179,2.3179,2.1523,2.1523,1.8212,1.6556,1.3245,1.3245,1.1589,1.1589,1.1589,1.1589,1.1589,0.9934,0.9934,0.9934,0.9934,0.8278,0.8278,0.8278,0.8278,0.8278,0.6623,0.6623,0.6623,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>active<\/th>\n      <th>country<\/th>\n      <th>count<\/th>\n      <th>pct<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>
Based on the table above, the DVD Rental business has customers in 118 countries. The DVD Rental business cannot have many walk in customers. It may possibly use a mail order distribution model.</p>
<p>For an international company, how are the different currencies converted to a standard currency? Looking at the ERD, there is no currency conversion rate.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-4" class="section level4">
<h4><span class="header-section-number">20.1.3.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb424"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb424-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb424-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb424-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb424-4" data-line-number="4"></a>
<a class="sourceLine" id="cb424-5" data-line-number="5">customers_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb424-6" data-line-number="6"></a>
<a class="sourceLine" id="cb424-7" data-line-number="7"><span class="kw">sp_print_df</span>(customers_dplyr)</a></code></pre></div>
<div id="htmlwidget-2ae622211a824c064fbd" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-2ae622211a824c064fbd">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="what-countries-constitute-the-top-25-of-the-customer-base" class="section level3">
<h3><span class="header-section-number">20.1.4</span> 5 What Countries Constitute the Top 25% of the Customer Base?</h3>
<p>Using the previous code, add two new columns. One column shows a running total and the second column shows a running percentage. Order the data by count then by country.</p>
<p>To answer this question we look at the <code>customer</code>, <code>address</code>, <code>city</code>, and <code>country</code> tables again.</p>
<div class="sourceCode" id="cb425"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb425-1" data-line-number="1">country_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb425-2" data-line-number="2">                            </a>
<a class="sourceLine" id="cb425-3" data-line-number="3"><span class="st">&quot;select active,country,count</span></a>
<a class="sourceLine" id="cb425-4" data-line-number="4"><span class="st">       ,sum(count) over (order by count desc,country rows between unbounded preceding and current row) running_total</span></a>
<a class="sourceLine" id="cb425-5" data-line-number="5"><span class="st">       , pct</span></a>
<a class="sourceLine" id="cb425-6" data-line-number="6"><span class="st">       ,sum(pct) over (order by pct desc,country rows between unbounded preceding and current row) running_pct</span></a>
<a class="sourceLine" id="cb425-7" data-line-number="7"><span class="st">  from (-- Start of inner SQL Block</span></a>
<a class="sourceLine" id="cb425-8" data-line-number="8"><span class="st">        select c.active,country.country,count(*) count</span></a>
<a class="sourceLine" id="cb425-9" data-line-number="9"><span class="st">              ,round(100 * count(*) / sum(count(*)) over(),4) as pct</span></a>
<a class="sourceLine" id="cb425-10" data-line-number="10"><span class="st">         from customer c</span></a>
<a class="sourceLine" id="cb425-11" data-line-number="11"><span class="st">              join address a on c.address_id = a.address_id</span></a>
<a class="sourceLine" id="cb425-12" data-line-number="12"><span class="st">              join city  on a.city_id = city.city_id</span></a>
<a class="sourceLine" id="cb425-13" data-line-number="13"><span class="st">              join country on city.country_id = country.country_id</span></a>
<a class="sourceLine" id="cb425-14" data-line-number="14"><span class="st">         group by c.active,country</span></a>
<a class="sourceLine" id="cb425-15" data-line-number="15"><span class="st">       ) ctry  -- End of inner SQL Block</span></a>
<a class="sourceLine" id="cb425-16" data-line-number="16"><span class="st"> order by count desc,country</span></a>
<a class="sourceLine" id="cb425-17" data-line-number="17"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb425-18" data-line-number="18"><span class="kw">sp_print_df</span>(country_sql)</a></code></pre></div>
<div id="htmlwidget-09904734225327216f09" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-09904734225327216f09">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118"],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,0,1,1,1,1,1,0,1,1,1,1,1,0,1,0,1,1,1,1,1,1,1,0,1,1,0,0,1],["India","China","United States","Japan","Mexico","Brazil","Russian Federation","Philippines","Indonesia","Turkey","Argentina","Nigeria","South Africa","Taiwan","Canada","United Kingdom","Germany","Iran","Italy","Poland","Venezuela","Colombia","Egypt","Ukraine","Vietnam","Netherlands","Pakistan","Saudi Arabia","South Korea","Spain","France","Peru","Yemen","Algeria","Austria","Bangladesh","Chile","China","Dominican Republic","Ecuador","India","Israel","Malaysia","Morocco","Mozambique","Paraguay","Switzerland","Tanzania","Thailand","United Arab Emirates","Angola","Australia","Azerbaijan","Belarus","Bolivia","Bulgaria","Cambodia","Cameroon","Congo, The Democratic Republic of the","French Polynesia","Greece","Kazakstan","Kenya","Latvia","Myanmar","Oman","Puerto Rico","Romania","Sudan","Yugoslavia","Afghanistan","American Samoa","Anguilla","Armenia","Bahrain","Brunei","Chad","Czech Republic","Estonia","Ethiopia","Faroe Islands","Finland","French Guiana","Gambia","Greenland","Holy See (Vatican City State)","Hong Kong","Hungary","Iran","Iraq","Israel","Kuwait","Liechtenstein","Lithuania","Madagascar","Malawi","Mexico","Moldova","Nauru","Nepal","New Zealand","North Korea","Poland","Runion","Russian Federation","Saint Vincent and the Grenadines","Senegal","Slovakia","Sri Lanka","Sweden","Tonga","Tunisia","Turkey","Turkmenistan","Tuvalu","United Kingdom","Virgin Islands, U.S.","Zambia"],[57,50,36,31,29,28,27,20,14,14,13,13,11,10,8,8,7,7,7,7,7,6,6,6,6,5,5,5,5,5,4,4,4,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[57,107,143,174,203,231,258,278,292,306,319,332,343,353,361,369,376,383,390,397,404,410,416,422,428,433,438,443,448,453,457,461,465,468,471,474,477,480,483,486,489,492,495,498,501,504,507,510,513,516,518,520,522,524,526,528,530,532,534,536,538,540,542,544,546,548,550,552,554,556,557,558,559,560,561,562,563,564,565,566,567,568,569,570,571,572,573,574,575,576,577,578,579,580,581,582,583,584,585,586,587,588,589,590,591,592,593,594,595,596,597,598,599,600,601,602,603,604],[9.4371,8.2781,5.9603,5.1325,4.8013,4.6358,4.4702,3.3113,2.3179,2.3179,2.1523,2.1523,1.8212,1.6556,1.3245,1.3245,1.1589,1.1589,1.1589,1.1589,1.1589,0.9934,0.9934,0.9934,0.9934,0.8278,0.8278,0.8278,0.8278,0.8278,0.6623,0.6623,0.6623,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656],[9.4371,17.7152,23.6755,28.808,33.6093,38.2451,42.7153,46.0266,48.3445,50.6624,52.8147,54.967,56.7882,58.4438,59.7683,61.0928,62.2517,63.4106,64.5695,65.7284,66.8873,67.8807,68.8741,69.8675,70.8609,71.6887,72.5165,73.3443,74.1721,74.9999,75.6622,76.3245,76.9868,77.4835,77.9802,78.4769,78.9736,79.4703,79.967,80.4637,80.9604,81.4571,81.9538,82.4505,82.9472,83.4439,83.9406,84.4373,84.934,85.4307,85.7618,86.0929,86.424,86.7551,87.0862,87.4173,87.7484,88.0795,88.4106,88.7417,89.0728,89.4039,89.735,90.0661,90.3972,90.7283,91.0594,91.3905,91.7216,92.0527,92.2183,92.3839,92.5495,92.7151,92.8807,93.0463,93.2119,93.3775,93.5431,93.7087,93.8743,94.0399,94.2055,94.3711,94.5367,94.7023,94.8679,95.0335,95.1991,95.3647,95.5303,95.6959,95.8615,96.0271,96.1927,96.3583,96.5239,96.6895,96.8551,97.0207,97.1863,97.3519,97.5175,97.6831,97.8487,98.0143,98.1799,98.3455,98.5111,98.6767,98.8423,99.0079,99.1735,99.3391,99.5047,99.6703,99.8359,100.0015]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>active<\/th>\n      <th>country<\/th>\n      <th>count<\/th>\n      <th>running_total<\/th>\n      <th>pct<\/th>\n      <th>running_pct<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3,4,5,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>
The top 25% of the customer base are from India, China, the United States, and Japan. The next six countries, the top 10, Mexico, Brazil, Russian Federation, Philipines, Indonesia, and Turkey round out the top 50% of the businesses customer base.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-5" class="section level4">
<h4><span class="header-section-number">20.1.4.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb426"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb426-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb426-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb426-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb426-4" data-line-number="4"></a>
<a class="sourceLine" id="cb426-5" data-line-number="5">country_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb426-6" data-line-number="6"></a>
<a class="sourceLine" id="cb426-7" data-line-number="7"><span class="kw">sp_print_df</span>(country_dplyr)</a></code></pre></div>
<div id="htmlwidget-b619f31f38e9f2471fcc" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-b619f31f38e9f2471fcc">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="how-many-customers-are-in-australia-and-canada" class="section level3">
<h3><span class="header-section-number">20.1.5</span> 6. How many customers are in Australia and Canada?</h3>
<p>To answer this question we use the results from the previous exercise.</p>
<div class="sourceCode" id="cb427"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb427-1" data-line-number="1">country_au_ca_sql &lt;-<span class="st"> </span>country_sql <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(country <span class="op">==</span><span class="st"> &#39;Australia&#39;</span> <span class="op">|</span><span class="st"> </span>country <span class="op">==</span><span class="st"> &#39;Canada&#39;</span>)</a>
<a class="sourceLine" id="cb427-2" data-line-number="2"><span class="kw">sp_print_df</span>(country_au_ca_sql)</a></code></pre></div>
<div id="htmlwidget-beeafef17c4840807f51" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-beeafef17c4840807f51">{"x":{"filter":"none","data":[["1","2"],[1,1],["Canada","Australia"],[8,2],[361,520],[1.3245,0.3311],[59.7683,86.0929]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>active<\/th>\n      <th>country<\/th>\n      <th>count<\/th>\n      <th>running_total<\/th>\n      <th>pct<\/th>\n      <th>running_pct<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3,4,5,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>There are 10 customers in Austrailia and Canada where the brick and mortar stores are located. The 20 customers are less than 2% of the world wide customer base. </font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-6" class="section level4">
<h4><span class="header-section-number">20.1.5.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb428"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb428-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb428-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb428-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb428-4" data-line-number="4"></a>
<a class="sourceLine" id="cb428-5" data-line-number="5">country_au_ca_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb428-6" data-line-number="6"></a>
<a class="sourceLine" id="cb428-7" data-line-number="7"><span class="kw">sp_print_df</span>(country_au_ca_dplyr)</a></code></pre></div>
<div id="htmlwidget-f6a2206cea77e899a1de" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-f6a2206cea77e899a1de">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="how-many-languages" class="section level3">
<h3><span class="header-section-number">20.1.6</span> 7. How Many Languages?</h3>
<p>With an international customer base, how many languages does the DVD Rental business distribute DVD’s in.</p>
<p>To answer this question we look at the <code>language</code> table.</p>
<div class="sourceCode" id="cb429"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb429-1" data-line-number="1">languages_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb429-2" data-line-number="2"><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb429-3" data-line-number="3"><span class="st">select * from language</span></a>
<a class="sourceLine" id="cb429-4" data-line-number="4"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb429-5" data-line-number="5"></a>
<a class="sourceLine" id="cb429-6" data-line-number="6"><span class="kw">sp_print_df</span>(languages_sql)</a></code></pre></div>
<div id="htmlwidget-80fb537b5ba0bd90fb93" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-80fb537b5ba0bd90fb93">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],[1,2,3,4,5,6],["English             ","Italian             ","Japanese            ","Mandarin            ","French              ","German              "],["2006-02-15T18:02:19Z","2006-02-15T18:02:19Z","2006-02-15T18:02:19Z","2006-02-15T18:02:19Z","2006-02-15T18:02:19Z","2006-02-15T18:02:19Z"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>language_id<\/th>\n      <th>name<\/th>\n      <th>last_update<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":1},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>DVD’s are distributed in six languages.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-7" class="section level4">
<h4><span class="header-section-number">20.1.6.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb430"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb430-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb430-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb430-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb430-4" data-line-number="4"></a>
<a class="sourceLine" id="cb430-5" data-line-number="5"><span class="co"># languages_dplyr &lt;- as.data.frame(&quot;code me&quot;)</span></a>
<a class="sourceLine" id="cb430-6" data-line-number="6"><span class="co"># </span></a>
<a class="sourceLine" id="cb430-7" data-line-number="7"><span class="co"># sp_print_df(language_table)</span></a></code></pre></div>
</div>
</div>
<div id="what-is-the-distribution-of-dvds-by-language" class="section level3">
<h3><span class="header-section-number">20.1.7</span> 8. What is the distribution of DVD’s by Language</h3>
<p>To answer this question we look at the <code>language</code> and <code>film</code> tables.</p>
<div class="sourceCode" id="cb431"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb431-1" data-line-number="1">language_distribution_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb431-2" data-line-number="2"><span class="st">&#39;</span></a>
<a class="sourceLine" id="cb431-3" data-line-number="3"><span class="st">select l.language_id,name &quot;language&quot;,count(f.film_id)</span></a>
<a class="sourceLine" id="cb431-4" data-line-number="4"><span class="st">  from language l left join film f on l.language_id = f.language_id</span></a>
<a class="sourceLine" id="cb431-5" data-line-number="5"><span class="st">group by l.language_id,name</span></a>
<a class="sourceLine" id="cb431-6" data-line-number="6"><span class="st">order by l.language_id</span></a>
<a class="sourceLine" id="cb431-7" data-line-number="7"><span class="st">&#39;</span>)</a>
<a class="sourceLine" id="cb431-8" data-line-number="8"></a>
<a class="sourceLine" id="cb431-9" data-line-number="9"><span class="kw">sp_print_df</span>(language_distribution_sql)</a></code></pre></div>
<div id="htmlwidget-703a15d93cfc9aff608e" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-703a15d93cfc9aff608e">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],[1,2,3,4,5,6],["English             ","Italian             ","Japanese            ","Mandarin            ","French              ","German              "],[1001,0,0,0,0,0]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>language_id<\/th>\n      <th>language<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>This is a surprise. For an international customer base, the entire stock of 1001 DVD’s are in English only.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-8" class="section level4">
<h4><span class="header-section-number">20.1.7.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb432"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb432-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb432-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb432-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb432-4" data-line-number="4"></a>
<a class="sourceLine" id="cb432-5" data-line-number="5">language_distribution_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb432-6" data-line-number="6"></a>
<a class="sourceLine" id="cb432-7" data-line-number="7"><span class="kw">sp_print_df</span>(language_distribution_dplyr)</a></code></pre></div>
<div id="htmlwidget-6d936e3915a36e12cd53" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6d936e3915a36e12cd53">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="what-are-the-number-of-rentals-and-rented-amount-by-store-by-month" class="section level3">
<h3><span class="header-section-number">20.1.8</span> 9. What are the number of rentals and rented amount by store, by month?</h3>
<p>To answer this question we look at the <code>rental</code>, <code>inventory</code>, and <code>film</code> tables to answer this question.</p>
<div class="sourceCode" id="cb433"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb433-1" data-line-number="1">store_rentals_by_mth_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb433-2" data-line-number="2"><span class="st">&quot;select *</span></a>
<a class="sourceLine" id="cb433-3" data-line-number="3"><span class="st">       ,sum(rental_amt) over (order by yyyy_mm,store_id rows </span></a>
<a class="sourceLine" id="cb433-4" data-line-number="4"><span class="st">                              between unbounded preceding and current row) running_rental_amt</span></a>
<a class="sourceLine" id="cb433-5" data-line-number="5"><span class="st">   from (select yyyy_mm,store_id,rentals,rental_amt</span></a>
<a class="sourceLine" id="cb433-6" data-line-number="6"><span class="st">               ,sum(rentals) over(partition by yyyy_mm order by store_id) mo_rentals</span></a>
<a class="sourceLine" id="cb433-7" data-line-number="7"><span class="st">               ,sum(rental_amt) over (partition by yyyy_mm order by store_id) mo_rental_amt</span></a>
<a class="sourceLine" id="cb433-8" data-line-number="8"><span class="st">           from (select to_char(rental_date,&#39;yyyy-mm&#39;) yyyy_mm</span></a>
<a class="sourceLine" id="cb433-9" data-line-number="9"><span class="st">                       ,i.store_id,count(*) rentals, sum(f.rental_rate) rental_amt</span></a>
<a class="sourceLine" id="cb433-10" data-line-number="10"><span class="st">                   from rental r join inventory i on r.inventory_id = i.inventory_id </span></a>
<a class="sourceLine" id="cb433-11" data-line-number="11"><span class="st">                        join film f on i.film_id = f.film_id</span></a>
<a class="sourceLine" id="cb433-12" data-line-number="12"><span class="st">                 group by to_char(rental_date,&#39;yyyy-mm&#39;),i.store_id</span></a>
<a class="sourceLine" id="cb433-13" data-line-number="13"><span class="st">                ) as details</span></a>
<a class="sourceLine" id="cb433-14" data-line-number="14"><span class="st">        ) as mo_running</span></a>
<a class="sourceLine" id="cb433-15" data-line-number="15"><span class="st">order by yyyy_mm,store_id</span></a>
<a class="sourceLine" id="cb433-16" data-line-number="16"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb433-17" data-line-number="17"><span class="kw">sp_print_df</span>(store_rentals_by_mth_sql)</a></code></pre></div>
<div id="htmlwidget-c195b56d57c26c8f1d4d" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-c195b56d57c26c8f1d4d">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11"],["2005-05","2005-05","2005-06","2005-06","2005-07","2005-07","2005-08","2005-08","2006-02","2006-02","2019-02"],[1,2,1,2,1,2,1,2,1,2,1],[575,581,1121,1190,3334,3375,2801,2885,92,90,1],[1721.25,1667.19,3331.79,3444.1,9914.66,9861.25,8292.99,8464.15,249.08,265.1,4.99],[575,1156,1121,2311,3334,6709,2801,5686,92,182,1],[1721.25,3388.44,3331.79,6775.89,9914.66,19775.91,8292.99,16757.14,249.08,514.18,4.99],[1721.25,3388.44,6720.23,10164.33,20078.99,29940.24,38233.23,46697.38,46946.46,47211.56,47216.55]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>yyyy_mm<\/th>\n      <th>store_id<\/th>\n      <th>rentals<\/th>\n      <th>rental_amt<\/th>\n      <th>mo_rentals<\/th>\n      <th>mo_rental_amt<\/th>\n      <th>running_rental_amt<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4,5,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>The current entry, row 11, is our new rental row we added to show the different joins in a previous chapter.
</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-9" class="section level4">
<h4><span class="header-section-number">20.1.8.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb434"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb434-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb434-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb434-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb434-4" data-line-number="4"></a>
<a class="sourceLine" id="cb434-5" data-line-number="5">store_rentals_by_mth_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb434-6" data-line-number="6">    </a>
<a class="sourceLine" id="cb434-7" data-line-number="7"><span class="kw">sp_print_df</span>(<span class="kw">head</span>(store_rentals_by_mth_dplyr, <span class="dt">n=</span><span class="dv">25</span>))</a></code></pre></div>
<div id="htmlwidget-7a589913f405d7a14fbe" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-7a589913f405d7a14fbe">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="rank-films-based-on-the-number-of-times-rented-and-associated-revenue" class="section level3">
<h3><span class="header-section-number">20.1.9</span> 10. Rank Films Based on the Number of Times Rented and Associated Revenue</h3>
<p>To answer this question we look at the <code>rental</code>, <code>inventory</code>, and <code>film</code> tables.</p>
<div class="sourceCode" id="cb435"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb435-1" data-line-number="1">film_rank_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb435-2" data-line-number="2"><span class="st">&quot;select f.film_id,f.title,f.rental_rate,count(*) count,f.rental_rate * count(*) rental_amt</span></a>
<a class="sourceLine" id="cb435-3" data-line-number="3"><span class="st">   from rental r join inventory i on r.inventory_id = i.inventory_id </span></a>
<a class="sourceLine" id="cb435-4" data-line-number="4"><span class="st">        join film f on i.film_id = f.film_id</span></a>
<a class="sourceLine" id="cb435-5" data-line-number="5"><span class="st"> group by f.film_id,f.title,f.rental_rate</span></a>
<a class="sourceLine" id="cb435-6" data-line-number="6"><span class="st"> order by count(*) desc&quot;</span>)</a>
<a class="sourceLine" id="cb435-7" data-line-number="7">  </a>
<a class="sourceLine" id="cb435-8" data-line-number="8"><span class="kw">sp_print_df</span>(film_rank_sql)</a></code></pre></div>
<div id="htmlwidget-a3fe20e2cfd2d5bbfba3" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-a3fe20e2cfd2d5bbfba3">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118","119","120","121","122","123","124","125","126","127","128","129","130","131","132","133","134","135","136","137","138","139","140","141","142","143","144","145","146","147","148","149","150","151","152","153","154","155","156","157","158","159","160","161","162","163","164","165","166","167","168","169","170","171","172","173","174","175","176","177","178","179","180","181","182","183","184","185","186","187","188","189","190","191","192","193","194","195","196","197","198","199","200","201","202","203","204","205","206","207","208","209","210","211","212","213","214","215","216","217","218","219","220","221","222","223","224","225","226","227","228","229","230","231","232","233","234","235","236","237","238","239","240","241","242","243","244","245","246","247","248","249","250","251","252","253","254","255","256","257","258","259","260","261","262","263","264","265","266","267","268","269","270","271","272","273","274","275","276","277","278","279","280","281","282","283","284","285","286","287","288","289","290","291","292","293","294","295","296","297","298","299","300","301","302","303","304","305","306","307","308","309","310","311","312","313","314","315","316","317","318","319","320","321","322","323","324","325","326","327","328","329","330","331","332","333","334","335","336","337","338","339","340","341","342","343","344","345","346","347","348","349","350","351","352","353","354","355","356","357","358","359","360","361","362","363","364","365","366","367","368","369","370","371","372","373","374","375","376","377","378","379","380","381","382","383","384","385","386","387","388","389","390","391","392","393","394","395","396","397","398","399","400","401","402","403","404","405","406","407","408","409","410","411","412","413","414","415","416","417","418","419","420","421","422","423","424","425","426","427","428","429","430","431","432","433","434","435","436","437","438","439","440","441","442","443","444","445","446","447","448","449","450","451","452","453","454","455","456","457","458","459","460","461","462","463","464","465","466","467","468","469","470","471","472","473","474","475","476","477","478","479","480","481","482","483","484","485","486","487","488","489","490","491","492","493","494","495","496","497","498","499","500","501","502","503","504","505","506","507","508","509","510","511","512","513","514","515","516","517","518","519","520","521","522","523","524","525","526","527","528","529","530","531","532","533","534","535","536","537","538","539","540","541","542","543","544","545","546","547","548","549","550","551","552","553","554","555","556","557","558","559","560","561","562","563","564","565","566","567","568","569","570","571","572","573","574","575","576","577","578","579","580","581","582","583","584","585","586","587","588","589","590","591","592","593","594","595","596","597","598","599","600","601","602","603","604","605","606","607","608","609","610","611","612","613","614","615","616","617","618","619","620","621","622","623","624","625","626","627","628","629","630","631","632","633","634","635","636","637","638","639","640","641","642","643","644","645","646","647","648","649","650","651","652","653","654","655","656","657","658","659","660","661","662","663","664","665","666","667","668","669","670","671","672","673","674","675","676","677","678","679","680","681","682","683","684","685","686","687","688","689","690","691","692","693","694","695","696","697","698","699","700","701","702","703","704","705","706","707","708","709","710","711","712","713","714","715","716","717","718","719","720","721","722","723","724","725","726","727","728","729","730","731","732","733","734","735","736","737","738","739","740","741","742","743","744","745","746","747","748","749","750","751","752","753","754","755","756","757","758","759","760","761","762","763","764","765","766","767","768","769","770","771","772","773","774","775","776","777","778","779","780","781","782","783","784","785","786","787","788","789","790","791","792","793","794","795","796","797","798","799","800","801","802","803","804","805","806","807","808","809","810","811","812","813","814","815","816","817","818","819","820","821","822","823","824","825","826","827","828","829","830","831","832","833","834","835","836","837","838","839","840","841","842","843","844","845","846","847","848","849","850","851","852","853","854","855","856","857","858","859","860","861","862","863","864","865","866","867","868","869","870","871","872","873","874","875","876","877","878","879","880","881","882","883","884","885","886","887","888","889","890","891","892","893","894","895","896","897","898","899","900","901","902","903","904","905","906","907","908","909","910","911","912","913","914","915","916","917","918","919","920","921","922","923","924","925","926","927","928","929","930","931","932","933","934","935","936","937","938","939","940","941","942","943","944","945","946","947","948","949","950","951","952","953","954","955","956","957","958","959"],[103,738,382,331,730,489,767,1000,621,369,418,753,31,891,735,973,563,109,748,239,869,979,559,789,609,450,285,127,403,374,702,341,220,945,86,174,301,873,941,875,361,849,595,73,284,893,378,358,295,395,356,305,951,745,764,159,911,850,625,638,715,521,200,698,603,367,958,135,835,206,525,468,330,78,697,879,114,897,434,228,531,244,870,349,445,181,303,471,687,460,391,773,938,890,970,554,234,901,838,670,12,101,263,397,572,307,167,683,880,856,895,309,266,624,162,555,791,288,387,760,571,247,786,273,172,989,863,545,55,417,245,644,319,902,154,586,741,775,476,11,649,810,304,45,366,91,865,35,966,119,131,790,447,527,253,650,804,641,502,43,551,852,433,130,491,443,388,166,914,676,816,494,122,117,320,270,646,961,645,327,412,771,843,857,1,504,10,191,982,614,51,995,271,334,915,199,353,976,608,437,665,759,4,892,26,376,518,322,556,706,79,54,823,267,428,18,772,143,814,61,59,15,500,949,314,972,300,21,575,782,408,415,176,985,651,898,142,406,25,800,444,89,252,930,317,67,23,6,981,677,242,149,280,755,602,776,37,132,377,922,164,514,637,846,129,49,807,218,861,596,112,681,841,22,313,235,19,57,83,274,833,806,953,416,69,727,354,193,100,39,138,292,920,255,249,484,414,326,439,140,462,139,628,231,647,363,204,851,906,720,680,805,486,535,409,993,707,147,728,778,845,578,694,465,350,733,590,562,402,467,668,723,496,743,99,501,827,579,345,663,160,344,747,222,115,97,948,690,118,479,734,436,710,48,298,785,233,243,370,396,72,725,158,580,912,282,269,631,457,281,302,864,887,227,311,619,451,560,818,610,616,150,429,812,17,212,967,768,90,461,688,184,871,456,385,329,724,746,524,383,56,8,254,936,432,121,986,777,346,286,215,463,689,473,657,474,251,971,583,155,77,709,410,924,116,294,877,299,169,561,999,95,944,574,854,333,611,448,70,925,308,643,183,424,763,265,717,506,626,512,510,744,803,964,623,737,175,878,348,534,488,398,693,464,58,481,336,275,672,483,380,691,324,552,859,739,855,716,427,105,85,708,679,458,480,526,606,226,600,975,351,678,111,373,797,50,141,956,123,862,963,42,969,179,601,908,44,696,165,704,189,809,757,666,686,927,392,186,980,570,170,260,203,749,937,664,991,40,987,598,152,84,442,68,858,655,137,529,505,421,618,634,942,272,542,544,201,844,438,446,932,907,588,28,236,770,654,287,796,732,795,872,420,792,896,7,820,988,830,110,589,557,452,229,232,788,532,615,592,962,453,648,658,478,347,216,913,599,784,219,381,455,900,241,756,916,629,536,847,360,946,81,493,921,793,774,652,620,992,894,205,673,783,426,277,832,667,840,379,365,24,173,546,16,394,968,190,882,296,929,133,290,661,27,65,328,917,617,765,34,842,604,63,423,440,96,711,98,487,577,511,71,593,762,449,209,639,736,153,660,293,828,321,573,258,145,829,705,177,151,202,568,213,867,597,134,994,540,430,207,585,798,291,931,766,9,881,794,93,533,413,813,80,113,5,3,567,919,564,519,977,538,821,957,928,88,315,825,389,576,194,682,323,581,933,627,306,250,722,831,918,848,283,210,509,888,257,700,587,187,640,886,899,633,729,469,342,761,46,74,549,819,92,530,104,853,889,692,75,337,64,905,352,60,731,726,368,422,960,375,82,613,157,537,636,740,477,868,811,662,339,528,780,393,312,29,750,508,539,952,553,276,482,20,543,279,246,630,66,837,834,522,126,240,632,188,826,120,214,565,582,591,435,355,264,492,815,503,934,983,685,230,466,338,516,256,984,515,13,940,425,824,211,208,998,30,390,454,76,357,714,550,978,721,499,594,223,364,817,136,926,866,787,923,566,659,401,146,674,751,758,719,124,52,718,47,822,990,548,490,384,523,431,163,752,876,703,371,656,225,939,197,569,513,278,268,839,407,156,622,161,996,947,238,836,547,237,910,196,53,411,248,316,182,605,2,684,520,470,185,289,695,935,178,261,517,653,779,541,106,399,262,224,754,883,799,340,769,997,635,498,808,125,372,168,507,475,959,259,62,32,297,974,472,885,102,405,884,485,965,675,310,612,107,362,343,180,903,441,459,335,94,781,558,699,904,400,584,1001],["Bucket Brotherhood","Rocketeer Mother","Grit Clockwork","Forward Temple","Ridgemont Submarine","Juggler Hardly","Scalawag Duck","Zorro Ark","Network Peak","Goodfellas Salute","Hobbit Alien","Rush Goodfellas","Apache Divine","Timberland Sky","Robbers Joon","Wife Turn","Massacre Usual","Butterfly Chocolat","Rugrats Shakespeare","Dogma Family","Suspects Quills","Witches Panic","Married Go","Shock Cabin","Muscle Bright","Idols Snatchers","English Bulworth","Cat Coneheads","Harry Idaho","Graffiti Love","Pulp Beverly","Frost Head","Deer Virginian","Virginian Pluto","Boogie Amelie","Confidential Interview","Family Sweet","Sweethearts Suspects","Videotape Arsenic","Talented Homicide","Gleaming Jawbreaker","Storm Happiness","Moon Bunch","Bingo Talented","Enemy Odds","Titans Jerk","Greatest North","Gilmore Boiled","Expendable Stallion","Handicap Boondock","Giant Troopers","Fatal Haunted","Voyage Legally","Roses Treasure","Saturday Lambs","Closer Bang","Trip Newton","Story Side","None Spiking","Operation Operation","Range Moonwalker","Lies Treatment","Curtain Videotape","Princess Giant","Movie Shakespeare","Goldmine Tycoon","Wardrobe Phantom","Chance Resurrection","Spy Mile","Dancing Fever","Loathing Legally","Invasion Cyclone","Forrester Comancheros","Blackout Private","Primary Glass","Telegraph Voyage","Camelot Vacation","Torque Bound","Horror Reign","Detective Vision","Lose Inch","Dorado Notting","Swarm Gold","Gangs Pride","Hyde Doctor","Contact Anonymous","Fantasy Troopers","Island Exorcist","Pocus Pulp","Innocent Usual","Half Outfield","Seabiscuit Punk","Velvet Terminator","Tights Dawn","Westward Seabiscuit","Malkovich Pet","Disturbing Scarface","Tracy Cider","Stagecoach Armageddon","Pelican Comforts","Alaska Phantom","Brotherhood Blanket","Durham Panky","Hanky October","Metropolis Coma","Fellowship Autumn","Coma Head","Pity Bound","Telemark Heartbreakers","Streetcar Intentions","Tomorrow Hustler","Feud Frogmen","Dynamite Tarzan","Nightmare Chill","Clueless Bucket","Mallrats United","Show Lord","Escape Metropolis","Gun Bonnie","Samurai Lion","Metal Armageddon","Downhill Enough","Shepherd Midsummer","Effect Gladiator","Coneheads Smoochy","Working Microcosmos","Sun Confessions","Madness Attacks","Barbarella Streetcar","Hills Neighbors","Double Wrath","Oscar Gold","Fish Opus","Trading Pinocchio","Clash Freddy","Mockingbird Hollywood","Roman Punk","Seattle Expecations","Jason Trap","Alamo Videotape","Oz Liaisons","Slums Duck","Fargo Gandhi","Attraction Newton","Goldfinger Sensibility","Bound Cheaper","Sunrise League","Arachnophobia Rollercoaster","Wedding Apollo","Caper Motions","Center Dinosaur","Shootist Superfly","Ice Crossing","Lola Agent","Drifter Commandments","Pacific Amistad","Sleeping Suspects","Orange Grapes","Knock Warlock","Atlantis Cause","Maiden Home","Strangelove Desire","Horn Working","Celebrity Horn","Jumping Wrath","Hurricane Affair","Gunfight Moon","Color Philadelphia","Trouble Date","Philadelphia Wife","Snowman Rollercoaster","Karate Moon","Carrie Bunch","Candles Grapes","Flamingos Connecticut","Earth Vision","Outbreak Divine","Wash Heavenly","Others Soup","Fool Mockingbird","Heavyweights Beast","Scorpion Apollo","Steel Santa","Strictly Scarface","Academy Dinosaur","Kwai Homeward","Aladdin Calendar","Crooked Frogmen","Women Dorado","Name Detective","Balloon Homeward","Yentl Idaho","Easy Gladiator","Freddy Storm","Truman Crazy","Cupboard Sinners","Gentlemen Stage","Wind Phantom","Murder Antitrust","House Dynamite","Patton Interview","Salute Apollo","Affair Prejudice","Titanic Boondock","Annie Identity","Grapes Fury","Liaisons Sweet","Flatliners Killer","Maltese Hope","Queen Luke","Blade Polish","Banger Pinocchio","South Wait","Eagles Panky","Homicide Peach","Alter Victory","Sea Virgin","Chill Luck","Snatch Slipper","Beauty Grease","Bear Graceland","Alien Center","Kiss Glory","Volcano Texas","Fight Jawbreaker","Whisperer Giant","Falcon Volume","American Circus","Midsummer Groundhog","Shakespeare Saddle","Head Stranger","High Encino","Congeniality Quest","Wonderland Christmas","Packer Madigan","Tourist Pelican","Chicken Hellfighters","Haunting Pianist","Angels Life","Sinners Atlantis","Hustler Party","Borrowers Bedazzled","Dream Pickup","Vacation Boondock","Fireball Philadelphia","Berets Agent","Anaconda Confessions","Agent Truman","Wolves Desire","Pianist Outfield","Doom Dancing","Christmas Moonshine","Empire Malkovich","Sabrina Midnight","Mourning Purple","Secret Groundhog","Arizona Bang","Chainsaw Uptown","Grease Youth","Undefeated Dalmations","Coast Rainbow","Lebowski Soldiers","Open African","Sting Personal","Cause Date","Badman Dawn","Sleuth Orient","Deceiver Betrayed","Suit Walls","Moonshine Cabin","Calendar Gunfight","Pirates Roxanne","Star Operation","Amistad Midsummer","Fidelity Devil","Divide Monster","Amadeus Holy","Basic Easy","Blues Instinct","Egg Igby","Splendor Patton","Sleepy Japanese","Wait Cider","Highball Potter","Beverly Outlaw","Resurrection Silverado","Ghost Groundhog","Crossroads Casualties","Brooklyn Desert","Armageddon Lost","Chariots Conspiracy","Excitement Eve","Unbreakable Karate","Driving Polish","Dracula Crystal","Jerk Paycheck","Hellfighters Sierra","Flying Hook","Hunchback Impossible","Cheaper Clyde","Insider Arizona","Chasing Fight","Northwest Polish","Dinosaur Secretary","Outfield Massacre","Go Purple","Dalmations Sweden","Straight Hours","Tramp Others","Redemption Comforts","Pinocchio Simon","Sleepless Monsoon","Jet Neighbors","Love Suicides","Heartbreakers Bright","Wrong Behavior","Quest Mussolini","Chocolat Harry","Reunion Witches","Secrets Paradise","Stepmom Dream","Million Ace","Prejudice Oleander","Interview Liaisons","Garden Island","River Outlaw","Money Harold","Masked Bubble","Harper Dying","Intrigue Worst","Peak Forever","Reign Gentlemen","Kick Savannah","Room Roman","Bringing Hysterical","Kissing Dolls","Spice Sorority","Minds Truman","Gables Metropolis","Patient Sister","Club Graffiti","Fury Murder","Roxanne Rebel","Desert Poseidon","Campus Remember","Bride Intrigue","Voice Peach","Pond Seattle","Canyon Stock","Jedi Beneath","Road Roxanne","Hours Rage","Rage Games","Backlash Undefeated","Eyes Driving","Shawshank Bubble","Disciple Mother","Doors President","Gorgeous Bingo","Hanging Deep","Bill Others","Requiem Tycoon","Clones Pinocchio","Mine Titans","Trojan Tomorrow","Encounters Curtain","Earring Instinct","Novocaine Flight","Independence Hotel","Encino Elf","Fantasia Park","Sundance Invasion","Thief Pelican","Details Packer","Fiction Christmas","Neighbors Charade","Igby Maker","Mars Roman","Something Duck","Music Boondock","National Story","Cider Desire","Honey Ties","Smoking Barbarella","Alone Trip","Darn Forrester","Weekend Personal","Scarface Bang","Boulevard Mob","Insects Stone","Polish Brooklyn","Core Suit","Sweden Shining","Inch Jet","Groundhog Uncut","Forrest Sons","Remember Diary","Rouge Squad","Lion Uncut","Groove Fiction","Barefoot Manchurian","Airport Pollock","Driver Annie","Vanishing Rocky","Hope Tootsie","Carol Texas","Wonka Sea","Secretary Rouge","Galaxy Sweethearts","Enough Raging","Dawn Pond","Instinct Airport","Pollock Deliverance","Jacket Frisco","Paradise Sabrina","Jade Bunch","Dragonfly Strangers","Whale Bikini","Mission Zoolander","Cleopatra Devil","Birds Perdition","Racer Egg","Heaven Freedom","Unforgiven Zoolander","Candidate Perdition","Expecations Natural","Taxi Kick","Factory Dragon","Comforts Rush","Mask Peach","Zoolander Fiction","Breakfast Goldfinger","Virgin Daisy","Midnight Westward","Strangers Graffiti","Freaky Pocus","Musketeers Wait","Idaho Love","Bikini Borrowers","United Pilot","Ferris Mother","Orient Closer","Conversation Downhill","Holocaust Highball","Satisfaction Confidential","Dying Maker","Rear Trading","Lady Stage","Noon Papi","League Hellfighters","Lawless Vision","Roots Remember","Slacker Liaisons","Waterfront Deliverance","Newton Labyrinth","Rock Instinct","Confused Candles","Teen Apollo","Gandhi Kwai","Louisiana Harry","Joon Northwest","Hanover Galaxy","Potter Connecticut","Intentions Empire","Beach Heartbreakers","Jekyll Frogmen","French Holiday","Egypt Tenenbaums","Perfect Groove","Jericho Mulan","Greek Everyone","Poseidon Forever","Flintstones Happiness","Majestic Floats","Sugar Wonka","Rocky War","Streak Ridgemont","Reap Unfaithful","Homeward Cider","Bull Shawshank","Bonnie Holocaust","Quills Bull","Pilot Hoosiers","Indian Love","Jeepers Wedding","Lock Rear","Mummy Creatures","Destiny Saturday","Motions Details","Willow Tracy","Gaslight Crusade","Pickup Driving","Caddyshack Jedi","Graduate Lord","Silence Kane","Baked Cleopatra","Chicago North","Wanda Chamber","Casablanca Super","Summer Scarface","Watch Tracy","Artist Coldblooded","West Lion","Conquerer Nuts","Moulin Wake","Trap Guys","Attacks Hate","Pride Alamo","Coldblooded Darling","Pure Runner","Creatures Shakespeare","Slipper Fidelity","Sagebrush Clueless","Paycheck Wait","Pluto Oleander","Uprising Uptown","Hall Cassidy","Craft Outfield","Wizard Coldblooded","Mermaid Insects","Command Darling","Dude Blindness","Daisy Menagerie","Rules Human","Varsity Trip","Patriot Roman","Worst Banger","Army Flintstones","Words Hunter","Mosquito Armageddon","Circus Youth","Boiled Dares","Hunting Musketeers","Betrayed Rear","Submarine Bed","Panther Reds","Charade Duffel","Lonely Elephant","Labyrinth League","Holiday Games","Necklace Outbreak","Odds Boogie","Vietnam Smoochy","Edge Kissing","Lust Lock","Madison Trap","Cyclone Family","Steers Armageddon","Human Graffiti","Hysterical Grail","Valley Packer","Translation Summer","Model Fish","Anthem Luke","Divine Resurrection","Scissorhands Slums","Panky Submarine","Entrapment Satisfaction","Sierra Divide","Rings Heartbreakers","Siege Madre","Sweet Brotherhood","Holes Brannigan","Shrek License","Tootsie Pilot","Airplane Sierra","Sons Interview","Worker Tarzan","Spirit Flintstones","Cabin Flash","Modern Dorado","Manchurian Curtain","Illusion Amelie","Devil Desire","Dirty Ace","Ship Wonderland","Loser Hustler","Nash Chocolat","Monster Spartacus","Wasteland Divine","Image Princess","Outlaw Hanky","Paris Weekend","Jaws Harry","Games Bowfinger","Day Unfaithful","Troopers Metal","Mother Oleander","Shanghai Tycoon","Deep Crusade","Grinch Massage","Impossible Prejudice","Town Ark","Donnie Alley","Saddle Antitrust","Turn Star","Notorious Reunion","Lovely Jingle","Stock Glass","Glass Dying","Virtual Spoilers","Blindness Gun","Kane Exorcist","Uncut Suicides","Shrunk Divine","Searchers Wait","Pajama Jawbreaker","Nemo Campus","Wrath Mile","Tomatoes Hellfighters","Dances None","Personal Ladybugs","Shane Darkness","Home Pity","Elephant Trojan","Splash Gump","Peach Innocent","Stampede Disturbing","Greedy Roots","Gold River","Analyze Hoosiers","Confessions Maguire","Madre Gables","Alley Evolution","Hamlet Wisdom","Werewolf Lola","Creepers Kane","Tenenbaums Command","Express Lonely","Usual Untouchables","Chamber Italian","Everyone Craft","Past Suicides","Anonymous Human","Behavior Runaway","Forever Candidate","Tuxedo Mile","Natural Stock","Saturn Name","Arabia Dogma","State Wasteland","Mulan Moon","Bedazzled Married","Hollywood Anonymous","Hunger Roof","Breaking Home","Raging Airplane","Bright Encounters","Jingle Sagebrush","Mile Mulan","Lawrence Love","Bilko Anonymous","Monterey Labyrinth","Sassy Packer","Identity Lover","Darkness War","Opposite Necklace","Robbery Bright","Citizen Shrek","Party Knock","Exorcist Sting","Spiking Element","Flash Wars","Microcosmos Paradise","Drums Dynamite","Chisum Behavior","Spinal Rocky","Purple Movie","Connecticut Tramp","Cincinatti Whisperer","Daddy Pittsburgh","Memento Zoolander","Date Speed","Super Wyoming","Moonwalker Fool","Champion Flatliners","Wyoming Storm","Lucky Flying","Hook Chariots","Dangerous Uptown","Mob Duffel","Silverado Goldfinger","Evolution Alter","Valentine Vanishing","Savannah Town","Alabama Devil","Temple Attraction","Side Ark","Brannigan Sunrise","Lost Bird","Hedwig Alter","Smoochy Control","Blanket Beverly","California Birds","African Egg","Adaptation Holes","Meet Chocolate","Tycoon Gathering","Massage Image","Liberty Magnificent","Window Side","Loverboy Attacks","Sorority Queen","War Notting","Uptown Young","Born Spinal","Finding Anaconda","Speakeasy Date","Gunfighter Mussolini","Mighty Luck","Crow Grease","Pittsburgh Hunchback","Flight Lies","Minority Kiss","Vampire Whale","North Tequila","Feathers Metal","Dragon Squad","Reef Salute","Spirited Casualties","Twisted Pirates","Stone Fire","Ending Crowds","Darko Dorado","Language Cowboy","Thin Sagebrush","Drumline Cyclone","Prix Undefeated","Mod Secretary","Cranes Reservoir","Opus Ice","Theory Mermaid","Towers Hurricane","October Submarine","Rider Caddyshack","Iron Moon","Fugitive Maguire","Santa Paris","Autumn Crow","Birch Antitrust","Magnolia Forrester","Song Hedwig","Bowfinger Gables","Lord Arizona","Bugsy Song","Stranger Strangers","Ties Hunger","Potluck Mixed","Bird Independence","Frida Slipper","Beethoven Exorcist","Trainspotting Strangers","Gathering Calendar","Beast Hunchback","Right Cranes","Reservoir Adaptation","Gone Trouble","Hollow Jeopardy","Wars Pluto","Grail Frankenstein","Blood Argonauts","Mystic Truman","Clockwork Paradise","Lover Truman","Oleander Clue","Rollercoaster Bringing","Jawbreaker Brooklyn","Superfly Trip","Smile Earring","Paths Control","Frogmen Breaking","Lolita World","Sensibility Rear","Halloween Nuts","Fiddler Lost","Antitrust Tomatoes","Run Pacific","Lambs Cincinatti","Luck Opus","Wagon Jaws","Maker Gables","Element Freddy","Jeopardy Encino","Amelie Hellfighters","Madigan Dorado","Elizabeth Shane","Doubtfire Labyrinth","Notting Speakeasy","Beneath Rush","Stage World","Spoilers Hellfighters","Life Twisted","Casualties Encino","Dolls Rage","Nuts Ties","Crazy Home","Speed Suit","Caribbean Liberty","Daughter Madigan","Matrix Snowman","Miracle Virtual","Monsoon Cause","Hotel Happiness","Ghostbusters Elf","Dwarfs Alter","Jungle Closer","Snatchers Montezuma","Kramer Chocolate","Vanilla Day","Won Dares","Platoon Instinct","Diary Panic","Intolerable Intentions","Frisco Forrest","Legend Jedi","Drop Waterfront","Wonderful Drop","Legally Secretary","Ali Forever","Victory Academy","Holy Tadpole","Spartacus Cheaper","Darling Breaking","Dares Pluto","Zhivago Core","Anything Savannah","Guys Falcon","Impact Aladdin","Birdcage Casper","Gilbert Pelican","Random Go","Maguire Apache","Wisdom Worker","Reds Pocus","King Evolution","Montezuma Command","Desire Alien","Godfather Diary","Soldiers Evolution","Chaplin License","Untouchables Sunrise","Sunset Racer","Shining Roses","Unfaithful Kill","Maude Mod","Park Citizen","Harold French","Chitty Lock","Pet Haunting","Runaway Tenenbaums","Saints Bride","Records Zorro","Casper Dragonfly","Ballroom Mockingbird","Rebel Airport","Baby Hall","Soup Wisdom","World Leathernecks","Magnificent Chitty","Jumanji Blade","Grosse Wonderful","Lights Deer","Hoosiers Birdcage","Clyde Theory","Runner Madigan","Tarzan Videotape","Punk Divorce","Gosford Donnie","Papi Necklace","Destination Jerk","Vertigo Northwest","Crusade Honey","Menagerie Rushmore","Leathernecks Dwarfs","Elf Murder","Early Home","Stallion Sundance","Hawk Chill","Clerks Angels","Newsies Story","Clue Grail","Young Language","Vision Torque","Doctor Grail","Squad Fish","Magic Mallrats","Divorce Shining","Treatment Jekyll","Cruelty Unforgiven","Bang Kwai","Heavenly Gun","Dozen Lion","Fire Wolves","Control Anthem","Mulholland Beast","Ace Goldfinger","Pizza Jumanji","License Weekend","Ishtar Rocketeer","Cowboy Doom","Eve Resurrection","President Bang","Vanished Garden","Connection Microcosmos","Duffel Apocalypse","Lesson Cleopatra","Panic Club","Sense Greek","Luke Mummy","Bulworth Commandments","Happiness United","Dumbo Lust","Desperate Trainspotting","Rushmore Mermaid","Tequila Past","Simon North","Frontier Cabin","School Jacket","Youth Kick","Oklahoma Jumanji","Killer Innocent","Sling Luke","Cassidy Wyoming","Graceland Dynamite","Comancheros Enemy","Ladybugs Armageddon","Japanese Run","Warlock Werewolf","Duck Racer","Bed Highball","Apocalypse Flamingos","Extraordinary Conquerer","Wild Apollo","Italian African","Texas Watch","Bubble Grosse","Haunted Antitrust","Terminator Club","Jersey Sassy","Watership Frontier","Phantom Glory","Fever Empire","Mussolini Spoilers","Bunch Minds","Glory Tracy","Full Flatliners","Conspiracy Spirit","Traffic Hobbit","Hunter Alter","Informer Double","Freedom Cleopatra","Braveheart Human","Seven Swarm","Mannequin Worst","Private Drop","Train Bunch","Hardly Robbers","Mixed Doors","Sophie's Choice"],[4.99,0.99,0.99,2.99,0.99,0.99,4.99,4.99,2.99,4.99,0.99,0.99,4.99,0.99,2.99,4.99,4.99,0.99,0.99,4.99,2.99,4.99,2.99,2.99,2.99,2.99,0.99,4.99,4.99,0.99,2.99,0.99,2.99,0.99,4.99,4.99,0.99,0.99,4.99,0.99,2.99,0.99,0.99,2.99,4.99,4.99,2.99,0.99,0.99,0.99,2.99,2.99,0.99,4.99,4.99,4.99,4.99,0.99,0.99,2.99,4.99,4.99,0.99,2.99,4.99,0.99,2.99,2.99,2.99,0.99,0.99,2.99,4.99,2.99,0.99,4.99,0.99,4.99,0.99,0.99,0.99,4.99,0.99,2.99,2.99,2.99,0.99,2.99,0.99,4.99,2.99,2.99,4.99,0.99,0.99,2.99,2.99,0.99,4.99,4.99,0.99,0.99,4.99,2.99,2.99,4.99,4.99,4.99,2.99,4.99,2.99,0.99,0.99,4.99,2.99,0.99,4.99,2.99,0.99,2.99,2.99,0.99,0.99,0.99,4.99,4.99,0.99,0.99,2.99,0.99,0.99,2.99,2.99,4.99,2.99,0.99,0.99,4.99,2.99,0.99,2.99,0.99,2.99,4.99,0.99,0.99,4.99,2.99,0.99,0.99,4.99,0.99,2.99,4.99,4.99,0.99,4.99,0.99,2.99,2.99,4.99,0.99,2.99,0.99,0.99,2.99,0.99,2.99,2.99,4.99,0.99,0.99,0.99,4.99,4.99,0.99,0.99,4.99,2.99,4.99,4.99,4.99,4.99,2.99,0.99,0.99,4.99,0.99,0.99,4.99,2.99,4.99,4.99,4.99,4.99,2.99,2.99,0.99,2.99,2.99,2.99,2.99,2.99,4.99,0.99,0.99,4.99,2.99,4.99,4.99,0.99,0.99,2.99,4.99,2.99,0.99,2.99,0.99,4.99,4.99,2.99,2.99,4.99,0.99,0.99,4.99,4.99,4.99,4.99,2.99,4.99,2.99,0.99,4.99,0.99,4.99,0.99,0.99,2.99,2.99,4.99,0.99,2.99,2.99,0.99,2.99,0.99,2.99,0.99,0.99,0.99,0.99,0.99,4.99,0.99,4.99,2.99,0.99,0.99,4.99,0.99,2.99,4.99,4.99,2.99,2.99,0.99,0.99,4.99,4.99,4.99,0.99,2.99,2.99,4.99,2.99,0.99,2.99,2.99,2.99,0.99,2.99,0.99,0.99,2.99,0.99,4.99,2.99,4.99,0.99,2.99,0.99,0.99,4.99,0.99,2.99,2.99,2.99,4.99,0.99,2.99,4.99,2.99,2.99,0.99,0.99,0.99,0.99,0.99,2.99,4.99,4.99,4.99,0.99,4.99,2.99,2.99,0.99,0.99,4.99,4.99,4.99,4.99,4.99,4.99,0.99,2.99,0.99,0.99,0.99,4.99,2.99,0.99,0.99,2.99,4.99,4.99,4.99,0.99,0.99,0.99,0.99,0.99,4.99,2.99,0.99,0.99,2.99,0.99,0.99,4.99,0.99,4.99,4.99,2.99,4.99,0.99,4.99,2.99,4.99,2.99,4.99,2.99,4.99,2.99,0.99,0.99,0.99,0.99,0.99,2.99,0.99,4.99,4.99,0.99,0.99,4.99,0.99,4.99,0.99,2.99,2.99,0.99,0.99,0.99,4.99,2.99,4.99,0.99,0.99,0.99,2.99,4.99,4.99,4.99,2.99,2.99,0.99,0.99,0.99,2.99,4.99,2.99,2.99,2.99,2.99,2.99,4.99,4.99,2.99,4.99,2.99,2.99,2.99,2.99,2.99,4.99,4.99,4.99,0.99,4.99,2.99,2.99,0.99,2.99,4.99,0.99,0.99,2.99,2.99,2.99,4.99,4.99,0.99,4.99,2.99,4.99,2.99,4.99,0.99,2.99,2.99,4.99,0.99,4.99,4.99,0.99,4.99,2.99,4.99,4.99,0.99,4.99,4.99,0.99,0.99,2.99,4.99,0.99,0.99,0.99,4.99,2.99,2.99,2.99,2.99,4.99,0.99,2.99,2.99,2.99,4.99,4.99,0.99,4.99,4.99,0.99,2.99,0.99,0.99,0.99,4.99,2.99,0.99,2.99,2.99,0.99,4.99,0.99,2.99,2.99,2.99,0.99,2.99,0.99,2.99,4.99,4.99,4.99,0.99,0.99,2.99,4.99,4.99,0.99,4.99,4.99,0.99,4.99,2.99,0.99,0.99,2.99,4.99,4.99,2.99,4.99,0.99,4.99,4.99,4.99,4.99,4.99,4.99,2.99,2.99,2.99,0.99,2.99,0.99,2.99,4.99,2.99,4.99,4.99,4.99,2.99,2.99,2.99,4.99,0.99,0.99,0.99,4.99,2.99,2.99,2.99,4.99,2.99,4.99,0.99,0.99,4.99,4.99,2.99,2.99,4.99,0.99,0.99,0.99,0.99,2.99,4.99,2.99,0.99,4.99,2.99,2.99,0.99,0.99,0.99,2.99,0.99,4.99,2.99,2.99,4.99,2.99,2.99,2.99,2.99,4.99,2.99,2.99,4.99,4.99,0.99,0.99,2.99,4.99,4.99,4.99,2.99,0.99,2.99,2.99,0.99,2.99,2.99,0.99,4.99,4.99,0.99,2.99,2.99,2.99,0.99,2.99,0.99,0.99,0.99,0.99,2.99,4.99,4.99,0.99,2.99,0.99,0.99,4.99,2.99,4.99,2.99,2.99,2.99,4.99,4.99,0.99,2.99,4.99,4.99,0.99,4.99,0.99,4.99,2.99,2.99,0.99,4.99,0.99,2.99,0.99,0.99,0.99,0.99,2.99,4.99,4.99,4.99,0.99,0.99,4.99,0.99,0.99,2.99,2.99,4.99,0.99,0.99,2.99,2.99,2.99,4.99,2.99,0.99,4.99,2.99,2.99,4.99,4.99,4.99,4.99,0.99,4.99,4.99,4.99,4.99,2.99,0.99,4.99,0.99,4.99,0.99,0.99,0.99,2.99,4.99,0.99,4.99,2.99,2.99,0.99,2.99,4.99,2.99,2.99,2.99,4.99,2.99,2.99,2.99,0.99,0.99,4.99,2.99,4.99,0.99,2.99,2.99,2.99,0.99,4.99,4.99,0.99,4.99,4.99,0.99,0.99,0.99,0.99,4.99,0.99,0.99,4.99,0.99,4.99,0.99,2.99,4.99,2.99,4.99,0.99,0.99,4.99,2.99,4.99,4.99,2.99,4.99,4.99,0.99,0.99,4.99,2.99,2.99,4.99,4.99,2.99,4.99,2.99,0.99,4.99,0.99,4.99,4.99,2.99,2.99,4.99,2.99,2.99,0.99,0.99,0.99,2.99,0.99,2.99,0.99,0.99,2.99,4.99,0.99,2.99,4.99,2.99,4.99,2.99,0.99,4.99,2.99,2.99,0.99,4.99,0.99,4.99,4.99,4.99,4.99,0.99,0.99,2.99,0.99,2.99,4.99,2.99,4.99,2.99,4.99,4.99,4.99,4.99,2.99,4.99,4.99,0.99,2.99,0.99,2.99,2.99,4.99,2.99,4.99,2.99,4.99,4.99,0.99,4.99,2.99,4.99,4.99,0.99,0.99,4.99,4.99,2.99,0.99,2.99,4.99,0.99,0.99,0.99,2.99,2.99,0.99,4.99,4.99,0.99,2.99,2.99,4.99,2.99,2.99,0.99,0.99,2.99,0.99,4.99,0.99,2.99,0.99,0.99,2.99,4.99,4.99,0.99,0.99,4.99,0.99,0.99,2.99,2.99,4.99,0.99,2.99,0.99,0.99,2.99,4.99,4.99,0.99,0.99,2.99,2.99,2.99,2.99,4.99,4.99,0.99,0.99,4.99,0.99,4.99,0.99,0.99,2.99,2.99,0.99,2.99,0.99,0.99,2.99,4.99,4.99,4.99,4.99,2.99,4.99,2.99,2.99,4.99,2.99,4.99,4.99,0.99,0.99,0.99,0.99,4.99,4.99,2.99,2.99,2.99,0.99,4.99,2.99,4.99,0.99,4.99,4.99,0.99,0.99,2.99,0.99,2.99,4.99,0.99,0.99,0.99,2.99,2.99,2.99,4.99,2.99,0.99,4.99,0.99,4.99,4.99,4.99,4.99,0.99,2.99,4.99,2.99,2.99,2.99,2.99,2.99,4.99,2.99,4.99,0.99,2.99,4.99,2.99,4.99,4.99,2.99,2.99,4.99],[34,33,32,32,32,32,32,31,31,31,31,31,31,31,31,31,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,28,28,28,28,28,28,28,28,28,28,28,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,5,5,5,5,5,5,5,5,5,5,5,5,5,5,4,4,4,1],[169.66,32.67,31.68,95.68,31.68,31.68,159.68,154.69,92.69,154.69,30.69,30.69,154.69,30.69,92.69,154.69,149.7,29.7,29.7,149.7,89.7,149.7,89.7,89.7,89.7,89.7,29.7,149.7,149.7,29.7,89.7,29.7,86.71,28.71,144.71,144.71,28.71,28.71,144.71,28.71,86.71,28.71,28.71,86.71,144.71,144.71,86.71,27.72,27.72,27.72,83.72,83.72,27.72,139.72,139.72,139.72,139.72,27.72,26.73,80.73,134.73,134.73,26.73,80.73,134.73,26.73,80.73,80.73,80.73,26.73,26.73,80.73,134.73,80.73,26.73,134.73,26.73,134.73,26.73,26.73,26.73,134.73,26.73,80.73,77.74,77.74,25.74,77.74,25.74,129.74,77.74,77.74,129.74,25.74,25.74,77.74,77.74,25.74,129.74,129.74,25.74,25.74,129.74,77.74,77.74,129.74,129.74,129.74,74.75,124.75,74.75,24.75,24.75,124.75,74.75,24.75,124.75,74.75,24.75,74.75,74.75,24.75,24.75,24.75,124.75,124.75,24.75,24.75,74.75,24.75,24.75,74.75,74.75,124.75,74.75,23.76,23.76,119.76,71.76,23.76,71.76,23.76,71.76,119.76,23.76,23.76,119.76,71.76,23.76,23.76,119.76,23.76,71.76,119.76,119.76,23.76,119.76,23.76,71.76,71.76,119.76,23.76,71.76,23.76,23.76,71.76,23.76,71.76,68.77,114.77,22.77,22.77,22.77,114.77,114.77,22.77,22.77,114.77,68.77,114.77,114.77,114.77,114.77,68.77,22.77,22.77,114.77,22.77,22.77,114.77,68.77,114.77,114.77,114.77,114.77,68.77,68.77,22.77,68.77,68.77,68.77,68.77,68.77,114.77,21.78,21.78,109.78,65.78,109.78,109.78,21.78,21.78,65.78,109.78,65.78,21.78,65.78,21.78,109.78,109.78,65.78,65.78,109.78,21.78,21.78,109.78,109.78,109.78,109.78,65.78,109.78,65.78,21.78,109.78,21.78,109.78,21.78,21.78,65.78,65.78,109.78,21.78,65.78,62.79,20.79,62.79,20.79,62.79,20.79,20.79,20.79,20.79,20.79,104.79,20.79,104.79,62.79,20.79,20.79,104.79,20.79,62.79,104.79,104.79,62.79,62.79,20.79,20.79,104.79,104.79,104.79,20.79,62.79,62.79,104.79,62.79,20.79,62.79,62.79,62.79,20.79,62.79,20.79,20.79,62.79,20.79,104.79,62.79,104.79,20.79,62.79,20.79,20.79,104.79,20.79,59.8,59.8,59.8,99.8,19.8,59.8,99.8,59.8,59.8,19.8,19.8,19.8,19.8,19.8,59.8,99.8,99.8,99.8,19.8,99.8,59.8,59.8,19.8,19.8,99.8,99.8,99.8,99.8,99.8,99.8,19.8,59.8,19.8,19.8,19.8,99.8,59.8,19.8,19.8,59.8,99.8,99.8,99.8,18.81,18.81,18.81,18.81,18.81,94.81,56.81,18.81,18.81,56.81,18.81,18.81,94.81,18.81,94.81,94.81,56.81,94.81,18.81,94.81,56.81,94.81,56.81,94.81,56.81,94.81,56.81,18.81,18.81,18.81,18.81,18.81,56.81,18.81,94.81,94.81,18.81,18.81,94.81,18.81,94.81,18.81,56.81,56.81,18.81,17.82,17.82,89.82,53.82,89.82,17.82,17.82,17.82,53.82,89.82,89.82,89.82,53.82,53.82,17.82,17.82,17.82,53.82,89.82,53.82,53.82,53.82,53.82,53.82,89.82,89.82,53.82,89.82,53.82,53.82,53.82,53.82,53.82,89.82,89.82,89.82,17.82,89.82,53.82,53.82,17.82,53.82,89.82,16.83,16.83,50.83,50.83,50.83,84.83,84.83,16.83,84.83,50.83,84.83,50.83,84.83,16.83,50.83,50.83,84.83,16.83,84.83,84.83,16.83,84.83,50.83,84.83,84.83,16.83,84.83,84.83,16.83,16.83,50.83,84.83,16.83,16.83,16.83,84.83,50.83,50.83,50.83,50.83,84.83,16.83,50.83,50.83,50.83,84.83,84.83,16.83,84.83,79.84,15.84,47.84,15.84,15.84,15.84,79.84,47.84,15.84,47.84,47.84,15.84,79.84,15.84,47.84,47.84,47.84,15.84,47.84,15.84,47.84,79.84,79.84,79.84,15.84,15.84,47.84,79.84,79.84,15.84,79.84,79.84,15.84,79.84,47.84,15.84,15.84,47.84,79.84,79.84,47.84,79.84,15.84,79.84,79.84,79.84,79.84,79.84,79.84,47.84,47.84,47.84,15.84,47.84,14.85,44.85,74.85,44.85,74.85,74.85,74.85,44.85,44.85,44.85,74.85,14.85,14.85,14.85,74.85,44.85,44.85,44.85,74.85,44.85,74.85,14.85,14.85,74.85,74.85,44.85,44.85,74.85,14.85,14.85,14.85,14.85,44.85,74.85,44.85,14.85,74.85,44.85,44.85,14.85,14.85,14.85,44.85,14.85,74.85,44.85,44.85,74.85,44.85,44.85,44.85,41.86,69.86,41.86,41.86,69.86,69.86,13.86,13.86,41.86,69.86,69.86,69.86,41.86,13.86,41.86,41.86,13.86,41.86,41.86,13.86,69.86,69.86,13.86,41.86,41.86,41.86,13.86,41.86,13.86,13.86,13.86,13.86,41.86,69.86,69.86,13.86,41.86,13.86,13.86,69.86,41.86,69.86,41.86,41.86,41.86,69.86,69.86,12.87,38.87,64.87,64.87,12.87,64.87,12.87,64.87,38.87,38.87,12.87,64.87,12.87,38.87,12.87,12.87,12.87,12.87,38.87,64.87,64.87,64.87,12.87,12.87,64.87,12.87,12.87,38.87,38.87,64.87,12.87,12.87,38.87,38.87,38.87,64.87,38.87,12.87,64.87,38.87,38.87,64.87,64.87,64.87,64.87,12.87,64.87,64.87,64.87,64.87,38.87,12.87,59.88,11.88,59.88,11.88,11.88,11.88,35.88,59.88,11.88,59.88,35.88,35.88,11.88,35.88,59.88,35.88,35.88,35.88,59.88,35.88,35.88,35.88,11.88,11.88,59.88,35.88,59.88,11.88,35.88,35.88,35.88,11.88,59.88,59.88,11.88,59.88,54.89,10.89,10.89,10.89,10.89,54.89,10.89,10.89,54.89,10.89,54.89,10.89,32.89,54.89,32.89,54.89,10.89,10.89,54.89,32.89,54.89,54.89,32.89,54.89,54.89,10.89,10.89,54.89,32.89,32.89,54.89,54.89,32.89,54.89,32.89,10.89,54.89,10.89,54.89,49.9,29.9,29.9,49.9,29.9,29.9,9.9,9.9,9.9,29.9,9.9,29.9,9.9,9.9,29.9,49.9,9.9,29.9,49.9,29.9,49.9,29.9,9.9,49.9,29.9,29.9,9.9,49.9,9.9,49.9,49.9,49.9,49.9,9.9,9.9,29.9,9.9,29.9,44.91,26.91,44.91,26.91,44.91,44.91,44.91,44.91,26.91,44.91,44.91,8.91,26.91,8.91,26.91,26.91,44.91,26.91,44.91,26.91,44.91,44.91,8.91,44.91,26.91,44.91,44.91,8.91,8.91,44.91,44.91,26.91,8.91,26.91,44.91,8.91,8.91,8.91,26.91,26.91,8.91,44.91,44.91,8.91,23.92,23.92,39.92,23.92,23.92,7.92,7.92,23.92,7.92,39.92,7.92,23.92,7.92,7.92,23.92,39.92,39.92,7.92,7.92,39.92,7.92,7.92,23.92,23.92,39.92,7.92,23.92,7.92,7.92,23.92,39.92,39.92,7.92,7.92,23.92,23.92,20.93,20.93,34.93,34.93,6.93,6.93,34.93,6.93,34.93,6.93,6.93,20.93,20.93,6.93,20.93,6.93,6.93,20.93,34.93,34.93,34.93,34.93,20.93,34.93,20.93,20.93,34.93,20.93,34.93,34.93,6.93,6.93,6.93,6.93,34.93,34.93,20.93,20.93,17.94,5.94,29.94,17.94,29.94,5.94,29.94,29.94,5.94,5.94,17.94,5.94,17.94,29.94,5.94,5.94,5.94,17.94,17.94,17.94,29.94,17.94,5.94,29.94,5.94,29.94,29.94,29.94,29.94,5.94,17.94,24.95,14.95,14.95,14.95,14.95,14.95,24.95,14.95,24.95,4.95,14.95,24.95,14.95,24.95,19.96,11.96,11.96,4.99]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>film_id<\/th>\n      <th>title<\/th>\n      <th>rental_rate<\/th>\n      <th>count<\/th>\n      <th>rental_amt<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>The most frequently rented movie, 34 times, is ‘Bucket Brotherhood’ followed by Rocketeer Mother, 33 times.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-10" class="section level4">
<h4><span class="header-section-number">20.1.9.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb436"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb436-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb436-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb436-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb436-4" data-line-number="4"></a>
<a class="sourceLine" id="cb436-5" data-line-number="5">film_rank_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb436-6" data-line-number="6"></a>
<a class="sourceLine" id="cb436-7" data-line-number="7"><span class="kw">sp_print_df</span>(film_rank_dplyr)</a></code></pre></div>
<div id="htmlwidget-a98751c486bb4e6734fc" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-a98751c486bb4e6734fc">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="what-is-the-rental-distributiondvd-for-the-top-two-rented-films" class="section level3">
<h3><span class="header-section-number">20.1.10</span> 11 What is the rental distribution/DVD for the top two rented films?</h3>
<p>From the previous exercise we know that the top two films are <code>Bucket Brotherhood</code> and <code>Rocketeer Mother</code>.</p>
<p>To answer this question we look at the <code>rental</code>, <code>inventory</code>, and <code>film</code> tables again.</p>
<p>Instead of looking at the film level, we need to drill down to the individual dvd’s for each film to answer this question.</p>
<div class="sourceCode" id="cb437"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb437-1" data-line-number="1">film_rank2_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb437-2" data-line-number="2"><span class="st">&quot;select i.store_id,i.film_id,f.title,i.inventory_id,count(*) </span></a>
<a class="sourceLine" id="cb437-3" data-line-number="3"><span class="st">   from rental r join inventory i on r.inventory_id = i.inventory_id </span></a>
<a class="sourceLine" id="cb437-4" data-line-number="4"><span class="st">        join film f on i.film_id = f.film_id</span></a>
<a class="sourceLine" id="cb437-5" data-line-number="5"><span class="st">  where i.film_id in (103,738)</span></a>
<a class="sourceLine" id="cb437-6" data-line-number="6"><span class="st">group by i.store_id,i.film_id,f.title,i.inventory_id&quot;</span>)</a>
<a class="sourceLine" id="cb437-7" data-line-number="7"></a>
<a class="sourceLine" id="cb437-8" data-line-number="8"><span class="kw">sp_print_df</span>(film_rank2_sql)</a></code></pre></div>
<div id="htmlwidget-90472fc291eea3b37ad9" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-90472fc291eea3b37ad9">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16"],[2,2,1,1,1,2,1,2,2,1,1,1,1,2,2,2],[738,738,738,738,103,738,738,103,103,103,738,103,103,738,103,103],["Rocketeer Mother","Rocketeer Mother","Rocketeer Mother","Rocketeer Mother","Bucket Brotherhood","Rocketeer Mother","Rocketeer Mother","Bucket Brotherhood","Bucket Brotherhood","Bucket Brotherhood","Rocketeer Mother","Bucket Brotherhood","Bucket Brotherhood","Rocketeer Mother","Bucket Brotherhood","Bucket Brotherhood"],[3367,3364,3361,3362,465,3365,3363,472,470,468,3360,467,466,3366,469,471],[5,5,3,2,3,4,5,2,5,5,5,4,5,4,5,5]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>store_id<\/th>\n      <th>film_id<\/th>\n      <th>title<\/th>\n      <th>inventory_id<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>The ‘Bucket Brotherhood’ and ‘Rocketeer Mother’ DVD’s are equally distributed between the two stores, 4 dvd’s each per film. The ‘Bucket Brotherhood’ was rented 17 times from both stores. The ‘Rocketeer Mother’ was rented 15 times from store 1 and 18 times from store 2.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-11" class="section level4">
<h4><span class="header-section-number">20.1.10.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb438"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb438-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb438-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb438-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb438-4" data-line-number="4"></a>
<a class="sourceLine" id="cb438-5" data-line-number="5">film_rank2_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb438-6" data-line-number="6"></a>
<a class="sourceLine" id="cb438-7" data-line-number="7"><span class="kw">sp_print_df</span>(film_rank2_dplyr)</a></code></pre></div>
<div id="htmlwidget-6c084255227fcd56827e" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6c084255227fcd56827e">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="list-staffing-information-for-store-1-associated-with-the-bucket-brother-rentals" class="section level3">
<h3><span class="header-section-number">20.1.11</span> 12. List staffing information for store 1 associated with the <code>Bucket Brother</code> rentals?</h3>
<p>To answer this question we look at the <code>rental</code>, <code>inventory</code>, <code>film</code>, <code>staff</code>, <code>address</code>, <code>city</code>, and <code>country</code> tables.</p>
<div class="sourceCode" id="cb439"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb439-1" data-line-number="1">film_<span class="dv">103</span>_details_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb439-2" data-line-number="2"><span class="st">&quot;select i.store_id,i.film_id,f.title,i.inventory_id inv_id,i.store_id inv_store_id</span></a>
<a class="sourceLine" id="cb439-3" data-line-number="3"><span class="st">       ,r.rental_date::date rented,r.return_date::date returned</span></a>
<a class="sourceLine" id="cb439-4" data-line-number="4"><span class="st">       ,s.staff_id,s.store_id staff_store_id,concat(s.first_name,&#39; &#39;,s.last_name) staff,ctry.country</span></a>
<a class="sourceLine" id="cb439-5" data-line-number="5"><span class="st">   from rental r join inventory i on r.inventory_id = i.inventory_id </span></a>
<a class="sourceLine" id="cb439-6" data-line-number="6"><span class="st">        join film f on i.film_id = f.film_id</span></a>
<a class="sourceLine" id="cb439-7" data-line-number="7"><span class="st">        join staff s on r.staff_id = s.staff_id</span></a>
<a class="sourceLine" id="cb439-8" data-line-number="8"><span class="st">        join address a on s.address_id = a.address_id</span></a>
<a class="sourceLine" id="cb439-9" data-line-number="9"><span class="st">        join city c on a.city_id = c.city_id</span></a>
<a class="sourceLine" id="cb439-10" data-line-number="10"><span class="st">        join country ctry on c.country_id = ctry.country_id</span></a>
<a class="sourceLine" id="cb439-11" data-line-number="11"><span class="st">  where i.film_id in (103)</span></a>
<a class="sourceLine" id="cb439-12" data-line-number="12"><span class="st">    and r.rental_date::date between &#39;2005-05-01&#39;::date and &#39;2005-06-01&#39;::date</span></a>
<a class="sourceLine" id="cb439-13" data-line-number="13"><span class="st">order by r.rental_date</span></a>
<a class="sourceLine" id="cb439-14" data-line-number="14"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb439-15" data-line-number="15"><span class="kw">sp_print_df</span>(film_<span class="dv">103</span>_details_sql)</a></code></pre></div>
<div id="htmlwidget-cc911bce9136bf4e7dfd" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-cc911bce9136bf4e7dfd">{"x":{"filter":"none","data":[["1","2","3","4","5"],[1,2,2,1,2],[103,103,103,103,103],["Bucket Brotherhood","Bucket Brotherhood","Bucket Brotherhood","Bucket Brotherhood","Bucket Brotherhood"],[466,470,471,468,469],[1,2,2,1,2],["2005-05-25","2005-05-25","2005-05-30","2005-05-31","2005-05-31"],["2005-05-27","2005-05-29","2005-06-05","2005-06-03","2005-06-02"],[1,1,1,2,2],[1,1,1,2,2],["Mike Hillyer","Mike Hillyer","Mike Hillyer","Jon Stephens","Jon Stephens"],["Canada","Canada","Canada","Australia","Australia"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>store_id<\/th>\n      <th>film_id<\/th>\n      <th>title<\/th>\n      <th>inv_id<\/th>\n      <th>inv_store_id<\/th>\n      <th>rented<\/th>\n      <th>returned<\/th>\n      <th>staff_id<\/th>\n      <th>staff_store_id<\/th>\n      <th>staff<\/th>\n      <th>country<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,4,5,8,9]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>In a previous exercise we saw that store 1 based in Canada and store 2 based in Austrailia each had one employee, staff_id 1 and 2 respectively. We see that Mike from store 1, Canada, had transactions in store 1 and store 2 on 5/25/2005. Similarly Jon from store 2, Australia, had transaction in store 2 and store 1 on 5/31/2005. Is this phsically possible, or a key in error?</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-12" class="section level4">
<h4><span class="header-section-number">20.1.11.1</span> Replicate the output above using dplyr syntax.</h4>
<table>
<thead>
<tr class="header">
<th>column</th>
<th>mapping</th>
<th>definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>inv_id</td>
<td>inventory.inventory_id</td>
<td></td>
</tr>
<tr class="even">
<td>inv_store_id</td>
<td>inventory.store_id</td>
<td></td>
</tr>
<tr class="odd">
<td>rented</td>
<td>rental.rental_date</td>
<td></td>
</tr>
<tr class="even">
<td>returned</td>
<td>rental.return_date</td>
<td></td>
</tr>
<tr class="odd">
<td>staff_store_id</td>
<td>store.store_id</td>
<td></td>
</tr>
<tr class="even">
<td>staff</td>
<td>first_name+last_name</td>
<td></td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb440"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb440-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb440-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb440-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb440-4" data-line-number="4"></a>
<a class="sourceLine" id="cb440-5" data-line-number="5">film_<span class="dv">103</span>_details_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb440-6" data-line-number="6"></a>
<a class="sourceLine" id="cb440-7" data-line-number="7"><span class="kw">sp_print_df</span>(film_<span class="dv">103</span>_details_dplyr)</a></code></pre></div>
<div id="htmlwidget-6c3e37b0fa7ac693f7cc" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6c3e37b0fa7ac693f7cc">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="which-films-have-never-been-rented" class="section level3">
<h3><span class="header-section-number">20.1.12</span> 13. Which film(s) have never been rented</h3>
<p>To answer this question we look at the <code>film</code>, <code>inventory</code> and <code>rental</code> tables.</p>
<div class="sourceCode" id="cb441"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb441-1" data-line-number="1">never_rented_dvds_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb441-2" data-line-number="2"><span class="st">&#39;select i.store_id,f.film_id, f.title,f.description, i.inventory_id</span></a>
<a class="sourceLine" id="cb441-3" data-line-number="3"><span class="st">   from film f join inventory i on f.film_id = i.film_id</span></a>
<a class="sourceLine" id="cb441-4" data-line-number="4"><span class="st">        left join rental r on i.inventory_id = r.inventory_id </span></a>
<a class="sourceLine" id="cb441-5" data-line-number="5"><span class="st">  where r.inventory_id is null </span></a>
<a class="sourceLine" id="cb441-6" data-line-number="6"><span class="st">&#39;</span></a>
<a class="sourceLine" id="cb441-7" data-line-number="7">)</a>
<a class="sourceLine" id="cb441-8" data-line-number="8"></a>
<a class="sourceLine" id="cb441-9" data-line-number="9"><span class="kw">sp_print_df</span>(never_rented_dvds_sql)</a></code></pre></div>
<div id="htmlwidget-88984347109043009685" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-88984347109043009685">{"x":{"filter":"none","data":[["1","2"],[2,2],[1,1001],["Academy Dinosaur","Sophie's Choice"],["A Epic Drama of a Feminist And a Mad Scientist who must Battle a Teacher in The Canadian Rockies","orphaned language_id=10"],[5,4583]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>store_id<\/th>\n      <th>film_id<\/th>\n      <th>title<\/th>\n      <th>description<\/th>\n      <th>inventory_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>There are only two movies that have not been rented, Academy Dinousaur and Sophie’s Choice.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-13" class="section level4">
<h4><span class="header-section-number">20.1.12.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb442"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb442-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb442-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb442-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb442-4" data-line-number="4"></a>
<a class="sourceLine" id="cb442-5" data-line-number="5">never_rented_dvds_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb442-6" data-line-number="6"></a>
<a class="sourceLine" id="cb442-7" data-line-number="7"><span class="kw">sp_print_df</span>(never_rented_dvds_dplyr)</a></code></pre></div>
<div id="htmlwidget-d80799441e19bf040cbf" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-d80799441e19bf040cbf">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="how-many-films-are-in-each-film-rating" class="section level3">
<h3><span class="header-section-number">20.1.13</span> 14. How many films are in each film rating?</h3>
<p>To answer this question we look at the <code>film</code> table to answer this question.</p>
<div class="sourceCode" id="cb443"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb443-1" data-line-number="1">film_ratings_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb443-2" data-line-number="2"><span class="st">&#39;select f.rating,count(*)</span></a>
<a class="sourceLine" id="cb443-3" data-line-number="3"><span class="st">   from film f </span></a>
<a class="sourceLine" id="cb443-4" data-line-number="4"><span class="st">group by f.rating</span></a>
<a class="sourceLine" id="cb443-5" data-line-number="5"><span class="st">order by count(*) desc</span></a>
<a class="sourceLine" id="cb443-6" data-line-number="6"><span class="st">&#39;</span></a>
<a class="sourceLine" id="cb443-7" data-line-number="7">)</a>
<a class="sourceLine" id="cb443-8" data-line-number="8"></a>
<a class="sourceLine" id="cb443-9" data-line-number="9"><span class="kw">sp_print_df</span>(film_ratings_sql)</a></code></pre></div>
<div id="htmlwidget-5bc260cc0681d28b4458" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5bc260cc0681d28b4458">{"x":{"filter":"none","data":[["1","2","3","4","5"],["PG-13","NC-17","R","PG","G"],[223,210,195,195,178]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>rating<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":2},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>There are 5 ratings and all 5 have roughly 200 movies.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-14" class="section level4">
<h4><span class="header-section-number">20.1.13.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb444"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb444-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb444-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb444-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb444-4" data-line-number="4"></a>
<a class="sourceLine" id="cb444-5" data-line-number="5">film_ratings_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb444-6" data-line-number="6"></a>
<a class="sourceLine" id="cb444-7" data-line-number="7"><span class="kw">sp_print_df</span>(film_ratings_dplyr)</a></code></pre></div>
<div id="htmlwidget-5e6debc8bc477449b2d2" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5e6debc8bc477449b2d2">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="what-are-the-different-film-categories" class="section level3">
<h3><span class="header-section-number">20.1.14</span> 15. What are the different film categories?</h3>
<p>To answer this question we look at the <code>category</code> table to answer this question.</p>
<div class="sourceCode" id="cb445"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb445-1" data-line-number="1">film_categories_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb445-2" data-line-number="2"><span class="st">&#39;select * from category&#39;</span></a>
<a class="sourceLine" id="cb445-3" data-line-number="3">)</a>
<a class="sourceLine" id="cb445-4" data-line-number="4"></a>
<a class="sourceLine" id="cb445-5" data-line-number="5"><span class="kw">sp_print_df</span>(film_categories_sql)</a></code></pre></div>
<div id="htmlwidget-a769f33e9bc2b11da24f" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-a769f33e9bc2b11da24f">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16"],[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16],["Action","Animation","Children","Classics","Comedy","Documentary","Drama","Family","Foreign","Games","Horror","Music","New","Sci-Fi","Sports","Travel"],["2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>category_id<\/th>\n      <th>name<\/th>\n      <th>last_update<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":1},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>There are 16 different categories</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-15" class="section level4">
<h4><span class="header-section-number">20.1.14.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb446"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb446-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb446-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb446-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb446-4" data-line-number="4"></a>
<a class="sourceLine" id="cb446-5" data-line-number="5">film_categories_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb446-6" data-line-number="6"></a>
<a class="sourceLine" id="cb446-7" data-line-number="7"><span class="kw">sp_print_df</span>(film_categories_dplyr)</a></code></pre></div>
<div id="htmlwidget-5afb8971f37330fd8cc4" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5afb8971f37330fd8cc4">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="how-many-dvds-are-in-each-film-categeory" class="section level3">
<h3><span class="header-section-number">20.1.15</span> 16. How many DVD’s are in each film categeory?</h3>
<p>To answer this question we look at the <code>category</code> table again.</p>
<div class="sourceCode" id="cb447"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb447-1" data-line-number="1">film_categories2_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb447-2" data-line-number="2"><span class="st">&#39;select c.name,count(*) count</span></a>
<a class="sourceLine" id="cb447-3" data-line-number="3"><span class="st">   from category c join film_category fc on c.category_id = fc.category_id</span></a>
<a class="sourceLine" id="cb447-4" data-line-number="4"><span class="st">group by c.name</span></a>
<a class="sourceLine" id="cb447-5" data-line-number="5"><span class="st">order by count(*) desc</span></a>
<a class="sourceLine" id="cb447-6" data-line-number="6"><span class="st">&#39;</span></a>
<a class="sourceLine" id="cb447-7" data-line-number="7">)</a>
<a class="sourceLine" id="cb447-8" data-line-number="8"></a>
<a class="sourceLine" id="cb447-9" data-line-number="9"><span class="kw">sp_print_df</span>(film_categories2_sql)</a></code></pre></div>
<div id="htmlwidget-e9ae68682532316859d5" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-e9ae68682532316859d5">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16"],["Sports","Foreign","Family","Documentary","Animation","Action","New","Drama","Sci-Fi","Games","Children","Comedy","Travel","Classics","Horror","Music"],[74,73,69,69,66,64,63,63,61,61,60,58,57,57,56,51]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>name<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":2},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>There are 16 film categories. The highest category, Sports, has 77 films followed by the International category which has 76 film. What is an example of an international category film where all films are currently in English?</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-16" class="section level4">
<h4><span class="header-section-number">20.1.15.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb448"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb448-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb448-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb448-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb448-4" data-line-number="4"></a>
<a class="sourceLine" id="cb448-5" data-line-number="5">film_categories2_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb448-6" data-line-number="6"></a>
<a class="sourceLine" id="cb448-7" data-line-number="7"><span class="kw">sp_print_df</span>(film_categories2_dplyr)</a></code></pre></div>
<div id="htmlwidget-32dc6527565d6d2fa8eb" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-32dc6527565d6d2fa8eb">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="which-films-are-listed-in-multiple-categories" class="section level3">
<h3><span class="header-section-number">20.1.16</span> 17. Which films are listed in multiple categories?</h3>
<p>To answer this question we look at the <code>film</code>, <code>film_category</code> and <code>category</code> tables.</p>
<div class="sourceCode" id="cb449"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb449-1" data-line-number="1">multiple_categories_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb449-2" data-line-number="2"><span class="st">&#39;select f.film_id, f.title,c.name</span></a>
<a class="sourceLine" id="cb449-3" data-line-number="3"><span class="st">   from film_category fc join film f on fc.film_id = f.film_id</span></a>
<a class="sourceLine" id="cb449-4" data-line-number="4"><span class="st">        join category c on fc.category_id = c.category_id</span></a>
<a class="sourceLine" id="cb449-5" data-line-number="5"><span class="st">  where fc.film_id in (select fc.film_id</span></a>
<a class="sourceLine" id="cb449-6" data-line-number="6"><span class="st">                         from film f join film_category fc on f.film_id = fc.film_id</span></a>
<a class="sourceLine" id="cb449-7" data-line-number="7"><span class="st">                       group by fc.film_id</span></a>
<a class="sourceLine" id="cb449-8" data-line-number="8"><span class="st">                       having count(*) &gt; 1</span></a>
<a class="sourceLine" id="cb449-9" data-line-number="9"><span class="st">                       ) </span></a>
<a class="sourceLine" id="cb449-10" data-line-number="10"><span class="st">&#39;</span></a>
<a class="sourceLine" id="cb449-11" data-line-number="11">)</a>
<a class="sourceLine" id="cb449-12" data-line-number="12"></a>
<a class="sourceLine" id="cb449-13" data-line-number="13"><span class="kw">sp_print_df</span>(multiple_categories_sql)</a></code></pre></div>
<div id="htmlwidget-bbe1f43178625f07ed69" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-bbe1f43178625f07ed69">{"x":{"filter":"none","data":[["1","2"],[1001,1001],["Sophie's Choice","Sophie's Choice"],["Documentary","Drama"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>film_id<\/th>\n      <th>title<\/th>\n      <th>name<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":1},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>There is only one film which has two categories, Sophie’s Choice.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-17" class="section level4">
<h4><span class="header-section-number">20.1.16.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb450"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb450-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb450-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb450-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb450-4" data-line-number="4"></a>
<a class="sourceLine" id="cb450-5" data-line-number="5">multiple_categories_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb450-6" data-line-number="6"></a>
<a class="sourceLine" id="cb450-7" data-line-number="7"><span class="kw">sp_print_df</span>(multiple_categories_dplyr)</a></code></pre></div>
<div id="htmlwidget-f44584fa5e4f08aaeb0b" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-f44584fa5e4f08aaeb0b">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="which-dvds-are-in-one-stores-inventory-but-not-the-other" class="section level3">
<h3><span class="header-section-number">20.1.17</span> 18. Which DVD’s are in one store’s inventory but not the other</h3>
<p>In the table below we show the first 10 rows.</p>
<p>To answer this question we look at the <code>inventory</code> and <code>film</code> tables.</p>
<div class="sourceCode" id="cb451"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb451-1" data-line-number="1">dvd_in_<span class="dv">1</span>_store_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb451-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb451-3" data-line-number="3">  <span class="st">&quot;</span></a>
<a class="sourceLine" id="cb451-4" data-line-number="4"><span class="st">--   select store1,count(count1) films_not_in_store_2,sum(coalesce(count1,0)) dvds_not_in_store_1</span></a>
<a class="sourceLine" id="cb451-5" data-line-number="5"><span class="st">--         ,store2,count(count2) films_not_in_store_1,sum(coalesce(count2,0)) dvds_not_in_store_2</span></a>
<a class="sourceLine" id="cb451-6" data-line-number="6"><span class="st">--     from (</span></a>
<a class="sourceLine" id="cb451-7" data-line-number="7"><span class="st">             select coalesce(i1.film_id,i2.film_id) film_id,f.title,f.rental_rate</span></a>
<a class="sourceLine" id="cb451-8" data-line-number="8"><span class="st">                   ,1 store1,coalesce(i1.count,0) count1</span></a>
<a class="sourceLine" id="cb451-9" data-line-number="9"><span class="st">                   ,2 store2,coalesce(i2.count,0) count2</span></a>
<a class="sourceLine" id="cb451-10" data-line-number="10"><span class="st">                  -- dvd inventory in store 1</span></a>
<a class="sourceLine" id="cb451-11" data-line-number="11"><span class="st">               from (select film_id,store_id,count(*) count </span></a>
<a class="sourceLine" id="cb451-12" data-line-number="12"><span class="st">                       from inventory where store_id = 1 </span></a>
<a class="sourceLine" id="cb451-13" data-line-number="13"><span class="st">                      group by film_id,store_id</span></a>
<a class="sourceLine" id="cb451-14" data-line-number="14"><span class="st">                    ) as i1</span></a>
<a class="sourceLine" id="cb451-15" data-line-number="15"><span class="st">                    full outer join </span></a>
<a class="sourceLine" id="cb451-16" data-line-number="16"><span class="st">                  -- dvd inventory in store 2</span></a>
<a class="sourceLine" id="cb451-17" data-line-number="17"><span class="st">                    (select film_id,store_id,count(*) count</span></a>
<a class="sourceLine" id="cb451-18" data-line-number="18"><span class="st">                       from inventory where store_id = 2 </span></a>
<a class="sourceLine" id="cb451-19" data-line-number="19"><span class="st">                     group by film_id,store_id</span></a>
<a class="sourceLine" id="cb451-20" data-line-number="20"><span class="st">                    ) as i2</span></a>
<a class="sourceLine" id="cb451-21" data-line-number="21"><span class="st">                 on i1.film_id = i2.film_id </span></a>
<a class="sourceLine" id="cb451-22" data-line-number="22"><span class="st">               join film f </span></a>
<a class="sourceLine" id="cb451-23" data-line-number="23"><span class="st">                 on coalesce(i1.film_id,i2.film_id) = f.film_id</span></a>
<a class="sourceLine" id="cb451-24" data-line-number="24"><span class="st">             where i1.film_id is null or i2.film_id is null</span></a>
<a class="sourceLine" id="cb451-25" data-line-number="25"><span class="st">             order by f.title  </span></a>
<a class="sourceLine" id="cb451-26" data-line-number="26"><span class="st">--          ) as src</span></a>
<a class="sourceLine" id="cb451-27" data-line-number="27"><span class="st">--    group by store1,store2</span></a>
<a class="sourceLine" id="cb451-28" data-line-number="28"><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb451-29" data-line-number="29">)</a>
<a class="sourceLine" id="cb451-30" data-line-number="30"><span class="cf">if</span>(HEAD_N <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb451-31" data-line-number="31">    <span class="kw">sp_print_df</span>(<span class="kw">head</span>(dvd_in_<span class="dv">1</span>_store_sql,<span class="dt">n=</span>HEAD_N))</a>
<a class="sourceLine" id="cb451-32" data-line-number="32">} <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb451-33" data-line-number="33">    <span class="kw">sp_print_df</span>(dvd_in_<span class="dv">1</span>_store_sql)</a>
<a class="sourceLine" id="cb451-34" data-line-number="34">}</a></code></pre></div>
<div id="htmlwidget-33be21b5fff197bb7cc4" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-33be21b5fff197bb7cc4">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10"],[2,3,5,8,13,20,24,27,28,29],["Ace Goldfinger","Adaptation Holes","African Egg","Airport Pollock","Ali Forever","Amelie Hellfighters","Analyze Hoosiers","Anonymous Human","Anthem Luke","Antitrust Tomatoes"],[4.99,2.99,2.99,4.99,4.99,4.99,2.99,0.99,4.99,2.99],[1,1,1,1,1,1,1,1,1,1],[0,0,0,0,0,3,4,4,3,2],[2,2,2,2,2,2,2,2,2,2],[3,4,3,4,4,0,0,0,0,0]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>film_id<\/th>\n      <th>title<\/th>\n      <th>rental_rate<\/th>\n      <th>store1<\/th>\n      <th>count1<\/th>\n      <th>store2<\/th>\n      <th>count2<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3,4,5,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>Store 1 has 196 films, (576 dvd’s), that are not in store 2. Store 2 has 199 films, (607 dvd’s), that are not in store 1.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-18" class="section level4">
<h4><span class="header-section-number">20.1.17.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb452"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb452-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb452-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb452-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb452-4" data-line-number="4"></a>
<a class="sourceLine" id="cb452-5" data-line-number="5">inv_tbl1 &lt;-<span class="st"> </span>inventory_table <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb452-6" data-line-number="6"><span class="st">    </span><span class="kw">filter</span>(store_id <span class="op">==</span><span class="st"> </span><span class="dv">1</span> ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb452-7" data-line-number="7"><span class="st">    </span><span class="kw">group_by</span>(film_id) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb452-8" data-line-number="8"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">count=</span><span class="kw">n</span>())</a>
<a class="sourceLine" id="cb452-9" data-line-number="9">inv_tbl2 &lt;-<span class="st"> </span>inventory_table <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb452-10" data-line-number="10"><span class="st">    </span><span class="kw">filter</span>(store_id <span class="op">==</span><span class="st"> </span><span class="dv">2</span> ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb452-11" data-line-number="11"><span class="st">    </span><span class="kw">group_by</span>(film_id) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb452-12" data-line-number="12"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">count=</span><span class="kw">n</span>())</a>
<a class="sourceLine" id="cb452-13" data-line-number="13"></a>
<a class="sourceLine" id="cb452-14" data-line-number="14">dvd_in_<span class="dv">1</span>_store_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb452-15" data-line-number="15"></a>
<a class="sourceLine" id="cb452-16" data-line-number="16"><span class="cf">if</span>(HEAD_N <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb452-17" data-line-number="17">    <span class="kw">sp_print_df</span>(<span class="kw">head</span>(dvd_in_<span class="dv">1</span>_store_dplyr,<span class="dt">n=</span>HEAD_N))</a>
<a class="sourceLine" id="cb452-18" data-line-number="18">} <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb452-19" data-line-number="19">    <span class="kw">sp_print_df</span>(dvd_in_<span class="dv">1</span>_store_dplyr)</a>
<a class="sourceLine" id="cb452-20" data-line-number="20">}</a></code></pre></div>
<div id="htmlwidget-008e7554d5faa93bd1b9" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-008e7554d5faa93bd1b9">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="which-films-are-not-tracked-in-inventory" class="section level3">
<h3><span class="header-section-number">20.1.18</span> 19. Which films are not tracked in inventory?</h3>
<p>To answer this question we look at the <code>film</code> and <code>rental</code> tables.</p>
<div class="sourceCode" id="cb453"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb453-1" data-line-number="1">films_no_inventory_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb453-2" data-line-number="2"><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb453-3" data-line-number="3"><span class="st">select f.film_id,title,rating,rental_rate,replacement_cost</span></a>
<a class="sourceLine" id="cb453-4" data-line-number="4"><span class="st">  from film f left outer join inventory i on f.film_id = i.film_id</span></a>
<a class="sourceLine" id="cb453-5" data-line-number="5"><span class="st"> where i.film_id is null;</span></a>
<a class="sourceLine" id="cb453-6" data-line-number="6"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb453-7" data-line-number="7"></a>
<a class="sourceLine" id="cb453-8" data-line-number="8"><span class="cf">if</span>(HEAD_N <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb453-9" data-line-number="9">    <span class="kw">sp_print_df</span>(<span class="kw">head</span>(films_no_inventory_sql,<span class="dt">n=</span>HEAD_N))</a>
<a class="sourceLine" id="cb453-10" data-line-number="10">} <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb453-11" data-line-number="11">    <span class="kw">sp_print_df</span>(films_no_inventory_sql)</a>
<a class="sourceLine" id="cb453-12" data-line-number="12">}</a></code></pre></div>
<div id="htmlwidget-f943e07c4e65c2196ba8" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-f943e07c4e65c2196ba8">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10"],[14,33,36,38,41,87,108,128,144,148],["Alice Fantasia","Apollo Teen","Argonauts Town","Ark Ridgemont","Arsenic Independence","Boondock Ballroom","Butch Panther","Catch Amistad","Chinatown Gladiator","Chocolate Duck"],["NC-17","PG-13","PG-13","NC-17","PG","NC-17","PG-13","G","PG","R"],[0.99,2.99,0.99,0.99,0.99,0.99,0.99,0.99,4.99,2.99],[23.99,15.99,12.99,25.99,17.99,14.99,19.99,10.99,24.99,13.99]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>film_id<\/th>\n      <th>title<\/th>\n      <th>rating<\/th>\n      <th>rental_rate<\/th>\n      <th>replacement_cost<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>There are 42 films that do not exist in inventory or in either store. These may be DVD’s that have been ordered but the business has not received them. Looking at the price and the replacement cost, it doesn’t look like there is any rhyme or reason to the setting of the price.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-19" class="section level4">
<h4><span class="header-section-number">20.1.18.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb454"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb454-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb454-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb454-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb454-4" data-line-number="4"></a>
<a class="sourceLine" id="cb454-5" data-line-number="5">films_no_inventory_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb454-6" data-line-number="6"></a>
<a class="sourceLine" id="cb454-7" data-line-number="7"><span class="cf">if</span>(HEAD_N <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb454-8" data-line-number="8">    <span class="kw">sp_print_df</span>(<span class="kw">head</span>(films_no_inventory_dplyr,<span class="dt">n=</span>HEAD_N))</a>
<a class="sourceLine" id="cb454-9" data-line-number="9">} <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb454-10" data-line-number="10">    <span class="kw">sp_print_df</span>(films_no_inventory_dplyr)</a>
<a class="sourceLine" id="cb454-11" data-line-number="11">}</a></code></pre></div>
<div id="htmlwidget-4b34001b371daf31fcf2" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-4b34001b371daf31fcf2">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="list-film-categories-in-descending-accounts-receivable." class="section level3">
<h3><span class="header-section-number">20.1.19</span> 20 List film categories in descending accounts receivable.</h3>
<p>To answer this question we look at the <code>rental</code>, <code>inventory</code>, <code>film</code>, <code>film_category</code> and <code>category</code> tables.</p>
<div class="sourceCode" id="cb455"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb455-1" data-line-number="1">film_category_AR_rank_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb455-2" data-line-number="2"><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb455-3" data-line-number="3"><span class="st">select category,AR</span></a>
<a class="sourceLine" id="cb455-4" data-line-number="4"><span class="st">       ,sum(AR) over (order by AR desc rows between unbounded preceding and current row) running_AR</span></a>
<a class="sourceLine" id="cb455-5" data-line-number="5"><span class="st">       ,rentals</span></a>
<a class="sourceLine" id="cb455-6" data-line-number="6"><span class="st">       ,sum(rentals) over (order by AR desc rows between unbounded preceding and current row) running_rentals</span></a>
<a class="sourceLine" id="cb455-7" data-line-number="7"><span class="st">  from (select c.name category, sum(f.rental_rate) AR, count(*) rentals</span></a>
<a class="sourceLine" id="cb455-8" data-line-number="8"><span class="st">          from rental r join inventory i on r.inventory_id = i.inventory_id </span></a>
<a class="sourceLine" id="cb455-9" data-line-number="9"><span class="st">               join film f on i.film_id = f.film_id</span></a>
<a class="sourceLine" id="cb455-10" data-line-number="10"><span class="st">               join film_category fc on f.film_id = fc.film_id</span></a>
<a class="sourceLine" id="cb455-11" data-line-number="11"><span class="st">               join category c on fc.category_id = c.category_id</span></a>
<a class="sourceLine" id="cb455-12" data-line-number="12"><span class="st">       group by c.name</span></a>
<a class="sourceLine" id="cb455-13" data-line-number="13"><span class="st">      ) src</span></a>
<a class="sourceLine" id="cb455-14" data-line-number="14"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb455-15" data-line-number="15">  </a>
<a class="sourceLine" id="cb455-16" data-line-number="16"><span class="kw">sp_print_df</span>(film_category_AR_rank_sql)</a></code></pre></div>
<div id="htmlwidget-b1bdbba72aec9089045d" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-b1bdbba72aec9089045d">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16"],["Sports","Drama","Sci-Fi","Animation","Comedy","Foreign","Games","Action","Family","New","Travel","Documentary","Horror","Music","Children","Classics"],[3617.21,3378.39,3289.99,3218.34,3089.59,3050.67,3033.31,2966.88,2959.04,2904.6,2776.63,2752.49,2623.54,2541.7,2541.55,2477.61],[3617.21,6995.6,10285.59,13503.93,16593.52,19644.19,22677.5,25644.38,28603.42,31508.02,34284.65,37037.14,39660.68,42202.38,44743.93,47221.54],[1179,1061,1101,1166,941,1033,969,1112,1096,940,837,1051,846,830,945,939],[1179,2240,3341,4507,5448,6481,7450,8562,9658,10598,11435,12486,13332,14162,15107,16046]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>category<\/th>\n      <th>ar<\/th>\n      <th>running_ar<\/th>\n      <th>rentals<\/th>\n      <th>running_rentals<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>There are 16 film categories. The top three categories based on highest AR amounts are Sports, Drama, and Sci-Fi. The total number of rentals are 16046 with an AR amount of 47221.54.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-20" class="section level4">
<h4><span class="header-section-number">20.1.19.1</span> Replicate the output above using dplyr syntax.</h4>
<table>
<thead>
<tr class="header">
<th>column</th>
<th>mapping</th>
<th>definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>category</td>
<td>category.name</td>
<td></td>
</tr>
<tr class="even">
<td>ar</td>
<td>f.rental_rate</td>
<td></td>
</tr>
<tr class="odd">
<td>running_ar</td>
<td></td>
<td>accumulated ar amounts based on ratings</td>
</tr>
<tr class="even">
<td>rentals</td>
<td></td>
<td>number of rentals associated with the rating</td>
</tr>
<tr class="odd">
<td>running_rentals</td>
<td></td>
<td>running rating rentals</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb456"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb456-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb456-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb456-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb456-4" data-line-number="4"></a>
<a class="sourceLine" id="cb456-5" data-line-number="5">film_category_AR_rank_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb456-6" data-line-number="6">    </a>
<a class="sourceLine" id="cb456-7" data-line-number="7">    </a>
<a class="sourceLine" id="cb456-8" data-line-number="8"><span class="kw">sp_print_df</span>(film_category_AR_rank_dplyr)</a></code></pre></div>
<div id="htmlwidget-af6ac1c69230c2179f6a" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-af6ac1c69230c2179f6a">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="list-film-ratings-in-descending-accounts-receivable-order." class="section level3">
<h3><span class="header-section-number">20.1.20</span> 21. List film ratings in descending accounts receivable order.</h3>
<p>To answer this question we look at the <code>rental</code>, <code>inventory</code>, and <code>film</code> tables.</p>
<div class="sourceCode" id="cb457"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb457-1" data-line-number="1">film_rating_rank_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb457-2" data-line-number="2"><span class="st">&quot;select rating,AR</span></a>
<a class="sourceLine" id="cb457-3" data-line-number="3"><span class="st">       ,sum(AR) over (order by AR desc rows </span></a>
<a class="sourceLine" id="cb457-4" data-line-number="4"><span class="st">        between unbounded preceding and current row) running_AR</span></a>
<a class="sourceLine" id="cb457-5" data-line-number="5"><span class="st">       ,rentals</span></a>
<a class="sourceLine" id="cb457-6" data-line-number="6"><span class="st">       ,sum(rentals) over (order by AR desc rows </span></a>
<a class="sourceLine" id="cb457-7" data-line-number="7"><span class="st">        between unbounded preceding and current row) running_rentals</span></a>
<a class="sourceLine" id="cb457-8" data-line-number="8"><span class="st">from (select f.rating, sum(f.rental_rate) AR, count(*) rentals</span></a>
<a class="sourceLine" id="cb457-9" data-line-number="9"><span class="st">        from rental r join inventory i on r.inventory_id = i.inventory_id </span></a>
<a class="sourceLine" id="cb457-10" data-line-number="10"><span class="st">        join film f on i.film_id = f.film_id</span></a>
<a class="sourceLine" id="cb457-11" data-line-number="11"><span class="st">      group by f.rating</span></a>
<a class="sourceLine" id="cb457-12" data-line-number="12"><span class="st">     ) as src </span></a>
<a class="sourceLine" id="cb457-13" data-line-number="13"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb457-14" data-line-number="14">  </a>
<a class="sourceLine" id="cb457-15" data-line-number="15"><span class="kw">sp_print_df</span>(film_rating_rank_sql)</a></code></pre></div>
<div id="htmlwidget-c6cef737dd6a83c62169" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-c6cef737dd6a83c62169">{"x":{"filter":"none","data":[["1","2","3","4","5"],["PG-13","NC-17","PG","R","G"],[10797.15,10062.07,9470.87,9011.19,7875.27],[10797.15,20859.22,30330.09,39341.28,47216.55],[3585,3293,3213,3181,2773],[3585,6878,10091,13272,16045]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>rating<\/th>\n      <th>ar<\/th>\n      <th>running_ar<\/th>\n      <th>rentals<\/th>\n      <th>running_rentals<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>There are 5 film ratings. The total number of rentals are 16045 with an AR amount of 47216.55.</p>
<p>Why do the film categories revenue and film rating revenue amounts and counts differ, 16046 and 47221.54?</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-21" class="section level4">
<h4><span class="header-section-number">20.1.20.1</span> Replicate the output above using dplyr syntax.</h4>
<table>
<thead>
<tr class="header">
<th>column</th>
<th>mapping</th>
<th>definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>rating</td>
<td>film.rating</td>
<td></td>
</tr>
<tr class="even">
<td>ar</td>
<td>f.rental_rate</td>
<td></td>
</tr>
<tr class="odd">
<td>running_ar</td>
<td></td>
<td>accumulated ar amounts based on ratings</td>
</tr>
<tr class="even">
<td>rentals</td>
<td></td>
<td>number of rentals associated with the rating</td>
</tr>
<tr class="odd">
<td>running_rentals</td>
<td></td>
<td>running rating rentals</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb458"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb458-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb458-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb458-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb458-4" data-line-number="4"></a>
<a class="sourceLine" id="cb458-5" data-line-number="5">film_rating_rank_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb458-6" data-line-number="6"></a>
<a class="sourceLine" id="cb458-7" data-line-number="7"><span class="kw">sp_print_df</span>(film_rating_rank_dplyr)</a></code></pre></div>
<div id="htmlwidget-a9e8581aee330d6d5646" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-a9e8581aee330d6d5646">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="how-many-rentals-were-returned-on-time-returned-late-never-returned" class="section level3">
<h3><span class="header-section-number">20.1.21</span> 22. How many rentals were returned on time, returned late, never returned?</h3>
<p>To answer this question we look at the <code>rental</code>, <code>inventory</code>, and <code>film</code> tables.</p>
<div class="sourceCode" id="cb459"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb459-1" data-line-number="1">returned_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb459-2" data-line-number="2"><span class="st">&quot;with details as</span></a>
<a class="sourceLine" id="cb459-3" data-line-number="3"><span class="st">    (select case when r.return_date is null</span></a>
<a class="sourceLine" id="cb459-4" data-line-number="4"><span class="st">                 then null</span></a>
<a class="sourceLine" id="cb459-5" data-line-number="5"><span class="st">                 else r.return_date::date  - (r.rental_date + INTERVAL &#39;1 day&#39;  * f.rental_duration)::date</span></a>
<a class="sourceLine" id="cb459-6" data-line-number="6"><span class="st">            end rtn_days</span></a>
<a class="sourceLine" id="cb459-7" data-line-number="7"><span class="st">           ,case when r.return_date is null</span></a>
<a class="sourceLine" id="cb459-8" data-line-number="8"><span class="st">                 then 1</span></a>
<a class="sourceLine" id="cb459-9" data-line-number="9"><span class="st">                 else 0</span></a>
<a class="sourceLine" id="cb459-10" data-line-number="10"><span class="st">            end not_rtn</span></a>
<a class="sourceLine" id="cb459-11" data-line-number="11"><span class="st">       from rental r join inventory i on r.inventory_id = i.inventory_id</span></a>
<a class="sourceLine" id="cb459-12" data-line-number="12"><span class="st">                     join film f on i.film_id = f.film_id</span></a>
<a class="sourceLine" id="cb459-13" data-line-number="13"><span class="st">    )</span></a>
<a class="sourceLine" id="cb459-14" data-line-number="14"><span class="st"> select sum(case when rtn_days &lt;= 0 then 1 else 0 end) on_time</span></a>
<a class="sourceLine" id="cb459-15" data-line-number="15"><span class="st">       ,sum(case when rtn_days &gt;  0 then 1 else 0 end) late</span></a>
<a class="sourceLine" id="cb459-16" data-line-number="16"><span class="st">       ,sum(not_rtn) not_rtn</span></a>
<a class="sourceLine" id="cb459-17" data-line-number="17"><span class="st">       ,count(*) rented</span></a>
<a class="sourceLine" id="cb459-18" data-line-number="18"><span class="st">       ,round(100. * sum(case when rtn_days &lt;= 0 then 1 else 0 end)/count(*),2) on_time_pct</span></a>
<a class="sourceLine" id="cb459-19" data-line-number="19"><span class="st">       ,round(100. * sum(case when rtn_days &gt;  0 then 1 else 0 end)/count(*),2) late_pct</span></a>
<a class="sourceLine" id="cb459-20" data-line-number="20"><span class="st">       ,round(100. * sum(not_rtn)/count(*),2)  not_rtn_pct</span></a>
<a class="sourceLine" id="cb459-21" data-line-number="21"><span class="st">   from details</span></a>
<a class="sourceLine" id="cb459-22" data-line-number="22"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb459-23" data-line-number="23"></a>
<a class="sourceLine" id="cb459-24" data-line-number="24"><span class="kw">sp_print_df</span>(returned_sql)</a></code></pre></div>
<div id="htmlwidget-a9c870ee45a861efbc97" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-a9c870ee45a861efbc97">{"x":{"filter":"none","data":[["1"],[8593],[7269],[183],[16045],[53.56],[45.3],[1.14]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>on_time<\/th>\n      <th>late<\/th>\n      <th>not_rtn<\/th>\n      <th>rented<\/th>\n      <th>on_time_pct<\/th>\n      <th>late_pct<\/th>\n      <th>not_rtn_pct<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>To date 53.56% of the rented DVD’s were returned on time, 45.30% were returned late, and 1.14% were never returned.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-22" class="section level4">
<h4><span class="header-section-number">20.1.21.1</span> Replicate the output above using dplyr syntax.</h4>
<table>
<colgroup>
<col width="34%" />
<col width="40%" />
<col width="25%" />
</colgroup>
<thead>
<tr class="header">
<th>column</th>
<th>mapping</th>
<th>definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>on_time</td>
<td></td>
<td>number of DVD’s where rental.return_date &lt;= rental.rental_date + film.rental_duration</td>
</tr>
<tr class="even">
<td>late</td>
<td></td>
<td>number of DVD’s where rental.return_date &gt; rental.rental_date + film.rental_duration</td>
</tr>
<tr class="odd">
<td>not_rtn</td>
<td></td>
<td>number of DVD’s not returned; rental.return_date is null</td>
</tr>
<tr class="even">
<td>rented</td>
<td></td>
<td>number of DVD’s rented.</td>
</tr>
<tr class="odd">
<td>on_time_pct</td>
<td></td>
<td>Percent of DVD’s returned on time</td>
</tr>
<tr class="even">
<td>late_pct</td>
<td></td>
<td>Percent of DVD’s returned late</td>
</tr>
<tr class="odd">
<td>not_rtn_pct</td>
<td></td>
<td>Percent of DVD’s not returned.</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb460"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb460-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb460-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb460-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb460-4" data-line-number="4"></a>
<a class="sourceLine" id="cb460-5" data-line-number="5">returned_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb460-6" data-line-number="6"></a>
<a class="sourceLine" id="cb460-7" data-line-number="7"><span class="kw">sp_print_df</span>(returned_dplyr)</a></code></pre></div>
<div id="htmlwidget-d0e1be80fd8ee1a19c08" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-d0e1be80fd8ee1a19c08">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="are-there-duplicate-customers" class="section level3">
<h3><span class="header-section-number">20.1.22</span> 23. Are there duplicate customers?</h3>
<p>To answer this question we look at the <code>customer</code>, <code>address</code>, <code>city</code>, and <code>country</code> tables.</p>
<p>We assume that if the customer first and last name match in two different rows, then it is a duplicate customer.</p>
<div class="sourceCode" id="cb461"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb461-1" data-line-number="1">customer_dupes_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb461-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb461-3" data-line-number="3">  <span class="st">&quot;select cust.customer_id id</span></a>
<a class="sourceLine" id="cb461-4" data-line-number="4"><span class="st">         ,cust.store_id store</span></a>
<a class="sourceLine" id="cb461-5" data-line-number="5"><span class="st">         ,concat(cust.first_name,&#39; &#39;,cust.last_name) customer</span></a>
<a class="sourceLine" id="cb461-6" data-line-number="6"><span class="st">         ,cust.email</span></a>
<a class="sourceLine" id="cb461-7" data-line-number="7"><span class="st">--         ,a.phone</span></a>
<a class="sourceLine" id="cb461-8" data-line-number="8"><span class="st">         ,a.address</span></a>
<a class="sourceLine" id="cb461-9" data-line-number="9"><span class="st">         ,c.city</span></a>
<a class="sourceLine" id="cb461-10" data-line-number="10"><span class="st">         ,a.postal_code zip</span></a>
<a class="sourceLine" id="cb461-11" data-line-number="11"><span class="st">         ,a.district</span></a>
<a class="sourceLine" id="cb461-12" data-line-number="12"><span class="st">         ,ctry.country</span></a>
<a class="sourceLine" id="cb461-13" data-line-number="13"><span class="st">     from customer cust join address a on cust.address_id = a.address_id</span></a>
<a class="sourceLine" id="cb461-14" data-line-number="14"><span class="st">                     join city c on a.city_id = c.city_id</span></a>
<a class="sourceLine" id="cb461-15" data-line-number="15"><span class="st">                     join country ctry on c.country_id = ctry.country_id</span></a>
<a class="sourceLine" id="cb461-16" data-line-number="16"><span class="st">    where concat(cust.first_name,cust.last_name)</span></a>
<a class="sourceLine" id="cb461-17" data-line-number="17"><span class="st">          in (select concat(first_name,last_name)</span></a>
<a class="sourceLine" id="cb461-18" data-line-number="18"><span class="st">                from customer</span></a>
<a class="sourceLine" id="cb461-19" data-line-number="19"><span class="st">              group by concat(first_name,last_name)</span></a>
<a class="sourceLine" id="cb461-20" data-line-number="20"><span class="st">             having count(*) &gt;1</span></a>
<a class="sourceLine" id="cb461-21" data-line-number="21"><span class="st">             )</span></a>
<a class="sourceLine" id="cb461-22" data-line-number="22"><span class="st">  &quot;</span>)</a>
<a class="sourceLine" id="cb461-23" data-line-number="23"><span class="kw">sp_print_df</span>(customer_dupes_sql)</a></code></pre></div>
<div id="htmlwidget-41c6fff5c0ae3f9b920c" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-41c6fff5c0ae3f9b920c">{"x":{"filter":"none","data":[["1","2"],[600,601],[3,2],["Sophie Yang","Sophie Yang"],["sophie.yang@sakilacustomer.org","sophie.yang@sakilacustomer.org"],["47 MySakila Drive","47 MySakila Drive"],["Lethbridge","Lethbridge"],["",""],["Alberta","Alberta"],["Canada","Canada"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>id<\/th>\n      <th>store<\/th>\n      <th>customer<\/th>\n      <th>email<\/th>\n      <th>address<\/th>\n      <th>city<\/th>\n      <th>zip<\/th>\n      <th>district<\/th>\n      <th>country<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>Sophie is the only duplicate customer. The only difference between the two records is the store. Record 600 is associated with store 3, which has no employees, and 601 is associated with store 2</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-23" class="section level4">
<h4><span class="header-section-number">20.1.22.1</span> Replicate the output above using dplyr syntax.</h4>
<table>
<thead>
<tr class="header">
<th>column</th>
<th>mapping</th>
<th>definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>id</td>
<td>customer.customer_id</td>
<td></td>
</tr>
<tr class="even">
<td>store</td>
<td>customer.store_id</td>
<td></td>
</tr>
<tr class="odd">
<td>customer</td>
<td>first_name + last_name</td>
<td></td>
</tr>
<tr class="even">
<td>zip</td>
<td>address.postal_code</td>
<td></td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb462"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb462-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb462-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb462-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb462-4" data-line-number="4"></a>
<a class="sourceLine" id="cb462-5" data-line-number="5">customer_dupes_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb462-6" data-line-number="6">    </a>
<a class="sourceLine" id="cb462-7" data-line-number="7"><span class="kw">sp_print_df</span>(customer_dupes_dplyr)</a></code></pre></div>
<div id="htmlwidget-5fe564842c318b64a092" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5fe564842c318b64a092">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="which-customers-have-never-rented-a-movie" class="section level3">
<h3><span class="header-section-number">20.1.23</span> 24. Which customers have never rented a movie?</h3>
<p>To answer this question we look at the <code>customer</code> and <code>rental</code> tables.</p>
<div class="sourceCode" id="cb463"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb463-1" data-line-number="1">customer_no_rentals_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb463-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb463-3" data-line-number="3">  <span class="st">&quot;select c.customer_id id</span></a>
<a class="sourceLine" id="cb463-4" data-line-number="4"><span class="st">         ,c.first_name</span></a>
<a class="sourceLine" id="cb463-5" data-line-number="5"><span class="st">         ,c.last_name</span></a>
<a class="sourceLine" id="cb463-6" data-line-number="6"><span class="st">         ,c.email</span></a>
<a class="sourceLine" id="cb463-7" data-line-number="7"><span class="st">         ,a.phone</span></a>
<a class="sourceLine" id="cb463-8" data-line-number="8"><span class="st">         ,city.city</span></a>
<a class="sourceLine" id="cb463-9" data-line-number="9"><span class="st">         ,ctry.country</span></a>
<a class="sourceLine" id="cb463-10" data-line-number="10"><span class="st">         ,c.active </span></a>
<a class="sourceLine" id="cb463-11" data-line-number="11"><span class="st">         ,c.create_date</span></a>
<a class="sourceLine" id="cb463-12" data-line-number="12"><span class="st">--         ,c.last_update</span></a>
<a class="sourceLine" id="cb463-13" data-line-number="13"><span class="st">     from customer c left join rental r on c.customer_id = r.customer_id</span></a>
<a class="sourceLine" id="cb463-14" data-line-number="14"><span class="st">                     left join address a on c.address_id = a.address_id</span></a>
<a class="sourceLine" id="cb463-15" data-line-number="15"><span class="st">                     left join city on a.city_id = city.city_id</span></a>
<a class="sourceLine" id="cb463-16" data-line-number="16"><span class="st">                     left join country ctry on city.country_id = ctry.country_id</span></a>
<a class="sourceLine" id="cb463-17" data-line-number="17"><span class="st">    where r.rental_id is null</span></a>
<a class="sourceLine" id="cb463-18" data-line-number="18"><span class="st">  order by c.customer_id</span></a>
<a class="sourceLine" id="cb463-19" data-line-number="19"></a>
<a class="sourceLine" id="cb463-20" data-line-number="20"><span class="st">  &quot;</span></a>
<a class="sourceLine" id="cb463-21" data-line-number="21">)</a>
<a class="sourceLine" id="cb463-22" data-line-number="22"><span class="kw">sp_print_df</span>(customer_no_rentals_sql)</a></code></pre></div>
<div id="htmlwidget-234a00f466fa8377b924" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-234a00f466fa8377b924">{"x":{"filter":"none","data":[["1","2","3","4"],[601,602,603,604],["Sophie","John","Ian","Ed"],["Yang","Smith","Frantz","Borasky"],["sophie.yang@sakilacustomer.org","john.smith@sakilacustomer.org","ian.frantz@sakilacustomer.org","ed.borasky@sakilacustomer.org"],["","","14033335568","6172235589"],["Lethbridge","Woodridge","Lethbridge","Woodridge"],["Canada","Australia","Canada","Australia"],[1,1,1,1],["2019-03-04","2019-03-04","2019-03-04","2019-03-04"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>email<\/th>\n      <th>phone<\/th>\n      <th>city<\/th>\n      <th>country<\/th>\n      <th>active<\/th>\n      <th>create_date<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,8]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>We see that there are four new customers who have never rented a movie. These four customers are in the countries that have a manned store.</font></p>
<table>
<thead>
<tr class="header">
<th>column</th>
<th>mapping</th>
<th>definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>id</td>
<td>customer.customer_id</td>
<td></td>
</tr>
</tbody>
</table>
<div id="replicate-the-output-above-using-dplyr-syntax.-24" class="section level4">
<h4><span class="header-section-number">20.1.23.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb464"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb464-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb464-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb464-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb464-4" data-line-number="4"></a>
<a class="sourceLine" id="cb464-5" data-line-number="5">customer_no_rentals_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb464-6" data-line-number="6"></a>
<a class="sourceLine" id="cb464-7" data-line-number="7"><span class="kw">sp_print_df</span>(customer_no_rentals_dplyr)</a></code></pre></div>
<div id="htmlwidget-868fa95f2212c2b3c328" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-868fa95f2212c2b3c328">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="who-are-the-top-5-customers-with-the-most-rentals-and-associated-payments" class="section level3">
<h3><span class="header-section-number">20.1.24</span> 25. Who are the top 5 customers with the most rentals and associated payments?</h3>
<p>This exercise uses the <code>customer</code>, <code>rental</code>, and <code>payment</code> tables.</p>
<div class="sourceCode" id="cb465"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb465-1" data-line-number="1">customer_top_rentals_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb465-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb465-3" data-line-number="3">  <span class="st">&quot;select c.customer_id id,c.store_id</span></a>
<a class="sourceLine" id="cb465-4" data-line-number="4"><span class="st">         ,concat(c.first_name,&#39; &#39;,c.last_name) customer</span></a>
<a class="sourceLine" id="cb465-5" data-line-number="5"><span class="st">         ,min(rental_date)::date mn_rental_dt</span></a>
<a class="sourceLine" id="cb465-6" data-line-number="6"><span class="st">         ,max(rental_date)::date mx_rental_dt</span></a>
<a class="sourceLine" id="cb465-7" data-line-number="7"><span class="st">         ,sum(COALESCE(p.amount,0.)) paid</span></a>
<a class="sourceLine" id="cb465-8" data-line-number="8"><span class="st">         ,count(r.rental_id) rentals</span></a>
<a class="sourceLine" id="cb465-9" data-line-number="9"><span class="st">     from customer c</span></a>
<a class="sourceLine" id="cb465-10" data-line-number="10"><span class="st">          left join rental r on c.customer_id = r.customer_id</span></a>
<a class="sourceLine" id="cb465-11" data-line-number="11"><span class="st">          left join payment p on r.rental_id = p.rental_id </span></a>
<a class="sourceLine" id="cb465-12" data-line-number="12"><span class="st">   group by  c.customer_id</span></a>
<a class="sourceLine" id="cb465-13" data-line-number="13"><span class="st">            ,c.first_name</span></a>
<a class="sourceLine" id="cb465-14" data-line-number="14"><span class="st">            ,c.last_name</span></a>
<a class="sourceLine" id="cb465-15" data-line-number="15"><span class="st">            ,c.store_id</span></a>
<a class="sourceLine" id="cb465-16" data-line-number="16"><span class="st">   order by count(r.rental_id) desc</span></a>
<a class="sourceLine" id="cb465-17" data-line-number="17"><span class="st">limit 5</span></a>
<a class="sourceLine" id="cb465-18" data-line-number="18"><span class="st">  &quot;</span></a>
<a class="sourceLine" id="cb465-19" data-line-number="19">)</a>
<a class="sourceLine" id="cb465-20" data-line-number="20"><span class="kw">sp_print_df</span>(customer_top_rentals_sql)</a></code></pre></div>
<div id="htmlwidget-99c3e94ea8569a159b98" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-99c3e94ea8569a159b98">{"x":{"filter":"none","data":[["1","2","3","4","5"],[148,526,236,144,75],[1,2,1,1,2],["Eleanor Hunt","Karl Seal","Marcia Dean","Clara Shaw","Tammy Sanders"],["2005-05-28","2005-05-28","2005-05-26","2005-05-27","2005-05-26"],["2005-08-23","2005-08-23","2006-02-14","2005-08-23","2006-02-14"],[211.55,208.58,166.61,189.6,149.61],[46,45,42,42,41]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>id<\/th>\n      <th>store_id<\/th>\n      <th>customer<\/th>\n      <th>mn_rental_dt<\/th>\n      <th>mx_rental_dt<\/th>\n      <th>paid<\/th>\n      <th>rentals<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>The top 5 customers all rented between 41 to 46 DVD’s. Three of the top 5 rented about 14 DVD’s per month over a three month period. The other two customers 41 and 42 DVD’s per 12 months.</font></p>
<div id="replicate-the-output-above-using-dplyr" class="section level4">
<h4><span class="header-section-number">20.1.24.1</span> Replicate the output above using dplyr</h4>
<table>
<thead>
<tr class="header">
<th>column</th>
<th>mapping</th>
<th>definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>id</td>
<td>customer.customer_id</td>
<td></td>
</tr>
<tr class="even">
<td>customer</td>
<td>first_name + last_name</td>
<td></td>
</tr>
<tr class="odd">
<td>mn_rental_dt</td>
<td></td>
<td>minimum renal date</td>
</tr>
<tr class="even">
<td>mx_rental_dt</td>
<td></td>
<td>maximum rental date</td>
</tr>
<tr class="odd">
<td>paid</td>
<td></td>
<td>paid amount</td>
</tr>
<tr class="even">
<td>rentals</td>
<td></td>
<td>customer rentals</td>
</tr>
</tbody>
</table>
<p>Use the dplyr inner_join verb to find the top 5 customers who have rented the most movies.</p>
<div class="sourceCode" id="cb466"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb466-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb466-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb466-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb466-4" data-line-number="4"></a>
<a class="sourceLine" id="cb466-5" data-line-number="5">customer_top_rentals_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)    </a>
<a class="sourceLine" id="cb466-6" data-line-number="6"></a>
<a class="sourceLine" id="cb466-7" data-line-number="7"><span class="kw">sp_print_df</span>(<span class="kw">head</span>(customer_top_rentals_dplyr,<span class="dt">n=</span><span class="dv">5</span>))</a></code></pre></div>
<div id="htmlwidget-abcdda0cacd8bfd420cb" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-abcdda0cacd8bfd420cb">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="combine-the-top-5-rental-customers-40-or-more-rentals-and-zero-rental-customers" class="section level3">
<h3><span class="header-section-number">20.1.25</span> 26. Combine the top 5 rental customers, (40 or more rentals), and zero rental customers</h3>
<p>To answer this question we look at the <code>customer</code>, <code>rental</code>, and <code>payments</code> tables again.</p>
<div class="sourceCode" id="cb467"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb467-1" data-line-number="1">customer_rental_high_low_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb467-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb467-3" data-line-number="3">  <span class="st">&quot;select c.customer_id id</span></a>
<a class="sourceLine" id="cb467-4" data-line-number="4"><span class="st">         ,concat(c.first_name,&#39; &#39;,c.last_name) customer</span></a>
<a class="sourceLine" id="cb467-5" data-line-number="5"><span class="st">         ,count(*) cust_cnt</span></a>
<a class="sourceLine" id="cb467-6" data-line-number="6"><span class="st">         ,count(r.rental_id) rentals</span></a>
<a class="sourceLine" id="cb467-7" data-line-number="7"><span class="st">         ,count(p.payment_id) payments</span></a>
<a class="sourceLine" id="cb467-8" data-line-number="8"><span class="st">         ,sum(coalesce(p.amount,0)) paid</span></a>
<a class="sourceLine" id="cb467-9" data-line-number="9"><span class="st">     from customer c</span></a>
<a class="sourceLine" id="cb467-10" data-line-number="10"><span class="st">          left outer join rental r on c.customer_id = r.customer_id</span></a>
<a class="sourceLine" id="cb467-11" data-line-number="11"><span class="st">          left outer join payment p on r.rental_id = p.rental_id</span></a>
<a class="sourceLine" id="cb467-12" data-line-number="12"><span class="st">   group by  c.customer_id</span></a>
<a class="sourceLine" id="cb467-13" data-line-number="13"><span class="st">            ,c.first_name</span></a>
<a class="sourceLine" id="cb467-14" data-line-number="14"><span class="st">            ,c.last_name</span></a>
<a class="sourceLine" id="cb467-15" data-line-number="15"><span class="st">   having count(r.rental_id) = 0 or count(r.rental_id) &gt; 40</span></a>
<a class="sourceLine" id="cb467-16" data-line-number="16"><span class="st">   order by count(r.rental_id) desc</span></a>
<a class="sourceLine" id="cb467-17" data-line-number="17"><span class="st">  &quot;</span></a>
<a class="sourceLine" id="cb467-18" data-line-number="18">)</a>
<a class="sourceLine" id="cb467-19" data-line-number="19"><span class="kw">sp_print_df</span>(customer_rental_high_low_sql)</a></code></pre></div>
<div id="htmlwidget-5bf2ee971cc89a16a855" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5bf2ee971cc89a16a855">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9"],[148,526,144,236,75,604,603,601,602],["Eleanor Hunt","Karl Seal","Clara Shaw","Marcia Dean","Tammy Sanders","Ed Borasky","Ian Frantz","Sophie Yang","John Smith"],[46,45,42,42,41,1,1,1,1],[46,45,42,42,41,0,0,0,0],[45,42,40,39,39,0,0,0,0],[211.55,208.58,189.6,166.61,149.61,0,0,0,0]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>id<\/th>\n      <th>customer<\/th>\n      <th>cust_cnt<\/th>\n      <th>rentals<\/th>\n      <th>payments<\/th>\n      <th>paid<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3,4,5,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>We see that there are four new customers who have never rented a movie. These four customers are in the countries that have a manned store.</p>
<p>We see that there are four new customers who have never rented a movie. These four customers are in the countries that have a manned store.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-25" class="section level4">
<h4><span class="header-section-number">20.1.25.1</span> Replicate the output above using dplyr syntax.</h4>
<table>
<thead>
<tr class="header">
<th>Column</th>
<th>Mapping</th>
<th>Definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>id</td>
<td>customer.customer_id</td>
<td></td>
</tr>
<tr class="even">
<td>customer</td>
<td>first_name + last_name</td>
<td></td>
</tr>
<tr class="odd">
<td>rentals</td>
<td></td>
<td>customer rentals</td>
</tr>
<tr class="even">
<td>payments</td>
<td></td>
<td>customer payments</td>
</tr>
<tr class="odd">
<td>paid_amt</td>
<td>payment.amount</td>
<td>aggregated payment amount</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb468"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb468-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb468-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb468-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb468-4" data-line-number="4"></a>
<a class="sourceLine" id="cb468-5" data-line-number="5">customer_rental_high_low_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb468-6" data-line-number="6"></a>
<a class="sourceLine" id="cb468-7" data-line-number="7"><span class="kw">sp_print_df</span>(customer_rental_high_low_dplyr)</a></code></pre></div>
<div id="htmlwidget-d53f5dec90ce090aa13d" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-d53f5dec90ce090aa13d">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="who-are-the-top-n1-and-bottom-n2-customers" class="section level3">
<h3><span class="header-section-number">20.1.26</span> 27. Who are the top-n1 and bottom-n2 customers?</h3>
<p>The issue with the two previous reports is that the top end is hardcoded, rentals &gt; 40. Over time, the current customers will always be in the top section and new customers will get added. Another way of looking at the previous report is to show just the top and bottom 5 customers.</p>
<p>Parameterize the previous exercise to show the top 5 and bottom 5 customers.</p>
<p>To answer this question we look at the <code>customer</code>, <code>rental</code>, and <code>payments</code> tables again.</p>
<div class="sourceCode" id="cb469"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb469-1" data-line-number="1">customer_rentals_hi_low_sql &lt;-<span class="st"> </span><span class="cf">function</span>(high_n,low_n) {</a>
<a class="sourceLine" id="cb469-2" data-line-number="2">    customer_rental_high_low_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb469-3" data-line-number="3">        <span class="st">&quot;select *</span></a>
<a class="sourceLine" id="cb469-4" data-line-number="4"><span class="st">           from (     select *</span></a>
<a class="sourceLine" id="cb469-5" data-line-number="5"><span class="st">                            ,ROW_NUMBER() OVER(ORDER BY rentals desc) rent_hi_low</span></a>
<a class="sourceLine" id="cb469-6" data-line-number="6"><span class="st">                            ,ROW_NUMBER() OVER(ORDER BY rentals ) rent_low_hi</span></a>
<a class="sourceLine" id="cb469-7" data-line-number="7"><span class="st">                       FROM (    </span></a>
<a class="sourceLine" id="cb469-8" data-line-number="8"><span class="st">                                 select c.customer_id id</span></a>
<a class="sourceLine" id="cb469-9" data-line-number="9"><span class="st">                                       ,concat(c.first_name,&#39; &#39;,c.last_name) customer</span></a>
<a class="sourceLine" id="cb469-10" data-line-number="10"><span class="st">                                       ,count(*) cust_cnt</span></a>
<a class="sourceLine" id="cb469-11" data-line-number="11"><span class="st">                                       ,count(r.rental_id) rentals</span></a>
<a class="sourceLine" id="cb469-12" data-line-number="12"><span class="st">                                       ,count(p.payment_id) payments</span></a>
<a class="sourceLine" id="cb469-13" data-line-number="13"><span class="st">                                       ,sum(coalesce(p.amount,0)) paid_amt</span></a>
<a class="sourceLine" id="cb469-14" data-line-number="14"><span class="st">                                  from customer c </span></a>
<a class="sourceLine" id="cb469-15" data-line-number="15"><span class="st">                                       left outer join rental r on c.customer_id = r.customer_id</span></a>
<a class="sourceLine" id="cb469-16" data-line-number="16"><span class="st">                                       left outer join payment p on r.rental_id = p.rental_id</span></a>
<a class="sourceLine" id="cb469-17" data-line-number="17"><span class="st">                                 group by c.customer_id</span></a>
<a class="sourceLine" id="cb469-18" data-line-number="18"><span class="st">                                        ,c.first_name</span></a>
<a class="sourceLine" id="cb469-19" data-line-number="19"><span class="st">                                        ,c.last_name</span></a>
<a class="sourceLine" id="cb469-20" data-line-number="20"><span class="st">                            ) as summary</span></a>
<a class="sourceLine" id="cb469-21" data-line-number="21"><span class="st">                ) row_nums</span></a>
<a class="sourceLine" id="cb469-22" data-line-number="22"><span class="st">           where rent_hi_low &lt;= $1 or rent_low_hi &lt;= $2</span></a>
<a class="sourceLine" id="cb469-23" data-line-number="23"><span class="st">          order by rent_hi_low</span></a>
<a class="sourceLine" id="cb469-24" data-line-number="24"><span class="st">        &quot;</span></a>
<a class="sourceLine" id="cb469-25" data-line-number="25">           ,<span class="kw">c</span>(high_n,low_n)</a>
<a class="sourceLine" id="cb469-26" data-line-number="26">        )</a>
<a class="sourceLine" id="cb469-27" data-line-number="27">    <span class="kw">return</span> (customer_rental_high_low_sql)</a>
<a class="sourceLine" id="cb469-28" data-line-number="28">}</a></code></pre></div>
<p>The next code block executes a sql version of such a function. With top_n = 5 and bot_n = 5, it replicates the hard coded version of the previous exercise. With top_n = 5 and bot_n = 0, it gives a top 5 report. With top_n = 0 and bot_n = 5, the report returns the bottom 5. Change the two parameters to see the output from the different combinations.</p>
<div class="sourceCode" id="cb470"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb470-1" data-line-number="1">top_n =<span class="st"> </span><span class="dv">5</span></a>
<a class="sourceLine" id="cb470-2" data-line-number="2">bot_n =<span class="st"> </span><span class="dv">5</span></a>
<a class="sourceLine" id="cb470-3" data-line-number="3"><span class="kw">sp_print_df</span>(<span class="kw">customer_rentals_hi_low_sql</span>(top_n,bot_n))</a></code></pre></div>
<div id="htmlwidget-409f67cc1efea6a7bf83" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-409f67cc1efea6a7bf83">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10"],[148,526,236,144,75,600,602,604,601,603],["Eleanor Hunt","Karl Seal","Marcia Dean","Clara Shaw","Tammy Sanders","Sophie Yang","John Smith","Ed Borasky","Sophie Yang","Ian Frantz"],[46,45,42,42,41,1,1,1,1,1],[46,45,42,42,41,1,0,0,0,0],[45,42,39,40,39,0,0,0,0,0],[211.55,208.58,166.61,189.6,149.61,0,0,0,0,0],[1,2,3,4,5,600,601,602,603,604],[604,603,602,601,600,5,4,3,2,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>id<\/th>\n      <th>customer<\/th>\n      <th>cust_cnt<\/th>\n      <th>rentals<\/th>\n      <th>payments<\/th>\n      <th>paid_amt<\/th>\n      <th>rent_hi_low<\/th>\n      <th>rent_low_hi<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3,4,5,6,7,8]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div id="replicate-the-function-above-use-dplyr-syntax." class="section level4">
<h4><span class="header-section-number">20.1.26.1</span> Replicate the function above use dplyr syntax.</h4>
<table>
<thead>
<tr class="header">
<th>Column</th>
<th>Mapping</th>
<th>Definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>id</td>
<td>customer.customer_id</td>
<td></td>
</tr>
<tr class="even">
<td>cust_cnt</td>
<td></td>
<td>customer count</td>
</tr>
<tr class="odd">
<td>rentals</td>
<td></td>
<td>customer rentals</td>
</tr>
<tr class="even">
<td>payments</td>
<td></td>
<td>customer payments</td>
</tr>
<tr class="odd">
<td>paid_amt</td>
<td>payment.amount</td>
<td>aggregated payment amount</td>
</tr>
<tr class="even">
<td>rent_hi_low</td>
<td></td>
<td>sequence with 1 = customer with highest rentals</td>
</tr>
<tr class="odd">
<td>rent_low_hi</td>
<td></td>
<td>sequence with 1 = customer with the lowest rentals</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb471"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb471-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb471-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb471-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb471-4" data-line-number="4"></a>
<a class="sourceLine" id="cb471-5" data-line-number="5">customer_rentals_hi_low_dplr &lt;-<span class="st"> </span><span class="cf">function</span>(high_n,low_n) {</a>
<a class="sourceLine" id="cb471-6" data-line-number="6">     <span class="kw">return</span>(<span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>))</a>
<a class="sourceLine" id="cb471-7" data-line-number="7">}</a></code></pre></div>
<div class="sourceCode" id="cb472"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb472-1" data-line-number="1">top_n =<span class="st"> </span><span class="dv">5</span></a>
<a class="sourceLine" id="cb472-2" data-line-number="2">bot_n =<span class="st"> </span><span class="dv">5</span></a>
<a class="sourceLine" id="cb472-3" data-line-number="3"><span class="kw">sp_print_df</span>(<span class="kw">customer_rentals_hi_low_dplr</span>(top_n,bot_n))</a></code></pre></div>
<div id="htmlwidget-619cf737bf6ed4e2fae9" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-619cf737bf6ed4e2fae9">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="how-much-has-each-store-collected" class="section level3">
<h3><span class="header-section-number">20.1.27</span> 28. How much has each store collected?</h3>
<p>How are the stores performing? The SQL code shows the payments made to each store in the business.</p>
<div class="sourceCode" id="cb473"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb473-1" data-line-number="1">store_payments_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb473-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb473-3" data-line-number="3">  <span class="st">&quot;select s.store_id,sum(p.amount) amount,count(*) cnt </span></a>
<a class="sourceLine" id="cb473-4" data-line-number="4"><span class="st">                   from payment p </span></a>
<a class="sourceLine" id="cb473-5" data-line-number="5"><span class="st">                        join staff s </span></a>
<a class="sourceLine" id="cb473-6" data-line-number="6"><span class="st">                          on p.staff_id = s.staff_id  </span></a>
<a class="sourceLine" id="cb473-7" data-line-number="7"><span class="st">                 group by store_id order by 2 desc</span></a>
<a class="sourceLine" id="cb473-8" data-line-number="8"><span class="st">                 ;</span></a>
<a class="sourceLine" id="cb473-9" data-line-number="9"><span class="st">                &quot;</span></a>
<a class="sourceLine" id="cb473-10" data-line-number="10">)</a>
<a class="sourceLine" id="cb473-11" data-line-number="11"><span class="kw">sp_print_df</span>(store_payments_sql)</a></code></pre></div>
<div id="htmlwidget-4139ca2ad6f87f0aa0d4" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-4139ca2ad6f87f0aa0d4">{"x":{"filter":"none","data":[["1","2"],[2,1],[31059.92,30252.12],[7304,7292]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>store_id<\/th>\n      <th>amount<\/th>\n      <th>cnt<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>Each store collected just over 30,000 in revenue and each store had about 7300 rentals.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-26" class="section level4">
<h4><span class="header-section-number">20.1.27.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb474"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb474-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb474-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb474-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb474-4" data-line-number="4"></a>
<a class="sourceLine" id="cb474-5" data-line-number="5">store_payments_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb474-6" data-line-number="6"></a>
<a class="sourceLine" id="cb474-7" data-line-number="7"><span class="kw">sp_print_df</span>(store_payments_dplyr)</a></code></pre></div>
<div id="htmlwidget-27fdaedd3ddcca9c350f" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-27fdaedd3ddcca9c350f">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="what-is-the-business-distribution-of-payments" class="section level3">
<h3><span class="header-section-number">20.1.28</span> 29. What is the business’ distribution of payments?</h3>
<p>To answer this question we look at the <code>rental</code>, <code>payment</code>, <code>inventory</code>, and <code>film</code> tables to answer this question.</p>
<p>As a sanity check, we first check the number of rentals and amount payments.</p>
<div class="sourceCode" id="cb475"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb475-1" data-line-number="1">rentals_payments_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb475-2" data-line-number="2"><span class="st">&quot;select &#39;rentals&#39; rec_type, count(*) cnt_amt from rental</span></a>
<a class="sourceLine" id="cb475-3" data-line-number="3"><span class="st"> union</span></a>
<a class="sourceLine" id="cb475-4" data-line-number="4"><span class="st"> select &#39;payments&#39; rec_type, sum(amount) from payment &quot;</span>)</a>
<a class="sourceLine" id="cb475-5" data-line-number="5"><span class="kw">sp_print_df</span>(rentals_payments_sql)</a></code></pre></div>
<div id="htmlwidget-a0cd32aa67630f6b8dd0" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-a0cd32aa67630f6b8dd0">{"x":{"filter":"none","data":[["1","2"],["payments","rentals"],[61312.04,16045]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>rec_type<\/th>\n      <th>cnt_amt<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":2},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb476"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb476-1" data-line-number="1">business_payment_dist_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb476-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb476-3" data-line-number="3"> <span class="st">&quot;select no_pay_rec_due</span></a>
<a class="sourceLine" id="cb476-4" data-line-number="4"><span class="st">      ,no_pay_rec_cnt</span></a>
<a class="sourceLine" id="cb476-5" data-line-number="5"><span class="st">      ,round(100.0 * no_pay_rec_cnt/rentals,2) no_pay_rec_pct</span></a>
<a class="sourceLine" id="cb476-6" data-line-number="6"><span class="st">      ,rate_eq_paid</span></a>
<a class="sourceLine" id="cb476-7" data-line-number="7"><span class="st">      ,rate_eq_paid_cnt</span></a>
<a class="sourceLine" id="cb476-8" data-line-number="8"><span class="st">      ,round(100.0 * rate_eq_paid_cnt/rentals,2) rate_eq_paid_pct</span></a>
<a class="sourceLine" id="cb476-9" data-line-number="9"><span class="st">      ,rate_lt_paid</span></a>
<a class="sourceLine" id="cb476-10" data-line-number="10"><span class="st">      ,rate_lt_over_paid</span></a>
<a class="sourceLine" id="cb476-11" data-line-number="11"><span class="st">      ,rate_lt_paid_cnt</span></a>
<a class="sourceLine" id="cb476-12" data-line-number="12"><span class="st">      ,round(100.0 * rate_lt_paid_cnt/rentals,2) rate_lt_paid_pct</span></a>
<a class="sourceLine" id="cb476-13" data-line-number="13"><span class="st">      ,rate_gt_paid_due</span></a>
<a class="sourceLine" id="cb476-14" data-line-number="14"><span class="st">      ,rate_gt_paid_cnt</span></a>
<a class="sourceLine" id="cb476-15" data-line-number="15"><span class="st">      ,round(100.0 * rate_gt_paid_cnt/rentals,2) rate_gt_paid_pct</span></a>
<a class="sourceLine" id="cb476-16" data-line-number="16"><span class="st">      ,rentals</span></a>
<a class="sourceLine" id="cb476-17" data-line-number="17"><span class="st">      ,rate_eq_paid_cnt + rate_lt_paid_cnt + rate_gt_paid_cnt payments</span></a>
<a class="sourceLine" id="cb476-18" data-line-number="18"><span class="st">      ,round(100.0 * </span></a>
<a class="sourceLine" id="cb476-19" data-line-number="19"><span class="st">            (no_pay_rec_cnt + rate_eq_paid_cnt + rate_lt_paid_cnt + rate_gt_paid_cnt)/rentals</span></a>
<a class="sourceLine" id="cb476-20" data-line-number="20"><span class="st">            ,2) pct</span></a>
<a class="sourceLine" id="cb476-21" data-line-number="21"><span class="st">      ,rate_eq_paid + rate_lt_paid + rate_lt_over_paid amt_paid</span></a>
<a class="sourceLine" id="cb476-22" data-line-number="22"><span class="st">      ,no_pay_rec_due + rate_gt_paid_due amt_due</span></a>
<a class="sourceLine" id="cb476-23" data-line-number="23"><span class="st">  from (</span></a>
<a class="sourceLine" id="cb476-24" data-line-number="24"><span class="st">        select sum(case when p.rental_id is null then rental_rate else 0 end ) no_pay_rec_due</span></a>
<a class="sourceLine" id="cb476-25" data-line-number="25"><span class="st">              ,sum(case when p.rental_id is null then 1 else 0 end) no_pay_rec_cnt</span></a>
<a class="sourceLine" id="cb476-26" data-line-number="26"><span class="st">              ,sum(case when f.rental_rate = p.amount </span></a>
<a class="sourceLine" id="cb476-27" data-line-number="27"><span class="st">                        then p.amount else 0 end) rate_eq_paid</span></a>
<a class="sourceLine" id="cb476-28" data-line-number="28"><span class="st">              ,sum(case when f.rental_rate = p.amount </span></a>
<a class="sourceLine" id="cb476-29" data-line-number="29"><span class="st">                        then 1 else 0 end ) rate_eq_paid_cnt</span></a>
<a class="sourceLine" id="cb476-30" data-line-number="30"><span class="st">              ,sum(case when f.rental_rate &lt; p.amount </span></a>
<a class="sourceLine" id="cb476-31" data-line-number="31"><span class="st">                        then f.rental_rate else 0 end) rate_lt_paid</span></a>
<a class="sourceLine" id="cb476-32" data-line-number="32"><span class="st">              ,sum(case when f.rental_rate &lt; p.amount </span></a>
<a class="sourceLine" id="cb476-33" data-line-number="33"><span class="st">                        then p.amount-f.rental_rate else 0 end) rate_lt_over_paid</span></a>
<a class="sourceLine" id="cb476-34" data-line-number="34"><span class="st">              ,sum(case when f.rental_rate &lt; p.amount </span></a>
<a class="sourceLine" id="cb476-35" data-line-number="35"><span class="st">                        then 1 else 0 end) rate_lt_paid_cnt</span></a>
<a class="sourceLine" id="cb476-36" data-line-number="36"><span class="st">              ,sum(case when f.rental_rate &gt; p.amount </span></a>
<a class="sourceLine" id="cb476-37" data-line-number="37"><span class="st">                        then f.rental_rate - p.amount else 0 end ) rate_gt_paid_due</span></a>
<a class="sourceLine" id="cb476-38" data-line-number="38"><span class="st">              ,sum(case when f.rental_rate &gt; p.amount </span></a>
<a class="sourceLine" id="cb476-39" data-line-number="39"><span class="st">                        then 1 else 0 end ) rate_gt_paid_cnt</span></a>
<a class="sourceLine" id="cb476-40" data-line-number="40"><span class="st">              ,count(*) rentals</span></a>
<a class="sourceLine" id="cb476-41" data-line-number="41"><span class="st">            FROM rental r</span></a>
<a class="sourceLine" id="cb476-42" data-line-number="42"><span class="st">                 LEFT JOIN payment p ON r.rental_id = p.rental_id and r.customer_id = p.customer_id</span></a>
<a class="sourceLine" id="cb476-43" data-line-number="43"><span class="st">                 INNER JOIN inventory i ON r.inventory_id = i.inventory_id</span></a>
<a class="sourceLine" id="cb476-44" data-line-number="44"><span class="st">                 INNER JOIN film f ON i.film_id = f.film_id</span></a>
<a class="sourceLine" id="cb476-45" data-line-number="45"><span class="st">       ) as details</span></a>
<a class="sourceLine" id="cb476-46" data-line-number="46"><span class="st">;&quot;</span></a>
<a class="sourceLine" id="cb476-47" data-line-number="47">)</a>
<a class="sourceLine" id="cb476-48" data-line-number="48"><span class="co"># Rental counts</span></a>
<a class="sourceLine" id="cb476-49" data-line-number="49"><span class="kw">sp_print_df</span>(business_payment_dist_sql <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">ends_with</span>(<span class="st">&quot;cnt&quot;</span>),rentals))</a></code></pre></div>
<div id="htmlwidget-d603924d095b44f9f39d" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-d603924d095b44f9f39d">{"x":{"filter":"none","data":[["1"],[1453],[7925],[6643],[24],[16045]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>no_pay_rec_cnt<\/th>\n      <th>rate_eq_paid_cnt<\/th>\n      <th>rate_lt_paid_cnt<\/th>\n      <th>rate_gt_paid_cnt<\/th>\n      <th>rentals<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb477"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb477-1" data-line-number="1"><span class="co"># Payments</span></a>
<a class="sourceLine" id="cb477-2" data-line-number="2"><span class="kw">sp_print_df</span>(business_payment_dist_sql <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">ends_with</span>(<span class="st">&quot;paid&quot;</span>)))</a></code></pre></div>
<div id="htmlwidget-f6e01e985baca3b2a01f" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-f6e01e985baca3b2a01f">{"x":{"filter":"none","data":[["1"],[23397.75],[19448.57],[18456.76],[61303.08]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>rate_eq_paid<\/th>\n      <th>rate_lt_paid<\/th>\n      <th>rate_lt_over_paid<\/th>\n      <th>amt_paid<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb478"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb478-1" data-line-number="1"><span class="co"># Not paid amounts</span></a>
<a class="sourceLine" id="cb478-2" data-line-number="2"><span class="kw">sp_print_df</span>(business_payment_dist_sql <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">ends_with</span>(<span class="st">&quot;due&quot;</span>)))</a></code></pre></div>
<div id="htmlwidget-472c2b8f6d63d7358265" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-472c2b8f6d63d7358265">{"x":{"filter":"none","data":[["1"],[4302.47],[67.76],[4370.23]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>no_pay_rec_due<\/th>\n      <th>rate_gt_paid_due<\/th>\n      <th>amt_due<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb479"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb479-1" data-line-number="1"><span class="co"># Rental payments</span></a>
<a class="sourceLine" id="cb479-2" data-line-number="2"><span class="kw">sp_print_df</span>(business_payment_dist_sql <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">ends_with</span>(<span class="st">&quot;pct&quot;</span>)))</a></code></pre></div>
<div id="htmlwidget-42cd4e14f26053aac67b" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-42cd4e14f26053aac67b">{"x":{"filter":"none","data":[["1"],[9.06],[49.39],[41.4],[0.15],[100]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>no_pay_rec_pct<\/th>\n      <th>rate_eq_paid_pct<\/th>\n      <th>rate_lt_paid_pct<\/th>\n      <th>rate_gt_paid_pct<\/th>\n      <th>pct<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>These are interesting results.</p>
<ul>
<li>09.06% of the total records have no associated payment record in the amount of 4302.47<br />
</li>
<li>49.39% of the rentals have been fully paid in full, 23397.75.</li>
<li>41.40% of the rentals have collected more than the rental amount by 18456.75</li>
<li>00.15% of the rentals have collected less than the rental amount by 67.76.</li>
<li>The no_pay_rec_cnt + rate_gt_paid_cnt, <span class="math inline">\(1453 + 24 = 1477\)</span> is the number of rentals which have not been paid in full.</li>
<li>The total outstanding balance is <span class="math inline">\(4302.47 + 67.76 = 4370.23\)</span></li>
</ul>
<p>With over 40 percent over collection, someone needs to find out what is wrong with the collection process. Many customers are owed credits or free rentals.
</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-27" class="section level4">
<h4><span class="header-section-number">20.1.28.1</span> Replicate the output above using dplyr syntax.</h4>
<p>This table describes the columns in the code block answer that follows. There are payment records where the charged amount, rental rate, is less than the amount paid. These payments are split into two pieces, rate_lt_paid and rate_lt_over_paid. The rate_lt_paid is rental rate amount. The rate_lt_over_paid is the paid amount - rental rate, the over paid amount.</p>
<table>
<colgroup>
<col width="32%" />
<col width="42%" />
<col width="26%" />
</colgroup>
<thead>
<tr class="header">
<th>Column</th>
<th>Mapping</th>
<th>Definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>no_pay_rec_cnt</td>
<td></td>
<td>number of DVD rentals without an associated payment record.</td>
</tr>
<tr class="even">
<td>rate_eq_paid_cnt</td>
<td></td>
<td>number of DVD payments that match the film rental rate.</td>
</tr>
<tr class="odd">
<td>rate_lt_paid_cnt</td>
<td></td>
<td>number of DVD rental with rental rate less than the amount paid.</td>
</tr>
<tr class="even">
<td>rate_gt_paid_cnt</td>
<td></td>
<td>number of DVD rentals with rental rate greater than the film rental rate.</td>
</tr>
<tr class="odd">
<td>rentals</td>
<td></td>
<td>number of rental records analyzed</td>
</tr>
<tr class="even">
<td>rate_eq_paid</td>
<td></td>
<td>amount paid where the rate charged = amount paid</td>
</tr>
<tr class="odd">
<td>rate_lt_paid</td>
<td></td>
<td>amount paid where the rate charged &lt;</td>
</tr>
<tr class="even">
<td>rate_lt_over_paid</td>
<td></td>
<td>rate charged &lt; amount paid; This represents the amount over paid</td>
</tr>
<tr class="odd">
<td>amt_paid</td>
<td></td>
<td>Total amount paid</td>
</tr>
<tr class="even">
<td>no_pay_rec_due</td>
<td></td>
<td>DVD rentals charges due without a payment record</td>
</tr>
<tr class="odd">
<td>rate_gt_paid_due</td>
<td></td>
<td>DVD rentals charged due with a payment record</td>
</tr>
<tr class="even">
<td>amt_due</td>
<td></td>
<td>Total amount due and not collected.</td>
</tr>
<tr class="odd">
<td>no_pay_rec_pct</td>
<td></td>
<td>Percent of rentals without a payment record.</td>
</tr>
<tr class="even">
<td>rate_lt_paid_pct</td>
<td></td>
<td>Percent of rentals where the rental charge is less than the paid amount</td>
</tr>
<tr class="odd">
<td>rate_gt_paid_pct</td>
<td></td>
<td>Percent of rentals where the rental charge is greater than the paid amount</td>
</tr>
<tr class="even">
<td>pct</td>
<td></td>
<td>Sum of percentages</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb480"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb480-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb480-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb480-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb480-4" data-line-number="4"></a>
<a class="sourceLine" id="cb480-5" data-line-number="5">business_payment_dist_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb480-6" data-line-number="6">    </a>
<a class="sourceLine" id="cb480-7" data-line-number="7"><span class="co"># Rental counts</span></a>
<a class="sourceLine" id="cb480-8" data-line-number="8"><span class="kw">sp_print_df</span>(business_payment_dist_dplyr)</a></code></pre></div>
<div id="htmlwidget-ed0cabd356ee7bf24f99" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-ed0cabd356ee7bf24f99">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="bad-data-analysis" class="section level4">
<h4><span class="header-section-number">20.1.28.2</span> Bad data analysis</h4>
<p>Here are the sanity check numbers calculated at the beginning of this exercise.</p>
<table>
<thead>
<tr class="header">
<th>rec_type</th>
<th>cnt_amt</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>payments</td>
<td>61312.04</td>
</tr>
<tr class="even">
<td>rentals</td>
<td>16045.00</td>
</tr>
</tbody>
</table>
<p>Note that the sanity check numbers above, do not match the numbers above. If you query returned the numbers above, use the following result set ot see where the differences exist.</p>
<div class="sourceCode" id="cb481"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb481-1" data-line-number="1">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb481-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb481-3" data-line-number="3"> <span class="st">&quot;SELECT  &#39;correct join&#39; hint,r.rental_id,r.customer_id,p.customer_id payment_customer_id,p.rental_id payment_rental_id,p.amount</span></a>
<a class="sourceLine" id="cb481-4" data-line-number="4"><span class="st">    FROM rental r</span></a>
<a class="sourceLine" id="cb481-5" data-line-number="5"><span class="st">         LEFT JOIN payment p ON r.rental_id = p.rental_id and r.customer_id = p.customer_id</span></a>
<a class="sourceLine" id="cb481-6" data-line-number="6"><span class="st">   where r.rental_id = 4591</span></a>
<a class="sourceLine" id="cb481-7" data-line-number="7"><span class="st">  UNION </span></a>
<a class="sourceLine" id="cb481-8" data-line-number="8"><span class="st"> SELECT  &#39;incorrect join&#39; hint,r.rental_id,r.customer_id,p.customer_id payment_customer_id,p.rental_id payment_rental_id,p.amount</span></a>
<a class="sourceLine" id="cb481-9" data-line-number="9"><span class="st">    FROM rental r</span></a>
<a class="sourceLine" id="cb481-10" data-line-number="10"><span class="st">         LEFT JOIN payment p ON r.rental_id = p.rental_id</span></a>
<a class="sourceLine" id="cb481-11" data-line-number="11"><span class="st">   where r.rental_id = 4591</span></a>
<a class="sourceLine" id="cb481-12" data-line-number="12"><span class="st">     and p.customer_id != 182</span></a>
<a class="sourceLine" id="cb481-13" data-line-number="13"><span class="st">;&quot;</span>)</a>
<a class="sourceLine" id="cb481-14" data-line-number="14"><span class="kw">sp_print_df</span>(<span class="kw">head</span>(rs))</a></code></pre></div>
<div id="htmlwidget-e39b708ff0d549d74256" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-e39b708ff0d549d74256">{"x":{"filter":"none","data":[["1","2","3","4","5"],["incorrect join","incorrect join","incorrect join","incorrect join","correct join"],[4591,4591,4591,4591,4591],[182,182,182,182,182],[546,401,16,259,182],[4591,4591,4591,4591,4591],[3.99,0.99,1.99,1.99,3.99]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>hint<\/th>\n      <th>rental_id<\/th>\n      <th>customer_id<\/th>\n      <th>payment_customer_id<\/th>\n      <th>payment_rental_id<\/th>\n      <th>amount<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4,5,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="which-customers-have-the-highest-open-amounts" class="section level3">
<h3><span class="header-section-number">20.1.29</span> 30. Which customers have the highest open amounts?</h3>
<p>From the previous exercise, we know that there are 1477 missing payment records or not fully paid payment records. List the top 5 customers from each category base on balance due amounts.</p>
<p>To answer this question we look at the <code>rental</code>, <code>payment</code>, <code>inventory</code>, <code>film</code> and <code>customer</code> tables to answer this question.</p>
<div class="sourceCode" id="cb482"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb482-1" data-line-number="1">customer_open_amts_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb482-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb482-3" data-line-number="3"><span class="st">&quot;  select customer_id</span></a>
<a class="sourceLine" id="cb482-4" data-line-number="4"><span class="st">         ,concat(first_name,&#39; &#39;,last_name) customer</span></a>
<a class="sourceLine" id="cb482-5" data-line-number="5"><span class="st">         ,pay_record</span></a>
<a class="sourceLine" id="cb482-6" data-line-number="6"><span class="st">         ,rental_amt</span></a>
<a class="sourceLine" id="cb482-7" data-line-number="7"><span class="st">         ,paid_amt</span></a>
<a class="sourceLine" id="cb482-8" data-line-number="8"><span class="st">         ,due_amt</span></a>
<a class="sourceLine" id="cb482-9" data-line-number="9"><span class="st">         ,cnt</span></a>
<a class="sourceLine" id="cb482-10" data-line-number="10"><span class="st">         ,rn</span></a>
<a class="sourceLine" id="cb482-11" data-line-number="11"><span class="st">  from (select c.customer_id</span></a>
<a class="sourceLine" id="cb482-12" data-line-number="12"><span class="st">              ,c.first_name</span></a>
<a class="sourceLine" id="cb482-13" data-line-number="13"><span class="st">              ,c.last_name</span></a>
<a class="sourceLine" id="cb482-14" data-line-number="14"><span class="st">              ,case when p.amount is null then &#39;No&#39; else &#39;Yes&#39; end Pay_record</span></a>
<a class="sourceLine" id="cb482-15" data-line-number="15"><span class="st">              ,sum(f.rental_rate) rental_amt</span></a>
<a class="sourceLine" id="cb482-16" data-line-number="16"><span class="st">              ,sum(coalesce(p.amount,0))  paid_amt</span></a>
<a class="sourceLine" id="cb482-17" data-line-number="17"><span class="st">              ,sum(f.rental_rate - coalesce(p.amount,0)) due_amt</span></a>
<a class="sourceLine" id="cb482-18" data-line-number="18"><span class="st">              ,count(*) cnt</span></a>
<a class="sourceLine" id="cb482-19" data-line-number="19"><span class="st">              ,row_number() over (partition by case when p.amount is null then &#39;No&#39; else &#39;Yes&#39; end</span></a>
<a class="sourceLine" id="cb482-20" data-line-number="20"><span class="st">                                  order by sum(f.rental_rate - coalesce(p.amount,0)) desc,c.customer_id) rn</span></a>
<a class="sourceLine" id="cb482-21" data-line-number="21"><span class="st">          FROM rental r</span></a>
<a class="sourceLine" id="cb482-22" data-line-number="22"><span class="st">               LEFT JOIN payment p</span></a>
<a class="sourceLine" id="cb482-23" data-line-number="23"><span class="st">                 ON r.rental_id = p.rental_id and r.customer_id = p.customer_id</span></a>
<a class="sourceLine" id="cb482-24" data-line-number="24"><span class="st">               INNER JOIN inventory i</span></a>
<a class="sourceLine" id="cb482-25" data-line-number="25"><span class="st">                 ON r.inventory_id = i.inventory_id</span></a>
<a class="sourceLine" id="cb482-26" data-line-number="26"><span class="st">               INNER JOIN film f</span></a>
<a class="sourceLine" id="cb482-27" data-line-number="27"><span class="st">                 ON i.film_id = f.film_id</span></a>
<a class="sourceLine" id="cb482-28" data-line-number="28"><span class="st">               INNER JOIN customer c</span></a>
<a class="sourceLine" id="cb482-29" data-line-number="29"><span class="st">                 ON r.customer_id = c.customer_id</span></a>
<a class="sourceLine" id="cb482-30" data-line-number="30"><span class="st">        WHERE f.rental_rate &gt; coalesce(p.amount, 0)</span></a>
<a class="sourceLine" id="cb482-31" data-line-number="31"><span class="st">       group by c.customer_id,c.first_name,c.last_name,case when p.amount is null then &#39;No&#39; else &#39;Yes&#39; end</span></a>
<a class="sourceLine" id="cb482-32" data-line-number="32"><span class="st">       ) as src</span></a>
<a class="sourceLine" id="cb482-33" data-line-number="33"><span class="st">  where rn &lt;= 5 -- and Pay_record = &#39;No&#39; or Pay_record = &#39;Yes&#39;</span></a>
<a class="sourceLine" id="cb482-34" data-line-number="34"><span class="st">  order by Pay_record,rn</span></a>
<a class="sourceLine" id="cb482-35" data-line-number="35"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb482-36" data-line-number="36"><span class="kw">sp_print_df</span>(customer_open_amts_sql)</a></code></pre></div>
<div id="htmlwidget-8e3082ed4e5b0ee283ce" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-8e3082ed4e5b0ee283ce">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10"],[293,307,316,299,274,75,53,60,155,163],["Mae Fletcher","Joseph Joy","Steven Curley","James Gannon","Naomi Jennings","Tammy Sanders","Heather Morris","Mildred Bailey","Gail Knight","Cathy Spencer"],["No","No","No","No","No","Yes","Yes","Yes","Yes","Yes"],[35.9,31.9,31.9,30.91,29.92,5.98,4.99,4.99,4.99,4.99],[0,0,0,0,0,0,0,0,0,0],[35.9,31.9,31.9,30.91,29.92,5.98,4.99,4.99,4.99,4.99],[10,10,10,9,8,2,1,1,1,1],[1,2,3,4,5,1,2,3,4,5]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>customer_id<\/th>\n      <th>customer<\/th>\n      <th>pay_record<\/th>\n      <th>rental_amt<\/th>\n      <th>paid_amt<\/th>\n      <th>due_amt<\/th>\n      <th>cnt<\/th>\n      <th>rn<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,4,5,6,7,8]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>From the previous exercise we see that the number of rentals that have not been paid in full is 1477. There are 24 records that have a payment record, pay_record = ‘Yes’, all have a 0 paid amount. There are 1453 DVD’s rented out that have no payment record. The top 3 customers have 10 DVD’s each that have not been paid.
</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-28" class="section level4">
<h4><span class="header-section-number">20.1.29.1</span> Replicate the output above using dplyr syntax.</h4>
<table>
<colgroup>
<col width="12%" />
<col width="24%" />
<col width="63%" />
</colgroup>
<thead>
<tr class="header">
<th>column</th>
<th>definition</th>
<th>mapping</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>customer</td>
<td>first_name + last_name</td>
<td></td>
</tr>
<tr class="even">
<td>Pay_record</td>
<td>Payment record exists Y/N</td>
<td>case when p.amount is null then ‘No’ else ‘Yes’ end</td>
</tr>
<tr class="odd">
<td>rental_amt</td>
<td>aggrgated film.rental_rate</td>
<td></td>
</tr>
<tr class="even">
<td>paid_amt</td>
<td>aggregated payment.amount</td>
<td></td>
</tr>
<tr class="odd">
<td>due_amt</td>
<td>aggregated film.rental_rate - payment.amount</td>
<td></td>
</tr>
<tr class="even">
<td>cnt</td>
<td>number of rentals/customer</td>
<td></td>
</tr>
<tr class="odd">
<td>rn</td>
<td>row number</td>
<td></td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb483"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb483-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb483-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb483-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb483-4" data-line-number="4"></a>
<a class="sourceLine" id="cb483-5" data-line-number="5">customer_open_amts_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb483-6" data-line-number="6"></a>
<a class="sourceLine" id="cb483-7" data-line-number="7"><span class="kw">sp_print_df</span>(customer_open_amts_dplyr)</a></code></pre></div>
<div id="htmlwidget-3cafdc732b82de0842ef" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-3cafdc732b82de0842ef">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="what-is-the-business-cash-flow" class="section level3">
<h3><span class="header-section-number">20.1.30</span> 31. What is the business cash flow?</h3>
<p>In the previous exercise we saw that about 50% of the rentals collected the correct amount and 40% of the rentals over collected. The last 10% were never collected.</p>
<p>Calculate the number of days it took before the payment was collected and the amount collected?</p>
<p>To answer this question we look at the <code>rental</code>, <code>customer</code>, <code>payment</code>, <code>inventory</code>, <code>payment</code> and <code>film</code> tables to answer this question.</p>
<div class="sourceCode" id="cb484"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb484-1" data-line-number="1">cash_flow_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb484-2" data-line-number="2"><span class="st">&quot;SELECT payment_date - exp_rtn_dt payment_days</span></a>
<a class="sourceLine" id="cb484-3" data-line-number="3"><span class="st">    ,sum(coalesce(amount, charges)) paid_or_due</span></a>
<a class="sourceLine" id="cb484-4" data-line-number="4"><span class="st">    ,count(*) late_returns</span></a>
<a class="sourceLine" id="cb484-5" data-line-number="5"><span class="st">FROM (</span></a>
<a class="sourceLine" id="cb484-6" data-line-number="6"><span class="st">    SELECT payment_date::DATE </span></a>
<a class="sourceLine" id="cb484-7" data-line-number="7"><span class="st">        ,(r.rental_date + INTERVAL &#39;1 day&#39; * f.rental_duration)::DATE exp_rtn_dt</span></a>
<a class="sourceLine" id="cb484-8" data-line-number="8"><span class="st">        ,p.amount </span></a>
<a class="sourceLine" id="cb484-9" data-line-number="9"><span class="st">        ,f.rental_rate charges</span></a>
<a class="sourceLine" id="cb484-10" data-line-number="10"><span class="st">        ,r.rental_date</span></a>
<a class="sourceLine" id="cb484-11" data-line-number="11"><span class="st">        ,r.return_date</span></a>
<a class="sourceLine" id="cb484-12" data-line-number="12"><span class="st">    FROM rental r</span></a>
<a class="sourceLine" id="cb484-13" data-line-number="13"><span class="st">         LEFT JOIN customer c ON c.customer_id = r.customer_id</span></a>
<a class="sourceLine" id="cb484-14" data-line-number="14"><span class="st">         LEFT JOIN address a  ON c.address_id = a.address_id</span></a>
<a class="sourceLine" id="cb484-15" data-line-number="15"><span class="st">         LEFT JOIN city       ON city.city_id = a.city_id</span></a>
<a class="sourceLine" id="cb484-16" data-line-number="16"><span class="st">         LEFT JOIN country ctry ON ctry.country_id = city.country_id</span></a>
<a class="sourceLine" id="cb484-17" data-line-number="17"><span class="st">         LEFT JOIN inventory i  ON r.inventory_id = i.inventory_id</span></a>
<a class="sourceLine" id="cb484-18" data-line-number="18"><span class="st">         LEFT JOIN payment p    ON c.customer_id = p.customer_id </span></a>
<a class="sourceLine" id="cb484-19" data-line-number="19"><span class="st">                               AND p.rental_id = r.rental_id</span></a>
<a class="sourceLine" id="cb484-20" data-line-number="20"><span class="st">         LEFT JOIN film f       ON i.film_id = f.film_id</span></a>
<a class="sourceLine" id="cb484-21" data-line-number="21"><span class="st">    WHERE return_date &gt; (r.rental_date + INTERVAL &#39;1 day&#39; * f.rental_duration)::DATE </span></a>
<a class="sourceLine" id="cb484-22" data-line-number="22"><span class="st">    ) AS src</span></a>
<a class="sourceLine" id="cb484-23" data-line-number="23"><span class="st">GROUP BY payment_date - exp_rtn_dt</span></a>
<a class="sourceLine" id="cb484-24" data-line-number="24"><span class="st">ORDER BY payment_date - exp_rtn_dt DESC&quot;</span>)</a>
<a class="sourceLine" id="cb484-25" data-line-number="25"></a>
<a class="sourceLine" id="cb484-26" data-line-number="26"><span class="kw">sp_print_df</span>(cash_flow_sql)</a></code></pre></div>
<div id="htmlwidget-9df3d00c4d83b54877ba" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-9df3d00c4d83b54877ba">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20"],[null,636,635,634,633,632,631,630,607,606,605,604,603,602,574,573,572,571,570,569],[2211.23,5599.24,5070.94,4173.02,2993.4,1692.83,316.27,1.98,1660.1,1458.22,1162.77,898.99,578.58,33.93,5234.98,4279.18,3311.73,2485.4,1438.39,51.85],[777,976,906,798,660,417,73,2,290,278,223,201,142,7,902,782,627,560,361,15]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>payment_days<\/th>\n      <th>paid_or_due<\/th>\n      <th>late_returns<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>Wow those are really generous terms. Customers are paying 1.2 to 1.7 years after they returned the DVD. This business is in serious financial trouble!
</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-29" class="section level4">
<h4><span class="header-section-number">20.1.30.1</span> Replicate the output above using dplyr syntax.</h4>
<table>
<colgroup>
<col width="12%" />
<col width="24%" />
<col width="63%" />
</colgroup>
<thead>
<tr class="header">
<th>column</th>
<th>definition</th>
<th>mapping</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>paid_or_due</td>
<td>paid amt associated with rental or the rental_rate</td>
<td>ifelse(is.na(amount),rental_rate,amount)</td>
</tr>
<tr class="even">
<td>payment_days</td>
<td>days til payment</td>
<td>payment_date - rental_date</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb485"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb485-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb485-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb485-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb485-4" data-line-number="4"></a>
<a class="sourceLine" id="cb485-5" data-line-number="5">cash_flow_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb485-6" data-line-number="6"></a>
<a class="sourceLine" id="cb485-7" data-line-number="7"><span class="kw">sp_print_df</span>(cash_flow_dplyr)</a></code></pre></div>
<div id="htmlwidget-20ef643ff2d76ae434f3" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-20ef643ff2d76ae434f3">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="customer-information" class="section level3">
<h3><span class="header-section-number">20.1.31</span> 32. Customer information</h3>
<p>Create a function that takes a customer id and returns</p>
<ul>
<li>customer address information</li>
<li>films rented and returned information</li>
<li>customer payment information</li>
</ul>
<p>The hidden code block implements such a function in SQL.</p>
<p>To answer this question we look at the <code>rental</code>, <code>customer</code>, <code>address</code>, <code>city,</code>country<code>,</code>inventory<code>,</code>payment<code>and</code>film` tables to answer this question.</p>
<div class="sourceCode" id="cb486"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb486-1" data-line-number="1">customer_details_fn_sql &lt;-<span class="st"> </span><span class="cf">function</span>(cust_id) {</a>
<a class="sourceLine" id="cb486-2" data-line-number="2">    customer_details_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb486-3" data-line-number="3">    <span class="st">&quot;select c.customer_id id,concat(first_name,&#39; &#39;,c.last_name) customer</span></a>
<a class="sourceLine" id="cb486-4" data-line-number="4"><span class="st">          ,c.email,a.phone,a.address,address2,city.city,a.postal_code,ctry.country</span></a>
<a class="sourceLine" id="cb486-5" data-line-number="5"><span class="st">          ,c.store_id cust_store_id</span></a>
<a class="sourceLine" id="cb486-6" data-line-number="6"><span class="st">          ,i.store_id inv_store_id</span></a>
<a class="sourceLine" id="cb486-7" data-line-number="7"><span class="st">          ,f.film_id</span></a>
<a class="sourceLine" id="cb486-8" data-line-number="8"><span class="st">          ,f.title</span></a>
<a class="sourceLine" id="cb486-9" data-line-number="9"><span class="st">          ,r.rental_date::date rented</span></a>
<a class="sourceLine" id="cb486-10" data-line-number="10"><span class="st">          ,r.return_date::date returned</span></a>
<a class="sourceLine" id="cb486-11" data-line-number="11"><span class="st">          ,(r.rental_date + INTERVAL &#39;1 day&#39;  * f.rental_duration)::date exp_rtn_dt</span></a>
<a class="sourceLine" id="cb486-12" data-line-number="12"><span class="st">          ,case when r.return_date is null</span></a>
<a class="sourceLine" id="cb486-13" data-line-number="13"><span class="st">                then null</span></a>
<a class="sourceLine" id="cb486-14" data-line-number="14"><span class="st">                else r.return_date::date  - (r.rental_date + INTERVAL &#39;1 day&#39;  * f.rental_duration)::date</span></a>
<a class="sourceLine" id="cb486-15" data-line-number="15"><span class="st">           end rtn_stat</span></a>
<a class="sourceLine" id="cb486-16" data-line-number="16"><span class="st">          ,case when r.rental_id is null</span></a>
<a class="sourceLine" id="cb486-17" data-line-number="17"><span class="st">                then null</span></a>
<a class="sourceLine" id="cb486-18" data-line-number="18"><span class="st">                      -- dvd returned             </span></a>
<a class="sourceLine" id="cb486-19" data-line-number="19"><span class="st">                when r.return_date is null</span></a>
<a class="sourceLine" id="cb486-20" data-line-number="20"><span class="st">                then 1</span></a>
<a class="sourceLine" id="cb486-21" data-line-number="21"><span class="st">                else 0</span></a>
<a class="sourceLine" id="cb486-22" data-line-number="22"><span class="st">           end not_rtn</span></a>
<a class="sourceLine" id="cb486-23" data-line-number="23"><span class="st">          ,payment_date::date pay_dt</span></a>
<a class="sourceLine" id="cb486-24" data-line-number="24"><span class="st">          ,f.rental_rate charges</span></a>
<a class="sourceLine" id="cb486-25" data-line-number="25"><span class="st">          ,p.amount paid</span></a>
<a class="sourceLine" id="cb486-26" data-line-number="26"><span class="st">          ,p.amount-f.rental_rate delta</span></a>
<a class="sourceLine" id="cb486-27" data-line-number="27"><span class="st">          ,p.staff_id pay_staff_id</span></a>
<a class="sourceLine" id="cb486-28" data-line-number="28"><span class="st">          ,payment_date::date - rental_date::date pay_days</span></a>
<a class="sourceLine" id="cb486-29" data-line-number="29"><span class="st">          ,r.rental_id,i.inventory_id,payment_id</span></a>
<a class="sourceLine" id="cb486-30" data-line-number="30"><span class="st">      from customer c left join rental r on c.customer_id = r.customer_id</span></a>
<a class="sourceLine" id="cb486-31" data-line-number="31"><span class="st">                      left join address a on c.address_id = a.address_id</span></a>
<a class="sourceLine" id="cb486-32" data-line-number="32"><span class="st">                      left join city on city.city_id = a.city_id</span></a>
<a class="sourceLine" id="cb486-33" data-line-number="33"><span class="st">                      left join country ctry on ctry.country_id = city.country_id</span></a>
<a class="sourceLine" id="cb486-34" data-line-number="34"><span class="st">                      left join inventory i on r.inventory_id = i.inventory_id</span></a>
<a class="sourceLine" id="cb486-35" data-line-number="35"><span class="st">                      left join payment p on c.customer_id = p.customer_id and p.rental_id = r.rental_id</span></a>
<a class="sourceLine" id="cb486-36" data-line-number="36"><span class="st">                      left join film f on i.film_id = f.film_id</span></a>
<a class="sourceLine" id="cb486-37" data-line-number="37"><span class="st">     where c.customer_id = $1</span></a>
<a class="sourceLine" id="cb486-38" data-line-number="38"><span class="st">    order by id,rented desc</span></a>
<a class="sourceLine" id="cb486-39" data-line-number="39"><span class="st">    &quot;</span></a>
<a class="sourceLine" id="cb486-40" data-line-number="40">    ,cust_id</a>
<a class="sourceLine" id="cb486-41" data-line-number="41">    )</a>
<a class="sourceLine" id="cb486-42" data-line-number="42">    <span class="kw">return</span>(customer_details_sql)</a>
<a class="sourceLine" id="cb486-43" data-line-number="43">}</a></code></pre></div>
<p>The following code block executes the customer function. Change the <code>cust_id</code> value to see differnt customers.</p>
<div class="sourceCode" id="cb487"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb487-1" data-line-number="1">cust_id &lt;-<span class="st"> </span><span class="dv">600</span></a>
<a class="sourceLine" id="cb487-2" data-line-number="2"><span class="kw">sp_print_df</span>( <span class="kw">customer_details_fn_sql</span>(cust_id))</a></code></pre></div>
<div id="htmlwidget-7a1ca14bd453df078a7a" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-7a1ca14bd453df078a7a">{"x":{"filter":"none","data":[["1"],[600],["Sophie Yang"],["sophie.yang@sakilacustomer.org"],[""],["47 MySakila Drive"],[null],["Lethbridge"],[""],["Canada"],[3],[1],[1001],["Sophie's Choice"],["2019-02-25"],["2019-03-04"],["2019-03-04"],[0],[0],[null],[4.99],[null],[null],[null],[null],[16050],[4582],[null]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>id<\/th>\n      <th>customer<\/th>\n      <th>email<\/th>\n      <th>phone<\/th>\n      <th>address<\/th>\n      <th>address2<\/th>\n      <th>city<\/th>\n      <th>postal_code<\/th>\n      <th>country<\/th>\n      <th>cust_store_id<\/th>\n      <th>inv_store_id<\/th>\n      <th>film_id<\/th>\n      <th>title<\/th>\n      <th>rented<\/th>\n      <th>returned<\/th>\n      <th>exp_rtn_dt<\/th>\n      <th>rtn_stat<\/th>\n      <th>not_rtn<\/th>\n      <th>pay_dt<\/th>\n      <th>charges<\/th>\n      <th>paid<\/th>\n      <th>delta<\/th>\n      <th>pay_staff_id<\/th>\n      <th>pay_days<\/th>\n      <th>rental_id<\/th>\n      <th>inventory_id<\/th>\n      <th>payment_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,10,11,12,17,18,20,21,22,23,24,25,26,27]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div id="replicate-the-output-above-using-dplyr-syntax.-30" class="section level4">
<h4><span class="header-section-number">20.1.31.1</span> Replicate the output above using dplyr syntax.</h4>
<table>
<colgroup>
<col width="12%" />
<col width="24%" />
<col width="63%" />
</colgroup>
<thead>
<tr class="header">
<th>column</th>
<th>definition</th>
<th>mapping</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>id</td>
<td>customer_id</td>
<td></td>
</tr>
<tr class="even">
<td>customer</td>
<td>first_name + last_name</td>
<td></td>
</tr>
<tr class="odd">
<td>exp_rtn_dt</td>
<td>expected return date</td>
<td>rental.rental_date + film.rental_duration</td>
</tr>
<tr class="even">
<td>rtn_stat</td>
<td>return status</td>
<td>rental.return_date - (rental.rental_date + film duration)</td>
</tr>
<tr class="odd">
<td>not_rtn</td>
<td>dvd not returned</td>
<td>null if rental_id is null;not rented; 1 return_date null else 0</td>
</tr>
<tr class="even">
<td>pay_dt</td>
<td>payment_date</td>
<td></td>
</tr>
<tr class="odd">
<td>delta</td>
<td></td>
<td>payment.amount-film.rental_rate</td>
</tr>
<tr class="even">
<td>pay_staff_id</td>
<td>payment.staff_id</td>
<td>payment.staff_id</td>
</tr>
<tr class="odd">
<td>pay_days</td>
<td>days til payment</td>
<td>payment_date - rental_date</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb488"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb488-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;store&#39;)</span></a>
<a class="sourceLine" id="cb488-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb488-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb488-4" data-line-number="4"></a>
<a class="sourceLine" id="cb488-5" data-line-number="5">customer_details_fn_dplyr &lt;-<span class="st"> </span><span class="cf">function</span>(cust_id) {</a>
<a class="sourceLine" id="cb488-6" data-line-number="6"></a>
<a class="sourceLine" id="cb488-7" data-line-number="7">customer_details_dplyr &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="st">&quot;code me&quot;</span>)</a>
<a class="sourceLine" id="cb488-8" data-line-number="8"></a>
<a class="sourceLine" id="cb488-9" data-line-number="9"><span class="kw">return</span>(customer_details_dplyr)</a>
<a class="sourceLine" id="cb488-10" data-line-number="10">}</a></code></pre></div>
<p>Use the following code block to test the dplyr function.</p>
<div class="sourceCode" id="cb489"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb489-1" data-line-number="1">cust_id &lt;-<span class="st"> </span><span class="dv">601</span></a>
<a class="sourceLine" id="cb489-2" data-line-number="2"><span class="kw">sp_print_df</span>(<span class="kw">customer_details_fn_dplyr</span>(cust_id))</a></code></pre></div>
<div id="htmlwidget-e07c38820216518b4dbd" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-e07c38820216518b4dbd">{"x":{"filter":"none","data":[["1"],["code me"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>\"code me\"<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb490"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb490-1" data-line-number="1"><span class="co"># diconnect from the db</span></a>
<a class="sourceLine" id="cb490-2" data-line-number="2"><span class="kw">dbDisconnect</span>(con)</a>
<a class="sourceLine" id="cb490-3" data-line-number="3"></a>
<a class="sourceLine" id="cb490-4" data-line-number="4"><span class="kw">sp_docker_stop</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="cb491"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb491-1" data-line-number="1">knitr<span class="op">::</span><span class="kw">knit_exit</span>()</a></code></pre></div>
<!--chapter:end:153-sql-joins-exercises.Rmd-->
</div>
</div>
</div>
</div>
<div id="chapter_sql-joins-exercises" class="section level1">
<h1><span class="header-section-number">21</span> SQL Joins exercises</h1>
<pre><code>&gt; This chapter contains questions one may be curious about or asked about the DVD Rental business.  
&gt; The goal of the exercises is extracting useful or questionable insights from one or more tables.   Each exercise has has some or all of the following parts.</code></pre>
<blockquote>
<ol style="list-style-type: decimal">
<li>The question.</li>
<li>The tables used to answer the question.</li>
<li>A hidden SQL code block showing the desired output. Click the code button to see the SQL code.<br />
</li>
<li>A table of derived values or renamed columns shown in the SQL block to facilitate replicating the desired dplyr solution. Abbreviated column names are used to squeeze in more columns into the answer to reduce scrolling across the screen.</li>
<li>A replication section where you recreate the desired output using dplyr syntax. Most columns come directly out of the tables. Each replication code block has three commented function calls</li>
</ol>
<ul>
<li>sp_tbl_descr(‘store’) –describes a table, store</li>
<li>sp_tbl_pk_fk(‘table_name’) –shows a table’s primary and foreign keys</li>
<li>sp_print_df(table_rows_sql) –shows table row counts.</li>
</ul>
<ol start="6" style="list-style-type: decimal">
<li>To keep the exercises concentrated on the joins, all derived dates drop their timestamp.
<ul>
<li>SQL syntax: date_column::DATE</li>
<li>Dplyr syntax: as.date(date_colun)</li>
</ul></li>
</ol>
</blockquote>
</div>
<div id="exercise-instructions-1" class="section level1">
<h1><span class="header-section-number">22</span> Exercise Instructions</h1>
<ol style="list-style-type: decimal">
<li>Manually execute all the code blocks up-to the “SQL Union Exercise.”<br />
</li>
<li>Most of the exercises can be performed in any order.<br />
</li>
</ol>
<ul>
<li>There are function exercises that create a function followed by another code block to call the function in the previous exercise.</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>Use the Show Document Outline, CTL-Shift-O, to navigate to the different exercises.</li>
</ol>
<p>Verify Docker is up and running:</p>
<div class="sourceCode" id="cb493"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb493-1" data-line-number="1"><span class="kw">sp_check_that_docker_is_up</span>()</a></code></pre></div>
<pre><code>## [1] &quot;Docker is up but running no containers&quot;</code></pre>
<p>Verify pet DB is available, it may be stopped.</p>
<div class="sourceCode" id="cb495"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb495-1" data-line-number="1"><span class="kw">sp_show_all_docker_containers</span>()</a></code></pre></div>
<pre><code>## CONTAINER ID        IMAGE                COMMAND                  CREATED             STATUS                     PORTS               NAMES
## ce3accea3583        postgres-dvdrental   &quot;docker-entrypoint.s…&quot;   56 seconds ago      Exited (0) 2 seconds ago                       sql-pet</code></pre>
<p>Start up the <code>docker-pet</code> container</p>
<div class="sourceCode" id="cb497"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb497-1" data-line-number="1"><span class="kw">sp_docker_start</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<p>Now connect to the database with R</p>
<div class="sourceCode" id="cb498"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb498-1" data-line-number="1"><span class="co"># need to wait for Docker &amp; Postgres to come up before connecting.</span></a>
<a class="sourceLine" id="cb498-2" data-line-number="2"></a>
<a class="sourceLine" id="cb498-3" data-line-number="3">con &lt;-<span class="st"> </span><span class="kw">sp_get_postgres_connection</span>(</a>
<a class="sourceLine" id="cb498-4" data-line-number="4">  <span class="dt">user =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_USER_NAME&quot;</span>),</a>
<a class="sourceLine" id="cb498-5" data-line-number="5">  <span class="dt">password =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_PASSWORD&quot;</span>),</a>
<a class="sourceLine" id="cb498-6" data-line-number="6">  <span class="dt">dbname =</span> <span class="st">&quot;dvdrental&quot;</span>,</a>
<a class="sourceLine" id="cb498-7" data-line-number="7">  <span class="dt">seconds_to_test =</span> <span class="dv">30</span></a>
<a class="sourceLine" id="cb498-8" data-line-number="8">)</a></code></pre></div>
</div>
<div id="dplyr-tables-1" class="section level1">
<h1><span class="header-section-number">23</span> Dplyr tables</h1>
<p>All the tables defined in the DVD Rental System will fit into memory which is rarely the case when working with a database. Each table is loaded into an R object named TableName_table, via a DBI::dbReadTable call.</p>
<ul>
<li>actor_table &lt;- DBI::dbReadTable(con,“actor”)</li>
</ul>
<div class="sourceCode" id="cb499"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb499-1" data-line-number="1"><span class="kw">source</span>(<span class="kw">here</span>(<span class="st">&#39;book-src&#39;</span>, <span class="st">&#39;dvdrental-table-declarations.R&#39;</span>),<span class="dt">echo=</span><span class="ot">FALSE</span>)</a></code></pre></div>
<p>The following code block deletes and inserts records into the different tables used in the exercises in this chpater. The techniques used in this code block are discussed in detail in the appendix, ??add link here.??</p>
<div class="sourceCode" id="cb500"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb500-1" data-line-number="1"><span class="kw">source</span>(<span class="kw">here</span>(<span class="st">&#39;book-src&#39;</span>, <span class="st">&#39;sql_pet_data.R&#39;</span>),<span class="dt">echo=</span><span class="ot">FALSE</span>)</a></code></pre></div>
</div>
<div id="sql-union-exercise-1" class="section level1">
<h1><span class="header-section-number">24</span> SQL Union Exercise</h1>
<p>When joining many tables, it is helpful to have the number of rows from each table as an initial sanity check that the joins are returning a reasonable number of rows.</p>
<div id="how-many-rows-are-in-each-table-1" class="section level2">
<h2><span class="header-section-number">24.1</span> 1. How many rows are in each table?</h2>
<div class="sourceCode" id="cb501"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb501-1" data-line-number="1">table_rows_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb501-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb501-3" data-line-number="3">  <span class="st">&quot;select *</span></a>
<a class="sourceLine" id="cb501-4" data-line-number="4"><span class="st">                 from (      select &#39;actor&#39; tbl_name,count(*) from actor </span></a>
<a class="sourceLine" id="cb501-5" data-line-number="5"><span class="st">                       union select &#39;category&#39; tbl_name,count(*) from category</span></a>
<a class="sourceLine" id="cb501-6" data-line-number="6"><span class="st">                       union select &#39;film&#39; tbl_name,count(*) from film</span></a>
<a class="sourceLine" id="cb501-7" data-line-number="7"><span class="st">                       union select &#39;film_actor&#39; tbl_name,count(*) from film_actor</span></a>
<a class="sourceLine" id="cb501-8" data-line-number="8"><span class="st">                       union select &#39;film_category&#39; tbl_name,count(*) from film_category</span></a>
<a class="sourceLine" id="cb501-9" data-line-number="9"><span class="st">                       union select &#39;language&#39; tbl_name,count(*) from language</span></a>
<a class="sourceLine" id="cb501-10" data-line-number="10"><span class="st">                       union select &#39;inventory&#39; tbl_name,count(*) from inventory</span></a>
<a class="sourceLine" id="cb501-11" data-line-number="11"><span class="st">                       union select &#39;rental&#39; tbl_name,count(*) from rental</span></a>
<a class="sourceLine" id="cb501-12" data-line-number="12"><span class="st">                       union select &#39;payment&#39; tbl_name,count(*) from payment</span></a>
<a class="sourceLine" id="cb501-13" data-line-number="13"><span class="st">                       union select &#39;staff&#39; tbl_name,count(*) from staff</span></a>
<a class="sourceLine" id="cb501-14" data-line-number="14"><span class="st">                       union select &#39;customer&#39; tbl_name,count(*) from customer</span></a>
<a class="sourceLine" id="cb501-15" data-line-number="15"><span class="st">                       union select &#39;address&#39; tbl_name,count(*) from address</span></a>
<a class="sourceLine" id="cb501-16" data-line-number="16"><span class="st">                       union select &#39;city&#39; tbl_name,count(*) from city</span></a>
<a class="sourceLine" id="cb501-17" data-line-number="17"><span class="st">                       union select &#39;country&#39; tbl_name,count(*) from country</span></a>
<a class="sourceLine" id="cb501-18" data-line-number="18"><span class="st">                       union select &#39;store&#39; tbl_name,count(*) from store</span></a>
<a class="sourceLine" id="cb501-19" data-line-number="19"><span class="st">                       ) counts</span></a>
<a class="sourceLine" id="cb501-20" data-line-number="20"><span class="st">                  order by tbl_name</span></a>
<a class="sourceLine" id="cb501-21" data-line-number="21"><span class="st">                 ;</span></a>
<a class="sourceLine" id="cb501-22" data-line-number="22"><span class="st">                &quot;</span></a>
<a class="sourceLine" id="cb501-23" data-line-number="23">)</a>
<a class="sourceLine" id="cb501-24" data-line-number="24"><span class="kw">sp_print_df</span>(table_rows_sql)</a></code></pre></div>
<div id="htmlwidget-1d9f9b9fdca3023baa83" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1d9f9b9fdca3023baa83">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15"],["actor","address","category","city","country","customer","film","film_actor","film_category","inventory","language","payment","rental","staff","store"],[200,603,16,600,109,604,1001,5462,1002,4583,6,14596,16045,2,3]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>tbl_name<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":2},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div id="replicate-the-output-above-using-dplyr-syntax.-31" class="section level4">
<h4><span class="header-section-number">24.1.0.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb502"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb502-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb502-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb502-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb502-4" data-line-number="4"></a>
<a class="sourceLine" id="cb502-5" data-line-number="5">table_rows_dplyr &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb502-6" data-line-number="6"><span class="st">  </span><span class="kw">as.data.frame</span>(actor_table <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="st">&quot;actor&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-7" data-line-number="7"><span class="st">                  </span><span class="kw">summarize</span>(<span class="dt">rows =</span> <span class="kw">n</span>())) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-8" data-line-number="8"><span class="st">  </span><span class="kw">union</span>(<span class="kw">as.data.frame</span>(address_table <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="st">&quot;address&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-9" data-line-number="9"><span class="st">                        </span><span class="kw">summarize</span>(<span class="dt">rows =</span> <span class="kw">n</span>()))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-10" data-line-number="10"><span class="st">  </span><span class="kw">union</span> (<span class="kw">as.data.frame</span>(category_table <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="st">&quot;category&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-11" data-line-number="11"><span class="st">                         </span><span class="kw">summarize</span>(<span class="dt">rows =</span> <span class="kw">n</span>()))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-12" data-line-number="12"><span class="st">  </span><span class="kw">union</span>(<span class="kw">as.data.frame</span>(country_table <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="st">&quot;city&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-13" data-line-number="13"><span class="st">                        </span><span class="kw">summarize</span>(<span class="dt">rows =</span> <span class="kw">n</span>()))) <span class="op">%&gt;%</span><span class="st">    </span></a>
<a class="sourceLine" id="cb502-14" data-line-number="14"><span class="st">  </span><span class="kw">union</span>(<span class="kw">as.data.frame</span>(country_table <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="st">&quot;country&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-15" data-line-number="15"><span class="st">                        </span><span class="kw">summarize</span>(<span class="dt">rows =</span> <span class="kw">n</span>()))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-16" data-line-number="16"><span class="st">  </span><span class="kw">union</span>(<span class="kw">as.data.frame</span>(customer_table <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="st">&quot;customer&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-17" data-line-number="17"><span class="st">                        </span><span class="kw">summarize</span>(<span class="dt">rows =</span> <span class="kw">n</span>()))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-18" data-line-number="18"><span class="st">  </span><span class="kw">union</span>(<span class="kw">as.data.frame</span>(film_table <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="st">&quot;film&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-19" data-line-number="19"><span class="st">                      </span><span class="kw">summarize</span>(<span class="dt">rows =</span> <span class="kw">n</span>()))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-20" data-line-number="20"><span class="st">  </span><span class="kw">union</span>(<span class="kw">as.data.frame</span>(film_actor_table <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="st">&quot;film_actor&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-21" data-line-number="21"><span class="st">                      </span><span class="kw">summarize</span>(<span class="dt">rows =</span> <span class="kw">n</span>()))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-22" data-line-number="22"><span class="st">  </span><span class="kw">union</span>(<span class="kw">as.data.frame</span>(film_category_table <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="st">&quot;film_category&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb502-23" data-line-number="23"><span class="st">                      </span><span class="kw">summarize</span>(<span class="dt">rows =</span> <span class="kw">n</span>()))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-24" data-line-number="24"><span class="st">  </span><span class="kw">union</span>(<span class="kw">as.data.frame</span>(inventory_table <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="st">&quot;inventory&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-25" data-line-number="25"><span class="st">                      </span><span class="kw">summarize</span>(<span class="dt">rows =</span> <span class="kw">n</span>()))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-26" data-line-number="26"><span class="st">  </span><span class="kw">union</span>(<span class="kw">as.data.frame</span>(language_table <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="st">&quot;language&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-27" data-line-number="27"><span class="st">                      </span><span class="kw">summarize</span>(<span class="dt">rows =</span> <span class="kw">n</span>()))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-28" data-line-number="28"><span class="st">  </span><span class="kw">union</span>(<span class="kw">as.data.frame</span>(rental_table <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="st">&quot;rental&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-29" data-line-number="29"><span class="st">                      </span><span class="kw">summarize</span>(<span class="dt">rows =</span> <span class="kw">n</span>()))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-30" data-line-number="30"><span class="st">  </span><span class="kw">union</span>(<span class="kw">as.data.frame</span>(payment_table <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="st">&quot;payment&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-31" data-line-number="31"><span class="st">                      </span><span class="kw">summarize</span>(<span class="dt">rows =</span> <span class="kw">n</span>()))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-32" data-line-number="32"><span class="st">  </span><span class="kw">union</span>(<span class="kw">as.data.frame</span>(staff_table <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="st">&quot;staff&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-33" data-line-number="33"><span class="st">                      </span><span class="kw">summarize</span>(<span class="dt">rows =</span> <span class="kw">n</span>()))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-34" data-line-number="34"><span class="st">  </span><span class="kw">union</span>(<span class="kw">as.data.frame</span>(store_table <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="st">&quot;store&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-35" data-line-number="35"><span class="st">                      </span><span class="kw">summarize</span>(<span class="dt">rows =</span> <span class="kw">n</span>()))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb502-36" data-line-number="36"><span class="st">  </span><span class="kw">arrange</span>(name)</a>
<a class="sourceLine" id="cb502-37" data-line-number="37"></a>
<a class="sourceLine" id="cb502-38" data-line-number="38"><span class="kw">sp_print_df</span>(table_rows_dplyr)</a></code></pre></div>
<div id="htmlwidget-b18b48ec4ad649442f3b" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-b18b48ec4ad649442f3b">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15"],["actor","address","category","city","country","customer","film","film_actor","film_category","inventory","language","payment","rental","staff","store"],[200,603,16,109,109,604,1001,5462,1002,4583,6,14596,16045,2,3]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>name<\/th>\n      <th>rows<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":2},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</div>
<div id="exercises-2" class="section level1">
<h1><span class="header-section-number">25</span> Exercises</h1>
<div id="where-is-the-dvd-rental-business-located-1" class="section level2">
<h2><span class="header-section-number">25.1</span> 1. Where is the DVD Rental Business located?</h2>
<p>To answer this question we look at the <code>store</code>, <code>address</code>, <code>city</code>, and <code>country</code> tables to answer this question.</p>
<div class="sourceCode" id="cb503"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb503-1" data-line-number="1">store_locations_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb503-2" data-line-number="2"><span class="st">&quot;select s.store_id</span></a>
<a class="sourceLine" id="cb503-3" data-line-number="3"><span class="st">       ,a.address</span></a>
<a class="sourceLine" id="cb503-4" data-line-number="4"><span class="st">       ,c.city</span></a>
<a class="sourceLine" id="cb503-5" data-line-number="5"><span class="st">       ,a.district</span></a>
<a class="sourceLine" id="cb503-6" data-line-number="6"><span class="st">       ,a.postal_code</span></a>
<a class="sourceLine" id="cb503-7" data-line-number="7"><span class="st">       ,c2.country</span></a>
<a class="sourceLine" id="cb503-8" data-line-number="8"><span class="st">       ,s.last_update</span></a>
<a class="sourceLine" id="cb503-9" data-line-number="9"><span class="st">   from store s </span></a>
<a class="sourceLine" id="cb503-10" data-line-number="10"><span class="st">         join address a on s.address_id = a.address_id</span></a>
<a class="sourceLine" id="cb503-11" data-line-number="11"><span class="st">         join city c on a.city_id = c.city_id</span></a>
<a class="sourceLine" id="cb503-12" data-line-number="12"><span class="st">         join country c2 on c.country_id = c2.country_id</span></a>
<a class="sourceLine" id="cb503-13" data-line-number="13"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb503-14" data-line-number="14"><span class="kw">sp_print_df</span>(store_locations_sql)</a></code></pre></div>
<div id="htmlwidget-514d280a38cf86ead40b" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-514d280a38cf86ead40b">{"x":{"filter":"none","data":[["1","2","3"],[1,2,10],["47 MySakila Drive","28 MySQL Boulevard","1795 Santiago de Compostela Way"],["Lethbridge","Woodridge","Laredo"],["Alberta","QLD","Texas"],["","","18743"],["Canada","Australia","United States"],["2006-02-15T17:57:12Z","2006-02-15T17:57:12Z","2019-03-04T02:21:54Z"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>store_id<\/th>\n      <th>address<\/th>\n      <th>city<\/th>\n      <th>district<\/th>\n      <th>postal_code<\/th>\n      <th>country<\/th>\n      <th>last_update<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":1},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>Our DVD Rental business is international and operates in three countries, Canada, Austraila, and the United States. Each country has one store.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-32" class="section level4">
<h4><span class="header-section-number">25.1.0.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb504"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb504-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb504-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb504-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb504-4" data-line-number="4"></a>
<a class="sourceLine" id="cb504-5" data-line-number="5">store_locations_dplyr &lt;-<span class="st"> </span>store_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb504-6" data-line-number="6"><span class="st">    </span><span class="kw">inner_join</span>(address_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;address_id&quot;</span> =<span class="st"> &quot;address_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.s&quot;</span>, <span class="st">&quot;.a&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb504-7" data-line-number="7"><span class="st">    </span><span class="kw">inner_join</span>(city_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;city_id&quot;</span> =<span class="st"> &quot;city_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.a&quot;</span>, <span class="st">&quot;.c&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb504-8" data-line-number="8"><span class="st">    </span><span class="kw">inner_join</span>(country_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;country_id&quot;</span> =<span class="st"> &quot;country_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.a&quot;</span>, <span class="st">&quot;.c&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb504-9" data-line-number="9"><span class="st">    </span><span class="kw">select</span> (store_id,address,city,district,postal_code,country,last_update.x) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb504-10" data-line-number="10"><span class="st">  </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb504-11" data-line-number="11"><span class="kw">sp_print_df</span>(store_locations_dplyr)</a></code></pre></div>
<div id="htmlwidget-74434d812ec23342fdce" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-74434d812ec23342fdce">{"x":{"filter":"none","data":[["1","2","3"],[1,2,10],["47 MySakila Drive","28 MySQL Boulevard","1795 Santiago de Compostela Way"],["Lethbridge","Woodridge","Laredo"],["Alberta","QLD","Texas"],["","","18743"],["Canada","Australia","United States"],["2006-02-15T17:57:12Z","2006-02-15T17:57:12Z","2019-03-04T02:21:54Z"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>store_id<\/th>\n      <th>address<\/th>\n      <th>city<\/th>\n      <th>district<\/th>\n      <th>postal_code<\/th>\n      <th>country<\/th>\n      <th>last_update.x<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":1},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="list-each-store-and-the-staff-contact-information-1" class="section level3">
<h3><span class="header-section-number">25.1.1</span> 2. List Each Store and the Staff Contact Information?</h3>
<p>To answer this question we look at the <code>store</code>, <code>staff</code>, <code>address</code>, <code>city</code>, and <code>country</code> tables.</p>
<div class="sourceCode" id="cb505"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb505-1" data-line-number="1">store_employees_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb505-2" data-line-number="2"><span class="st">&quot;select st.store_id</span></a>
<a class="sourceLine" id="cb505-3" data-line-number="3"><span class="st">       ,s.first_name</span></a>
<a class="sourceLine" id="cb505-4" data-line-number="4"><span class="st">       ,s.last_name</span></a>
<a class="sourceLine" id="cb505-5" data-line-number="5"><span class="st">       ,s.email</span></a>
<a class="sourceLine" id="cb505-6" data-line-number="6"><span class="st">       ,a.phone</span></a>
<a class="sourceLine" id="cb505-7" data-line-number="7"><span class="st">       ,a.address</span></a>
<a class="sourceLine" id="cb505-8" data-line-number="8"><span class="st">       ,c.city</span></a>
<a class="sourceLine" id="cb505-9" data-line-number="9"><span class="st">       ,a.district</span></a>
<a class="sourceLine" id="cb505-10" data-line-number="10"><span class="st">       ,a.postal_code</span></a>
<a class="sourceLine" id="cb505-11" data-line-number="11"><span class="st">       ,c2.country</span></a>
<a class="sourceLine" id="cb505-12" data-line-number="12"><span class="st">   from store st left join staff s on st.manager_staff_id = s.staff_id </span></a>
<a class="sourceLine" id="cb505-13" data-line-number="13"><span class="st">         left join address a on s.address_id = a.address_id</span></a>
<a class="sourceLine" id="cb505-14" data-line-number="14"><span class="st">         left join city c on a.city_id = c.city_id</span></a>
<a class="sourceLine" id="cb505-15" data-line-number="15"><span class="st">         left join country c2 on c.country_id = c2.country_id</span></a>
<a class="sourceLine" id="cb505-16" data-line-number="16"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb505-17" data-line-number="17"><span class="kw">sp_print_df</span>(store_employees_sql)</a></code></pre></div>
<div id="htmlwidget-8da54f9f5480ad7c3ec3" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-8da54f9f5480ad7c3ec3">{"x":{"filter":"none","data":[["1","2","3"],[1,2,10],["Mike","Jon",null],["Hillyer","Stephens",null],["Mike.Hillyer@sakilastaff.com","Jon.Stephens@sakilastaff.com",null],["14033335568","6172235589",null],["23 Workhaven Lane","1411 Lillydale Drive",null],["Lethbridge","Woodridge",null],["Alberta","QLD",null],["","",null],["Canada","Australia",null]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>store_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>email<\/th>\n      <th>phone<\/th>\n      <th>address<\/th>\n      <th>city<\/th>\n      <th>district<\/th>\n      <th>postal_code<\/th>\n      <th>country<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":1},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>Our DVD Rental business is international and operates in three countries, Canada, Austraila, and the United States. Each country has one store. The stores in Canada and Austrailia have one employee each, Mike Hillyer and Jon Stephens respectively. The store in the United States has no employees yet.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-33" class="section level4">
<h4><span class="header-section-number">25.1.1.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb506"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb506-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb506-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb506-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb506-4" data-line-number="4"></a>
<a class="sourceLine" id="cb506-5" data-line-number="5">store_employees_dplyr &lt;-<span class="st"> </span>store_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb506-6" data-line-number="6"><span class="st">  </span><span class="kw">left_join</span> (staff_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;manager_staff_id&quot;</span> =<span class="st"> &quot;staff_id&quot;</span>),<span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&#39;sto&#39;</span>,<span class="st">&#39;sta&#39;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb506-7" data-line-number="7"><span class="st">  </span><span class="kw">left_join</span>(address_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;address_id.y&quot;</span> =<span class="st"> &quot;address_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.sta&quot;</span>, <span class="st">&quot;.a&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb506-8" data-line-number="8"><span class="st">  </span><span class="kw">left_join</span>(city_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;city_id&quot;</span> =<span class="st"> &quot;city_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.sta&quot;</span>, <span class="st">&quot;.city&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb506-9" data-line-number="9"><span class="st">  </span><span class="kw">left_join</span>(country_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;country_id&quot;</span> =<span class="st"> &quot;country_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.city&quot;</span>, <span class="st">&quot;.cnt&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb506-10" data-line-number="10"><span class="st">  </span><span class="kw">select</span>(store_id.x,first_name,last_name,email,phone,address,city,district,postal_code,country) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb506-11" data-line-number="11"><span class="st">  </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb506-12" data-line-number="12"></a>
<a class="sourceLine" id="cb506-13" data-line-number="13"><span class="kw">sp_print_df</span>(store_employees_dplyr)</a></code></pre></div>
<div id="htmlwidget-124fb78127817ec02cd9" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-124fb78127817ec02cd9">{"x":{"filter":"none","data":[["1","2","3"],[1,2,10],["Mike","Jon",null],["Hillyer","Stephens",null],["Mike.Hillyer@sakilastaff.com","Jon.Stephens@sakilastaff.com",null],["14033335568","6172235589",null],["23 Workhaven Lane","1411 Lillydale Drive",null],["Lethbridge","Woodridge",null],["Alberta","QLD",null],["","",null],["Canada","Australia",null]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>store_id.x<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>email<\/th>\n      <th>phone<\/th>\n      <th>address<\/th>\n      <th>city<\/th>\n      <th>district<\/th>\n      <th>postal_code<\/th>\n      <th>country<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":1},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="how-many-active-inactive-and-total-customers-does-the-dvd-rental-business-have-1" class="section level3">
<h3><span class="header-section-number">25.1.2</span> 3. How Many Active, Inactive, and Total Customers Does the DVD Rental Business Have?</h3>
<p>To answer this question we look at the <code>customer</code> table. In a previous chapter we observed that there are two columns, <code>activebool</code> and <code>active</code>. We consider <code>active = 1</code> as active.</p>
<div class="sourceCode" id="cb507"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb507-1" data-line-number="1">customer_cnt_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb507-2" data-line-number="2"><span class="st">&quot;SELECT sum(case when active = 1 then 1 else 0 end) active</span></a>
<a class="sourceLine" id="cb507-3" data-line-number="3"><span class="st">       ,sum(case when active = 0 then 1 else 0 end) inactive</span></a>
<a class="sourceLine" id="cb507-4" data-line-number="4"><span class="st">       ,count(*) total</span></a>
<a class="sourceLine" id="cb507-5" data-line-number="5"><span class="st">   from customer</span></a>
<a class="sourceLine" id="cb507-6" data-line-number="6"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb507-7" data-line-number="7"></a>
<a class="sourceLine" id="cb507-8" data-line-number="8"><span class="kw">sp_print_df</span>(customer_cnt_sql)</a></code></pre></div>
<div id="htmlwidget-dd0a51033db44e820d90" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-dd0a51033db44e820d90">{"x":{"filter":"none","data":[["1"],[589],[15],[604]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>active<\/th>\n      <th>inactive<\/th>\n      <th>total<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>
Our DVD Rental business is international and operates in three countries, Canada, Austraila, and the United States. Each country has one store. The stores in Canada and Austrailia have one employee each. The store in the United States has no employees yet.</p>
<p>The business has 604 international customers, 589 are active and 15 inactive.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-34" class="section level4">
<h4><span class="header-section-number">25.1.2.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb508"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb508-1" data-line-number="1">customer_cnt_dplyr &lt;-<span class="st"> </span>customer_table <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb508-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">inactive =</span> <span class="kw">ifelse</span>(active<span class="op">==</span><span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb508-3" data-line-number="3"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">active   =</span> <span class="kw">sum</span>(active)</a>
<a class="sourceLine" id="cb508-4" data-line-number="4">             ,<span class="dt">inactive =</span> <span class="kw">sum</span>(inactive)</a>
<a class="sourceLine" id="cb508-5" data-line-number="5">             ,<span class="dt">total =</span> <span class="kw">n</span>()</a>
<a class="sourceLine" id="cb508-6" data-line-number="6">             ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb508-7" data-line-number="7"><span class="st">  </span><span class="kw">collect</span>()</a></code></pre></div>
<pre><code>## Warning: Missing values are always removed in SQL.
## Use `SUM(x, na.rm = TRUE)` to silence this warning

## Warning: Missing values are always removed in SQL.
## Use `SUM(x, na.rm = TRUE)` to silence this warning</code></pre>
<div class="sourceCode" id="cb510"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb510-1" data-line-number="1"><span class="kw">sp_print_df</span>(customer_cnt_dplyr)</a></code></pre></div>
<div id="htmlwidget-1fe403c81784621152ab" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1fe403c81784621152ab">{"x":{"filter":"none","data":[["1"],[589],[15],[604]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>active<\/th>\n      <th>inactive<\/th>\n      <th>total<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="how-many-and-what-percent-of-customers-are-from-each-country-1" class="section level3">
<h3><span class="header-section-number">25.1.3</span> 4. How Many and What Percent of Customers Are From Each Country?</h3>
<p>To answer this question we look at the <code>customer</code>, <code>address</code>, <code>city</code>, and <code>country</code> tables.</p>
<div class="sourceCode" id="cb511"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb511-1" data-line-number="1">customers_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb511-2" data-line-number="2"><span class="st">&quot;select c.active,country.country,count(*) count</span></a>
<a class="sourceLine" id="cb511-3" data-line-number="3"><span class="st">              ,round(100 * count(*) / sum(count(*)) over(),4) as pct</span></a>
<a class="sourceLine" id="cb511-4" data-line-number="4"><span class="st">         from customer c</span></a>
<a class="sourceLine" id="cb511-5" data-line-number="5"><span class="st">              join address a on c.address_id = a.address_id</span></a>
<a class="sourceLine" id="cb511-6" data-line-number="6"><span class="st">              join city  on a.city_id = city.city_id</span></a>
<a class="sourceLine" id="cb511-7" data-line-number="7"><span class="st">              join country on city.country_id = country.country_id</span></a>
<a class="sourceLine" id="cb511-8" data-line-number="8"><span class="st">         group by c.active,country</span></a>
<a class="sourceLine" id="cb511-9" data-line-number="9"><span class="st">order by count(*) desc</span></a>
<a class="sourceLine" id="cb511-10" data-line-number="10"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb511-11" data-line-number="11"><span class="kw">sp_print_df</span>(customers_sql)</a></code></pre></div>
<div id="htmlwidget-ed78248b32e6634f28e5" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-ed78248b32e6634f28e5">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118"],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,0,0,1,1,0,1,1,1,0,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0],["India","China","United States","Japan","Mexico","Brazil","Russian Federation","Philippines","Indonesia","Turkey","Argentina","Nigeria","South Africa","Taiwan","United Kingdom","Canada","Poland","Germany","Venezuela","Italy","Iran","Ukraine","Colombia","Egypt","Vietnam","Pakistan","Spain","Netherlands","Saudi Arabia","South Korea","Peru","France","Yemen","Malaysia","Morocco","Austria","China","India","Dominican Republic","Chile","United Arab Emirates","Thailand","Algeria","Bangladesh","Israel","Mozambique","Paraguay","Ecuador","Switzerland","Tanzania","Angola","Cambodia","Bolivia","Australia","Romania","Yugoslavia","Bulgaria","Latvia","Oman","Puerto Rico","Congo, The Democratic Republic of the","Kenya","Belarus","Sudan","Cameroon","Kazakstan","Azerbaijan","Myanmar","Greece","French Polynesia","Madagascar","Turkey","Saint Vincent and the Grenadines","Armenia","Gambia","Slovakia","North Korea","Malawi","Sri Lanka","Bahrain","Nauru","Moldova","Finland","Kuwait","Estonia","Hong Kong","Lithuania","Tonga","United Kingdom","Tunisia","American Samoa","Israel","Mexico","Sweden","New Zealand","Iran","Brunei","Greenland","Runion","Virgin Islands, U.S.","Nepal","Zambia","Ethiopia","Hungary","Poland","Chad","French Guiana","Faroe Islands","Turkmenistan","Czech Republic","Anguilla","Iraq","Holy See (Vatican City State)","Senegal","Tuvalu","Liechtenstein","Afghanistan","Russian Federation"],[57,50,36,31,29,28,27,20,14,14,13,13,11,10,8,8,7,7,7,7,7,6,6,6,6,5,5,5,5,5,4,4,4,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[9.4371,8.2781,5.9603,5.1325,4.8013,4.6358,4.4702,3.3113,2.3179,2.3179,2.1523,2.1523,1.8212,1.6556,1.3245,1.3245,1.1589,1.1589,1.1589,1.1589,1.1589,0.9934,0.9934,0.9934,0.9934,0.8278,0.8278,0.8278,0.8278,0.8278,0.6623,0.6623,0.6623,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>active<\/th>\n      <th>country<\/th>\n      <th>count<\/th>\n      <th>pct<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>
Based on the table above, the DVD Rental business has customers in 118 countries. The DVD Rental business cannot have many walk in customers. It may possibly use a mail order distribution model.</p>
<p>For an international company, how are the different currencies converted to a standard currency? Looking at the ERD, there is no currency conversion rate.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-35" class="section level4">
<h4><span class="header-section-number">25.1.3.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb512"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb512-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb512-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb512-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb512-4" data-line-number="4"></a>
<a class="sourceLine" id="cb512-5" data-line-number="5">customers_dplyr &lt;-<span class="st"> </span>customer_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb512-6" data-line-number="6"><span class="st">    </span><span class="kw">inner_join</span>(address_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;address_id&quot;</span> =<span class="st"> &quot;address_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.s&quot;</span>, <span class="st">&quot;.a&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb512-7" data-line-number="7"><span class="st">    </span><span class="kw">inner_join</span>(city_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;city_id&quot;</span> =<span class="st"> &quot;city_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.a&quot;</span>, <span class="st">&quot;.c&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb512-8" data-line-number="8"><span class="st">    </span><span class="kw">inner_join</span>(country_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;country_id&quot;</span> =<span class="st"> &quot;country_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.a&quot;</span>, <span class="st">&quot;.c&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb512-9" data-line-number="9"><span class="st">    </span><span class="kw">group_by</span>(active,country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb512-10" data-line-number="10"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">count=</span><span class="kw">n</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb512-11" data-line-number="11"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">total=</span><span class="kw">cumsum</span>(count)</a>
<a class="sourceLine" id="cb512-12" data-line-number="12">          ,<span class="dt">pct=</span><span class="kw">round</span>(<span class="dv">100</span> <span class="op">*</span><span class="st"> </span>count<span class="op">/</span>total,<span class="dv">4</span>)</a>
<a class="sourceLine" id="cb512-13" data-line-number="13">          ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb512-14" data-line-number="14"><span class="st">    </span><span class="kw">arrange</span>(<span class="kw">desc</span>(count)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb512-15" data-line-number="15"><span class="st">    </span><span class="kw">select</span> (active,country,count,pct) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb512-16" data-line-number="16"><span class="st">  </span><span class="kw">collect</span>()</a></code></pre></div>
<pre><code>## Warning: Windowed expression &#39;sum(&quot;count&quot;)&#39; does not have explicit order.
## Please use arrange() or window_order() to make determinstic.</code></pre>
<div class="sourceCode" id="cb514"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb514-1" data-line-number="1"><span class="kw">sp_print_df</span>(customers_dplyr)</a></code></pre></div>
<div id="htmlwidget-2ae622211a824c064fbd" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-2ae622211a824c064fbd">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118"],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,0,1,1,0,0,0,0,1,1,1,1,1],["India","China","United States","Japan","Mexico","Brazil","Russian Federation","Philippines","Turkey","Indonesia","Argentina","Nigeria","South Africa","Taiwan","Canada","United Kingdom","Iran","Poland","Italy","Germany","Venezuela","Colombia","Ukraine","Egypt","Vietnam","Netherlands","Spain","South Korea","Saudi Arabia","Pakistan","France","Peru","Yemen","India","Switzerland","Malaysia","Dominican Republic","Ecuador","Algeria","Israel","Morocco","Paraguay","Tanzania","Thailand","Mozambique","United Arab Emirates","Austria","Bangladesh","China","Chile","Myanmar","Angola","Australia","Azerbaijan","Belarus","Bolivia","Bulgaria","Cambodia","Cameroon","Congo, The Democratic Republic of the","French Polynesia","Greece","Kazakstan","Kenya","Latvia","Oman","Puerto Rico","Romania","Sudan","Yugoslavia","Moldova","Iraq","Hong Kong","Holy See (Vatican City State)","Nauru","Nepal","Greenland","New Zealand","Gambia","North Korea","Israel","French Guiana","Finland","Faroe Islands","Ethiopia","Estonia","Iran","Hungary","Runion","Czech Republic","Saint Vincent and the Grenadines","Chad","Senegal","Slovakia","Brunei","Bahrain","Armenia","Sri Lanka","Zambia","Sweden","Anguilla","American Samoa","Afghanistan","Virgin Islands, U.S.","Tonga","Tunisia","United Kingdom","Turkmenistan","Tuvalu","Turkey","Russian Federation","Poland","Mexico","Lithuania","Madagascar","Malawi","Liechtenstein","Kuwait"],[57,50,36,31,29,28,27,20,14,14,13,13,11,10,8,8,7,7,7,7,7,6,6,6,6,5,5,5,5,5,4,4,4,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[24.1525,37.3134,6.3269,10.3679,8.4795,43.0769,6.0538,4.914,2.7237,5.6,61.9048,3.4946,2.3656,2.0325,10,1.5009,2.7237,1.6908,2.6119,4.023,1.2153,4.2857,1.1494,3.871,1.0309,1.3966,1.0526,1.0638,1.1062,1.3158,2.454,1.0336,0.6826,42.8571,0.6224,0.9585,2.0548,2.0134,75,1.1494,0.8671,0.7833,0.6061,0.6024,0.8596,0.5714,11.1111,9.0909,100,3.5714,0.5698,28.5714,8.3333,6.8966,5.7143,5.4054,2.9412,2.8571,2.7778,1.4085,1.2048,1.1364,0.6645,0.6601,0.6536,0.5333,0.4808,0.4785,0.4184,0.3401,0.2915,0.3876,0.5587,0.5618,0.2841,0.2833,0.565,0.2786,0.5988,0.2681,11.1111,0.6098,0.6289,0.6329,0.6369,0.641,12.5,25,0.2387,0.6993,0.2237,1.2346,0.2208,0.2203,1.5152,3.3333,4.5455,0.2101,0.1698,0.2088,12.5,20,100,6.6667,0.2004,0.2,7.1429,0.1942,0.1938,7.6923,8.3333,9.0909,10,0.3247,0.3236,0.3226,0.3257,0.3289]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>active<\/th>\n      <th>country<\/th>\n      <th>count<\/th>\n      <th>pct<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="what-countries-constitute-the-top-25-of-the-customer-base-1" class="section level3">
<h3><span class="header-section-number">25.1.4</span> 5 What Countries Constitute the Top 25% of the Customer Base?</h3>
<p>Using the previous code, add two new columns. One column shows a running total and the second column shows a running percentage. Order the data by count then by country.</p>
<p>To answer this question we look at the <code>customer</code>, <code>address</code>, <code>city</code>, and <code>country</code> tables again.</p>
<div class="sourceCode" id="cb515"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb515-1" data-line-number="1">country_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb515-2" data-line-number="2">                            </a>
<a class="sourceLine" id="cb515-3" data-line-number="3"><span class="st">&quot;select active,country,count</span></a>
<a class="sourceLine" id="cb515-4" data-line-number="4"><span class="st">       ,sum(count) over (order by count desc,country rows between unbounded preceding and current row) running_total</span></a>
<a class="sourceLine" id="cb515-5" data-line-number="5"><span class="st">       , pct</span></a>
<a class="sourceLine" id="cb515-6" data-line-number="6"><span class="st">       ,sum(pct) over (order by pct desc,country rows between unbounded preceding and current row) running_pct</span></a>
<a class="sourceLine" id="cb515-7" data-line-number="7"><span class="st">  from (-- Start of inner SQL Block</span></a>
<a class="sourceLine" id="cb515-8" data-line-number="8"><span class="st">        select c.active,country.country,count(*) count</span></a>
<a class="sourceLine" id="cb515-9" data-line-number="9"><span class="st">              ,round(100 * count(*) / sum(count(*)) over(),4) as pct</span></a>
<a class="sourceLine" id="cb515-10" data-line-number="10"><span class="st">         from customer c</span></a>
<a class="sourceLine" id="cb515-11" data-line-number="11"><span class="st">              join address a on c.address_id = a.address_id</span></a>
<a class="sourceLine" id="cb515-12" data-line-number="12"><span class="st">              join city  on a.city_id = city.city_id</span></a>
<a class="sourceLine" id="cb515-13" data-line-number="13"><span class="st">              join country on city.country_id = country.country_id</span></a>
<a class="sourceLine" id="cb515-14" data-line-number="14"><span class="st">         group by c.active,country</span></a>
<a class="sourceLine" id="cb515-15" data-line-number="15"><span class="st">       ) ctry  -- End of inner SQL Block</span></a>
<a class="sourceLine" id="cb515-16" data-line-number="16"><span class="st"> order by count desc,country</span></a>
<a class="sourceLine" id="cb515-17" data-line-number="17"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb515-18" data-line-number="18"><span class="kw">sp_print_df</span>(country_sql)</a></code></pre></div>
<div id="htmlwidget-09904734225327216f09" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-09904734225327216f09">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118"],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,0,1,1,1,1,1,0,1,1,1,1,1,0,1,0,1,1,1,1,1,1,1,0,1,1,0,0,1],["India","China","United States","Japan","Mexico","Brazil","Russian Federation","Philippines","Indonesia","Turkey","Argentina","Nigeria","South Africa","Taiwan","Canada","United Kingdom","Germany","Iran","Italy","Poland","Venezuela","Colombia","Egypt","Ukraine","Vietnam","Netherlands","Pakistan","Saudi Arabia","South Korea","Spain","France","Peru","Yemen","Algeria","Austria","Bangladesh","Chile","China","Dominican Republic","Ecuador","India","Israel","Malaysia","Morocco","Mozambique","Paraguay","Switzerland","Tanzania","Thailand","United Arab Emirates","Angola","Australia","Azerbaijan","Belarus","Bolivia","Bulgaria","Cambodia","Cameroon","Congo, The Democratic Republic of the","French Polynesia","Greece","Kazakstan","Kenya","Latvia","Myanmar","Oman","Puerto Rico","Romania","Sudan","Yugoslavia","Afghanistan","American Samoa","Anguilla","Armenia","Bahrain","Brunei","Chad","Czech Republic","Estonia","Ethiopia","Faroe Islands","Finland","French Guiana","Gambia","Greenland","Holy See (Vatican City State)","Hong Kong","Hungary","Iran","Iraq","Israel","Kuwait","Liechtenstein","Lithuania","Madagascar","Malawi","Mexico","Moldova","Nauru","Nepal","New Zealand","North Korea","Poland","Runion","Russian Federation","Saint Vincent and the Grenadines","Senegal","Slovakia","Sri Lanka","Sweden","Tonga","Tunisia","Turkey","Turkmenistan","Tuvalu","United Kingdom","Virgin Islands, U.S.","Zambia"],[57,50,36,31,29,28,27,20,14,14,13,13,11,10,8,8,7,7,7,7,7,6,6,6,6,5,5,5,5,5,4,4,4,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[57,107,143,174,203,231,258,278,292,306,319,332,343,353,361,369,376,383,390,397,404,410,416,422,428,433,438,443,448,453,457,461,465,468,471,474,477,480,483,486,489,492,495,498,501,504,507,510,513,516,518,520,522,524,526,528,530,532,534,536,538,540,542,544,546,548,550,552,554,556,557,558,559,560,561,562,563,564,565,566,567,568,569,570,571,572,573,574,575,576,577,578,579,580,581,582,583,584,585,586,587,588,589,590,591,592,593,594,595,596,597,598,599,600,601,602,603,604],[9.4371,8.2781,5.9603,5.1325,4.8013,4.6358,4.4702,3.3113,2.3179,2.3179,2.1523,2.1523,1.8212,1.6556,1.3245,1.3245,1.1589,1.1589,1.1589,1.1589,1.1589,0.9934,0.9934,0.9934,0.9934,0.8278,0.8278,0.8278,0.8278,0.8278,0.6623,0.6623,0.6623,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.4967,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.3311,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656,0.1656],[9.4371,17.7152,23.6755,28.808,33.6093,38.2451,42.7153,46.0266,48.3445,50.6624,52.8147,54.967,56.7882,58.4438,59.7683,61.0928,62.2517,63.4106,64.5695,65.7284,66.8873,67.8807,68.8741,69.8675,70.8609,71.6887,72.5165,73.3443,74.1721,74.9999,75.6622,76.3245,76.9868,77.4835,77.9802,78.4769,78.9736,79.4703,79.967,80.4637,80.9604,81.4571,81.9538,82.4505,82.9472,83.4439,83.9406,84.4373,84.934,85.4307,85.7618,86.0929,86.424,86.7551,87.0862,87.4173,87.7484,88.0795,88.4106,88.7417,89.0728,89.4039,89.735,90.0661,90.3972,90.7283,91.0594,91.3905,91.7216,92.0527,92.2183,92.3839,92.5495,92.7151,92.8807,93.0463,93.2119,93.3775,93.5431,93.7087,93.8743,94.0399,94.2055,94.3711,94.5367,94.7023,94.8679,95.0335,95.1991,95.3647,95.5303,95.6959,95.8615,96.0271,96.1927,96.3583,96.5239,96.6895,96.8551,97.0207,97.1863,97.3519,97.5175,97.6831,97.8487,98.0143,98.1799,98.3455,98.5111,98.6767,98.8423,99.0079,99.1735,99.3391,99.5047,99.6703,99.8359,100.0015]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>active<\/th>\n      <th>country<\/th>\n      <th>count<\/th>\n      <th>running_total<\/th>\n      <th>pct<\/th>\n      <th>running_pct<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3,4,5,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>
The top 25% of the customer base are from India, China, the United States, and Japan. The next six countries, the top 10, Mexico, Brazil, Russian Federation, Philipines, Indonesia, and Turkey round out the top 50% of the businesses customer base.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-36" class="section level4">
<h4><span class="header-section-number">25.1.4.1</span> Replicate the output above using dplyr syntax. ??</h4>
<div class="sourceCode" id="cb516"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb516-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb516-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb516-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb516-4" data-line-number="4"></a>
<a class="sourceLine" id="cb516-5" data-line-number="5">country_dplyr &lt;-<span class="st"> </span>customer_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb516-6" data-line-number="6"><span class="st">    </span><span class="kw">inner_join</span>(address_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;address_id&quot;</span> =<span class="st"> &quot;address_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.s&quot;</span>, <span class="st">&quot;.a&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb516-7" data-line-number="7"><span class="st">    </span><span class="kw">inner_join</span>(city_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;city_id&quot;</span> =<span class="st"> &quot;city_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.a&quot;</span>, <span class="st">&quot;.c&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb516-8" data-line-number="8"><span class="st">    </span><span class="kw">inner_join</span>(country_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;country_id&quot;</span> =<span class="st"> &quot;country_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.a&quot;</span>, <span class="st">&quot;.c&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb516-9" data-line-number="9"><span class="st">    </span><span class="kw">group_by</span>(active,country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb516-10" data-line-number="10"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">count=</span><span class="kw">n</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb516-11" data-line-number="11"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">total=</span><span class="kw">cumsum</span>(count)</a>
<a class="sourceLine" id="cb516-12" data-line-number="12">          ,<span class="dt">pct=</span><span class="kw">round</span>(<span class="dv">100</span> <span class="op">*</span><span class="st"> </span>count<span class="op">/</span>total,<span class="dv">4</span>)</a>
<a class="sourceLine" id="cb516-13" data-line-number="13">          ,<span class="dt">csp=</span><span class="dv">1</span></a>
<a class="sourceLine" id="cb516-14" data-line-number="14">          ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb516-15" data-line-number="15"><span class="st">    </span><span class="kw">arrange</span>(<span class="kw">desc</span>(count)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb516-16" data-line-number="16"><span class="st">    </span></a>
<a class="sourceLine" id="cb516-17" data-line-number="17"><span class="st">    </span><span class="kw">group_by</span>(csp) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb516-18" data-line-number="18"><span class="st">    </span></a>
<a class="sourceLine" id="cb516-19" data-line-number="19"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">running_pct=</span><span class="kw">cumsum</span>(pct)</a>
<a class="sourceLine" id="cb516-20" data-line-number="20">          ,<span class="dt">running_total=</span><span class="kw">cumsum</span>(count)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb516-21" data-line-number="21"><span class="st">    </span><span class="kw">select</span> (csp,active,country,count,running_total,pct,running_pct) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb516-22" data-line-number="22"><span class="st">  </span><span class="kw">collect</span>()</a></code></pre></div>
<pre><code>## Warning: Windowed expression &#39;sum(&quot;count&quot;)&#39; does not have explicit order.
## Please use arrange() or window_order() to make determinstic.</code></pre>
<div class="sourceCode" id="cb518"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb518-1" data-line-number="1"><span class="kw">sp_print_df</span>(country_dplyr)</a></code></pre></div>
<div id="htmlwidget-b619f31f38e9f2471fcc" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-b619f31f38e9f2471fcc">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118"],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,0,1,1,0,0,0,0,1,1,1,1,1],["India","China","United States","Japan","Mexico","Brazil","Russian Federation","Philippines","Turkey","Indonesia","Argentina","Nigeria","South Africa","Taiwan","Canada","United Kingdom","Iran","Poland","Italy","Germany","Venezuela","Colombia","Ukraine","Egypt","Vietnam","Netherlands","Spain","South Korea","Saudi Arabia","Pakistan","France","Peru","Yemen","India","Switzerland","Malaysia","Dominican Republic","Ecuador","Algeria","Israel","Morocco","Paraguay","Tanzania","Thailand","Mozambique","United Arab Emirates","Austria","Bangladesh","China","Chile","Myanmar","Angola","Australia","Azerbaijan","Belarus","Bolivia","Bulgaria","Cambodia","Cameroon","Congo, The Democratic Republic of the","French Polynesia","Greece","Kazakstan","Kenya","Latvia","Oman","Puerto Rico","Romania","Sudan","Yugoslavia","Moldova","Iraq","Hong Kong","Holy See (Vatican City State)","Nauru","Nepal","Greenland","New Zealand","Gambia","North Korea","Israel","French Guiana","Finland","Faroe Islands","Ethiopia","Estonia","Iran","Hungary","Runion","Czech Republic","Saint Vincent and the Grenadines","Chad","Senegal","Slovakia","Brunei","Bahrain","Armenia","Sri Lanka","Zambia","Sweden","Anguilla","American Samoa","Afghanistan","Virgin Islands, U.S.","Tonga","Tunisia","United Kingdom","Turkmenistan","Tuvalu","Turkey","Russian Federation","Poland","Mexico","Lithuania","Madagascar","Malawi","Liechtenstein","Kuwait"],[57,50,36,31,29,28,27,20,14,14,13,13,11,10,8,8,7,7,7,7,7,6,6,6,6,5,5,5,5,5,4,4,4,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[57,107,143,174,203,231,258,278,292,306,319,332,343,353,361,369,376,383,390,397,404,410,416,422,428,433,438,443,448,453,457,461,465,468,471,474,477,480,483,486,489,492,495,498,501,504,507,510,513,516,518,520,522,524,526,528,530,532,534,536,538,540,542,544,546,548,550,552,554,556,557,558,559,560,561,562,563,564,565,566,567,568,569,570,571,572,573,574,575,576,577,578,579,580,581,582,583,584,585,586,587,588,589,590,591,592,593,594,595,596,597,598,599,600,601,602,603,604],[24.1525,37.3134,6.3269,10.3679,8.4795,43.0769,6.0538,4.914,2.7237,5.6,61.9048,3.4946,2.3656,2.0325,10,1.5009,2.7237,1.6908,2.6119,4.023,1.2153,4.2857,1.1494,3.871,1.0309,1.3966,1.0526,1.0638,1.1062,1.3158,2.454,1.0336,0.6826,42.8571,0.6224,0.9585,2.0548,2.0134,75,1.1494,0.8671,0.7833,0.6061,0.6024,0.8596,0.5714,11.1111,9.0909,100,3.5714,0.5698,28.5714,8.3333,6.8966,5.7143,5.4054,2.9412,2.8571,2.7778,1.4085,1.2048,1.1364,0.6645,0.6601,0.6536,0.5333,0.4808,0.4785,0.4184,0.3401,0.2915,0.3876,0.5587,0.5618,0.2841,0.2833,0.565,0.2786,0.5988,0.2681,11.1111,0.6098,0.6289,0.6329,0.6369,0.641,12.5,25,0.2387,0.6993,0.2237,1.2346,0.2208,0.2203,1.5152,3.3333,4.5455,0.2101,0.1698,0.2088,12.5,20,100,6.6667,0.2004,0.2,7.1429,0.1942,0.1938,7.6923,8.3333,9.0909,10,0.3247,0.3236,0.3226,0.3257,0.3289],[24.1525,61.4659,67.7928,78.1607,86.6402,129.7171,135.7709,140.6849,143.4086,149.0086,210.9134,214.408,216.7736,218.8061,228.8061,230.307,233.0307,234.7215,237.3334,241.3564,242.5717,246.8574,248.0068,251.8778,252.9087,254.3053,255.3579,256.4217,257.5279,258.8437,261.2977,262.3313,263.0139,305.871,306.4934,307.4519,309.5067,311.5201,386.5201,387.6695,388.5366,389.3199,389.926,390.5284,391.388,391.9594,403.0705,412.1614,512.1614,515.7328,516.3026,544.874,553.2073,560.1039,565.8182,571.2236,574.1648,577.0219,579.7997,581.2082,582.413,583.5494,584.2139,584.874,585.5276,586.0609,586.5417,587.0202,587.4386,587.7787,588.0702,588.4578,589.0165,589.5783,589.8624,590.1457,590.7107,590.9893,591.5881,591.8562,602.9673,603.5771,604.206,604.8389,605.4758,606.1168,618.6168,643.6168,643.8555,644.5548,644.7785,646.0131,646.2339,646.4542,647.9694,651.3027,655.8482,656.0583,656.2281,656.4369,668.9369,688.9369,788.9369,795.6036,795.804,796.004,803.1469,803.3411,803.5349,811.2272,819.5605,828.6514,838.6514,838.9761,839.2997,839.6223,839.948,840.2769]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>csp<\/th>\n      <th>active<\/th>\n      <th>country<\/th>\n      <th>count<\/th>\n      <th>running_total<\/th>\n      <th>pct<\/th>\n      <th>running_pct<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,4,5,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="how-many-customers-are-in-australia-and-canada-1" class="section level3">
<h3><span class="header-section-number">25.1.5</span> 6. How many customers are in Australia and Canada?</h3>
<p>To answer this question we use the results from the previous exercise.</p>
<div class="sourceCode" id="cb519"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb519-1" data-line-number="1">country_au_ca_sql &lt;-<span class="st"> </span>country_sql <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(country <span class="op">==</span><span class="st"> &#39;Australia&#39;</span> <span class="op">|</span><span class="st"> </span>country <span class="op">==</span><span class="st"> &#39;Canada&#39;</span>)</a>
<a class="sourceLine" id="cb519-2" data-line-number="2"><span class="kw">sp_print_df</span>(country_au_ca_sql)</a></code></pre></div>
<div id="htmlwidget-beeafef17c4840807f51" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-beeafef17c4840807f51">{"x":{"filter":"none","data":[["1","2"],[1,1],["Canada","Australia"],[8,2],[361,520],[1.3245,0.3311],[59.7683,86.0929]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>active<\/th>\n      <th>country<\/th>\n      <th>count<\/th>\n      <th>running_total<\/th>\n      <th>pct<\/th>\n      <th>running_pct<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3,4,5,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>There are 10 customers in Austrailia and Canada where the brick and mortar stores are located. The 20 customers are less than 2% of the world wide customer base. </font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-37" class="section level4">
<h4><span class="header-section-number">25.1.5.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb520"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb520-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb520-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb520-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb520-4" data-line-number="4"></a>
<a class="sourceLine" id="cb520-5" data-line-number="5">country_au_ca_dplyr &lt;-<span class="st"> </span>country_dplyr <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(country <span class="op">==</span><span class="st"> &#39;Australia&#39;</span> <span class="op">|</span><span class="st"> </span>country <span class="op">==</span><span class="st"> &#39;Canada&#39;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb520-6" data-line-number="6"><span class="st">  </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb520-7" data-line-number="7"></a>
<a class="sourceLine" id="cb520-8" data-line-number="8"><span class="kw">sp_print_df</span>(country_au_ca_dplyr)</a></code></pre></div>
<div id="htmlwidget-f6a2206cea77e899a1de" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-f6a2206cea77e899a1de">{"x":{"filter":"none","data":[["1","2"],[1,1],[1,1],["Canada","Australia"],[8,2],[361,522],[10,8.3333],[228.8061,553.2073]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>csp<\/th>\n      <th>active<\/th>\n      <th>country<\/th>\n      <th>count<\/th>\n      <th>running_total<\/th>\n      <th>pct<\/th>\n      <th>running_pct<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,4,5,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="how-many-languages-1" class="section level3">
<h3><span class="header-section-number">25.1.6</span> 7. How Many Languages?</h3>
<p>With an international customer base, how many languages does the DVD Rental business distribute DVD’s in.</p>
<p>To answer this question we look at the <code>language</code> table.</p>
<div class="sourceCode" id="cb521"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb521-1" data-line-number="1">languages_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb521-2" data-line-number="2"><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb521-3" data-line-number="3"><span class="st">select * from language</span></a>
<a class="sourceLine" id="cb521-4" data-line-number="4"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb521-5" data-line-number="5"></a>
<a class="sourceLine" id="cb521-6" data-line-number="6"><span class="kw">sp_print_df</span>(languages_sql)</a></code></pre></div>
<div id="htmlwidget-80fb537b5ba0bd90fb93" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-80fb537b5ba0bd90fb93">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],[1,2,3,4,5,6],["English             ","Italian             ","Japanese            ","Mandarin            ","French              ","German              "],["2006-02-15T18:02:19Z","2006-02-15T18:02:19Z","2006-02-15T18:02:19Z","2006-02-15T18:02:19Z","2006-02-15T18:02:19Z","2006-02-15T18:02:19Z"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>language_id<\/th>\n      <th>name<\/th>\n      <th>last_update<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":1},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>DVD’s are distributed in six languages.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-38" class="section level4">
<h4><span class="header-section-number">25.1.6.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb522"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb522-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb522-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb522-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb522-4" data-line-number="4"></a>
<a class="sourceLine" id="cb522-5" data-line-number="5">languages_dplyr &lt;-<span class="st"> </span>language_table <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb522-6" data-line-number="6"><span class="st">  </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb522-7" data-line-number="7"></a>
<a class="sourceLine" id="cb522-8" data-line-number="8"><span class="kw">sp_print_df</span>(languages_dplyr)</a></code></pre></div>
<div id="htmlwidget-703a15d93cfc9aff608e" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-703a15d93cfc9aff608e">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],[1,2,3,4,5,6],["English             ","Italian             ","Japanese            ","Mandarin            ","French              ","German              "],["2006-02-15T18:02:19Z","2006-02-15T18:02:19Z","2006-02-15T18:02:19Z","2006-02-15T18:02:19Z","2006-02-15T18:02:19Z","2006-02-15T18:02:19Z"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>language_id<\/th>\n      <th>name<\/th>\n      <th>last_update<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":1},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="what-is-the-distribution-of-dvds-by-language-1" class="section level3">
<h3><span class="header-section-number">25.1.7</span> 8. What is the distribution of DVD’s by Language</h3>
<p>To answer this question we look at the <code>language</code> and <code>film</code> tables.</p>
<div class="sourceCode" id="cb523"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb523-1" data-line-number="1">language_distribution_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb523-2" data-line-number="2"><span class="st">&#39;</span></a>
<a class="sourceLine" id="cb523-3" data-line-number="3"><span class="st">select l.language_id,name &quot;language&quot;,count(f.film_id)</span></a>
<a class="sourceLine" id="cb523-4" data-line-number="4"><span class="st">  from language l left join film f on l.language_id = f.language_id</span></a>
<a class="sourceLine" id="cb523-5" data-line-number="5"><span class="st">group by l.language_id,name</span></a>
<a class="sourceLine" id="cb523-6" data-line-number="6"><span class="st">order by l.language_id</span></a>
<a class="sourceLine" id="cb523-7" data-line-number="7"><span class="st">&#39;</span>)</a>
<a class="sourceLine" id="cb523-8" data-line-number="8"></a>
<a class="sourceLine" id="cb523-9" data-line-number="9"><span class="kw">sp_print_df</span>(language_distribution_sql)</a></code></pre></div>
<div id="htmlwidget-6d936e3915a36e12cd53" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6d936e3915a36e12cd53">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],[1,2,3,4,5,6],["English             ","Italian             ","Japanese            ","Mandarin            ","French              ","German              "],[1001,0,0,0,0,0]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>language_id<\/th>\n      <th>language<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>This is a surprise. For an international customer base, the entire stock of 1001 DVD’s are in English only.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-39" class="section level4">
<h4><span class="header-section-number">25.1.7.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb524"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb524-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb524-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb524-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb524-4" data-line-number="4"></a>
<a class="sourceLine" id="cb524-5" data-line-number="5">language_distribution_dplyr &lt;-<span class="st"> </span>language_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb524-6" data-line-number="6"><span class="st">    </span><span class="kw">left_join</span>(film_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;language_id&quot;</span> =<span class="st"> &quot;language_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.s&quot;</span>, <span class="st">&quot;.a&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb524-7" data-line-number="7"><span class="st">    </span><span class="kw">group_by</span>(language_id,name) <span class="op">%&gt;%</span><span class="st"> </span>collect <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb524-8" data-line-number="8"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">count =</span> <span class="kw">sum</span>(<span class="op">!</span><span class="kw">is.na</span>(title))) </a>
<a class="sourceLine" id="cb524-9" data-line-number="9"></a>
<a class="sourceLine" id="cb524-10" data-line-number="10"><span class="kw">sp_print_df</span>(language_distribution_dplyr)</a></code></pre></div>
<div id="htmlwidget-c195b56d57c26c8f1d4d" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-c195b56d57c26c8f1d4d">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],[1,2,3,4,5,6],["English             ","Italian             ","Japanese            ","Mandarin            ","French              ","German              "],[1001,0,0,0,0,0]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>language_id<\/th>\n      <th>name<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="what-are-the-number-of-rentals-and-rented-amount-by-store-by-month-1" class="section level3">
<h3><span class="header-section-number">25.1.8</span> 9. What are the number of rentals and rented amount by store, by month?</h3>
<p>To answer this question we look at the <code>rental</code>, <code>inventory</code>, and <code>film</code> tables to answer this question.</p>
<div class="sourceCode" id="cb525"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb525-1" data-line-number="1">store_rentals_by_mth_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb525-2" data-line-number="2"><span class="st">&quot;select *</span></a>
<a class="sourceLine" id="cb525-3" data-line-number="3"><span class="st">       ,sum(rental_amt) over (order by yyyy_mm,store_id rows </span></a>
<a class="sourceLine" id="cb525-4" data-line-number="4"><span class="st">                              between unbounded preceding and current row) running_rental_amt</span></a>
<a class="sourceLine" id="cb525-5" data-line-number="5"><span class="st">   from (select yyyy_mm,store_id,rentals,rental_amt</span></a>
<a class="sourceLine" id="cb525-6" data-line-number="6"><span class="st">               ,sum(rentals) over(partition by yyyy_mm order by store_id) mo_rentals</span></a>
<a class="sourceLine" id="cb525-7" data-line-number="7"><span class="st">               ,sum(rental_amt) over (partition by yyyy_mm order by store_id) mo_rental_amt</span></a>
<a class="sourceLine" id="cb525-8" data-line-number="8"><span class="st">           from (select to_char(rental_date,&#39;yyyy-mm&#39;) yyyy_mm</span></a>
<a class="sourceLine" id="cb525-9" data-line-number="9"><span class="st">                       ,i.store_id,count(*) rentals, sum(f.rental_rate) rental_amt</span></a>
<a class="sourceLine" id="cb525-10" data-line-number="10"><span class="st">                   from rental r join inventory i on r.inventory_id = i.inventory_id </span></a>
<a class="sourceLine" id="cb525-11" data-line-number="11"><span class="st">                        join film f on i.film_id = f.film_id</span></a>
<a class="sourceLine" id="cb525-12" data-line-number="12"><span class="st">                 group by to_char(rental_date,&#39;yyyy-mm&#39;),i.store_id</span></a>
<a class="sourceLine" id="cb525-13" data-line-number="13"><span class="st">                ) as details</span></a>
<a class="sourceLine" id="cb525-14" data-line-number="14"><span class="st">        ) as mo_running</span></a>
<a class="sourceLine" id="cb525-15" data-line-number="15"><span class="st">order by yyyy_mm,store_id</span></a>
<a class="sourceLine" id="cb525-16" data-line-number="16"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb525-17" data-line-number="17"><span class="kw">sp_print_df</span>(store_rentals_by_mth_sql)</a></code></pre></div>
<div id="htmlwidget-7a589913f405d7a14fbe" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-7a589913f405d7a14fbe">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11"],["2005-05","2005-05","2005-06","2005-06","2005-07","2005-07","2005-08","2005-08","2006-02","2006-02","2019-02"],[1,2,1,2,1,2,1,2,1,2,1],[575,581,1121,1190,3334,3375,2801,2885,92,90,1],[1721.25,1667.19,3331.79,3444.1,9914.66,9861.25,8292.99,8464.15,249.08,265.1,4.99],[575,1156,1121,2311,3334,6709,2801,5686,92,182,1],[1721.25,3388.44,3331.79,6775.89,9914.66,19775.91,8292.99,16757.14,249.08,514.18,4.99],[1721.25,3388.44,6720.23,10164.33,20078.99,29940.24,38233.23,46697.38,46946.46,47211.56,47216.55]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>yyyy_mm<\/th>\n      <th>store_id<\/th>\n      <th>rentals<\/th>\n      <th>rental_amt<\/th>\n      <th>mo_rentals<\/th>\n      <th>mo_rental_amt<\/th>\n      <th>running_rental_amt<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4,5,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>The current entry, row 11, is our new rental row we added to show the different joins in a previous chapter.
</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-40" class="section level4">
<h4><span class="header-section-number">25.1.8.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb526"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb526-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb526-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb526-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb526-4" data-line-number="4"></a>
<a class="sourceLine" id="cb526-5" data-line-number="5">store_rentals_by_mth_dplyr &lt;-<span class="st"> </span>rental_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb526-6" data-line-number="6"><span class="st">    </span><span class="kw">inner_join</span>(inventory_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;inventory_id&quot;</span> =<span class="st"> &quot;inventory_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.r&quot;</span>, <span class="st">&quot;.i&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb526-7" data-line-number="7"><span class="st">    </span><span class="kw">inner_join</span>(film_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;film_id&quot;</span> =<span class="st"> &quot;film_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.i&quot;</span>, <span class="st">&quot;.f&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">collect</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb526-8" data-line-number="8"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">YYYY_MM =</span> <span class="kw">format</span>(rental_date,<span class="st">&quot;%Y-%m&quot;</span>)</a>
<a class="sourceLine" id="cb526-9" data-line-number="9">          ,<span class="dt">running_total =</span> <span class="st">&#39;running_total&#39;</span></a>
<a class="sourceLine" id="cb526-10" data-line-number="10">          ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb526-11" data-line-number="11"><span class="st">    </span><span class="kw">group_by</span>(running_total,YYYY_MM,store_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb526-12" data-line-number="12"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">rentals =</span> <span class="kw">n</span>()</a>
<a class="sourceLine" id="cb526-13" data-line-number="13">             ,<span class="dt">rental_amt =</span> <span class="kw">sum</span>(rental_rate)</a>
<a class="sourceLine" id="cb526-14" data-line-number="14">             ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb526-15" data-line-number="15"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">mo_rentals=</span><span class="kw">order_by</span>(store_id,<span class="kw">cumsum</span>(rentals))</a>
<a class="sourceLine" id="cb526-16" data-line-number="16">          ,<span class="dt">mo_rental_amt=</span><span class="kw">order_by</span>(store_id,<span class="kw">cumsum</span>(rental_amt))</a>
<a class="sourceLine" id="cb526-17" data-line-number="17">          ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb526-18" data-line-number="18"><span class="st">    </span><span class="kw">group_by</span>(running_total) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">running_rental_amt =</span> <span class="kw">cumsum</span>(rental_amt)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb526-19" data-line-number="19"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>running_total)</a>
<a class="sourceLine" id="cb526-20" data-line-number="20">  </a>
<a class="sourceLine" id="cb526-21" data-line-number="21">    </a>
<a class="sourceLine" id="cb526-22" data-line-number="22"><span class="kw">sp_print_df</span>(store_rentals_by_mth_dplyr)</a></code></pre></div>
<div id="htmlwidget-a3fe20e2cfd2d5bbfba3" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-a3fe20e2cfd2d5bbfba3">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11"],["2005-05","2005-05","2005-06","2005-06","2005-07","2005-07","2005-08","2005-08","2006-02","2006-02","2019-02"],[1,2,1,2,1,2,1,2,1,2,1],[575,581,1121,1190,3334,3375,2801,2885,92,90,1],[1721.25,1667.19,3331.79,3444.1,9914.66,9861.25,8292.99,8464.15,249.08,265.1,4.99],[575,1156,1121,2311,3334,6709,2801,5686,92,182,1],[1721.25,3388.44,3331.79,6775.89,9914.66,19775.91,8292.99,16757.14,249.08,514.18,4.99],[1721.25,3388.44,6720.23,10164.33,20078.99,29940.24,38233.23,46697.38,46946.46,47211.56,47216.55]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>YYYY_MM<\/th>\n      <th>store_id<\/th>\n      <th>rentals<\/th>\n      <th>rental_amt<\/th>\n      <th>mo_rentals<\/th>\n      <th>mo_rental_amt<\/th>\n      <th>running_rental_amt<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4,5,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="rank-films-based-on-the-number-of-times-rented-and-associated-revenue-1" class="section level3">
<h3><span class="header-section-number">25.1.9</span> 10. Rank Films Based on the Number of Times Rented and Associated Revenue</h3>
<p>To answer this question we look at the <code>rental</code>, <code>inventory</code>, and <code>film</code> tables.</p>
<div class="sourceCode" id="cb527"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb527-1" data-line-number="1">film_rank_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb527-2" data-line-number="2"><span class="st">&quot;select f.film_id,f.title,f.rental_rate,count(*) count,f.rental_rate * count(*) rental_amt</span></a>
<a class="sourceLine" id="cb527-3" data-line-number="3"><span class="st">   from rental r join inventory i on r.inventory_id = i.inventory_id </span></a>
<a class="sourceLine" id="cb527-4" data-line-number="4"><span class="st">        join film f on i.film_id = f.film_id</span></a>
<a class="sourceLine" id="cb527-5" data-line-number="5"><span class="st"> group by f.film_id,f.title,f.rental_rate</span></a>
<a class="sourceLine" id="cb527-6" data-line-number="6"><span class="st"> order by count(*) desc&quot;</span>)</a>
<a class="sourceLine" id="cb527-7" data-line-number="7">  </a>
<a class="sourceLine" id="cb527-8" data-line-number="8"><span class="kw">sp_print_df</span>(film_rank_sql)</a></code></pre></div>
<div id="htmlwidget-a98751c486bb4e6734fc" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-a98751c486bb4e6734fc">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118","119","120","121","122","123","124","125","126","127","128","129","130","131","132","133","134","135","136","137","138","139","140","141","142","143","144","145","146","147","148","149","150","151","152","153","154","155","156","157","158","159","160","161","162","163","164","165","166","167","168","169","170","171","172","173","174","175","176","177","178","179","180","181","182","183","184","185","186","187","188","189","190","191","192","193","194","195","196","197","198","199","200","201","202","203","204","205","206","207","208","209","210","211","212","213","214","215","216","217","218","219","220","221","222","223","224","225","226","227","228","229","230","231","232","233","234","235","236","237","238","239","240","241","242","243","244","245","246","247","248","249","250","251","252","253","254","255","256","257","258","259","260","261","262","263","264","265","266","267","268","269","270","271","272","273","274","275","276","277","278","279","280","281","282","283","284","285","286","287","288","289","290","291","292","293","294","295","296","297","298","299","300","301","302","303","304","305","306","307","308","309","310","311","312","313","314","315","316","317","318","319","320","321","322","323","324","325","326","327","328","329","330","331","332","333","334","335","336","337","338","339","340","341","342","343","344","345","346","347","348","349","350","351","352","353","354","355","356","357","358","359","360","361","362","363","364","365","366","367","368","369","370","371","372","373","374","375","376","377","378","379","380","381","382","383","384","385","386","387","388","389","390","391","392","393","394","395","396","397","398","399","400","401","402","403","404","405","406","407","408","409","410","411","412","413","414","415","416","417","418","419","420","421","422","423","424","425","426","427","428","429","430","431","432","433","434","435","436","437","438","439","440","441","442","443","444","445","446","447","448","449","450","451","452","453","454","455","456","457","458","459","460","461","462","463","464","465","466","467","468","469","470","471","472","473","474","475","476","477","478","479","480","481","482","483","484","485","486","487","488","489","490","491","492","493","494","495","496","497","498","499","500","501","502","503","504","505","506","507","508","509","510","511","512","513","514","515","516","517","518","519","520","521","522","523","524","525","526","527","528","529","530","531","532","533","534","535","536","537","538","539","540","541","542","543","544","545","546","547","548","549","550","551","552","553","554","555","556","557","558","559","560","561","562","563","564","565","566","567","568","569","570","571","572","573","574","575","576","577","578","579","580","581","582","583","584","585","586","587","588","589","590","591","592","593","594","595","596","597","598","599","600","601","602","603","604","605","606","607","608","609","610","611","612","613","614","615","616","617","618","619","620","621","622","623","624","625","626","627","628","629","630","631","632","633","634","635","636","637","638","639","640","641","642","643","644","645","646","647","648","649","650","651","652","653","654","655","656","657","658","659","660","661","662","663","664","665","666","667","668","669","670","671","672","673","674","675","676","677","678","679","680","681","682","683","684","685","686","687","688","689","690","691","692","693","694","695","696","697","698","699","700","701","702","703","704","705","706","707","708","709","710","711","712","713","714","715","716","717","718","719","720","721","722","723","724","725","726","727","728","729","730","731","732","733","734","735","736","737","738","739","740","741","742","743","744","745","746","747","748","749","750","751","752","753","754","755","756","757","758","759","760","761","762","763","764","765","766","767","768","769","770","771","772","773","774","775","776","777","778","779","780","781","782","783","784","785","786","787","788","789","790","791","792","793","794","795","796","797","798","799","800","801","802","803","804","805","806","807","808","809","810","811","812","813","814","815","816","817","818","819","820","821","822","823","824","825","826","827","828","829","830","831","832","833","834","835","836","837","838","839","840","841","842","843","844","845","846","847","848","849","850","851","852","853","854","855","856","857","858","859","860","861","862","863","864","865","866","867","868","869","870","871","872","873","874","875","876","877","878","879","880","881","882","883","884","885","886","887","888","889","890","891","892","893","894","895","896","897","898","899","900","901","902","903","904","905","906","907","908","909","910","911","912","913","914","915","916","917","918","919","920","921","922","923","924","925","926","927","928","929","930","931","932","933","934","935","936","937","938","939","940","941","942","943","944","945","946","947","948","949","950","951","952","953","954","955","956","957","958","959"],[103,738,382,331,730,489,767,1000,621,369,418,753,31,891,735,973,563,109,748,239,869,979,559,789,609,450,285,127,403,374,702,341,220,945,86,174,301,873,941,875,361,849,595,73,284,893,378,358,295,395,356,305,951,745,764,159,911,850,625,638,715,521,200,698,603,367,958,135,835,206,525,468,330,78,697,879,114,897,434,228,531,244,870,349,445,181,303,471,687,460,391,773,938,890,970,554,234,901,838,670,12,101,263,397,572,307,167,683,880,856,895,309,266,624,162,555,791,288,387,760,571,247,786,273,172,989,863,545,55,417,245,644,319,902,154,586,741,775,476,11,649,810,304,45,366,91,865,35,966,119,131,790,447,527,253,650,804,641,502,43,551,852,433,130,491,443,388,166,914,676,816,494,122,117,320,270,646,961,645,327,412,771,843,857,1,504,10,191,982,614,51,995,271,334,915,199,353,976,608,437,665,759,4,892,26,376,518,322,556,706,79,54,823,267,428,18,772,143,814,61,59,15,500,949,314,972,300,21,575,782,408,415,176,985,651,898,142,406,25,800,444,89,252,930,317,67,23,6,981,677,242,149,280,755,602,776,37,132,377,922,164,514,637,846,129,49,807,218,861,596,112,681,841,22,313,235,19,57,83,274,833,806,953,416,69,727,354,193,100,39,138,292,920,255,249,484,414,326,439,140,462,139,628,231,647,363,204,851,906,720,680,805,486,535,409,993,707,147,728,778,845,578,694,465,350,733,590,562,402,467,668,723,496,743,99,501,827,579,345,663,160,344,747,222,115,97,948,690,118,479,734,436,710,48,298,785,233,243,370,396,72,725,158,580,912,282,269,631,457,281,302,864,887,227,311,619,451,560,818,610,616,150,429,812,17,212,967,768,90,461,688,184,871,456,385,329,724,746,524,383,56,8,254,936,432,121,986,777,346,286,215,463,689,473,657,474,251,971,583,155,77,709,410,924,116,294,877,299,169,561,999,95,944,574,854,333,611,448,70,925,308,643,183,424,763,265,717,506,626,512,510,744,803,964,623,737,175,878,348,534,488,398,693,464,58,481,336,275,672,483,380,691,324,552,859,739,855,716,427,105,85,708,679,458,480,526,606,226,600,975,351,678,111,373,797,50,141,956,123,862,963,42,969,179,601,908,44,696,165,704,189,809,757,666,686,927,392,186,980,570,170,260,203,749,937,664,991,40,987,598,152,84,442,68,858,655,137,529,505,421,618,634,942,272,542,544,201,844,438,446,932,907,588,28,236,770,654,287,796,732,795,872,420,792,896,7,820,988,830,110,589,557,452,229,232,788,532,615,592,962,453,648,658,478,347,216,913,599,784,219,381,455,900,241,756,916,629,536,847,360,946,81,493,921,793,774,652,620,992,894,205,673,783,426,277,832,667,840,379,365,24,173,546,16,394,968,190,882,296,929,133,290,661,27,65,328,917,617,765,34,842,604,63,423,440,96,711,98,487,577,511,71,593,762,449,209,639,736,153,660,293,828,321,573,258,145,829,705,177,151,202,568,213,867,597,134,994,540,430,207,585,798,291,931,766,9,881,794,93,533,413,813,80,113,5,3,567,919,564,519,977,538,821,957,928,88,315,825,389,576,194,682,323,581,933,627,306,250,722,831,918,848,283,210,509,888,257,700,587,187,640,886,899,633,729,469,342,761,46,74,549,819,92,530,104,853,889,692,75,337,64,905,352,60,731,726,368,422,960,375,82,613,157,537,636,740,477,868,811,662,339,528,780,393,312,29,750,508,539,952,553,276,482,20,543,279,246,630,66,837,834,522,126,240,632,188,826,120,214,565,582,591,435,355,264,492,815,503,934,983,685,230,466,338,516,256,984,515,13,940,425,824,211,208,998,30,390,454,76,357,714,550,978,721,499,594,223,364,817,136,926,866,787,923,566,659,401,146,674,751,758,719,124,52,718,47,822,990,548,490,384,523,431,163,752,876,703,371,656,225,939,197,569,513,278,268,839,407,156,622,161,996,947,238,836,547,237,910,196,53,411,248,316,182,605,2,684,520,470,185,289,695,935,178,261,517,653,779,541,106,399,262,224,754,883,799,340,769,997,635,498,808,125,372,168,507,475,959,259,62,32,297,974,472,885,102,405,884,485,965,675,310,612,107,362,343,180,903,441,459,335,94,781,558,699,904,400,584,1001],["Bucket Brotherhood","Rocketeer Mother","Grit Clockwork","Forward Temple","Ridgemont Submarine","Juggler Hardly","Scalawag Duck","Zorro Ark","Network Peak","Goodfellas Salute","Hobbit Alien","Rush Goodfellas","Apache Divine","Timberland Sky","Robbers Joon","Wife Turn","Massacre Usual","Butterfly Chocolat","Rugrats Shakespeare","Dogma Family","Suspects Quills","Witches Panic","Married Go","Shock Cabin","Muscle Bright","Idols Snatchers","English Bulworth","Cat Coneheads","Harry Idaho","Graffiti Love","Pulp Beverly","Frost Head","Deer Virginian","Virginian Pluto","Boogie Amelie","Confidential Interview","Family Sweet","Sweethearts Suspects","Videotape Arsenic","Talented Homicide","Gleaming Jawbreaker","Storm Happiness","Moon Bunch","Bingo Talented","Enemy Odds","Titans Jerk","Greatest North","Gilmore Boiled","Expendable Stallion","Handicap Boondock","Giant Troopers","Fatal Haunted","Voyage Legally","Roses Treasure","Saturday Lambs","Closer Bang","Trip Newton","Story Side","None Spiking","Operation Operation","Range Moonwalker","Lies Treatment","Curtain Videotape","Princess Giant","Movie Shakespeare","Goldmine Tycoon","Wardrobe Phantom","Chance Resurrection","Spy Mile","Dancing Fever","Loathing Legally","Invasion Cyclone","Forrester Comancheros","Blackout Private","Primary Glass","Telegraph Voyage","Camelot Vacation","Torque Bound","Horror Reign","Detective Vision","Lose Inch","Dorado Notting","Swarm Gold","Gangs Pride","Hyde Doctor","Contact Anonymous","Fantasy Troopers","Island Exorcist","Pocus Pulp","Innocent Usual","Half Outfield","Seabiscuit Punk","Velvet Terminator","Tights Dawn","Westward Seabiscuit","Malkovich Pet","Disturbing Scarface","Tracy Cider","Stagecoach Armageddon","Pelican Comforts","Alaska Phantom","Brotherhood Blanket","Durham Panky","Hanky October","Metropolis Coma","Fellowship Autumn","Coma Head","Pity Bound","Telemark Heartbreakers","Streetcar Intentions","Tomorrow Hustler","Feud Frogmen","Dynamite Tarzan","Nightmare Chill","Clueless Bucket","Mallrats United","Show Lord","Escape Metropolis","Gun Bonnie","Samurai Lion","Metal Armageddon","Downhill Enough","Shepherd Midsummer","Effect Gladiator","Coneheads Smoochy","Working Microcosmos","Sun Confessions","Madness Attacks","Barbarella Streetcar","Hills Neighbors","Double Wrath","Oscar Gold","Fish Opus","Trading Pinocchio","Clash Freddy","Mockingbird Hollywood","Roman Punk","Seattle Expecations","Jason Trap","Alamo Videotape","Oz Liaisons","Slums Duck","Fargo Gandhi","Attraction Newton","Goldfinger Sensibility","Bound Cheaper","Sunrise League","Arachnophobia Rollercoaster","Wedding Apollo","Caper Motions","Center Dinosaur","Shootist Superfly","Ice Crossing","Lola Agent","Drifter Commandments","Pacific Amistad","Sleeping Suspects","Orange Grapes","Knock Warlock","Atlantis Cause","Maiden Home","Strangelove Desire","Horn Working","Celebrity Horn","Jumping Wrath","Hurricane Affair","Gunfight Moon","Color Philadelphia","Trouble Date","Philadelphia Wife","Snowman Rollercoaster","Karate Moon","Carrie Bunch","Candles Grapes","Flamingos Connecticut","Earth Vision","Outbreak Divine","Wash Heavenly","Others Soup","Fool Mockingbird","Heavyweights Beast","Scorpion Apollo","Steel Santa","Strictly Scarface","Academy Dinosaur","Kwai Homeward","Aladdin Calendar","Crooked Frogmen","Women Dorado","Name Detective","Balloon Homeward","Yentl Idaho","Easy Gladiator","Freddy Storm","Truman Crazy","Cupboard Sinners","Gentlemen Stage","Wind Phantom","Murder Antitrust","House Dynamite","Patton Interview","Salute Apollo","Affair Prejudice","Titanic Boondock","Annie Identity","Grapes Fury","Liaisons Sweet","Flatliners Killer","Maltese Hope","Queen Luke","Blade Polish","Banger Pinocchio","South Wait","Eagles Panky","Homicide Peach","Alter Victory","Sea Virgin","Chill Luck","Snatch Slipper","Beauty Grease","Bear Graceland","Alien Center","Kiss Glory","Volcano Texas","Fight Jawbreaker","Whisperer Giant","Falcon Volume","American Circus","Midsummer Groundhog","Shakespeare Saddle","Head Stranger","High Encino","Congeniality Quest","Wonderland Christmas","Packer Madigan","Tourist Pelican","Chicken Hellfighters","Haunting Pianist","Angels Life","Sinners Atlantis","Hustler Party","Borrowers Bedazzled","Dream Pickup","Vacation Boondock","Fireball Philadelphia","Berets Agent","Anaconda Confessions","Agent Truman","Wolves Desire","Pianist Outfield","Doom Dancing","Christmas Moonshine","Empire Malkovich","Sabrina Midnight","Mourning Purple","Secret Groundhog","Arizona Bang","Chainsaw Uptown","Grease Youth","Undefeated Dalmations","Coast Rainbow","Lebowski Soldiers","Open African","Sting Personal","Cause Date","Badman Dawn","Sleuth Orient","Deceiver Betrayed","Suit Walls","Moonshine Cabin","Calendar Gunfight","Pirates Roxanne","Star Operation","Amistad Midsummer","Fidelity Devil","Divide Monster","Amadeus Holy","Basic Easy","Blues Instinct","Egg Igby","Splendor Patton","Sleepy Japanese","Wait Cider","Highball Potter","Beverly Outlaw","Resurrection Silverado","Ghost Groundhog","Crossroads Casualties","Brooklyn Desert","Armageddon Lost","Chariots Conspiracy","Excitement Eve","Unbreakable Karate","Driving Polish","Dracula Crystal","Jerk Paycheck","Hellfighters Sierra","Flying Hook","Hunchback Impossible","Cheaper Clyde","Insider Arizona","Chasing Fight","Northwest Polish","Dinosaur Secretary","Outfield Massacre","Go Purple","Dalmations Sweden","Straight Hours","Tramp Others","Redemption Comforts","Pinocchio Simon","Sleepless Monsoon","Jet Neighbors","Love Suicides","Heartbreakers Bright","Wrong Behavior","Quest Mussolini","Chocolat Harry","Reunion Witches","Secrets Paradise","Stepmom Dream","Million Ace","Prejudice Oleander","Interview Liaisons","Garden Island","River Outlaw","Money Harold","Masked Bubble","Harper Dying","Intrigue Worst","Peak Forever","Reign Gentlemen","Kick Savannah","Room Roman","Bringing Hysterical","Kissing Dolls","Spice Sorority","Minds Truman","Gables Metropolis","Patient Sister","Club Graffiti","Fury Murder","Roxanne Rebel","Desert Poseidon","Campus Remember","Bride Intrigue","Voice Peach","Pond Seattle","Canyon Stock","Jedi Beneath","Road Roxanne","Hours Rage","Rage Games","Backlash Undefeated","Eyes Driving","Shawshank Bubble","Disciple Mother","Doors President","Gorgeous Bingo","Hanging Deep","Bill Others","Requiem Tycoon","Clones Pinocchio","Mine Titans","Trojan Tomorrow","Encounters Curtain","Earring Instinct","Novocaine Flight","Independence Hotel","Encino Elf","Fantasia Park","Sundance Invasion","Thief Pelican","Details Packer","Fiction Christmas","Neighbors Charade","Igby Maker","Mars Roman","Something Duck","Music Boondock","National Story","Cider Desire","Honey Ties","Smoking Barbarella","Alone Trip","Darn Forrester","Weekend Personal","Scarface Bang","Boulevard Mob","Insects Stone","Polish Brooklyn","Core Suit","Sweden Shining","Inch Jet","Groundhog Uncut","Forrest Sons","Remember Diary","Rouge Squad","Lion Uncut","Groove Fiction","Barefoot Manchurian","Airport Pollock","Driver Annie","Vanishing Rocky","Hope Tootsie","Carol Texas","Wonka Sea","Secretary Rouge","Galaxy Sweethearts","Enough Raging","Dawn Pond","Instinct Airport","Pollock Deliverance","Jacket Frisco","Paradise Sabrina","Jade Bunch","Dragonfly Strangers","Whale Bikini","Mission Zoolander","Cleopatra Devil","Birds Perdition","Racer Egg","Heaven Freedom","Unforgiven Zoolander","Candidate Perdition","Expecations Natural","Taxi Kick","Factory Dragon","Comforts Rush","Mask Peach","Zoolander Fiction","Breakfast Goldfinger","Virgin Daisy","Midnight Westward","Strangers Graffiti","Freaky Pocus","Musketeers Wait","Idaho Love","Bikini Borrowers","United Pilot","Ferris Mother","Orient Closer","Conversation Downhill","Holocaust Highball","Satisfaction Confidential","Dying Maker","Rear Trading","Lady Stage","Noon Papi","League Hellfighters","Lawless Vision","Roots Remember","Slacker Liaisons","Waterfront Deliverance","Newton Labyrinth","Rock Instinct","Confused Candles","Teen Apollo","Gandhi Kwai","Louisiana Harry","Joon Northwest","Hanover Galaxy","Potter Connecticut","Intentions Empire","Beach Heartbreakers","Jekyll Frogmen","French Holiday","Egypt Tenenbaums","Perfect Groove","Jericho Mulan","Greek Everyone","Poseidon Forever","Flintstones Happiness","Majestic Floats","Sugar Wonka","Rocky War","Streak Ridgemont","Reap Unfaithful","Homeward Cider","Bull Shawshank","Bonnie Holocaust","Quills Bull","Pilot Hoosiers","Indian Love","Jeepers Wedding","Lock Rear","Mummy Creatures","Destiny Saturday","Motions Details","Willow Tracy","Gaslight Crusade","Pickup Driving","Caddyshack Jedi","Graduate Lord","Silence Kane","Baked Cleopatra","Chicago North","Wanda Chamber","Casablanca Super","Summer Scarface","Watch Tracy","Artist Coldblooded","West Lion","Conquerer Nuts","Moulin Wake","Trap Guys","Attacks Hate","Pride Alamo","Coldblooded Darling","Pure Runner","Creatures Shakespeare","Slipper Fidelity","Sagebrush Clueless","Paycheck Wait","Pluto Oleander","Uprising Uptown","Hall Cassidy","Craft Outfield","Wizard Coldblooded","Mermaid Insects","Command Darling","Dude Blindness","Daisy Menagerie","Rules Human","Varsity Trip","Patriot Roman","Worst Banger","Army Flintstones","Words Hunter","Mosquito Armageddon","Circus Youth","Boiled Dares","Hunting Musketeers","Betrayed Rear","Submarine Bed","Panther Reds","Charade Duffel","Lonely Elephant","Labyrinth League","Holiday Games","Necklace Outbreak","Odds Boogie","Vietnam Smoochy","Edge Kissing","Lust Lock","Madison Trap","Cyclone Family","Steers Armageddon","Human Graffiti","Hysterical Grail","Valley Packer","Translation Summer","Model Fish","Anthem Luke","Divine Resurrection","Scissorhands Slums","Panky Submarine","Entrapment Satisfaction","Sierra Divide","Rings Heartbreakers","Siege Madre","Sweet Brotherhood","Holes Brannigan","Shrek License","Tootsie Pilot","Airplane Sierra","Sons Interview","Worker Tarzan","Spirit Flintstones","Cabin Flash","Modern Dorado","Manchurian Curtain","Illusion Amelie","Devil Desire","Dirty Ace","Ship Wonderland","Loser Hustler","Nash Chocolat","Monster Spartacus","Wasteland Divine","Image Princess","Outlaw Hanky","Paris Weekend","Jaws Harry","Games Bowfinger","Day Unfaithful","Troopers Metal","Mother Oleander","Shanghai Tycoon","Deep Crusade","Grinch Massage","Impossible Prejudice","Town Ark","Donnie Alley","Saddle Antitrust","Turn Star","Notorious Reunion","Lovely Jingle","Stock Glass","Glass Dying","Virtual Spoilers","Blindness Gun","Kane Exorcist","Uncut Suicides","Shrunk Divine","Searchers Wait","Pajama Jawbreaker","Nemo Campus","Wrath Mile","Tomatoes Hellfighters","Dances None","Personal Ladybugs","Shane Darkness","Home Pity","Elephant Trojan","Splash Gump","Peach Innocent","Stampede Disturbing","Greedy Roots","Gold River","Analyze Hoosiers","Confessions Maguire","Madre Gables","Alley Evolution","Hamlet Wisdom","Werewolf Lola","Creepers Kane","Tenenbaums Command","Express Lonely","Usual Untouchables","Chamber Italian","Everyone Craft","Past Suicides","Anonymous Human","Behavior Runaway","Forever Candidate","Tuxedo Mile","Natural Stock","Saturn Name","Arabia Dogma","State Wasteland","Mulan Moon","Bedazzled Married","Hollywood Anonymous","Hunger Roof","Breaking Home","Raging Airplane","Bright Encounters","Jingle Sagebrush","Mile Mulan","Lawrence Love","Bilko Anonymous","Monterey Labyrinth","Sassy Packer","Identity Lover","Darkness War","Opposite Necklace","Robbery Bright","Citizen Shrek","Party Knock","Exorcist Sting","Spiking Element","Flash Wars","Microcosmos Paradise","Drums Dynamite","Chisum Behavior","Spinal Rocky","Purple Movie","Connecticut Tramp","Cincinatti Whisperer","Daddy Pittsburgh","Memento Zoolander","Date Speed","Super Wyoming","Moonwalker Fool","Champion Flatliners","Wyoming Storm","Lucky Flying","Hook Chariots","Dangerous Uptown","Mob Duffel","Silverado Goldfinger","Evolution Alter","Valentine Vanishing","Savannah Town","Alabama Devil","Temple Attraction","Side Ark","Brannigan Sunrise","Lost Bird","Hedwig Alter","Smoochy Control","Blanket Beverly","California Birds","African Egg","Adaptation Holes","Meet Chocolate","Tycoon Gathering","Massage Image","Liberty Magnificent","Window Side","Loverboy Attacks","Sorority Queen","War Notting","Uptown Young","Born Spinal","Finding Anaconda","Speakeasy Date","Gunfighter Mussolini","Mighty Luck","Crow Grease","Pittsburgh Hunchback","Flight Lies","Minority Kiss","Vampire Whale","North Tequila","Feathers Metal","Dragon Squad","Reef Salute","Spirited Casualties","Twisted Pirates","Stone Fire","Ending Crowds","Darko Dorado","Language Cowboy","Thin Sagebrush","Drumline Cyclone","Prix Undefeated","Mod Secretary","Cranes Reservoir","Opus Ice","Theory Mermaid","Towers Hurricane","October Submarine","Rider Caddyshack","Iron Moon","Fugitive Maguire","Santa Paris","Autumn Crow","Birch Antitrust","Magnolia Forrester","Song Hedwig","Bowfinger Gables","Lord Arizona","Bugsy Song","Stranger Strangers","Ties Hunger","Potluck Mixed","Bird Independence","Frida Slipper","Beethoven Exorcist","Trainspotting Strangers","Gathering Calendar","Beast Hunchback","Right Cranes","Reservoir Adaptation","Gone Trouble","Hollow Jeopardy","Wars Pluto","Grail Frankenstein","Blood Argonauts","Mystic Truman","Clockwork Paradise","Lover Truman","Oleander Clue","Rollercoaster Bringing","Jawbreaker Brooklyn","Superfly Trip","Smile Earring","Paths Control","Frogmen Breaking","Lolita World","Sensibility Rear","Halloween Nuts","Fiddler Lost","Antitrust Tomatoes","Run Pacific","Lambs Cincinatti","Luck Opus","Wagon Jaws","Maker Gables","Element Freddy","Jeopardy Encino","Amelie Hellfighters","Madigan Dorado","Elizabeth Shane","Doubtfire Labyrinth","Notting Speakeasy","Beneath Rush","Stage World","Spoilers Hellfighters","Life Twisted","Casualties Encino","Dolls Rage","Nuts Ties","Crazy Home","Speed Suit","Caribbean Liberty","Daughter Madigan","Matrix Snowman","Miracle Virtual","Monsoon Cause","Hotel Happiness","Ghostbusters Elf","Dwarfs Alter","Jungle Closer","Snatchers Montezuma","Kramer Chocolate","Vanilla Day","Won Dares","Platoon Instinct","Diary Panic","Intolerable Intentions","Frisco Forrest","Legend Jedi","Drop Waterfront","Wonderful Drop","Legally Secretary","Ali Forever","Victory Academy","Holy Tadpole","Spartacus Cheaper","Darling Breaking","Dares Pluto","Zhivago Core","Anything Savannah","Guys Falcon","Impact Aladdin","Birdcage Casper","Gilbert Pelican","Random Go","Maguire Apache","Wisdom Worker","Reds Pocus","King Evolution","Montezuma Command","Desire Alien","Godfather Diary","Soldiers Evolution","Chaplin License","Untouchables Sunrise","Sunset Racer","Shining Roses","Unfaithful Kill","Maude Mod","Park Citizen","Harold French","Chitty Lock","Pet Haunting","Runaway Tenenbaums","Saints Bride","Records Zorro","Casper Dragonfly","Ballroom Mockingbird","Rebel Airport","Baby Hall","Soup Wisdom","World Leathernecks","Magnificent Chitty","Jumanji Blade","Grosse Wonderful","Lights Deer","Hoosiers Birdcage","Clyde Theory","Runner Madigan","Tarzan Videotape","Punk Divorce","Gosford Donnie","Papi Necklace","Destination Jerk","Vertigo Northwest","Crusade Honey","Menagerie Rushmore","Leathernecks Dwarfs","Elf Murder","Early Home","Stallion Sundance","Hawk Chill","Clerks Angels","Newsies Story","Clue Grail","Young Language","Vision Torque","Doctor Grail","Squad Fish","Magic Mallrats","Divorce Shining","Treatment Jekyll","Cruelty Unforgiven","Bang Kwai","Heavenly Gun","Dozen Lion","Fire Wolves","Control Anthem","Mulholland Beast","Ace Goldfinger","Pizza Jumanji","License Weekend","Ishtar Rocketeer","Cowboy Doom","Eve Resurrection","President Bang","Vanished Garden","Connection Microcosmos","Duffel Apocalypse","Lesson Cleopatra","Panic Club","Sense Greek","Luke Mummy","Bulworth Commandments","Happiness United","Dumbo Lust","Desperate Trainspotting","Rushmore Mermaid","Tequila Past","Simon North","Frontier Cabin","School Jacket","Youth Kick","Oklahoma Jumanji","Killer Innocent","Sling Luke","Cassidy Wyoming","Graceland Dynamite","Comancheros Enemy","Ladybugs Armageddon","Japanese Run","Warlock Werewolf","Duck Racer","Bed Highball","Apocalypse Flamingos","Extraordinary Conquerer","Wild Apollo","Italian African","Texas Watch","Bubble Grosse","Haunted Antitrust","Terminator Club","Jersey Sassy","Watership Frontier","Phantom Glory","Fever Empire","Mussolini Spoilers","Bunch Minds","Glory Tracy","Full Flatliners","Conspiracy Spirit","Traffic Hobbit","Hunter Alter","Informer Double","Freedom Cleopatra","Braveheart Human","Seven Swarm","Mannequin Worst","Private Drop","Train Bunch","Hardly Robbers","Mixed Doors","Sophie's Choice"],[4.99,0.99,0.99,2.99,0.99,0.99,4.99,4.99,2.99,4.99,0.99,0.99,4.99,0.99,2.99,4.99,4.99,0.99,0.99,4.99,2.99,4.99,2.99,2.99,2.99,2.99,0.99,4.99,4.99,0.99,2.99,0.99,2.99,0.99,4.99,4.99,0.99,0.99,4.99,0.99,2.99,0.99,0.99,2.99,4.99,4.99,2.99,0.99,0.99,0.99,2.99,2.99,0.99,4.99,4.99,4.99,4.99,0.99,0.99,2.99,4.99,4.99,0.99,2.99,4.99,0.99,2.99,2.99,2.99,0.99,0.99,2.99,4.99,2.99,0.99,4.99,0.99,4.99,0.99,0.99,0.99,4.99,0.99,2.99,2.99,2.99,0.99,2.99,0.99,4.99,2.99,2.99,4.99,0.99,0.99,2.99,2.99,0.99,4.99,4.99,0.99,0.99,4.99,2.99,2.99,4.99,4.99,4.99,2.99,4.99,2.99,0.99,0.99,4.99,2.99,0.99,4.99,2.99,0.99,2.99,2.99,0.99,0.99,0.99,4.99,4.99,0.99,0.99,2.99,0.99,0.99,2.99,2.99,4.99,2.99,0.99,0.99,4.99,2.99,0.99,2.99,0.99,2.99,4.99,0.99,0.99,4.99,2.99,0.99,0.99,4.99,0.99,2.99,4.99,4.99,0.99,4.99,0.99,2.99,2.99,4.99,0.99,2.99,0.99,0.99,2.99,0.99,2.99,2.99,4.99,0.99,0.99,0.99,4.99,4.99,0.99,0.99,4.99,2.99,4.99,4.99,4.99,4.99,2.99,0.99,0.99,4.99,0.99,0.99,4.99,2.99,4.99,4.99,4.99,4.99,2.99,2.99,0.99,2.99,2.99,2.99,2.99,2.99,4.99,0.99,0.99,4.99,2.99,4.99,4.99,0.99,0.99,2.99,4.99,2.99,0.99,2.99,0.99,4.99,4.99,2.99,2.99,4.99,0.99,0.99,4.99,4.99,4.99,4.99,2.99,4.99,2.99,0.99,4.99,0.99,4.99,0.99,0.99,2.99,2.99,4.99,0.99,2.99,2.99,0.99,2.99,0.99,2.99,0.99,0.99,0.99,0.99,0.99,4.99,0.99,4.99,2.99,0.99,0.99,4.99,0.99,2.99,4.99,4.99,2.99,2.99,0.99,0.99,4.99,4.99,4.99,0.99,2.99,2.99,4.99,2.99,0.99,2.99,2.99,2.99,0.99,2.99,0.99,0.99,2.99,0.99,4.99,2.99,4.99,0.99,2.99,0.99,0.99,4.99,0.99,2.99,2.99,2.99,4.99,0.99,2.99,4.99,2.99,2.99,0.99,0.99,0.99,0.99,0.99,2.99,4.99,4.99,4.99,0.99,4.99,2.99,2.99,0.99,0.99,4.99,4.99,4.99,4.99,4.99,4.99,0.99,2.99,0.99,0.99,0.99,4.99,2.99,0.99,0.99,2.99,4.99,4.99,4.99,0.99,0.99,0.99,0.99,0.99,4.99,2.99,0.99,0.99,2.99,0.99,0.99,4.99,0.99,4.99,4.99,2.99,4.99,0.99,4.99,2.99,4.99,2.99,4.99,2.99,4.99,2.99,0.99,0.99,0.99,0.99,0.99,2.99,0.99,4.99,4.99,0.99,0.99,4.99,0.99,4.99,0.99,2.99,2.99,0.99,0.99,0.99,4.99,2.99,4.99,0.99,0.99,0.99,2.99,4.99,4.99,4.99,2.99,2.99,0.99,0.99,0.99,2.99,4.99,2.99,2.99,2.99,2.99,2.99,4.99,4.99,2.99,4.99,2.99,2.99,2.99,2.99,2.99,4.99,4.99,4.99,0.99,4.99,2.99,2.99,0.99,2.99,4.99,0.99,0.99,2.99,2.99,2.99,4.99,4.99,0.99,4.99,2.99,4.99,2.99,4.99,0.99,2.99,2.99,4.99,0.99,4.99,4.99,0.99,4.99,2.99,4.99,4.99,0.99,4.99,4.99,0.99,0.99,2.99,4.99,0.99,0.99,0.99,4.99,2.99,2.99,2.99,2.99,4.99,0.99,2.99,2.99,2.99,4.99,4.99,0.99,4.99,4.99,0.99,2.99,0.99,0.99,0.99,4.99,2.99,0.99,2.99,2.99,0.99,4.99,0.99,2.99,2.99,2.99,0.99,2.99,0.99,2.99,4.99,4.99,4.99,0.99,0.99,2.99,4.99,4.99,0.99,4.99,4.99,0.99,4.99,2.99,0.99,0.99,2.99,4.99,4.99,2.99,4.99,0.99,4.99,4.99,4.99,4.99,4.99,4.99,2.99,2.99,2.99,0.99,2.99,0.99,2.99,4.99,2.99,4.99,4.99,4.99,2.99,2.99,2.99,4.99,0.99,0.99,0.99,4.99,2.99,2.99,2.99,4.99,2.99,4.99,0.99,0.99,4.99,4.99,2.99,2.99,4.99,0.99,0.99,0.99,0.99,2.99,4.99,2.99,0.99,4.99,2.99,2.99,0.99,0.99,0.99,2.99,0.99,4.99,2.99,2.99,4.99,2.99,2.99,2.99,2.99,4.99,2.99,2.99,4.99,4.99,0.99,0.99,2.99,4.99,4.99,4.99,2.99,0.99,2.99,2.99,0.99,2.99,2.99,0.99,4.99,4.99,0.99,2.99,2.99,2.99,0.99,2.99,0.99,0.99,0.99,0.99,2.99,4.99,4.99,0.99,2.99,0.99,0.99,4.99,2.99,4.99,2.99,2.99,2.99,4.99,4.99,0.99,2.99,4.99,4.99,0.99,4.99,0.99,4.99,2.99,2.99,0.99,4.99,0.99,2.99,0.99,0.99,0.99,0.99,2.99,4.99,4.99,4.99,0.99,0.99,4.99,0.99,0.99,2.99,2.99,4.99,0.99,0.99,2.99,2.99,2.99,4.99,2.99,0.99,4.99,2.99,2.99,4.99,4.99,4.99,4.99,0.99,4.99,4.99,4.99,4.99,2.99,0.99,4.99,0.99,4.99,0.99,0.99,0.99,2.99,4.99,0.99,4.99,2.99,2.99,0.99,2.99,4.99,2.99,2.99,2.99,4.99,2.99,2.99,2.99,0.99,0.99,4.99,2.99,4.99,0.99,2.99,2.99,2.99,0.99,4.99,4.99,0.99,4.99,4.99,0.99,0.99,0.99,0.99,4.99,0.99,0.99,4.99,0.99,4.99,0.99,2.99,4.99,2.99,4.99,0.99,0.99,4.99,2.99,4.99,4.99,2.99,4.99,4.99,0.99,0.99,4.99,2.99,2.99,4.99,4.99,2.99,4.99,2.99,0.99,4.99,0.99,4.99,4.99,2.99,2.99,4.99,2.99,2.99,0.99,0.99,0.99,2.99,0.99,2.99,0.99,0.99,2.99,4.99,0.99,2.99,4.99,2.99,4.99,2.99,0.99,4.99,2.99,2.99,0.99,4.99,0.99,4.99,4.99,4.99,4.99,0.99,0.99,2.99,0.99,2.99,4.99,2.99,4.99,2.99,4.99,4.99,4.99,4.99,2.99,4.99,4.99,0.99,2.99,0.99,2.99,2.99,4.99,2.99,4.99,2.99,4.99,4.99,0.99,4.99,2.99,4.99,4.99,0.99,0.99,4.99,4.99,2.99,0.99,2.99,4.99,0.99,0.99,0.99,2.99,2.99,0.99,4.99,4.99,0.99,2.99,2.99,4.99,2.99,2.99,0.99,0.99,2.99,0.99,4.99,0.99,2.99,0.99,0.99,2.99,4.99,4.99,0.99,0.99,4.99,0.99,0.99,2.99,2.99,4.99,0.99,2.99,0.99,0.99,2.99,4.99,4.99,0.99,0.99,2.99,2.99,2.99,2.99,4.99,4.99,0.99,0.99,4.99,0.99,4.99,0.99,0.99,2.99,2.99,0.99,2.99,0.99,0.99,2.99,4.99,4.99,4.99,4.99,2.99,4.99,2.99,2.99,4.99,2.99,4.99,4.99,0.99,0.99,0.99,0.99,4.99,4.99,2.99,2.99,2.99,0.99,4.99,2.99,4.99,0.99,4.99,4.99,0.99,0.99,2.99,0.99,2.99,4.99,0.99,0.99,0.99,2.99,2.99,2.99,4.99,2.99,0.99,4.99,0.99,4.99,4.99,4.99,4.99,0.99,2.99,4.99,2.99,2.99,2.99,2.99,2.99,4.99,2.99,4.99,0.99,2.99,4.99,2.99,4.99,4.99,2.99,2.99,4.99],[34,33,32,32,32,32,32,31,31,31,31,31,31,31,31,31,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,28,28,28,28,28,28,28,28,28,28,28,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,5,5,5,5,5,5,5,5,5,5,5,5,5,5,4,4,4,1],[169.66,32.67,31.68,95.68,31.68,31.68,159.68,154.69,92.69,154.69,30.69,30.69,154.69,30.69,92.69,154.69,149.7,29.7,29.7,149.7,89.7,149.7,89.7,89.7,89.7,89.7,29.7,149.7,149.7,29.7,89.7,29.7,86.71,28.71,144.71,144.71,28.71,28.71,144.71,28.71,86.71,28.71,28.71,86.71,144.71,144.71,86.71,27.72,27.72,27.72,83.72,83.72,27.72,139.72,139.72,139.72,139.72,27.72,26.73,80.73,134.73,134.73,26.73,80.73,134.73,26.73,80.73,80.73,80.73,26.73,26.73,80.73,134.73,80.73,26.73,134.73,26.73,134.73,26.73,26.73,26.73,134.73,26.73,80.73,77.74,77.74,25.74,77.74,25.74,129.74,77.74,77.74,129.74,25.74,25.74,77.74,77.74,25.74,129.74,129.74,25.74,25.74,129.74,77.74,77.74,129.74,129.74,129.74,74.75,124.75,74.75,24.75,24.75,124.75,74.75,24.75,124.75,74.75,24.75,74.75,74.75,24.75,24.75,24.75,124.75,124.75,24.75,24.75,74.75,24.75,24.75,74.75,74.75,124.75,74.75,23.76,23.76,119.76,71.76,23.76,71.76,23.76,71.76,119.76,23.76,23.76,119.76,71.76,23.76,23.76,119.76,23.76,71.76,119.76,119.76,23.76,119.76,23.76,71.76,71.76,119.76,23.76,71.76,23.76,23.76,71.76,23.76,71.76,68.77,114.77,22.77,22.77,22.77,114.77,114.77,22.77,22.77,114.77,68.77,114.77,114.77,114.77,114.77,68.77,22.77,22.77,114.77,22.77,22.77,114.77,68.77,114.77,114.77,114.77,114.77,68.77,68.77,22.77,68.77,68.77,68.77,68.77,68.77,114.77,21.78,21.78,109.78,65.78,109.78,109.78,21.78,21.78,65.78,109.78,65.78,21.78,65.78,21.78,109.78,109.78,65.78,65.78,109.78,21.78,21.78,109.78,109.78,109.78,109.78,65.78,109.78,65.78,21.78,109.78,21.78,109.78,21.78,21.78,65.78,65.78,109.78,21.78,65.78,62.79,20.79,62.79,20.79,62.79,20.79,20.79,20.79,20.79,20.79,104.79,20.79,104.79,62.79,20.79,20.79,104.79,20.79,62.79,104.79,104.79,62.79,62.79,20.79,20.79,104.79,104.79,104.79,20.79,62.79,62.79,104.79,62.79,20.79,62.79,62.79,62.79,20.79,62.79,20.79,20.79,62.79,20.79,104.79,62.79,104.79,20.79,62.79,20.79,20.79,104.79,20.79,59.8,59.8,59.8,99.8,19.8,59.8,99.8,59.8,59.8,19.8,19.8,19.8,19.8,19.8,59.8,99.8,99.8,99.8,19.8,99.8,59.8,59.8,19.8,19.8,99.8,99.8,99.8,99.8,99.8,99.8,19.8,59.8,19.8,19.8,19.8,99.8,59.8,19.8,19.8,59.8,99.8,99.8,99.8,18.81,18.81,18.81,18.81,18.81,94.81,56.81,18.81,18.81,56.81,18.81,18.81,94.81,18.81,94.81,94.81,56.81,94.81,18.81,94.81,56.81,94.81,56.81,94.81,56.81,94.81,56.81,18.81,18.81,18.81,18.81,18.81,56.81,18.81,94.81,94.81,18.81,18.81,94.81,18.81,94.81,18.81,56.81,56.81,18.81,17.82,17.82,89.82,53.82,89.82,17.82,17.82,17.82,53.82,89.82,89.82,89.82,53.82,53.82,17.82,17.82,17.82,53.82,89.82,53.82,53.82,53.82,53.82,53.82,89.82,89.82,53.82,89.82,53.82,53.82,53.82,53.82,53.82,89.82,89.82,89.82,17.82,89.82,53.82,53.82,17.82,53.82,89.82,16.83,16.83,50.83,50.83,50.83,84.83,84.83,16.83,84.83,50.83,84.83,50.83,84.83,16.83,50.83,50.83,84.83,16.83,84.83,84.83,16.83,84.83,50.83,84.83,84.83,16.83,84.83,84.83,16.83,16.83,50.83,84.83,16.83,16.83,16.83,84.83,50.83,50.83,50.83,50.83,84.83,16.83,50.83,50.83,50.83,84.83,84.83,16.83,84.83,79.84,15.84,47.84,15.84,15.84,15.84,79.84,47.84,15.84,47.84,47.84,15.84,79.84,15.84,47.84,47.84,47.84,15.84,47.84,15.84,47.84,79.84,79.84,79.84,15.84,15.84,47.84,79.84,79.84,15.84,79.84,79.84,15.84,79.84,47.84,15.84,15.84,47.84,79.84,79.84,47.84,79.84,15.84,79.84,79.84,79.84,79.84,79.84,79.84,47.84,47.84,47.84,15.84,47.84,14.85,44.85,74.85,44.85,74.85,74.85,74.85,44.85,44.85,44.85,74.85,14.85,14.85,14.85,74.85,44.85,44.85,44.85,74.85,44.85,74.85,14.85,14.85,74.85,74.85,44.85,44.85,74.85,14.85,14.85,14.85,14.85,44.85,74.85,44.85,14.85,74.85,44.85,44.85,14.85,14.85,14.85,44.85,14.85,74.85,44.85,44.85,74.85,44.85,44.85,44.85,41.86,69.86,41.86,41.86,69.86,69.86,13.86,13.86,41.86,69.86,69.86,69.86,41.86,13.86,41.86,41.86,13.86,41.86,41.86,13.86,69.86,69.86,13.86,41.86,41.86,41.86,13.86,41.86,13.86,13.86,13.86,13.86,41.86,69.86,69.86,13.86,41.86,13.86,13.86,69.86,41.86,69.86,41.86,41.86,41.86,69.86,69.86,12.87,38.87,64.87,64.87,12.87,64.87,12.87,64.87,38.87,38.87,12.87,64.87,12.87,38.87,12.87,12.87,12.87,12.87,38.87,64.87,64.87,64.87,12.87,12.87,64.87,12.87,12.87,38.87,38.87,64.87,12.87,12.87,38.87,38.87,38.87,64.87,38.87,12.87,64.87,38.87,38.87,64.87,64.87,64.87,64.87,12.87,64.87,64.87,64.87,64.87,38.87,12.87,59.88,11.88,59.88,11.88,11.88,11.88,35.88,59.88,11.88,59.88,35.88,35.88,11.88,35.88,59.88,35.88,35.88,35.88,59.88,35.88,35.88,35.88,11.88,11.88,59.88,35.88,59.88,11.88,35.88,35.88,35.88,11.88,59.88,59.88,11.88,59.88,54.89,10.89,10.89,10.89,10.89,54.89,10.89,10.89,54.89,10.89,54.89,10.89,32.89,54.89,32.89,54.89,10.89,10.89,54.89,32.89,54.89,54.89,32.89,54.89,54.89,10.89,10.89,54.89,32.89,32.89,54.89,54.89,32.89,54.89,32.89,10.89,54.89,10.89,54.89,49.9,29.9,29.9,49.9,29.9,29.9,9.9,9.9,9.9,29.9,9.9,29.9,9.9,9.9,29.9,49.9,9.9,29.9,49.9,29.9,49.9,29.9,9.9,49.9,29.9,29.9,9.9,49.9,9.9,49.9,49.9,49.9,49.9,9.9,9.9,29.9,9.9,29.9,44.91,26.91,44.91,26.91,44.91,44.91,44.91,44.91,26.91,44.91,44.91,8.91,26.91,8.91,26.91,26.91,44.91,26.91,44.91,26.91,44.91,44.91,8.91,44.91,26.91,44.91,44.91,8.91,8.91,44.91,44.91,26.91,8.91,26.91,44.91,8.91,8.91,8.91,26.91,26.91,8.91,44.91,44.91,8.91,23.92,23.92,39.92,23.92,23.92,7.92,7.92,23.92,7.92,39.92,7.92,23.92,7.92,7.92,23.92,39.92,39.92,7.92,7.92,39.92,7.92,7.92,23.92,23.92,39.92,7.92,23.92,7.92,7.92,23.92,39.92,39.92,7.92,7.92,23.92,23.92,20.93,20.93,34.93,34.93,6.93,6.93,34.93,6.93,34.93,6.93,6.93,20.93,20.93,6.93,20.93,6.93,6.93,20.93,34.93,34.93,34.93,34.93,20.93,34.93,20.93,20.93,34.93,20.93,34.93,34.93,6.93,6.93,6.93,6.93,34.93,34.93,20.93,20.93,17.94,5.94,29.94,17.94,29.94,5.94,29.94,29.94,5.94,5.94,17.94,5.94,17.94,29.94,5.94,5.94,5.94,17.94,17.94,17.94,29.94,17.94,5.94,29.94,5.94,29.94,29.94,29.94,29.94,5.94,17.94,24.95,14.95,14.95,14.95,14.95,14.95,24.95,14.95,24.95,4.95,14.95,24.95,14.95,24.95,19.96,11.96,11.96,4.99]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>film_id<\/th>\n      <th>title<\/th>\n      <th>rental_rate<\/th>\n      <th>count<\/th>\n      <th>rental_amt<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>The most frequently rented movie, 34 times, is ‘Bucket Brotherhood’ followed by Rocketeer Mother, 33 times.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-41" class="section level4">
<h4><span class="header-section-number">25.1.9.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb528"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb528-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb528-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb528-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb528-4" data-line-number="4"></a>
<a class="sourceLine" id="cb528-5" data-line-number="5">film_rank_dplyr &lt;-<span class="st"> </span>rental_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb528-6" data-line-number="6"><span class="st">    </span><span class="kw">inner_join</span>(inventory_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;inventory_id&quot;</span> =<span class="st"> &quot;inventory_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.r&quot;</span>, <span class="st">&quot;.i&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb528-7" data-line-number="7"><span class="st">    </span><span class="kw">inner_join</span>(film_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;film_id&quot;</span> =<span class="st"> &quot;film_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.f&quot;</span>, <span class="st">&quot;.i&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb528-8" data-line-number="8"><span class="st">    </span><span class="kw">group_by</span>(film_id,title,rental_rate) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb528-9" data-line-number="9"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">count =</span> <span class="kw">n</span>()</a>
<a class="sourceLine" id="cb528-10" data-line-number="10">             ,<span class="dt">rental_amt =</span> <span class="kw">sum</span>(rental_rate)</a>
<a class="sourceLine" id="cb528-11" data-line-number="11">             ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb528-12" data-line-number="12"><span class="st">    </span><span class="kw">arrange</span>(<span class="kw">desc</span>(count)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb528-13" data-line-number="13"><span class="st">  </span><span class="kw">collect</span>()</a></code></pre></div>
<pre><code>## Warning: Missing values are always removed in SQL.
## Use `SUM(x, na.rm = TRUE)` to silence this warning</code></pre>
<div class="sourceCode" id="cb530"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb530-1" data-line-number="1"><span class="kw">sp_print_df</span>(film_rank_dplyr)</a></code></pre></div>
<div id="htmlwidget-90472fc291eea3b37ad9" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-90472fc291eea3b37ad9">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118","119","120","121","122","123","124","125","126","127","128","129","130","131","132","133","134","135","136","137","138","139","140","141","142","143","144","145","146","147","148","149","150","151","152","153","154","155","156","157","158","159","160","161","162","163","164","165","166","167","168","169","170","171","172","173","174","175","176","177","178","179","180","181","182","183","184","185","186","187","188","189","190","191","192","193","194","195","196","197","198","199","200","201","202","203","204","205","206","207","208","209","210","211","212","213","214","215","216","217","218","219","220","221","222","223","224","225","226","227","228","229","230","231","232","233","234","235","236","237","238","239","240","241","242","243","244","245","246","247","248","249","250","251","252","253","254","255","256","257","258","259","260","261","262","263","264","265","266","267","268","269","270","271","272","273","274","275","276","277","278","279","280","281","282","283","284","285","286","287","288","289","290","291","292","293","294","295","296","297","298","299","300","301","302","303","304","305","306","307","308","309","310","311","312","313","314","315","316","317","318","319","320","321","322","323","324","325","326","327","328","329","330","331","332","333","334","335","336","337","338","339","340","341","342","343","344","345","346","347","348","349","350","351","352","353","354","355","356","357","358","359","360","361","362","363","364","365","366","367","368","369","370","371","372","373","374","375","376","377","378","379","380","381","382","383","384","385","386","387","388","389","390","391","392","393","394","395","396","397","398","399","400","401","402","403","404","405","406","407","408","409","410","411","412","413","414","415","416","417","418","419","420","421","422","423","424","425","426","427","428","429","430","431","432","433","434","435","436","437","438","439","440","441","442","443","444","445","446","447","448","449","450","451","452","453","454","455","456","457","458","459","460","461","462","463","464","465","466","467","468","469","470","471","472","473","474","475","476","477","478","479","480","481","482","483","484","485","486","487","488","489","490","491","492","493","494","495","496","497","498","499","500","501","502","503","504","505","506","507","508","509","510","511","512","513","514","515","516","517","518","519","520","521","522","523","524","525","526","527","528","529","530","531","532","533","534","535","536","537","538","539","540","541","542","543","544","545","546","547","548","549","550","551","552","553","554","555","556","557","558","559","560","561","562","563","564","565","566","567","568","569","570","571","572","573","574","575","576","577","578","579","580","581","582","583","584","585","586","587","588","589","590","591","592","593","594","595","596","597","598","599","600","601","602","603","604","605","606","607","608","609","610","611","612","613","614","615","616","617","618","619","620","621","622","623","624","625","626","627","628","629","630","631","632","633","634","635","636","637","638","639","640","641","642","643","644","645","646","647","648","649","650","651","652","653","654","655","656","657","658","659","660","661","662","663","664","665","666","667","668","669","670","671","672","673","674","675","676","677","678","679","680","681","682","683","684","685","686","687","688","689","690","691","692","693","694","695","696","697","698","699","700","701","702","703","704","705","706","707","708","709","710","711","712","713","714","715","716","717","718","719","720","721","722","723","724","725","726","727","728","729","730","731","732","733","734","735","736","737","738","739","740","741","742","743","744","745","746","747","748","749","750","751","752","753","754","755","756","757","758","759","760","761","762","763","764","765","766","767","768","769","770","771","772","773","774","775","776","777","778","779","780","781","782","783","784","785","786","787","788","789","790","791","792","793","794","795","796","797","798","799","800","801","802","803","804","805","806","807","808","809","810","811","812","813","814","815","816","817","818","819","820","821","822","823","824","825","826","827","828","829","830","831","832","833","834","835","836","837","838","839","840","841","842","843","844","845","846","847","848","849","850","851","852","853","854","855","856","857","858","859","860","861","862","863","864","865","866","867","868","869","870","871","872","873","874","875","876","877","878","879","880","881","882","883","884","885","886","887","888","889","890","891","892","893","894","895","896","897","898","899","900","901","902","903","904","905","906","907","908","909","910","911","912","913","914","915","916","917","918","919","920","921","922","923","924","925","926","927","928","929","930","931","932","933","934","935","936","937","938","939","940","941","942","943","944","945","946","947","948","949","950","951","952","953","954","955","956","957","958","959"],[103,738,331,489,382,730,767,753,418,1000,973,621,891,31,735,369,869,559,403,127,563,109,979,702,789,285,748,239,341,609,450,374,73,86,849,174,378,361,941,301,893,284,220,595,875,873,945,358,764,159,395,356,951,911,850,305,745,295,114,349,367,715,330,625,434,698,697,244,835,603,228,531,206,200,870,468,525,638,879,521,958,78,897,135,181,397,391,970,938,554,101,901,670,167,890,683,471,687,460,572,234,12,838,445,263,303,307,773,417,571,247,245,760,55,902,989,154,895,319,162,309,387,644,172,880,786,791,288,624,545,555,863,273,856,266,476,804,91,741,443,966,366,131,166,810,865,447,527,253,43,304,852,11,433,551,586,650,130,388,775,641,502,649,35,45,491,119,790,334,816,327,646,199,771,320,412,665,504,122,608,892,437,676,915,961,914,271,270,4,857,982,1,51,614,10,353,191,976,843,645,995,494,759,117,176,89,556,142,143,898,949,79,518,25,500,61,59,21,54,972,408,406,823,252,444,814,267,575,18,800,15,26,782,428,300,706,985,314,772,322,376,415,651,776,313,6,596,981,317,953,39,193,112,149,602,67,681,354,37,727,377,416,292,69,841,49,922,274,242,235,22,138,833,930,19,249,806,807,514,23,132,255,846,677,83,218,280,57,755,861,100,129,164,637,920,827,694,439,409,99,462,465,805,204,535,467,590,993,680,484,728,647,578,562,579,402,486,778,363,707,720,496,147,326,906,733,668,140,501,628,350,743,231,723,845,414,851,139,281,560,580,48,72,948,97,115,118,912,150,158,160,887,864,222,227,233,243,818,269,282,785,298,302,311,344,345,747,370,734,725,396,710,429,436,451,690,457,479,663,631,619,616,610,17,709,116,385,986,777,456,383,121,689,212,461,56,463,724,8,688,155,871,184,474,473,746,971,294,432,286,967,410,583,329,524,768,77,90,936,812,254,251,657,924,346,215,717,348,763,336,333,324,424,308,299,999,803,275,265,448,854,574,693,691,611,561,859,464,877,183,878,481,483,175,169,488,672,925,506,510,512,95,944,643,70,964,58,534,626,623,552,380,737,398,744,226,111,664,42,927,40,600,987,105,351,260,980,937,708,392,696,85,809,956,606,963,373,739,991,797,526,969,704,186,686,189,757,601,679,570,480,427,678,50,179,975,170,749,44,165,716,203,862,141,908,123,666,458,855,505,7,28,68,84,110,137,152,201,229,232,236,272,287,420,421,438,442,446,452,529,532,542,544,557,588,589,592,598,615,618,634,654,655,732,770,788,792,795,796,820,830,844,858,872,896,907,932,942,962,988,894,546,394,913,219,774,241,667,493,277,81,673,173,946,900,216,16,478,620,832,784,992,190,840,648,629,365,205,455,381,24,453,652,783,793,379,921,847,756,360,968,599,536,426,916,658,347,917,430,705,423,258,540,711,133,134,145,151,153,593,882,27,736,177,213,597,34,639,321,573,842,293,290,577,511,994,63,328,617,65,660,661,296,71,209,765,604,487,762,568,96,98,829,828,929,202,449,440,867,766,291,9,794,798,825,813,821,519,585,576,581,567,957,80,88,93,682,3,933,931,928,113,919,413,564,389,538,881,533,5,194,207,977,323,315,352,257,250,899,905,46,918,700,342,692,104,469,761,92,831,337,75,633,74,64,60,509,283,549,210,640,848,587,819,306,853,888,627,889,886,729,722,530,187,553,613,543,539,537,630,29,636,528,522,508,662,482,477,422,726,393,731,375,740,368,750,339,312,780,20,279,276,811,246,834,837,868,157,82,952,960,66,466,454,685,264,998,30,934,594,826,214,978,211,240,591,632,208,338,516,815,582,188,355,515,357,983,984,390,824,503,565,13,230,550,721,499,76,492,714,126,425,435,120,940,256,787,866,225,548,566,703,431,674,124,659,163,923,752,939,926,751,223,401,719,876,817,822,146,990,490,47,52,136,718,364,371,656,384,523,758,197,248,268,278,836,547,839,238,237,289,779,316,196,185,182,178,161,996,156,910,407,411,106,695,470,935,684,947,2,605,653,53,513,517,520,569,622,541,261,125,62,224,883,974,799,754,32,340,635,808,769,102,259,472,475,485,675,997,405,498,959,399,262,507,297,965,168,372,885,884,335,459,699,107,558,441,903,94,362,310,180,781,343,612,904,584,400,1001],["Bucket Brotherhood","Rocketeer Mother","Forward Temple","Juggler Hardly","Grit Clockwork","Ridgemont Submarine","Scalawag Duck","Rush Goodfellas","Hobbit Alien","Zorro Ark","Wife Turn","Network Peak","Timberland Sky","Apache Divine","Robbers Joon","Goodfellas Salute","Suspects Quills","Married Go","Harry Idaho","Cat Coneheads","Massacre Usual","Butterfly Chocolat","Witches Panic","Pulp Beverly","Shock Cabin","English Bulworth","Rugrats Shakespeare","Dogma Family","Frost Head","Muscle Bright","Idols Snatchers","Graffiti Love","Bingo Talented","Boogie Amelie","Storm Happiness","Confidential Interview","Greatest North","Gleaming Jawbreaker","Videotape Arsenic","Family Sweet","Titans Jerk","Enemy Odds","Deer Virginian","Moon Bunch","Talented Homicide","Sweethearts Suspects","Virginian Pluto","Gilmore Boiled","Saturday Lambs","Closer Bang","Handicap Boondock","Giant Troopers","Voyage Legally","Trip Newton","Story Side","Fatal Haunted","Roses Treasure","Expendable Stallion","Camelot Vacation","Gangs Pride","Goldmine Tycoon","Range Moonwalker","Forrester Comancheros","None Spiking","Horror Reign","Princess Giant","Primary Glass","Dorado Notting","Spy Mile","Movie Shakespeare","Detective Vision","Lose Inch","Dancing Fever","Curtain Videotape","Swarm Gold","Invasion Cyclone","Loathing Legally","Operation Operation","Telegraph Voyage","Lies Treatment","Wardrobe Phantom","Blackout Private","Torque Bound","Chance Resurrection","Contact Anonymous","Hanky October","Half Outfield","Westward Seabiscuit","Velvet Terminator","Malkovich Pet","Brotherhood Blanket","Tracy Cider","Pelican Comforts","Coma Head","Tights Dawn","Pity Bound","Island Exorcist","Pocus Pulp","Innocent Usual","Metropolis Coma","Disturbing Scarface","Alaska Phantom","Stagecoach Armageddon","Hyde Doctor","Durham Panky","Fantasy Troopers","Fellowship Autumn","Seabiscuit Punk","Hills Neighbors","Metal Armageddon","Downhill Enough","Double Wrath","Samurai Lion","Barbarella Streetcar","Trading Pinocchio","Working Microcosmos","Clash Freddy","Tomorrow Hustler","Fish Opus","Clueless Bucket","Feud Frogmen","Gun Bonnie","Oscar Gold","Coneheads Smoochy","Telemark Heartbreakers","Shepherd Midsummer","Show Lord","Escape Metropolis","Nightmare Chill","Madness Attacks","Mallrats United","Sun Confessions","Effect Gladiator","Streetcar Intentions","Dynamite Tarzan","Jason Trap","Sleeping Suspects","Bound Cheaper","Roman Punk","Hurricane Affair","Wedding Apollo","Goldfinger Sensibility","Center Dinosaur","Color Philadelphia","Slums Duck","Sunrise League","Ice Crossing","Lola Agent","Drifter Commandments","Atlantis Cause","Fargo Gandhi","Strangelove Desire","Alamo Videotape","Horn Working","Maiden Home","Mockingbird Hollywood","Pacific Amistad","Celebrity Horn","Gunfight Moon","Seattle Expecations","Orange Grapes","Knock Warlock","Oz Liaisons","Arachnophobia Rollercoaster","Attraction Newton","Jumping Wrath","Caper Motions","Shootist Superfly","Freddy Storm","Snowman Rollercoaster","Fool Mockingbird","Outbreak Divine","Cupboard Sinners","Scorpion Apollo","Flamingos Connecticut","Heavyweights Beast","Patton Interview","Kwai Homeward","Carrie Bunch","Murder Antitrust","Titanic Boondock","House Dynamite","Philadelphia Wife","Truman Crazy","Wash Heavenly","Trouble Date","Easy Gladiator","Earth Vision","Affair Prejudice","Strictly Scarface","Women Dorado","Academy Dinosaur","Balloon Homeward","Name Detective","Aladdin Calendar","Gentlemen Stage","Crooked Frogmen","Wind Phantom","Steel Santa","Others Soup","Yentl Idaho","Karate Moon","Salute Apollo","Candles Grapes","Congeniality Quest","Borrowers Bedazzled","Maltese Hope","Chicken Hellfighters","Chill Luck","Tourist Pelican","Volcano Texas","Blade Polish","Liaisons Sweet","Angels Life","Kiss Glory","Beauty Grease","Bear Graceland","American Circus","Banger Pinocchio","Whisperer Giant","Head Stranger","Haunting Pianist","South Wait","Dream Pickup","Hustler Party","Snatch Slipper","Eagles Panky","Midsummer Groundhog","Alter Victory","Sinners Atlantis","Alien Center","Annie Identity","Shakespeare Saddle","Homicide Peach","Falcon Volume","Queen Luke","Wonderland Christmas","Fight Jawbreaker","Sea Virgin","Flatliners Killer","Grapes Fury","High Encino","Packer Madigan","Secret Groundhog","Fidelity Devil","Agent Truman","Moonshine Cabin","Wolves Desire","Fireball Philadelphia","Wait Cider","Armageddon Lost","Crossroads Casualties","Calendar Gunfight","Christmas Moonshine","Mourning Purple","Berets Agent","Pirates Roxanne","Ghost Groundhog","Arizona Bang","Resurrection Silverado","Grease Youth","Highball Potter","Excitement Eve","Beverly Outlaw","Star Operation","Badman Dawn","Undefeated Dalmations","Egg Igby","Doom Dancing","Divide Monster","Amistad Midsummer","Chariots Conspiracy","Splendor Patton","Vacation Boondock","Amadeus Holy","Dracula Crystal","Sleepy Japanese","Sleuth Orient","Lebowski Soldiers","Anaconda Confessions","Chainsaw Uptown","Driving Polish","Sting Personal","Pianist Outfield","Blues Instinct","Deceiver Betrayed","Empire Malkovich","Basic Easy","Sabrina Midnight","Suit Walls","Brooklyn Desert","Cause Date","Coast Rainbow","Open African","Unbreakable Karate","Spice Sorority","Prejudice Oleander","Hunchback Impossible","Heartbreakers Bright","Bringing Hysterical","Insider Arizona","Interview Liaisons","Sleepless Monsoon","Dalmations Sweden","Love Suicides","Intrigue Worst","Money Harold","Wrong Behavior","Pinocchio Simon","Jerk Paycheck","Reunion Witches","Outfield Massacre","Million Ace","Masked Bubble","Minds Truman","Harper Dying","Jet Neighbors","Secrets Paradise","Go Purple","Quest Mussolini","Redemption Comforts","Kick Savannah","Chocolat Harry","Flying Hook","Tramp Others","River Outlaw","Peak Forever","Cheaper Clyde","Kissing Dolls","Northwest Polish","Garden Island","Room Roman","Dinosaur Secretary","Reign Gentlemen","Stepmom Dream","Hellfighters Sierra","Straight Hours","Chasing Fight","Encino Elf","Mars Roman","Mine Titans","Backlash Undefeated","Bill Others","Voice Peach","Bride Intrigue","Campus Remember","Canyon Stock","Trojan Tomorrow","Cider Desire","Clones Pinocchio","Club Graffiti","Thief Pelican","Sundance Invasion","Desert Poseidon","Details Packer","Disciple Mother","Doors President","Something Duck","Earring Instinct","Encounters Curtain","Shawshank Bubble","Eyes Driving","Fantasia Park","Fiction Christmas","Fury Murder","Gables Metropolis","Roxanne Rebel","Gorgeous Bingo","Road Roxanne","Requiem Tycoon","Hanging Deep","Rage Games","Honey Ties","Hours Rage","Igby Maker","Pond Seattle","Independence Hotel","Jedi Beneath","Patient Sister","Novocaine Flight","Neighbors Charade","National Story","Music Boondock","Alone Trip","Racer Egg","Candidate Perdition","Groundhog Uncut","Wonka Sea","Secretary Rouge","Inch Jet","Groove Fiction","Carol Texas","Pollock Deliverance","Darn Forrester","Insects Stone","Barefoot Manchurian","Instinct Airport","Remember Diary","Airport Pollock","Polish Brooklyn","Cleopatra Devil","Sweden Shining","Core Suit","Jade Bunch","Jacket Frisco","Rouge Squad","Whale Bikini","Expecations Natural","Hope Tootsie","Enough Raging","Weekend Personal","Heaven Freedom","Mission Zoolander","Forrest Sons","Lion Uncut","Scarface Bang","Birds Perdition","Boulevard Mob","Vanishing Rocky","Smoking Barbarella","Driver Annie","Dragonfly Strangers","Paradise Sabrina","Unforgiven Zoolander","Galaxy Sweethearts","Dawn Pond","Rear Trading","Gandhi Kwai","Satisfaction Confidential","French Holiday","Freaky Pocus","Flintstones Happiness","Holocaust Highball","Ferris Mother","Factory Dragon","Zoolander Fiction","Slacker Liaisons","Egypt Tenenbaums","Dying Maker","Idaho Love","Strangers Graffiti","Midnight Westward","Potter Connecticut","Poseidon Forever","Musketeers Wait","Mask Peach","Sugar Wonka","Intentions Empire","Taxi Kick","Conversation Downhill","Teen Apollo","Jekyll Frogmen","Jericho Mulan","Confused Candles","Comforts Rush","Joon Northwest","Perfect Groove","United Pilot","Lady Stage","Lawless Vision","League Hellfighters","Breakfast Goldfinger","Virgin Daisy","Orient Closer","Bikini Borrowers","Waterfront Deliverance","Beach Heartbreakers","Louisiana Harry","Noon Papi","Newton Labyrinth","Majestic Floats","Greek Everyone","Rock Instinct","Hanover Galaxy","Roots Remember","Destiny Saturday","Caddyshack Jedi","Patriot Roman","Artist Coldblooded","Uprising Uptown","Army Flintstones","Motions Details","Words Hunter","Bull Shawshank","Gaslight Crusade","Dude Blindness","Wizard Coldblooded","Varsity Trip","Quills Bull","Hall Cassidy","Pride Alamo","Bonnie Holocaust","Slipper Fidelity","Wanda Chamber","Mummy Creatures","Watch Tracy","Graduate Lord","Rocky War","Worst Banger","Silence Kane","Lock Rear","West Lion","Pure Runner","Craft Outfield","Pluto Oleander","Creatures Shakespeare","Sagebrush Clueless","Moulin Wake","Pilot Hoosiers","Mermaid Insects","Jeepers Wedding","Homeward Cider","Pickup Driving","Baked Cleopatra","Conquerer Nuts","Willow Tracy","Command Darling","Rules Human","Attacks Hate","Coldblooded Darling","Reap Unfaithful","Daisy Menagerie","Summer Scarface","Chicago North","Trap Guys","Casablanca Super","Paycheck Wait","Indian Love","Streak Ridgemont","Labyrinth League","Airplane Sierra","Anthem Luke","Betrayed Rear","Boiled Dares","Cabin Flash","Charade Duffel","Circus Youth","Cyclone Family","Devil Desire","Dirty Ace","Divine Resurrection","Edge Kissing","Entrapment Satisfaction","Holes Brannigan","Holiday Games","Human Graffiti","Hunting Musketeers","Hysterical Grail","Illusion Amelie","Lonely Elephant","Loser Hustler","Lust Lock","Madison Trap","Manchurian Curtain","Model Fish","Modern Dorado","Monster Spartacus","Mosquito Armageddon","Nash Chocolat","Necklace Outbreak","Odds Boogie","Panky Submarine","Panther Reds","Rings Heartbreakers","Scissorhands Slums","Ship Wonderland","Shrek License","Siege Madre","Sierra Divide","Sons Interview","Spirit Flintstones","Steers Armageddon","Submarine Bed","Sweet Brotherhood","Tootsie Pilot","Translation Summer","Valley Packer","Vietnam Smoochy","Wasteland Divine","Worker Tarzan","Tomatoes Hellfighters","Madre Gables","Hamlet Wisdom","Troopers Metal","Deep Crusade","Searchers Wait","Donnie Alley","Peach Innocent","Kane Exorcist","Elephant Trojan","Blindness Gun","Personal Ladybugs","Confessions Maguire","Virtual Spoilers","Town Ark","Day Unfaithful","Alley Evolution","Jaws Harry","Nemo Campus","Splash Gump","Shanghai Tycoon","Wrath Mile","Creepers Kane","Stampede Disturbing","Outlaw Hanky","Notorious Reunion","Gold River","Dances None","Impossible Prejudice","Grinch Massage","Analyze Hoosiers","Image Princess","Pajama Jawbreaker","Shane Darkness","Shrunk Divine","Greedy Roots","Uncut Suicides","Stock Glass","Saddle Antitrust","Glass Dying","Werewolf Lola","Mother Oleander","Lovely Jingle","Home Pity","Turn Star","Paris Weekend","Games Bowfinger","Tuxedo Mile","Hook Chariots","Purple Movie","Hollywood Anonymous","Drums Dynamite","Lucky Flying","Raging Airplane","Chamber Italian","Champion Flatliners","Chisum Behavior","Cincinatti Whisperer","Citizen Shrek","Monterey Labyrinth","Tenenbaums Command","Anonymous Human","Robbery Bright","Connecticut Tramp","Date Speed","Moonwalker Fool","Arabia Dogma","Opposite Necklace","Flash Wars","Microcosmos Paradise","State Wasteland","Exorcist Sting","Everyone Craft","Mile Mulan","Lawrence Love","Wyoming Storm","Bedazzled Married","Forever Candidate","Natural Stock","Behavior Runaway","Party Knock","Past Suicides","Express Lonely","Bilko Anonymous","Darkness War","Saturn Name","Mulan Moon","Jingle Sagebrush","Sassy Packer","Memento Zoolander","Breaking Home","Bright Encounters","Spinal Rocky","Spiking Element","Usual Untouchables","Daddy Pittsburgh","Identity Lover","Hunger Roof","Super Wyoming","Savannah Town","Evolution Alter","Alabama Devil","Side Ark","Silverado Goldfinger","Speakeasy Date","Smoochy Control","Sorority Queen","Liberty Magnificent","Mob Duffel","Mighty Luck","Minority Kiss","Meet Chocolate","War Notting","Blanket Beverly","Born Spinal","Brannigan Sunrise","Pittsburgh Hunchback","Adaptation Holes","Vampire Whale","Valentine Vanishing","Uptown Young","California Birds","Tycoon Gathering","Hedwig Alter","Massage Image","Gunfighter Mussolini","Loverboy Attacks","Temple Attraction","Lost Bird","African Egg","Crow Grease","Dangerous Uptown","Window Side","Flight Lies","Finding Anaconda","Gathering Calendar","Drumline Cyclone","Dragon Squad","Towers Hurricane","Trainspotting Strangers","Autumn Crow","Twisted Pirates","Prix Undefeated","Fugitive Maguire","Potluck Mixed","Bugsy Song","Iron Moon","Santa Paris","Bowfinger Gables","Spirited Casualties","Frida Slipper","Bird Independence","October Submarine","Birch Antitrust","Beethoven Exorcist","Beast Hunchback","Language Cowboy","Ending Crowds","Magnolia Forrester","Darko Dorado","Opus Ice","Stone Fire","Mod Secretary","Song Hedwig","Feathers Metal","Stranger Strangers","Thin Sagebrush","North Tequila","Ties Hunger","Theory Mermaid","Rider Caddyshack","Reef Salute","Lord Arizona","Cranes Reservoir","Maker Gables","Mystic Truman","Madigan Dorado","Luck Opus","Lover Truman","Notting Speakeasy","Antitrust Tomatoes","Oleander Clue","Lolita World","Life Twisted","Lambs Cincinatti","Paths Control","Jeopardy Encino","Jawbreaker Brooklyn","Hollow Jeopardy","Reservoir Adaptation","Halloween Nuts","Right Cranes","Grail Frankenstein","Rollercoaster Bringing","Gone Trouble","Run Pacific","Frogmen Breaking","Fiddler Lost","Sensibility Rear","Amelie Hellfighters","Elizabeth Shane","Element Freddy","Smile Earring","Doubtfire Labyrinth","Spoilers Hellfighters","Stage World","Superfly Trip","Clockwork Paradise","Blood Argonauts","Wagon Jaws","Wars Pluto","Beneath Rush","Intolerable Intentions","Impact Aladdin","Platoon Instinct","Dwarfs Alter","Zhivago Core","Anything Savannah","Vanilla Day","Montezuma Command","Speed Suit","Daughter Madigan","Wisdom Worker","Darling Breaking","Dolls Rage","Monsoon Cause","Nuts Ties","Dares Pluto","Frisco Forrest","Legend Jedi","Snatchers Montezuma","Miracle Virtual","Crazy Home","Ghostbusters Elf","Legally Secretary","Gilbert Pelican","Won Dares","Wonderful Drop","Guys Falcon","Spartacus Cheaper","Kramer Chocolate","Matrix Snowman","Ali Forever","Diary Panic","Maguire Apache","Reds Pocus","King Evolution","Birdcage Casper","Jungle Closer","Random Go","Casualties Encino","Holy Tadpole","Hotel Happiness","Caribbean Liberty","Victory Academy","Drop Waterfront","Shining Roses","Sunset Racer","Destination Jerk","Magnificent Chitty","Maude Mod","Punk Divorce","Hoosiers Birdcage","Pet Haunting","Casper Dragonfly","Park Citizen","Clyde Theory","Unfaithful Kill","Runner Madigan","Vertigo Northwest","Untouchables Sunrise","Runaway Tenenbaums","Desire Alien","Harold French","Records Zorro","Tarzan Videotape","Soldiers Evolution","Soup Wisdom","Chitty Lock","World Leathernecks","Jumanji Blade","Baby Hall","Ballroom Mockingbird","Chaplin License","Rebel Airport","Godfather Diary","Gosford Donnie","Papi Necklace","Grosse Wonderful","Lights Deer","Saints Bride","Crusade Honey","Dozen Lion","Early Home","Elf Murder","Squad Fish","Magic Mallrats","Stallion Sundance","Doctor Grail","Divorce Shining","Eve Resurrection","Sense Greek","Fire Wolves","Cruelty Unforgiven","Cowboy Doom","Control Anthem","Connection Microcosmos","Clue Grail","Young Language","Clerks Angels","Treatment Jekyll","Hawk Chill","Heavenly Gun","Bulworth Commandments","President Bang","Ishtar Rocketeer","Vanished Garden","Pizza Jumanji","Vision Torque","Ace Goldfinger","Mulholland Beast","Panic Club","Bang Kwai","Leathernecks Dwarfs","Lesson Cleopatra","License Weekend","Menagerie Rushmore","Newsies Story","Luke Mummy","Duffel Apocalypse","Cassidy Wyoming","Bed Highball","Desperate Trainspotting","Tequila Past","Wild Apollo","Simon North","Rushmore Mermaid","Apocalypse Flamingos","Frontier Cabin","Oklahoma Jumanji","Sling Luke","School Jacket","Bubble Grosse","Duck Racer","Italian African","Japanese Run","Jersey Sassy","Phantom Glory","Youth Kick","Haunted Antitrust","Killer Innocent","Warlock Werewolf","Happiness United","Dumbo Lust","Ladybugs Armageddon","Extraordinary Conquerer","Watership Frontier","Comancheros Enemy","Graceland Dynamite","Texas Watch","Terminator Club","Freedom Cleopatra","Informer Double","Private Drop","Bunch Minds","Mannequin Worst","Hunter Alter","Traffic Hobbit","Braveheart Human","Glory Tracy","Fever Empire","Conspiracy Spirit","Seven Swarm","Full Flatliners","Mussolini Spoilers","Train Bunch","Mixed Doors","Hardly Robbers","Sophie's Choice"],[4.99,0.99,2.99,0.99,0.99,0.99,4.99,0.99,0.99,4.99,4.99,2.99,0.99,4.99,2.99,4.99,2.99,2.99,4.99,4.99,4.99,0.99,4.99,2.99,2.99,0.99,0.99,4.99,0.99,2.99,2.99,0.99,2.99,4.99,0.99,4.99,2.99,2.99,4.99,0.99,4.99,4.99,2.99,0.99,0.99,0.99,0.99,0.99,4.99,4.99,0.99,2.99,0.99,4.99,0.99,2.99,4.99,0.99,0.99,2.99,0.99,4.99,4.99,0.99,0.99,2.99,0.99,4.99,2.99,4.99,0.99,0.99,0.99,0.99,0.99,2.99,0.99,2.99,4.99,4.99,2.99,2.99,4.99,2.99,2.99,2.99,2.99,0.99,4.99,2.99,0.99,0.99,4.99,4.99,0.99,4.99,2.99,0.99,4.99,2.99,2.99,0.99,4.99,2.99,4.99,0.99,4.99,2.99,0.99,2.99,0.99,0.99,2.99,2.99,4.99,4.99,2.99,2.99,2.99,2.99,0.99,0.99,2.99,4.99,2.99,0.99,4.99,2.99,4.99,0.99,0.99,0.99,0.99,4.99,0.99,2.99,4.99,0.99,0.99,2.99,0.99,0.99,4.99,2.99,0.99,4.99,2.99,4.99,4.99,2.99,2.99,0.99,0.99,2.99,4.99,0.99,0.99,0.99,0.99,4.99,0.99,2.99,2.99,2.99,4.99,0.99,0.99,0.99,4.99,0.99,4.99,0.99,2.99,4.99,4.99,4.99,2.99,0.99,0.99,2.99,4.99,2.99,4.99,4.99,4.99,2.99,4.99,0.99,2.99,2.99,0.99,0.99,2.99,4.99,4.99,2.99,0.99,0.99,4.99,2.99,4.99,0.99,2.99,4.99,0.99,0.99,4.99,0.99,0.99,4.99,0.99,0.99,4.99,2.99,4.99,4.99,2.99,4.99,0.99,4.99,4.99,0.99,2.99,2.99,4.99,4.99,4.99,4.99,0.99,2.99,2.99,0.99,2.99,2.99,4.99,4.99,4.99,0.99,2.99,2.99,0.99,2.99,0.99,4.99,4.99,2.99,4.99,0.99,0.99,0.99,0.99,2.99,4.99,0.99,0.99,2.99,0.99,4.99,2.99,0.99,0.99,0.99,0.99,2.99,2.99,2.99,4.99,2.99,0.99,2.99,2.99,2.99,0.99,2.99,0.99,0.99,2.99,0.99,2.99,0.99,0.99,4.99,4.99,0.99,2.99,0.99,0.99,2.99,4.99,4.99,4.99,2.99,0.99,4.99,0.99,4.99,4.99,4.99,4.99,2.99,2.99,4.99,4.99,0.99,0.99,0.99,2.99,2.99,4.99,2.99,0.99,0.99,4.99,0.99,4.99,0.99,4.99,4.99,0.99,2.99,2.99,0.99,0.99,2.99,0.99,0.99,4.99,0.99,4.99,2.99,4.99,0.99,2.99,2.99,4.99,2.99,0.99,4.99,0.99,0.99,4.99,4.99,2.99,0.99,0.99,2.99,0.99,2.99,2.99,2.99,0.99,4.99,0.99,4.99,4.99,0.99,4.99,4.99,0.99,0.99,4.99,2.99,2.99,0.99,0.99,0.99,0.99,2.99,4.99,4.99,4.99,4.99,0.99,0.99,4.99,2.99,0.99,0.99,0.99,0.99,0.99,2.99,0.99,0.99,2.99,2.99,4.99,2.99,4.99,4.99,0.99,2.99,2.99,4.99,0.99,2.99,2.99,2.99,4.99,0.99,0.99,4.99,2.99,2.99,2.99,0.99,4.99,4.99,2.99,2.99,2.99,2.99,4.99,2.99,0.99,4.99,4.99,0.99,2.99,0.99,2.99,4.99,2.99,0.99,4.99,4.99,0.99,0.99,4.99,4.99,2.99,4.99,0.99,2.99,0.99,2.99,4.99,0.99,4.99,2.99,4.99,0.99,2.99,4.99,4.99,2.99,4.99,2.99,0.99,4.99,4.99,2.99,2.99,2.99,2.99,0.99,2.99,0.99,4.99,4.99,4.99,4.99,4.99,2.99,4.99,4.99,2.99,0.99,2.99,0.99,0.99,2.99,0.99,4.99,0.99,4.99,0.99,2.99,2.99,2.99,0.99,0.99,2.99,0.99,2.99,4.99,4.99,2.99,4.99,4.99,0.99,0.99,0.99,4.99,0.99,0.99,2.99,4.99,2.99,0.99,2.99,4.99,2.99,0.99,4.99,0.99,2.99,0.99,2.99,4.99,2.99,0.99,2.99,2.99,4.99,2.99,4.99,4.99,4.99,4.99,2.99,4.99,0.99,4.99,4.99,4.99,4.99,0.99,0.99,2.99,4.99,4.99,4.99,4.99,0.99,2.99,2.99,2.99,4.99,2.99,2.99,4.99,0.99,4.99,4.99,2.99,2.99,4.99,0.99,2.99,4.99,2.99,2.99,2.99,4.99,0.99,2.99,0.99,2.99,0.99,0.99,4.99,4.99,0.99,2.99,2.99,2.99,0.99,0.99,2.99,0.99,4.99,4.99,2.99,0.99,0.99,0.99,0.99,2.99,2.99,0.99,2.99,2.99,0.99,4.99,2.99,0.99,2.99,0.99,4.99,4.99,0.99,4.99,4.99,2.99,4.99,2.99,2.99,2.99,0.99,2.99,0.99,4.99,0.99,4.99,0.99,4.99,0.99,4.99,4.99,2.99,2.99,0.99,2.99,2.99,0.99,2.99,2.99,2.99,0.99,4.99,0.99,2.99,4.99,2.99,2.99,4.99,2.99,0.99,2.99,0.99,0.99,2.99,4.99,4.99,4.99,4.99,4.99,0.99,0.99,0.99,0.99,0.99,4.99,0.99,4.99,0.99,4.99,4.99,2.99,2.99,2.99,0.99,0.99,0.99,4.99,0.99,2.99,0.99,4.99,2.99,4.99,2.99,4.99,2.99,4.99,0.99,4.99,0.99,4.99,2.99,4.99,2.99,2.99,4.99,4.99,2.99,0.99,4.99,0.99,0.99,2.99,0.99,4.99,2.99,0.99,0.99,2.99,0.99,2.99,0.99,2.99,4.99,2.99,4.99,4.99,4.99,2.99,4.99,0.99,2.99,4.99,4.99,2.99,2.99,2.99,0.99,4.99,2.99,2.99,0.99,4.99,2.99,4.99,0.99,0.99,0.99,0.99,0.99,4.99,4.99,4.99,2.99,4.99,2.99,2.99,4.99,2.99,4.99,0.99,2.99,4.99,4.99,4.99,0.99,4.99,0.99,0.99,0.99,4.99,4.99,0.99,4.99,0.99,0.99,4.99,4.99,4.99,4.99,0.99,2.99,0.99,2.99,2.99,0.99,0.99,4.99,2.99,2.99,0.99,2.99,0.99,2.99,2.99,4.99,4.99,0.99,0.99,4.99,2.99,2.99,4.99,2.99,2.99,2.99,0.99,0.99,4.99,4.99,4.99,4.99,4.99,2.99,4.99,0.99,2.99,0.99,0.99,0.99,2.99,2.99,0.99,4.99,0.99,4.99,2.99,0.99,2.99,4.99,0.99,4.99,4.99,0.99,4.99,2.99,4.99,4.99,2.99,4.99,0.99,2.99,2.99,2.99,0.99,4.99,0.99,2.99,2.99,4.99,4.99,2.99,4.99,4.99,2.99,2.99,4.99,4.99,0.99,0.99,2.99,4.99,0.99,4.99,4.99,0.99,4.99,0.99,0.99,0.99,2.99,0.99,4.99,2.99,0.99,4.99,4.99,0.99,2.99,0.99,2.99,2.99,0.99,2.99,0.99,4.99,2.99,4.99,0.99,2.99,0.99,2.99,4.99,0.99,2.99,0.99,2.99,4.99,0.99,4.99,0.99,2.99,2.99,4.99,4.99,4.99,2.99,0.99,0.99,2.99,2.99,4.99,4.99,4.99,0.99,2.99,4.99,0.99,4.99,0.99,4.99,0.99,0.99,4.99,2.99,4.99,4.99,0.99,2.99,0.99,4.99,2.99,4.99,2.99,2.99,0.99,2.99,2.99,0.99,2.99,0.99,2.99,2.99,4.99,4.99,0.99,0.99,2.99,4.99,4.99,0.99,0.99,4.99,4.99,2.99,4.99,0.99,4.99,2.99,0.99,4.99,2.99,2.99,2.99,0.99,0.99,2.99,0.99,0.99,4.99,0.99,4.99,0.99,4.99,4.99,2.99,2.99,2.99,4.99,2.99,2.99,4.99,2.99,4.99,2.99,2.99,4.99,2.99,2.99,4.99],[34,33,32,32,32,32,32,31,31,31,31,31,31,31,31,31,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,28,28,28,28,28,28,28,28,28,28,28,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,5,5,5,5,5,5,5,5,5,5,5,5,5,5,4,4,4,1],[169.66,32.67,95.68,31.68,31.68,31.68,159.68,30.69,30.69,154.69,154.69,92.69,30.69,154.69,92.69,154.69,89.7,89.7,149.7,149.7,149.7,29.7,149.7,89.7,89.7,29.7,29.7,149.7,29.7,89.7,89.7,29.7,86.71,144.71,28.71,144.71,86.71,86.71,144.71,28.71,144.71,144.71,86.71,28.71,28.71,28.71,28.71,27.72,139.72,139.72,27.72,83.72,27.72,139.72,27.72,83.72,139.72,27.72,26.73,80.73,26.73,134.73,134.73,26.73,26.73,80.73,26.73,134.73,80.73,134.73,26.73,26.73,26.73,26.73,26.73,80.73,26.73,80.73,134.73,134.73,80.73,80.73,134.73,80.73,77.74,77.74,77.74,25.74,129.74,77.74,25.74,25.74,129.74,129.74,25.74,129.74,77.74,25.74,129.74,77.74,77.74,25.74,129.74,77.74,129.74,25.74,129.74,77.74,24.75,74.75,24.75,24.75,74.75,74.75,124.75,124.75,74.75,74.75,74.75,74.75,24.75,24.75,74.75,124.75,74.75,24.75,124.75,74.75,124.75,24.75,24.75,24.75,24.75,124.75,24.75,71.76,119.76,23.76,23.76,71.76,23.76,23.76,119.76,71.76,23.76,119.76,71.76,119.76,119.76,71.76,71.76,23.76,23.76,71.76,119.76,23.76,23.76,23.76,23.76,119.76,23.76,71.76,71.76,71.76,119.76,23.76,23.76,23.76,114.77,22.77,114.77,22.77,68.77,114.77,114.77,114.77,68.77,22.77,22.77,68.77,114.77,68.77,114.77,114.77,114.77,68.77,114.77,22.77,68.77,68.77,22.77,22.77,68.77,114.77,114.77,68.77,22.77,22.77,114.77,68.77,114.77,22.77,68.77,114.77,21.78,21.78,109.78,21.78,21.78,109.78,21.78,21.78,109.78,65.78,109.78,109.78,65.78,109.78,21.78,109.78,109.78,21.78,65.78,65.78,109.78,109.78,109.78,109.78,21.78,65.78,65.78,21.78,65.78,65.78,109.78,109.78,109.78,21.78,65.78,65.78,21.78,65.78,21.78,104.79,104.79,62.79,104.79,20.79,20.79,20.79,20.79,62.79,104.79,20.79,20.79,62.79,20.79,104.79,62.79,20.79,20.79,20.79,20.79,62.79,62.79,62.79,104.79,62.79,20.79,62.79,62.79,62.79,20.79,62.79,20.79,20.79,62.79,20.79,62.79,20.79,20.79,104.79,104.79,20.79,62.79,20.79,20.79,62.79,104.79,104.79,104.79,62.79,20.79,104.79,20.79,99.8,99.8,99.8,99.8,59.8,59.8,99.8,99.8,19.8,19.8,19.8,59.8,59.8,99.8,59.8,19.8,19.8,99.8,19.8,99.8,19.8,99.8,99.8,19.8,59.8,59.8,19.8,19.8,59.8,19.8,19.8,99.8,19.8,99.8,59.8,99.8,19.8,59.8,59.8,99.8,59.8,19.8,99.8,18.81,18.81,94.81,94.81,56.81,18.81,18.81,56.81,18.81,56.81,56.81,56.81,18.81,94.81,18.81,94.81,94.81,18.81,94.81,94.81,18.81,18.81,94.81,56.81,56.81,18.81,18.81,18.81,18.81,56.81,94.81,94.81,94.81,94.81,18.81,18.81,94.81,56.81,18.81,18.81,18.81,18.81,18.81,56.81,18.81,17.82,53.82,53.82,89.82,53.82,89.82,89.82,17.82,53.82,53.82,89.82,17.82,53.82,53.82,53.82,89.82,17.82,17.82,89.82,53.82,53.82,53.82,17.82,89.82,89.82,53.82,53.82,53.82,53.82,89.82,53.82,17.82,89.82,89.82,17.82,53.82,17.82,53.82,89.82,53.82,17.82,89.82,89.82,16.83,16.83,84.83,84.83,50.83,84.83,16.83,50.83,16.83,50.83,84.83,16.83,84.83,50.83,84.83,16.83,50.83,84.83,84.83,50.83,84.83,50.83,16.83,84.83,84.83,50.83,50.83,50.83,50.83,16.83,50.83,16.83,84.83,84.83,84.83,84.83,84.83,50.83,84.83,84.83,50.83,16.83,50.83,16.83,16.83,50.83,16.83,84.83,16.83,79.84,15.84,47.84,47.84,47.84,15.84,15.84,47.84,15.84,47.84,79.84,79.84,47.84,79.84,79.84,15.84,15.84,15.84,79.84,15.84,15.84,47.84,79.84,47.84,15.84,47.84,79.84,47.84,15.84,79.84,15.84,47.84,15.84,47.84,79.84,47.84,15.84,47.84,47.84,79.84,47.84,79.84,79.84,79.84,79.84,47.84,79.84,15.84,79.84,79.84,79.84,79.84,15.84,15.84,44.85,74.85,74.85,74.85,74.85,14.85,44.85,44.85,44.85,74.85,44.85,44.85,74.85,14.85,74.85,74.85,44.85,44.85,74.85,14.85,44.85,74.85,44.85,44.85,44.85,74.85,14.85,44.85,14.85,44.85,14.85,14.85,74.85,74.85,14.85,44.85,44.85,44.85,14.85,14.85,44.85,14.85,74.85,74.85,44.85,14.85,14.85,14.85,14.85,44.85,44.85,13.86,41.86,41.86,13.86,69.86,41.86,13.86,41.86,13.86,69.86,69.86,13.86,69.86,69.86,41.86,69.86,41.86,41.86,41.86,13.86,41.86,13.86,69.86,13.86,69.86,13.86,69.86,13.86,69.86,69.86,41.86,41.86,13.86,41.86,41.86,13.86,41.86,41.86,41.86,13.86,69.86,13.86,41.86,69.86,41.86,41.86,69.86,38.87,12.87,38.87,12.87,12.87,38.87,64.87,64.87,64.87,64.87,64.87,12.87,12.87,12.87,12.87,12.87,64.87,12.87,64.87,12.87,64.87,64.87,38.87,38.87,38.87,12.87,12.87,12.87,64.87,12.87,38.87,12.87,64.87,38.87,64.87,38.87,64.87,38.87,64.87,12.87,64.87,12.87,64.87,38.87,64.87,38.87,38.87,64.87,64.87,38.87,12.87,64.87,11.88,11.88,35.88,11.88,59.88,35.88,11.88,11.88,35.88,11.88,35.88,11.88,35.88,59.88,35.88,59.88,59.88,59.88,35.88,59.88,11.88,35.88,59.88,59.88,35.88,35.88,35.88,11.88,59.88,35.88,35.88,11.88,59.88,35.88,59.88,11.88,10.89,10.89,10.89,10.89,54.89,54.89,54.89,32.89,54.89,32.89,32.89,54.89,32.89,54.89,10.89,32.89,54.89,54.89,54.89,10.89,54.89,10.89,10.89,10.89,54.89,54.89,10.89,54.89,10.89,10.89,54.89,54.89,54.89,54.89,10.89,32.89,10.89,32.89,32.89,9.9,9.9,49.9,29.9,29.9,9.9,29.9,9.9,29.9,29.9,49.9,49.9,9.9,9.9,49.9,29.9,29.9,49.9,29.9,29.9,29.9,9.9,9.9,49.9,49.9,49.9,49.9,49.9,29.9,49.9,9.9,29.9,9.9,9.9,9.9,29.9,29.9,9.9,44.91,8.91,44.91,26.91,8.91,26.91,44.91,8.91,44.91,44.91,8.91,44.91,26.91,44.91,44.91,26.91,44.91,8.91,26.91,26.91,26.91,8.91,44.91,8.91,26.91,26.91,44.91,44.91,26.91,44.91,44.91,26.91,26.91,44.91,44.91,8.91,8.91,26.91,44.91,8.91,44.91,44.91,8.91,44.91,7.92,7.92,7.92,23.92,7.92,39.92,23.92,7.92,39.92,39.92,7.92,23.92,7.92,23.92,23.92,7.92,23.92,7.92,39.92,23.92,39.92,7.92,23.92,7.92,23.92,39.92,7.92,23.92,7.92,23.92,39.92,7.92,39.92,7.92,23.92,23.92,34.93,34.93,34.93,20.93,6.93,6.93,20.93,20.93,34.93,34.93,34.93,6.93,20.93,34.93,6.93,34.93,6.93,34.93,6.93,6.93,34.93,20.93,34.93,34.93,6.93,20.93,6.93,34.93,20.93,34.93,20.93,20.93,6.93,20.93,20.93,6.93,20.93,6.93,17.94,17.94,29.94,29.94,5.94,5.94,17.94,29.94,29.94,5.94,5.94,29.94,29.94,17.94,29.94,5.94,29.94,17.94,5.94,29.94,17.94,17.94,17.94,5.94,5.94,17.94,5.94,5.94,29.94,5.94,29.94,4.95,24.95,24.95,14.95,14.95,14.95,24.95,14.95,14.95,24.95,14.95,24.95,14.95,14.95,19.96,11.96,11.96,4.99]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>film_id<\/th>\n      <th>title<\/th>\n      <th>rental_rate<\/th>\n      <th>count<\/th>\n      <th>rental_amt<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="what-is-the-rental-distributiondvd-for-the-top-two-rented-films-1" class="section level3">
<h3><span class="header-section-number">25.1.10</span> 11 What is the rental distribution/DVD for the top two rented films?</h3>
<p>From the previous exercise we know that the top two films are <code>Bucket Brotherhood</code> and <code>Rocketeer Mother</code>.</p>
<p>To answer this question we look at the <code>rental</code>, <code>inventory</code>, and <code>film</code> tables again.</p>
<p>Instead of looking at the film level, we need to drill down to the individual dvd’s for each film to answer this question.</p>
<div class="sourceCode" id="cb531"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb531-1" data-line-number="1">film_rank2_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb531-2" data-line-number="2"><span class="st">&quot;select i.store_id,i.film_id,f.title,i.inventory_id,count(*) </span></a>
<a class="sourceLine" id="cb531-3" data-line-number="3"><span class="st">   from rental r join inventory i on r.inventory_id = i.inventory_id </span></a>
<a class="sourceLine" id="cb531-4" data-line-number="4"><span class="st">        join film f on i.film_id = f.film_id</span></a>
<a class="sourceLine" id="cb531-5" data-line-number="5"><span class="st">  where i.film_id in (103,738)</span></a>
<a class="sourceLine" id="cb531-6" data-line-number="6"><span class="st">group by i.store_id,i.film_id,f.title,i.inventory_id&quot;</span>)</a>
<a class="sourceLine" id="cb531-7" data-line-number="7"></a>
<a class="sourceLine" id="cb531-8" data-line-number="8"><span class="kw">sp_print_df</span>(film_rank2_sql)</a></code></pre></div>
<div id="htmlwidget-6c084255227fcd56827e" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6c084255227fcd56827e">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16"],[2,2,1,1,1,2,1,2,2,1,1,1,1,2,2,2],[738,738,738,738,103,738,738,103,103,103,738,103,103,738,103,103],["Rocketeer Mother","Rocketeer Mother","Rocketeer Mother","Rocketeer Mother","Bucket Brotherhood","Rocketeer Mother","Rocketeer Mother","Bucket Brotherhood","Bucket Brotherhood","Bucket Brotherhood","Rocketeer Mother","Bucket Brotherhood","Bucket Brotherhood","Rocketeer Mother","Bucket Brotherhood","Bucket Brotherhood"],[3367,3364,3361,3362,465,3365,3363,472,470,468,3360,467,466,3366,469,471],[5,5,3,2,3,4,5,2,5,5,5,4,5,4,5,5]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>store_id<\/th>\n      <th>film_id<\/th>\n      <th>title<\/th>\n      <th>inventory_id<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>The ‘Bucket Brotherhood’ and ‘Rocketeer Mother’ DVD’s are equally distributed between the two stores, 4 dvd’s each per film. The ‘Bucket Brotherhood’ was rented 17 times from both stores. The ‘Rocketeer Mother’ was rented 15 times from store 1 and 18 times from store 2.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-42" class="section level4">
<h4><span class="header-section-number">25.1.10.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb532"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb532-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb532-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb532-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb532-4" data-line-number="4"></a>
<a class="sourceLine" id="cb532-5" data-line-number="5">film_rank2_dplyr &lt;-<span class="st"> </span>rental_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb532-6" data-line-number="6"><span class="st">    </span><span class="kw">inner_join</span>(inventory_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;inventory_id&quot;</span> =<span class="st"> &quot;inventory_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.r&quot;</span>, <span class="st">&quot;.i&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb532-7" data-line-number="7"><span class="st">    </span><span class="kw">inner_join</span>(film_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;film_id&quot;</span> =<span class="st"> &quot;film_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.f&quot;</span>, <span class="st">&quot;.i&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb532-8" data-line-number="8"><span class="st">    </span><span class="kw">filter</span>(film_id <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">103</span>,<span class="dv">738</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb532-9" data-line-number="9"><span class="st">    </span><span class="kw">group_by</span>(store_id,film_id,title,inventory_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb532-10" data-line-number="10"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">count =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb532-11" data-line-number="11"><span class="st">    </span><span class="kw">arrange</span>(film_id,store_id,inventory_id) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb532-12" data-line-number="12"><span class="st">  </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb532-13" data-line-number="13"></a>
<a class="sourceLine" id="cb532-14" data-line-number="14"><span class="kw">sp_print_df</span>(film_rank2_dplyr)</a></code></pre></div>
<div id="htmlwidget-cc911bce9136bf4e7dfd" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-cc911bce9136bf4e7dfd">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16"],[1,1,1,1,2,2,2,2,1,1,1,1,2,2,2,2],[103,103,103,103,103,103,103,103,738,738,738,738,738,738,738,738],["Bucket Brotherhood","Bucket Brotherhood","Bucket Brotherhood","Bucket Brotherhood","Bucket Brotherhood","Bucket Brotherhood","Bucket Brotherhood","Bucket Brotherhood","Rocketeer Mother","Rocketeer Mother","Rocketeer Mother","Rocketeer Mother","Rocketeer Mother","Rocketeer Mother","Rocketeer Mother","Rocketeer Mother"],[465,466,467,468,469,470,471,472,3360,3361,3362,3363,3364,3365,3366,3367],[3,5,4,5,5,5,5,2,5,3,2,5,5,4,4,5]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>store_id<\/th>\n      <th>film_id<\/th>\n      <th>title<\/th>\n      <th>inventory_id<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="list-staffing-information-for-store-1-associated-with-the-bucket-brother-rentals-1" class="section level3">
<h3><span class="header-section-number">25.1.11</span> 12. List staffing information for store 1 associated with the <code>Bucket Brother</code> rentals?</h3>
<p>To answer this question we look at the <code>rental</code>, <code>inventory</code>, <code>film</code>, <code>staff</code>, <code>address</code>, <code>city</code>, and <code>country</code> tables.</p>
<div class="sourceCode" id="cb533"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb533-1" data-line-number="1">film_<span class="dv">103</span>_details_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb533-2" data-line-number="2"><span class="st">&quot;select i.store_id,i.film_id,f.title,i.inventory_id inv_id,i.store_id inv_store_id</span></a>
<a class="sourceLine" id="cb533-3" data-line-number="3"><span class="st">       ,r.rental_date::date rented,r.return_date::date returned</span></a>
<a class="sourceLine" id="cb533-4" data-line-number="4"><span class="st">       ,s.staff_id,s.store_id staff_store_id,concat(s.first_name,&#39; &#39;,s.last_name) staff,ctry.country</span></a>
<a class="sourceLine" id="cb533-5" data-line-number="5"><span class="st">   from rental r join inventory i on r.inventory_id = i.inventory_id </span></a>
<a class="sourceLine" id="cb533-6" data-line-number="6"><span class="st">        join film f on i.film_id = f.film_id</span></a>
<a class="sourceLine" id="cb533-7" data-line-number="7"><span class="st">        join staff s on r.staff_id = s.staff_id</span></a>
<a class="sourceLine" id="cb533-8" data-line-number="8"><span class="st">        join address a on s.address_id = a.address_id</span></a>
<a class="sourceLine" id="cb533-9" data-line-number="9"><span class="st">        join city c on a.city_id = c.city_id</span></a>
<a class="sourceLine" id="cb533-10" data-line-number="10"><span class="st">        join country ctry on c.country_id = ctry.country_id</span></a>
<a class="sourceLine" id="cb533-11" data-line-number="11"><span class="st">  where i.film_id in (103)</span></a>
<a class="sourceLine" id="cb533-12" data-line-number="12"><span class="st">    and r.rental_date::date between &#39;2005-05-01&#39;::date and &#39;2005-06-01&#39;::date</span></a>
<a class="sourceLine" id="cb533-13" data-line-number="13"><span class="st">order by r.rental_date</span></a>
<a class="sourceLine" id="cb533-14" data-line-number="14"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb533-15" data-line-number="15"><span class="kw">sp_print_df</span>(film_<span class="dv">103</span>_details_sql)</a></code></pre></div>
<div id="htmlwidget-6c3e37b0fa7ac693f7cc" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6c3e37b0fa7ac693f7cc">{"x":{"filter":"none","data":[["1","2","3","4","5"],[1,2,2,1,2],[103,103,103,103,103],["Bucket Brotherhood","Bucket Brotherhood","Bucket Brotherhood","Bucket Brotherhood","Bucket Brotherhood"],[466,470,471,468,469],[1,2,2,1,2],["2005-05-25","2005-05-25","2005-05-30","2005-05-31","2005-05-31"],["2005-05-27","2005-05-29","2005-06-05","2005-06-03","2005-06-02"],[1,1,1,2,2],[1,1,1,2,2],["Mike Hillyer","Mike Hillyer","Mike Hillyer","Jon Stephens","Jon Stephens"],["Canada","Canada","Canada","Australia","Australia"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>store_id<\/th>\n      <th>film_id<\/th>\n      <th>title<\/th>\n      <th>inv_id<\/th>\n      <th>inv_store_id<\/th>\n      <th>rented<\/th>\n      <th>returned<\/th>\n      <th>staff_id<\/th>\n      <th>staff_store_id<\/th>\n      <th>staff<\/th>\n      <th>country<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,4,5,8,9]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>In a previous exercise we saw that store 1 based in Canada and store 2 based in Austrailia each had one employee, staff_id 1 and 2 respectively. We see that Mike from store 1, Canada, had transactions in store 1 and store 2 on 5/25/2005. Similarly Jon from store 2, Australia, had transaction in store 2 and store 1 on 5/31/2005. Is this phsically possible, or a key in error?</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-43" class="section level4">
<h4><span class="header-section-number">25.1.11.1</span> Replicate the output above using dplyr syntax.</h4>
<table>
<thead>
<tr class="header">
<th>column</th>
<th>mapping</th>
<th>definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>inv_id</td>
<td>inventory.inventory_id</td>
<td></td>
</tr>
<tr class="even">
<td>inv_store_id</td>
<td>inventory.store_id</td>
<td></td>
</tr>
<tr class="odd">
<td>rented</td>
<td>rental.rental_date</td>
<td></td>
</tr>
<tr class="even">
<td>returned</td>
<td>rental.return_date</td>
<td></td>
</tr>
<tr class="odd">
<td>staff_store_id</td>
<td>store.store_id</td>
<td></td>
</tr>
<tr class="even">
<td>staff</td>
<td>first_name+last_name</td>
<td></td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb534"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb534-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb534-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb534-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb534-4" data-line-number="4"></a>
<a class="sourceLine" id="cb534-5" data-line-number="5">film_<span class="dv">103</span>_details_dplyr &lt;-<span class="st"> </span>inventory_table <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(film_id <span class="op">==</span><span class="st"> </span><span class="dv">103</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb534-6" data-line-number="6"><span class="st">  </span><span class="kw">inner_join</span>(film_table, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;film_id&#39;</span> =<span class="st"> &#39;film_id&#39;</span>),<span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&#39;.f&#39;</span>,<span class="st">&#39;r&#39;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb534-7" data-line-number="7"><span class="st">  </span><span class="kw">inner_join</span>(rental_table, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;inventory_id&#39;</span> =<span class="st"> &#39;inventory_id&#39;</span>),<span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&#39;.i&#39;</span>,<span class="st">&#39;r&#39;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb534-8" data-line-number="8"><span class="st">  </span><span class="kw">filter</span>(rental_date <span class="op">&lt;</span><span class="st"> &#39;2005-06-01&#39;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb534-9" data-line-number="9"><span class="st">  </span><span class="kw">inner_join</span>(staff_table, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;staff_id&#39;</span> =<span class="st"> &#39;staff_id&#39;</span>),<span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&#39;.x&#39;</span>,<span class="st">&#39;r&#39;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb534-10" data-line-number="10"><span class="st">  </span><span class="kw">inner_join</span>(address_table, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;address_id&#39;</span> =<span class="st"> &#39;address_id&#39;</span>),<span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&#39;.a&#39;</span>,<span class="st">&#39;r&#39;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb534-11" data-line-number="11"><span class="st">  </span><span class="kw">inner_join</span>(city_table, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;city_id&#39;</span> =<span class="st"> &#39;city_id&#39;</span>),<span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&#39;.c&#39;</span>,<span class="st">&#39;a&#39;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb534-12" data-line-number="12"><span class="st">  </span><span class="kw">inner_join</span>(country_table, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;country_id&#39;</span> =<span class="st"> &#39;country_id&#39;</span>),<span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&#39;.ctry&#39;</span>,<span class="st">&#39;city&#39;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb534-13" data-line-number="13"><span class="st">  </span><span class="kw">collect</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb534-14" data-line-number="14"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">rented =</span> <span class="kw">as.Date</span>(rental_date)</a>
<a class="sourceLine" id="cb534-15" data-line-number="15">        ,<span class="dt">returned =</span> <span class="kw">as.Date</span>(return_date)</a>
<a class="sourceLine" id="cb534-16" data-line-number="16">        ,<span class="dt">staff =</span> <span class="kw">paste0</span>(first_name,<span class="st">&#39; &#39;</span>,last_name)</a>
<a class="sourceLine" id="cb534-17" data-line-number="17">        ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb534-18" data-line-number="18"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">inv_store =</span> store_id.x</a>
<a class="sourceLine" id="cb534-19" data-line-number="19">        ,<span class="dt">staff_store_id=</span>store_id.y</a>
<a class="sourceLine" id="cb534-20" data-line-number="20">        ,<span class="dt">inv_id =</span> inventory_id</a>
<a class="sourceLine" id="cb534-21" data-line-number="21">        ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb534-22" data-line-number="22"><span class="st">  </span><span class="kw">select</span>(inv_store,film_id,title,inv_id,rented,returned,staff_id,staff_store_id</a>
<a class="sourceLine" id="cb534-23" data-line-number="23">         ,staff,country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb534-24" data-line-number="24"><span class="st">  </span><span class="kw">arrange</span>(rented) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb534-25" data-line-number="25"><span class="st">  </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb534-26" data-line-number="26"></a>
<a class="sourceLine" id="cb534-27" data-line-number="27"><span class="kw">sp_print_df</span>(film_<span class="dv">103</span>_details_dplyr)</a></code></pre></div>
<div id="htmlwidget-88984347109043009685" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-88984347109043009685">{"x":{"filter":"none","data":[["1","2","3","4","5"],[1,2,2,1,2],[103,103,103,103,103],["Bucket Brotherhood","Bucket Brotherhood","Bucket Brotherhood","Bucket Brotherhood","Bucket Brotherhood"],[466,470,471,468,469],["2005-05-25","2005-05-25","2005-05-30","2005-05-31","2005-05-31"],["2005-05-27","2005-05-29","2005-06-05","2005-06-03","2005-06-02"],[1,1,1,2,2],[1,1,1,2,2],["Mike Hillyer","Mike Hillyer","Mike Hillyer","Jon Stephens","Jon Stephens"],["Canada","Canada","Canada","Australia","Australia"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>inv_store<\/th>\n      <th>film_id<\/th>\n      <th>title<\/th>\n      <th>inv_id<\/th>\n      <th>rented<\/th>\n      <th>returned<\/th>\n      <th>staff_id<\/th>\n      <th>staff_store_id<\/th>\n      <th>staff<\/th>\n      <th>country<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,4,7,8]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="which-films-have-never-been-rented-1" class="section level3">
<h3><span class="header-section-number">25.1.12</span> 13. Which film(s) have never been rented</h3>
<p>To answer this question we look at the <code>film</code>, <code>inventory</code> and <code>rental</code> tables.</p>
<div class="sourceCode" id="cb535"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb535-1" data-line-number="1">never_rented_dvds_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb535-2" data-line-number="2"><span class="st">&#39;select i.store_id,f.film_id, f.title,f.description, i.inventory_id</span></a>
<a class="sourceLine" id="cb535-3" data-line-number="3"><span class="st">   from film f join inventory i on f.film_id = i.film_id</span></a>
<a class="sourceLine" id="cb535-4" data-line-number="4"><span class="st">        left join rental r on i.inventory_id = r.inventory_id </span></a>
<a class="sourceLine" id="cb535-5" data-line-number="5"><span class="st">  where r.inventory_id is null </span></a>
<a class="sourceLine" id="cb535-6" data-line-number="6"><span class="st">&#39;</span></a>
<a class="sourceLine" id="cb535-7" data-line-number="7">)</a>
<a class="sourceLine" id="cb535-8" data-line-number="8"></a>
<a class="sourceLine" id="cb535-9" data-line-number="9"><span class="kw">sp_print_df</span>(never_rented_dvds_sql)</a></code></pre></div>
<div id="htmlwidget-d80799441e19bf040cbf" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-d80799441e19bf040cbf">{"x":{"filter":"none","data":[["1","2"],[2,2],[1,1001],["Academy Dinosaur","Sophie's Choice"],["A Epic Drama of a Feminist And a Mad Scientist who must Battle a Teacher in The Canadian Rockies","orphaned language_id=10"],[5,4583]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>store_id<\/th>\n      <th>film_id<\/th>\n      <th>title<\/th>\n      <th>description<\/th>\n      <th>inventory_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>There are only two movies that have not been rented, Academy Dinousaur and Sophie’s Choice.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-44" class="section level4">
<h4><span class="header-section-number">25.1.12.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb536"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb536-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb536-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb536-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb536-4" data-line-number="4"></a>
<a class="sourceLine" id="cb536-5" data-line-number="5">never_rented_dvds_dplyr &lt;-<span class="st"> </span>film_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb536-6" data-line-number="6"><span class="st">    </span><span class="kw">inner_join</span>(inventory_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;film_id&quot;</span> =<span class="st"> &quot;film_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.f&quot;</span>, <span class="st">&quot;.i&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb536-7" data-line-number="7"><span class="st">    </span><span class="kw">anti_join</span>(rental_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&#39;inventory_id&#39;</span>,<span class="st">&#39;inventory_id&#39;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&#39;.i&#39;</span>,<span class="st">&#39;.r&#39;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb536-8" data-line-number="8"><span class="st">    </span><span class="kw">select</span>(film_id,title,description,inventory_id) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb536-9" data-line-number="9"><span class="st">  </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb536-10" data-line-number="10"></a>
<a class="sourceLine" id="cb536-11" data-line-number="11"><span class="kw">sp_print_df</span>(never_rented_dvds_dplyr)</a></code></pre></div>
<div id="htmlwidget-5bc260cc0681d28b4458" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5bc260cc0681d28b4458">{"x":{"filter":"none","data":[["1","2"],[1,1001],["Academy Dinosaur","Sophie's Choice"],["A Epic Drama of a Feminist And a Mad Scientist who must Battle a Teacher in The Canadian Rockies","orphaned language_id=10"],[5,4583]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>film_id<\/th>\n      <th>title<\/th>\n      <th>description<\/th>\n      <th>inventory_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="how-many-films-are-in-each-film-rating-1" class="section level3">
<h3><span class="header-section-number">25.1.13</span> 14. How many films are in each film rating?</h3>
<p>To answer this question we look at the <code>film</code> table to answer this question.</p>
<div class="sourceCode" id="cb537"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb537-1" data-line-number="1">film_ratings_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb537-2" data-line-number="2"><span class="st">&#39;select f.rating,count(*)</span></a>
<a class="sourceLine" id="cb537-3" data-line-number="3"><span class="st">   from film f </span></a>
<a class="sourceLine" id="cb537-4" data-line-number="4"><span class="st">group by f.rating</span></a>
<a class="sourceLine" id="cb537-5" data-line-number="5"><span class="st">order by count(*) desc</span></a>
<a class="sourceLine" id="cb537-6" data-line-number="6"><span class="st">&#39;</span></a>
<a class="sourceLine" id="cb537-7" data-line-number="7">)</a>
<a class="sourceLine" id="cb537-8" data-line-number="8"></a>
<a class="sourceLine" id="cb537-9" data-line-number="9"><span class="kw">sp_print_df</span>(film_ratings_sql)</a></code></pre></div>
<div id="htmlwidget-5e6debc8bc477449b2d2" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5e6debc8bc477449b2d2">{"x":{"filter":"none","data":[["1","2","3","4","5"],["PG-13","NC-17","R","PG","G"],[223,210,195,195,178]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>rating<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":2},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>There are 5 ratings and all 5 have roughly 200 movies.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-45" class="section level4">
<h4><span class="header-section-number">25.1.13.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb538"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb538-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb538-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb538-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb538-4" data-line-number="4"></a>
<a class="sourceLine" id="cb538-5" data-line-number="5">film_ratings_dplyr &lt;-<span class="st"> </span>film_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb538-6" data-line-number="6"><span class="st">  </span><span class="kw">group_by</span>(rating) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb538-7" data-line-number="7"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">count=</span><span class="kw">n</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb538-8" data-line-number="8"><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(count))<span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb538-9" data-line-number="9"><span class="st">  </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb538-10" data-line-number="10"></a>
<a class="sourceLine" id="cb538-11" data-line-number="11"><span class="kw">sp_print_df</span>(film_ratings_dplyr)</a></code></pre></div>
<div id="htmlwidget-a769f33e9bc2b11da24f" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-a769f33e9bc2b11da24f">{"x":{"filter":"none","data":[["1","2","3","4","5"],["PG-13","NC-17","R","PG","G"],[223,210,195,195,178]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>rating<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":2},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="what-are-the-different-film-categories-1" class="section level3">
<h3><span class="header-section-number">25.1.14</span> 15. What are the different film categories?</h3>
<p>To answer this question we look at the <code>category</code> table to answer this question.</p>
<div class="sourceCode" id="cb539"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb539-1" data-line-number="1">film_categories_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb539-2" data-line-number="2"><span class="st">&#39;select * from category&#39;</span></a>
<a class="sourceLine" id="cb539-3" data-line-number="3">)</a>
<a class="sourceLine" id="cb539-4" data-line-number="4"></a>
<a class="sourceLine" id="cb539-5" data-line-number="5"><span class="kw">sp_print_df</span>(film_categories_sql)</a></code></pre></div>
<div id="htmlwidget-5afb8971f37330fd8cc4" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5afb8971f37330fd8cc4">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16"],[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16],["Action","Animation","Children","Classics","Comedy","Documentary","Drama","Family","Foreign","Games","Horror","Music","New","Sci-Fi","Sports","Travel"],["2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>category_id<\/th>\n      <th>name<\/th>\n      <th>last_update<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":1},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>There are 16 different categories</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-46" class="section level4">
<h4><span class="header-section-number">25.1.14.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb540"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb540-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb540-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb540-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb540-4" data-line-number="4"></a>
<a class="sourceLine" id="cb540-5" data-line-number="5">film_categories_dplyr &lt;-<span class="st"> </span>category_table <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb540-6" data-line-number="6"><span class="st">  </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb540-7" data-line-number="7"></a>
<a class="sourceLine" id="cb540-8" data-line-number="8"><span class="kw">sp_print_df</span>(film_categories_dplyr)</a></code></pre></div>
<div id="htmlwidget-e9ae68682532316859d5" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-e9ae68682532316859d5">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16"],[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16],["Action","Animation","Children","Classics","Comedy","Documentary","Drama","Family","Foreign","Games","Horror","Music","New","Sci-Fi","Sports","Travel"],["2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z","2006-02-15T17:46:27Z"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>category_id<\/th>\n      <th>name<\/th>\n      <th>last_update<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":1},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="how-many-dvds-are-in-each-film-categeory-1" class="section level3">
<h3><span class="header-section-number">25.1.15</span> 16. How many DVD’s are in each film categeory?</h3>
<p>To answer this question we look at the <code>category</code> table again.</p>
<div class="sourceCode" id="cb541"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb541-1" data-line-number="1">film_categories2_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb541-2" data-line-number="2"><span class="st">&#39;select c.name,count(*) count</span></a>
<a class="sourceLine" id="cb541-3" data-line-number="3"><span class="st">   from category c join film_category fc on c.category_id = fc.category_id</span></a>
<a class="sourceLine" id="cb541-4" data-line-number="4"><span class="st">group by c.name</span></a>
<a class="sourceLine" id="cb541-5" data-line-number="5"><span class="st">order by count(*) desc</span></a>
<a class="sourceLine" id="cb541-6" data-line-number="6"><span class="st">&#39;</span></a>
<a class="sourceLine" id="cb541-7" data-line-number="7">)</a>
<a class="sourceLine" id="cb541-8" data-line-number="8"></a>
<a class="sourceLine" id="cb541-9" data-line-number="9"><span class="kw">sp_print_df</span>(film_categories2_sql)</a></code></pre></div>
<div id="htmlwidget-32dc6527565d6d2fa8eb" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-32dc6527565d6d2fa8eb">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16"],["Sports","Foreign","Family","Documentary","Animation","Action","New","Drama","Sci-Fi","Games","Children","Comedy","Travel","Classics","Horror","Music"],[74,73,69,69,66,64,63,63,61,61,60,58,57,57,56,51]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>name<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":2},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>There are 16 film categories. The highest category, Sports, has 77 films followed by the International category which has 76 film. What is an example of an international category film where all films are currently in English?</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-47" class="section level4">
<h4><span class="header-section-number">25.1.15.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb542"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb542-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb542-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb542-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb542-4" data-line-number="4"></a>
<a class="sourceLine" id="cb542-5" data-line-number="5">film_categories2_dplyr &lt;-<span class="st"> </span>category_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb542-6" data-line-number="6"><span class="st">  </span><span class="kw">inner_join</span>(film_category_table, <span class="dt">by =</span><span class="kw">c</span>(<span class="st">&#39;category_id&#39;</span>=<span class="st">&#39;category_id&#39;</span>) </a>
<a class="sourceLine" id="cb542-7" data-line-number="7">            ,<span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&#39;.c&#39;</span>,<span class="st">&#39;.fc&#39;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb542-8" data-line-number="8"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb542-9" data-line-number="9"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">count=</span><span class="kw">n</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb542-10" data-line-number="10"><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(count)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb542-11" data-line-number="11"><span class="st">  </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb542-12" data-line-number="12"></a>
<a class="sourceLine" id="cb542-13" data-line-number="13"><span class="kw">sp_print_df</span>(film_categories2_dplyr)</a></code></pre></div>
<div id="htmlwidget-bbe1f43178625f07ed69" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-bbe1f43178625f07ed69">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16"],["Sports","Foreign","Family","Documentary","Animation","Action","New","Drama","Sci-Fi","Games","Children","Comedy","Travel","Classics","Horror","Music"],[74,73,69,69,66,64,63,63,61,61,60,58,57,57,56,51]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>name<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":2},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="which-films-are-listed-in-multiple-categories-1" class="section level3">
<h3><span class="header-section-number">25.1.16</span> 17. Which films are listed in multiple categories?</h3>
<p>To answer this question we look at the <code>film</code>, <code>film_category</code> and <code>category</code> tables.</p>
<div class="sourceCode" id="cb543"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb543-1" data-line-number="1">multiple_categories_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb543-2" data-line-number="2"><span class="st">&#39;select f.film_id, f.title,c.name</span></a>
<a class="sourceLine" id="cb543-3" data-line-number="3"><span class="st">   from film_category fc join film f on fc.film_id = f.film_id</span></a>
<a class="sourceLine" id="cb543-4" data-line-number="4"><span class="st">        join category c on fc.category_id = c.category_id</span></a>
<a class="sourceLine" id="cb543-5" data-line-number="5"><span class="st">  where fc.film_id in (select fc.film_id</span></a>
<a class="sourceLine" id="cb543-6" data-line-number="6"><span class="st">                         from film f join film_category fc on f.film_id = fc.film_id</span></a>
<a class="sourceLine" id="cb543-7" data-line-number="7"><span class="st">                       group by fc.film_id</span></a>
<a class="sourceLine" id="cb543-8" data-line-number="8"><span class="st">                       having count(*) &gt; 1</span></a>
<a class="sourceLine" id="cb543-9" data-line-number="9"><span class="st">                       ) </span></a>
<a class="sourceLine" id="cb543-10" data-line-number="10"><span class="st">&#39;</span></a>
<a class="sourceLine" id="cb543-11" data-line-number="11">)</a>
<a class="sourceLine" id="cb543-12" data-line-number="12"></a>
<a class="sourceLine" id="cb543-13" data-line-number="13"><span class="kw">sp_print_df</span>(multiple_categories_sql)</a></code></pre></div>
<div id="htmlwidget-f44584fa5e4f08aaeb0b" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-f44584fa5e4f08aaeb0b">{"x":{"filter":"none","data":[["1","2"],[1001,1001],["Sophie's Choice","Sophie's Choice"],["Documentary","Drama"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>film_id<\/th>\n      <th>title<\/th>\n      <th>name<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":1},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>There is only one film which has two categories, Sophie’s Choice.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-48" class="section level4">
<h4><span class="header-section-number">25.1.16.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb544"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb544-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb544-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb544-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb544-4" data-line-number="4"></a>
<a class="sourceLine" id="cb544-5" data-line-number="5">multiple_categories_dplyr &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb544-6" data-line-number="6"><span class="st">  </span><span class="co"># compute films with multiple categories</span></a>
<a class="sourceLine" id="cb544-7" data-line-number="7"><span class="st">  </span>film_table <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb544-8" data-line-number="8"><span class="st">    </span><span class="kw">inner_join</span>(film_category_table,<span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;film_id&#39;</span>=<span class="st">&#39;film_id&#39;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&#39;.f&#39;</span>,<span class="st">&#39;.fc&#39;</span>))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb544-9" data-line-number="9"><span class="st">    </span><span class="kw">group_by</span>(film_id,title) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb544-10" data-line-number="10"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">count=</span><span class="kw">n</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb544-11" data-line-number="11"><span class="st">    </span><span class="kw">filter</span>(count <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb544-12" data-line-number="12"><span class="st">  </span><span class="co"># get the category ids</span></a>
<a class="sourceLine" id="cb544-13" data-line-number="13"><span class="st">  </span><span class="kw">inner_join</span>(film_category_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&#39;film_id&#39;</span>=<span class="st">&#39;film_id&#39;</span>),<span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&#39;.f&#39;</span>,<span class="st">&#39;.fc&#39;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb544-14" data-line-number="14"><span class="st">  </span><span class="co"># get the category names</span></a>
<a class="sourceLine" id="cb544-15" data-line-number="15"><span class="st">  </span><span class="kw">inner_join</span>(category_table, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;category_id&#39;</span>=<span class="st">&#39;category_id&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb544-16" data-line-number="16"><span class="st">  </span><span class="kw">select</span>(film_id,title,name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb544-17" data-line-number="17"><span class="st">  </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb544-18" data-line-number="18"></a>
<a class="sourceLine" id="cb544-19" data-line-number="19"><span class="kw">sp_print_df</span>(multiple_categories_dplyr)</a></code></pre></div>
<div id="htmlwidget-33be21b5fff197bb7cc4" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-33be21b5fff197bb7cc4">{"x":{"filter":"none","data":[["1","2"],[1001,1001],["Sophie's Choice","Sophie's Choice"],["Documentary","Drama"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>film_id<\/th>\n      <th>title<\/th>\n      <th>name<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":1},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="which-dvds-are-in-one-stores-inventory-but-not-the-other-1" class="section level3">
<h3><span class="header-section-number">25.1.17</span> 18. Which DVD’s are in one store’s inventory but not the other</h3>
<p>In the table below we show the first 10 rows.</p>
<p>To answer this question we look at the <code>inventory</code> and <code>film</code> tables.</p>
<div class="sourceCode" id="cb545"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb545-1" data-line-number="1">dvd_in_<span class="dv">1</span>_store_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb545-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb545-3" data-line-number="3">  <span class="st">&quot;</span></a>
<a class="sourceLine" id="cb545-4" data-line-number="4"><span class="st">--   select store1,count(count1) films_not_in_store_2,sum(coalesce(count1,0)) dvds_not_in_store_1</span></a>
<a class="sourceLine" id="cb545-5" data-line-number="5"><span class="st">--         ,store2,count(count2) films_not_in_store_1,sum(coalesce(count2,0)) dvds_not_in_store_2</span></a>
<a class="sourceLine" id="cb545-6" data-line-number="6"><span class="st">--     from (</span></a>
<a class="sourceLine" id="cb545-7" data-line-number="7"><span class="st">             select coalesce(i1.film_id,i2.film_id) film_id,f.title,f.rental_rate</span></a>
<a class="sourceLine" id="cb545-8" data-line-number="8"><span class="st">                   ,1 store1,coalesce(i1.count,0) count1</span></a>
<a class="sourceLine" id="cb545-9" data-line-number="9"><span class="st">                   ,2 store2,coalesce(i2.count,0) count2</span></a>
<a class="sourceLine" id="cb545-10" data-line-number="10"><span class="st">                  -- dvd inventory in store 1</span></a>
<a class="sourceLine" id="cb545-11" data-line-number="11"><span class="st">               from (select film_id,store_id,count(*) count </span></a>
<a class="sourceLine" id="cb545-12" data-line-number="12"><span class="st">                       from inventory where store_id = 1 </span></a>
<a class="sourceLine" id="cb545-13" data-line-number="13"><span class="st">                      group by film_id,store_id</span></a>
<a class="sourceLine" id="cb545-14" data-line-number="14"><span class="st">                    ) as i1</span></a>
<a class="sourceLine" id="cb545-15" data-line-number="15"><span class="st">                    full outer join </span></a>
<a class="sourceLine" id="cb545-16" data-line-number="16"><span class="st">                  -- dvd inventory in store 2</span></a>
<a class="sourceLine" id="cb545-17" data-line-number="17"><span class="st">                    (select film_id,store_id,count(*) count</span></a>
<a class="sourceLine" id="cb545-18" data-line-number="18"><span class="st">                       from inventory where store_id = 2 </span></a>
<a class="sourceLine" id="cb545-19" data-line-number="19"><span class="st">                     group by film_id,store_id</span></a>
<a class="sourceLine" id="cb545-20" data-line-number="20"><span class="st">                    ) as i2</span></a>
<a class="sourceLine" id="cb545-21" data-line-number="21"><span class="st">                 on i1.film_id = i2.film_id </span></a>
<a class="sourceLine" id="cb545-22" data-line-number="22"><span class="st">               join film f </span></a>
<a class="sourceLine" id="cb545-23" data-line-number="23"><span class="st">                 on coalesce(i1.film_id,i2.film_id) = f.film_id</span></a>
<a class="sourceLine" id="cb545-24" data-line-number="24"><span class="st">             where i1.film_id is null or i2.film_id is null</span></a>
<a class="sourceLine" id="cb545-25" data-line-number="25"><span class="st">             order by f.title  </span></a>
<a class="sourceLine" id="cb545-26" data-line-number="26"><span class="st">--          ) as src</span></a>
<a class="sourceLine" id="cb545-27" data-line-number="27"><span class="st">--    group by store1,store2</span></a>
<a class="sourceLine" id="cb545-28" data-line-number="28"><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb545-29" data-line-number="29">)</a>
<a class="sourceLine" id="cb545-30" data-line-number="30"><span class="cf">if</span>(HEAD_N <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb545-31" data-line-number="31">    <span class="kw">sp_print_df</span>(<span class="kw">head</span>(dvd_in_<span class="dv">1</span>_store_sql,<span class="dt">n=</span>HEAD_N))</a>
<a class="sourceLine" id="cb545-32" data-line-number="32">} <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb545-33" data-line-number="33">    <span class="kw">sp_print_df</span>(dvd_in_<span class="dv">1</span>_store_sql)</a>
<a class="sourceLine" id="cb545-34" data-line-number="34">}</a></code></pre></div>
<div id="htmlwidget-008e7554d5faa93bd1b9" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-008e7554d5faa93bd1b9">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10"],[2,3,5,8,13,20,24,27,28,29],["Ace Goldfinger","Adaptation Holes","African Egg","Airport Pollock","Ali Forever","Amelie Hellfighters","Analyze Hoosiers","Anonymous Human","Anthem Luke","Antitrust Tomatoes"],[4.99,2.99,2.99,4.99,4.99,4.99,2.99,0.99,4.99,2.99],[1,1,1,1,1,1,1,1,1,1],[0,0,0,0,0,3,4,4,3,2],[2,2,2,2,2,2,2,2,2,2],[3,4,3,4,4,0,0,0,0,0]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>film_id<\/th>\n      <th>title<\/th>\n      <th>rental_rate<\/th>\n      <th>store1<\/th>\n      <th>count1<\/th>\n      <th>store2<\/th>\n      <th>count2<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3,4,5,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>Store 1 has 196 films, (576 dvd’s), that are not in store 2. Store 2 has 199 films, (607 dvd’s), that are not in store 1.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-49" class="section level4">
<h4><span class="header-section-number">25.1.17.1</span> Replicate the output above using dplyr syntax.</h4>
<blockquote>
<p>The following chunk doesn’t work.. Multiple problems with it.</p>
</blockquote>
<div class="sourceCode" id="cb546"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb546-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb546-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb546-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb546-4" data-line-number="4"></a>
<a class="sourceLine" id="cb546-5" data-line-number="5">inv_tbl1 &lt;-<span class="st"> </span>inventory_table <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb546-6" data-line-number="6"><span class="st">    </span><span class="kw">filter</span>(store_id <span class="op">==</span><span class="st"> </span><span class="dv">1</span> ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb546-7" data-line-number="7"><span class="st">    </span><span class="kw">group_by</span>(film_id) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb546-8" data-line-number="8"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">count=</span><span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb546-9" data-line-number="9"><span class="st">  </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb546-10" data-line-number="10"></a>
<a class="sourceLine" id="cb546-11" data-line-number="11">inv_tbl2 &lt;-<span class="st"> </span>inventory_table <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb546-12" data-line-number="12"><span class="st">    </span><span class="kw">filter</span>(store_id <span class="op">==</span><span class="st"> </span><span class="dv">2</span> ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb546-13" data-line-number="13"><span class="st">    </span><span class="kw">group_by</span>(film_id) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb546-14" data-line-number="14"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">count=</span><span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb546-15" data-line-number="15"><span class="st">  </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb546-16" data-line-number="16"></a>
<a class="sourceLine" id="cb546-17" data-line-number="17">dvd_in_<span class="dv">1</span>_store_dplyr &lt;-<span class="st"> </span>inv_tbl1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb546-18" data-line-number="18"><span class="st">    </span><span class="kw">full_join</span>(inv_tbl2, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;film_id&#39;</span>,<span class="st">&#39;film_id&#39;</span>), <span class="dt">suffix =</span> (<span class="kw">c</span>(<span class="st">&#39;.i1&#39;</span>,<span class="st">&#39;.i2&#39;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb546-19" data-line-number="19"><span class="st">    </span><span class="kw">filter</span>(<span class="kw">is.na</span>(count.i1) <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(count.i2)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb546-20" data-line-number="20"><span class="co">#    filter(is.na(count.x + count.y)) %&gt;%   #this works also    </span></a>
<a class="sourceLine" id="cb546-21" data-line-number="21"><span class="st">    </span><span class="kw">mutate_all</span>(<span class="kw">list</span>(<span class="op">~</span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(.), <span class="dv">0</span>, .))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb546-22" data-line-number="22"><span class="st">    </span><span class="kw">inner_join</span>(film_table,<span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;film_id&#39;</span>,<span class="st">&#39;film_id&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb546-23" data-line-number="23"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">store_id1 =</span> <span class="dv">1</span>, <span class="dt">store_id2 =</span> <span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb546-24" data-line-number="24"><span class="st">    </span><span class="kw">select</span> (film_id,title,rental_rate,store_id1,count.x,store_id2,count.y) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb546-25" data-line-number="25"><span class="st">    </span><span class="kw">arrange</span>(film_id) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb546-26" data-line-number="26"><span class="st">  </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb546-27" data-line-number="27"></a>
<a class="sourceLine" id="cb546-28" data-line-number="28"><span class="cf">if</span>(HEAD_N <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb546-29" data-line-number="29">    <span class="kw">sp_print_df</span>(<span class="kw">head</span>(dvd_in_<span class="dv">1</span>_store_dplyr,<span class="dt">n=</span>HEAD_N))</a>
<a class="sourceLine" id="cb546-30" data-line-number="30">} <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb546-31" data-line-number="31">    <span class="kw">sp_print_df</span>(dvd_in_<span class="dv">1</span>_store_dplyr)</a>
<a class="sourceLine" id="cb546-32" data-line-number="32">}</a></code></pre></div>
</div>
</div>
<div id="which-films-are-not-tracked-in-inventory-1" class="section level3">
<h3><span class="header-section-number">25.1.18</span> 19. Which films are not tracked in inventory?</h3>
<p>To answer this question we look at the <code>film</code> and <code>rental</code> tables.</p>
<div class="sourceCode" id="cb547"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb547-1" data-line-number="1">films_no_inventory_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb547-2" data-line-number="2"><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb547-3" data-line-number="3"><span class="st">select f.film_id,title,rating,rental_rate,replacement_cost</span></a>
<a class="sourceLine" id="cb547-4" data-line-number="4"><span class="st">  from film f left outer join inventory i on f.film_id = i.film_id</span></a>
<a class="sourceLine" id="cb547-5" data-line-number="5"><span class="st"> where i.film_id is null;</span></a>
<a class="sourceLine" id="cb547-6" data-line-number="6"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb547-7" data-line-number="7"></a>
<a class="sourceLine" id="cb547-8" data-line-number="8"><span class="cf">if</span>(HEAD_N <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb547-9" data-line-number="9">    <span class="kw">sp_print_df</span>(<span class="kw">head</span>(films_no_inventory_sql,<span class="dt">n=</span>HEAD_N))</a>
<a class="sourceLine" id="cb547-10" data-line-number="10">} <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb547-11" data-line-number="11">    <span class="kw">sp_print_df</span>(films_no_inventory_sql)</a>
<a class="sourceLine" id="cb547-12" data-line-number="12">}</a></code></pre></div>
<div id="htmlwidget-f943e07c4e65c2196ba8" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-f943e07c4e65c2196ba8">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10"],[14,33,36,38,41,87,108,128,144,148],["Alice Fantasia","Apollo Teen","Argonauts Town","Ark Ridgemont","Arsenic Independence","Boondock Ballroom","Butch Panther","Catch Amistad","Chinatown Gladiator","Chocolate Duck"],["NC-17","PG-13","PG-13","NC-17","PG","NC-17","PG-13","G","PG","R"],[0.99,2.99,0.99,0.99,0.99,0.99,0.99,0.99,4.99,2.99],[23.99,15.99,12.99,25.99,17.99,14.99,19.99,10.99,24.99,13.99]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>film_id<\/th>\n      <th>title<\/th>\n      <th>rating<\/th>\n      <th>rental_rate<\/th>\n      <th>replacement_cost<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>There are 42 films that do not exist in inventory or in either store. These may be DVD’s that have been ordered but the business has not received them. Looking at the price and the replacement cost, it doesn’t look like there is any rhyme or reason to the setting of the price.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-50" class="section level4">
<h4><span class="header-section-number">25.1.18.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb548"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb548-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb548-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb548-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb548-4" data-line-number="4"></a>
<a class="sourceLine" id="cb548-5" data-line-number="5">films_no_inventory_dplyr &lt;-<span class="st"> </span>film_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb548-6" data-line-number="6"><span class="st">    </span><span class="kw">anti_join</span>(inventory_table, <span class="dt">by=</span>(<span class="kw">c</span>(<span class="st">&#39;film_id&#39;</span>=<span class="st">&#39;film_id&#39;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb548-7" data-line-number="7"><span class="st">    </span><span class="kw">select</span> (film_id,title,rating,rental_rate,replacement_cost) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb548-8" data-line-number="8"><span class="st">  </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb548-9" data-line-number="9"></a>
<a class="sourceLine" id="cb548-10" data-line-number="10"><span class="cf">if</span>(HEAD_N <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb548-11" data-line-number="11">    <span class="kw">sp_print_df</span>(<span class="kw">head</span>(films_no_inventory_dplyr,<span class="dt">n=</span>HEAD_N))</a>
<a class="sourceLine" id="cb548-12" data-line-number="12">} <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb548-13" data-line-number="13">    <span class="kw">sp_print_df</span>(films_no_inventory_dplyr)</a>
<a class="sourceLine" id="cb548-14" data-line-number="14">}</a></code></pre></div>
<div id="htmlwidget-4b34001b371daf31fcf2" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-4b34001b371daf31fcf2">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10"],[14,33,36,38,41,87,108,128,144,148],["Alice Fantasia","Apollo Teen","Argonauts Town","Ark Ridgemont","Arsenic Independence","Boondock Ballroom","Butch Panther","Catch Amistad","Chinatown Gladiator","Chocolate Duck"],["NC-17","PG-13","PG-13","NC-17","PG","NC-17","PG-13","G","PG","R"],[0.99,2.99,0.99,0.99,0.99,0.99,0.99,0.99,4.99,2.99],[23.99,15.99,12.99,25.99,17.99,14.99,19.99,10.99,24.99,13.99]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>film_id<\/th>\n      <th>title<\/th>\n      <th>rating<\/th>\n      <th>rental_rate<\/th>\n      <th>replacement_cost<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="list-film-categories-in-descending-accounts-receivable.-1" class="section level3">
<h3><span class="header-section-number">25.1.19</span> 20 List film categories in descending accounts receivable.</h3>
<p>To answer this question we look at the <code>rental</code>, <code>inventory</code>, <code>film</code>, <code>film_category</code> and <code>category</code> tables.</p>
<div class="sourceCode" id="cb549"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb549-1" data-line-number="1">film_category_AR_rank_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb549-2" data-line-number="2"><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb549-3" data-line-number="3"><span class="st">select category,AR</span></a>
<a class="sourceLine" id="cb549-4" data-line-number="4"><span class="st">       ,sum(AR) over (order by AR desc rows between unbounded preceding and current row) running_AR</span></a>
<a class="sourceLine" id="cb549-5" data-line-number="5"><span class="st">       ,rentals</span></a>
<a class="sourceLine" id="cb549-6" data-line-number="6"><span class="st">       ,sum(rentals) over (order by AR desc rows between unbounded preceding and current row) running_rentals</span></a>
<a class="sourceLine" id="cb549-7" data-line-number="7"><span class="st">  from (select c.name category, sum(f.rental_rate) AR, count(*) rentals</span></a>
<a class="sourceLine" id="cb549-8" data-line-number="8"><span class="st">          from rental r join inventory i on r.inventory_id = i.inventory_id </span></a>
<a class="sourceLine" id="cb549-9" data-line-number="9"><span class="st">               join film f on i.film_id = f.film_id</span></a>
<a class="sourceLine" id="cb549-10" data-line-number="10"><span class="st">               join film_category fc on f.film_id = fc.film_id</span></a>
<a class="sourceLine" id="cb549-11" data-line-number="11"><span class="st">               join category c on fc.category_id = c.category_id</span></a>
<a class="sourceLine" id="cb549-12" data-line-number="12"><span class="st">       group by c.name</span></a>
<a class="sourceLine" id="cb549-13" data-line-number="13"><span class="st">      ) src</span></a>
<a class="sourceLine" id="cb549-14" data-line-number="14"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb549-15" data-line-number="15">  </a>
<a class="sourceLine" id="cb549-16" data-line-number="16"><span class="kw">sp_print_df</span>(film_category_AR_rank_sql)</a></code></pre></div>
<div id="htmlwidget-b1bdbba72aec9089045d" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-b1bdbba72aec9089045d">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16"],["Sports","Drama","Sci-Fi","Animation","Comedy","Foreign","Games","Action","Family","New","Travel","Documentary","Horror","Music","Children","Classics"],[3617.21,3378.39,3289.99,3218.34,3089.59,3050.67,3033.31,2966.88,2959.04,2904.6,2776.63,2752.49,2623.54,2541.7,2541.55,2477.61],[3617.21,6995.6,10285.59,13503.93,16593.52,19644.19,22677.5,25644.38,28603.42,31508.02,34284.65,37037.14,39660.68,42202.38,44743.93,47221.54],[1179,1061,1101,1166,941,1033,969,1112,1096,940,837,1051,846,830,945,939],[1179,2240,3341,4507,5448,6481,7450,8562,9658,10598,11435,12486,13332,14162,15107,16046]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>category<\/th>\n      <th>ar<\/th>\n      <th>running_ar<\/th>\n      <th>rentals<\/th>\n      <th>running_rentals<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>There are 16 film categories. The top three categories based on highest AR amounts are Sports, Drama, and Sci-Fi. The total number of rentals are 16046 with an AR amount of 47221.54.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-51" class="section level4">
<h4><span class="header-section-number">25.1.19.1</span> Replicate the output above using dplyr syntax.</h4>
<table>
<thead>
<tr class="header">
<th>column</th>
<th>mapping</th>
<th>definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>category</td>
<td>category.name</td>
<td></td>
</tr>
<tr class="even">
<td>ar</td>
<td>f.rental_rate</td>
<td></td>
</tr>
<tr class="odd">
<td>running_ar</td>
<td></td>
<td>accumulated ar amounts based on ratings</td>
</tr>
<tr class="even">
<td>rentals</td>
<td></td>
<td>number of rentals associated with the rating</td>
</tr>
<tr class="odd">
<td>running_rentals</td>
<td></td>
<td>running rating rentals</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb550"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb550-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb550-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb550-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb550-4" data-line-number="4"></a>
<a class="sourceLine" id="cb550-5" data-line-number="5">film_category_AR_rank_dplyr &lt;-<span class="st"> </span>rental_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb550-6" data-line-number="6"><span class="st">    </span><span class="kw">inner_join</span>(inventory_table, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;inventory_id&#39;</span>=<span class="st">&#39;inventory_id&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb550-7" data-line-number="7"><span class="st">    </span><span class="kw">inner_join</span>(film_table, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;film_id&#39;</span>=<span class="st">&#39;film_id&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb550-8" data-line-number="8"><span class="st">    </span><span class="kw">inner_join</span>(film_category_table, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;film_id&#39;</span>=<span class="st">&#39;film_id&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb550-9" data-line-number="9"><span class="st">    </span><span class="kw">inner_join</span>(category_table,<span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;category_id&#39;</span>=<span class="st">&#39;category_id&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb550-10" data-line-number="10"><span class="st">    </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb550-11" data-line-number="11"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">rentals=</span><span class="kw">n</span>()</a>
<a class="sourceLine" id="cb550-12" data-line-number="12">             ,<span class="dt">AR=</span><span class="kw">sum</span>(rental_rate)</a>
<a class="sourceLine" id="cb550-13" data-line-number="13">             ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb550-14" data-line-number="14"><span class="st">    </span><span class="kw">arrange</span>(<span class="kw">desc</span>(AR)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb550-15" data-line-number="15"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">running_ar=</span><span class="kw">cumsum</span>(AR)</a>
<a class="sourceLine" id="cb550-16" data-line-number="16">          ,<span class="dt">running_rentals=</span><span class="kw">cumsum</span>(rentals)</a>
<a class="sourceLine" id="cb550-17" data-line-number="17">          ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb550-18" data-line-number="18"><span class="st">    </span><span class="kw">rename</span>(<span class="dt">category=</span>name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb550-19" data-line-number="19"><span class="st">    </span><span class="kw">select</span>(category,AR,running_ar,rentals,running_rentals) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb550-20" data-line-number="20"><span class="st">  </span><span class="kw">collect</span>()</a></code></pre></div>
<pre><code>## Warning: Missing values are always removed in SQL.
## Use `SUM(x, na.rm = TRUE)` to silence this warning</code></pre>
<div class="sourceCode" id="cb552"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb552-1" data-line-number="1"><span class="kw">sp_print_df</span>(film_category_AR_rank_dplyr)</a></code></pre></div>
<div id="htmlwidget-af6ac1c69230c2179f6a" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-af6ac1c69230c2179f6a">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16"],["Sports","Drama","Sci-Fi","Animation","Comedy","Foreign","Games","Action","Family","New","Travel","Documentary","Horror","Music","Children","Classics"],[3617.21,3378.39,3289.99,3218.34,3089.59,3050.67,3033.31,2966.88,2959.04,2904.6,2776.63,2752.49,2623.54,2541.7,2541.55,2477.61],[3617.21,6995.6,10285.59,13503.93,16593.52,19644.19,22677.5,25644.38,28603.42,31508.02,34284.65,37037.14,39660.68,42202.38,44743.93,47221.54],[1179,1061,1101,1166,941,1033,969,1112,1096,940,837,1051,846,830,945,939],[1179,2240,3341,4507,5448,6481,7450,8562,9658,10598,11435,12486,13332,14162,15107,16046]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>category<\/th>\n      <th>AR<\/th>\n      <th>running_ar<\/th>\n      <th>rentals<\/th>\n      <th>running_rentals<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="list-film-ratings-in-descending-accounts-receivable-order.-1" class="section level3">
<h3><span class="header-section-number">25.1.20</span> 21. List film ratings in descending accounts receivable order.</h3>
<p>To answer this question we look at the <code>rental</code>, <code>inventory</code>, and <code>film</code> tables.</p>
<div class="sourceCode" id="cb553"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb553-1" data-line-number="1">film_rating_rank_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb553-2" data-line-number="2"><span class="st">&quot;select rating,AR</span></a>
<a class="sourceLine" id="cb553-3" data-line-number="3"><span class="st">       ,sum(AR) over (order by AR desc rows </span></a>
<a class="sourceLine" id="cb553-4" data-line-number="4"><span class="st">        between unbounded preceding and current row) running_AR</span></a>
<a class="sourceLine" id="cb553-5" data-line-number="5"><span class="st">       ,rentals</span></a>
<a class="sourceLine" id="cb553-6" data-line-number="6"><span class="st">       ,sum(rentals) over (order by AR desc rows </span></a>
<a class="sourceLine" id="cb553-7" data-line-number="7"><span class="st">        between unbounded preceding and current row) running_rentals</span></a>
<a class="sourceLine" id="cb553-8" data-line-number="8"><span class="st">from (select f.rating, sum(f.rental_rate) AR, count(*) rentals</span></a>
<a class="sourceLine" id="cb553-9" data-line-number="9"><span class="st">        from rental r join inventory i on r.inventory_id = i.inventory_id </span></a>
<a class="sourceLine" id="cb553-10" data-line-number="10"><span class="st">        join film f on i.film_id = f.film_id</span></a>
<a class="sourceLine" id="cb553-11" data-line-number="11"><span class="st">      group by f.rating</span></a>
<a class="sourceLine" id="cb553-12" data-line-number="12"><span class="st">     ) as src </span></a>
<a class="sourceLine" id="cb553-13" data-line-number="13"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb553-14" data-line-number="14">  </a>
<a class="sourceLine" id="cb553-15" data-line-number="15"><span class="kw">sp_print_df</span>(film_rating_rank_sql)</a></code></pre></div>
<div id="htmlwidget-c6cef737dd6a83c62169" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-c6cef737dd6a83c62169">{"x":{"filter":"none","data":[["1","2","3","4","5"],["PG-13","NC-17","PG","R","G"],[10797.15,10062.07,9470.87,9011.19,7875.27],[10797.15,20859.22,30330.09,39341.28,47216.55],[3585,3293,3213,3181,2773],[3585,6878,10091,13272,16045]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>rating<\/th>\n      <th>ar<\/th>\n      <th>running_ar<\/th>\n      <th>rentals<\/th>\n      <th>running_rentals<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>There are 5 film ratings. The total number of rentals are 16045 with an AR amount of 47216.55.</p>
<p>Why do the film categories revenue and film rating revenue amounts and counts differ, 16046 and 47221.54?</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-52" class="section level4">
<h4><span class="header-section-number">25.1.20.1</span> Replicate the output above using dplyr syntax.</h4>
<table>
<thead>
<tr class="header">
<th>column</th>
<th>mapping</th>
<th>definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>rating</td>
<td>film.rating</td>
<td></td>
</tr>
<tr class="even">
<td>ar</td>
<td>f.rental_rate</td>
<td></td>
</tr>
<tr class="odd">
<td>running_ar</td>
<td></td>
<td>accumulated ar amounts based on ratings</td>
</tr>
<tr class="even">
<td>rentals</td>
<td></td>
<td>number of rentals associated with the rating</td>
</tr>
<tr class="odd">
<td>running_rentals</td>
<td></td>
<td>running rating rentals</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb554"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb554-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb554-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb554-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb554-4" data-line-number="4"></a>
<a class="sourceLine" id="cb554-5" data-line-number="5">film_rating_rank_dplyr &lt;-<span class="st"> </span>rental_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb554-6" data-line-number="6"><span class="st">    </span><span class="kw">inner_join</span>(inventory_table, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;inventory_id&#39;</span>=<span class="st">&#39;inventory_id&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb554-7" data-line-number="7"><span class="st">    </span><span class="kw">inner_join</span>(film_table, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;film_id&#39;</span>=<span class="st">&#39;film_id&#39;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb554-8" data-line-number="8"><span class="st">    </span><span class="kw">group_by</span>(rating) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb554-9" data-line-number="9"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">rentals=</span><span class="kw">n</span>()</a>
<a class="sourceLine" id="cb554-10" data-line-number="10">             ,<span class="dt">AR=</span><span class="kw">sum</span>(rental_rate)</a>
<a class="sourceLine" id="cb554-11" data-line-number="11">             ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb554-12" data-line-number="12"><span class="st">    </span><span class="kw">arrange</span>(<span class="kw">desc</span>(AR)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb554-13" data-line-number="13"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">running_ar=</span><span class="kw">cumsum</span>(AR)</a>
<a class="sourceLine" id="cb554-14" data-line-number="14">          ,<span class="dt">running_rentals=</span><span class="kw">cumsum</span>(rentals)</a>
<a class="sourceLine" id="cb554-15" data-line-number="15">          ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb554-16" data-line-number="16"><span class="st">    </span><span class="kw">select</span>(rating,AR,running_ar,rentals,running_rentals) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb554-17" data-line-number="17"><span class="st">  </span><span class="kw">collect</span>()</a></code></pre></div>
<pre><code>## Warning: Missing values are always removed in SQL.
## Use `SUM(x, na.rm = TRUE)` to silence this warning</code></pre>
<div class="sourceCode" id="cb556"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb556-1" data-line-number="1"><span class="kw">sp_print_df</span>(film_rating_rank_dplyr)</a></code></pre></div>
<div id="htmlwidget-a9e8581aee330d6d5646" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-a9e8581aee330d6d5646">{"x":{"filter":"none","data":[["1","2","3","4","5"],["PG-13","NC-17","PG","R","G"],[10797.15,10062.07,9470.87,9011.19,7875.27],[10797.15,20859.22,30330.09,39341.28,47216.55],[3585,3293,3213,3181,2773],[3585,6878,10091,13272,16045]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>rating<\/th>\n      <th>AR<\/th>\n      <th>running_ar<\/th>\n      <th>rentals<\/th>\n      <th>running_rentals<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="how-many-rentals-were-returned-on-time-returned-late-never-returned-1" class="section level3">
<h3><span class="header-section-number">25.1.21</span> 22. How many rentals were returned on time, returned late, never returned?</h3>
<p>To answer this question we look at the <code>rental</code>, <code>inventory</code>, and <code>film</code> tables.</p>
<div class="sourceCode" id="cb557"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb557-1" data-line-number="1">returned_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb557-2" data-line-number="2"><span class="st">&quot;with details as</span></a>
<a class="sourceLine" id="cb557-3" data-line-number="3"><span class="st">    (select case when r.return_date is null</span></a>
<a class="sourceLine" id="cb557-4" data-line-number="4"><span class="st">                 then null</span></a>
<a class="sourceLine" id="cb557-5" data-line-number="5"><span class="st">                 else r.return_date::date  - (r.rental_date + INTERVAL &#39;1 day&#39;  * f.rental_duration)::date</span></a>
<a class="sourceLine" id="cb557-6" data-line-number="6"><span class="st">            end rtn_days</span></a>
<a class="sourceLine" id="cb557-7" data-line-number="7"><span class="st">           ,case when r.return_date is null</span></a>
<a class="sourceLine" id="cb557-8" data-line-number="8"><span class="st">                 then 1</span></a>
<a class="sourceLine" id="cb557-9" data-line-number="9"><span class="st">                 else 0</span></a>
<a class="sourceLine" id="cb557-10" data-line-number="10"><span class="st">            end not_rtn</span></a>
<a class="sourceLine" id="cb557-11" data-line-number="11"><span class="st">       from rental r join inventory i on r.inventory_id = i.inventory_id</span></a>
<a class="sourceLine" id="cb557-12" data-line-number="12"><span class="st">                     join film f on i.film_id = f.film_id</span></a>
<a class="sourceLine" id="cb557-13" data-line-number="13"><span class="st">    )</span></a>
<a class="sourceLine" id="cb557-14" data-line-number="14"><span class="st"> select sum(case when rtn_days &lt;= 0 then 1 else 0 end) on_time</span></a>
<a class="sourceLine" id="cb557-15" data-line-number="15"><span class="st">       ,sum(case when rtn_days &gt;  0 then 1 else 0 end) late</span></a>
<a class="sourceLine" id="cb557-16" data-line-number="16"><span class="st">       ,sum(not_rtn) not_rtn</span></a>
<a class="sourceLine" id="cb557-17" data-line-number="17"><span class="st">       ,count(*) rented</span></a>
<a class="sourceLine" id="cb557-18" data-line-number="18"><span class="st">       ,round(100. * sum(case when rtn_days &lt;= 0 then 1 else 0 end)/count(*),2) on_time_pct</span></a>
<a class="sourceLine" id="cb557-19" data-line-number="19"><span class="st">       ,round(100. * sum(case when rtn_days &gt;  0 then 1 else 0 end)/count(*),2) late_pct</span></a>
<a class="sourceLine" id="cb557-20" data-line-number="20"><span class="st">       ,round(100. * sum(not_rtn)/count(*),2)  not_rtn_pct</span></a>
<a class="sourceLine" id="cb557-21" data-line-number="21"><span class="st">   from details</span></a>
<a class="sourceLine" id="cb557-22" data-line-number="22"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb557-23" data-line-number="23"></a>
<a class="sourceLine" id="cb557-24" data-line-number="24"><span class="kw">sp_print_df</span>(returned_sql)</a></code></pre></div>
<div id="htmlwidget-a9c870ee45a861efbc97" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-a9c870ee45a861efbc97">{"x":{"filter":"none","data":[["1"],[8593],[7269],[183],[16045],[53.56],[45.3],[1.14]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>on_time<\/th>\n      <th>late<\/th>\n      <th>not_rtn<\/th>\n      <th>rented<\/th>\n      <th>on_time_pct<\/th>\n      <th>late_pct<\/th>\n      <th>not_rtn_pct<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>To date 53.56% of the rented DVD’s were returned on time, 45.30% were returned late, and 1.14% were never returned.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-53" class="section level4">
<h4><span class="header-section-number">25.1.21.1</span> Replicate the output above using dplyr syntax.</h4>
<table>
<colgroup>
<col width="34%" />
<col width="40%" />
<col width="25%" />
</colgroup>
<thead>
<tr class="header">
<th>column</th>
<th>mapping</th>
<th>definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>on_time</td>
<td></td>
<td>number of DVD’s where rental.return_date &lt;= rental.rental_date + film.rental_duration</td>
</tr>
<tr class="even">
<td>late</td>
<td></td>
<td>number of DVD’s where rental.return_date &gt; rental.rental_date + film.rental_duration</td>
</tr>
<tr class="odd">
<td>not_rtn</td>
<td></td>
<td>number of DVD’s not returned; rental.return_date is null</td>
</tr>
<tr class="even">
<td>rented</td>
<td></td>
<td>number of DVD’s rented.</td>
</tr>
<tr class="odd">
<td>on_time_pct</td>
<td></td>
<td>Percent of DVD’s returned on time</td>
</tr>
<tr class="even">
<td>late_pct</td>
<td></td>
<td>Percent of DVD’s returned late</td>
</tr>
<tr class="odd">
<td>not_rtn_pct</td>
<td></td>
<td>Percent of DVD’s not returned.</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb558"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb558-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb558-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb558-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb558-4" data-line-number="4"></a>
<a class="sourceLine" id="cb558-5" data-line-number="5">returned_dplyr &lt;-<span class="st"> </span>rental_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb558-6" data-line-number="6"><span class="st">    </span><span class="kw">inner_join</span>(inventory_table, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;inventory_id&#39;</span>=<span class="st">&#39;inventory_id&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb558-7" data-line-number="7"><span class="st">    </span><span class="kw">inner_join</span>(film_table, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;film_id&#39;</span>=<span class="st">&#39;film_id&#39;</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">collect</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb558-8" data-line-number="8"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">rtn_days=</span> lubridate<span class="op">::</span><span class="kw">date</span>(return_date) <span class="op">-</span><span class="st"> </span>(lubridate<span class="op">::</span><span class="kw">date</span>(rental_date) <span class="op">+</span><span class="st"> </span>rental_duration)</a>
<a class="sourceLine" id="cb558-9" data-line-number="9">          ,<span class="dt">not_returned=</span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(return_date),<span class="dv">1</span>,<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb558-10" data-line-number="10">          ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb558-11" data-line-number="11"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">on_time =</span> <span class="kw">sum</span>(<span class="kw">ifelse</span>(rtn_days <span class="op">&lt;=</span><span class="st"> </span><span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>),<span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb558-12" data-line-number="12">             ,<span class="dt">late =</span> <span class="kw">sum</span>(<span class="kw">ifelse</span>(rtn_days <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>),<span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb558-13" data-line-number="13">             ,<span class="dt">not_rtn=</span><span class="kw">sum</span>(not_returned)</a>
<a class="sourceLine" id="cb558-14" data-line-number="14">             ,<span class="dt">rented =</span> <span class="kw">n</span>()</a>
<a class="sourceLine" id="cb558-15" data-line-number="15">             ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb558-16" data-line-number="16"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">on_time_pct =</span> <span class="kw">round</span>(<span class="fl">100.0</span> <span class="op">*</span><span class="st"> </span>on_time<span class="op">/</span>rented,<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb558-17" data-line-number="17">          ,<span class="dt">late_pct    =</span> <span class="kw">round</span>(<span class="fl">100.0</span> <span class="op">*</span><span class="st"> </span>late<span class="op">/</span>rented,<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb558-18" data-line-number="18">          ,<span class="dt">not_rtn_pct =</span> <span class="kw">round</span>(<span class="fl">100.0</span> <span class="op">*</span><span class="st"> </span>not_rtn<span class="op">/</span>rented,<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb558-19" data-line-number="19">          ) </a>
<a class="sourceLine" id="cb558-20" data-line-number="20"></a>
<a class="sourceLine" id="cb558-21" data-line-number="21"></a>
<a class="sourceLine" id="cb558-22" data-line-number="22"><span class="kw">sp_print_df</span>(returned_dplyr)</a></code></pre></div>
<div id="htmlwidget-d0e1be80fd8ee1a19c08" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-d0e1be80fd8ee1a19c08">{"x":{"filter":"none","data":[["1"],[8593],[7269],[183],[16045],[53.56],[45.3],[1.14]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>on_time<\/th>\n      <th>late<\/th>\n      <th>not_rtn<\/th>\n      <th>rented<\/th>\n      <th>on_time_pct<\/th>\n      <th>late_pct<\/th>\n      <th>not_rtn_pct<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="are-there-duplicate-customers-1" class="section level3">
<h3><span class="header-section-number">25.1.22</span> 23. Are there duplicate customers?</h3>
<p>To answer this question we look at the <code>customer</code>, <code>address</code>, <code>city</code>, and <code>country</code> tables.</p>
<p>We assume that if the customer first and last name match in two different rows, then it is a duplicate customer.</p>
<div class="sourceCode" id="cb559"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb559-1" data-line-number="1">customer_dupes_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb559-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb559-3" data-line-number="3">  <span class="st">&quot;select cust.customer_id id</span></a>
<a class="sourceLine" id="cb559-4" data-line-number="4"><span class="st">         ,cust.store_id store</span></a>
<a class="sourceLine" id="cb559-5" data-line-number="5"><span class="st">         ,concat(cust.first_name,&#39; &#39;,cust.last_name) customer</span></a>
<a class="sourceLine" id="cb559-6" data-line-number="6"><span class="st">         ,cust.email</span></a>
<a class="sourceLine" id="cb559-7" data-line-number="7"><span class="st">--         ,a.phone</span></a>
<a class="sourceLine" id="cb559-8" data-line-number="8"><span class="st">         ,a.address</span></a>
<a class="sourceLine" id="cb559-9" data-line-number="9"><span class="st">         ,c.city</span></a>
<a class="sourceLine" id="cb559-10" data-line-number="10"><span class="st">         ,a.postal_code zip</span></a>
<a class="sourceLine" id="cb559-11" data-line-number="11"><span class="st">         ,a.district</span></a>
<a class="sourceLine" id="cb559-12" data-line-number="12"><span class="st">         ,ctry.country</span></a>
<a class="sourceLine" id="cb559-13" data-line-number="13"><span class="st">     from customer cust join address a on cust.address_id = a.address_id</span></a>
<a class="sourceLine" id="cb559-14" data-line-number="14"><span class="st">                     join city c on a.city_id = c.city_id</span></a>
<a class="sourceLine" id="cb559-15" data-line-number="15"><span class="st">                     join country ctry on c.country_id = ctry.country_id</span></a>
<a class="sourceLine" id="cb559-16" data-line-number="16"><span class="st">    where concat(cust.first_name,cust.last_name)</span></a>
<a class="sourceLine" id="cb559-17" data-line-number="17"><span class="st">          in (select concat(first_name,last_name)</span></a>
<a class="sourceLine" id="cb559-18" data-line-number="18"><span class="st">                from customer</span></a>
<a class="sourceLine" id="cb559-19" data-line-number="19"><span class="st">              group by concat(first_name,last_name)</span></a>
<a class="sourceLine" id="cb559-20" data-line-number="20"><span class="st">             having count(*) &gt;1</span></a>
<a class="sourceLine" id="cb559-21" data-line-number="21"><span class="st">             )</span></a>
<a class="sourceLine" id="cb559-22" data-line-number="22"><span class="st">  &quot;</span>)</a>
<a class="sourceLine" id="cb559-23" data-line-number="23"><span class="kw">sp_print_df</span>(customer_dupes_sql)</a></code></pre></div>
<div id="htmlwidget-41c6fff5c0ae3f9b920c" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-41c6fff5c0ae3f9b920c">{"x":{"filter":"none","data":[["1","2"],[600,601],[3,2],["Sophie Yang","Sophie Yang"],["sophie.yang@sakilacustomer.org","sophie.yang@sakilacustomer.org"],["47 MySakila Drive","47 MySakila Drive"],["Lethbridge","Lethbridge"],["",""],["Alberta","Alberta"],["Canada","Canada"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>id<\/th>\n      <th>store<\/th>\n      <th>customer<\/th>\n      <th>email<\/th>\n      <th>address<\/th>\n      <th>city<\/th>\n      <th>zip<\/th>\n      <th>district<\/th>\n      <th>country<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>Sophie is the only duplicate customer. The only difference between the two records is the store. Record 600 is associated with store 3, which has no employees, and 601 is associated with store 2</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-54" class="section level4">
<h4><span class="header-section-number">25.1.22.1</span> Replicate the output above using dplyr syntax.</h4>
<table>
<thead>
<tr class="header">
<th>column</th>
<th>mapping</th>
<th>definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>id</td>
<td>customer.customer_id</td>
<td></td>
</tr>
<tr class="even">
<td>store</td>
<td>customer.store_id</td>
<td></td>
</tr>
<tr class="odd">
<td>customer</td>
<td>first_name + last_name</td>
<td></td>
</tr>
<tr class="even">
<td>zip</td>
<td>address.postal_code</td>
<td></td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb560"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb560-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb560-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb560-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb560-4" data-line-number="4"></a>
<a class="sourceLine" id="cb560-5" data-line-number="5">customer_dupes_dplyr &lt;-<span class="st"> </span>customer_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb560-6" data-line-number="6"><span class="st">    </span><span class="kw">group_by</span>(first_name,last_name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb560-7" data-line-number="7"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">n =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb560-8" data-line-number="8"><span class="st">    </span><span class="kw">filter</span>(n <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb560-9" data-line-number="9"><span class="st">    </span><span class="kw">inner_join</span>(customer_table,<span class="dt">by=</span><span class="kw">c</span>(<span class="st">&quot;first_name&quot;</span>=<span class="st">&quot;first_name&quot;</span>,<span class="st">&quot;last_name&quot;</span>=<span class="st">&quot;last_name&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb560-10" data-line-number="10"><span class="st">    </span><span class="kw">inner_join</span>(address_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;address_id&quot;</span> =<span class="st"> &quot;address_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.s&quot;</span>, <span class="st">&quot;.a&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb560-11" data-line-number="11"><span class="st">    </span><span class="kw">inner_join</span>(city_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;city_id&quot;</span> =<span class="st"> &quot;city_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.a&quot;</span>, <span class="st">&quot;.c&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb560-12" data-line-number="12"><span class="st">    </span><span class="kw">inner_join</span>(country_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;country_id&quot;</span> =<span class="st"> &quot;country_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.a&quot;</span>, <span class="st">&quot;.c&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb560-13" data-line-number="13"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">customer=</span><span class="kw">paste0</span>(first_name,last_name,<span class="dt">sep=</span><span class="st">&#39; &#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb560-14" data-line-number="14"><span class="st">    </span><span class="kw">group_by</span>(customer) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb560-15" data-line-number="15"><span class="st">    </span><span class="kw">rename</span>(<span class="dt">id=</span>customer_id</a>
<a class="sourceLine" id="cb560-16" data-line-number="16">          ,<span class="dt">store=</span>store_id</a>
<a class="sourceLine" id="cb560-17" data-line-number="17">          ,<span class="dt">zip=</span>postal_code</a>
<a class="sourceLine" id="cb560-18" data-line-number="18">          ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb560-19" data-line-number="19"><span class="st">    </span><span class="kw">select</span>(id,store,customer,email,address,city,zip,district,country) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb560-20" data-line-number="20"><span class="st">  </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb560-21" data-line-number="21">    </a>
<a class="sourceLine" id="cb560-22" data-line-number="22"><span class="kw">sp_print_df</span>(customer_dupes_dplyr)</a></code></pre></div>
<div id="htmlwidget-5fe564842c318b64a092" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5fe564842c318b64a092">{"x":{"filter":"none","data":[["1","2"],[600,601],[3,2],["Sophie Yang","Sophie Yang"],["sophie.yang@sakilacustomer.org","sophie.yang@sakilacustomer.org"],["47 MySakila Drive","47 MySakila Drive"],["Lethbridge","Lethbridge"],["",""],["Alberta","Alberta"],["Canada","Canada"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>id<\/th>\n      <th>store<\/th>\n      <th>customer<\/th>\n      <th>email<\/th>\n      <th>address<\/th>\n      <th>city<\/th>\n      <th>zip<\/th>\n      <th>district<\/th>\n      <th>country<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="which-customers-have-never-rented-a-movie-1" class="section level3">
<h3><span class="header-section-number">25.1.23</span> 24. Which customers have never rented a movie?</h3>
<p>To answer this question we look at the <code>customer</code> and <code>rental</code> tables.</p>
<div class="sourceCode" id="cb561"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb561-1" data-line-number="1">customer_no_rentals_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb561-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb561-3" data-line-number="3">  <span class="st">&quot;select c.customer_id id</span></a>
<a class="sourceLine" id="cb561-4" data-line-number="4"><span class="st">         ,c.first_name</span></a>
<a class="sourceLine" id="cb561-5" data-line-number="5"><span class="st">         ,c.last_name</span></a>
<a class="sourceLine" id="cb561-6" data-line-number="6"><span class="st">         ,c.email</span></a>
<a class="sourceLine" id="cb561-7" data-line-number="7"><span class="st">         ,a.phone</span></a>
<a class="sourceLine" id="cb561-8" data-line-number="8"><span class="st">         ,city.city</span></a>
<a class="sourceLine" id="cb561-9" data-line-number="9"><span class="st">         ,ctry.country</span></a>
<a class="sourceLine" id="cb561-10" data-line-number="10"><span class="st">         ,c.active </span></a>
<a class="sourceLine" id="cb561-11" data-line-number="11"><span class="st">         ,c.create_date</span></a>
<a class="sourceLine" id="cb561-12" data-line-number="12"><span class="st">--         ,c.last_update</span></a>
<a class="sourceLine" id="cb561-13" data-line-number="13"><span class="st">     from customer c left join rental r on c.customer_id = r.customer_id</span></a>
<a class="sourceLine" id="cb561-14" data-line-number="14"><span class="st">                     left join address a on c.address_id = a.address_id</span></a>
<a class="sourceLine" id="cb561-15" data-line-number="15"><span class="st">                     left join city on a.city_id = city.city_id</span></a>
<a class="sourceLine" id="cb561-16" data-line-number="16"><span class="st">                     left join country ctry on city.country_id = ctry.country_id</span></a>
<a class="sourceLine" id="cb561-17" data-line-number="17"><span class="st">    where r.rental_id is null</span></a>
<a class="sourceLine" id="cb561-18" data-line-number="18"><span class="st">  order by c.customer_id</span></a>
<a class="sourceLine" id="cb561-19" data-line-number="19"></a>
<a class="sourceLine" id="cb561-20" data-line-number="20"><span class="st">  &quot;</span></a>
<a class="sourceLine" id="cb561-21" data-line-number="21">)</a>
<a class="sourceLine" id="cb561-22" data-line-number="22"><span class="kw">sp_print_df</span>(customer_no_rentals_sql)</a></code></pre></div>
<div id="htmlwidget-234a00f466fa8377b924" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-234a00f466fa8377b924">{"x":{"filter":"none","data":[["1","2","3","4"],[601,602,603,604],["Sophie","John","Ian","Ed"],["Yang","Smith","Frantz","Borasky"],["sophie.yang@sakilacustomer.org","john.smith@sakilacustomer.org","ian.frantz@sakilacustomer.org","ed.borasky@sakilacustomer.org"],["","","14033335568","6172235589"],["Lethbridge","Woodridge","Lethbridge","Woodridge"],["Canada","Australia","Canada","Australia"],[1,1,1,1],["2019-03-04","2019-03-04","2019-03-04","2019-03-04"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>email<\/th>\n      <th>phone<\/th>\n      <th>city<\/th>\n      <th>country<\/th>\n      <th>active<\/th>\n      <th>create_date<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,8]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>We see that there are four new customers who have never rented a movie. These four customers are in the countries that have a manned store.</font></p>
<table>
<thead>
<tr class="header">
<th>column</th>
<th>mapping</th>
<th>definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>id</td>
<td>customer.customer_id</td>
<td></td>
</tr>
</tbody>
</table>
<div id="replicate-the-output-above-using-dplyr-syntax.-55" class="section level4">
<h4><span class="header-section-number">25.1.23.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb562"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb562-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb562-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb562-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb562-4" data-line-number="4"></a>
<a class="sourceLine" id="cb562-5" data-line-number="5">customer_no_rentals_dplyr &lt;-<span class="st"> </span>customer_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb562-6" data-line-number="6"><span class="st">    </span><span class="kw">anti_join</span>(rental_table, <span class="dt">by =</span> <span class="st">&quot;customer_id&quot;</span> ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb562-7" data-line-number="7"><span class="st">    </span><span class="kw">inner_join</span>(address_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&#39;address_id&#39;</span>=<span class="st">&#39;address_id&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb562-8" data-line-number="8"><span class="st">    </span><span class="kw">inner_join</span>(city_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&#39;city_id&#39;</span>=<span class="st">&#39;city_id&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb562-9" data-line-number="9"><span class="st">    </span><span class="kw">inner_join</span>(country_table, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;country_id&#39;</span>=<span class="st">&#39;country_id&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb562-10" data-line-number="10"><span class="st">    </span><span class="kw">rename</span>(<span class="dt">id=</span>customer_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb562-11" data-line-number="11"><span class="st">    </span><span class="kw">select</span>(id,first_name,last_name,email,phone,active,city,country,create_date) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb562-12" data-line-number="12"><span class="st">  </span><span class="kw">collect</span>() </a>
<a class="sourceLine" id="cb562-13" data-line-number="13"></a>
<a class="sourceLine" id="cb562-14" data-line-number="14"><span class="kw">sp_print_df</span>(customer_no_rentals_dplyr)</a></code></pre></div>
<div id="htmlwidget-868fa95f2212c2b3c328" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-868fa95f2212c2b3c328">{"x":{"filter":"none","data":[["1","2","3","4"],[601,602,603,604],["Sophie","John","Ian","Ed"],["Yang","Smith","Frantz","Borasky"],["sophie.yang@sakilacustomer.org","john.smith@sakilacustomer.org","ian.frantz@sakilacustomer.org","ed.borasky@sakilacustomer.org"],["","","14033335568","6172235589"],[1,1,1,1],["Lethbridge","Woodridge","Lethbridge","Woodridge"],["Canada","Australia","Canada","Australia"],["2019-03-04","2019-03-04","2019-03-04","2019-03-04"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>email<\/th>\n      <th>phone<\/th>\n      <th>active<\/th>\n      <th>city<\/th>\n      <th>country<\/th>\n      <th>create_date<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="who-are-the-top-5-customers-with-the-most-rentals-and-associated-payments-1" class="section level3">
<h3><span class="header-section-number">25.1.24</span> 25. Who are the top 5 customers with the most rentals and associated payments?</h3>
<p>This exercise uses the <code>customer</code>, <code>rental</code>, and <code>payment</code> tables.</p>
<div class="sourceCode" id="cb563"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb563-1" data-line-number="1">customer_top_rentals_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb563-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb563-3" data-line-number="3">  <span class="st">&quot;select c.customer_id id,c.store_id</span></a>
<a class="sourceLine" id="cb563-4" data-line-number="4"><span class="st">         ,concat(c.first_name,&#39; &#39;,c.last_name) customer</span></a>
<a class="sourceLine" id="cb563-5" data-line-number="5"><span class="st">         ,min(rental_date)::date mn_rental_dt</span></a>
<a class="sourceLine" id="cb563-6" data-line-number="6"><span class="st">         ,max(rental_date)::date mx_rental_dt</span></a>
<a class="sourceLine" id="cb563-7" data-line-number="7"><span class="st">         ,sum(COALESCE(p.amount,0.)) paid</span></a>
<a class="sourceLine" id="cb563-8" data-line-number="8"><span class="st">         ,count(r.rental_id) rentals</span></a>
<a class="sourceLine" id="cb563-9" data-line-number="9"><span class="st">     from customer c</span></a>
<a class="sourceLine" id="cb563-10" data-line-number="10"><span class="st">          left join rental r on c.customer_id = r.customer_id</span></a>
<a class="sourceLine" id="cb563-11" data-line-number="11"><span class="st">          left join payment p on r.rental_id = p.rental_id </span></a>
<a class="sourceLine" id="cb563-12" data-line-number="12"><span class="st">   group by  c.customer_id</span></a>
<a class="sourceLine" id="cb563-13" data-line-number="13"><span class="st">            ,c.first_name</span></a>
<a class="sourceLine" id="cb563-14" data-line-number="14"><span class="st">            ,c.last_name</span></a>
<a class="sourceLine" id="cb563-15" data-line-number="15"><span class="st">            ,c.store_id</span></a>
<a class="sourceLine" id="cb563-16" data-line-number="16"><span class="st">   order by count(r.rental_id) desc</span></a>
<a class="sourceLine" id="cb563-17" data-line-number="17"><span class="st">limit 5</span></a>
<a class="sourceLine" id="cb563-18" data-line-number="18"><span class="st">  &quot;</span></a>
<a class="sourceLine" id="cb563-19" data-line-number="19">)</a>
<a class="sourceLine" id="cb563-20" data-line-number="20"><span class="kw">sp_print_df</span>(customer_top_rentals_sql)</a></code></pre></div>
<div id="htmlwidget-99c3e94ea8569a159b98" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-99c3e94ea8569a159b98">{"x":{"filter":"none","data":[["1","2","3","4","5"],[148,526,236,144,75],[1,2,1,1,2],["Eleanor Hunt","Karl Seal","Marcia Dean","Clara Shaw","Tammy Sanders"],["2005-05-28","2005-05-28","2005-05-26","2005-05-27","2005-05-26"],["2005-08-23","2005-08-23","2006-02-14","2005-08-23","2006-02-14"],[211.55,208.58,166.61,189.6,149.61],[46,45,42,42,41]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>id<\/th>\n      <th>store_id<\/th>\n      <th>customer<\/th>\n      <th>mn_rental_dt<\/th>\n      <th>mx_rental_dt<\/th>\n      <th>paid<\/th>\n      <th>rentals<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>The top 5 customers all rented between 41 to 46 DVD’s. Three of the top 5 rented about 14 DVD’s per month over a three month period. The other two customers 41 and 42 DVD’s per 12 months.</font></p>
<div id="replicate-the-output-above-using-dplyr-1" class="section level4">
<h4><span class="header-section-number">25.1.24.1</span> Replicate the output above using dplyr</h4>
<table>
<thead>
<tr class="header">
<th>column</th>
<th>mapping</th>
<th>definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>id</td>
<td>customer.customer_id</td>
<td></td>
</tr>
<tr class="even">
<td>customer</td>
<td>first_name + last_name</td>
<td></td>
</tr>
<tr class="odd">
<td>mn_rental_dt</td>
<td></td>
<td>minimum renal date</td>
</tr>
<tr class="even">
<td>mx_rental_dt</td>
<td></td>
<td>maximum rental date</td>
</tr>
<tr class="odd">
<td>paid</td>
<td></td>
<td>paid amount</td>
</tr>
<tr class="even">
<td>rentals</td>
<td></td>
<td>customer rentals</td>
</tr>
</tbody>
</table>
<p>Use the dplyr inner_join verb to find the top 5 customers who have rented the most movies.</p>
<div class="sourceCode" id="cb564"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb564-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb564-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb564-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb564-4" data-line-number="4"></a>
<a class="sourceLine" id="cb564-5" data-line-number="5">customer_top_rentals_dplyr &lt;-<span class="st"> </span>customer_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb564-6" data-line-number="6"><span class="st">    </span><span class="kw">left_join</span>(rental_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;customer_id&quot;</span> =<span class="st"> &quot;customer_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.c&quot;</span>, <span class="st">&quot;.r&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb564-7" data-line-number="7"><span class="st">    </span><span class="kw">left_join</span>(payment_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;rental_id&quot;</span> =<span class="st"> &quot;rental_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&#39;r&#39;</span>,<span class="st">&#39;p&#39;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb564-8" data-line-number="8"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">customer=</span><span class="kw">paste</span>(first_name,last_name,<span class="dt">sep=</span><span class="st">&#39; &#39;</span>)</a>
<a class="sourceLine" id="cb564-9" data-line-number="9">          ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb564-10" data-line-number="10"><span class="st">    </span><span class="kw">group_by</span>(customer_id.x,customer,store_id) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb564-11" data-line-number="11"><span class="st">  </span><span class="kw">collect</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb564-12" data-line-number="12"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">rentals=</span><span class="kw">n</span>()</a>
<a class="sourceLine" id="cb564-13" data-line-number="13">             ,<span class="dt">paid =</span> <span class="kw">sum</span>(<span class="kw">ifelse</span>(<span class="kw">is.na</span>(amount),<span class="dv">0</span>,amount))</a>
<a class="sourceLine" id="cb564-14" data-line-number="14">             ,<span class="dt">mn_rental_dt =</span> <span class="kw">as.Date</span>(<span class="kw">min</span>(rental_date))</a>
<a class="sourceLine" id="cb564-15" data-line-number="15">             ,<span class="dt">mx_rental_dt =</span> <span class="kw">as.Date</span>(<span class="kw">max</span>(rental_date))</a>
<a class="sourceLine" id="cb564-16" data-line-number="16">             ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb564-17" data-line-number="17"><span class="st">    </span><span class="kw">arrange</span>(<span class="kw">desc</span>(rentals)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb564-18" data-line-number="18"><span class="st">    </span><span class="kw">rename</span>(<span class="dt">id =</span> customer_id.x) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb564-19" data-line-number="19"><span class="st">    </span><span class="kw">select</span>(id,store_id,customer,mn_rental_dt,mx_rental_dt,paid,rentals) </a>
<a class="sourceLine" id="cb564-20" data-line-number="20"></a>
<a class="sourceLine" id="cb564-21" data-line-number="21"><span class="kw">sp_print_df</span>(<span class="kw">head</span>(customer_top_rentals_dplyr,<span class="dt">n=</span><span class="dv">5</span>))</a></code></pre></div>
<div id="htmlwidget-abcdda0cacd8bfd420cb" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-abcdda0cacd8bfd420cb">{"x":{"filter":"none","data":[["1","2","3","4","5"],[148,526,144,236,75],[1,2,1,1,2],["Eleanor Hunt","Karl Seal","Clara Shaw","Marcia Dean","Tammy Sanders"],["2005-05-29","2005-05-28","2005-05-27","2005-05-26","2005-05-26"],["2005-08-23","2005-08-24","2005-08-23","2006-02-14","2006-02-14"],[211.55,208.58,189.6,166.61,149.61],[46,45,42,42,41]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>id<\/th>\n      <th>store_id<\/th>\n      <th>customer<\/th>\n      <th>mn_rental_dt<\/th>\n      <th>mx_rental_dt<\/th>\n      <th>paid<\/th>\n      <th>rentals<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="combine-the-top-5-rental-customers-40-or-more-rentals-and-zero-rental-customers-1" class="section level3">
<h3><span class="header-section-number">25.1.25</span> 26. Combine the top 5 rental customers, (40 or more rentals), and zero rental customers</h3>
<p>To answer this question we look at the <code>customer</code>, <code>rental</code>, and <code>payments</code> tables again.</p>
<div class="sourceCode" id="cb565"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb565-1" data-line-number="1">customer_rental_high_low_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb565-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb565-3" data-line-number="3">  <span class="st">&quot;select c.customer_id id</span></a>
<a class="sourceLine" id="cb565-4" data-line-number="4"><span class="st">         ,concat(c.first_name,&#39; &#39;,c.last_name) customer</span></a>
<a class="sourceLine" id="cb565-5" data-line-number="5"><span class="st">         ,count(*) cust_cnt</span></a>
<a class="sourceLine" id="cb565-6" data-line-number="6"><span class="st">         ,count(r.rental_id) rentals</span></a>
<a class="sourceLine" id="cb565-7" data-line-number="7"><span class="st">         ,count(p.payment_id) payments</span></a>
<a class="sourceLine" id="cb565-8" data-line-number="8"><span class="st">         ,sum(coalesce(p.amount,0)) paid</span></a>
<a class="sourceLine" id="cb565-9" data-line-number="9"><span class="st">     from customer c</span></a>
<a class="sourceLine" id="cb565-10" data-line-number="10"><span class="st">          left outer join rental r on c.customer_id = r.customer_id</span></a>
<a class="sourceLine" id="cb565-11" data-line-number="11"><span class="st">          left outer join payment p on r.rental_id = p.rental_id</span></a>
<a class="sourceLine" id="cb565-12" data-line-number="12"><span class="st">   group by  c.customer_id</span></a>
<a class="sourceLine" id="cb565-13" data-line-number="13"><span class="st">            ,c.first_name</span></a>
<a class="sourceLine" id="cb565-14" data-line-number="14"><span class="st">            ,c.last_name</span></a>
<a class="sourceLine" id="cb565-15" data-line-number="15"><span class="st">   having count(r.rental_id) = 0 or count(r.rental_id) &gt; 40</span></a>
<a class="sourceLine" id="cb565-16" data-line-number="16"><span class="st">   order by count(r.rental_id) desc</span></a>
<a class="sourceLine" id="cb565-17" data-line-number="17"><span class="st">  &quot;</span></a>
<a class="sourceLine" id="cb565-18" data-line-number="18">)</a>
<a class="sourceLine" id="cb565-19" data-line-number="19"><span class="kw">sp_print_df</span>(customer_rental_high_low_sql)</a></code></pre></div>
<div id="htmlwidget-5bf2ee971cc89a16a855" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5bf2ee971cc89a16a855">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9"],[148,526,144,236,75,604,603,601,602],["Eleanor Hunt","Karl Seal","Clara Shaw","Marcia Dean","Tammy Sanders","Ed Borasky","Ian Frantz","Sophie Yang","John Smith"],[46,45,42,42,41,1,1,1,1],[46,45,42,42,41,0,0,0,0],[45,42,40,39,39,0,0,0,0],[211.55,208.58,189.6,166.61,149.61,0,0,0,0]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>id<\/th>\n      <th>customer<\/th>\n      <th>cust_cnt<\/th>\n      <th>rentals<\/th>\n      <th>payments<\/th>\n      <th>paid<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3,4,5,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>We see that there are four new customers who have never rented a movie. These four customers are in the countries that have a manned store.</p>
<p>We see that there are four new customers who have never rented a movie. These four customers are in the countries that have a manned store.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-56" class="section level4">
<h4><span class="header-section-number">25.1.25.1</span> Replicate the output above using dplyr syntax.</h4>
<table>
<thead>
<tr class="header">
<th>Column</th>
<th>Mapping</th>
<th>Definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>id</td>
<td>customer.customer_id</td>
<td></td>
</tr>
<tr class="even">
<td>customer</td>
<td>first_name + last_name</td>
<td></td>
</tr>
<tr class="odd">
<td>rentals</td>
<td></td>
<td>customer rentals</td>
</tr>
<tr class="even">
<td>payments</td>
<td></td>
<td>customer payments</td>
</tr>
<tr class="odd">
<td>paid_amt</td>
<td>payment.amount</td>
<td>aggregated payment amount</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb566"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb566-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb566-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb566-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb566-4" data-line-number="4"></a>
<a class="sourceLine" id="cb566-5" data-line-number="5">customer_rental_high_low_dplyr &lt;-<span class="st"> </span>customer_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb566-6" data-line-number="6"><span class="st">    </span><span class="kw">left_join</span>(rental_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;customer_id&quot;</span> =<span class="st"> &quot;customer_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.c&quot;</span>, <span class="st">&quot;.r&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb566-7" data-line-number="7"><span class="st">    </span><span class="kw">left_join</span>(payment_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;rental_id&quot;</span> =<span class="st"> &quot;rental_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&#39;r&#39;</span>,<span class="st">&#39;p&#39;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb566-8" data-line-number="8"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">customer=</span><span class="kw">paste</span>(first_name,last_name,<span class="dt">sep=</span><span class="st">&#39; &#39;</span>)</a>
<a class="sourceLine" id="cb566-9" data-line-number="9">          ,<span class="dt">rented =</span> <span class="kw">if_else</span>(<span class="kw">is.na</span>(rental_id),<span class="dv">0</span>, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb566-10" data-line-number="10">          ,<span class="dt">paid =</span> <span class="kw">if_else</span>(<span class="kw">is.na</span>(payment_id),<span class="dv">0</span>,<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb566-11" data-line-number="11">          ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb566-12" data-line-number="12"><span class="st">    </span><span class="kw">group_by</span>(customer_id.x,customer,rented) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb566-13" data-line-number="13"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">cust_cnt =</span> <span class="kw">n</span>()</a>
<a class="sourceLine" id="cb566-14" data-line-number="14">             ,<span class="dt">rentals=</span><span class="kw">sum</span>(rented)</a>
<a class="sourceLine" id="cb566-15" data-line-number="15">             ,<span class="dt">payments =</span> <span class="kw">sum</span>(paid)</a>
<a class="sourceLine" id="cb566-16" data-line-number="16">             ,<span class="dt">paid_amt =</span> <span class="kw">sum</span>(<span class="kw">ifelse</span>(<span class="kw">is.na</span>(amount),<span class="dv">0</span>,amount))</a>
<a class="sourceLine" id="cb566-17" data-line-number="17">            ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb566-18" data-line-number="18"><span class="st">    </span><span class="kw">filter</span>( rentals <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">|</span><span class="st"> </span>rentals <span class="op">&gt;</span><span class="st"> </span><span class="dv">40</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb566-19" data-line-number="19"><span class="st">    </span><span class="kw">rename</span>(<span class="dt">id =</span> customer_id.x) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb566-20" data-line-number="20"><span class="st">    </span><span class="kw">select</span>(id,customer,cust_cnt,rentals,payments,paid_amt) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb566-21" data-line-number="21"><span class="st">    </span><span class="kw">arrange</span>(<span class="kw">desc</span>(rentals)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb566-22" data-line-number="22"><span class="st">  </span><span class="kw">collect</span>()</a></code></pre></div>
<pre><code>## Warning: Missing values are always removed in SQL.
## Use `SUM(x, na.rm = TRUE)` to silence this warning

## Warning: Missing values are always removed in SQL.
## Use `SUM(x, na.rm = TRUE)` to silence this warning

## Warning: Missing values are always removed in SQL.
## Use `SUM(x, na.rm = TRUE)` to silence this warning</code></pre>
<div class="sourceCode" id="cb568"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb568-1" data-line-number="1"><span class="kw">sp_print_df</span>(customer_rental_high_low_dplyr)</a></code></pre></div>
<div id="htmlwidget-d53f5dec90ce090aa13d" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-d53f5dec90ce090aa13d">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9"],[148,526,144,236,75,601,602,603,604],["Eleanor Hunt","Karl Seal","Clara Shaw","Marcia Dean","Tammy Sanders","Sophie Yang","John Smith","Ian Frantz","Ed Borasky"],[46,45,42,42,41,1,1,1,1],[46,45,42,42,41,0,0,0,0],[45,42,40,39,39,0,0,0,0],[211.55,208.58,189.6,166.61,149.61,0,0,0,0]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>id<\/th>\n      <th>customer<\/th>\n      <th>cust_cnt<\/th>\n      <th>rentals<\/th>\n      <th>payments<\/th>\n      <th>paid_amt<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3,4,5,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="who-are-the-top-n1-and-bottom-n2-customers-1" class="section level3">
<h3><span class="header-section-number">25.1.26</span> 27. Who are the top-n1 and bottom-n2 customers?</h3>
<p>The issue with the two previous reports is that the top end is hardcoded, rentals &gt; 40. Over time, the current customers will always be in the top section and new customers will get added. Another way of looking at the previous report is to show just the top and bottom 5 customers.</p>
<p>Parameterize the previous exercise to show the top 5 and bottom 5 customers.</p>
<p>To answer this question we look at the <code>customer</code>, <code>rental</code>, and <code>payments</code> tables again.</p>
<div class="sourceCode" id="cb569"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb569-1" data-line-number="1">customer_rentals_hi_low_sql &lt;-<span class="st"> </span><span class="cf">function</span>(high_n,low_n) {</a>
<a class="sourceLine" id="cb569-2" data-line-number="2">    customer_rental_high_low_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb569-3" data-line-number="3">        <span class="st">&quot;select *</span></a>
<a class="sourceLine" id="cb569-4" data-line-number="4"><span class="st">           from (     select *</span></a>
<a class="sourceLine" id="cb569-5" data-line-number="5"><span class="st">                            ,ROW_NUMBER() OVER(ORDER BY rentals desc) rent_hi_low</span></a>
<a class="sourceLine" id="cb569-6" data-line-number="6"><span class="st">                            ,ROW_NUMBER() OVER(ORDER BY rentals ) rent_low_hi</span></a>
<a class="sourceLine" id="cb569-7" data-line-number="7"><span class="st">                       FROM (    </span></a>
<a class="sourceLine" id="cb569-8" data-line-number="8"><span class="st">                                 select c.customer_id id</span></a>
<a class="sourceLine" id="cb569-9" data-line-number="9"><span class="st">                                       ,concat(c.first_name,&#39; &#39;,c.last_name) customer</span></a>
<a class="sourceLine" id="cb569-10" data-line-number="10"><span class="st">                                       ,count(*) cust_cnt</span></a>
<a class="sourceLine" id="cb569-11" data-line-number="11"><span class="st">                                       ,count(r.rental_id) rentals</span></a>
<a class="sourceLine" id="cb569-12" data-line-number="12"><span class="st">                                       ,count(p.payment_id) payments</span></a>
<a class="sourceLine" id="cb569-13" data-line-number="13"><span class="st">                                       ,sum(coalesce(p.amount,0)) paid_amt</span></a>
<a class="sourceLine" id="cb569-14" data-line-number="14"><span class="st">                                  from customer c </span></a>
<a class="sourceLine" id="cb569-15" data-line-number="15"><span class="st">                                       left outer join rental r on c.customer_id = r.customer_id</span></a>
<a class="sourceLine" id="cb569-16" data-line-number="16"><span class="st">                                       left outer join payment p on r.rental_id = p.rental_id</span></a>
<a class="sourceLine" id="cb569-17" data-line-number="17"><span class="st">                                 group by c.customer_id</span></a>
<a class="sourceLine" id="cb569-18" data-line-number="18"><span class="st">                                        ,c.first_name</span></a>
<a class="sourceLine" id="cb569-19" data-line-number="19"><span class="st">                                        ,c.last_name</span></a>
<a class="sourceLine" id="cb569-20" data-line-number="20"><span class="st">                            ) as summary</span></a>
<a class="sourceLine" id="cb569-21" data-line-number="21"><span class="st">                ) row_nums</span></a>
<a class="sourceLine" id="cb569-22" data-line-number="22"><span class="st">           where rent_hi_low &lt;= $1 or rent_low_hi &lt;= $2</span></a>
<a class="sourceLine" id="cb569-23" data-line-number="23"><span class="st">          order by rent_hi_low</span></a>
<a class="sourceLine" id="cb569-24" data-line-number="24"><span class="st">        &quot;</span></a>
<a class="sourceLine" id="cb569-25" data-line-number="25">           ,<span class="kw">c</span>(high_n,low_n)</a>
<a class="sourceLine" id="cb569-26" data-line-number="26">        )</a>
<a class="sourceLine" id="cb569-27" data-line-number="27">    <span class="kw">return</span> (customer_rental_high_low_sql)</a>
<a class="sourceLine" id="cb569-28" data-line-number="28">}</a></code></pre></div>
<p>The next code block executes a sql version of such a function. With top_n = 5 and bot_n = 5, it replicates the hard coded version of the previous exercise. With top_n = 5 and bot_n = 0, it gives a top 5 report. With top_n = 0 and bot_n = 5, the report returns the bottom 5. Change the two parameters to see the output from the different combinations.</p>
<div class="sourceCode" id="cb570"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb570-1" data-line-number="1">top_n =<span class="st"> </span><span class="dv">5</span></a>
<a class="sourceLine" id="cb570-2" data-line-number="2">bot_n =<span class="st"> </span><span class="dv">5</span></a>
<a class="sourceLine" id="cb570-3" data-line-number="3"><span class="kw">sp_print_df</span>(<span class="kw">customer_rentals_hi_low_sql</span>(top_n,bot_n))</a></code></pre></div>
<div id="htmlwidget-409f67cc1efea6a7bf83" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-409f67cc1efea6a7bf83">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10"],[148,526,236,144,75,600,602,604,601,603],["Eleanor Hunt","Karl Seal","Marcia Dean","Clara Shaw","Tammy Sanders","Sophie Yang","John Smith","Ed Borasky","Sophie Yang","Ian Frantz"],[46,45,42,42,41,1,1,1,1,1],[46,45,42,42,41,1,0,0,0,0],[45,42,39,40,39,0,0,0,0,0],[211.55,208.58,166.61,189.6,149.61,0,0,0,0,0],[1,2,3,4,5,600,601,602,603,604],[604,603,602,601,600,5,4,3,2,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>id<\/th>\n      <th>customer<\/th>\n      <th>cust_cnt<\/th>\n      <th>rentals<\/th>\n      <th>payments<\/th>\n      <th>paid_amt<\/th>\n      <th>rent_hi_low<\/th>\n      <th>rent_low_hi<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3,4,5,6,7,8]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div id="replicate-the-function-above-use-dplyr-syntax.-1" class="section level4">
<h4><span class="header-section-number">25.1.26.1</span> Replicate the function above use dplyr syntax.</h4>
<table>
<thead>
<tr class="header">
<th>Column</th>
<th>Mapping</th>
<th>Definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>id</td>
<td>customer.customer_id</td>
<td></td>
</tr>
<tr class="even">
<td>cust_cnt</td>
<td></td>
<td>customer count</td>
</tr>
<tr class="odd">
<td>rentals</td>
<td></td>
<td>customer rentals</td>
</tr>
<tr class="even">
<td>payments</td>
<td></td>
<td>customer payments</td>
</tr>
<tr class="odd">
<td>paid_amt</td>
<td>payment.amount</td>
<td>aggregated payment amount</td>
</tr>
<tr class="even">
<td>rent_hi_low</td>
<td></td>
<td>sequence with 1 = customer with highest rentals</td>
</tr>
<tr class="odd">
<td>rent_low_hi</td>
<td></td>
<td>sequence with 1 = customer with the lowest rentals</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb571"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb571-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb571-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb571-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb571-4" data-line-number="4"></a>
<a class="sourceLine" id="cb571-5" data-line-number="5">customer_rentals_hi_low_dplr &lt;-<span class="st"> </span><span class="cf">function</span>(high_n,low_n) {</a>
<a class="sourceLine" id="cb571-6" data-line-number="6">    customer_table &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbReadTable</span>(con, <span class="st">&quot;customer&quot;</span>)</a>
<a class="sourceLine" id="cb571-7" data-line-number="7">    rental_table   &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbReadTable</span>(con, <span class="st">&quot;rental&quot;</span>)</a>
<a class="sourceLine" id="cb571-8" data-line-number="8">    </a>
<a class="sourceLine" id="cb571-9" data-line-number="9">    customer_rental_loj_hi_low_d &lt;-<span class="st"> </span>customer_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb571-10" data-line-number="10"><span class="st">        </span><span class="kw">left_join</span>(rental_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;customer_id&quot;</span> =<span class="st"> &quot;customer_id&quot;</span>)</a>
<a class="sourceLine" id="cb571-11" data-line-number="11">                  , <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.c&quot;</span>, <span class="st">&quot;.r&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb571-12" data-line-number="12"><span class="st">      </span></a>
<a class="sourceLine" id="cb571-13" data-line-number="13"><span class="st">    </span><span class="kw">left_join</span>(payment_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;rental_id&quot;</span> =<span class="st"> &quot;rental_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&#39;r&#39;</span>,<span class="st">&#39;p&#39;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb571-14" data-line-number="14"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">customer=</span><span class="kw">paste</span>(first_name,last_name,<span class="dt">sep=</span><span class="st">&#39; &#39;</span>)</a>
<a class="sourceLine" id="cb571-15" data-line-number="15">          ,<span class="dt">rented =</span> <span class="kw">if_else</span>(<span class="kw">is.na</span>(rental_id),<span class="dv">0</span>, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb571-16" data-line-number="16">          ,<span class="dt">paid =</span> <span class="kw">if_else</span>(<span class="kw">is.na</span>(payment_id),<span class="dv">0</span>,<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb571-17" data-line-number="17">          ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb571-18" data-line-number="18"><span class="st">    </span><span class="kw">group_by</span>(customer_id.x,customer,rented) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb571-19" data-line-number="19"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">cust_cnt =</span> <span class="kw">n</span>()</a>
<a class="sourceLine" id="cb571-20" data-line-number="20">             ,<span class="dt">rentals=</span><span class="kw">sum</span>(rented)</a>
<a class="sourceLine" id="cb571-21" data-line-number="21">             ,<span class="dt">payments =</span> <span class="kw">sum</span>(paid)</a>
<a class="sourceLine" id="cb571-22" data-line-number="22">             ,<span class="dt">paid_amt =</span> <span class="kw">sum</span>(<span class="kw">ifelse</span>(<span class="kw">is.na</span>(amount),<span class="dv">0</span>,amount))</a>
<a class="sourceLine" id="cb571-23" data-line-number="23">            ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb571-24" data-line-number="24"><span class="st">    </span><span class="kw">rename</span>(<span class="dt">id=</span>customer_id.x) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb571-25" data-line-number="25"><span class="st">    </span><span class="kw">select</span>(id,customer,cust_cnt,rentals,payments,paid_amt) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb571-26" data-line-number="26"><span class="st">    </span><span class="kw">arrange</span>(<span class="kw">desc</span>(rentals)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb571-27" data-line-number="27"><span class="st">  </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb571-28" data-line-number="28">    </a>
<a class="sourceLine" id="cb571-29" data-line-number="29"><span class="co">#</span></a>
<a class="sourceLine" id="cb571-30" data-line-number="30"><span class="co">#   Add the rankings </span></a>
<a class="sourceLine" id="cb571-31" data-line-number="31"><span class="co">#    </span></a>
<a class="sourceLine" id="cb571-32" data-line-number="32">    customer_rental_loj_hi_low_d &lt;-<span class="st"> </span><span class="kw">cbind</span>(customer_rental_loj_hi_low_d</a>
<a class="sourceLine" id="cb571-33" data-line-number="33">                                         ,<span class="dt">rent_hi_low =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(customer_rental_loj_hi_low_d)</a>
<a class="sourceLine" id="cb571-34" data-line-number="34">                                         ,<span class="dt">rent_low_hi =</span> <span class="kw">nrow</span>(customer_rental_loj_hi_low_d)<span class="op">:</span><span class="dv">1</span></a>
<a class="sourceLine" id="cb571-35" data-line-number="35">                                         )</a>
<a class="sourceLine" id="cb571-36" data-line-number="36">    customer_rental_loj_hi_low_d <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb571-37" data-line-number="37"><span class="st">        </span><span class="kw">filter</span>(rent_hi_low <span class="op">&lt;=</span><span class="st"> </span>high_n <span class="op">|</span><span class="st"> </span>rent_low_hi <span class="op">&lt;=</span><span class="st"> </span>low_n) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb571-38" data-line-number="38"><span class="st">        </span><span class="kw">arrange</span>(rent_hi_low) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb571-39" data-line-number="39"><span class="st">  </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb571-40" data-line-number="40">    </a>
<a class="sourceLine" id="cb571-41" data-line-number="41">}</a></code></pre></div>
<p>The following code doesn’t run.</p>
<div class="sourceCode" id="cb572"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb572-1" data-line-number="1"><span class="co"># top_n = 5</span></a>
<a class="sourceLine" id="cb572-2" data-line-number="2"><span class="co"># bot_n = 5</span></a>
<a class="sourceLine" id="cb572-3" data-line-number="3"><span class="co"># sp_print_df(customer_rentals_hi_low_dplr(top_n,bot_n))</span></a></code></pre></div>
</div>
</div>
<div id="how-much-has-each-store-collected-1" class="section level3">
<h3><span class="header-section-number">25.1.27</span> 28. How much has each store collected?</h3>
<p>How are the stores performing? The SQL code shows the payments made to each store in the business.</p>
<div class="sourceCode" id="cb573"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb573-1" data-line-number="1">store_payments_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb573-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb573-3" data-line-number="3">  <span class="st">&quot;select s.store_id,sum(p.amount) amount,count(*) cnt </span></a>
<a class="sourceLine" id="cb573-4" data-line-number="4"><span class="st">                   from payment p </span></a>
<a class="sourceLine" id="cb573-5" data-line-number="5"><span class="st">                        join staff s </span></a>
<a class="sourceLine" id="cb573-6" data-line-number="6"><span class="st">                          on p.staff_id = s.staff_id  </span></a>
<a class="sourceLine" id="cb573-7" data-line-number="7"><span class="st">                 group by store_id order by 2 desc</span></a>
<a class="sourceLine" id="cb573-8" data-line-number="8"><span class="st">                 ;</span></a>
<a class="sourceLine" id="cb573-9" data-line-number="9"><span class="st">                &quot;</span></a>
<a class="sourceLine" id="cb573-10" data-line-number="10">)</a>
<a class="sourceLine" id="cb573-11" data-line-number="11"><span class="kw">sp_print_df</span>(store_payments_sql)</a></code></pre></div>
<div id="htmlwidget-619cf737bf6ed4e2fae9" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-619cf737bf6ed4e2fae9">{"x":{"filter":"none","data":[["1","2"],[2,1],[31059.92,30252.12],[7304,7292]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>store_id<\/th>\n      <th>amount<\/th>\n      <th>cnt<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>Each store collected just over 30,000 in revenue and each store had about 7300 rentals.</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-57" class="section level4">
<h4><span class="header-section-number">25.1.27.1</span> Replicate the output above using dplyr syntax.</h4>
<div class="sourceCode" id="cb574"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb574-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb574-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb574-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb574-4" data-line-number="4"></a>
<a class="sourceLine" id="cb574-5" data-line-number="5">store_payments_dplyr &lt;-<span class="st"> </span>payment_table <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb574-6" data-line-number="6"><span class="st">    </span><span class="kw">inner_join</span>(staff_table,<span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;staff_id&#39;</span>,<span class="st">&#39;staff_id&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb574-7" data-line-number="7"><span class="st">    </span><span class="kw">group_by</span>(staff_id) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb574-8" data-line-number="8"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">amount=</span><span class="kw">sum</span>(amount,<span class="dt">na.rm=</span><span class="ot">TRUE</span>),<span class="dt">cnt=</span><span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st">  </span></a>
<a class="sourceLine" id="cb574-9" data-line-number="9"><span class="st">    </span><span class="kw">arrange</span>(<span class="kw">desc</span>(amount)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb574-10" data-line-number="10"><span class="st">  </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb574-11" data-line-number="11"></a>
<a class="sourceLine" id="cb574-12" data-line-number="12"><span class="kw">sp_print_df</span>(store_payments_dplyr)</a></code></pre></div>
<div id="htmlwidget-4139ca2ad6f87f0aa0d4" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-4139ca2ad6f87f0aa0d4">{"x":{"filter":"none","data":[["1","2"],[2,1],[31059.92,30252.12],[7304,7292]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>staff_id<\/th>\n      <th>amount<\/th>\n      <th>cnt<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="what-is-the-business-distribution-of-payments-1" class="section level3">
<h3><span class="header-section-number">25.1.28</span> 29. What is the business’ distribution of payments?</h3>
<p>To answer this question we look at the <code>rental</code>, <code>payment</code>, <code>inventory</code>, and <code>film</code> tables to answer this question.</p>
<p>As a sanity check, we first check the number of rentals and amount payments.</p>
<div class="sourceCode" id="cb575"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb575-1" data-line-number="1">rentals_payments_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb575-2" data-line-number="2"><span class="st">&quot;select &#39;rentals&#39; rec_type, count(*) cnt_amt from rental</span></a>
<a class="sourceLine" id="cb575-3" data-line-number="3"><span class="st"> union</span></a>
<a class="sourceLine" id="cb575-4" data-line-number="4"><span class="st"> select &#39;payments&#39; rec_type, sum(amount) from payment &quot;</span>)</a>
<a class="sourceLine" id="cb575-5" data-line-number="5"><span class="kw">sp_print_df</span>(rentals_payments_sql)</a></code></pre></div>
<div id="htmlwidget-27fdaedd3ddcca9c350f" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-27fdaedd3ddcca9c350f">{"x":{"filter":"none","data":[["1","2"],["payments","rentals"],[61312.04,16045]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>rec_type<\/th>\n      <th>cnt_amt<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":2},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb576"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb576-1" data-line-number="1">business_payment_dist_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb576-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb576-3" data-line-number="3"> <span class="st">&quot;select no_pay_rec_due</span></a>
<a class="sourceLine" id="cb576-4" data-line-number="4"><span class="st">      ,no_pay_rec_cnt</span></a>
<a class="sourceLine" id="cb576-5" data-line-number="5"><span class="st">      ,round(100.0 * no_pay_rec_cnt/rentals,2) no_pay_rec_pct</span></a>
<a class="sourceLine" id="cb576-6" data-line-number="6"><span class="st">      ,rate_eq_paid</span></a>
<a class="sourceLine" id="cb576-7" data-line-number="7"><span class="st">      ,rate_eq_paid_cnt</span></a>
<a class="sourceLine" id="cb576-8" data-line-number="8"><span class="st">      ,round(100.0 * rate_eq_paid_cnt/rentals,2) rate_eq_paid_pct</span></a>
<a class="sourceLine" id="cb576-9" data-line-number="9"><span class="st">      ,rate_lt_paid</span></a>
<a class="sourceLine" id="cb576-10" data-line-number="10"><span class="st">      ,rate_lt_over_paid</span></a>
<a class="sourceLine" id="cb576-11" data-line-number="11"><span class="st">      ,rate_lt_paid_cnt</span></a>
<a class="sourceLine" id="cb576-12" data-line-number="12"><span class="st">      ,round(100.0 * rate_lt_paid_cnt/rentals,2) rate_lt_paid_pct</span></a>
<a class="sourceLine" id="cb576-13" data-line-number="13"><span class="st">      ,rate_gt_paid_due</span></a>
<a class="sourceLine" id="cb576-14" data-line-number="14"><span class="st">      ,rate_gt_paid_cnt</span></a>
<a class="sourceLine" id="cb576-15" data-line-number="15"><span class="st">      ,round(100.0 * rate_gt_paid_cnt/rentals,2) rate_gt_paid_pct</span></a>
<a class="sourceLine" id="cb576-16" data-line-number="16"><span class="st">      ,rentals</span></a>
<a class="sourceLine" id="cb576-17" data-line-number="17"><span class="st">      ,rate_eq_paid_cnt + rate_lt_paid_cnt + rate_gt_paid_cnt payments</span></a>
<a class="sourceLine" id="cb576-18" data-line-number="18"><span class="st">      ,round(100.0 * </span></a>
<a class="sourceLine" id="cb576-19" data-line-number="19"><span class="st">            (no_pay_rec_cnt + rate_eq_paid_cnt + rate_lt_paid_cnt + rate_gt_paid_cnt)/rentals</span></a>
<a class="sourceLine" id="cb576-20" data-line-number="20"><span class="st">            ,2) pct</span></a>
<a class="sourceLine" id="cb576-21" data-line-number="21"><span class="st">      ,rate_eq_paid + rate_lt_paid + rate_lt_over_paid amt_paid</span></a>
<a class="sourceLine" id="cb576-22" data-line-number="22"><span class="st">      ,no_pay_rec_due + rate_gt_paid_due amt_due</span></a>
<a class="sourceLine" id="cb576-23" data-line-number="23"><span class="st">  from (</span></a>
<a class="sourceLine" id="cb576-24" data-line-number="24"><span class="st">        select sum(case when p.rental_id is null then rental_rate else 0 end ) no_pay_rec_due</span></a>
<a class="sourceLine" id="cb576-25" data-line-number="25"><span class="st">              ,sum(case when p.rental_id is null then 1 else 0 end) no_pay_rec_cnt</span></a>
<a class="sourceLine" id="cb576-26" data-line-number="26"><span class="st">              ,sum(case when f.rental_rate = p.amount </span></a>
<a class="sourceLine" id="cb576-27" data-line-number="27"><span class="st">                        then p.amount else 0 end) rate_eq_paid</span></a>
<a class="sourceLine" id="cb576-28" data-line-number="28"><span class="st">              ,sum(case when f.rental_rate = p.amount </span></a>
<a class="sourceLine" id="cb576-29" data-line-number="29"><span class="st">                        then 1 else 0 end ) rate_eq_paid_cnt</span></a>
<a class="sourceLine" id="cb576-30" data-line-number="30"><span class="st">              ,sum(case when f.rental_rate &lt; p.amount </span></a>
<a class="sourceLine" id="cb576-31" data-line-number="31"><span class="st">                        then f.rental_rate else 0 end) rate_lt_paid</span></a>
<a class="sourceLine" id="cb576-32" data-line-number="32"><span class="st">              ,sum(case when f.rental_rate &lt; p.amount </span></a>
<a class="sourceLine" id="cb576-33" data-line-number="33"><span class="st">                        then p.amount-f.rental_rate else 0 end) rate_lt_over_paid</span></a>
<a class="sourceLine" id="cb576-34" data-line-number="34"><span class="st">              ,sum(case when f.rental_rate &lt; p.amount </span></a>
<a class="sourceLine" id="cb576-35" data-line-number="35"><span class="st">                        then 1 else 0 end) rate_lt_paid_cnt</span></a>
<a class="sourceLine" id="cb576-36" data-line-number="36"><span class="st">              ,sum(case when f.rental_rate &gt; p.amount </span></a>
<a class="sourceLine" id="cb576-37" data-line-number="37"><span class="st">                        then f.rental_rate - p.amount else 0 end ) rate_gt_paid_due</span></a>
<a class="sourceLine" id="cb576-38" data-line-number="38"><span class="st">              ,sum(case when f.rental_rate &gt; p.amount </span></a>
<a class="sourceLine" id="cb576-39" data-line-number="39"><span class="st">                        then 1 else 0 end ) rate_gt_paid_cnt</span></a>
<a class="sourceLine" id="cb576-40" data-line-number="40"><span class="st">              ,count(*) rentals</span></a>
<a class="sourceLine" id="cb576-41" data-line-number="41"><span class="st">            FROM rental r</span></a>
<a class="sourceLine" id="cb576-42" data-line-number="42"><span class="st">                 LEFT JOIN payment p ON r.rental_id = p.rental_id and r.customer_id = p.customer_id</span></a>
<a class="sourceLine" id="cb576-43" data-line-number="43"><span class="st">                 INNER JOIN inventory i ON r.inventory_id = i.inventory_id</span></a>
<a class="sourceLine" id="cb576-44" data-line-number="44"><span class="st">                 INNER JOIN film f ON i.film_id = f.film_id</span></a>
<a class="sourceLine" id="cb576-45" data-line-number="45"><span class="st">       ) as details</span></a>
<a class="sourceLine" id="cb576-46" data-line-number="46"><span class="st">;&quot;</span></a>
<a class="sourceLine" id="cb576-47" data-line-number="47">)</a>
<a class="sourceLine" id="cb576-48" data-line-number="48"><span class="co"># Rental counts</span></a>
<a class="sourceLine" id="cb576-49" data-line-number="49"><span class="kw">sp_print_df</span>(business_payment_dist_sql <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">ends_with</span>(<span class="st">&quot;cnt&quot;</span>),rentals))</a></code></pre></div>
<div id="htmlwidget-a0cd32aa67630f6b8dd0" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-a0cd32aa67630f6b8dd0">{"x":{"filter":"none","data":[["1"],[1453],[7925],[6643],[24],[16045]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>no_pay_rec_cnt<\/th>\n      <th>rate_eq_paid_cnt<\/th>\n      <th>rate_lt_paid_cnt<\/th>\n      <th>rate_gt_paid_cnt<\/th>\n      <th>rentals<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb577"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb577-1" data-line-number="1"><span class="co"># Payments</span></a>
<a class="sourceLine" id="cb577-2" data-line-number="2"><span class="kw">sp_print_df</span>(business_payment_dist_sql <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">ends_with</span>(<span class="st">&quot;paid&quot;</span>)))</a></code></pre></div>
<div id="htmlwidget-d603924d095b44f9f39d" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-d603924d095b44f9f39d">{"x":{"filter":"none","data":[["1"],[23397.75],[19448.57],[18456.76],[61303.08]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>rate_eq_paid<\/th>\n      <th>rate_lt_paid<\/th>\n      <th>rate_lt_over_paid<\/th>\n      <th>amt_paid<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb578"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb578-1" data-line-number="1"><span class="co"># Not paid amounts</span></a>
<a class="sourceLine" id="cb578-2" data-line-number="2"><span class="kw">sp_print_df</span>(business_payment_dist_sql <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">ends_with</span>(<span class="st">&quot;due&quot;</span>)))</a></code></pre></div>
<div id="htmlwidget-f6e01e985baca3b2a01f" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-f6e01e985baca3b2a01f">{"x":{"filter":"none","data":[["1"],[4302.47],[67.76],[4370.23]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>no_pay_rec_due<\/th>\n      <th>rate_gt_paid_due<\/th>\n      <th>amt_due<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb579"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb579-1" data-line-number="1"><span class="co"># Rental payments</span></a>
<a class="sourceLine" id="cb579-2" data-line-number="2"><span class="kw">sp_print_df</span>(business_payment_dist_sql <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">ends_with</span>(<span class="st">&quot;pct&quot;</span>)))</a></code></pre></div>
<div id="htmlwidget-472c2b8f6d63d7358265" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-472c2b8f6d63d7358265">{"x":{"filter":"none","data":[["1"],[9.06],[49.39],[41.4],[0.15],[100]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>no_pay_rec_pct<\/th>\n      <th>rate_eq_paid_pct<\/th>\n      <th>rate_lt_paid_pct<\/th>\n      <th>rate_gt_paid_pct<\/th>\n      <th>pct<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>These are interesting results.</p>
<ul>
<li>09.06% of the total records have no associated payment record in the amount of 4302.47<br />
</li>
<li>49.39% of the rentals have been fully paid in full, 23397.75.</li>
<li>41.40% of the rentals have collected more than the rental amount by 18456.75</li>
<li>00.15% of the rentals have collected less than the rental amount by 67.76.</li>
<li>The no_pay_rec_cnt + rate_gt_paid_cnt, <span class="math inline">\(1453 + 24 = 1477\)</span> is the number of rentals which have not been paid in full.</li>
<li>The total outstanding balance is <span class="math inline">\(4302.47 + 67.76 = 4370.23\)</span></li>
</ul>
<p>With over 40 percent over collection, someone needs to find out what is wrong with the collection process. Many customers are owed credits or free rentals.
</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-58" class="section level4">
<h4><span class="header-section-number">25.1.28.1</span> Replicate the output above using dplyr syntax.</h4>
<p>This table describes the columns in the code block answer that follows. There are payment records where the charged amount, rental rate, is less than the amount paid. These payments are split into two pieces, rate_lt_paid and rate_lt_over_paid. The rate_lt_paid is rental rate amount. The rate_lt_over_paid is the paid amount - rental rate, the over paid amount.</p>
<table>
<colgroup>
<col width="32%" />
<col width="42%" />
<col width="26%" />
</colgroup>
<thead>
<tr class="header">
<th>Column</th>
<th>Mapping</th>
<th>Definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>no_pay_rec_cnt</td>
<td></td>
<td>number of DVD rentals without an associated payment record.</td>
</tr>
<tr class="even">
<td>rate_eq_paid_cnt</td>
<td></td>
<td>number of DVD payments that match the film rental rate.</td>
</tr>
<tr class="odd">
<td>rate_lt_paid_cnt</td>
<td></td>
<td>number of DVD rental with rental rate less than the amount paid.</td>
</tr>
<tr class="even">
<td>rate_gt_paid_cnt</td>
<td></td>
<td>number of DVD rentals with rental rate greater than the film rental rate.</td>
</tr>
<tr class="odd">
<td>rentals</td>
<td></td>
<td>number of rental records analyzed</td>
</tr>
<tr class="even">
<td>rate_eq_paid</td>
<td></td>
<td>amount paid where the rate charged = amount paid</td>
</tr>
<tr class="odd">
<td>rate_lt_paid</td>
<td></td>
<td>amount paid where the rate charged &lt;</td>
</tr>
<tr class="even">
<td>rate_lt_over_paid</td>
<td></td>
<td>rate charged &lt; amount paid; This represents the amount over paid</td>
</tr>
<tr class="odd">
<td>amt_paid</td>
<td></td>
<td>Total amount paid</td>
</tr>
<tr class="even">
<td>no_pay_rec_due</td>
<td></td>
<td>DVD rentals charges due without a payment record</td>
</tr>
<tr class="odd">
<td>rate_gt_paid_due</td>
<td></td>
<td>DVD rentals charged due with a payment record</td>
</tr>
<tr class="even">
<td>amt_due</td>
<td></td>
<td>Total amount due and not collected.</td>
</tr>
<tr class="odd">
<td>no_pay_rec_pct</td>
<td></td>
<td>Percent of rentals without a payment record.</td>
</tr>
<tr class="even">
<td>rate_lt_paid_pct</td>
<td></td>
<td>Percent of rentals where the rental charge is less than the paid amount</td>
</tr>
<tr class="odd">
<td>rate_gt_paid_pct</td>
<td></td>
<td>Percent of rentals where the rental charge is greater than the paid amount</td>
</tr>
<tr class="even">
<td>pct</td>
<td></td>
<td>Sum of percentages</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb580"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb580-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb580-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb580-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb580-4" data-line-number="4"></a>
<a class="sourceLine" id="cb580-5" data-line-number="5">business_payment_dist_dplyr &lt;-<span class="st"> </span>rental_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb580-6" data-line-number="6"><span class="st">    </span><span class="kw">left_join</span>(payment_table</a>
<a class="sourceLine" id="cb580-7" data-line-number="7">             , <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;rental_id&quot;</span>, <span class="st">&quot;rental_id&quot;</span></a>
<a class="sourceLine" id="cb580-8" data-line-number="8">                     ,<span class="st">&quot;customer_id&quot;</span>,<span class="st">&quot;customer_id&quot;</span></a>
<a class="sourceLine" id="cb580-9" data-line-number="9">                     )</a>
<a class="sourceLine" id="cb580-10" data-line-number="10">             , <span class="dt">suffix =</span> <span class="kw">c</span>(<span class="st">&quot;.r&quot;</span>, <span class="st">&quot;.p&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb580-11" data-line-number="11"><span class="st">    </span><span class="kw">inner_join</span>(inventory_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;inventory_id&quot;</span>, <span class="st">&quot;inventory_id&quot;</span>), <span class="dt">suffix =</span> <span class="kw">c</span>(<span class="st">&quot;.r&quot;</span>, <span class="st">&quot;.i&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb580-12" data-line-number="12"><span class="st">    </span><span class="kw">inner_join</span>(film_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;film_id&quot;</span>, <span class="st">&quot;film_id&quot;</span>), <span class="dt">suffix =</span> <span class="kw">c</span>(<span class="st">&quot;.i&quot;</span>, <span class="st">&quot;.f&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb580-13" data-line-number="13"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">rentals =</span> <span class="kw">n</span>()</a>
<a class="sourceLine" id="cb580-14" data-line-number="14">             ,<span class="dt">no_pay_rec_due =</span> <span class="kw">sum</span>(<span class="kw">ifelse</span>(<span class="kw">is.na</span>(payment_id),rental_rate,<span class="dv">0</span>),<span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb580-15" data-line-number="15">             ,<span class="dt">no_pay_rec_cnt =</span> <span class="kw">sum</span>(<span class="kw">ifelse</span>(<span class="kw">is.na</span>(payment_id),<span class="dv">1</span>,<span class="dv">0</span>),<span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb580-16" data-line-number="16">             ,<span class="dt">rate_eq_paid   =</span> <span class="kw">sum</span>(<span class="kw">ifelse</span>(rental_rate <span class="op">==</span><span class="st"> </span>amount,amount,<span class="dv">0</span>),<span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb580-17" data-line-number="17">             ,<span class="dt">rate_eq_paid_cnt   =</span> <span class="kw">sum</span>(<span class="kw">ifelse</span>(rental_rate <span class="op">==</span><span class="st"> </span>amount,<span class="dv">1</span>,<span class="dv">0</span>),<span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb580-18" data-line-number="18">             ,<span class="dt">rental_amt     =</span> <span class="kw">sum</span>(<span class="kw">ifelse</span>(rental_rate <span class="op">&lt;</span><span class="st"> </span>amount,rental_rate,<span class="dv">0</span>),<span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb580-19" data-line-number="19">             ,<span class="dt">rate_lt_paid =</span> <span class="kw">sum</span>(<span class="kw">ifelse</span>(rental_rate <span class="op">&lt;</span><span class="st"> </span>amount, rental_rate,<span class="dv">0</span>),<span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb580-20" data-line-number="20">             ,<span class="dt">rate_lt_over_paid  =</span> <span class="kw">sum</span>(<span class="kw">ifelse</span>(rental_rate <span class="op">&lt;</span><span class="st"> </span>amount,amount<span class="op">-</span>rental_rate,<span class="dv">0</span>),<span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb580-21" data-line-number="21">             ,<span class="dt">rate_lt_paid_cnt  =</span> <span class="kw">sum</span>(<span class="kw">ifelse</span>(rental_rate <span class="op">&lt;</span><span class="st"> </span>amount,<span class="dv">1</span>,<span class="dv">0</span>),<span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb580-22" data-line-number="22">             ,<span class="dt">rate_gt_paid_due =</span> <span class="kw">sum</span>(<span class="kw">ifelse</span>(amount <span class="op">&lt;</span><span class="st"> </span>rental_rate,rental_rate<span class="op">-</span>amount,<span class="dv">0</span>),<span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb580-23" data-line-number="23">             ,<span class="dt">rate_gt_paid_cnt =</span> <span class="kw">sum</span>(<span class="kw">ifelse</span>(amount <span class="op">&lt;</span><span class="st"> </span>rental_rate,<span class="dv">1</span>,<span class="dv">0</span>),<span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb580-24" data-line-number="24">             ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb580-25" data-line-number="25"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">no_pay_rec_pct =</span> <span class="kw">round</span>(<span class="dv">100</span> <span class="op">*</span><span class="st"> </span>no_pay_rec_cnt<span class="op">/</span>rentals,<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb580-26" data-line-number="26">          ,<span class="dt">rate_eq_paid_pct   =</span> <span class="kw">round</span>(<span class="dv">100</span> <span class="op">*</span><span class="st"> </span>rate_eq_paid_cnt<span class="op">/</span>rentals,<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb580-27" data-line-number="27">          ,<span class="dt">rate_lt_paid_pct  =</span> <span class="kw">round</span>(<span class="dv">100</span> <span class="op">*</span><span class="st"> </span>rate_lt_paid_cnt<span class="op">/</span>rentals,<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb580-28" data-line-number="28">          ,<span class="dt">rate_gt_paid_pct =</span> <span class="kw">round</span>(<span class="dv">100</span> <span class="op">*</span><span class="st"> </span>rate_gt_paid_cnt<span class="op">/</span>rentals,<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb580-29" data-line-number="29">          ,<span class="dt">payments =</span> rate_eq_paid_cnt <span class="op">+</span><span class="st"> </span>rate_lt_paid_cnt <span class="op">+</span><span class="st"> </span>rate_gt_paid_cnt</a>
<a class="sourceLine" id="cb580-30" data-line-number="30">          ,<span class="dt">amt_paid =</span> rate_eq_paid <span class="op">+</span><span class="st"> </span>rate_lt_over_paid <span class="op">+</span><span class="st">  </span>rental_amt </a>
<a class="sourceLine" id="cb580-31" data-line-number="31">          ,<span class="dt">pct =</span> no_pay_rec_pct <span class="op">+</span><span class="st"> </span>rate_eq_paid_pct <span class="op">+</span><span class="st"> </span>rate_lt_paid_pct <span class="op">+</span><span class="st"> </span>rate_gt_paid_pct</a>
<a class="sourceLine" id="cb580-32" data-line-number="32">          ,<span class="dt">amt_due =</span> no_pay_rec_due <span class="op">+</span><span class="st"> </span>rate_gt_paid_due</a>
<a class="sourceLine" id="cb580-33" data-line-number="33">          ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb580-34" data-line-number="34"><span class="st">    </span><span class="kw">select</span> (no_pay_rec_due,no_pay_rec_cnt,no_pay_rec_pct</a>
<a class="sourceLine" id="cb580-35" data-line-number="35">           ,rate_eq_paid,rate_eq_paid_cnt,rate_eq_paid_pct</a>
<a class="sourceLine" id="cb580-36" data-line-number="36">           ,rate_lt_paid,rate_lt_over_paid,rate_lt_paid_cnt,rate_lt_paid_pct</a>
<a class="sourceLine" id="cb580-37" data-line-number="37">           ,rate_gt_paid_due,rate_gt_paid_cnt,rate_gt_paid_pct</a>
<a class="sourceLine" id="cb580-38" data-line-number="38">           ,rentals</a>
<a class="sourceLine" id="cb580-39" data-line-number="39">           </a>
<a class="sourceLine" id="cb580-40" data-line-number="40">           ,payments</a>
<a class="sourceLine" id="cb580-41" data-line-number="41">           ,pct</a>
<a class="sourceLine" id="cb580-42" data-line-number="42">           ,amt_paid</a>
<a class="sourceLine" id="cb580-43" data-line-number="43">           ,amt_due) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb580-44" data-line-number="44"><span class="st">    </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb580-45" data-line-number="45">    </a>
<a class="sourceLine" id="cb580-46" data-line-number="46"></a>
<a class="sourceLine" id="cb580-47" data-line-number="47"><span class="co"># Rental counts</span></a>
<a class="sourceLine" id="cb580-48" data-line-number="48"><span class="kw">sp_print_df</span>(business_payment_dist_dplyr <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">ends_with</span>(<span class="st">&quot;cnt&quot;</span>),rentals))</a></code></pre></div>
<div id="htmlwidget-42cd4e14f26053aac67b" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-42cd4e14f26053aac67b">{"x":{"filter":"none","data":[["1"],[1453],[7925],[6643],[24],[16045]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>no_pay_rec_cnt<\/th>\n      <th>rate_eq_paid_cnt<\/th>\n      <th>rate_lt_paid_cnt<\/th>\n      <th>rate_gt_paid_cnt<\/th>\n      <th>rentals<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb581"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb581-1" data-line-number="1"><span class="co"># Payments</span></a>
<a class="sourceLine" id="cb581-2" data-line-number="2"><span class="kw">sp_print_df</span>(business_payment_dist_dplyr <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">ends_with</span>(<span class="st">&quot;paid&quot;</span>)))</a></code></pre></div>
<div id="htmlwidget-ed0cabd356ee7bf24f99" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-ed0cabd356ee7bf24f99">{"x":{"filter":"none","data":[["1"],[23397.75],[19448.57],[18456.76],[61303.08]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>rate_eq_paid<\/th>\n      <th>rate_lt_paid<\/th>\n      <th>rate_lt_over_paid<\/th>\n      <th>amt_paid<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb582"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb582-1" data-line-number="1"><span class="co"># Not paid amounts</span></a>
<a class="sourceLine" id="cb582-2" data-line-number="2"><span class="kw">sp_print_df</span>(business_payment_dist_dplyr <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">ends_with</span>(<span class="st">&quot;due&quot;</span>)))</a></code></pre></div>
<div id="htmlwidget-e39b708ff0d549d74256" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-e39b708ff0d549d74256">{"x":{"filter":"none","data":[["1"],[4302.47],[67.76],[4370.23]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>no_pay_rec_due<\/th>\n      <th>rate_gt_paid_due<\/th>\n      <th>amt_due<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb583"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb583-1" data-line-number="1"><span class="co"># Rental payments</span></a>
<a class="sourceLine" id="cb583-2" data-line-number="2"><span class="kw">sp_print_df</span>(business_payment_dist_dplyr <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">ends_with</span>(<span class="st">&quot;pct&quot;</span>)))</a></code></pre></div>
<div id="htmlwidget-8e3082ed4e5b0ee283ce" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-8e3082ed4e5b0ee283ce">{"x":{"filter":"none","data":[["1"],[9.06],[49.39],[41.4],[0.15],[100]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>no_pay_rec_pct<\/th>\n      <th>rate_eq_paid_pct<\/th>\n      <th>rate_lt_paid_pct<\/th>\n      <th>rate_gt_paid_pct<\/th>\n      <th>pct<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="bad-data-analysis-1" class="section level4">
<h4><span class="header-section-number">25.1.28.2</span> Bad data analysis</h4>
<p>Here are the sanity check numbers calculated at the beginning of this exercise.</p>
<table>
<thead>
<tr class="header">
<th>rec_type</th>
<th>cnt_amt</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>payments</td>
<td>61312.04</td>
</tr>
<tr class="even">
<td>rentals</td>
<td>16045.00</td>
</tr>
</tbody>
</table>
<p>Note that the sanity check numbers above, do not match the numbers above. If you query returned the numbers above, use the following result set ot see where the differences exist.</p>
<div class="sourceCode" id="cb584"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb584-1" data-line-number="1">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb584-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb584-3" data-line-number="3"> <span class="st">&quot;SELECT  &#39;correct join&#39; hint,r.rental_id,r.customer_id,p.customer_id payment_customer_id,p.rental_id payment_rental_id,p.amount</span></a>
<a class="sourceLine" id="cb584-4" data-line-number="4"><span class="st">    FROM rental r</span></a>
<a class="sourceLine" id="cb584-5" data-line-number="5"><span class="st">         LEFT JOIN payment p ON r.rental_id = p.rental_id and r.customer_id = p.customer_id</span></a>
<a class="sourceLine" id="cb584-6" data-line-number="6"><span class="st">   where r.rental_id = 4591</span></a>
<a class="sourceLine" id="cb584-7" data-line-number="7"><span class="st">  UNION </span></a>
<a class="sourceLine" id="cb584-8" data-line-number="8"><span class="st"> SELECT  &#39;incorrect join&#39; hint,r.rental_id,r.customer_id,p.customer_id payment_customer_id,p.rental_id payment_rental_id,p.amount</span></a>
<a class="sourceLine" id="cb584-9" data-line-number="9"><span class="st">    FROM rental r</span></a>
<a class="sourceLine" id="cb584-10" data-line-number="10"><span class="st">         LEFT JOIN payment p ON r.rental_id = p.rental_id</span></a>
<a class="sourceLine" id="cb584-11" data-line-number="11"><span class="st">   where r.rental_id = 4591</span></a>
<a class="sourceLine" id="cb584-12" data-line-number="12"><span class="st">     and p.customer_id != 182</span></a>
<a class="sourceLine" id="cb584-13" data-line-number="13"><span class="st">;&quot;</span>)</a>
<a class="sourceLine" id="cb584-14" data-line-number="14"><span class="kw">sp_print_df</span>(<span class="kw">head</span>(rs))</a></code></pre></div>
<div id="htmlwidget-3cafdc732b82de0842ef" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-3cafdc732b82de0842ef">{"x":{"filter":"none","data":[["1","2","3","4","5"],["incorrect join","incorrect join","incorrect join","incorrect join","correct join"],[4591,4591,4591,4591,4591],[182,182,182,182,182],[546,401,16,259,182],[4591,4591,4591,4591,4591],[3.99,0.99,1.99,1.99,3.99]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>hint<\/th>\n      <th>rental_id<\/th>\n      <th>customer_id<\/th>\n      <th>payment_customer_id<\/th>\n      <th>payment_rental_id<\/th>\n      <th>amount<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4,5,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="which-customers-have-the-highest-open-amounts-1" class="section level3">
<h3><span class="header-section-number">25.1.29</span> 30. Which customers have the highest open amounts?</h3>
<p>From the previous exercise, we know that there are 1477 missing payment records or not fully paid payment records. List the top 5 customers from each category base on balance due amounts.</p>
<p>To answer this question we look at the <code>rental</code>, <code>payment</code>, <code>inventory</code>, <code>film</code> and <code>customer</code> tables to answer this question.</p>
<div class="sourceCode" id="cb585"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb585-1" data-line-number="1">customer_open_amts_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb585-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb585-3" data-line-number="3"><span class="st">&quot;  select customer_id</span></a>
<a class="sourceLine" id="cb585-4" data-line-number="4"><span class="st">         ,concat(first_name,&#39; &#39;,last_name) customer</span></a>
<a class="sourceLine" id="cb585-5" data-line-number="5"><span class="st">         ,pay_record</span></a>
<a class="sourceLine" id="cb585-6" data-line-number="6"><span class="st">         ,rental_amt</span></a>
<a class="sourceLine" id="cb585-7" data-line-number="7"><span class="st">         ,paid_amt</span></a>
<a class="sourceLine" id="cb585-8" data-line-number="8"><span class="st">         ,due_amt</span></a>
<a class="sourceLine" id="cb585-9" data-line-number="9"><span class="st">         ,cnt</span></a>
<a class="sourceLine" id="cb585-10" data-line-number="10"><span class="st">         ,rn</span></a>
<a class="sourceLine" id="cb585-11" data-line-number="11"><span class="st">  from (select c.customer_id</span></a>
<a class="sourceLine" id="cb585-12" data-line-number="12"><span class="st">              ,c.first_name</span></a>
<a class="sourceLine" id="cb585-13" data-line-number="13"><span class="st">              ,c.last_name</span></a>
<a class="sourceLine" id="cb585-14" data-line-number="14"><span class="st">              ,case when p.amount is null then &#39;No&#39; else &#39;Yes&#39; end Pay_record</span></a>
<a class="sourceLine" id="cb585-15" data-line-number="15"><span class="st">              ,sum(f.rental_rate) rental_amt</span></a>
<a class="sourceLine" id="cb585-16" data-line-number="16"><span class="st">              ,sum(coalesce(p.amount,0))  paid_amt</span></a>
<a class="sourceLine" id="cb585-17" data-line-number="17"><span class="st">              ,sum(f.rental_rate - coalesce(p.amount,0)) due_amt</span></a>
<a class="sourceLine" id="cb585-18" data-line-number="18"><span class="st">              ,count(*) cnt</span></a>
<a class="sourceLine" id="cb585-19" data-line-number="19"><span class="st">              ,row_number() over (partition by case when p.amount is null then &#39;No&#39; else &#39;Yes&#39; end</span></a>
<a class="sourceLine" id="cb585-20" data-line-number="20"><span class="st">                                  order by sum(f.rental_rate - coalesce(p.amount,0)) desc,c.customer_id) rn</span></a>
<a class="sourceLine" id="cb585-21" data-line-number="21"><span class="st">          FROM rental r</span></a>
<a class="sourceLine" id="cb585-22" data-line-number="22"><span class="st">               LEFT JOIN payment p</span></a>
<a class="sourceLine" id="cb585-23" data-line-number="23"><span class="st">                 ON r.rental_id = p.rental_id and r.customer_id = p.customer_id</span></a>
<a class="sourceLine" id="cb585-24" data-line-number="24"><span class="st">               INNER JOIN inventory i</span></a>
<a class="sourceLine" id="cb585-25" data-line-number="25"><span class="st">                 ON r.inventory_id = i.inventory_id</span></a>
<a class="sourceLine" id="cb585-26" data-line-number="26"><span class="st">               INNER JOIN film f</span></a>
<a class="sourceLine" id="cb585-27" data-line-number="27"><span class="st">                 ON i.film_id = f.film_id</span></a>
<a class="sourceLine" id="cb585-28" data-line-number="28"><span class="st">               INNER JOIN customer c</span></a>
<a class="sourceLine" id="cb585-29" data-line-number="29"><span class="st">                 ON r.customer_id = c.customer_id</span></a>
<a class="sourceLine" id="cb585-30" data-line-number="30"><span class="st">        WHERE f.rental_rate &gt; coalesce(p.amount, 0)</span></a>
<a class="sourceLine" id="cb585-31" data-line-number="31"><span class="st">       group by c.customer_id,c.first_name,c.last_name,case when p.amount is null then &#39;No&#39; else &#39;Yes&#39; end</span></a>
<a class="sourceLine" id="cb585-32" data-line-number="32"><span class="st">       ) as src</span></a>
<a class="sourceLine" id="cb585-33" data-line-number="33"><span class="st">  where rn &lt;= 5 -- and Pay_record = &#39;No&#39; or Pay_record = &#39;Yes&#39;</span></a>
<a class="sourceLine" id="cb585-34" data-line-number="34"><span class="st">  order by Pay_record,rn</span></a>
<a class="sourceLine" id="cb585-35" data-line-number="35"><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb585-36" data-line-number="36"><span class="kw">sp_print_df</span>(customer_open_amts_sql)</a></code></pre></div>
<div id="htmlwidget-9df3d00c4d83b54877ba" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-9df3d00c4d83b54877ba">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10"],[293,307,316,299,274,75,53,60,155,163],["Mae Fletcher","Joseph Joy","Steven Curley","James Gannon","Naomi Jennings","Tammy Sanders","Heather Morris","Mildred Bailey","Gail Knight","Cathy Spencer"],["No","No","No","No","No","Yes","Yes","Yes","Yes","Yes"],[35.9,31.9,31.9,30.91,29.92,5.98,4.99,4.99,4.99,4.99],[0,0,0,0,0,0,0,0,0,0],[35.9,31.9,31.9,30.91,29.92,5.98,4.99,4.99,4.99,4.99],[10,10,10,9,8,2,1,1,1,1],[1,2,3,4,5,1,2,3,4,5]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>customer_id<\/th>\n      <th>customer<\/th>\n      <th>pay_record<\/th>\n      <th>rental_amt<\/th>\n      <th>paid_amt<\/th>\n      <th>due_amt<\/th>\n      <th>cnt<\/th>\n      <th>rn<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,4,5,6,7,8]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>From the previous exercise we see that the number of rentals that have not been paid in full is 1477. There are 24 records that have a payment record, pay_record = ‘Yes’, all have a 0 paid amount. There are 1453 DVD’s rented out that have no payment record. The top 3 customers have 10 DVD’s each that have not been paid.
</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-59" class="section level4">
<h4><span class="header-section-number">25.1.29.1</span> Replicate the output above using dplyr syntax.</h4>
<table>
<colgroup>
<col width="12%" />
<col width="24%" />
<col width="63%" />
</colgroup>
<thead>
<tr class="header">
<th>column</th>
<th>definition</th>
<th>mapping</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>customer</td>
<td>first_name + last_name</td>
<td></td>
</tr>
<tr class="even">
<td>Pay_record</td>
<td>Payment record exists Y/N</td>
<td>case when p.amount is null then ‘No’ else ‘Yes’ end</td>
</tr>
<tr class="odd">
<td>rental_amt</td>
<td>aggrgated film.rental_rate</td>
<td></td>
</tr>
<tr class="even">
<td>paid_amt</td>
<td>aggregated payment.amount</td>
<td></td>
</tr>
<tr class="odd">
<td>due_amt</td>
<td>aggregated film.rental_rate - payment.amount</td>
<td></td>
</tr>
<tr class="even">
<td>cnt</td>
<td>number of rentals/customer</td>
<td></td>
</tr>
<tr class="odd">
<td>rn</td>
<td>row number</td>
<td></td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb586"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb586-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb586-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb586-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb586-4" data-line-number="4"></a>
<a class="sourceLine" id="cb586-5" data-line-number="5">customer_open_amts_dplyr &lt;-<span class="st"> </span>rental_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb586-6" data-line-number="6"><span class="st">    </span><span class="kw">left_join</span>(payment_table</a>
<a class="sourceLine" id="cb586-7" data-line-number="7">             , <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;rental_id&quot;</span>, <span class="st">&quot;rental_id&quot;</span></a>
<a class="sourceLine" id="cb586-8" data-line-number="8">                     ,<span class="st">&quot;customer_id&quot;</span>,<span class="st">&quot;customer_id&quot;</span></a>
<a class="sourceLine" id="cb586-9" data-line-number="9">                     )</a>
<a class="sourceLine" id="cb586-10" data-line-number="10">             , <span class="dt">suffix =</span> <span class="kw">c</span>(<span class="st">&quot;.r&quot;</span>, <span class="st">&quot;.p&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb586-11" data-line-number="11"><span class="st">    </span><span class="kw">inner_join</span>(inventory_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;inventory_id&quot;</span>, <span class="st">&quot;inventory_id&quot;</span>), <span class="dt">suffix =</span> <span class="kw">c</span>(<span class="st">&quot;.r&quot;</span>, <span class="st">&quot;.i&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb586-12" data-line-number="12"><span class="st">    </span><span class="kw">inner_join</span>(film_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;film_id&quot;</span>, <span class="st">&quot;film_id&quot;</span>), <span class="dt">suffix =</span> <span class="kw">c</span>(<span class="st">&quot;.i&quot;</span>, <span class="st">&quot;.f&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb586-13" data-line-number="13"><span class="st">    </span><span class="kw">inner_join</span>(customer_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&#39;customer_id&#39;</span> =<span class="st"> &#39;customer_id&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb586-14" data-line-number="14"><span class="st">    </span><span class="kw">filter</span>(rental_rate <span class="op">&gt;</span><span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(amount), <span class="dv">0</span>,amount)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb586-15" data-line-number="15"><span class="st">        </span><span class="kw">mutate</span>(<span class="dt">customer=</span><span class="kw">paste0</span>(first_name,<span class="st">&#39; &#39;</span>,last_name)</a>
<a class="sourceLine" id="cb586-16" data-line-number="16">              ,<span class="dt">pay_record =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(amount),<span class="st">&#39;No&#39;</span>,<span class="st">&#39;Yes&#39;</span>)</a>
<a class="sourceLine" id="cb586-17" data-line-number="17">              ,<span class="dt">paid =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(amount),<span class="dv">0</span>,amount)</a>
<a class="sourceLine" id="cb586-18" data-line-number="18">              ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb586-19" data-line-number="19"><span class="st">    </span><span class="kw">group_by</span>(customer_id,customer,pay_record) <span class="op">%&gt;%</span><span class="st">    </span></a>
<a class="sourceLine" id="cb586-20" data-line-number="20"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">rental_amt =</span> <span class="kw">sum</span>(rental_rate)</a>
<a class="sourceLine" id="cb586-21" data-line-number="21">             ,<span class="dt">paid_amt =</span> <span class="kw">sum</span>(paid)</a>
<a class="sourceLine" id="cb586-22" data-line-number="22">             ,<span class="dt">due_amt  =</span> <span class="kw">sum</span>(rental_rate <span class="op">-</span><span class="st"> </span>paid)</a>
<a class="sourceLine" id="cb586-23" data-line-number="23">             ,<span class="dt">cnt =</span> <span class="kw">n</span>()</a>
<a class="sourceLine" id="cb586-24" data-line-number="24">             ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb586-25" data-line-number="25"><span class="st">    </span><span class="kw">arrange</span>(pay_record,<span class="kw">desc</span>(due_amt)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb586-26" data-line-number="26"><span class="st">    </span><span class="kw">group_by</span>(pay_record) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb586-27" data-line-number="27"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">id =</span> <span class="kw">row_number</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb586-28" data-line-number="28"><span class="st">    </span><span class="kw">filter</span>(id <span class="op">&lt;=</span><span class="st"> </span><span class="dv">5</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb586-29" data-line-number="29"><span class="st">    </span><span class="kw">select</span>(customer_id,customer,pay_record,rental_amt,paid_amt,due_amt,cnt,id) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb586-30" data-line-number="30"><span class="st">  </span><span class="kw">collect</span>()</a></code></pre></div>
<pre><code>## Warning: Missing values are always removed in SQL.
## Use `SUM(x, na.rm = TRUE)` to silence this warning

## Warning: Missing values are always removed in SQL.
## Use `SUM(x, na.rm = TRUE)` to silence this warning

## Warning: Missing values are always removed in SQL.
## Use `SUM(x, na.rm = TRUE)` to silence this warning</code></pre>
<div class="sourceCode" id="cb588"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb588-1" data-line-number="1"><span class="kw">sp_print_df</span>(customer_open_amts_dplyr)</a></code></pre></div>
<div id="htmlwidget-20ef643ff2d76ae434f3" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-20ef643ff2d76ae434f3">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10"],[293,307,316,299,274,75,155,267,60,163],["Mae Fletcher","Joseph Joy","Steven Curley","James Gannon","Naomi Jennings","Tammy Sanders","Gail Knight","Margie Wade","Mildred Bailey","Cathy Spencer"],["No","No","No","No","No","Yes","Yes","Yes","Yes","Yes"],[35.9,31.9,31.9,30.91,29.92,5.98,4.99,4.99,4.99,4.99],[0,0,0,0,0,0,0,0,0,0],[35.9,31.9,31.9,30.91,29.92,5.98,4.99,4.99,4.99,4.99],[10,10,10,9,8,2,1,1,1,1],[1,2,3,4,5,1,2,3,4,5]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>customer_id<\/th>\n      <th>customer<\/th>\n      <th>pay_record<\/th>\n      <th>rental_amt<\/th>\n      <th>paid_amt<\/th>\n      <th>due_amt<\/th>\n      <th>cnt<\/th>\n      <th>id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,4,5,6,7,8]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="what-is-the-business-cash-flow-1" class="section level3">
<h3><span class="header-section-number">25.1.30</span> 31. What is the business cash flow?</h3>
<p>In the previous exercise we saw that about 50% of the rentals collected the correct amount and 40% of the rentals over collected. The last 10% were never collected.</p>
<p>Calculate the number of days it took before the payment was collected and the amount collected?</p>
<p>To answer this question we look at the <code>rental</code>, <code>customer</code>, <code>payment</code>, <code>inventory</code>, <code>payment</code> and <code>film</code> tables to answer this question.</p>
<div class="sourceCode" id="cb589"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb589-1" data-line-number="1">cash_flow_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb589-2" data-line-number="2"><span class="st">&quot;SELECT payment_date - exp_rtn_dt payment_days</span></a>
<a class="sourceLine" id="cb589-3" data-line-number="3"><span class="st">    ,sum(coalesce(amount, charges)) paid_or_due</span></a>
<a class="sourceLine" id="cb589-4" data-line-number="4"><span class="st">    ,count(*) late_returns</span></a>
<a class="sourceLine" id="cb589-5" data-line-number="5"><span class="st">FROM (</span></a>
<a class="sourceLine" id="cb589-6" data-line-number="6"><span class="st">    SELECT payment_date::DATE </span></a>
<a class="sourceLine" id="cb589-7" data-line-number="7"><span class="st">        ,(r.rental_date + INTERVAL &#39;1 day&#39; * f.rental_duration)::DATE exp_rtn_dt</span></a>
<a class="sourceLine" id="cb589-8" data-line-number="8"><span class="st">        ,p.amount </span></a>
<a class="sourceLine" id="cb589-9" data-line-number="9"><span class="st">        ,f.rental_rate charges</span></a>
<a class="sourceLine" id="cb589-10" data-line-number="10"><span class="st">        ,r.rental_date</span></a>
<a class="sourceLine" id="cb589-11" data-line-number="11"><span class="st">        ,r.return_date</span></a>
<a class="sourceLine" id="cb589-12" data-line-number="12"><span class="st">    FROM rental r</span></a>
<a class="sourceLine" id="cb589-13" data-line-number="13"><span class="st">         LEFT JOIN customer c ON c.customer_id = r.customer_id</span></a>
<a class="sourceLine" id="cb589-14" data-line-number="14"><span class="st">         LEFT JOIN address a  ON c.address_id = a.address_id</span></a>
<a class="sourceLine" id="cb589-15" data-line-number="15"><span class="st">         LEFT JOIN city       ON city.city_id = a.city_id</span></a>
<a class="sourceLine" id="cb589-16" data-line-number="16"><span class="st">         LEFT JOIN country ctry ON ctry.country_id = city.country_id</span></a>
<a class="sourceLine" id="cb589-17" data-line-number="17"><span class="st">         LEFT JOIN inventory i  ON r.inventory_id = i.inventory_id</span></a>
<a class="sourceLine" id="cb589-18" data-line-number="18"><span class="st">         LEFT JOIN payment p    ON c.customer_id = p.customer_id </span></a>
<a class="sourceLine" id="cb589-19" data-line-number="19"><span class="st">                               AND p.rental_id = r.rental_id</span></a>
<a class="sourceLine" id="cb589-20" data-line-number="20"><span class="st">         LEFT JOIN film f       ON i.film_id = f.film_id</span></a>
<a class="sourceLine" id="cb589-21" data-line-number="21"><span class="st">    WHERE return_date &gt; (r.rental_date + INTERVAL &#39;1 day&#39; * f.rental_duration)::DATE </span></a>
<a class="sourceLine" id="cb589-22" data-line-number="22"><span class="st">    ) AS src</span></a>
<a class="sourceLine" id="cb589-23" data-line-number="23"><span class="st">GROUP BY payment_date - exp_rtn_dt</span></a>
<a class="sourceLine" id="cb589-24" data-line-number="24"><span class="st">ORDER BY payment_date - exp_rtn_dt DESC&quot;</span>)</a>
<a class="sourceLine" id="cb589-25" data-line-number="25"></a>
<a class="sourceLine" id="cb589-26" data-line-number="26"><span class="kw">sp_print_df</span>(cash_flow_sql)</a></code></pre></div>
<div id="htmlwidget-7a1ca14bd453df078a7a" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-7a1ca14bd453df078a7a">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20"],[null,636,635,634,633,632,631,630,607,606,605,604,603,602,574,573,572,571,570,569],[2211.23,5599.24,5070.94,4173.02,2993.4,1692.83,316.27,1.98,1660.1,1458.22,1162.77,898.99,578.58,33.93,5234.98,4279.18,3311.73,2485.4,1438.39,51.85],[777,976,906,798,660,417,73,2,290,278,223,201,142,7,902,782,627,560,361,15]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>payment_days<\/th>\n      <th>paid_or_due<\/th>\n      <th>late_returns<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><font color='blue'>Wow those are really generous terms. Customers are paying 1.2 to 1.7 years after they returned the DVD. This business is in serious financial trouble!
</font></p>
<div id="replicate-the-output-above-using-dplyr-syntax.-60" class="section level4">
<h4><span class="header-section-number">25.1.30.1</span> Replicate the output above using dplyr syntax.</h4>
<table>
<colgroup>
<col width="12%" />
<col width="24%" />
<col width="63%" />
</colgroup>
<thead>
<tr class="header">
<th>column</th>
<th>definition</th>
<th>mapping</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>paid_or_due</td>
<td>paid amt associated with rental or the rental_rate</td>
<td>ifelse(is.na(amount),rental_rate,amount)</td>
</tr>
<tr class="even">
<td>payment_days</td>
<td>days til payment</td>
<td>payment_date - rental_date</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb590"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb590-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb590-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb590-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb590-4" data-line-number="4"></a>
<a class="sourceLine" id="cb590-5" data-line-number="5">cash_flow_dplyr &lt;-<span class="st"> </span>rental_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb590-6" data-line-number="6"><span class="st">    </span><span class="kw">left_join</span>(payment_table, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;rental_id&#39;</span>=<span class="st">&#39;rental_id&#39;</span>,<span class="st">&#39;customer_id&#39;</span>=<span class="st">&#39;customer_id&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb590-7" data-line-number="7"><span class="st">    </span><span class="kw">left_join</span>(inventory_table, <span class="dt">by=</span>(<span class="st">&#39;inventory_id&#39;</span>=<span class="st">&#39;inventory_id&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb590-8" data-line-number="8"><span class="st">    </span><span class="kw">left_join</span>(film_table, <span class="dt">by=</span>(<span class="st">&#39;film_id&#39;</span>=<span class="st">&#39;film_id&#39;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb590-9" data-line-number="9"><span class="st">  </span><span class="kw">collect</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb590-10" data-line-number="10"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">pay_dt =</span> lubridate<span class="op">::</span><span class="kw">date</span>(payment_date)</a>
<a class="sourceLine" id="cb590-11" data-line-number="11">          ,<span class="dt">exp_rtn_dt =</span> lubridate<span class="op">::</span><span class="kw">date</span>(rental_date) <span class="op">+</span><span class="st"> </span>rental_duration</a>
<a class="sourceLine" id="cb590-12" data-line-number="12">          ,<span class="dt">rdate=</span>lubridate<span class="op">::</span><span class="kw">date</span>(rental_date)</a>
<a class="sourceLine" id="cb590-13" data-line-number="13">          ,<span class="dt">payment_days =</span> lubridate<span class="op">::</span><span class="kw">date</span>(payment_date) <span class="op">-</span><span class="st"> </span>(lubridate<span class="op">::</span><span class="kw">date</span>(rental_date) <span class="op">+</span><span class="st"> </span>rental_duration)</a>
<a class="sourceLine" id="cb590-14" data-line-number="14">          ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb590-15" data-line-number="15"><span class="st">    </span><span class="kw">filter</span>(return_date <span class="op">&gt;</span><span class="st"> </span>exp_rtn_dt) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb590-16" data-line-number="16"><span class="st">    </span><span class="kw">group_by</span>(payment_days) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb590-17" data-line-number="17"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">paid_or_due=</span><span class="kw">sum</span>(<span class="kw">ifelse</span>(<span class="kw">is.na</span>(amount),rental_rate,amount))</a>
<a class="sourceLine" id="cb590-18" data-line-number="18">             ,<span class="dt">late_returns=</span><span class="kw">n</span>()</a>
<a class="sourceLine" id="cb590-19" data-line-number="19">             ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb590-20" data-line-number="20"><span class="st">    </span><span class="kw">arrange</span>(<span class="kw">desc</span>(payment_days)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb590-21" data-line-number="21"><span class="st">    </span><span class="kw">select</span>(payment_days,paid_or_due,late_returns) </a>
<a class="sourceLine" id="cb590-22" data-line-number="22"></a>
<a class="sourceLine" id="cb590-23" data-line-number="23"><span class="kw">sp_print_df</span>(cash_flow_dplyr)</a></code></pre></div>
<div id="htmlwidget-e07c38820216518b4dbd" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-e07c38820216518b4dbd">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20"],[636,635,634,633,632,631,630,607,606,605,604,603,602,574,573,572,571,570,569,null],[5599.24,5070.94,4173.02,2993.4,1692.83,316.27,1.98,1660.1,1458.22,1162.77,898.99,578.58,33.93,5234.98,4279.18,3311.73,2485.4,1438.39,51.85,2211.23],[976,906,798,660,417,73,2,290,278,223,201,142,7,902,782,627,560,361,15,777]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>payment_days<\/th>\n      <th>paid_or_due<\/th>\n      <th>late_returns<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="customer-information-1" class="section level3">
<h3><span class="header-section-number">25.1.31</span> 32. Customer information</h3>
<p>Create a function that takes a customer id and returns</p>
<ul>
<li>customer address information</li>
<li>films rented and returned information</li>
<li>customer payment information</li>
</ul>
<p>The hidden code block implements such a function in SQL.</p>
<p>To answer this question we look at the <code>rental</code>, <code>customer</code>, <code>address</code>, <code>city,</code>country<code>,</code>inventory<code>,</code>payment<code>and</code>film` tables to answer this question.</p>
<div class="sourceCode" id="cb591"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb591-1" data-line-number="1">customer_details_fn_sql &lt;-<span class="st"> </span><span class="cf">function</span>(cust_id) {</a>
<a class="sourceLine" id="cb591-2" data-line-number="2">    customer_details_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb591-3" data-line-number="3">    <span class="st">&quot;select c.customer_id id,concat(first_name,&#39; &#39;,c.last_name) customer</span></a>
<a class="sourceLine" id="cb591-4" data-line-number="4"><span class="st">          ,c.email,a.phone,a.address,address2,city.city,a.postal_code,ctry.country</span></a>
<a class="sourceLine" id="cb591-5" data-line-number="5"><span class="st">          ,c.store_id cust_store_id</span></a>
<a class="sourceLine" id="cb591-6" data-line-number="6"><span class="st">          ,i.store_id inv_store_id</span></a>
<a class="sourceLine" id="cb591-7" data-line-number="7"><span class="st">          ,f.film_id</span></a>
<a class="sourceLine" id="cb591-8" data-line-number="8"><span class="st">          ,f.title</span></a>
<a class="sourceLine" id="cb591-9" data-line-number="9"><span class="st">          ,r.rental_date::date rented</span></a>
<a class="sourceLine" id="cb591-10" data-line-number="10"><span class="st">          ,r.return_date::date returned</span></a>
<a class="sourceLine" id="cb591-11" data-line-number="11"><span class="st">          ,(r.rental_date + INTERVAL &#39;1 day&#39;  * f.rental_duration)::date exp_rtn_dt</span></a>
<a class="sourceLine" id="cb591-12" data-line-number="12"><span class="st">          ,case when r.return_date is null</span></a>
<a class="sourceLine" id="cb591-13" data-line-number="13"><span class="st">                then null</span></a>
<a class="sourceLine" id="cb591-14" data-line-number="14"><span class="st">                else r.return_date::date  - (r.rental_date + INTERVAL &#39;1 day&#39;  * f.rental_duration)::date</span></a>
<a class="sourceLine" id="cb591-15" data-line-number="15"><span class="st">           end rtn_stat</span></a>
<a class="sourceLine" id="cb591-16" data-line-number="16"><span class="st">          ,case when r.rental_id is null</span></a>
<a class="sourceLine" id="cb591-17" data-line-number="17"><span class="st">                then null</span></a>
<a class="sourceLine" id="cb591-18" data-line-number="18"><span class="st">                      -- dvd returned             </span></a>
<a class="sourceLine" id="cb591-19" data-line-number="19"><span class="st">                when r.return_date is null</span></a>
<a class="sourceLine" id="cb591-20" data-line-number="20"><span class="st">                then 1</span></a>
<a class="sourceLine" id="cb591-21" data-line-number="21"><span class="st">                else 0</span></a>
<a class="sourceLine" id="cb591-22" data-line-number="22"><span class="st">           end not_rtn</span></a>
<a class="sourceLine" id="cb591-23" data-line-number="23"><span class="st">          ,payment_date::date pay_dt</span></a>
<a class="sourceLine" id="cb591-24" data-line-number="24"><span class="st">          ,f.rental_rate charges</span></a>
<a class="sourceLine" id="cb591-25" data-line-number="25"><span class="st">          ,p.amount paid</span></a>
<a class="sourceLine" id="cb591-26" data-line-number="26"><span class="st">          ,p.amount-f.rental_rate delta</span></a>
<a class="sourceLine" id="cb591-27" data-line-number="27"><span class="st">          ,p.staff_id pay_staff_id</span></a>
<a class="sourceLine" id="cb591-28" data-line-number="28"><span class="st">          ,payment_date::date - rental_date::date pay_days</span></a>
<a class="sourceLine" id="cb591-29" data-line-number="29"><span class="st">          ,r.rental_id,i.inventory_id,payment_id</span></a>
<a class="sourceLine" id="cb591-30" data-line-number="30"><span class="st">      from customer c left join rental r on c.customer_id = r.customer_id</span></a>
<a class="sourceLine" id="cb591-31" data-line-number="31"><span class="st">                      left join address a on c.address_id = a.address_id</span></a>
<a class="sourceLine" id="cb591-32" data-line-number="32"><span class="st">                      left join city on city.city_id = a.city_id</span></a>
<a class="sourceLine" id="cb591-33" data-line-number="33"><span class="st">                      left join country ctry on ctry.country_id = city.country_id</span></a>
<a class="sourceLine" id="cb591-34" data-line-number="34"><span class="st">                      left join inventory i on r.inventory_id = i.inventory_id</span></a>
<a class="sourceLine" id="cb591-35" data-line-number="35"><span class="st">                      left join payment p on c.customer_id = p.customer_id and p.rental_id = r.rental_id</span></a>
<a class="sourceLine" id="cb591-36" data-line-number="36"><span class="st">                      left join film f on i.film_id = f.film_id</span></a>
<a class="sourceLine" id="cb591-37" data-line-number="37"><span class="st">     where c.customer_id = $1</span></a>
<a class="sourceLine" id="cb591-38" data-line-number="38"><span class="st">    order by id,rented desc</span></a>
<a class="sourceLine" id="cb591-39" data-line-number="39"><span class="st">    &quot;</span></a>
<a class="sourceLine" id="cb591-40" data-line-number="40">    ,cust_id</a>
<a class="sourceLine" id="cb591-41" data-line-number="41">    )</a>
<a class="sourceLine" id="cb591-42" data-line-number="42">    <span class="kw">return</span>(customer_details_sql)</a>
<a class="sourceLine" id="cb591-43" data-line-number="43">}</a></code></pre></div>
<p>The following code block executes the customer function. Change the <code>cust_id</code> value to see differnt customers.</p>
<div class="sourceCode" id="cb592"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb592-1" data-line-number="1"><span class="co"># cust_id &lt;- 600</span></a>
<a class="sourceLine" id="cb592-2" data-line-number="2"><span class="co"># sp_print_df( customer_details_fn_sql(cust_id))</span></a></code></pre></div>
<div id="replicate-the-output-above-using-dplyr-syntax.-61" class="section level4">
<h4><span class="header-section-number">25.1.31.1</span> Replicate the output above using dplyr syntax.</h4>
<table>
<colgroup>
<col width="12%" />
<col width="24%" />
<col width="63%" />
</colgroup>
<thead>
<tr class="header">
<th>column</th>
<th>definition</th>
<th>mapping</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>id</td>
<td>customer_id</td>
<td></td>
</tr>
<tr class="even">
<td>customer</td>
<td>first_name + last_name</td>
<td></td>
</tr>
<tr class="odd">
<td>exp_rtn_dt</td>
<td>expected return date</td>
<td>rental.rental_date + film.rental_duration</td>
</tr>
<tr class="even">
<td>rtn_stat</td>
<td>return status</td>
<td>rental.return_date - (rental.rental_date + film duration)</td>
</tr>
<tr class="odd">
<td>not_rtn</td>
<td>dvd not returned</td>
<td>null if rental_id is null;not rented; 1 return_date null else 0</td>
</tr>
<tr class="even">
<td>pay_dt</td>
<td>payment_date</td>
<td></td>
</tr>
<tr class="odd">
<td>delta</td>
<td></td>
<td>payment.amount-film.rental_rate</td>
</tr>
<tr class="even">
<td>pay_staff_id</td>
<td>payment.staff_id</td>
<td>payment.staff_id</td>
</tr>
<tr class="odd">
<td>pay_days</td>
<td>days til payment</td>
<td>payment_date - rental_date</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb593"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb593-1" data-line-number="1"><span class="co"># sp_tbl_descr(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb593-2" data-line-number="2"><span class="co"># sp_tbl_pk_fk(&#39;table_name&#39;)</span></a>
<a class="sourceLine" id="cb593-3" data-line-number="3"><span class="co"># sp_print_df(table_rows_sql)</span></a>
<a class="sourceLine" id="cb593-4" data-line-number="4"></a>
<a class="sourceLine" id="cb593-5" data-line-number="5">customer_details_fn_dplyr &lt;-<span class="st"> </span><span class="cf">function</span>(cust_id) {</a>
<a class="sourceLine" id="cb593-6" data-line-number="6"></a>
<a class="sourceLine" id="cb593-7" data-line-number="7">customer_details_dplyr &lt;-<span class="st"> </span>customer_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb593-8" data-line-number="8"><span class="st">    </span><span class="kw">left_join</span>(rental_table, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;customer_id&#39;</span>=<span class="st">&#39;customer_id&#39;</span>)) <span class="op">%&gt;%</span><span class="st">    </span></a>
<a class="sourceLine" id="cb593-9" data-line-number="9"><span class="st">    </span><span class="kw">left_join</span>(address_table, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;address_id&#39;</span>=<span class="st">&#39;address_id&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb593-10" data-line-number="10"><span class="st">    </span><span class="kw">left_join</span>(city_table,<span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;city_id&#39;</span>=<span class="st">&#39;city_id&#39;</span>))  <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb593-11" data-line-number="11"><span class="st">    </span><span class="kw">left_join</span>(country_table,<span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;country_id&#39;</span>=<span class="st">&#39;country_id&#39;</span>))  <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb593-12" data-line-number="12"><span class="st">    </span><span class="kw">left_join</span>(inventory_table,<span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;inventory_id&#39;</span>=<span class="st">&#39;inventory_id&#39;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb593-13" data-line-number="13"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">inv_store_id =</span> store_id.y) <span class="op">%&gt;%</span><span class="st">    </span></a>
<a class="sourceLine" id="cb593-14" data-line-number="14"><span class="st">    </span><span class="kw">left_join</span>(payment_table,<span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;customer_id&#39;</span>=<span class="st">&#39;customer_id&#39;</span>,<span class="st">&#39;rental_id&#39;</span>=<span class="st">&#39;rental_id&#39;</span>))  <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb593-15" data-line-number="15"><span class="st">    </span><span class="kw">left_join</span>(film_table,<span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;film_id&#39;</span>=<span class="st">&#39;film_id&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb593-16" data-line-number="16"><span class="st">    </span><span class="kw">filter</span>(customer_id <span class="op">==</span><span class="st"> </span>cust_id ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb593-17" data-line-number="17"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">customer=</span><span class="kw">paste0</span>(first_name,<span class="st">&#39; &#39;</span>,last_name)</a>
<a class="sourceLine" id="cb593-18" data-line-number="18">          ,<span class="dt">exp_rtn_dt =</span> lubridate<span class="op">::</span><span class="kw">date</span>(rental_date) <span class="op">+</span><span class="st"> </span>rental_duration</a>
<a class="sourceLine" id="cb593-19" data-line-number="19">          ,<span class="dt">rtn_days=</span> lubridate<span class="op">::</span><span class="kw">date</span>(return_date) <span class="op">-</span><span class="st"> </span>(lubridate<span class="op">::</span><span class="kw">date</span>(rental_date) <span class="op">+</span><span class="st"> </span>rental_duration)</a>
<a class="sourceLine" id="cb593-20" data-line-number="20">          ,<span class="dt">rented =</span> <span class="kw">as.Date</span>(rental_date)</a>
<a class="sourceLine" id="cb593-21" data-line-number="21">          ,<span class="dt">returned =</span> <span class="kw">as.Date</span>(return_date)</a>
<a class="sourceLine" id="cb593-22" data-line-number="22">          ,<span class="dt">not_rtn=</span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(rental_id),rental_id,<span class="kw">ifelse</span>(<span class="kw">is.na</span>(return_date),<span class="dv">1</span>,<span class="dv">0</span>))</a>
<a class="sourceLine" id="cb593-23" data-line-number="23">          ,<span class="dt">delta =</span> amount<span class="op">-</span>rental_rate</a>
<a class="sourceLine" id="cb593-24" data-line-number="24">          ,<span class="dt">pay_days =</span> lubridate<span class="op">::</span><span class="kw">date</span>(payment_date) <span class="op">-</span><span class="st"> </span>(lubridate<span class="op">::</span><span class="kw">date</span>(rental_date) <span class="op">+</span><span class="st"> </span>rental_duration)</a>
<a class="sourceLine" id="cb593-25" data-line-number="25">          ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb593-26" data-line-number="26"><span class="st">    </span><span class="kw">rename</span>(<span class="dt">id =</span> customer_id</a>
<a class="sourceLine" id="cb593-27" data-line-number="27">          ,<span class="dt">cust_store_id =</span> store_id.x</a>
<a class="sourceLine" id="cb593-28" data-line-number="28">          ,<span class="dt">charges =</span> rental_rate</a>
<a class="sourceLine" id="cb593-29" data-line-number="29">          ,<span class="dt">paid =</span> amount</a>
<a class="sourceLine" id="cb593-30" data-line-number="30">          ,<span class="dt">pay_dt =</span> payment_date</a>
<a class="sourceLine" id="cb593-31" data-line-number="31">          ,<span class="dt">pay_staff_id =</span> staff_id.y</a>
<a class="sourceLine" id="cb593-32" data-line-number="32">          ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb593-33" data-line-number="33"><span class="st">    </span><span class="kw">select</span>(id,customer,email,phone,address,address2,city,postal_code,country</a>
<a class="sourceLine" id="cb593-34" data-line-number="34">          ,cust_store_id</a>
<a class="sourceLine" id="cb593-35" data-line-number="35">          ,inv_store_id</a>
<a class="sourceLine" id="cb593-36" data-line-number="36">          ,film_id,title,rented,returned</a>
<a class="sourceLine" id="cb593-37" data-line-number="37">          ,exp_rtn_dt,rtn_days,not_rtn</a>
<a class="sourceLine" id="cb593-38" data-line-number="38">          ,pay_dt</a>
<a class="sourceLine" id="cb593-39" data-line-number="39">          ,charges,paid,delta,pay_staff_id</a>
<a class="sourceLine" id="cb593-40" data-line-number="40">          ,pay_days,film_id,rental_id,inventory_id,payment_id</a>
<a class="sourceLine" id="cb593-41" data-line-number="41">          ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb593-42" data-line-number="42"><span class="st">  </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb593-43" data-line-number="43"></a>
<a class="sourceLine" id="cb593-44" data-line-number="44"><span class="kw">return</span>(customer_details_dplyr)</a>
<a class="sourceLine" id="cb593-45" data-line-number="45">}</a></code></pre></div>
<p>Use the following code block to test the dplyr function.</p>
<div class="sourceCode" id="cb594"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb594-1" data-line-number="1"><span class="co"># cust_id &lt;- 601</span></a>
<a class="sourceLine" id="cb594-2" data-line-number="2"><span class="co"># sp_print_df(customer_details_fn_dplyr(cust_id))</span></a></code></pre></div>
</div>
</div>
</div>
<div id="different-strategies-for-interacting-with-the-database" class="section level2">
<h2><span class="header-section-number">25.2</span> Different strategies for interacting with the database</h2>
<p>select examples</p>
<pre><code>dbGetQuery returns the entire result set as a data frame.  For large returned datasets, complex or inefficient SQL statements, this may take a long time.

  dbSendQuery: parses, compiles, creates the optimized execution plan.  
      dbFetch: Execute optimzed execution plan and return the dataset.
dbClearResult: remove pending query results from the database to your R environment</code></pre>
<div id="dbgetquery-versus-dbsendquerydbfetchdbclearresult" class="section level3">
<h3><span class="header-section-number">25.2.1</span> dbGetQuery Versus dbSendQuery+dbFetch+dbClearResult</h3>
<p>How many customers are there in the DVD Rental System?</p>
<div class="sourceCode" id="cb596"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb596-1" data-line-number="1">rs1 &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con, <span class="st">&quot;select * from customer;&quot;</span>)</a>
<a class="sourceLine" id="cb596-2" data-line-number="2"><span class="kw">sp_print_df</span>(<span class="kw">head</span>(rs1))</a></code></pre></div>
<div id="htmlwidget-0299b677371d69a30e91" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-0299b677371d69a30e91">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],[524,1,2,3,4,5],[1,1,1,1,2,1],["Jared","Mary","Patricia","Linda","Barbara","Elizabeth"],["Ely","Smith","Johnson","Williams","Jones","Brown"],["jared.ely@sakilacustomer.org","mary.smith@sakilacustomer.org","patricia.johnson@sakilacustomer.org","linda.williams@sakilacustomer.org","barbara.jones@sakilacustomer.org","elizabeth.brown@sakilacustomer.org"],[530,5,6,7,8,9],[true,true,true,true,true,true],["2006-02-14","2006-02-14","2006-02-14","2006-02-14","2006-02-14","2006-02-14"],["2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z"],[1,1,1,1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>customer_id<\/th>\n      <th>store_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>email<\/th>\n      <th>address_id<\/th>\n      <th>activebool<\/th>\n      <th>create_date<\/th>\n      <th>last_update<\/th>\n      <th>active<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,6,10]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb597"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb597-1" data-line-number="1">fetch &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb597-2" data-line-number="2">rows &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb597-3" data-line-number="3">pco &lt;-<span class="st"> </span><span class="kw">dbSendQuery</span>(con, <span class="st">&quot;select * from customer;&quot;</span>)</a>
<a class="sourceLine" id="cb597-4" data-line-number="4"><span class="cf">while</span>(<span class="op">!</span><span class="kw">dbHasCompleted</span>(pco)) {</a>
<a class="sourceLine" id="cb597-5" data-line-number="5">    rs2 &lt;-<span class="st"> </span><span class="kw">dbFetch</span>(pco,<span class="dt">n=</span><span class="dv">100</span>)</a>
<a class="sourceLine" id="cb597-6" data-line-number="6">    fetch &lt;-<span class="st"> </span>fetch <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb597-7" data-line-number="7">    rows &lt;-<span class="st"> </span>rows <span class="op">+</span><span class="st"> </span><span class="kw">nrow</span>(rs2)</a>
<a class="sourceLine" id="cb597-8" data-line-number="8">    <span class="kw">print</span>(<span class="kw">paste0</span>(<span class="st">&quot;fetch=&quot;</span>,fetch,<span class="st">&quot; fetched rows=&quot;</span>,<span class="kw">nrow</span>(rs2),<span class="st">&quot; running rows fetched=&quot;</span>,rows))</a>
<a class="sourceLine" id="cb597-9" data-line-number="9">    <span class="co"># add additional code to process fetched records</span></a>
<a class="sourceLine" id="cb597-10" data-line-number="10">}    </a></code></pre></div>
<pre><code>## [1] &quot;fetch=1 fetched rows=100 running rows fetched=100&quot;
## [1] &quot;fetch=2 fetched rows=100 running rows fetched=200&quot;
## [1] &quot;fetch=3 fetched rows=100 running rows fetched=300&quot;
## [1] &quot;fetch=4 fetched rows=100 running rows fetched=400&quot;
## [1] &quot;fetch=5 fetched rows=100 running rows fetched=500&quot;
## [1] &quot;fetch=6 fetched rows=100 running rows fetched=600&quot;
## [1] &quot;fetch=7 fetched rows=4 running rows fetched=604&quot;</code></pre>
<div class="sourceCode" id="cb599"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb599-1" data-line-number="1"><span class="kw">dbClearResult</span>(pco)</a>
<a class="sourceLine" id="cb599-2" data-line-number="2"><span class="kw">sp_print_df</span>(<span class="kw">head</span>(rs2))</a></code></pre></div>
<div id="htmlwidget-b5f9f81d302f7434f919" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-b5f9f81d302f7434f919">{"x":{"filter":"none","data":[["1","2","3","4"],[601,602,603,604],[2,4,5,6],["Sophie","John","Ian","Ed"],["Yang","Smith","Frantz","Borasky"],["sophie.yang@sakilacustomer.org","john.smith@sakilacustomer.org","ian.frantz@sakilacustomer.org","ed.borasky@sakilacustomer.org"],[1,2,3,4],[true,true,true,true],["2019-03-04","2019-03-04","2019-03-04","2019-03-04"],["2019-03-04T08:00:00Z","2019-03-04T08:00:00Z","2019-03-04T08:00:00Z","2019-03-04T08:00:00Z"],[1,1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>customer_id<\/th>\n      <th>store_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>email<\/th>\n      <th>address_id<\/th>\n      <th>activebool<\/th>\n      <th>create_date<\/th>\n      <th>last_update<\/th>\n      <th>active<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,6,10]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb600"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb600-1" data-line-number="1"><span class="co"># diconnect from the db</span></a>
<a class="sourceLine" id="cb600-2" data-line-number="2"><span class="kw">dbDisconnect</span>(con)</a>
<a class="sourceLine" id="cb600-3" data-line-number="3"></a>
<a class="sourceLine" id="cb600-4" data-line-number="4"><span class="kw">sp_docker_stop</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="cb601"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb601-1" data-line-number="1"><span class="co"># knitr::knit_exit()</span></a></code></pre></div>
<!--chapter:end:155-sql-joins-exercises-with-answers.Rmd-->
</div>
</div>
</div>
<div id="chapter_anti-join-cost-comparisons" class="section level1">
<h1><span class="header-section-number">26</span> Anti-join cost comparisons</h1>
<p>Verify Docker is up and running:</p>
<div class="sourceCode" id="cb602"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb602-1" data-line-number="1"><span class="kw">sp_check_that_docker_is_up</span>()</a></code></pre></div>
<pre><code>## [1] &quot;Docker is up but running no containers&quot;</code></pre>
<p>Verify pet DB is available, it may be stopped.</p>
<div class="sourceCode" id="cb604"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb604-1" data-line-number="1"><span class="kw">sp_show_all_docker_containers</span>()</a></code></pre></div>
<pre><code>## CONTAINER ID        IMAGE                COMMAND                  CREATED              STATUS                     PORTS               NAMES
## ce3accea3583        postgres-dvdrental   &quot;docker-entrypoint.s…&quot;   About a minute ago   Exited (0) 2 seconds ago                       sql-pet</code></pre>
<p>Start up the <code>docker-pet</code> container</p>
<div class="sourceCode" id="cb606"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb606-1" data-line-number="1"><span class="kw">sp_docker_start</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<p>Now connect to the database with R</p>
<div class="sourceCode" id="cb607"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb607-1" data-line-number="1"><span class="co"># need to wait for Docker &amp; Postgres to come up before connecting.</span></a>
<a class="sourceLine" id="cb607-2" data-line-number="2"></a>
<a class="sourceLine" id="cb607-3" data-line-number="3">con &lt;-<span class="st"> </span><span class="kw">sp_get_postgres_connection</span>(</a>
<a class="sourceLine" id="cb607-4" data-line-number="4">  <span class="dt">user =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_USER_NAME&quot;</span>),</a>
<a class="sourceLine" id="cb607-5" data-line-number="5">  <span class="dt">password =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_PASSWORD&quot;</span>),</a>
<a class="sourceLine" id="cb607-6" data-line-number="6">  <span class="dt">dbname =</span> <span class="st">&quot;dvdrental&quot;</span>,</a>
<a class="sourceLine" id="cb607-7" data-line-number="7">  <span class="dt">seconds_to_test =</span> <span class="dv">30</span></a>
<a class="sourceLine" id="cb607-8" data-line-number="8">)</a></code></pre></div>
<div class="sourceCode" id="cb608"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb608-1" data-line-number="1"><span class="kw">source</span>(<span class="dt">file=</span><span class="kw">here</span>(<span class="st">&#39;book-src/sql_pet_data.R&#39;</span>),<span class="dt">echo=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb608-2" data-line-number="2"><span class="co">## </span></a>
<a class="sourceLine" id="cb608-3" data-line-number="3"><span class="co">## &gt; dbExecute(con, &quot;delete from film_category where film_id &gt;= 1001;&quot;)</span></a>
<a class="sourceLine" id="cb608-4" data-line-number="4"><span class="co">## [1] 2</span></a>
<a class="sourceLine" id="cb608-5" data-line-number="5"><span class="co">## </span></a>
<a class="sourceLine" id="cb608-6" data-line-number="6"><span class="co">## &gt; dbExecute(con, &quot;delete from rental where rental_id &gt;= 16050;&quot;)</span></a>
<a class="sourceLine" id="cb608-7" data-line-number="7"><span class="co">## [1] 1</span></a>
<a class="sourceLine" id="cb608-8" data-line-number="8"><span class="co">## </span></a>
<a class="sourceLine" id="cb608-9" data-line-number="9"><span class="co">## &gt; dbExecute(con, &quot;delete from inventory where film_id &gt;= 1001;&quot;)</span></a>
<a class="sourceLine" id="cb608-10" data-line-number="10"><span class="co">## [1] 2</span></a>
<a class="sourceLine" id="cb608-11" data-line-number="11"><span class="co">## </span></a>
<a class="sourceLine" id="cb608-12" data-line-number="12"><span class="co">## &gt; dbExecute(con, &quot;delete from film where film_id &gt;= 1001;&quot;)</span></a>
<a class="sourceLine" id="cb608-13" data-line-number="13"><span class="co">## [1] 1</span></a>
<a class="sourceLine" id="cb608-14" data-line-number="14"><span class="co">## </span></a>
<a class="sourceLine" id="cb608-15" data-line-number="15"><span class="co">## &gt; dbExecute(con, &quot;delete from customer where customer_id &gt;= 600;&quot;)</span></a>
<a class="sourceLine" id="cb608-16" data-line-number="16"><span class="co">## [1] 5</span></a>
<a class="sourceLine" id="cb608-17" data-line-number="17"><span class="co">## </span></a>
<a class="sourceLine" id="cb608-18" data-line-number="18"><span class="co">## &gt; dbExecute(con, &quot;delete from store where store_id &gt; 2;&quot;)</span></a>
<a class="sourceLine" id="cb608-19" data-line-number="19"><span class="co">## [1] 1</span></a>
<a class="sourceLine" id="cb608-20" data-line-number="20"><span class="co">## </span></a>
<a class="sourceLine" id="cb608-21" data-line-number="21"><span class="co">## &gt; dbExecute(con, &quot;insert into customer\n  (customer_id,store_id,first_name,last_name,email,address_id,activebool\n  ,create_date,last_update,active)\n ...&quot; ... [TRUNCATED] </span></a>
<a class="sourceLine" id="cb608-22" data-line-number="22"><span class="co">## [1] 5</span></a>
<a class="sourceLine" id="cb608-23" data-line-number="23"><span class="co">## </span></a>
<a class="sourceLine" id="cb608-24" data-line-number="24"><span class="co">## &gt; dbExecute(con, &quot;ALTER TABLE store DISABLE TRIGGER ALL;&quot;)</span></a>
<a class="sourceLine" id="cb608-25" data-line-number="25"><span class="co">## [1] 0</span></a>
<a class="sourceLine" id="cb608-26" data-line-number="26"><span class="co">## </span></a>
<a class="sourceLine" id="cb608-27" data-line-number="27"><span class="co">## &gt; df &lt;- data.frame(store_id = 10, manager_staff_id = 10, </span></a>
<a class="sourceLine" id="cb608-28" data-line-number="28"><span class="co">## +     address_id = 10, last_update = Sys.time())</span></a>
<a class="sourceLine" id="cb608-29" data-line-number="29"><span class="co">## </span></a>
<a class="sourceLine" id="cb608-30" data-line-number="30"><span class="co">## &gt; dbWriteTable(con, &quot;store&quot;, value = df, append = TRUE, </span></a>
<a class="sourceLine" id="cb608-31" data-line-number="31"><span class="co">## +     row.names = FALSE)</span></a>
<a class="sourceLine" id="cb608-32" data-line-number="32"><span class="co">## </span></a>
<a class="sourceLine" id="cb608-33" data-line-number="33"><span class="co">## &gt; dbExecute(con, &quot;ALTER TABLE store ENABLE TRIGGER ALL;&quot;)</span></a>
<a class="sourceLine" id="cb608-34" data-line-number="34"><span class="co">## [1] 0</span></a>
<a class="sourceLine" id="cb608-35" data-line-number="35"><span class="co">## </span></a>
<a class="sourceLine" id="cb608-36" data-line-number="36"><span class="co">## &gt; dbExecute(con, &quot;insert into film\n  (film_id,title,description,release_year,language_id\n  ,rental_duration,rental_rate,length,replacement_cost,rati ...&quot; ... [TRUNCATED] </span></a>
<a class="sourceLine" id="cb608-37" data-line-number="37"><span class="co">## [1] 1</span></a>
<a class="sourceLine" id="cb608-38" data-line-number="38"><span class="co">## </span></a>
<a class="sourceLine" id="cb608-39" data-line-number="39"><span class="co">## &gt; dbExecute(con, &quot;insert into film_category\n  (film_id,category_id,last_update)\n  values(1001,6,now()::date)\n  ,(1001,7,now()::date)\n  ;&quot;)</span></a>
<a class="sourceLine" id="cb608-40" data-line-number="40"><span class="co">## [1] 2</span></a>
<a class="sourceLine" id="cb608-41" data-line-number="41"><span class="co">## </span></a>
<a class="sourceLine" id="cb608-42" data-line-number="42"><span class="co">## &gt; dbExecute(con, &quot;insert into inventory\n  (inventory_id,film_id,store_id,last_update)\n  values(4582,1001,1,now()::date)\n  ,(4583,1001,2,now()::date ...&quot; ... [TRUNCATED] </span></a>
<a class="sourceLine" id="cb608-43" data-line-number="43"><span class="co">## [1] 2</span></a>
<a class="sourceLine" id="cb608-44" data-line-number="44"><span class="co">## </span></a>
<a class="sourceLine" id="cb608-45" data-line-number="45"><span class="co">## &gt; dbExecute(con, &quot;insert into rental\n  (rental_id,rental_date,inventory_id,customer_id,return_date,staff_id,last_update)\n  values(16050,now()::date  ...&quot; ... [TRUNCATED] </span></a>
<a class="sourceLine" id="cb608-46" data-line-number="46"><span class="co">## [1] 1</span></a></code></pre></div>
<p>Explain plans <a href="https://robots.thoughtbot.com/reading-an-explain-analyze-query-plan">here</a></p>
<div id="sql-anti-join-costs" class="section level2">
<h2><span class="header-section-number">26.1</span> SQL anti join Costs</h2>
<div class="sourceCode" id="cb609"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb609-1" data-line-number="1">sql_aj1 &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb609-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb609-3" data-line-number="3">  <span class="st">&quot;explain analyze</span></a>
<a class="sourceLine" id="cb609-4" data-line-number="4"><span class="st">   select &#39;aj&#39; join_type, customer_id, first_name, last_name, c.store_id,count(*) ajs</span></a>
<a class="sourceLine" id="cb609-5" data-line-number="5"><span class="st">   from customer c left outer join store s on c.store_id = s.store_id</span></a>
<a class="sourceLine" id="cb609-6" data-line-number="6"><span class="st">  where s.store_id is null</span></a>
<a class="sourceLine" id="cb609-7" data-line-number="7"><span class="st">  group by customer_id, first_name, last_name, c.store_id</span></a>
<a class="sourceLine" id="cb609-8" data-line-number="8"><span class="st">order by c.customer_id;&quot;</span></a>
<a class="sourceLine" id="cb609-9" data-line-number="9">)</a>
<a class="sourceLine" id="cb609-10" data-line-number="10"></a>
<a class="sourceLine" id="cb609-11" data-line-number="11">sql_aj2 &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb609-12" data-line-number="12">  con,</a>
<a class="sourceLine" id="cb609-13" data-line-number="13">  <span class="st">&quot;explain analyze</span></a>
<a class="sourceLine" id="cb609-14" data-line-number="14"><span class="st">   select &#39;aj&#39; join_type, customer_id, first_name, last_name, c.store_id,count(*) ajs</span></a>
<a class="sourceLine" id="cb609-15" data-line-number="15"><span class="st">   from customer c </span></a>
<a class="sourceLine" id="cb609-16" data-line-number="16"><span class="st">  where c.store_id NOT IN (select store_id from store)</span></a>
<a class="sourceLine" id="cb609-17" data-line-number="17"><span class="st">  group by  customer_id, first_name, last_name, c.store_id</span></a>
<a class="sourceLine" id="cb609-18" data-line-number="18"><span class="st">order by c.customer_id;&quot;</span></a>
<a class="sourceLine" id="cb609-19" data-line-number="19">)</a>
<a class="sourceLine" id="cb609-20" data-line-number="20"></a>
<a class="sourceLine" id="cb609-21" data-line-number="21">sql_aj3 &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb609-22" data-line-number="22">  con,</a>
<a class="sourceLine" id="cb609-23" data-line-number="23">  <span class="st">&quot;explain analyze</span></a>
<a class="sourceLine" id="cb609-24" data-line-number="24"><span class="st">   select &#39;aj&#39; join_type, customer_id, first_name, last_name, c.store_id,count(*) ajs</span></a>
<a class="sourceLine" id="cb609-25" data-line-number="25"><span class="st">   from customer c </span></a>
<a class="sourceLine" id="cb609-26" data-line-number="26"><span class="st">  where not exists (select s.store_id from store s where s.store_id = c.store_id)</span></a>
<a class="sourceLine" id="cb609-27" data-line-number="27"><span class="st"> group by customer_id, first_name, last_name, c.store_id</span></a>
<a class="sourceLine" id="cb609-28" data-line-number="28"><span class="st">order by c.customer_id</span></a>
<a class="sourceLine" id="cb609-29" data-line-number="29"><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb609-30" data-line-number="30">)</a></code></pre></div>
<div id="sql-costs" class="section level5">
<h5><span class="header-section-number">26.1.0.0.1</span> SQL Costs</h5>
<div class="sourceCode" id="cb610"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb610-1" data-line-number="1"><span class="kw">print</span>(<span class="kw">glue</span>(<span class="st">&quot;sql_aj1 loj-null costs=&quot;</span>, sql_aj1[<span class="dv">1</span>, <span class="dv">1</span>]))</a></code></pre></div>
<pre><code>## sql_aj1 loj-null costs=GroupAggregate  (cost=33.28..38.53 rows=300 width=266) (actual time=11.971..12.093 rows=4 loops=1)</code></pre>
<div class="sourceCode" id="cb612"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb612-1" data-line-number="1"><span class="kw">print</span>(<span class="kw">glue</span>(<span class="st">&quot;sql_aj2 not in costs=&quot;</span>, sql_aj2[<span class="dv">1</span>, <span class="dv">1</span>]))</a></code></pre></div>
<pre><code>## sql_aj2 not in costs=GroupAggregate  (cost=29.86..35.11 rows=300 width=262) (actual time=0.367..0.482 rows=4 loops=1)</code></pre>
<div class="sourceCode" id="cb614"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb614-1" data-line-number="1"><span class="kw">print</span>(<span class="kw">glue</span>(<span class="st">&quot;sql_aj3 not exist costs=&quot;</span>, sql_aj3[<span class="dv">1</span>, <span class="dv">1</span>]))</a></code></pre></div>
<pre><code>## sql_aj3 not exist costs=GroupAggregate  (cost=33.28..38.53 rows=300 width=262) (actual time=11.155..11.251 rows=4 loops=1)</code></pre>
</div>
</div>
<div id="dplyr-anti-joins" class="section level2">
<h2><span class="header-section-number">26.2</span> dplyr Anti joins</h2>
<p>In this next section we look at two methods to implemnt an anti join in dplyr.</p>
<div class="sourceCode" id="cb616"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb616-1" data-line-number="1">customer_table &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;customer&quot;</span>) <span class="co"># DBI::dbReadTable(con, &quot;customer&quot;)</span></a>
<a class="sourceLine" id="cb616-2" data-line-number="2">rental_table &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;rental&quot;</span>) <span class="co"># DBI::dbReadTable(con, &quot;rental&quot;)</span></a>
<a class="sourceLine" id="cb616-3" data-line-number="3"></a>
<a class="sourceLine" id="cb616-4" data-line-number="4"><span class="co"># Method 1.  dplyr anti_join</span></a>
<a class="sourceLine" id="cb616-5" data-line-number="5">daj1 &lt;-</a>
<a class="sourceLine" id="cb616-6" data-line-number="6"><span class="st">  </span><span class="kw">anti_join</span>(customer_table, rental_table, <span class="dt">by =</span> <span class="st">&quot;customer_id&quot;</span>, <span class="dt">suffix =</span> <span class="kw">c</span>(<span class="st">&quot;.c&quot;</span>, <span class="st">&quot;.r&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb616-7" data-line-number="7"><span class="st">  </span><span class="kw">select</span>(<span class="kw">c</span>(<span class="st">&quot;first_name&quot;</span>, <span class="st">&quot;last_name&quot;</span>, <span class="st">&quot;email&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb616-8" data-line-number="8"><span class="st">  </span><span class="kw">explain</span>()</a></code></pre></div>
<pre><code>## &lt;SQL&gt;
## SELECT &quot;first_name&quot;, &quot;last_name&quot;, &quot;email&quot;
## FROM (SELECT * FROM &quot;customer&quot; AS &quot;TBL_LEFT&quot;
## 
## WHERE NOT EXISTS (
##   SELECT 1 FROM &quot;rental&quot; AS &quot;TBL_RIGHT&quot;
##   WHERE (&quot;TBL_LEFT&quot;.&quot;customer_id&quot; = &quot;TBL_RIGHT&quot;.&quot;customer_id&quot;)
## )) &quot;cqpqwqagrn&quot;</code></pre>
<pre><code>## </code></pre>
<pre><code>## &lt;PLAN&gt;
## Hash Anti Join  (cost=510.99..552.63 rows=300 width=334)
##   Hash Cond: (&quot;TBL_LEFT&quot;.customer_id = &quot;TBL_RIGHT&quot;.customer_id)
##   -&gt;  Seq Scan on customer &quot;TBL_LEFT&quot;  (cost=0.00..14.99 rows=599 width=338)
##   -&gt;  Hash  (cost=310.44..310.44 rows=16044 width=2)
##         -&gt;  Seq Scan on rental &quot;TBL_RIGHT&quot;  (cost=0.00..310.44 rows=16044 width=2)</code></pre>
<div class="sourceCode" id="cb620"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb620-1" data-line-number="1">customer_table &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;customer&quot;</span>) <span class="co"># DBI::dbReadTable(con, &quot;customer&quot;)</span></a>
<a class="sourceLine" id="cb620-2" data-line-number="2">rental_table &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;rental&quot;</span>) <span class="co"># DBI::dbReadTable(con, &quot;rental&quot;)</span></a>
<a class="sourceLine" id="cb620-3" data-line-number="3"></a>
<a class="sourceLine" id="cb620-4" data-line-number="4"><span class="co"># Method 2.  dplyr loj with NA</span></a>
<a class="sourceLine" id="cb620-5" data-line-number="5">daj2 &lt;-</a>
<a class="sourceLine" id="cb620-6" data-line-number="6"><span class="st">  </span><span class="kw">left_join</span>(customer_table, rental_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;customer_id&quot;</span>, <span class="st">&quot;customer_id&quot;</span>), <span class="dt">suffix =</span> <span class="kw">c</span>(<span class="st">&quot;.c&quot;</span>, <span class="st">&quot;.r&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb620-7" data-line-number="7"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">is.na</span>(rental_id)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb620-8" data-line-number="8"><span class="st">  </span><span class="kw">select</span>(<span class="kw">c</span>(<span class="st">&quot;first_name&quot;</span>, <span class="st">&quot;last_name&quot;</span>, <span class="st">&quot;email&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb620-9" data-line-number="9"><span class="st">  </span><span class="kw">explain</span>()</a></code></pre></div>
<pre><code>## &lt;SQL&gt;
## SELECT &quot;first_name&quot;, &quot;last_name&quot;, &quot;email&quot;
## FROM (SELECT &quot;TBL_LEFT&quot;.&quot;customer_id&quot; AS &quot;customer_id&quot;, &quot;TBL_LEFT&quot;.&quot;store_id&quot; AS &quot;store_id&quot;, &quot;TBL_LEFT&quot;.&quot;first_name&quot; AS &quot;first_name&quot;, &quot;TBL_LEFT&quot;.&quot;last_name&quot; AS &quot;last_name&quot;, &quot;TBL_LEFT&quot;.&quot;email&quot; AS &quot;email&quot;, &quot;TBL_LEFT&quot;.&quot;address_id&quot; AS &quot;address_id&quot;, &quot;TBL_LEFT&quot;.&quot;activebool&quot; AS &quot;activebool&quot;, &quot;TBL_LEFT&quot;.&quot;create_date&quot; AS &quot;create_date&quot;, &quot;TBL_LEFT&quot;.&quot;last_update&quot; AS &quot;last_update.c&quot;, &quot;TBL_LEFT&quot;.&quot;active&quot; AS &quot;active&quot;, &quot;TBL_RIGHT&quot;.&quot;rental_id&quot; AS &quot;rental_id&quot;, &quot;TBL_RIGHT&quot;.&quot;rental_date&quot; AS &quot;rental_date&quot;, &quot;TBL_RIGHT&quot;.&quot;inventory_id&quot; AS &quot;inventory_id&quot;, &quot;TBL_RIGHT&quot;.&quot;return_date&quot; AS &quot;return_date&quot;, &quot;TBL_RIGHT&quot;.&quot;staff_id&quot; AS &quot;staff_id&quot;, &quot;TBL_RIGHT&quot;.&quot;last_update&quot; AS &quot;last_update.r&quot;
##   FROM &quot;customer&quot; AS &quot;TBL_LEFT&quot;
##   LEFT JOIN &quot;rental&quot; AS &quot;TBL_RIGHT&quot;
##   ON (&quot;TBL_LEFT&quot;.&quot;customer_id&quot; = &quot;TBL_RIGHT&quot;.&quot;customer_id&quot;)
## ) &quot;ihebfvnxvb&quot;
## WHERE (((&quot;rental_id&quot;) IS NULL))</code></pre>
<pre><code>## </code></pre>
<pre><code>## &lt;PLAN&gt;
## Hash Right Join  (cost=22.48..375.33 rows=80 width=334)
##   Hash Cond: (&quot;TBL_RIGHT&quot;.customer_id = &quot;TBL_LEFT&quot;.customer_id)
##   Filter: (&quot;TBL_RIGHT&quot;.rental_id IS NULL)
##   -&gt;  Seq Scan on rental &quot;TBL_RIGHT&quot;  (cost=0.00..310.44 rows=16044 width=6)
##   -&gt;  Hash  (cost=14.99..14.99 rows=599 width=338)
##         -&gt;  Seq Scan on customer &quot;TBL_LEFT&quot;  (cost=0.00..14.99 rows=599 width=338)</code></pre>
<!-- 


### dplyr Costs

```
<PLAN>
Hash Anti Join  (cost=510.99..529.72 rows=1 width=45)
  Hash Cond: ("TBL_LEFT".customer_id = "TBL_RIGHT".customer_id)
  ->  Seq Scan on customer "TBL_LEFT"  (cost=0.00..14.99 rows=599 width=49)
  ->  Hash  (cost=310.44..310.44 rows=16044 width=2)
        ->  Seq Scan on rental "TBL_RIGHT"  (cost=0.00..310.44 rows=16044 width=2)
```

```
<PLAN>
Hash Right Join  (cost=22.48..375.33 rows=1 width=45)
  Hash Cond: ("TBL_RIGHT".customer_id = "TBL_LEFT".customer_id)
  Filter: ("TBL_RIGHT".rental_id IS NULL)
  ->  Seq Scan on rental "TBL_RIGHT"  (cost=0.00..310.44 rows=16044 width=6)
  ->  Hash  (cost=14.99..14.99 rows=599 width=49)
        ->  Seq Scan on customer "TBL_LEFT"  (cost=0.00..14.99 rows=599 width=49)
```
-->
<p>In this example, the dplyr anti_join verb is <em>1.4113447 to 22.7308719</em> times more expensive than the left outer join with a null condition.</p>
<div class="sourceCode" id="cb624"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb624-1" data-line-number="1">sql_aj1 &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb624-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb624-3" data-line-number="3">  <span class="st">&quot;explain analyze select c.customer_id,count(*) lojs</span></a>
<a class="sourceLine" id="cb624-4" data-line-number="4"><span class="st">   from customer c left outer join rental r on c.customer_id = r.customer_id</span></a>
<a class="sourceLine" id="cb624-5" data-line-number="5"><span class="st">  where r.customer_id is null</span></a>
<a class="sourceLine" id="cb624-6" data-line-number="6"><span class="st">  group by c.customer_id</span></a>
<a class="sourceLine" id="cb624-7" data-line-number="7"><span class="st">order by c.customer_id;&quot;</span></a>
<a class="sourceLine" id="cb624-8" data-line-number="8">)</a>
<a class="sourceLine" id="cb624-9" data-line-number="9"><span class="kw">sp_print_df</span>(sql_aj1)</a></code></pre></div>
<div id="htmlwidget-124fb78127817ec02cd9" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-124fb78127817ec02cd9">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13"],["GroupAggregate  (cost=564.97..570.22 rows=300 width=12) (actual time=262.915..262.992 rows=4 loops=1)","  Group Key: c.customer_id","  -&gt;  Sort  (cost=564.97..565.72 rows=300 width=4) (actual time=262.882..262.916 rows=4 loops=1)","        Sort Key: c.customer_id","        Sort Method: quicksort  Memory: 25kB","        -&gt;  Hash Anti Join  (cost=510.99..552.63 rows=300 width=4) (actual time=262.748..262.837 rows=4 loops=1)","              Hash Cond: (c.customer_id = r.customer_id)","              -&gt;  Seq Scan on customer c  (cost=0.00..14.99 rows=599 width=4) (actual time=0.017..4.271 rows=604 loops=1)","              -&gt;  Hash  (cost=310.44..310.44 rows=16044 width=2) (actual time=253.932..253.938 rows=16045 loops=1)","                    Buckets: 16384  Batches: 1  Memory Usage: 661kB","                    -&gt;  Seq Scan on rental r  (cost=0.00..310.44 rows=16044 width=2) (actual time=0.013..126.414 rows=16045 loops=1)","Planning time: 0.162 ms","Execution time: 263.149 ms"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>QUERY PLAN<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb625"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb625-1" data-line-number="1">sql_aj1</a></code></pre></div>
<pre><code>##                                                                                                                              QUERY PLAN
## 1                                 GroupAggregate  (cost=564.97..570.22 rows=300 width=12) (actual time=262.915..262.992 rows=4 loops=1)
## 2                                                                                                              Group Key: c.customer_id
## 3                                        -&gt;  Sort  (cost=564.97..565.72 rows=300 width=4) (actual time=262.882..262.916 rows=4 loops=1)
## 4                                                                                                               Sort Key: c.customer_id
## 5                                                                                                  Sort Method: quicksort  Memory: 25kB
## 6                              -&gt;  Hash Anti Join  (cost=510.99..552.63 rows=300 width=4) (actual time=262.748..262.837 rows=4 loops=1)
## 7                                                                                            Hash Cond: (c.customer_id = r.customer_id)
## 8                           -&gt;  Seq Scan on customer c  (cost=0.00..14.99 rows=599 width=4) (actual time=0.017..4.271 rows=604 loops=1)
## 9                                  -&gt;  Hash  (cost=310.44..310.44 rows=16044 width=2) (actual time=253.932..253.938 rows=16045 loops=1)
## 10                                                                                      Buckets: 16384  Batches: 1  Memory Usage: 661kB
## 11                     -&gt;  Seq Scan on rental r  (cost=0.00..310.44 rows=16044 width=2) (actual time=0.013..126.414 rows=16045 loops=1)
## 12                                                                                                              Planning time: 0.162 ms
## 13                                                                                                           Execution time: 263.149 ms</code></pre>
<div class="sourceCode" id="cb627"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb627-1" data-line-number="1">sql_aj3 &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb627-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb627-3" data-line-number="3">  <span class="st">&quot;explain analyze </span></a>
<a class="sourceLine" id="cb627-4" data-line-number="4"><span class="st">select c.customer_id,count(*) lojs</span></a>
<a class="sourceLine" id="cb627-5" data-line-number="5"><span class="st">   from customer c </span></a>
<a class="sourceLine" id="cb627-6" data-line-number="6"><span class="st">  where not exists (select customer_id from rental r where c.customer_id = r.customer_id)</span></a>
<a class="sourceLine" id="cb627-7" data-line-number="7"><span class="st"> group by c.customer_id</span></a>
<a class="sourceLine" id="cb627-8" data-line-number="8"><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb627-9" data-line-number="9">)</a>
<a class="sourceLine" id="cb627-10" data-line-number="10"></a>
<a class="sourceLine" id="cb627-11" data-line-number="11"><span class="kw">print</span>(<span class="kw">glue</span>(<span class="st">&quot;sql_aj1 loj-null costs=&quot;</span>, sql_aj1[<span class="dv">1</span>, <span class="dv">1</span>]))</a></code></pre></div>
<pre><code>## sql_aj1 loj-null costs=GroupAggregate  (cost=564.97..570.22 rows=300 width=12) (actual time=262.915..262.992 rows=4 loops=1)</code></pre>
<div class="sourceCode" id="cb629"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb629-1" data-line-number="1"><span class="kw">print</span>(<span class="kw">glue</span>(<span class="st">&quot;sql_aj3 not exist costs=&quot;</span>, sql_aj3[<span class="dv">1</span>, <span class="dv">1</span>]))</a></code></pre></div>
<pre><code>## sql_aj3 not exist costs=HashAggregate  (cost=554.13..557.13 rows=300 width=12) (actual time=249.959..249.995 rows=4 loops=1)</code></pre>
<!--chapter:end:160-anti-join-cost-comparisons.Rmd-->
</div>
</div>
<div id="chapter_sql-quick-start" class="section level1">
<h1><span class="header-section-number">27</span> SQL Quick start - simple retrieval</h1>
<blockquote>
<p>This chapter demonstrates:</p>
<ul>
<li>Several elementary SQL statements</li>
<li>SQL databases and 3rd normal form</li>
</ul>
</blockquote>
<div id="intro" class="section level2">
<h2><span class="header-section-number">27.1</span> Intro</h2>
<ul>
<li><p>Coverage in this book. There are many SQL tutorials that are available. For example, we are drawing some materials from <a href="http://www.postgresqltutorial.com/postgresql-sample-database/">a tutorial we recommend</a>. In particular, we will not replicate the lessons there, which you might want to complete. Instead, we are showing strategies that are recommended for R users. That will include some translations of queries that are discussed there.</p></li>
<li><p><a href="https://datacarpentry.org/R-ecology-lesson/05-r-and-databases.html" class="uri">https://datacarpentry.org/R-ecology-lesson/05-r-and-databases.html</a> Very good intro. How is ours different?</p></li>
</ul>
<p>Start up the <code>docker-pet</code> container</p>
<div class="sourceCode" id="cb631"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb631-1" data-line-number="1"><span class="kw">sp_docker_start</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<p>Now connect to the <code>dvdrental</code> database with R</p>
<div class="sourceCode" id="cb632"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb632-1" data-line-number="1">con &lt;-<span class="st"> </span><span class="kw">sp_get_postgres_connection</span>(</a>
<a class="sourceLine" id="cb632-2" data-line-number="2">  <span class="dt">user =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_USER_NAME&quot;</span>),</a>
<a class="sourceLine" id="cb632-3" data-line-number="3">  <span class="dt">password =</span>  <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_PASSWORD&quot;</span>),</a>
<a class="sourceLine" id="cb632-4" data-line-number="4">  <span class="dt">dbname =</span> <span class="st">&quot;dvdrental&quot;</span>,</a>
<a class="sourceLine" id="cb632-5" data-line-number="5">  <span class="dt">seconds_to_test =</span> <span class="dv">30</span>)</a>
<a class="sourceLine" id="cb632-6" data-line-number="6">con</a></code></pre></div>
<pre><code>## &lt;PqConnection&gt; dvdrental@localhost:5432</code></pre>
<div class="sourceCode" id="cb634"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb634-1" data-line-number="1">colFmt &lt;-<span class="st"> </span><span class="cf">function</span>(x,color)</a>
<a class="sourceLine" id="cb634-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb634-3" data-line-number="3">  <span class="co"># x string</span></a>
<a class="sourceLine" id="cb634-4" data-line-number="4">  <span class="co"># color </span></a>
<a class="sourceLine" id="cb634-5" data-line-number="5">  outputFormat =<span class="st"> </span>knitr<span class="op">::</span>opts_knit<span class="op">$</span><span class="kw">get</span>(<span class="st">&quot;rmarkdown.pandoc.to&quot;</span>)</a>
<a class="sourceLine" id="cb634-6" data-line-number="6">  <span class="cf">if</span>(outputFormat <span class="op">==</span><span class="st"> &#39;latex&#39;</span>)</a>
<a class="sourceLine" id="cb634-7" data-line-number="7">    <span class="kw">paste</span>(<span class="st">&quot;</span><span class="ch">\\</span><span class="st">textcolor{&quot;</span>,color,<span class="st">&quot;}{&quot;</span>,x,<span class="st">&quot;}&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb634-8" data-line-number="8">  <span class="cf">else</span> <span class="cf">if</span>(outputFormat <span class="op">==</span><span class="st"> &#39;html&#39;</span>)</a>
<a class="sourceLine" id="cb634-9" data-line-number="9">    <span class="kw">paste</span>(<span class="st">&quot;&lt;font color=&#39;&quot;</span>,color,<span class="st">&quot;&#39;&gt;&quot;</span>,x,<span class="st">&quot;&lt;/font&gt;&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb634-10" data-line-number="10">  <span class="cf">else</span></a>
<a class="sourceLine" id="cb634-11" data-line-number="11">    x</a>
<a class="sourceLine" id="cb634-12" data-line-number="12">}</a>
<a class="sourceLine" id="cb634-13" data-line-number="13"></a>
<a class="sourceLine" id="cb634-14" data-line-number="14"><span class="co"># sample call</span></a>
<a class="sourceLine" id="cb634-15" data-line-number="15"><span class="co"># * `r colFmt(&#39;Cover inline tables in future section&#39;,&#39;red&#39;)`</span></a></code></pre></div>
<p>Moved this from 11-elementary-queries</p>
<div class="sourceCode" id="cb635"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb635-1" data-line-number="1">dplyr_summary_df &lt;-</a>
<a class="sourceLine" id="cb635-2" data-line-number="2"><span class="st">    </span><span class="kw">read.delim</span>(</a>
<a class="sourceLine" id="cb635-3" data-line-number="3">    <span class="st">&#39;11-dplyr_sql_summary_table.tsv&#39;</span>,</a>
<a class="sourceLine" id="cb635-4" data-line-number="4">    <span class="dt">header =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb635-5" data-line-number="5">    <span class="dt">sep =</span> <span class="st">&#39;</span><span class="ch">\t</span><span class="st">&#39;</span>,</a>
<a class="sourceLine" id="cb635-6" data-line-number="6">    <span class="dt">as.is =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb635-7" data-line-number="7">    )</a>
<a class="sourceLine" id="cb635-8" data-line-number="8"></a>
<a class="sourceLine" id="cb635-9" data-line-number="9"><span class="kw">head</span>(dplyr_summary_df)</a></code></pre></div>
<pre><code>##   In          Dplyr_Function
## 1  Y               arrange()
## 2 Y?              distinct()
## 3  Y       select() rename()
## 4  N                  pull()
## 5  Y    mutate() transmute()
## 6  Y summarise() summarize()
##                                      description
## 1                      Arrange rows by variables
## 2           Return rows with matching conditions
## 3                Select/rename variables by name
## 4                     Pull out a single variable
## 5                              Add new variables
## 6 Reduces multiple values down to a single value
##                            SQL_Clause Notes                 Category
## 1                            ORDER BY    NA Basic single-table verbs
## 2                   SELECT distinct *    NA Basic single-table verbs
## 3       SELECT column_name alias_name    NA Basic single-table verbs
## 4                 SELECT column_name;    NA Basic single-table verbs
## 5 SELECT computed_value computed_name    NA Basic single-table verbs
## 6 SELECT aggregate_functions GROUP BY    NA Basic single-table verbs</code></pre>
</div>
<div id="databases-and-third-normal-form---3nf" class="section level2">
<h2><span class="header-section-number">27.2</span> Databases and Third Normal Form - 3NF</h2>
<p>Most relational database applications are designed to be third normal form “like”, 3NF. The key benefits of 3NF are</p>
<ol style="list-style-type: decimal">
<li>speedy on-line transactional processing, OLTP.</li>
<li>improved referential integrity, reduce modification anomalies that can occur during an insert, update, or delete operation.</li>
<li>reduced storage, elimination of redundant data.</li>
</ol>
<p>3NF is great for database application input performance, but not so great for getting the data back out for the data analyst or report writer. As a data analyst, you might get the ubiquitous Excel spreadsheet with all the information needed to start an Exploratory Data Analysis, EDA. The spreadsheet may have provider, patient, diagnosis, procedure, and insurance information all “neatly” arranged on a single row. At least “neatly” when compared to the same information stored in the database, in at least 5 tables.</p>
<p>For this tutorial, the most important thing to know about 3NF is that the data you are looking for gets spread across many many tables. Working in a relational database requires you to</p>
<ol style="list-style-type: decimal">
<li>find the many many different tables that contains your data.<br />
</li>
<li>Understand the relationships that tie the tables together correctly to ensure that data is not dropped or duplicated. Data that is dropped or duplicated can either over or understate your aggregated numeric values.</li>
</ol>
<div class="figure">
<img src="screenshots/ERD_Hospital_Billing_System.PNG" alt="hospital-billing-erd" />
<p class="caption">hospital-billing-erd</p>
</div>
<p><a href="https://www.smartdraw.com/entity-relationship-diagram/examples/hospital-billing-entity-relationship-diagram/" class="uri">https://www.smartdraw.com/entity-relationship-diagram/examples/hospital-billing-entity-relationship-diagram/</a></p>
<p>Real life applications have 100’s or even 1000’s of tables supporting the application. The goal is to transform the application data model into a useful data analysis model using the DDL and DML SQL statements.</p>
</div>
<div id="sql-commands" class="section level2">
<h2><span class="header-section-number">27.3</span> SQL Commands</h2>
<p>SQL commands fall into four categories.</p>
<table>
<colgroup>
<col width="20%" />
<col width="79%" />
</colgroup>
<thead>
<tr class="header">
<th>SQL Category</th>
<th>Definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>DDL:Data Definition Language</td>
<td>DBA’s execute these commands to define objects in the database.</td>
</tr>
<tr class="even">
<td>DML:Data Manipulation Language</td>
<td>Users and developers execute these commands to investigate data.</td>
</tr>
<tr class="odd">
<td>DCL:Data Control Language</td>
<td>DBA’s execute these commands to grant/revoke access to</td>
</tr>
<tr class="even">
<td>TCL:Transaction Control Language</td>
<td>Developers execute these commands when developing applications.</td>
</tr>
</tbody>
</table>
<p>Data analysts use the SELECT DML command to learn interesting things about the data stored in the database. Applications are used to control the insert, update, and deletion of data in the database. Data users can update the database objects via the application which enforces referential integrity in the database. Data users should never directly update data application database objects. Leave this task to the developers and DBA’s.</p>
<p>DBA’s can setup a sandbox within the database for a data analyst. The application(s) do not maintain the data in the sandbox.</p>
<p>The <code>sql-pet</code> database is tiny, but for the purposes of these exercises, we assume that data so large that it will not easily fit into the memory of your laptop.</p>
<p>This tutorial focuses on the most frequently used SQL statement, the SQL SELECT statement.</p>
<p>A SQL SELECT statement consists of 1 to 6 clauses.</p>
<table>
<colgroup>
<col width="26%" />
<col width="26%" />
<col width="46%" />
</colgroup>
<thead>
<tr class="header">
<th>SQL Clause</th>
<th>DPLYR Verb</th>
<th>SQL Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>SELECT</td>
<td>SELECT()</td>
<td>Contains a list of column names from an object or a derived value.</td>
</tr>
<tr class="even">
<td></td>
<td>mutate()</td>
<td></td>
</tr>
<tr class="odd">
<td>FROM</td>
<td></td>
<td>Contains a list of related tables from which the SELECT list of columns is derived.</td>
</tr>
<tr class="even">
<td>WHERE</td>
<td>filter()</td>
<td>Provides the filter conditions the objects in the FROM clause must meet.</td>
</tr>
<tr class="odd">
<td>GROUP BY</td>
<td>group_by()</td>
<td>Contains a list rollup aggregation columns.</td>
</tr>
<tr class="even">
<td>HAVING</td>
<td></td>
<td>Provides the filter condition on the the GROUP BY clause.</td>
</tr>
<tr class="odd">
<td>ORDER BY</td>
<td>arrange()</td>
<td>Contains a list of column names indicating the order of the column value. Each column can be either ASCending or DEScending.</td>
</tr>
</tbody>
</table>
<p>The foundation of the SQL language is based set theory and the result of a SQL SELECT statement is referred to as a result set. A SQL SELECT statement is “guaranteed” to return the same set of data,
but not necessarily in the same order. However, in practice, the result set is usually in the same order.</p>
<p>SQL SELECT statements can be broken up into two categories, SELECT detail statements and SELECT aggregate statements.</p>
<table>
<thead>
<tr class="header">
<th>SELECT DETAIL</th>
<th>SELECT AGGREGATE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>select det_col1…det_coln</td>
<td>select det_agg1…, agg1,…,aggn</td>
</tr>
<tr class="even">
<td>from same</td>
<td>from same</td>
</tr>
<tr class="odd">
<td>where same</td>
<td>where same</td>
</tr>
<tr class="even">
<td></td>
<td>group by det_agg1</td>
</tr>
<tr class="odd">
<td></td>
<td>having <aggregation condition></td>
</tr>
<tr class="even">
<td>order by same</td>
<td>order by same</td>
</tr>
</tbody>
</table>
<p>The difference between the two statements is the AGGREGATE has</p>
<ol style="list-style-type: decimal">
<li>select clause has one or more detail columns, det_agg1…, on which values get aggregated against/rolled up to.</li>
<li>select clause zero or more aggregated values, agg1, …, aggn</li>
<li>group by clause is required and matches the one or more detail columns, det_agg1.</li>
<li>having clause is optional and adds a filter condition on one or more agg1 … aggn values.</li>
</ol>
</div>
<div id="sql-select-quick-start" class="section level2">
<h2><span class="header-section-number">27.4</span> SQL SELECT Quick Start</h2>
<p>This section focuses on getting new SQL users familiar with the six SQL query clauses and a single table. SQL queries from multiple tables are discussed in the JOIN section of this tutorial. The JOIN section resolves the issue introduced with 3NF, the splitting of data into many many tables, back into a denormalaized format similar to the Excel spreadsheet.</p>
<p>The DBI::dbGetQuery function is used to submit SQL SELECT statements to the PostgreSQL database. At a minimum it requires two parameters, a connection object and a SQL SELECT statement.</p>
<p>In the following section we only look at SELECT DETAIL statements.</p>
<div id="select-clause-column-selection-vertical-partioning-of-data" class="section level3">
<h3><span class="header-section-number">27.4.1</span> SELECT Clause: Column Selection – Vertical Partioning of Data</h3>
<div id="simplest-sql-query-all-rows-and-all-columns-from-a-single-table." class="section level4">
<h4><span class="header-section-number">27.4.1.1</span> 1. Simplest SQL query: All rows and all columns from a single table.</h4>
<div class="sourceCode" id="cb637"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb637-1" data-line-number="1">rs &lt;-</a>
<a class="sourceLine" id="cb637-2" data-line-number="2"><span class="st">  </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb637-3" data-line-number="3">  con,</a>
<a class="sourceLine" id="cb637-4" data-line-number="4">  <span class="st">&quot;</span></a>
<a class="sourceLine" id="cb637-5" data-line-number="5"><span class="st">  select * from store;</span></a>
<a class="sourceLine" id="cb637-6" data-line-number="6"><span class="st">  &quot;</span>)</a>
<a class="sourceLine" id="cb637-7" data-line-number="7"><span class="kw">kable</span>(rs,<span class="dt">caption =</span> <span class="st">&#39;select all columns&#39;</span>)  </a></code></pre></div>
<table>
<caption>(#tab:unnamed-chunk-5)select all columns</caption>
<thead>
<tr class="header">
<th align="right">store_id</th>
<th align="right">manager_staff_id</th>
<th align="right">address_id</th>
<th align="left">last_update</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">2006-02-15 09:57:12</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">2</td>
<td align="right">2</td>
<td align="left">2006-02-15 09:57:12</td>
</tr>
<tr class="odd">
<td align="right">10</td>
<td align="right">10</td>
<td align="right">10</td>
<td align="left">2019-03-03 18:22:06</td>
</tr>
</tbody>
</table>
</div>
<div id="same-query-as-1-but-only-show-first-two-columns" class="section level4">
<h4><span class="header-section-number">27.4.1.2</span> 2. Same Query as 1, but only show first two columns;</h4>
<div class="sourceCode" id="cb638"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb638-1" data-line-number="1">rs &lt;-</a>
<a class="sourceLine" id="cb638-2" data-line-number="2"><span class="st">  </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb638-3" data-line-number="3">  con,</a>
<a class="sourceLine" id="cb638-4" data-line-number="4">  <span class="st">&quot;</span></a>
<a class="sourceLine" id="cb638-5" data-line-number="5"><span class="st">  select STORE_ID, manager_staff_id from store;  </span></a>
<a class="sourceLine" id="cb638-6" data-line-number="6"><span class="st">  &quot;</span>)</a>
<a class="sourceLine" id="cb638-7" data-line-number="7"><span class="kw">kable</span>(rs,<span class="dt">caption =</span> <span class="st">&#39;select first two columns only&#39;</span>) </a></code></pre></div>
<table>
<caption>(#tab:unnamed-chunk-6)select first two columns only</caption>
<thead>
<tr class="header">
<th align="right">store_id</th>
<th align="right">manager_staff_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="right">10</td>
<td align="right">10</td>
</tr>
</tbody>
</table>
</div>
<div id="same-query-as-2-but-reverse-the-column-order" class="section level4">
<h4><span class="header-section-number">27.4.1.3</span> 3. Same Query as 2, but reverse the column order</h4>
<p>dvdrental=# select manager_staff_id,store_id from store;</p>
<div class="sourceCode" id="cb639"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb639-1" data-line-number="1">rs &lt;-</a>
<a class="sourceLine" id="cb639-2" data-line-number="2"><span class="st">  </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb639-3" data-line-number="3">  con,</a>
<a class="sourceLine" id="cb639-4" data-line-number="4">  <span class="st">&quot;</span></a>
<a class="sourceLine" id="cb639-5" data-line-number="5"><span class="st">  select manager_staff_id,store_id from store;  </span></a>
<a class="sourceLine" id="cb639-6" data-line-number="6"><span class="st">  &quot;</span>)</a>
<a class="sourceLine" id="cb639-7" data-line-number="7"><span class="kw">kable</span>(rs,<span class="dt">caption =</span> <span class="st">&#39;reverse the column order&#39;</span>) </a></code></pre></div>
<table>
<caption>(#tab:unnamed-chunk-7)reverse the column order</caption>
<thead>
<tr class="header">
<th align="right">manager_staff_id</th>
<th align="right">store_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="right">10</td>
<td align="right">10</td>
</tr>
</tbody>
</table>
</div>
<div id="rename-columns-sql-column-alias-in-the-result-set" class="section level4">
<h4><span class="header-section-number">27.4.1.4</span> 4. Rename Columns – SQL column alias in the result set</h4>
<div class="sourceCode" id="cb640"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb640-1" data-line-number="1">rs &lt;-</a>
<a class="sourceLine" id="cb640-2" data-line-number="2"><span class="st">  </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb640-3" data-line-number="3">  con,</a>
<a class="sourceLine" id="cb640-4" data-line-number="4">  <span class="st">&quot;</span></a>
<a class="sourceLine" id="cb640-5" data-line-number="5"><span class="st">  select manager_staff_id mgr_sid,store_id st_id from store;    </span></a>
<a class="sourceLine" id="cb640-6" data-line-number="6"><span class="st">  &quot;</span>)</a>
<a class="sourceLine" id="cb640-7" data-line-number="7"><span class="kw">kable</span>(rs,<span class="dt">caption =</span> <span class="st">&#39;Rename Columns&#39;</span>) </a></code></pre></div>
<table>
<caption>(#tab:unnamed-chunk-8)Rename Columns</caption>
<thead>
<tr class="header">
<th align="right">mgr_sid</th>
<th align="right">st_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="right">10</td>
<td align="right">10</td>
</tr>
</tbody>
</table>
<pre><code>The manager_staff_id has changed to mgr_sid.
store_id has changed to st_id.  

Note that the column names have changed in the result set only, not in the actual database table.  
The DBA&#39;s will not allow a space or other special characters in a database table column name.  

Some motivations for aliasing the result set column names are

  1.  Some database table column names are not user friendly.
  2.  When multiple tables are joined, the column names may be the same in one or more tables and one needs to distinguish between the column names from the different tables.
  </code></pre>
</div>
<div id="adding-meta-data-columns-to-the-result-set" class="section level4">
<h4><span class="header-section-number">27.4.1.5</span> 5. Adding Meta Data Columns to the Result Set</h4>
<div class="sourceCode" id="cb642"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb642-1" data-line-number="1">rs &lt;-</a>
<a class="sourceLine" id="cb642-2" data-line-number="2"><span class="st">  </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb642-3" data-line-number="3">  con,</a>
<a class="sourceLine" id="cb642-4" data-line-number="4">  <span class="st">&quot;</span></a>
<a class="sourceLine" id="cb642-5" data-line-number="5"><span class="st">  select &#39;derived column&#39; showing</span></a>
<a class="sourceLine" id="cb642-6" data-line-number="6"><span class="st">        ,*</span></a>
<a class="sourceLine" id="cb642-7" data-line-number="7"><span class="st">        ,current_database() db</span></a>
<a class="sourceLine" id="cb642-8" data-line-number="8"><span class="st">        ,user</span></a>
<a class="sourceLine" id="cb642-9" data-line-number="9"><span class="st">        ,to_char(now(),&#39;YYYY/MM/DD HH24:MI:SS&#39;) dtts </span></a>
<a class="sourceLine" id="cb642-10" data-line-number="10"><span class="st">    from store;    </span></a>
<a class="sourceLine" id="cb642-11" data-line-number="11"><span class="st">  &quot;</span>)</a>
<a class="sourceLine" id="cb642-12" data-line-number="12"><span class="kw">kable</span>(rs,<span class="dt">caption =</span> <span class="st">&#39;Adding Meta Data Columns&#39;</span>) </a></code></pre></div>
<table>
<caption>(#tab:unnamed-chunk-9)Adding Meta Data Columns</caption>
<thead>
<tr class="header">
<th align="left">showing</th>
<th align="right">store_id</th>
<th align="right">manager_staff_id</th>
<th align="right">address_id</th>
<th align="left">last_update</th>
<th align="left">db</th>
<th align="left">user</th>
<th align="left">dtts</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">derived column</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">2006-02-15 09:57:12</td>
<td align="left">dvdrental</td>
<td align="left">postgres</td>
<td align="left">2019/03/04 02:22:09</td>
</tr>
<tr class="even">
<td align="left">derived column</td>
<td align="right">2</td>
<td align="right">2</td>
<td align="right">2</td>
<td align="left">2006-02-15 09:57:12</td>
<td align="left">dvdrental</td>
<td align="left">postgres</td>
<td align="left">2019/03/04 02:22:09</td>
</tr>
<tr class="odd">
<td align="left">derived column</td>
<td align="right">10</td>
<td align="right">10</td>
<td align="right">10</td>
<td align="left">2019-03-03 18:22:06</td>
<td align="left">dvdrental</td>
<td align="left">postgres</td>
<td align="left">2019/03/04 02:22:09</td>
</tr>
</tbody>
</table>
<pre><code>All the previous examples easily fit on a single line.  This one is longer.  Each column is entered on its own line, indented past the select keyword, and preceeded by a comma.  

1.  The showing column is a hard coded string surrounded by single quotes.  Note that single quotes are for hard coded values and double quotes are for column aliases.  
2.  The db and dtts, date timestamp, are new columns generated from PostgreSQL System Information Functions.
3.  Note that `user` is not a function call, no parenthesis.  </code></pre>
</div>
</div>
<div id="sql-comments" class="section level3">
<h3><span class="header-section-number">27.4.2</span> SQL Comments</h3>
<p>SQL supports both a single line comment, preceed the line with two dashes, <code>--</code>, and a C like block comment, \* … */.</p>
<div id="single-line-comment" class="section level4">
<h4><span class="header-section-number">27.4.2.1</span> 6. Single line comment –</h4>
<div class="sourceCode" id="cb644"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb644-1" data-line-number="1">rs &lt;-</a>
<a class="sourceLine" id="cb644-2" data-line-number="2"><span class="st">  </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb644-3" data-line-number="3">  con,</a>
<a class="sourceLine" id="cb644-4" data-line-number="4">  <span class="st">&quot;</span></a>
<a class="sourceLine" id="cb644-5" data-line-number="5"><span class="st">  select &#39;single line comment, dtts&#39; showing       </span></a>
<a class="sourceLine" id="cb644-6" data-line-number="6"><span class="st">        ,*</span></a>
<a class="sourceLine" id="cb644-7" data-line-number="7"><span class="st">        ,current_database() db</span></a>
<a class="sourceLine" id="cb644-8" data-line-number="8"><span class="st">        ,user</span></a>
<a class="sourceLine" id="cb644-9" data-line-number="9"><span class="st">    --  ,to_char(now(),&#39;YYYY/MM/DD HH24:MI:SS&#39;) dtts</span></a>
<a class="sourceLine" id="cb644-10" data-line-number="10"><span class="st">    from store;    </span></a>
<a class="sourceLine" id="cb644-11" data-line-number="11"><span class="st">  &quot;</span>)</a>
<a class="sourceLine" id="cb644-12" data-line-number="12"><span class="kw">kable</span>(rs,<span class="dt">caption =</span> <span class="st">&#39;Sincle line comment&#39;</span>) </a></code></pre></div>
<table>
<caption>(#tab:unnamed-chunk-10)Sincle line comment</caption>
<thead>
<tr class="header">
<th align="left">showing</th>
<th align="right">store_id</th>
<th align="right">manager_staff_id</th>
<th align="right">address_id</th>
<th align="left">last_update</th>
<th align="left">db</th>
<th align="left">user</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">single line comment, dtts</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">2006-02-15 09:57:12</td>
<td align="left">dvdrental</td>
<td align="left">postgres</td>
</tr>
<tr class="even">
<td align="left">single line comment, dtts</td>
<td align="right">2</td>
<td align="right">2</td>
<td align="right">2</td>
<td align="left">2006-02-15 09:57:12</td>
<td align="left">dvdrental</td>
<td align="left">postgres</td>
</tr>
<tr class="odd">
<td align="left">single line comment, dtts</td>
<td align="right">10</td>
<td align="right">10</td>
<td align="right">10</td>
<td align="left">2019-03-03 18:22:06</td>
<td align="left">dvdrental</td>
<td align="left">postgres</td>
</tr>
</tbody>
</table>
<pre><code>The dtts  line is commented out with the two dashes and is dropped from the end of the result set columns.</code></pre>
</div>
<div id="multi-line-comment" class="section level4">
<h4><span class="header-section-number">27.4.2.2</span> 7. Multi-line comment /*…*/</h4>
<div class="sourceCode" id="cb646"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb646-1" data-line-number="1">rs &lt;-</a>
<a class="sourceLine" id="cb646-2" data-line-number="2"><span class="st">  </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb646-3" data-line-number="3">  con,</a>
<a class="sourceLine" id="cb646-4" data-line-number="4">  <span class="st">&quot;</span></a>
<a class="sourceLine" id="cb646-5" data-line-number="5"><span class="st">  select &#39;block comment drop db, user, and dtts&#39; showing</span></a>
<a class="sourceLine" id="cb646-6" data-line-number="6"><span class="st">        ,*</span></a>
<a class="sourceLine" id="cb646-7" data-line-number="7"><span class="st">        /*</span></a>
<a class="sourceLine" id="cb646-8" data-line-number="8"><span class="st">        ,current_database() db</span></a>
<a class="sourceLine" id="cb646-9" data-line-number="9"><span class="st">        ,user</span></a>
<a class="sourceLine" id="cb646-10" data-line-number="10"><span class="st">        ,to_char(now(),&#39;YYYY/MM/DD HH24:MI:SS&#39;) dtts</span></a>
<a class="sourceLine" id="cb646-11" data-line-number="11"><span class="st">        */</span></a>
<a class="sourceLine" id="cb646-12" data-line-number="12"><span class="st">    from store;    </span></a>
<a class="sourceLine" id="cb646-13" data-line-number="13"><span class="st">  &quot;</span>)</a>
<a class="sourceLine" id="cb646-14" data-line-number="14"><span class="kw">kable</span>(rs,<span class="dt">caption =</span> <span class="st">&#39;Multi-line comment&#39;</span>) </a></code></pre></div>
<table>
<caption>(#tab:unnamed-chunk-11)Multi-line comment</caption>
<thead>
<tr class="header">
<th align="left">showing</th>
<th align="right">store_id</th>
<th align="right">manager_staff_id</th>
<th align="right">address_id</th>
<th align="left">last_update</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">block comment drop db, user, and dtts</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">2006-02-15 09:57:12</td>
</tr>
<tr class="even">
<td align="left">block comment drop db, user, and dtts</td>
<td align="right">2</td>
<td align="right">2</td>
<td align="right">2</td>
<td align="left">2006-02-15 09:57:12</td>
</tr>
<tr class="odd">
<td align="left">block comment drop db, user, and dtts</td>
<td align="right">10</td>
<td align="right">10</td>
<td align="right">10</td>
<td align="left">2019-03-03 18:22:06</td>
</tr>
</tbody>
</table>
<pre><code>The three columns db, user, and dtts, between the /\* and \*/ have been commented and no longer appear as the end columns of the result set.</code></pre>
</div>
</div>
<div id="from-clause" class="section level3">
<h3><span class="header-section-number">27.4.3</span> FROM Clause</h3>
<p>The <code>FROM</code> clause contains one or more datasets, usually database tables/views, from which the <code>SELECT</code> columns are derived. For now, in the examples, we are only using a single table. If the database reflects a relational model, your data is likely spread out over several tables. The key take away when beginning your analysis is to pick the table that has most of the data that you need for your analysis. This table becomes your main or driving table to build your SQL query statement around. After identifying your driving table, potentially save yourself a lot of time and heart ache, review any view that is built on your driving table. If one or more exist, especially, if vendor built, may already have the additional information needed for your analysis.</p>
<p><font color='red'>Insert SQL here or link to Views dependent on what</font></p>
<p>In this tutorial, there is only a single user hitting the database and row/table locking is not necessary and considered out of scope.</p>
<div id="table-uses" class="section level4">
<h4><span class="header-section-number">27.4.3.1</span> Table Uses</h4>
<ul>
<li>A table can be used more than once in a FROM clause. These are self-referencing tables. An example is an EMPLOYEE table which contains a foriegn key to her manager. Her manager also has a foriegn key to her manager, etc up the corporate ladder.<br />
</li>
<li><p>In the example above, the EMPLOYEE table plays two roles, employee and manager. The next line shows the FROM clause showing the same table used twice.</p>
<p>FROM EMPLOYEE EE, EMPLOYEE MGR</p></li>
<li>The EE and MGR are aliases for the EMPLOYEE table and represent the different roles the EMPLOYEE table plays.<br />
</li>
<li>Since all the column names are exactly the same for the EE and MGR role, the column names need to be prefixed with their role alias, e.g., SELECT MGR.EE_NAME, EE.EE_NAME … shows the manager name and her employee name(s) who work for her.</li>
<li>It is a good habit to always alias your tables and prefix your column names with the table alias to eliminate any ambiguity as to where the column came from. This is critical where there is inconsistent table column naming convention. It also helps when debugging larger SQL queries.</li>
<li><p><font color='red'>Cover inline tables in future section</font></p></li>
</ul>
<pre><code>Side Note: Do not create an unintended Cartesian join.  If one has more than one table in the FROM clause, make sure that every table in the FROM clause joins to at least one other table in the WHERE clause.  If your result set has an unexpectantly high rowcount and long runtime, check for a missing join in the FROM clause.</code></pre>
</div>
</div>
<div id="where-clause-row-selection-horizontal-partitioning-of-data" class="section level3">
<h3><span class="header-section-number">27.4.4</span> WHERE Clause: Row Selection – Horizontal Partitioning of Data</h3>
<p>In the previous SELECT clause section, the SELECT statement either partitioned data vertically across the table columns or derived vertical column values. This section provides examples that partitions the table data across rows in the table.</p>
<p>The WHERE clause defines all the conditions the data must meet to be included or excluded in the final result set. If all the conditions are met data is returned or it is rejected. This is commonly referred to as the data set filter condition.</p>
<pre><code>Side Note: For performance optimization reasons, the WHERE clause should reduce the dataset down to the smallest dataset as quickly as possible.  This is typically done using indexed columns, range conditions, and any other condition that rejects a lot of rows from being retrieved.</code></pre>
<p>The WHERE condition(s) can be simple or complex, but in the end are the appliction of the logic rules shown in the table below.</p>
<table>
<thead>
<tr class="header">
<th>p</th>
<th>q</th>
<th>p and q</th>
<th>p or q</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>T</td>
<td>T</td>
<td>T</td>
<td>T</td>
</tr>
<tr class="even">
<td>T</td>
<td>F</td>
<td>F</td>
<td>T</td>
</tr>
<tr class="odd">
<td>T</td>
<td>N</td>
<td>N</td>
<td>T</td>
</tr>
<tr class="even">
<td>F</td>
<td>F</td>
<td>F</td>
<td>F</td>
</tr>
<tr class="odd">
<td>F</td>
<td>N</td>
<td>F</td>
<td>T</td>
</tr>
<tr class="even">
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
</tr>
</tbody>
</table>
<p>When the filter logic is complex, it is sometimes easier to represent the where clause symbollically and apply a version of DeMorgan’s law which is shown below.</p>
<ol style="list-style-type: decimal">
<li>(A and B)’ = A’ or B’</li>
<li>(A or B)’ = A’ and B’</li>
</ol>
<div id="examples-continued" class="section level4">
<h4><span class="header-section-number">27.4.4.1</span> Examples Continued</h4>
<p>We begin with <code>1</code>, our simplest SQL query.</p>
<div class="sourceCode" id="cb650"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb650-1" data-line-number="1">rs &lt;-</a>
<a class="sourceLine" id="cb650-2" data-line-number="2"><span class="st">  </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb650-3" data-line-number="3">  con,</a>
<a class="sourceLine" id="cb650-4" data-line-number="4">  <span class="st">&quot;</span></a>
<a class="sourceLine" id="cb650-5" data-line-number="5"><span class="st">  select * from store;</span></a>
<a class="sourceLine" id="cb650-6" data-line-number="6"><span class="st">  &quot;</span>)</a>
<a class="sourceLine" id="cb650-7" data-line-number="7"><span class="kw">kable</span>(rs,<span class="dt">caption =</span> <span class="st">&#39;select all columns&#39;</span>)  </a></code></pre></div>
<table>
<caption>(#tab:unnamed-chunk-12)select all columns</caption>
<thead>
<tr class="header">
<th align="right">store_id</th>
<th align="right">manager_staff_id</th>
<th align="right">address_id</th>
<th align="left">last_update</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">2006-02-15 09:57:12</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">2</td>
<td align="right">2</td>
<td align="left">2006-02-15 09:57:12</td>
</tr>
<tr class="odd">
<td align="right">10</td>
<td align="right">10</td>
<td align="right">10</td>
<td align="left">2019-03-03 18:22:06</td>
</tr>
</tbody>
</table>
</div>
<div id="where-condition-logically-never-true." class="section level4">
<h4><span class="header-section-number">27.4.4.2</span> 8 WHERE condition logically never TRUE.</h4>
<div class="sourceCode" id="cb651"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb651-1" data-line-number="1">rs &lt;-</a>
<a class="sourceLine" id="cb651-2" data-line-number="2"><span class="st">  </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb651-3" data-line-number="3">  con,</a>
<a class="sourceLine" id="cb651-4" data-line-number="4">  <span class="st">&quot;</span></a>
<a class="sourceLine" id="cb651-5" data-line-number="5"><span class="st">  select * from store where 1 = 0;</span></a>
<a class="sourceLine" id="cb651-6" data-line-number="6"><span class="st">  &quot;</span>)</a>
<a class="sourceLine" id="cb651-7" data-line-number="7"><span class="kw">kable</span>(rs,<span class="dt">caption =</span> <span class="st">&#39;WHERE always FALSE&#39;</span>)  </a></code></pre></div>
<p>Table: (#tab:unnamed-chunk-13)WHERE always FALSE</p>
<p>store_id manager_staff_id address_id last_update
——— —————– ———– ————</p>
<pre><code>Since 1 = 0 is always false, no rows are ever returned.  Initially this construct seems useless, but actually is quite handy when debugging large scripts where a portion of the script needs to be turned off or when creating an empty table with the exact same column names and types as the FROM table(s).  </code></pre>
</div>
<div id="where-condition-logically-always-true." class="section level4">
<h4><span class="header-section-number">27.4.4.3</span> 9 WHERE condition logically always TRUE.</h4>
<div class="sourceCode" id="cb653"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb653-1" data-line-number="1">rs &lt;-</a>
<a class="sourceLine" id="cb653-2" data-line-number="2"><span class="st">  </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb653-3" data-line-number="3">  con,</a>
<a class="sourceLine" id="cb653-4" data-line-number="4">  <span class="st">&quot;</span></a>
<a class="sourceLine" id="cb653-5" data-line-number="5"><span class="st">  select * from store where 1 = 1;</span></a>
<a class="sourceLine" id="cb653-6" data-line-number="6"><span class="st">  &quot;</span>)</a>
<a class="sourceLine" id="cb653-7" data-line-number="7"><span class="kw">kable</span>(rs,<span class="dt">caption =</span> <span class="st">&#39;WHERE always TRUE&#39;</span>)  </a></code></pre></div>
<table>
<caption>(#tab:unnamed-chunk-14)WHERE always TRUE</caption>
<thead>
<tr class="header">
<th align="right">store_id</th>
<th align="right">manager_staff_id</th>
<th align="right">address_id</th>
<th align="left">last_update</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">2006-02-15 09:57:12</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">2</td>
<td align="right">2</td>
<td align="left">2006-02-15 09:57:12</td>
</tr>
<tr class="odd">
<td align="right">10</td>
<td align="right">10</td>
<td align="right">10</td>
<td align="left">2019-03-03 18:22:06</td>
</tr>
</tbody>
</table>
<pre><code>Since 1 = 1 is always true, all rows are always returned.  Initially this construct seems useless, but actually is also quite handy when debugging large scripts and creating a backup of table.</code></pre>
</div>
<div id="where-equality-condition" class="section level4">
<h4><span class="header-section-number">27.4.4.4</span> 10 WHERE equality condition</h4>
<div class="sourceCode" id="cb655"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb655-1" data-line-number="1">rs &lt;-</a>
<a class="sourceLine" id="cb655-2" data-line-number="2"><span class="st">  </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb655-3" data-line-number="3">  con,</a>
<a class="sourceLine" id="cb655-4" data-line-number="4">  <span class="st">&quot;</span></a>
<a class="sourceLine" id="cb655-5" data-line-number="5"><span class="st">  select * from store where store_id = 2;</span></a>
<a class="sourceLine" id="cb655-6" data-line-number="6"><span class="st">  &quot;</span>)</a>
<a class="sourceLine" id="cb655-7" data-line-number="7"><span class="kw">kable</span>(rs,<span class="dt">caption =</span> <span class="st">&#39;WHERE EQUAL&#39;</span>)  </a></code></pre></div>
<table>
<caption>(#tab:unnamed-chunk-15)WHERE EQUAL</caption>
<thead>
<tr class="header">
<th align="right">store_id</th>
<th align="right">manager_staff_id</th>
<th align="right">address_id</th>
<th align="left">last_update</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">2</td>
<td align="right">2</td>
<td align="right">2</td>
<td align="left">2006-02-15 09:57:12</td>
</tr>
</tbody>
</table>
<pre><code>    The only row where the store_id = 2 is row 2 and it is the only row returned.
    </code></pre>
</div>
<div id="where-not-equal-conditions" class="section level4">
<h4><span class="header-section-number">27.4.4.5</span> 11 WHERE NOT equal conditions</h4>
<div class="sourceCode" id="cb657"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb657-1" data-line-number="1">rs &lt;-</a>
<a class="sourceLine" id="cb657-2" data-line-number="2"><span class="st">  </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb657-3" data-line-number="3">  con,</a>
<a class="sourceLine" id="cb657-4" data-line-number="4">  <span class="st">&quot;</span></a>
<a class="sourceLine" id="cb657-5" data-line-number="5"><span class="st">  select * from store where store_id &lt;&gt; 2;</span></a>
<a class="sourceLine" id="cb657-6" data-line-number="6"><span class="st">  &quot;</span>)</a>
<a class="sourceLine" id="cb657-7" data-line-number="7"><span class="kw">kable</span>(rs,<span class="dt">caption =</span> <span class="st">&#39;WHERE NOT EQUAL&#39;</span>)  </a></code></pre></div>
<table>
<caption>(#tab:unnamed-chunk-16)WHERE NOT EQUAL</caption>
<thead>
<tr class="header">
<th align="right">store_id</th>
<th align="right">manager_staff_id</th>
<th align="right">address_id</th>
<th align="left">last_update</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">2006-02-15 09:57:12</td>
</tr>
<tr class="even">
<td align="right">10</td>
<td align="right">10</td>
<td align="right">10</td>
<td align="left">2019-03-03 18:22:06</td>
</tr>
</tbody>
</table>
<pre><code>&lt;&gt; is syntactically the same as !=
    
    The only row where the store_id &lt;&gt; 2 is row 1 and only row 1 is returned.  </code></pre>
</div>
<div id="where-or-condition" class="section level4">
<h4><span class="header-section-number">27.4.4.6</span> 12 WHERE OR condition</h4>
<div class="sourceCode" id="cb659"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb659-1" data-line-number="1">rs &lt;-</a>
<a class="sourceLine" id="cb659-2" data-line-number="2"><span class="st">  </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb659-3" data-line-number="3">  con,</a>
<a class="sourceLine" id="cb659-4" data-line-number="4">  <span class="st">&quot;</span></a>
<a class="sourceLine" id="cb659-5" data-line-number="5"><span class="st">  select * from store where manager_staff_id = 1 or store_id &lt; 3; </span></a>
<a class="sourceLine" id="cb659-6" data-line-number="6"><span class="st">  &quot;</span>)</a>
<a class="sourceLine" id="cb659-7" data-line-number="7"><span class="kw">kable</span>(rs,<span class="dt">caption =</span> <span class="st">&#39;WHERE OR condition&#39;</span>)  </a></code></pre></div>
<table>
<caption>(#tab:unnamed-chunk-17)WHERE OR condition</caption>
<thead>
<tr class="header">
<th align="right">store_id</th>
<th align="right">manager_staff_id</th>
<th align="right">address_id</th>
<th align="left">last_update</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">2006-02-15 09:57:12</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">2</td>
<td align="right">2</td>
<td align="left">2006-02-15 09:57:12</td>
</tr>
</tbody>
</table>
<pre><code>The first condition manager_staff_id = 1 returns a single row and the second condition store_id &lt; 3 returns two rows.  </code></pre>
<p>Following table is modified from <a href="http://www.tutorialspoint.com/sql/sql-operators" class="uri">http://www.tutorialspoint.com/sql/sql-operators</a></p>
<p>SQL Comparison Operators</p>
<table>
<colgroup>
<col width="10%" />
<col width="75%" />
<col width="14%" />
</colgroup>
<thead>
<tr class="header">
<th>Operator</th>
<th>Description</th>
<th>example</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>=</td>
<td>Checks if the values of two operands are equal or not, if yes then condition becomes true.</td>
<td>(a = b) is not true.</td>
</tr>
<tr class="even">
<td>!=</td>
<td>Checks if the values of two operands are equal or not, if values are not equal then condition becomes true.</td>
<td>(a != b) is true.</td>
</tr>
<tr class="odd">
<td>&lt;&gt;</td>
<td>Checks if the values of two operands are equal or not, if values are not equal then condition becomes true.</td>
<td>(a &lt;&gt; b) is true.</td>
</tr>
<tr class="even">
<td><code>&gt;</code></td>
<td>Checks if the value of left operand is greater than the value of right operand, if yes then condition becomes true.</td>
<td>(a &gt; b) is not true.</td>
</tr>
<tr class="odd">
<td>&lt;</td>
<td>Checks if the value of left operand is less than the value of right operand, if yes then condition becomes true.</td>
<td>(a &lt; b) is true.</td>
</tr>
<tr class="even">
<td><code>&gt;=</code></td>
<td>Checks if the value of left operand is greater than or equal to the value of right operand, if yes then condition becomes true.</td>
<td>(a &gt;= b) is not true.</td>
</tr>
<tr class="odd">
<td>&lt;=</td>
<td>Checks if the value of left operand is less than or equal to the value of right operand, if yes then condition becomes true.</td>
<td>(a &lt;= b) is true.</td>
</tr>
<tr class="even">
<td>!&lt;</td>
<td>Checks if the value of left operand is not less than the value of right operand, if yes then condition becomes true.</td>
<td>(a !&lt; b) is false.</td>
</tr>
<tr class="odd">
<td>!&gt;</td>
<td>Checks if the value of left operand is not greater than the value of right operand, if yes then condition becomes true.</td>
<td>(a !&gt; b) is true.</td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="8%" />
<col width="91%" />
</colgroup>
<thead>
<tr class="header">
<th>Operator</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ALL</td>
<td>The ALL operator is used to compare a value to all values in another value set.</td>
</tr>
<tr class="even">
<td>AND</td>
<td>The AND operator allows the existence of multiple conditions in an SQL statement’s WHERE clause.</td>
</tr>
<tr class="odd">
<td>ANY</td>
<td>The ANY operator is used to compare a value to any applicable value in the list as per the condition.</td>
</tr>
<tr class="even">
<td>BETWEEN</td>
<td>The BETWEEN operator is used to search for values that are within a set of values, given the minimum value and the maximum value.</td>
</tr>
<tr class="odd">
<td>EXISTS</td>
<td>The EXISTS operator is used to search for the presence of a row in a specified table that meets a certain criterion.</td>
</tr>
<tr class="even">
<td>IN</td>
<td>The IN operator is used to compare a value to a list of literal values that have been specified.</td>
</tr>
<tr class="odd">
<td>LIKE</td>
<td>The LIKE operator is used to compare a value to similar values using wildcard operators.</td>
</tr>
<tr class="even">
<td>NOT</td>
<td>The NOT operator reverses the meaning of the logical operator with which it is used. Eg: NOT EXISTS, NOT BETWEEN, NOT IN, etc. This is a negate operator.</td>
</tr>
<tr class="odd">
<td>OR</td>
<td>The OR operator is used to combine multiple conditions in an SQL statement’s WHERE clause.</td>
</tr>
<tr class="even">
<td>IS NULL</td>
<td>The NULL operator is used to compare a value with a NULL value.</td>
</tr>
<tr class="odd">
<td>UNIQUE</td>
<td>The UNIQUE operator searches every row of a specified table for uniqueness (no duplicates).</td>
</tr>
</tbody>
</table>
<p><a href="https://pgexercises.com/questions/basic" class="uri">https://pgexercises.com/questions/basic</a></p>
<p>## TO-DO’s</p>
<ol style="list-style-type: decimal">
<li>inline tables</li>
<li>correlated subqueries</li>
</ol>
</div>
</div>
</div>
<div id="paradigm-shift-from-r-dplyr-to-sql" class="section level2">
<h2><span class="header-section-number">27.5</span> Paradigm Shift from R-Dplyr to SQL</h2>
<p>Paraphrasing what some have said with an R dplyr background and no SQL experience, “It is like working from the inside out.” This sentiment occurs because</p>
<ol style="list-style-type: decimal">
<li>The SQL SELECT statement begins at the end, the SELECT clause, and drills backwards, loosely speaking, to derive the desired result set.</li>
<li>SQL SELECT statements are an all or nothing proposition. One gets nothing if there is any kind of syntax error.<br />
</li>
<li>SQL SELECT result sets can be quite opaque. The WHERE clause can be very dense and difficult to trace through. It is rarely ever linear in nature.<br />
</li>
<li>Validating all the permutations in the where clause can be tough and tedious.</li>
</ol>
<div id="big-bang-versus-piped-incremental-steps." class="section level3">
<h3><span class="header-section-number">27.5.1</span> Big bang versus piped incremental steps.</h3>
<ol style="list-style-type: decimal">
<li>Dplyr starts with one or more sources joined together in a conceptually similar way that SQL joins sources.</li>
<li>The pipe and filter() function breaks down the filter conditions into small managable logical steps. This makes it much easier to understand what is happening in the derivation of the final tibble. Adding tees through out the pipe line gives one full trace back of all the data transformations at every pipe.</li>
</ol>
<p>Helpful tidyverse functions that output tibbles: tbl_module function in <a href="https://github.com/nhemerson/tibbleColumns" class="uri">https://github.com/nhemerson/tibbleColumns</a> package;</p>
<p>Mental picture: SQL approach: Imagine a data lake named Niagera Falls and drinking from it without drowning. R-Dplyr approach: Imagine a resturant at the bottom of the Niagera Falls data lake and having a refreshing dring out of the water faucet.</p>
</div>
<div id="sql-execution-order" class="section level3">
<h3><span class="header-section-number">27.5.2</span> SQL Execution Order</h3>
<p>The table below is derived from this site. <a href="https://www.periscopedata.com/blog/sql-query-order-of-operations" class="uri">https://www.periscopedata.com/blog/sql-query-order-of-operations</a> It shows what goes on under the hood SQL SELECT hood.</p>
<table>
<colgroup>
<col width="3%" />
<col width="19%" />
<col width="47%" />
<col width="29%" />
</colgroup>
<thead>
<tr class="header">
<th>SEQ</th>
<th>SQL</th>
<th>Function</th>
<th>Dplyr</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>WITH</td>
<td>Common Table expression, CTE, one or more datasets/tables used FROM clause.</td>
<td>.data parameter in dplyr functions</td>
</tr>
<tr class="even">
<td>2</td>
<td>FROM</td>
<td>Choose and join tables to get base data</td>
<td>.data parameter in dplyr functions</td>
</tr>
<tr class="odd">
<td>3</td>
<td>ON</td>
<td>Choose and join tables to get base data</td>
<td>dplyr join family of functions</td>
</tr>
<tr class="even">
<td>4</td>
<td>JOIN</td>
<td>Choose and join tables to get base data</td>
<td>dplyr join family of functions</td>
</tr>
<tr class="odd">
<td>5</td>
<td>WHERE</td>
<td>filters the base data</td>
<td>dplyr filter()</td>
</tr>
<tr class="even">
<td>6</td>
<td>GROUP BY</td>
<td>aggregates the base data</td>
<td>dplyr group_by family of functions</td>
</tr>
<tr class="odd">
<td>7</td>
<td>WITH CUBE/ROLLUP</td>
<td>aggregates the base data</td>
<td>is this part of the dplyr grammar</td>
</tr>
<tr class="even">
<td>8</td>
<td>HAVING</td>
<td>filters aggregated data</td>
<td>dplyr filter()</td>
</tr>
<tr class="odd">
<td>9</td>
<td>SELECT</td>
<td>Returns final data set</td>
<td>dplyr select()</td>
</tr>
<tr class="even">
<td>10</td>
<td>DISTINCT</td>
<td>Dedupe the final data set</td>
<td>dplyr distinct()</td>
</tr>
<tr class="odd">
<td>11</td>
<td>ORDER BY</td>
<td>Sorts the final data set</td>
<td>arrange()</td>
</tr>
<tr class="even">
<td>12</td>
<td>TOP/LIMIT</td>
<td>Limits the number of rows in data set</td>
<td></td>
</tr>
<tr class="odd">
<td>13</td>
<td>OFFSET/FETCH</td>
<td>Limits the number of rows in data set</td>
<td></td>
</tr>
</tbody>
</table>
<p>The SEQ column shows the standard order of SQL execution. One take away for this tutorial is that the SELECT clause actually executes late in the process, even though it is the first clause in the entire SELECT statement. A second take away is that SQL execution order, or tweaked order, plays a critical role in SQL query tuning.</p>
<ol start="6" style="list-style-type: decimal">
<li>SQL for View table dependencies.</li>
<li>Add cartesian join exercise.</li>
</ol>
<!--chapter:end:170-sql-quick-start-simple-retrieval.Rmd-->
</div>
</div>
</div>
<div id="chapter_postgresql-metadata" class="section level1">
<h1><span class="header-section-number">28</span> Getting metadata about and from PostgreSQL</h1>
<blockquote>
<p>This chapter demonstrates:</p>
<ul>
<li>What kind of data about the database is contained in a dbms</li>
<li>Several methods for obtaining metadata from the dbms</li>
</ul>
</blockquote>
<p>The following packages are used in this chapter:</p>
<div class="sourceCode" id="cb661"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb661-1" data-line-number="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb661-2" data-line-number="2"><span class="kw">library</span>(DBI)</a>
<a class="sourceLine" id="cb661-3" data-line-number="3"><span class="kw">library</span>(RPostgres)</a>
<a class="sourceLine" id="cb661-4" data-line-number="4"><span class="kw">library</span>(glue)</a>
<a class="sourceLine" id="cb661-5" data-line-number="5"><span class="kw">library</span>(here)</a>
<a class="sourceLine" id="cb661-6" data-line-number="6"><span class="kw">require</span>(knitr)</a>
<a class="sourceLine" id="cb661-7" data-line-number="7"><span class="kw">library</span>(dbplyr)</a>
<a class="sourceLine" id="cb661-8" data-line-number="8"><span class="kw">library</span>(sqlpetr)</a></code></pre></div>
<p>Assume that the Docker container with PostgreSQL and the dvdrental database are ready to go.</p>
<div class="sourceCode" id="cb662"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb662-1" data-line-number="1"><span class="kw">sp_docker_start</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<p>Connect to the database:</p>
<div class="sourceCode" id="cb663"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb663-1" data-line-number="1">con &lt;-<span class="st"> </span><span class="kw">sp_get_postgres_connection</span>(</a>
<a class="sourceLine" id="cb663-2" data-line-number="2">  <span class="dt">user =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_USER_NAME&quot;</span>),</a>
<a class="sourceLine" id="cb663-3" data-line-number="3">  <span class="dt">password =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_PASSWORD&quot;</span>),</a>
<a class="sourceLine" id="cb663-4" data-line-number="4">  <span class="dt">dbname =</span> <span class="st">&quot;dvdrental&quot;</span>,</a>
<a class="sourceLine" id="cb663-5" data-line-number="5">  <span class="dt">seconds_to_test =</span> <span class="dv">30</span></a>
<a class="sourceLine" id="cb663-6" data-line-number="6">)</a></code></pre></div>
<div id="database-contents-and-structure" class="section level2">
<h2><span class="header-section-number">28.1</span> Database contents and structure</h2>
<p>After just looking at the data you seek, it might be worthwhile stepping back and looking at the big picture.</p>
<div id="database-structure" class="section level3">
<h3><span class="header-section-number">28.1.1</span> Database structure</h3>
<p>For large or complex databases you need to use both the available documentation for your database (e.g., <a href="http://www.postgresqltutorial.com/postgresql-sample-database/">the dvdrental</a> database) and the other empirical tools that are available. For example it’s worth learning to interpret the symbols in an <a href="https://en.wikipedia.org/wiki/Entity%E2%80%93relationship_model">Entity Relationship Diagram</a>:</p>
<p><img src="screenshots/ER-diagram-symbols.png" /></p>
<p>The <code>information_schema</code> is a trove of information <em>about</em> the database. Its format is more or less consistent across the different SQL implementations that are available. Here we explore some of what’s available using several different methods. PostgreSQL stores <a href="https://www.postgresql.org/docs/current/static/infoschema-columns.html">a lot of metadata</a>.</p>
</div>
<div id="contents-of-the-information_schema" class="section level3">
<h3><span class="header-section-number">28.1.2</span> Contents of the <code>information_schema</code></h3>
<p>For this chapter R needs the <code>dbplyr</code> package to access alternate schemas. A <a href="http://www.postgresqltutorial.com/postgresql-server-and-database-objects/">schema</a> is an object that contains one or more tables. Most often there will be a default schema, but to access the metadata, you need to explicitly specify which schema contains the data you want.</p>
</div>
<div id="what-tables-are-in-the-database" class="section level3">
<h3><span class="header-section-number">28.1.3</span> What tables are in the database?</h3>
<p>The simplest way to get a list of tables is with</p>
<div class="sourceCode" id="cb664"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb664-1" data-line-number="1">table_list &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbListTables</span>(con)</a>
<a class="sourceLine" id="cb664-2" data-line-number="2"></a>
<a class="sourceLine" id="cb664-3" data-line-number="3"><span class="kw">kable</span>(table_list)</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">x</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">actor_info</td>
</tr>
<tr class="even">
<td align="left">customer_list</td>
</tr>
<tr class="odd">
<td align="left">film_list</td>
</tr>
<tr class="even">
<td align="left">nicer_but_slower_film_list</td>
</tr>
<tr class="odd">
<td align="left">sales_by_film_category</td>
</tr>
<tr class="even">
<td align="left">staff</td>
</tr>
<tr class="odd">
<td align="left">sales_by_store</td>
</tr>
<tr class="even">
<td align="left">staff_list</td>
</tr>
<tr class="odd">
<td align="left">category</td>
</tr>
<tr class="even">
<td align="left">film_category</td>
</tr>
<tr class="odd">
<td align="left">country</td>
</tr>
<tr class="even">
<td align="left">actor</td>
</tr>
<tr class="odd">
<td align="left">language</td>
</tr>
<tr class="even">
<td align="left">inventory</td>
</tr>
<tr class="odd">
<td align="left">payment</td>
</tr>
<tr class="even">
<td align="left">rental</td>
</tr>
<tr class="odd">
<td align="left">city</td>
</tr>
<tr class="even">
<td align="left">store</td>
</tr>
<tr class="odd">
<td align="left">film</td>
</tr>
<tr class="even">
<td align="left">address</td>
</tr>
<tr class="odd">
<td align="left">film_actor</td>
</tr>
<tr class="even">
<td align="left">customer</td>
</tr>
<tr class="odd">
<td align="left">smy_customer</td>
</tr>
</tbody>
</table>
</div>
<div id="digging-into-the-information_schema" class="section level3">
<h3><span class="header-section-number">28.1.4</span> Digging into the <code>information_schema</code></h3>
<p>We usually need more detail than just a list of tables. Most SQL databases have an <code>information_schema</code> that has a standard structure to describe and control the database.</p>
<p>The <code>information_schema</code> is in a different schema from the default, so to connect to the <code>tables</code> table in the <code>information_schema</code> we connect to the database in a different way:</p>
<div class="sourceCode" id="cb665"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb665-1" data-line-number="1">table_info_schema_table &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, dbplyr<span class="op">::</span><span class="kw">in_schema</span>(<span class="st">&quot;information_schema&quot;</span>, <span class="st">&quot;tables&quot;</span>))</a></code></pre></div>
<p>The <code>information_schema</code> is large and complex and contains 211 tables. So it’s easy to get lost in it.</p>
<p>This query retrieves a list of the tables in the database that includes additional detail, not just the name of the table.</p>
<div class="sourceCode" id="cb666"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb666-1" data-line-number="1">table_info &lt;-<span class="st"> </span>table_info_schema_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb666-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(table_schema <span class="op">==</span><span class="st"> &quot;public&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb666-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(table_catalog, table_schema, table_name, table_type) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb666-4" data-line-number="4"><span class="st">  </span><span class="kw">arrange</span>(table_type, table_name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb666-5" data-line-number="5"><span class="st">  </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb666-6" data-line-number="6"></a>
<a class="sourceLine" id="cb666-7" data-line-number="7"><span class="kw">kable</span>(table_info)</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">table_catalog</th>
<th align="left">table_schema</th>
<th align="left">table_name</th>
<th align="left">table_type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">actor</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">address</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">category</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">city</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">country</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">customer</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">film</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">film_actor</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">film_category</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">inventory</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">language</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">payment</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">rental</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">smy_customer</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">staff</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">store</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">actor_info</td>
<td align="left">VIEW</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">customer_list</td>
<td align="left">VIEW</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">film_list</td>
<td align="left">VIEW</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">nicer_but_slower_film_list</td>
<td align="left">VIEW</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">sales_by_film_category</td>
<td align="left">VIEW</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">sales_by_store</td>
<td align="left">VIEW</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">staff_list</td>
<td align="left">VIEW</td>
</tr>
<tr class="even">
<td align="left">In this context</td>
<td align="left"><code>table_catalog</code></td>
<td align="left">is synonymous with `database</td>
<td align="left">`.</td>
</tr>
</tbody>
</table>
<p>Notice that <em>VIEWS</em> are composites made up of one or more <em>BASE TABLES</em>.</p>
<p>The SQL world has its own terminology. For example <code>rs</code> is shorthand for <code>result set</code>. That’s equivalent to using <code>df</code> for a <code>data frame</code>. The following SQL query returns the same information as the previous one.</p>
<div class="sourceCode" id="cb667"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb667-1" data-line-number="1">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb667-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb667-3" data-line-number="3">  <span class="st">&quot;select table_catalog, table_schema, table_name, table_type </span></a>
<a class="sourceLine" id="cb667-4" data-line-number="4"><span class="st">  from information_schema.tables </span></a>
<a class="sourceLine" id="cb667-5" data-line-number="5"><span class="st">  where table_schema not in (&#39;pg_catalog&#39;,&#39;information_schema&#39;)</span></a>
<a class="sourceLine" id="cb667-6" data-line-number="6"><span class="st">  order by table_type, table_name </span></a>
<a class="sourceLine" id="cb667-7" data-line-number="7"><span class="st">  ;&quot;</span></a>
<a class="sourceLine" id="cb667-8" data-line-number="8">)</a>
<a class="sourceLine" id="cb667-9" data-line-number="9"><span class="kw">kable</span>(rs)</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">table_catalog</th>
<th align="left">table_schema</th>
<th align="left">table_name</th>
<th align="left">table_type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">actor</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">address</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">category</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">city</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">country</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">customer</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">film</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">film_actor</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">film_category</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">inventory</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">language</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">payment</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">rental</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">smy_customer</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">staff</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">store</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">actor_info</td>
<td align="left">VIEW</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">customer_list</td>
<td align="left">VIEW</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">film_list</td>
<td align="left">VIEW</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">nicer_but_slower_film_list</td>
<td align="left">VIEW</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">sales_by_film_category</td>
<td align="left">VIEW</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">sales_by_store</td>
<td align="left">VIEW</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">staff_list</td>
<td align="left">VIEW</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="what-columns-do-those-tables-contain" class="section level2">
<h2><span class="header-section-number">28.2</span> What columns do those tables contain?</h2>
<p>Of course, the <code>DBI</code> package has a <code>dbListFields</code> function that provides the simplest way to get the minimum, a list of column names:</p>
<div class="sourceCode" id="cb668"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb668-1" data-line-number="1">DBI<span class="op">::</span><span class="kw">dbListFields</span>(con, <span class="st">&quot;rental&quot;</span>)</a></code></pre></div>
<pre><code>## [1] &quot;rental_id&quot;    &quot;rental_date&quot;  &quot;inventory_id&quot; &quot;customer_id&quot; 
## [5] &quot;return_date&quot;  &quot;staff_id&quot;     &quot;last_update&quot;</code></pre>
<p>But the <code>information_schema</code> has a lot more useful information that we can use.</p>
<div class="sourceCode" id="cb670"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb670-1" data-line-number="1">columns_info_schema_table &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, dbplyr<span class="op">::</span><span class="kw">in_schema</span>(<span class="st">&quot;information_schema&quot;</span>, <span class="st">&quot;columns&quot;</span>))</a></code></pre></div>
<p>Since the <code>information_schema</code> contains 1865 columns, we are narrowing our focus to just one table. This query retrieves more information about the <code>rental</code> table:</p>
<div class="sourceCode" id="cb671"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb671-1" data-line-number="1">columns_info_schema_info &lt;-<span class="st"> </span>columns_info_schema_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb671-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(table_schema <span class="op">==</span><span class="st"> &quot;public&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb671-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(</a>
<a class="sourceLine" id="cb671-4" data-line-number="4">    table_catalog, table_schema, table_name, column_name, data_type, ordinal_position,</a>
<a class="sourceLine" id="cb671-5" data-line-number="5">    character_maximum_length, column_default, numeric_precision, numeric_precision_radix</a>
<a class="sourceLine" id="cb671-6" data-line-number="6">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb671-7" data-line-number="7"><span class="st">  </span><span class="kw">collect</span>(<span class="dt">n =</span> <span class="ot">Inf</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb671-8" data-line-number="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data_type =</span> <span class="kw">case_when</span>(</a>
<a class="sourceLine" id="cb671-9" data-line-number="9">    data_type <span class="op">==</span><span class="st"> &quot;character varying&quot;</span> <span class="op">~</span><span class="st"> </span><span class="kw">paste0</span>(data_type, <span class="st">&quot; (&quot;</span>, character_maximum_length, <span class="st">&quot;)&quot;</span>),</a>
<a class="sourceLine" id="cb671-10" data-line-number="10">    data_type <span class="op">==</span><span class="st"> &quot;real&quot;</span> <span class="op">~</span><span class="st"> </span><span class="kw">paste0</span>(data_type, <span class="st">&quot; (&quot;</span>, numeric_precision, <span class="st">&quot;,&quot;</span>, numeric_precision_radix, <span class="st">&quot;)&quot;</span>),</a>
<a class="sourceLine" id="cb671-11" data-line-number="11">    <span class="ot">TRUE</span> <span class="op">~</span><span class="st"> </span>data_type</a>
<a class="sourceLine" id="cb671-12" data-line-number="12">  )) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb671-13" data-line-number="13"><span class="st">  </span><span class="kw">filter</span>(table_name <span class="op">==</span><span class="st"> &quot;rental&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb671-14" data-line-number="14"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>table_schema, <span class="op">-</span>numeric_precision, <span class="op">-</span>numeric_precision_radix)</a>
<a class="sourceLine" id="cb671-15" data-line-number="15"></a>
<a class="sourceLine" id="cb671-16" data-line-number="16"><span class="kw">glimpse</span>(columns_info_schema_info)</a></code></pre></div>
<pre><code>## Observations: 7
## Variables: 7
## $ table_catalog            &lt;chr&gt; &quot;dvdrental&quot;, &quot;dvdrental&quot;, &quot;dvdrental&quot;, …
## $ table_name               &lt;chr&gt; &quot;rental&quot;, &quot;rental&quot;, &quot;rental&quot;, &quot;rental&quot;,…
## $ column_name              &lt;chr&gt; &quot;rental_id&quot;, &quot;rental_date&quot;, &quot;inventory_…
## $ data_type                &lt;chr&gt; &quot;integer&quot;, &quot;timestamp without time zone…
## $ ordinal_position         &lt;int&gt; 1, 2, 3, 4, 5, 6, 7
## $ character_maximum_length &lt;int&gt; NA, NA, NA, NA, NA, NA, NA
## $ column_default           &lt;chr&gt; &quot;nextval(&#39;rental_rental_id_seq&#39;::regcla…</code></pre>
<div class="sourceCode" id="cb673"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb673-1" data-line-number="1"><span class="kw">kable</span>(columns_info_schema_info)</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">table_catalog</th>
<th align="left">table_name</th>
<th align="left">column_name</th>
<th align="left">data_type</th>
<th align="right">ordinal_position</th>
<th align="right">character_maximum_length</th>
<th align="left">column_default</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">rental</td>
<td align="left">rental_id</td>
<td align="left">integer</td>
<td align="right">1</td>
<td align="right">NA</td>
<td align="left">nextval(‘rental_rental_id_seq’::regclass)</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">rental</td>
<td align="left">rental_date</td>
<td align="left">timestamp without time zone</td>
<td align="right">2</td>
<td align="right">NA</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">rental</td>
<td align="left">inventory_id</td>
<td align="left">integer</td>
<td align="right">3</td>
<td align="right">NA</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">rental</td>
<td align="left">customer_id</td>
<td align="left">smallint</td>
<td align="right">4</td>
<td align="right">NA</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">rental</td>
<td align="left">return_date</td>
<td align="left">timestamp without time zone</td>
<td align="right">5</td>
<td align="right">NA</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">rental</td>
<td align="left">staff_id</td>
<td align="left">smallint</td>
<td align="right">6</td>
<td align="right">NA</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">rental</td>
<td align="left">last_update</td>
<td align="left">timestamp without time zone</td>
<td align="right">7</td>
<td align="right">NA</td>
<td align="left">now()</td>
</tr>
</tbody>
</table>
<div id="what-is-the-difference-between-a-view-and-a-base-table" class="section level3">
<h3><span class="header-section-number">28.2.1</span> What is the difference between a <code>VIEW</code> and a <code>BASE TABLE</code>?</h3>
<p>The <code>BASE TABLE</code> has the underlying data in the database</p>
<div class="sourceCode" id="cb674"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb674-1" data-line-number="1">table_info_schema_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb674-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(table_schema <span class="op">==</span><span class="st"> &quot;public&quot;</span> <span class="op">&amp;</span><span class="st"> </span>table_type <span class="op">==</span><span class="st"> &quot;BASE TABLE&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb674-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(table_name, table_type) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb674-4" data-line-number="4"><span class="st">  </span><span class="kw">left_join</span>(columns_info_schema_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;table_name&quot;</span> =<span class="st"> &quot;table_name&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb674-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(</a>
<a class="sourceLine" id="cb674-6" data-line-number="6">    table_type, table_name, column_name, data_type, ordinal_position,</a>
<a class="sourceLine" id="cb674-7" data-line-number="7">    column_default</a>
<a class="sourceLine" id="cb674-8" data-line-number="8">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb674-9" data-line-number="9"><span class="st">  </span><span class="kw">collect</span>(<span class="dt">n =</span> <span class="ot">Inf</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb674-10" data-line-number="10"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">str_detect</span>(table_name, <span class="st">&quot;cust&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb674-11" data-line-number="11"><span class="st">  </span><span class="kw">kable</span>()</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">table_type</th>
<th align="left">table_name</th>
<th align="left">column_name</th>
<th align="left">data_type</th>
<th align="right">ordinal_position</th>
<th align="left">column_default</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">BASE TABLE</td>
<td align="left">customer</td>
<td align="left">store_id</td>
<td align="left">smallint</td>
<td align="right">2</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">BASE TABLE</td>
<td align="left">customer</td>
<td align="left">first_name</td>
<td align="left">character varying</td>
<td align="right">3</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">BASE TABLE</td>
<td align="left">customer</td>
<td align="left">last_name</td>
<td align="left">character varying</td>
<td align="right">4</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">BASE TABLE</td>
<td align="left">customer</td>
<td align="left">email</td>
<td align="left">character varying</td>
<td align="right">5</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">BASE TABLE</td>
<td align="left">customer</td>
<td align="left">address_id</td>
<td align="left">smallint</td>
<td align="right">6</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">BASE TABLE</td>
<td align="left">customer</td>
<td align="left">active</td>
<td align="left">integer</td>
<td align="right">10</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">BASE TABLE</td>
<td align="left">customer</td>
<td align="left">customer_id</td>
<td align="left">integer</td>
<td align="right">1</td>
<td align="left">nextval(‘customer_customer_id_seq’::regclass)</td>
</tr>
<tr class="even">
<td align="left">BASE TABLE</td>
<td align="left">customer</td>
<td align="left">activebool</td>
<td align="left">boolean</td>
<td align="right">7</td>
<td align="left">true</td>
</tr>
<tr class="odd">
<td align="left">BASE TABLE</td>
<td align="left">customer</td>
<td align="left">create_date</td>
<td align="left">date</td>
<td align="right">8</td>
<td align="left">(‘now’::text)::date</td>
</tr>
<tr class="even">
<td align="left">BASE TABLE</td>
<td align="left">customer</td>
<td align="left">last_update</td>
<td align="left">timestamp without time zone</td>
<td align="right">9</td>
<td align="left">now()</td>
</tr>
<tr class="odd">
<td align="left">BASE TABLE</td>
<td align="left">smy_customer</td>
<td align="left">customer_id</td>
<td align="left">integer</td>
<td align="right">1</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">BASE TABLE</td>
<td align="left">smy_customer</td>
<td align="left">store_id</td>
<td align="left">smallint</td>
<td align="right">2</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">BASE TABLE</td>
<td align="left">smy_customer</td>
<td align="left">first_name</td>
<td align="left">character varying</td>
<td align="right">3</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">BASE TABLE</td>
<td align="left">smy_customer</td>
<td align="left">last_name</td>
<td align="left">character varying</td>
<td align="right">4</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">BASE TABLE</td>
<td align="left">smy_customer</td>
<td align="left">email</td>
<td align="left">character varying</td>
<td align="right">5</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">BASE TABLE</td>
<td align="left">smy_customer</td>
<td align="left">address_id</td>
<td align="left">smallint</td>
<td align="right">6</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">BASE TABLE</td>
<td align="left">smy_customer</td>
<td align="left">activebool</td>
<td align="left">boolean</td>
<td align="right">7</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">BASE TABLE</td>
<td align="left">smy_customer</td>
<td align="left">create_date</td>
<td align="left">date</td>
<td align="right">8</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">BASE TABLE</td>
<td align="left">smy_customer</td>
<td align="left">last_update</td>
<td align="left">timestamp without time zone</td>
<td align="right">9</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">BASE TABLE</td>
<td align="left">smy_customer</td>
<td align="left">active</td>
<td align="left">integer</td>
<td align="right">10</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
<p>Probably should explore how the <code>VIEW</code> is made up of data from BASE TABLEs.</p>
<div class="sourceCode" id="cb675"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb675-1" data-line-number="1">table_info_schema_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb675-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(table_schema <span class="op">==</span><span class="st"> &quot;public&quot;</span> <span class="op">&amp;</span><span class="st"> </span>table_type <span class="op">==</span><span class="st"> &quot;VIEW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb675-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(table_name, table_type) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb675-4" data-line-number="4"><span class="st">  </span><span class="kw">left_join</span>(columns_info_schema_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;table_name&quot;</span> =<span class="st"> &quot;table_name&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb675-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(</a>
<a class="sourceLine" id="cb675-6" data-line-number="6">    table_type, table_name, column_name, data_type, ordinal_position,</a>
<a class="sourceLine" id="cb675-7" data-line-number="7">    column_default</a>
<a class="sourceLine" id="cb675-8" data-line-number="8">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb675-9" data-line-number="9"><span class="st">  </span><span class="kw">collect</span>(<span class="dt">n =</span> <span class="ot">Inf</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb675-10" data-line-number="10"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">str_detect</span>(table_name, <span class="st">&quot;cust&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb675-11" data-line-number="11"><span class="st">  </span><span class="kw">kable</span>()</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">table_type</th>
<th align="left">table_name</th>
<th align="left">column_name</th>
<th align="left">data_type</th>
<th align="right">ordinal_position</th>
<th align="left">column_default</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">VIEW</td>
<td align="left">customer_list</td>
<td align="left">id</td>
<td align="left">integer</td>
<td align="right">1</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">VIEW</td>
<td align="left">customer_list</td>
<td align="left">name</td>
<td align="left">text</td>
<td align="right">2</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">VIEW</td>
<td align="left">customer_list</td>
<td align="left">address</td>
<td align="left">character varying</td>
<td align="right">3</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">VIEW</td>
<td align="left">customer_list</td>
<td align="left">zip code</td>
<td align="left">character varying</td>
<td align="right">4</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">VIEW</td>
<td align="left">customer_list</td>
<td align="left">phone</td>
<td align="left">character varying</td>
<td align="right">5</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">VIEW</td>
<td align="left">customer_list</td>
<td align="left">city</td>
<td align="left">character varying</td>
<td align="right">6</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">VIEW</td>
<td align="left">customer_list</td>
<td align="left">country</td>
<td align="left">character varying</td>
<td align="right">7</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">VIEW</td>
<td align="left">customer_list</td>
<td align="left">notes</td>
<td align="left">text</td>
<td align="right">8</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">VIEW</td>
<td align="left">customer_list</td>
<td align="left">sid</td>
<td align="left">smallint</td>
<td align="right">9</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
</div>
<div id="what-data-types-are-found-in-the-database" class="section level3">
<h3><span class="header-section-number">28.2.2</span> What data types are found in the database?</h3>
<div class="sourceCode" id="cb676"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb676-1" data-line-number="1">columns_info_schema_info <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">count</span>(data_type)</a></code></pre></div>
<pre><code>## # A tibble: 3 x 2
##   data_type                       n
##   &lt;chr&gt;                       &lt;int&gt;
## 1 integer                         2
## 2 smallint                        2
## 3 timestamp without time zone     3</code></pre>
</div>
</div>
<div id="characterizing-how-things-are-named" class="section level2">
<h2><span class="header-section-number">28.3</span> Characterizing how things are named</h2>
<p>Names are the handle for accessing the data. Tables and columns may or may not be named consistently or in a way that makes sense to you. You should look at these names <em>as data</em>.</p>
<div id="counting-columns-and-name-reuse" class="section level3">
<h3><span class="header-section-number">28.3.1</span> Counting columns and name reuse</h3>
<p>Pull out some rough-and-ready but useful statistics about your database. Since we are in SQL-land we talk about variables as <code>columns</code>.</p>
<div class="sourceCode" id="cb678"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb678-1" data-line-number="1">public_tables &lt;-<span class="st"> </span>columns_info_schema_table <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb678-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(table_schema <span class="op">==</span><span class="st"> &quot;public&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb678-3" data-line-number="3"><span class="st">  </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb678-4" data-line-number="4"></a>
<a class="sourceLine" id="cb678-5" data-line-number="5">public_tables <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb678-6" data-line-number="6"><span class="st">  </span><span class="kw">count</span>(table_name, <span class="dt">sort =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dt">n =</span> <span class="dv">15</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb678-7" data-line-number="7"><span class="st">  </span><span class="kw">kable</span>()</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">table_name</th>
<th align="right">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">film</td>
<td align="right">13</td>
</tr>
<tr class="even">
<td align="left">staff</td>
<td align="right">11</td>
</tr>
<tr class="odd">
<td align="left">customer</td>
<td align="right">10</td>
</tr>
<tr class="even">
<td align="left">smy_customer</td>
<td align="right">10</td>
</tr>
<tr class="odd">
<td align="left">customer_list</td>
<td align="right">9</td>
</tr>
<tr class="even">
<td align="left">address</td>
<td align="right">8</td>
</tr>
<tr class="odd">
<td align="left">film_list</td>
<td align="right">8</td>
</tr>
<tr class="even">
<td align="left">nicer_but_slower_film_list</td>
<td align="right">8</td>
</tr>
<tr class="odd">
<td align="left">staff_list</td>
<td align="right">8</td>
</tr>
<tr class="even">
<td align="left">rental</td>
<td align="right">7</td>
</tr>
<tr class="odd">
<td align="left">payment</td>
<td align="right">6</td>
</tr>
<tr class="even">
<td align="left">actor</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="left">actor_info</td>
<td align="right">4</td>
</tr>
<tr class="even">
<td align="left">city</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="left">inventory</td>
<td align="right">4</td>
</tr>
</tbody>
</table>
<p>How many <em>column names</em> are shared across tables (or duplicated)?</p>
<div class="sourceCode" id="cb679"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb679-1" data-line-number="1">public_tables <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">count</span>(column_name, <span class="dt">sort =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(n <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>)</a></code></pre></div>
<pre><code>## # A tibble: 36 x 2
##    column_name     n
##    &lt;chr&gt;       &lt;int&gt;
##  1 last_update    15
##  2 address_id      5
##  3 first_name      5
##  4 last_name       5
##  5 store_id        5
##  6 customer_id     4
##  7 film_id         4
##  8 name            4
##  9 active          3
## 10 actor_id        3
## # … with 26 more rows</code></pre>
<p>How many column names are unique?</p>
<div class="sourceCode" id="cb681"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb681-1" data-line-number="1">public_tables <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">count</span>(column_name) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(n <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">count</span>()</a></code></pre></div>
<pre><code>## # A tibble: 1 x 1
##       n
##   &lt;int&gt;
## 1    22</code></pre>
</div>
</div>
<div id="database-keys" class="section level2">
<h2><span class="header-section-number">28.4</span> Database keys</h2>
<div id="direct-sql" class="section level3">
<h3><span class="header-section-number">28.4.1</span> Direct SQL</h3>
<p>How do we use this output? Could it be generated by dplyr?</p>
<div class="sourceCode" id="cb683"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb683-1" data-line-number="1">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb683-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb683-3" data-line-number="3">  <span class="st">&quot;</span></a>
<a class="sourceLine" id="cb683-4" data-line-number="4"><span class="st">--SELECT conrelid::regclass as table_from</span></a>
<a class="sourceLine" id="cb683-5" data-line-number="5"><span class="st">select table_catalog||&#39;.&#39;||table_schema||&#39;.&#39;||table_name table_name</span></a>
<a class="sourceLine" id="cb683-6" data-line-number="6"><span class="st">, conname, pg_catalog.pg_get_constraintdef(r.oid, true) as condef</span></a>
<a class="sourceLine" id="cb683-7" data-line-number="7"><span class="st">FROM information_schema.columns c,pg_catalog.pg_constraint r</span></a>
<a class="sourceLine" id="cb683-8" data-line-number="8"><span class="st">WHERE 1 = 1 --r.conrelid = &#39;16485&#39; </span></a>
<a class="sourceLine" id="cb683-9" data-line-number="9"><span class="st">  AND r.contype  in (&#39;f&#39;,&#39;p&#39;) ORDER BY 1</span></a>
<a class="sourceLine" id="cb683-10" data-line-number="10"><span class="st">;&quot;</span></a>
<a class="sourceLine" id="cb683-11" data-line-number="11">)</a>
<a class="sourceLine" id="cb683-12" data-line-number="12"><span class="kw">glimpse</span>(rs)</a></code></pre></div>
<pre><code>## Observations: 61,545
## Variables: 3
## $ table_name &lt;chr&gt; &quot;dvdrental.information_schema.administrable_role_auth…
## $ conname    &lt;chr&gt; &quot;actor_pkey&quot;, &quot;actor_pkey&quot;, &quot;actor_pkey&quot;, &quot;country_pk…
## $ condef     &lt;chr&gt; &quot;PRIMARY KEY (actor_id)&quot;, &quot;PRIMARY KEY (actor_id)&quot;, &quot;…</code></pre>
<div class="sourceCode" id="cb685"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb685-1" data-line-number="1"><span class="kw">kable</span>(<span class="kw">head</span>(rs))</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">table_name</th>
<th align="left">conname</th>
<th align="left">condef</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">dvdrental.information_schema.administrable_role_authorizations</td>
<td align="left">actor_pkey</td>
<td align="left">PRIMARY KEY (actor_id)</td>
</tr>
<tr class="even">
<td align="left">dvdrental.information_schema.administrable_role_authorizations</td>
<td align="left">actor_pkey</td>
<td align="left">PRIMARY KEY (actor_id)</td>
</tr>
<tr class="odd">
<td align="left">dvdrental.information_schema.administrable_role_authorizations</td>
<td align="left">actor_pkey</td>
<td align="left">PRIMARY KEY (actor_id)</td>
</tr>
<tr class="even">
<td align="left">dvdrental.information_schema.administrable_role_authorizations</td>
<td align="left">country_pkey</td>
<td align="left">PRIMARY KEY (country_id)</td>
</tr>
<tr class="odd">
<td align="left">dvdrental.information_schema.administrable_role_authorizations</td>
<td align="left">country_pkey</td>
<td align="left">PRIMARY KEY (country_id)</td>
</tr>
<tr class="even">
<td align="left">dvdrental.information_schema.administrable_role_authorizations</td>
<td align="left">country_pkey</td>
<td align="left">PRIMARY KEY (country_id)</td>
</tr>
<tr class="odd">
<td align="left">The following is more compact and looks more useful. What is the</td>
<td align="left">difference bet</td>
<td align="left">ween the two?</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb686"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb686-1" data-line-number="1">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb686-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb686-3" data-line-number="3">  <span class="st">&quot;select conrelid::regclass as table_from</span></a>
<a class="sourceLine" id="cb686-4" data-line-number="4"><span class="st">      ,c.conname</span></a>
<a class="sourceLine" id="cb686-5" data-line-number="5"><span class="st">      ,pg_get_constraintdef(c.oid)</span></a>
<a class="sourceLine" id="cb686-6" data-line-number="6"><span class="st">  from pg_constraint c</span></a>
<a class="sourceLine" id="cb686-7" data-line-number="7"><span class="st">  join pg_namespace n on n.oid = c.connamespace</span></a>
<a class="sourceLine" id="cb686-8" data-line-number="8"><span class="st"> where c.contype in (&#39;f&#39;,&#39;p&#39;)</span></a>
<a class="sourceLine" id="cb686-9" data-line-number="9"><span class="st">   and n.nspname = &#39;public&#39;</span></a>
<a class="sourceLine" id="cb686-10" data-line-number="10"><span class="st">order by conrelid::regclass::text, contype DESC;</span></a>
<a class="sourceLine" id="cb686-11" data-line-number="11"><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb686-12" data-line-number="12">)</a>
<a class="sourceLine" id="cb686-13" data-line-number="13"><span class="kw">glimpse</span>(rs)</a></code></pre></div>
<pre><code>## Observations: 33
## Variables: 3
## $ table_from           &lt;chr&gt; &quot;actor&quot;, &quot;address&quot;, &quot;address&quot;, &quot;category&quot;, …
## $ conname              &lt;chr&gt; &quot;actor_pkey&quot;, &quot;address_pkey&quot;, &quot;fk_address_c…
## $ pg_get_constraintdef &lt;chr&gt; &quot;PRIMARY KEY (actor_id)&quot;, &quot;PRIMARY KEY (add…</code></pre>
<div class="sourceCode" id="cb688"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb688-1" data-line-number="1"><span class="kw">kable</span>(<span class="kw">head</span>(rs))</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">table_from</th>
<th align="left">conname</th>
<th align="left">pg_get_constraintdef</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">actor</td>
<td align="left">actor_pkey</td>
<td align="left">PRIMARY KEY (actor_id)</td>
</tr>
<tr class="even">
<td align="left">address</td>
<td align="left">address_pkey</td>
<td align="left">PRIMARY KEY (address_id)</td>
</tr>
<tr class="odd">
<td align="left">address</td>
<td align="left">fk_address_city</td>
<td align="left">FOREIGN KEY (city_id) REFERENCES city(city_id)</td>
</tr>
<tr class="even">
<td align="left">category</td>
<td align="left">category_pkey</td>
<td align="left">PRIMARY KEY (category_id)</td>
</tr>
<tr class="odd">
<td align="left">city</td>
<td align="left">city_pkey</td>
<td align="left">PRIMARY KEY (city_id)</td>
</tr>
<tr class="even">
<td align="left">city</td>
<td align="left">fk_city</td>
<td align="left">FOREIGN KEY (country_id) REFERENCES country(country_id)</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb689"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb689-1" data-line-number="1"><span class="kw">dim</span>(rs)[<span class="dv">1</span>]</a></code></pre></div>
<pre><code>## [1] 33</code></pre>
</div>
<div id="database-keys-with-dplyr" class="section level3">
<h3><span class="header-section-number">28.4.2</span> Database keys with dplyr</h3>
<p>This query shows the primary and foreign keys in the database.</p>
<div class="sourceCode" id="cb691"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb691-1" data-line-number="1">tables &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, dbplyr<span class="op">::</span><span class="kw">in_schema</span>(<span class="st">&quot;information_schema&quot;</span>, <span class="st">&quot;tables&quot;</span>))</a>
<a class="sourceLine" id="cb691-2" data-line-number="2">table_constraints &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, dbplyr<span class="op">::</span><span class="kw">in_schema</span>(<span class="st">&quot;information_schema&quot;</span>, <span class="st">&quot;table_constraints&quot;</span>))</a>
<a class="sourceLine" id="cb691-3" data-line-number="3">key_column_usage &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, dbplyr<span class="op">::</span><span class="kw">in_schema</span>(<span class="st">&quot;information_schema&quot;</span>, <span class="st">&quot;key_column_usage&quot;</span>))</a>
<a class="sourceLine" id="cb691-4" data-line-number="4">referential_constraints &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, dbplyr<span class="op">::</span><span class="kw">in_schema</span>(<span class="st">&quot;information_schema&quot;</span>, <span class="st">&quot;referential_constraints&quot;</span>))</a>
<a class="sourceLine" id="cb691-5" data-line-number="5">constraint_column_usage &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, dbplyr<span class="op">::</span><span class="kw">in_schema</span>(<span class="st">&quot;information_schema&quot;</span>, <span class="st">&quot;constraint_column_usage&quot;</span>))</a>
<a class="sourceLine" id="cb691-6" data-line-number="6"></a>
<a class="sourceLine" id="cb691-7" data-line-number="7">keys &lt;-<span class="st"> </span>tables <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb691-8" data-line-number="8"><span class="st">  </span><span class="kw">left_join</span>(table_constraints, <span class="dt">by =</span> <span class="kw">c</span>(</a>
<a class="sourceLine" id="cb691-9" data-line-number="9">    <span class="st">&quot;table_catalog&quot;</span> =<span class="st"> &quot;table_catalog&quot;</span>,</a>
<a class="sourceLine" id="cb691-10" data-line-number="10">    <span class="st">&quot;table_schema&quot;</span> =<span class="st"> &quot;table_schema&quot;</span>,</a>
<a class="sourceLine" id="cb691-11" data-line-number="11">    <span class="st">&quot;table_name&quot;</span> =<span class="st"> &quot;table_name&quot;</span></a>
<a class="sourceLine" id="cb691-12" data-line-number="12">  )) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb691-13" data-line-number="13"><span class="st">  </span><span class="co"># table_constraints %&gt;%</span></a>
<a class="sourceLine" id="cb691-14" data-line-number="14"><span class="st">  </span><span class="kw">filter</span>(constraint_type <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;FOREIGN KEY&quot;</span>, <span class="st">&quot;PRIMARY KEY&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb691-15" data-line-number="15"><span class="st">  </span><span class="kw">left_join</span>(key_column_usage,</a>
<a class="sourceLine" id="cb691-16" data-line-number="16">    <span class="dt">by =</span> <span class="kw">c</span>(</a>
<a class="sourceLine" id="cb691-17" data-line-number="17">      <span class="st">&quot;table_catalog&quot;</span> =<span class="st"> &quot;table_catalog&quot;</span>,</a>
<a class="sourceLine" id="cb691-18" data-line-number="18">      <span class="st">&quot;constraint_catalog&quot;</span> =<span class="st"> &quot;constraint_catalog&quot;</span>,</a>
<a class="sourceLine" id="cb691-19" data-line-number="19">      <span class="st">&quot;constraint_schema&quot;</span> =<span class="st"> &quot;constraint_schema&quot;</span>,</a>
<a class="sourceLine" id="cb691-20" data-line-number="20">      <span class="st">&quot;table_name&quot;</span> =<span class="st"> &quot;table_name&quot;</span>,</a>
<a class="sourceLine" id="cb691-21" data-line-number="21">      <span class="st">&quot;table_schema&quot;</span> =<span class="st"> &quot;table_schema&quot;</span>,</a>
<a class="sourceLine" id="cb691-22" data-line-number="22">      <span class="st">&quot;constraint_name&quot;</span> =<span class="st"> &quot;constraint_name&quot;</span></a>
<a class="sourceLine" id="cb691-23" data-line-number="23">    )</a>
<a class="sourceLine" id="cb691-24" data-line-number="24">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb691-25" data-line-number="25"><span class="st">  </span><span class="co"># left_join(constraint_column_usage) %&gt;% # does this table add anything useful?</span></a>
<a class="sourceLine" id="cb691-26" data-line-number="26"><span class="st">  </span><span class="kw">select</span>(table_name, table_type, constraint_name, constraint_type, column_name, ordinal_position) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb691-27" data-line-number="27"><span class="st">  </span><span class="kw">arrange</span>(table_name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb691-28" data-line-number="28"><span class="st">  </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb691-29" data-line-number="29"><span class="kw">glimpse</span>(keys)</a></code></pre></div>
<pre><code>## Observations: 35
## Variables: 6
## $ table_name       &lt;chr&gt; &quot;actor&quot;, &quot;address&quot;, &quot;address&quot;, &quot;category&quot;, &quot;cit…
## $ table_type       &lt;chr&gt; &quot;BASE TABLE&quot;, &quot;BASE TABLE&quot;, &quot;BASE TABLE&quot;, &quot;BASE…
## $ constraint_name  &lt;chr&gt; &quot;actor_pkey&quot;, &quot;address_pkey&quot;, &quot;fk_address_city&quot;…
## $ constraint_type  &lt;chr&gt; &quot;PRIMARY KEY&quot;, &quot;PRIMARY KEY&quot;, &quot;FOREIGN KEY&quot;, &quot;P…
## $ column_name      &lt;chr&gt; &quot;actor_id&quot;, &quot;address_id&quot;, &quot;city_id&quot;, &quot;category_…
## $ ordinal_position &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1,…</code></pre>
<div class="sourceCode" id="cb693"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb693-1" data-line-number="1"><span class="kw">kable</span>(keys)</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">table_name</th>
<th align="left">table_type</th>
<th align="left">constraint_name</th>
<th align="left">constraint_type</th>
<th align="left">column_name</th>
<th align="right">ordinal_position</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">actor</td>
<td align="left">BASE TABLE</td>
<td align="left">actor_pkey</td>
<td align="left">PRIMARY KEY</td>
<td align="left">actor_id</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">address</td>
<td align="left">BASE TABLE</td>
<td align="left">address_pkey</td>
<td align="left">PRIMARY KEY</td>
<td align="left">address_id</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">address</td>
<td align="left">BASE TABLE</td>
<td align="left">fk_address_city</td>
<td align="left">FOREIGN KEY</td>
<td align="left">city_id</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">category</td>
<td align="left">BASE TABLE</td>
<td align="left">category_pkey</td>
<td align="left">PRIMARY KEY</td>
<td align="left">category_id</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">city</td>
<td align="left">BASE TABLE</td>
<td align="left">city_pkey</td>
<td align="left">PRIMARY KEY</td>
<td align="left">city_id</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">city</td>
<td align="left">BASE TABLE</td>
<td align="left">fk_city</td>
<td align="left">FOREIGN KEY</td>
<td align="left">country_id</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">country</td>
<td align="left">BASE TABLE</td>
<td align="left">country_pkey</td>
<td align="left">PRIMARY KEY</td>
<td align="left">country_id</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">customer</td>
<td align="left">BASE TABLE</td>
<td align="left">customer_address_id_fkey</td>
<td align="left">FOREIGN KEY</td>
<td align="left">address_id</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">customer</td>
<td align="left">BASE TABLE</td>
<td align="left">customer_pkey</td>
<td align="left">PRIMARY KEY</td>
<td align="left">customer_id</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">film</td>
<td align="left">BASE TABLE</td>
<td align="left">film_language_id_fkey</td>
<td align="left">FOREIGN KEY</td>
<td align="left">language_id</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">film</td>
<td align="left">BASE TABLE</td>
<td align="left">film_pkey</td>
<td align="left">PRIMARY KEY</td>
<td align="left">film_id</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">film_actor</td>
<td align="left">BASE TABLE</td>
<td align="left">film_actor_actor_id_fkey</td>
<td align="left">FOREIGN KEY</td>
<td align="left">actor_id</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">film_actor</td>
<td align="left">BASE TABLE</td>
<td align="left">film_actor_film_id_fkey</td>
<td align="left">FOREIGN KEY</td>
<td align="left">film_id</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">film_actor</td>
<td align="left">BASE TABLE</td>
<td align="left">film_actor_pkey</td>
<td align="left">PRIMARY KEY</td>
<td align="left">actor_id</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">film_actor</td>
<td align="left">BASE TABLE</td>
<td align="left">film_actor_pkey</td>
<td align="left">PRIMARY KEY</td>
<td align="left">film_id</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="left">film_category</td>
<td align="left">BASE TABLE</td>
<td align="left">film_category_category_id_fkey</td>
<td align="left">FOREIGN KEY</td>
<td align="left">category_id</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">film_category</td>
<td align="left">BASE TABLE</td>
<td align="left">film_category_film_id_fkey</td>
<td align="left">FOREIGN KEY</td>
<td align="left">film_id</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">film_category</td>
<td align="left">BASE TABLE</td>
<td align="left">film_category_pkey</td>
<td align="left">PRIMARY KEY</td>
<td align="left">film_id</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">film_category</td>
<td align="left">BASE TABLE</td>
<td align="left">film_category_pkey</td>
<td align="left">PRIMARY KEY</td>
<td align="left">category_id</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="left">inventory</td>
<td align="left">BASE TABLE</td>
<td align="left">inventory_film_id_fkey</td>
<td align="left">FOREIGN KEY</td>
<td align="left">film_id</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">inventory</td>
<td align="left">BASE TABLE</td>
<td align="left">inventory_pkey</td>
<td align="left">PRIMARY KEY</td>
<td align="left">inventory_id</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">language</td>
<td align="left">BASE TABLE</td>
<td align="left">language_pkey</td>
<td align="left">PRIMARY KEY</td>
<td align="left">language_id</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">payment</td>
<td align="left">BASE TABLE</td>
<td align="left">payment_customer_id_fkey</td>
<td align="left">FOREIGN KEY</td>
<td align="left">customer_id</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">payment</td>
<td align="left">BASE TABLE</td>
<td align="left">payment_pkey</td>
<td align="left">PRIMARY KEY</td>
<td align="left">payment_id</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">payment</td>
<td align="left">BASE TABLE</td>
<td align="left">payment_rental_id_fkey</td>
<td align="left">FOREIGN KEY</td>
<td align="left">rental_id</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">payment</td>
<td align="left">BASE TABLE</td>
<td align="left">payment_staff_id_fkey</td>
<td align="left">FOREIGN KEY</td>
<td align="left">staff_id</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">rental</td>
<td align="left">BASE TABLE</td>
<td align="left">rental_customer_id_fkey</td>
<td align="left">FOREIGN KEY</td>
<td align="left">customer_id</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">rental</td>
<td align="left">BASE TABLE</td>
<td align="left">rental_inventory_id_fkey</td>
<td align="left">FOREIGN KEY</td>
<td align="left">inventory_id</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">rental</td>
<td align="left">BASE TABLE</td>
<td align="left">rental_pkey</td>
<td align="left">PRIMARY KEY</td>
<td align="left">rental_id</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">rental</td>
<td align="left">BASE TABLE</td>
<td align="left">rental_staff_id_key</td>
<td align="left">FOREIGN KEY</td>
<td align="left">staff_id</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">staff</td>
<td align="left">BASE TABLE</td>
<td align="left">staff_address_id_fkey</td>
<td align="left">FOREIGN KEY</td>
<td align="left">address_id</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">staff</td>
<td align="left">BASE TABLE</td>
<td align="left">staff_pkey</td>
<td align="left">PRIMARY KEY</td>
<td align="left">staff_id</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">store</td>
<td align="left">BASE TABLE</td>
<td align="left">store_address_id_fkey</td>
<td align="left">FOREIGN KEY</td>
<td align="left">address_id</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">store</td>
<td align="left">BASE TABLE</td>
<td align="left">store_manager_staff_id_fkey</td>
<td align="left">FOREIGN KEY</td>
<td align="left">manager_staff_id</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">store</td>
<td align="left">BASE TABLE</td>
<td align="left">store_pkey</td>
<td align="left">PRIMARY KEY</td>
<td align="left">store_id</td>
<td align="right">1</td>
</tr>
</tbody>
</table>
<p>What do we learn from the following query? How is it useful?</p>
<div class="sourceCode" id="cb694"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb694-1" data-line-number="1">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb694-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb694-3" data-line-number="3">  <span class="st">&quot;SELECT r.*,</span></a>
<a class="sourceLine" id="cb694-4" data-line-number="4"><span class="st">  pg_catalog.pg_get_constraintdef(r.oid, true) as condef</span></a>
<a class="sourceLine" id="cb694-5" data-line-number="5"><span class="st">  FROM pg_catalog.pg_constraint r</span></a>
<a class="sourceLine" id="cb694-6" data-line-number="6"><span class="st">  WHERE 1=1 --r.conrelid = &#39;16485&#39; AND r.contype = &#39;f&#39; ORDER BY 1;</span></a>
<a class="sourceLine" id="cb694-7" data-line-number="7"><span class="st">  &quot;</span></a>
<a class="sourceLine" id="cb694-8" data-line-number="8">)</a>
<a class="sourceLine" id="cb694-9" data-line-number="9"></a>
<a class="sourceLine" id="cb694-10" data-line-number="10"><span class="kw">head</span>(rs)</a></code></pre></div>
<pre><code>##                        conname connamespace contype condeferrable
## 1 cardinal_number_domain_check        12703       c         FALSE
## 2              yes_or_no_check        12703       c         FALSE
## 3                   year_check         2200       c         FALSE
## 4                   actor_pkey         2200       p         FALSE
## 5                 address_pkey         2200       p         FALSE
## 6                category_pkey         2200       p         FALSE
##   condeferred convalidated conrelid contypid conindid confrelid
## 1       FALSE         TRUE        0    12716        0         0
## 2       FALSE         TRUE        0    12724        0         0
## 3       FALSE         TRUE        0    16397        0         0
## 4       FALSE         TRUE    16420        0    16555         0
## 5       FALSE         TRUE    16461        0    16557         0
## 6       FALSE         TRUE    16427        0    16559         0
##   confupdtype confdeltype confmatchtype conislocal coninhcount
## 1                                             TRUE           0
## 2                                             TRUE           0
## 3                                             TRUE           0
## 4                                             TRUE           0
## 5                                             TRUE           0
## 6                                             TRUE           0
##   connoinherit conkey confkey conpfeqop conppeqop conffeqop conexclop
## 1        FALSE   &lt;NA&gt;    &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;
## 2        FALSE   &lt;NA&gt;    &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;
## 3        FALSE   &lt;NA&gt;    &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;
## 4         TRUE    {1}    &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;
## 5         TRUE    {1}    &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;
## 6         TRUE    {1}    &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;
##                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  conbin
## 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       {OPEXPR :opno 525 :opfuncid 150 :opresulttype 16 :opretset false :opcollid 0 :inputcollid 0 :args ({COERCETODOMAINVALUE :typeId 23 :typeMod -1 :collation 0 :location 195} {CONST :consttype 23 :consttypmod -1 :constcollid 0 :constlen 4 :constbyval true :constisnull false :location 204 :constvalue 4 [ 0 0 0 0 0 0 0 0 ]}) :location 201}
## 2 {SCALARARRAYOPEXPR :opno 98 :opfuncid 67 :useOr true :inputcollid 100 :args ({RELABELTYPE :arg {COERCETODOMAINVALUE :typeId 1043 :typeMod 7 :collation 100 :location 121} :resulttype 25 :resulttypmod -1 :resultcollid 100 :relabelformat 2 :location -1} {ARRAYCOERCEEXPR :arg {ARRAY :array_typeid 1015 :array_collid 100 :element_typeid 1043 :elements ({CONST :consttype 1043 :consttypmod -1 :constcollid 100 :constlen -1 :constbyval false :constisnull false :location 131 :constvalue 7 [ 28 0 0 0 89 69 83 ]} {CONST :consttype 1043 :consttypmod -1 :constcollid 100 :constlen -1 :constbyval false :constisnull false :location 138 :constvalue 6 [ 24 0 0 0 78 79 ]}) :multidims false :location -1} :elemfuncid 0 :resulttype 1009 :resulttypmod -1 :resultcollid 100 :isExplicit false :coerceformat 2 :location -1}) :location 127}
## 3                                                                                                             {BOOLEXPR :boolop and :args ({OPEXPR :opno 525 :opfuncid 150 :opresulttype 16 :opretset false :opcollid 0 :inputcollid 0 :args ({COERCETODOMAINVALUE :typeId 23 :typeMod -1 :collation 0 :location 62} {CONST :consttype 23 :consttypmod -1 :constcollid 0 :constlen 4 :constbyval true :constisnull false :location 71 :constvalue 4 [ 109 7 0 0 0 0 0 0 ]}) :location 68} {OPEXPR :opno 523 :opfuncid 149 :opresulttype 16 :opretset false :opcollid 0 :inputcollid 0 :args ({COERCETODOMAINVALUE :typeId 23 :typeMod -1 :collation 0 :location 82} {CONST :consttype 23 :consttypmod -1 :constcollid 0 :constlen 4 :constbyval true :constisnull false :location 91 :constvalue 4 [ 107 8 0 0 0 0 0 0 ]}) :location 88}) :location 77}
## 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  &lt;NA&gt;
## 5                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  &lt;NA&gt;
## 6                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  &lt;NA&gt;
##                                                                                       consrc
## 1                                                                               (VALUE &gt;= 0)
## 2 ((VALUE)::text = ANY ((ARRAY[&#39;YES&#39;::character varying, &#39;NO&#39;::character varying])::text[]))
## 3                                                      ((VALUE &gt;= 1901) AND (VALUE &lt;= 2155))
## 4                                                                                       &lt;NA&gt;
## 5                                                                                       &lt;NA&gt;
## 6                                                                                       &lt;NA&gt;
##                                                                                         condef
## 1                                                                           CHECK (VALUE &gt;= 0)
## 2 CHECK (VALUE::text = ANY (ARRAY[&#39;YES&#39;::character varying, &#39;NO&#39;::character varying]::text[]))
## 3                                                      CHECK (VALUE &gt;= 1901 AND VALUE &lt;= 2155)
## 4                                                                       PRIMARY KEY (actor_id)
## 5                                                                     PRIMARY KEY (address_id)
## 6                                                                    PRIMARY KEY (category_id)</code></pre>
</div>
</div>
<div id="creating-your-own-data-dictionary" class="section level2">
<h2><span class="header-section-number">28.5</span> Creating your own data dictionary</h2>
<p>If you are going to work with a database for an extended period it can be useful to create your own data dictionary. This can take the form of <a href="https://caitlinhudon.com/2018/10/30/data-dictionaries/">keeping detaild notes</a> as well as extracting metadata from the dbms. Here is an illustration of the idea.</p>
<div class="sourceCode" id="cb696"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb696-1" data-line-number="1">some_tables &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;rental&quot;</span>, <span class="st">&quot;city&quot;</span>, <span class="st">&quot;store&quot;</span>)</a>
<a class="sourceLine" id="cb696-2" data-line-number="2"></a>
<a class="sourceLine" id="cb696-3" data-line-number="3">all_meta &lt;-<span class="st"> </span><span class="kw">map_df</span>(some_tables, sp_get_dbms_data_dictionary, <span class="dt">con =</span> con)</a>
<a class="sourceLine" id="cb696-4" data-line-number="4"></a>
<a class="sourceLine" id="cb696-5" data-line-number="5">all_meta</a></code></pre></div>
<pre><code>## # A tibble: 15 x 11
##    table_name var_name var_type num_rows num_blank num_unique min   q_25 
##    &lt;chr&gt;      &lt;chr&gt;    &lt;chr&gt;       &lt;int&gt;     &lt;int&gt;      &lt;int&gt; &lt;chr&gt; &lt;chr&gt;
##  1 rental     rental_… integer     16045         0      16045 1     4013 
##  2 rental     rental_… double      16045         0      15816 2005… 2005…
##  3 rental     invento… integer     16045         0       4581 1     1154 
##  4 rental     custome… integer     16045         0        600 1     148  
##  5 rental     return_… double      16045       183      15837 2005… 2005…
##  6 rental     staff_id integer     16045         0          2 1     1    
##  7 rental     last_up… double      16045         0          4 2006… 2006…
##  8 city       city_id  integer       600         0        600 1     150  
##  9 city       city     charact…      600         0        599 A Co… Dzer…
## 10 city       country… integer       600         0        109 1     28   
## 11 city       last_up… double        600         0          1 2006… 2006…
## 12 store      store_id integer         3         0          3 1     1    
## 13 store      manager… integer         3         0          3 1     1    
## 14 store      address… integer         3         0          3 1     1    
## 15 store      last_up… double          3         0          2 2006… 2006…
## # … with 3 more variables: q_50 &lt;chr&gt;, q_75 &lt;chr&gt;, max &lt;chr&gt;</code></pre>
<div class="sourceCode" id="cb698"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb698-1" data-line-number="1"><span class="kw">glimpse</span>(all_meta)</a></code></pre></div>
<pre><code>## Observations: 15
## Variables: 11
## $ table_name &lt;chr&gt; &quot;rental&quot;, &quot;rental&quot;, &quot;rental&quot;, &quot;rental&quot;, &quot;rental&quot;, &quot;re…
## $ var_name   &lt;chr&gt; &quot;rental_id&quot;, &quot;rental_date&quot;, &quot;inventory_id&quot;, &quot;customer…
## $ var_type   &lt;chr&gt; &quot;integer&quot;, &quot;double&quot;, &quot;integer&quot;, &quot;integer&quot;, &quot;double&quot;, …
## $ num_rows   &lt;int&gt; 16045, 16045, 16045, 16045, 16045, 16045, 16045, 600,…
## $ num_blank  &lt;int&gt; 0, 0, 0, 0, 183, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
## $ num_unique &lt;int&gt; 16045, 15816, 4581, 600, 15837, 2, 4, 600, 599, 109, …
## $ min        &lt;chr&gt; &quot;1&quot;, &quot;2005-05-24 22:53:30&quot;, &quot;1&quot;, &quot;1&quot;, &quot;2005-05-25 23:…
## $ q_25       &lt;chr&gt; &quot;4013&quot;, &quot;2005-07-07 00:58:00&quot;, &quot;1154&quot;, &quot;148&quot;, &quot;2005-0…
## $ q_50       &lt;chr&gt; &quot;8025&quot;, &quot;2005-07-28 16:03:27&quot;, &quot;2291&quot;, &quot;296&quot;, &quot;2005-0…
## $ q_75       &lt;chr&gt; &quot;12037&quot;, &quot;2005-08-17 21:13:35&quot;, &quot;3433&quot;, &quot;446&quot;, &quot;2005-…
## $ max        &lt;chr&gt; &quot;16050&quot;, &quot;2019-02-25&quot;, &quot;4582&quot;, &quot;600&quot;, &quot;2019-03-04&quot;, &quot;…</code></pre>
<div class="sourceCode" id="cb700"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb700-1" data-line-number="1"><span class="kw">kable</span>(<span class="kw">head</span>(all_meta))</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">table_name</th>
<th align="left">var_name</th>
<th align="left">var_type</th>
<th align="right">num_rows</th>
<th align="right">num_blank</th>
<th align="right">num_unique</th>
<th align="left">min</th>
<th align="left">q_25</th>
<th align="left">q_50</th>
<th align="left">q_75</th>
<th align="left">max</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">rental</td>
<td align="left">rental_id</td>
<td align="left">integer</td>
<td align="right">16045</td>
<td align="right">0</td>
<td align="right">16045</td>
<td align="left">1</td>
<td align="left">4013</td>
<td align="left">8025</td>
<td align="left">12037</td>
<td align="left">16050</td>
</tr>
<tr class="even">
<td align="left">rental</td>
<td align="left">rental_date</td>
<td align="left">double</td>
<td align="right">16045</td>
<td align="right">0</td>
<td align="right">15816</td>
<td align="left">2005-05-24 22:53:30</td>
<td align="left">2005-07-07 00:58:00</td>
<td align="left">2005-07-28 16:03:27</td>
<td align="left">2005-08-17 21:13:35</td>
<td align="left">2019-02-25</td>
</tr>
<tr class="odd">
<td align="left">rental</td>
<td align="left">inventory_id</td>
<td align="left">integer</td>
<td align="right">16045</td>
<td align="right">0</td>
<td align="right">4581</td>
<td align="left">1</td>
<td align="left">1154</td>
<td align="left">2291</td>
<td align="left">3433</td>
<td align="left">4582</td>
</tr>
<tr class="even">
<td align="left">rental</td>
<td align="left">customer_id</td>
<td align="left">integer</td>
<td align="right">16045</td>
<td align="right">0</td>
<td align="right">600</td>
<td align="left">1</td>
<td align="left">148</td>
<td align="left">296</td>
<td align="left">446</td>
<td align="left">600</td>
</tr>
<tr class="odd">
<td align="left">rental</td>
<td align="left">return_date</td>
<td align="left">double</td>
<td align="right">16045</td>
<td align="right">183</td>
<td align="right">15837</td>
<td align="left">2005-05-25 23:55:21</td>
<td align="left">2005-07-10 15:48:58</td>
<td align="left">2005-08-01 19:45:29</td>
<td align="left">2005-08-20 23:49:25</td>
<td align="left">2019-03-04</td>
</tr>
<tr class="even">
<td align="left">rental</td>
<td align="left">staff_id</td>
<td align="left">integer</td>
<td align="right">16045</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">2</td>
<td align="left">2</td>
</tr>
<tr class="odd">
<td align="left">## Save your</td>
<td align="left">work!</td>
<td align="left"></td>
<td align="right"></td>
<td align="right"></td>
<td align="right"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody>
</table>
<p>The work you do to understand the structure and contents of a database can be useful for others (including future-you). So at the end of a session, you might look at all the data frames you want to save. Consider saving them in a form where you can add notes at the appropriate level (as in a Google Doc representing table or columns that you annotate over time).</p>
<div class="sourceCode" id="cb701"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb701-1" data-line-number="1"><span class="kw">ls</span>()</a></code></pre></div>
<pre><code>##  [1] &quot;all_meta&quot;                  &quot;columns_info_schema_info&quot; 
##  [3] &quot;columns_info_schema_table&quot; &quot;con&quot;                      
##  [5] &quot;constraint_column_usage&quot;   &quot;cranex&quot;                   
##  [7] &quot;key_column_usage&quot;          &quot;keys&quot;                     
##  [9] &quot;public_tables&quot;             &quot;referential_constraints&quot;  
## [11] &quot;rs&quot;                        &quot;some_tables&quot;              
## [13] &quot;table_constraints&quot;         &quot;table_info&quot;               
## [15] &quot;table_info_schema_table&quot;   &quot;table_list&quot;               
## [17] &quot;tables&quot;</code></pre>
<!--chapter:end:180-r-query-postgres-metadata.Rmd-->
</div>
</div>
<div id="chapter_dbms-environment" class="section level1">
<h1><span class="header-section-number">29</span> Drilling into your DBMS environment</h1>
<blockquote>
<p>This chapter investigates:</p>
<ul>
<li>Elements of the database environment</li>
<li>Differences between a database, a schema, and other objects</li>
<li>Exercises</li>
</ul>
</blockquote>
<p>The following packages are used in this chapter:</p>
<div class="sourceCode" id="cb703"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb703-1" data-line-number="1"><span class="co"># These packages are called in almost every chapter of the book:</span></a>
<a class="sourceLine" id="cb703-2" data-line-number="2"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb703-3" data-line-number="3"><span class="kw">library</span>(DBI)</a>
<a class="sourceLine" id="cb703-4" data-line-number="4"><span class="kw">library</span>(RPostgres)</a>
<a class="sourceLine" id="cb703-5" data-line-number="5"><span class="kw">require</span>(knitr)</a>
<a class="sourceLine" id="cb703-6" data-line-number="6"><span class="kw">library</span>(dbplyr)</a>
<a class="sourceLine" id="cb703-7" data-line-number="7"><span class="kw">library</span>(sqlpetr)</a>
<a class="sourceLine" id="cb703-8" data-line-number="8"></a>
<a class="sourceLine" id="cb703-9" data-line-number="9">display_rows &lt;-<span class="st">  </span><span class="dv">15</span> <span class="co"># as a default, show 15 rows</span></a></code></pre></div>
<p>Start up the <code>docker-pet</code> container</p>
<div class="sourceCode" id="cb704"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb704-1" data-line-number="1"><span class="kw">sp_docker_start</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<p>Now connect to the <code>dvdrental</code> database with R</p>
<div class="sourceCode" id="cb705"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb705-1" data-line-number="1">con &lt;-<span class="st"> </span><span class="kw">sp_get_postgres_connection</span>(</a>
<a class="sourceLine" id="cb705-2" data-line-number="2">  <span class="dt">user =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_USER_NAME&quot;</span>),</a>
<a class="sourceLine" id="cb705-3" data-line-number="3">  <span class="dt">password =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_PASSWORD&quot;</span>),</a>
<a class="sourceLine" id="cb705-4" data-line-number="4">  <span class="dt">dbname =</span> <span class="st">&quot;dvdrental&quot;</span>,</a>
<a class="sourceLine" id="cb705-5" data-line-number="5">  <span class="dt">seconds_to_test =</span> <span class="dv">30</span></a>
<a class="sourceLine" id="cb705-6" data-line-number="6">)</a>
<a class="sourceLine" id="cb705-7" data-line-number="7">con</a></code></pre></div>
<pre><code>## &lt;PqConnection&gt; dvdrental@localhost:5432</code></pre>
<div id="which-database" class="section level2">
<h2><span class="header-section-number">29.1</span> Which database?</h2>
<p>Your DBA will create your user accounts and priviledges for the database(s) that you can access.</p>
<p>One of the challenges when working with a database(s) is finding where your data actually resides. Your best resources will be one or more subject matter experts, <code>SME</code>, and your DBA. Your data may actually reside in multiple databases, e.g., a detail and summary databases. In our tutorial, we focus on the one database, <code>dvdrental</code>. Database names usually reflect something about the data that they contain.</p>
<p>Your laptop is a server for the Docker PostgreSQL databases. A database is a collection of files that PostgreSQL manages in the background.</p>
</div>
<div id="how-many-databases-reside-in-the-docker-container" class="section level2">
<h2><span class="header-section-number">29.2</span> How many databases reside in the Docker Container?</h2>
<div class="sourceCode" id="cb707"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb707-1" data-line-number="1">rs &lt;-</a>
<a class="sourceLine" id="cb707-2" data-line-number="2"><span class="st">  </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb707-3" data-line-number="3">    con,</a>
<a class="sourceLine" id="cb707-4" data-line-number="4">    <span class="st">&quot;SELECT &#39;DB Names in Docker&#39; showing</span></a>
<a class="sourceLine" id="cb707-5" data-line-number="5"><span class="st">          ,datname DB</span></a>
<a class="sourceLine" id="cb707-6" data-line-number="6"><span class="st">     FROM pg_database</span></a>
<a class="sourceLine" id="cb707-7" data-line-number="7"><span class="st">    WHERE datistemplate = false;</span></a>
<a class="sourceLine" id="cb707-8" data-line-number="8"><span class="st">  &quot;</span></a>
<a class="sourceLine" id="cb707-9" data-line-number="9">  )</a>
<a class="sourceLine" id="cb707-10" data-line-number="10"><span class="kw">kable</span>(rs)</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">showing</th>
<th align="left">db</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">DB Names in Docker</td>
<td align="left">postgres</td>
</tr>
<tr class="even">
<td align="left">DB Names in Docker</td>
<td align="left">dvdrental</td>
</tr>
</tbody>
</table>
<p>Which databases are available?</p>
<pre><code>Modify the connection call to connect to the `postgres` database.</code></pre>
<div class="sourceCode" id="cb709"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb709-1" data-line-number="1"><span class="co"># this code chunk is not evaluated because the `dbname` is not valid!</span></a>
<a class="sourceLine" id="cb709-2" data-line-number="2">con &lt;-<span class="st"> </span><span class="kw">sp_get_postgres_connection</span>(</a>
<a class="sourceLine" id="cb709-3" data-line-number="3">  <span class="dt">user =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_USER_NAME&quot;</span>),</a>
<a class="sourceLine" id="cb709-4" data-line-number="4">  <span class="dt">password =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_PASSWORD&quot;</span>),</a>
<a class="sourceLine" id="cb709-5" data-line-number="5">  <span class="dt">dbname =</span> <span class="st">&quot;your code goes here&quot;</span>,</a>
<a class="sourceLine" id="cb709-6" data-line-number="6">  <span class="dt">seconds_to_test =</span> <span class="dv">30</span></a>
<a class="sourceLine" id="cb709-7" data-line-number="7">)</a>
<a class="sourceLine" id="cb709-8" data-line-number="8"></a>
<a class="sourceLine" id="cb709-9" data-line-number="9">con</a>
<a class="sourceLine" id="cb709-10" data-line-number="10"><span class="cf">if</span> (con <span class="op">!=</span><span class="st"> &quot;There is no connection&quot;</span>) {</a>
<a class="sourceLine" id="cb709-11" data-line-number="11">  <span class="kw">dbDisconnect</span>(con)</a>
<a class="sourceLine" id="cb709-12" data-line-number="12">}</a>
<a class="sourceLine" id="cb709-13" data-line-number="13"></a>
<a class="sourceLine" id="cb709-14" data-line-number="14"><span class="co"># Answer: con &lt;PqConnection&gt; postgres@localhost:5432</span></a></code></pre></div>
<div class="sourceCode" id="cb710"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb710-1" data-line-number="1"><span class="co"># Reconnect to dvdrental</span></a>
<a class="sourceLine" id="cb710-2" data-line-number="2"></a>
<a class="sourceLine" id="cb710-3" data-line-number="3">con &lt;-<span class="st"> </span><span class="kw">sp_get_postgres_connection</span>(</a>
<a class="sourceLine" id="cb710-4" data-line-number="4">  <span class="dt">user =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_USER_NAME&quot;</span>),</a>
<a class="sourceLine" id="cb710-5" data-line-number="5">  <span class="dt">password =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_PASSWORD&quot;</span>),</a>
<a class="sourceLine" id="cb710-6" data-line-number="6">  <span class="dt">dbname =</span> <span class="st">&quot;dvdrental&quot;</span>,</a>
<a class="sourceLine" id="cb710-7" data-line-number="7">  <span class="dt">seconds_to_test =</span> <span class="dv">30</span></a>
<a class="sourceLine" id="cb710-8" data-line-number="8">)</a>
<a class="sourceLine" id="cb710-9" data-line-number="9">con</a></code></pre></div>
<pre><code>## &lt;PqConnection&gt; dvdrental@localhost:5432</code></pre>
<p>Note that the two Sys.getenv function calls work in this tutorial because both the user and password are available in both databases. This is a common practice in organinzations that have implemented single sign on across their organization.</p>
<pre><code>Gotcha:

If one has data in multiple databases or multiple environments, Development,
Integration, and Prodution, it is very easy to connect to the wrong database in
the wrong environment.  Always double check your connection information when
logging in and before performing any inserts, updates, or deletes against the
database.</code></pre>
<p>The following code block should be used to reduce propagating the above gotcha. Current_database(), CURRENT_DATE or CURRENT_TIMESTAMP, and ‘result set’ are the most useful and last three not so much. Instead of the host IP address having the actual hostname would be a nice addition.</p>
<div class="sourceCode" id="cb713"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb713-1" data-line-number="1">rs1 &lt;-</a>
<a class="sourceLine" id="cb713-2" data-line-number="2"><span class="st">  </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb713-3" data-line-number="3">    con,</a>
<a class="sourceLine" id="cb713-4" data-line-number="4">    <span class="st">&quot;SELECT current_database() DB</span></a>
<a class="sourceLine" id="cb713-5" data-line-number="5"><span class="st">         ,CURRENT_DATE</span></a>
<a class="sourceLine" id="cb713-6" data-line-number="6"><span class="st">         ,CURRENT_TIMESTAMP</span></a>
<a class="sourceLine" id="cb713-7" data-line-number="7"><span class="st">         ,&#39;result set description&#39; showing</span></a>
<a class="sourceLine" id="cb713-8" data-line-number="8"><span class="st">         ,session_user</span></a>
<a class="sourceLine" id="cb713-9" data-line-number="9"><span class="st">         ,inet_server_addr() host</span></a>
<a class="sourceLine" id="cb713-10" data-line-number="10"><span class="st">         ,inet_server_port() port</span></a>
<a class="sourceLine" id="cb713-11" data-line-number="11"><span class="st">  &quot;</span></a>
<a class="sourceLine" id="cb713-12" data-line-number="12">  )</a>
<a class="sourceLine" id="cb713-13" data-line-number="13"><span class="kw">kable</span>(rs1)</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">db</th>
<th align="left">current_date</th>
<th align="left">current_timestamp</th>
<th align="left">showing</th>
<th align="left">session_user</th>
<th align="left">host</th>
<th align="right">port</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">2019-03-04</td>
<td align="left">2019-03-03 18:22:15</td>
<td align="left">result set description</td>
<td align="left">postgres</td>
<td align="left">172.17.0.2</td>
<td align="right">5432</td>
</tr>
</tbody>
</table>
<p>Since we will only be working in the <code>dvdrental</code> database in this tutorial and reduce the number of output columns shown, only the ‘result set description’ will be used.</p>
</div>
<div id="which-schema" class="section level2">
<h2><span class="header-section-number">29.3</span> Which Schema?</h2>
<p>In the code block below, we look at the <code>information_schema.table</code> which contains information about all the schemas and table/views within our dvdrental database. Databases can have one or more schemas, containers that hold tables or views. Schemas partition the database into big logical blocks of related data. Schema names usually reflect an application or logically related datasets. Occasionally a DBA will set up a new schema and use a users name.</p>
<p>What schemas are in the <code>dvdrental</code> database?
How many entries are in each schema?</p>
<div class="sourceCode" id="cb714"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb714-1" data-line-number="1"><span class="co">## Database Schemas</span></a>
<a class="sourceLine" id="cb714-2" data-line-number="2"><span class="co">#</span></a>
<a class="sourceLine" id="cb714-3" data-line-number="3">rs1 &lt;-</a>
<a class="sourceLine" id="cb714-4" data-line-number="4"><span class="st">  </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb714-5" data-line-number="5">    con,</a>
<a class="sourceLine" id="cb714-6" data-line-number="6">    <span class="st">&quot;SELECT &#39;DB Schemas&#39; showing,t.table_catalog DB,t.table_schema,COUNT(*) tbl_vws</span></a>
<a class="sourceLine" id="cb714-7" data-line-number="7"><span class="st">     FROM information_schema.tables t</span></a>
<a class="sourceLine" id="cb714-8" data-line-number="8"><span class="st">    GROUP BY t.table_catalog,t.table_schema</span></a>
<a class="sourceLine" id="cb714-9" data-line-number="9"><span class="st">  &quot;</span></a>
<a class="sourceLine" id="cb714-10" data-line-number="10">  )</a>
<a class="sourceLine" id="cb714-11" data-line-number="11"><span class="kw">kable</span>(rs1)</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">showing</th>
<th align="left">db</th>
<th align="left">table_schema</th>
<th align="right">tbl_vws</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">DB Schemas</td>
<td align="left">dvdrental</td>
<td align="left">pg_catalog</td>
<td align="right">121</td>
</tr>
<tr class="even">
<td align="left">DB Schemas</td>
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="right">23</td>
</tr>
<tr class="odd">
<td align="left">DB Schemas</td>
<td align="left">dvdrental</td>
<td align="left">information_schema</td>
<td align="right">67</td>
</tr>
</tbody>
</table>
<p>We see that there are three schemas. The pg_catalog is the standard PostgreSQL meta data and core schema. PostgreSQL uses this schema to manage the internal workings of the database. DBA’s are the primary users of pg_catalog. We used the pg_catalog schema to answer the question ‘How many databases reside in the Docker Container?’, but normally the data analyst is not interested in analyzing database data.</p>
<p>The information_schema contains ANSI standardized views used across the different SQL vendors, (Oracle, Sysbase, MS SQL Server, IBM DB2, etc). The information_schema contains a plethora of metadata that will help you locate your data tables, understand the relationships between the tables, and write efficient SQL queries.</p>
</div>
<div id="exercises-3" class="section level2">
<h2><span class="header-section-number">29.4</span> Exercises</h2>
<div class="sourceCode" id="cb715"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb715-1" data-line-number="1"><span class="co">#</span></a>
<a class="sourceLine" id="cb715-2" data-line-number="2"><span class="co"># Add an order by clause to order the output by the table catalog.</span></a>
<a class="sourceLine" id="cb715-3" data-line-number="3">rs1 &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(con, <span class="st">&quot;SELECT &#39;1. ORDER BY table_catalog&#39; showing</span></a>
<a class="sourceLine" id="cb715-4" data-line-number="4"><span class="st">                                  ,t.table_catalog DB,t.table_schema,COUNT(*) tbl_vws </span></a>
<a class="sourceLine" id="cb715-5" data-line-number="5"><span class="st">                              FROM information_schema.tables t</span></a>
<a class="sourceLine" id="cb715-6" data-line-number="6"><span class="st">                            GROUP BY t.table_catalog,t.table_schema</span></a>
<a class="sourceLine" id="cb715-7" data-line-number="7"><span class="st">                            &quot;</span>)</a>
<a class="sourceLine" id="cb715-8" data-line-number="8"><span class="kw">kable</span>(rs1)</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">showing</th>
<th align="left">db</th>
<th align="left">table_schema</th>
<th align="right">tbl_vws</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1. ORDER BY table_catalog</td>
<td align="left">dvdrental</td>
<td align="left">pg_catalog</td>
<td align="right">121</td>
</tr>
<tr class="even">
<td align="left">1. ORDER BY table_catalog</td>
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="right">23</td>
</tr>
<tr class="odd">
<td align="left">1. ORDER BY table_catalog</td>
<td align="left">dvdrental</td>
<td align="left">information_schema</td>
<td align="right">67</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb716"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb716-1" data-line-number="1"><span class="co"># Add an order by clause to order the output by tbl_vws in descending order.</span></a>
<a class="sourceLine" id="cb716-2" data-line-number="2">rs2 &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(con, <span class="st">&quot;SELECT &#39;2. ORDER BY tbl_vws desc&#39; showing</span></a>
<a class="sourceLine" id="cb716-3" data-line-number="3"><span class="st">                                  ,t.table_catalog DB,t.table_schema,COUNT(*) tbl_vws </span></a>
<a class="sourceLine" id="cb716-4" data-line-number="4"><span class="st">                              FROM information_schema.tables t</span></a>
<a class="sourceLine" id="cb716-5" data-line-number="5"><span class="st">                            GROUP BY t.table_catalog,t.table_schema</span></a>
<a class="sourceLine" id="cb716-6" data-line-number="6"><span class="st">                            &quot;</span>)</a>
<a class="sourceLine" id="cb716-7" data-line-number="7"><span class="kw">kable</span>(rs2)</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">showing</th>
<th align="left">db</th>
<th align="left">table_schema</th>
<th align="right">tbl_vws</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">2. ORDER BY tbl_vws desc</td>
<td align="left">dvdrental</td>
<td align="left">pg_catalog</td>
<td align="right">121</td>
</tr>
<tr class="even">
<td align="left">2. ORDER BY tbl_vws desc</td>
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="right">23</td>
</tr>
<tr class="odd">
<td align="left">2. ORDER BY tbl_vws desc</td>
<td align="left">dvdrental</td>
<td align="left">information_schema</td>
<td align="right">67</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb717"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb717-1" data-line-number="1"><span class="co"># Complete the SQL statement to show everything about all the tables.</span></a>
<a class="sourceLine" id="cb717-2" data-line-number="2"></a>
<a class="sourceLine" id="cb717-3" data-line-number="3">rs3 &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(con, <span class="st">&quot;SELECT &#39;3. all information_schema tables&#39; showing</span></a>
<a class="sourceLine" id="cb717-4" data-line-number="4"><span class="st">                                  ,&#39;your code goes here&#39; </span></a>
<a class="sourceLine" id="cb717-5" data-line-number="5"><span class="st">                              FROM information_schema.tables t</span></a>
<a class="sourceLine" id="cb717-6" data-line-number="6"><span class="st">                            &quot;</span>)</a>
<a class="sourceLine" id="cb717-7" data-line-number="7"><span class="kw">kable</span>(<span class="kw">head</span>(rs3, display_rows))</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">showing</th>
<th align="left">?column?</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">3. all information_schema tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="even">
<td align="left">3. all information_schema tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="odd">
<td align="left">3. all information_schema tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="even">
<td align="left">3. all information_schema tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="odd">
<td align="left">3. all information_schema tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="even">
<td align="left">3. all information_schema tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="odd">
<td align="left">3. all information_schema tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="even">
<td align="left">3. all information_schema tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="odd">
<td align="left">3. all information_schema tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="even">
<td align="left">3. all information_schema tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="odd">
<td align="left">3. all information_schema tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="even">
<td align="left">3. all information_schema tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="odd">
<td align="left">3. all information_schema tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="even">
<td align="left">3. all information_schema tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="odd">
<td align="left">3. all information_schema tables</td>
<td align="left">your code goes here</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb718"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb718-1" data-line-number="1"><span class="co"># Use the results from above to pull interesting columns from just the information_schema</span></a>
<a class="sourceLine" id="cb718-2" data-line-number="2">rs4 &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(con, <span class="st">&quot;SELECT &#39;4. information_schema.tables&#39; showing</span></a>
<a class="sourceLine" id="cb718-3" data-line-number="3"><span class="st">                                  ,&#39;your code goes here&#39; </span></a>
<a class="sourceLine" id="cb718-4" data-line-number="4"><span class="st">                              FROM information_schema.tables t</span></a>
<a class="sourceLine" id="cb718-5" data-line-number="5"><span class="st">                             where &#39;your code goes here&#39; = &#39;your code goes here&#39;</span></a>
<a class="sourceLine" id="cb718-6" data-line-number="6"><span class="st">                            &quot;</span>)</a>
<a class="sourceLine" id="cb718-7" data-line-number="7"><span class="kw">head</span>(rs4, display_rows)</a></code></pre></div>
<pre><code>##                         showing            ?column?
## 1  4. information_schema.tables your code goes here
## 2  4. information_schema.tables your code goes here
## 3  4. information_schema.tables your code goes here
## 4  4. information_schema.tables your code goes here
## 5  4. information_schema.tables your code goes here
## 6  4. information_schema.tables your code goes here
## 7  4. information_schema.tables your code goes here
## 8  4. information_schema.tables your code goes here
## 9  4. information_schema.tables your code goes here
## 10 4. information_schema.tables your code goes here
## 11 4. information_schema.tables your code goes here
## 12 4. information_schema.tables your code goes here
## 13 4. information_schema.tables your code goes here
## 14 4. information_schema.tables your code goes here
## 15 4. information_schema.tables your code goes here</code></pre>
<div class="sourceCode" id="cb720"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb720-1" data-line-number="1"><span class="co"># Modify the SQL below with your interesting column names.</span></a>
<a class="sourceLine" id="cb720-2" data-line-number="2"><span class="co"># Update the where clause to return only rows from the information schema and begin with &#39;tab&#39;</span></a>
<a class="sourceLine" id="cb720-3" data-line-number="3">rs5 &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(con, <span class="st">&quot;SELECT &#39;5. information_schema.tables&#39; showing</span></a>
<a class="sourceLine" id="cb720-4" data-line-number="4"><span class="st">                                  ,&#39;your code goes here&#39; </span></a>
<a class="sourceLine" id="cb720-5" data-line-number="5"><span class="st">                              FROM information_schema.tables t</span></a>
<a class="sourceLine" id="cb720-6" data-line-number="6"><span class="st">                             where &#39;your code goes here&#39; = &#39;your code goes here&#39;</span></a>
<a class="sourceLine" id="cb720-7" data-line-number="7"><span class="st">                            &quot;</span>)</a>
<a class="sourceLine" id="cb720-8" data-line-number="8"><span class="kw">kable</span>(<span class="kw">head</span>(rs5, display_rows))</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">showing</th>
<th align="left">?column?</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">5. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="even">
<td align="left">5. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="odd">
<td align="left">5. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="even">
<td align="left">5. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="odd">
<td align="left">5. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="even">
<td align="left">5. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="odd">
<td align="left">5. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="even">
<td align="left">5. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="odd">
<td align="left">5. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="even">
<td align="left">5. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="odd">
<td align="left">5. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="even">
<td align="left">5. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="odd">
<td align="left">5. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="even">
<td align="left">5. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="odd">
<td align="left">5. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb721"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb721-1" data-line-number="1"><span class="co"># Modify the SQL below with your interesting column names.</span></a>
<a class="sourceLine" id="cb721-2" data-line-number="2"><span class="co"># Update the where clause to return only rows from the information schema and begin with &#39;col&#39;</span></a>
<a class="sourceLine" id="cb721-3" data-line-number="3">rs6 &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(con, <span class="st">&quot;SELECT &#39;6. information_schema.tables&#39; showing</span></a>
<a class="sourceLine" id="cb721-4" data-line-number="4"><span class="st">                                  ,&#39;your code goes here&#39; </span></a>
<a class="sourceLine" id="cb721-5" data-line-number="5"><span class="st">                              FROM information_schema.tables t</span></a>
<a class="sourceLine" id="cb721-6" data-line-number="6"><span class="st">                             where &#39;your code goes here&#39; = &#39;your code goes here&#39;</span></a>
<a class="sourceLine" id="cb721-7" data-line-number="7"><span class="st">                            &quot;</span>)</a>
<a class="sourceLine" id="cb721-8" data-line-number="8"><span class="kw">kable</span>(<span class="kw">head</span>(rs6, display_rows))</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">showing</th>
<th align="left">?column?</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">6. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="even">
<td align="left">6. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="odd">
<td align="left">6. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="even">
<td align="left">6. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="odd">
<td align="left">6. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="even">
<td align="left">6. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="odd">
<td align="left">6. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="even">
<td align="left">6. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="odd">
<td align="left">6. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="even">
<td align="left">6. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="odd">
<td align="left">6. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="even">
<td align="left">6. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="odd">
<td align="left">6. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="even">
<td align="left">6. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
<tr class="odd">
<td align="left">6. information_schema.tables</td>
<td align="left">your code goes here</td>
</tr>
</tbody>
</table>
<p>In the next exercise we combine both the table and column output from the previous exercises. Review the following code block. The last two lines of the WHERE clause are swithced. Will the result set be the same or different? Execute the code block and review the two datasets.</p>
<div class="sourceCode" id="cb722"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb722-1" data-line-number="1">rs7 &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(con, <span class="st">&quot;SELECT &#39;7. information_schema.tables&#39; showing</span></a>
<a class="sourceLine" id="cb722-2" data-line-number="2"><span class="st">                                  ,table_catalog||&#39;.&#39;||table_schema db_info, table_name, table_type</span></a>
<a class="sourceLine" id="cb722-3" data-line-number="3"><span class="st">                              FROM information_schema.tables t</span></a>
<a class="sourceLine" id="cb722-4" data-line-number="4"><span class="st">                             where table_schema = &#39;information_schema&#39;</span></a>
<a class="sourceLine" id="cb722-5" data-line-number="5"><span class="st">                               and table_name like &#39;table%&#39; OR table_name like &#39;%col%&#39;</span></a>
<a class="sourceLine" id="cb722-6" data-line-number="6"><span class="st">                               and table_type = &#39;VIEW&#39;</span></a>
<a class="sourceLine" id="cb722-7" data-line-number="7"><span class="st">                            &quot;</span>)</a>
<a class="sourceLine" id="cb722-8" data-line-number="8"><span class="kw">kable</span>(<span class="kw">head</span>(rs7, display_rows))</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">showing</th>
<th align="left">db_info</th>
<th align="left">table_name</th>
<th align="left">table_type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">7. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">collations</td>
<td align="left">VIEW</td>
</tr>
<tr class="even">
<td align="left">7. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">collation_character_set_applicability</td>
<td align="left">VIEW</td>
</tr>
<tr class="odd">
<td align="left">7. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">column_domain_usage</td>
<td align="left">VIEW</td>
</tr>
<tr class="even">
<td align="left">7. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">column_privileges</td>
<td align="left">VIEW</td>
</tr>
<tr class="odd">
<td align="left">7. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">column_udt_usage</td>
<td align="left">VIEW</td>
</tr>
<tr class="even">
<td align="left">7. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">columns</td>
<td align="left">VIEW</td>
</tr>
<tr class="odd">
<td align="left">7. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">constraint_column_usage</td>
<td align="left">VIEW</td>
</tr>
<tr class="even">
<td align="left">7. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">key_column_usage</td>
<td align="left">VIEW</td>
</tr>
<tr class="odd">
<td align="left">7. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">role_column_grants</td>
<td align="left">VIEW</td>
</tr>
<tr class="even">
<td align="left">7. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">table_constraints</td>
<td align="left">VIEW</td>
</tr>
<tr class="odd">
<td align="left">7. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">table_privileges</td>
<td align="left">VIEW</td>
</tr>
<tr class="even">
<td align="left">7. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">tables</td>
<td align="left">VIEW</td>
</tr>
<tr class="odd">
<td align="left">7. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">triggered_update_columns</td>
<td align="left">VIEW</td>
</tr>
<tr class="even">
<td align="left">7. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">view_column_usage</td>
<td align="left">VIEW</td>
</tr>
<tr class="odd">
<td align="left">7. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">_pg_foreign_table_columns</td>
<td align="left">VIEW</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb723"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb723-1" data-line-number="1">rs8 &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(con, <span class="st">&quot;SELECT &#39;8. information_schema.tables&#39; showing</span></a>
<a class="sourceLine" id="cb723-2" data-line-number="2"><span class="st">                                  ,table_catalog||&#39;.&#39;||table_schema db_info, table_name, table_type</span></a>
<a class="sourceLine" id="cb723-3" data-line-number="3"><span class="st">                              FROM information_schema.tables t</span></a>
<a class="sourceLine" id="cb723-4" data-line-number="4"><span class="st">                             where table_schema = &#39;information_schema&#39;</span></a>
<a class="sourceLine" id="cb723-5" data-line-number="5"><span class="st">                               and table_type = &#39;VIEW&#39;</span></a>
<a class="sourceLine" id="cb723-6" data-line-number="6"><span class="st">                               and table_name like &#39;table%&#39; OR table_name like &#39;%col%&#39;</span></a>
<a class="sourceLine" id="cb723-7" data-line-number="7"><span class="st">                            &quot;</span>)</a>
<a class="sourceLine" id="cb723-8" data-line-number="8"><span class="kw">kable</span>(<span class="kw">head</span>(rs8, display_rows))</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">showing</th>
<th align="left">db_info</th>
<th align="left">table_name</th>
<th align="left">table_type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">8. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">column_options</td>
<td align="left">VIEW</td>
</tr>
<tr class="even">
<td align="left">8. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">_pg_foreign_table_columns</td>
<td align="left">VIEW</td>
</tr>
<tr class="odd">
<td align="left">8. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">view_column_usage</td>
<td align="left">VIEW</td>
</tr>
<tr class="even">
<td align="left">8. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">triggered_update_columns</td>
<td align="left">VIEW</td>
</tr>
<tr class="odd">
<td align="left">8. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">tables</td>
<td align="left">VIEW</td>
</tr>
<tr class="even">
<td align="left">8. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">table_privileges</td>
<td align="left">VIEW</td>
</tr>
<tr class="odd">
<td align="left">8. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">table_constraints</td>
<td align="left">VIEW</td>
</tr>
<tr class="even">
<td align="left">8. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">role_column_grants</td>
<td align="left">VIEW</td>
</tr>
<tr class="odd">
<td align="left">8. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">key_column_usage</td>
<td align="left">VIEW</td>
</tr>
<tr class="even">
<td align="left">8. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">constraint_column_usage</td>
<td align="left">VIEW</td>
</tr>
<tr class="odd">
<td align="left">8. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">columns</td>
<td align="left">VIEW</td>
</tr>
<tr class="even">
<td align="left">8. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">column_udt_usage</td>
<td align="left">VIEW</td>
</tr>
<tr class="odd">
<td align="left">8. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">column_privileges</td>
<td align="left">VIEW</td>
</tr>
<tr class="even">
<td align="left">8. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">column_domain_usage</td>
<td align="left">VIEW</td>
</tr>
<tr class="odd">
<td align="left">8. information_schema.tables</td>
<td align="left">dvdrental.information_schema</td>
<td align="left">collation_character_set_applicability</td>
<td align="left">VIEW</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr class="header">
<th>Operator/Element</th>
<th>Associativity</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>.</td>
<td>left</td>
<td>table/column name separator</td>
</tr>
<tr class="even">
<td>::</td>
<td>left</td>
<td>PostgreSQL-style typecast</td>
</tr>
<tr class="odd">
<td>[ ]</td>
<td>left</td>
<td>array element selection</td>
</tr>
<tr class="even">
<td>-</td>
<td>right</td>
<td>unary minus</td>
</tr>
<tr class="odd">
<td>^</td>
<td>left</td>
<td>exponentiation</td>
</tr>
<tr class="even">
<td>* / %</td>
<td>left</td>
<td>multiplication, division, modulo</td>
</tr>
<tr class="odd">
<td>+ -</td>
<td>left</td>
<td>addition, subtraction</td>
</tr>
<tr class="even">
<td>IS</td>
<td></td>
<td>IS TRUE, IS FALSE, IS UNKNOWN, IS NULL</td>
</tr>
<tr class="odd">
<td>ISNULL</td>
<td></td>
<td>test for null</td>
</tr>
<tr class="even">
<td>NOTNULL</td>
<td></td>
<td>test for not null</td>
</tr>
<tr class="odd">
<td>(any other)</td>
<td>left</td>
<td>all other native and user-defined operators</td>
</tr>
<tr class="even">
<td>IN</td>
<td></td>
<td>set membership</td>
</tr>
<tr class="odd">
<td>BETWEEN</td>
<td></td>
<td>range containment</td>
</tr>
<tr class="even">
<td>OVERLAPS</td>
<td></td>
<td>time interval overlap</td>
</tr>
<tr class="odd">
<td>LIKE ILIKE SIMILAR</td>
<td></td>
<td>string pattern matching</td>
</tr>
<tr class="even">
<td>&lt; &gt;</td>
<td></td>
<td>less than, greater than</td>
</tr>
<tr class="odd">
<td>=</td>
<td>right</td>
<td>equality, assignment</td>
</tr>
<tr class="even">
<td>NOT</td>
<td>right</td>
<td>logical negation</td>
</tr>
<tr class="odd">
<td>AND</td>
<td>left</td>
<td>logical conjunction</td>
</tr>
<tr class="even">
<td>OR</td>
<td>left</td>
<td>logical disjunction</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb724"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb724-1" data-line-number="1">rs1 &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(con, <span class="st">&quot;SELECT t.table_catalog DB ,t.table_schema</span></a>
<a class="sourceLine" id="cb724-2" data-line-number="2"><span class="st">                                  ,t.table_name,t.table_type</span></a>
<a class="sourceLine" id="cb724-3" data-line-number="3"><span class="st">                              FROM information_schema.tables t&quot;</span>)</a>
<a class="sourceLine" id="cb724-4" data-line-number="4"></a>
<a class="sourceLine" id="cb724-5" data-line-number="5">rs2 &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(con, <span class="st">&quot;SELECT t.table_catalog DB ,t.table_schema</span></a>
<a class="sourceLine" id="cb724-6" data-line-number="6"><span class="st">                                  ,t.table_type,COUNT(*) tbls</span></a>
<a class="sourceLine" id="cb724-7" data-line-number="7"><span class="st">                              FROM information_schema.tables t</span></a>
<a class="sourceLine" id="cb724-8" data-line-number="8"><span class="st">                            group by t.table_catalog ,t.table_schema</span></a>
<a class="sourceLine" id="cb724-9" data-line-number="9"><span class="st">                                  ,t.table_type</span></a>
<a class="sourceLine" id="cb724-10" data-line-number="10"><span class="st">                            &quot;</span>)</a>
<a class="sourceLine" id="cb724-11" data-line-number="11"></a>
<a class="sourceLine" id="cb724-12" data-line-number="12">rs3 &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(con, <span class="st">&quot;SELECT distinct t.table_catalog DB ,t.table_schema</span></a>
<a class="sourceLine" id="cb724-13" data-line-number="13"><span class="st">                                  ,t.table_type tbls</span></a>
<a class="sourceLine" id="cb724-14" data-line-number="14"><span class="st">                              FROM information_schema.tables t</span></a>
<a class="sourceLine" id="cb724-15" data-line-number="15"><span class="st">                            &quot;</span>)</a>
<a class="sourceLine" id="cb724-16" data-line-number="16"></a>
<a class="sourceLine" id="cb724-17" data-line-number="17"></a>
<a class="sourceLine" id="cb724-18" data-line-number="18"></a>
<a class="sourceLine" id="cb724-19" data-line-number="19"><span class="co"># kable(head(rs1 %&gt;% arrange (table_name)))</span></a>
<a class="sourceLine" id="cb724-20" data-line-number="20"><span class="co"># View(rs1)</span></a>
<a class="sourceLine" id="cb724-21" data-line-number="21"><span class="co"># View(rs2)</span></a>
<a class="sourceLine" id="cb724-22" data-line-number="22"><span class="co"># View(rs3)</span></a>
<a class="sourceLine" id="cb724-23" data-line-number="23"><span class="kw">kable</span>(<span class="kw">head</span>(rs1))</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">db</th>
<th align="left">table_schema</th>
<th align="left">table_name</th>
<th align="left">table_type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">actor_info</td>
<td align="left">VIEW</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">customer_list</td>
<td align="left">VIEW</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">film_list</td>
<td align="left">VIEW</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">nicer_but_slower_film_list</td>
<td align="left">VIEW</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">sales_by_film_category</td>
<td align="left">VIEW</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">staff</td>
<td align="left">BASE TABLE</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb725"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb725-1" data-line-number="1"><span class="kw">kable</span>(<span class="kw">head</span>(rs2))</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">db</th>
<th align="left">table_schema</th>
<th align="left">table_type</th>
<th align="right">tbls</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">information_schema</td>
<td align="left">BASE TABLE</td>
<td align="right">7</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">information_schema</td>
<td align="left">VIEW</td>
<td align="right">60</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">pg_catalog</td>
<td align="left">BASE TABLE</td>
<td align="right">62</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">BASE TABLE</td>
<td align="right">16</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">VIEW</td>
<td align="right">7</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">pg_catalog</td>
<td align="left">VIEW</td>
<td align="right">59</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb726"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb726-1" data-line-number="1"><span class="kw">kable</span>(<span class="kw">head</span>(rs3))</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">db</th>
<th align="left">table_schema</th>
<th align="left">tbls</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">information_schema</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">information_schema</td>
<td align="left">VIEW</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">pg_catalog</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">BASE TABLE</td>
</tr>
<tr class="odd">
<td align="left">dvdrental</td>
<td align="left">public</td>
<td align="left">VIEW</td>
</tr>
<tr class="even">
<td align="left">dvdrental</td>
<td align="left">pg_catalog</td>
<td align="left">VIEW</td>
</tr>
</tbody>
</table>
<p>www.dataquest.io/blog/postgres-internals</p>
<p>Comment on the practice of putting a comma at the beginning of a line in SQL code.</p>
<div class="sourceCode" id="cb727"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb727-1" data-line-number="1"><span class="co">## Explain a `dplyr::join</span></a>
<a class="sourceLine" id="cb727-2" data-line-number="2"></a>
<a class="sourceLine" id="cb727-3" data-line-number="3">tbl_pk_fk_df &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb727-4" data-line-number="4">  con,</a>
<a class="sourceLine" id="cb727-5" data-line-number="5">  <span class="st">&quot;</span></a>
<a class="sourceLine" id="cb727-6" data-line-number="6"><span class="st">SELECT --t.table_catalog,t.table_schema,</span></a>
<a class="sourceLine" id="cb727-7" data-line-number="7"><span class="st">   c.table_name</span></a>
<a class="sourceLine" id="cb727-8" data-line-number="8"><span class="st">    ,kcu.column_name</span></a>
<a class="sourceLine" id="cb727-9" data-line-number="9"><span class="st">    ,c.constraint_name</span></a>
<a class="sourceLine" id="cb727-10" data-line-number="10"><span class="st">    ,c.constraint_type</span></a>
<a class="sourceLine" id="cb727-11" data-line-number="11"><span class="st">    ,coalesce(c2.table_name, &#39;&#39;) ref_table</span></a>
<a class="sourceLine" id="cb727-12" data-line-number="12"><span class="st">    ,coalesce(kcu2.column_name, &#39;&#39;) ref_table_col</span></a>
<a class="sourceLine" id="cb727-13" data-line-number="13"><span class="st">FROM information_schema.tables t</span></a>
<a class="sourceLine" id="cb727-14" data-line-number="14"><span class="st">LEFT JOIN information_schema.table_constraints c</span></a>
<a class="sourceLine" id="cb727-15" data-line-number="15"><span class="st">  ON t.table_catalog = c.table_catalog</span></a>
<a class="sourceLine" id="cb727-16" data-line-number="16"><span class="st">    AND t.table_schema = c.table_schema</span></a>
<a class="sourceLine" id="cb727-17" data-line-number="17"><span class="st">    AND t.table_name = c.table_name</span></a>
<a class="sourceLine" id="cb727-18" data-line-number="18"><span class="st">LEFT JOIN information_schema.key_column_usage kcu</span></a>
<a class="sourceLine" id="cb727-19" data-line-number="19"><span class="st">    ON c.constraint_schema = kcu.constraint_schema</span></a>
<a class="sourceLine" id="cb727-20" data-line-number="20"><span class="st">        AND c.constraint_name = kcu.constraint_name</span></a>
<a class="sourceLine" id="cb727-21" data-line-number="21"><span class="st">LEFT JOIN information_schema.referential_constraints rc</span></a>
<a class="sourceLine" id="cb727-22" data-line-number="22"><span class="st">    ON c.constraint_schema = rc.constraint_schema</span></a>
<a class="sourceLine" id="cb727-23" data-line-number="23"><span class="st">        AND c.constraint_name = rc.constraint_name</span></a>
<a class="sourceLine" id="cb727-24" data-line-number="24"><span class="st">LEFT JOIN information_schema.table_constraints c2</span></a>
<a class="sourceLine" id="cb727-25" data-line-number="25"><span class="st">    ON rc.unique_constraint_schema = c2.constraint_schema</span></a>
<a class="sourceLine" id="cb727-26" data-line-number="26"><span class="st">        AND rc.unique_constraint_name = c2.constraint_name</span></a>
<a class="sourceLine" id="cb727-27" data-line-number="27"><span class="st">LEFT JOIN information_schema.key_column_usage kcu2</span></a>
<a class="sourceLine" id="cb727-28" data-line-number="28"><span class="st">    ON c2.constraint_schema = kcu2.constraint_schema</span></a>
<a class="sourceLine" id="cb727-29" data-line-number="29"><span class="st">        AND c2.constraint_name = kcu2.constraint_name</span></a>
<a class="sourceLine" id="cb727-30" data-line-number="30"><span class="st">        AND kcu.ordinal_position = kcu2.ordinal_position</span></a>
<a class="sourceLine" id="cb727-31" data-line-number="31"><span class="st">WHERE c.constraint_type IN (&#39;PRIMARY KEY&#39;, &#39;FOREIGN KEY&#39;)</span></a>
<a class="sourceLine" id="cb727-32" data-line-number="32"><span class="st">  AND c.table_catalog = &#39;dvdrental&#39;</span></a>
<a class="sourceLine" id="cb727-33" data-line-number="33"><span class="st">    AND c.table_schema = &#39;public&#39;</span></a>
<a class="sourceLine" id="cb727-34" data-line-number="34"><span class="st">ORDER BY c.table_name;</span></a>
<a class="sourceLine" id="cb727-35" data-line-number="35"><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb727-36" data-line-number="36">)</a>
<a class="sourceLine" id="cb727-37" data-line-number="37"></a>
<a class="sourceLine" id="cb727-38" data-line-number="38"><span class="co"># View(tbl_pk_fk_df)</span></a>
<a class="sourceLine" id="cb727-39" data-line-number="39"></a>
<a class="sourceLine" id="cb727-40" data-line-number="40">tables_df &lt;-<span class="st"> </span>tbl_pk_fk_df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>(table_name)</a>
<a class="sourceLine" id="cb727-41" data-line-number="41"><span class="co"># View(tables_df)</span></a></code></pre></div>
<div class="sourceCode" id="cb728"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb728-1" data-line-number="1"><span class="kw">library</span>(DiagrammeR)</a>
<a class="sourceLine" id="cb728-2" data-line-number="2"></a>
<a class="sourceLine" id="cb728-3" data-line-number="3">table_nodes_ndf &lt;-<span class="st"> </span><span class="kw">create_node_df</span>(</a>
<a class="sourceLine" id="cb728-4" data-line-number="4">  n &lt;-<span class="st"> </span><span class="kw">nrow</span>(tables_df)</a>
<a class="sourceLine" id="cb728-5" data-line-number="5">  , type &lt;-<span class="st"> &quot;table&quot;</span></a>
<a class="sourceLine" id="cb728-6" data-line-number="6">  , label &lt;-<span class="st"> </span>tables_df<span class="op">$</span>table_name</a>
<a class="sourceLine" id="cb728-7" data-line-number="7">  ,</a>
<a class="sourceLine" id="cb728-8" data-line-number="8">  <span class="dt">shape =</span> <span class="st">&quot;rectangle&quot;</span></a>
<a class="sourceLine" id="cb728-9" data-line-number="9">  , <span class="dt">width =</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb728-10" data-line-number="10">  , <span class="dt">height =</span> <span class="fl">.5</span></a>
<a class="sourceLine" id="cb728-11" data-line-number="11">  , <span class="dt">fontsize =</span> <span class="dv">18</span></a>
<a class="sourceLine" id="cb728-12" data-line-number="12">)</a>
<a class="sourceLine" id="cb728-13" data-line-number="13"></a>
<a class="sourceLine" id="cb728-14" data-line-number="14">tbl_pk_fk_ids_df &lt;-<span class="st"> </span><span class="kw">inner_join</span>(tbl_pk_fk_df, table_nodes_ndf</a>
<a class="sourceLine" id="cb728-15" data-line-number="15">  ,</a>
<a class="sourceLine" id="cb728-16" data-line-number="16">  <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;table_name&quot;</span> =<span class="st"> &quot;label&quot;</span>)</a>
<a class="sourceLine" id="cb728-17" data-line-number="17">  , <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;st&quot;</span>, <span class="st">&quot;s&quot;</span>))</a>
<a class="sourceLine" id="cb728-18" data-line-number="18">) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb728-19" data-line-number="19"><span class="st">  </span><span class="kw">rename</span>(<span class="st">&quot;src_tbl_id&quot;</span> =<span class="st"> </span>id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb728-20" data-line-number="20"><span class="st">  </span><span class="kw">left_join</span>(table_nodes_ndf</a>
<a class="sourceLine" id="cb728-21" data-line-number="21">    ,</a>
<a class="sourceLine" id="cb728-22" data-line-number="22">    <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;ref_table&quot;</span> =<span class="st"> &quot;label&quot;</span>)</a>
<a class="sourceLine" id="cb728-23" data-line-number="23">    , <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;st&quot;</span>, <span class="st">&quot;t&quot;</span>))</a>
<a class="sourceLine" id="cb728-24" data-line-number="24">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb728-25" data-line-number="25"><span class="st">  </span><span class="kw">rename</span>(<span class="st">&quot;fk_tbl_id&quot;</span> =<span class="st"> </span>id)</a>
<a class="sourceLine" id="cb728-26" data-line-number="26"></a>
<a class="sourceLine" id="cb728-27" data-line-number="27">tbl_fk_df &lt;-<span class="st"> </span>tbl_pk_fk_ids_df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(constraint_type <span class="op">==</span><span class="st"> &quot;FOREIGN KEY&quot;</span>)</a>
<a class="sourceLine" id="cb728-28" data-line-number="28">tbl_pk_df &lt;-<span class="st"> </span>tbl_pk_fk_ids_df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(constraint_type <span class="op">==</span><span class="st"> &quot;PRIMARY KEY&quot;</span>)</a>
<a class="sourceLine" id="cb728-29" data-line-number="29"><span class="co"># View(tbl_pk_fk_ids_df)</span></a>
<a class="sourceLine" id="cb728-30" data-line-number="30"><span class="co"># View(tbl_fk_df)</span></a>
<a class="sourceLine" id="cb728-31" data-line-number="31"><span class="co"># View(tbl_pk_df)</span></a>
<a class="sourceLine" id="cb728-32" data-line-number="32"><span class="kw">kable</span>(<span class="kw">head</span>(tbl_fk_df))</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">table_name</th>
<th align="left">column_name</th>
<th align="left">constraint_name</th>
<th align="left">constraint_type</th>
<th align="left">ref_table</th>
<th align="left">ref_table_col</th>
<th align="right">src_tbl_id</th>
<th align="left">type.x</th>
<th align="left">shape.x</th>
<th align="right">width.x</th>
<th align="right">height.x</th>
<th align="right">fontsize.x</th>
<th align="right">fk_tbl_id</th>
<th align="left">type.y</th>
<th align="left">shape.y</th>
<th align="right">width.y</th>
<th align="right">height.y</th>
<th align="right">fontsize.y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">address</td>
<td align="left">city_id</td>
<td align="left">fk_address_city</td>
<td align="left">FOREIGN KEY</td>
<td align="left">city</td>
<td align="left">city_id</td>
<td align="right">2</td>
<td align="left">table</td>
<td align="left">rectangle</td>
<td align="right">1</td>
<td align="right">0.5</td>
<td align="right">18</td>
<td align="right">4</td>
<td align="left">table</td>
<td align="left">rectangle</td>
<td align="right">1</td>
<td align="right">0.5</td>
<td align="right">18</td>
</tr>
<tr class="even">
<td align="left">city</td>
<td align="left">country_id</td>
<td align="left">fk_city</td>
<td align="left">FOREIGN KEY</td>
<td align="left">country</td>
<td align="left">country_id</td>
<td align="right">4</td>
<td align="left">table</td>
<td align="left">rectangle</td>
<td align="right">1</td>
<td align="right">0.5</td>
<td align="right">18</td>
<td align="right">5</td>
<td align="left">table</td>
<td align="left">rectangle</td>
<td align="right">1</td>
<td align="right">0.5</td>
<td align="right">18</td>
</tr>
<tr class="odd">
<td align="left">customer</td>
<td align="left">address_id</td>
<td align="left">customer_address_id_fkey</td>
<td align="left">FOREIGN KEY</td>
<td align="left">address</td>
<td align="left">address_id</td>
<td align="right">6</td>
<td align="left">table</td>
<td align="left">rectangle</td>
<td align="right">1</td>
<td align="right">0.5</td>
<td align="right">18</td>
<td align="right">2</td>
<td align="left">table</td>
<td align="left">rectangle</td>
<td align="right">1</td>
<td align="right">0.5</td>
<td align="right">18</td>
</tr>
<tr class="even">
<td align="left">film</td>
<td align="left">language_id</td>
<td align="left">film_language_id_fkey</td>
<td align="left">FOREIGN KEY</td>
<td align="left">language</td>
<td align="left">language_id</td>
<td align="right">7</td>
<td align="left">table</td>
<td align="left">rectangle</td>
<td align="right">1</td>
<td align="right">0.5</td>
<td align="right">18</td>
<td align="right">11</td>
<td align="left">table</td>
<td align="left">rectangle</td>
<td align="right">1</td>
<td align="right">0.5</td>
<td align="right">18</td>
</tr>
<tr class="odd">
<td align="left">film_actor</td>
<td align="left">actor_id</td>
<td align="left">film_actor_actor_id_fkey</td>
<td align="left">FOREIGN KEY</td>
<td align="left">actor</td>
<td align="left">actor_id</td>
<td align="right">8</td>
<td align="left">table</td>
<td align="left">rectangle</td>
<td align="right">1</td>
<td align="right">0.5</td>
<td align="right">18</td>
<td align="right">1</td>
<td align="left">table</td>
<td align="left">rectangle</td>
<td align="right">1</td>
<td align="right">0.5</td>
<td align="right">18</td>
</tr>
<tr class="even">
<td align="left">film_actor</td>
<td align="left">film_id</td>
<td align="left">film_actor_film_id_fkey</td>
<td align="left">FOREIGN KEY</td>
<td align="left">film</td>
<td align="left">film_id</td>
<td align="right">8</td>
<td align="left">table</td>
<td align="left">rectangle</td>
<td align="right">1</td>
<td align="right">0.5</td>
<td align="right">18</td>
<td align="right">7</td>
<td align="left">table</td>
<td align="left">rectangle</td>
<td align="right">1</td>
<td align="right">0.5</td>
<td align="right">18</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb729"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb729-1" data-line-number="1"><span class="kw">kable</span>(<span class="kw">head</span>(tbl_pk_df))</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">table_name</th>
<th align="left">column_name</th>
<th align="left">constraint_name</th>
<th align="left">constraint_type</th>
<th align="left">ref_table</th>
<th align="left">ref_table_col</th>
<th align="right">src_tbl_id</th>
<th align="left">type.x</th>
<th align="left">shape.x</th>
<th align="right">width.x</th>
<th align="right">height.x</th>
<th align="right">fontsize.x</th>
<th align="right">fk_tbl_id</th>
<th align="left">type.y</th>
<th align="left">shape.y</th>
<th align="right">width.y</th>
<th align="right">height.y</th>
<th align="right">fontsize.y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">actor</td>
<td align="left">actor_id</td>
<td align="left">actor_pkey</td>
<td align="left">PRIMARY KEY</td>
<td align="left"></td>
<td align="left"></td>
<td align="right">1</td>
<td align="left">table</td>
<td align="left">rectangle</td>
<td align="right">1</td>
<td align="right">0.5</td>
<td align="right">18</td>
<td align="right">NA</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">address</td>
<td align="left">address_id</td>
<td align="left">address_pkey</td>
<td align="left">PRIMARY KEY</td>
<td align="left"></td>
<td align="left"></td>
<td align="right">2</td>
<td align="left">table</td>
<td align="left">rectangle</td>
<td align="right">1</td>
<td align="right">0.5</td>
<td align="right">18</td>
<td align="right">NA</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">category</td>
<td align="left">category_id</td>
<td align="left">category_pkey</td>
<td align="left">PRIMARY KEY</td>
<td align="left"></td>
<td align="left"></td>
<td align="right">3</td>
<td align="left">table</td>
<td align="left">rectangle</td>
<td align="right">1</td>
<td align="right">0.5</td>
<td align="right">18</td>
<td align="right">NA</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">city</td>
<td align="left">city_id</td>
<td align="left">city_pkey</td>
<td align="left">PRIMARY KEY</td>
<td align="left"></td>
<td align="left"></td>
<td align="right">4</td>
<td align="left">table</td>
<td align="left">rectangle</td>
<td align="right">1</td>
<td align="right">0.5</td>
<td align="right">18</td>
<td align="right">NA</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">country</td>
<td align="left">country_id</td>
<td align="left">country_pkey</td>
<td align="left">PRIMARY KEY</td>
<td align="left"></td>
<td align="left"></td>
<td align="right">5</td>
<td align="left">table</td>
<td align="left">rectangle</td>
<td align="right">1</td>
<td align="right">0.5</td>
<td align="right">18</td>
<td align="right">NA</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">customer</td>
<td align="left">customer_id</td>
<td align="left">customer_pkey</td>
<td align="left">PRIMARY KEY</td>
<td align="left"></td>
<td align="left"></td>
<td align="right">6</td>
<td align="left">table</td>
<td align="left">rectangle</td>
<td align="right">1</td>
<td align="right">0.5</td>
<td align="right">18</td>
<td align="right">NA</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb730"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb730-1" data-line-number="1"><span class="co"># Create an edge data frame, edf</span></a>
<a class="sourceLine" id="cb730-2" data-line-number="2"></a>
<a class="sourceLine" id="cb730-3" data-line-number="3">fk_edf &lt;-</a>
<a class="sourceLine" id="cb730-4" data-line-number="4"><span class="st">  </span><span class="kw">create_edge_df</span>(</a>
<a class="sourceLine" id="cb730-5" data-line-number="5">    <span class="dt">from =</span> tbl_fk_df<span class="op">$</span>src_tbl_id,</a>
<a class="sourceLine" id="cb730-6" data-line-number="6">    <span class="dt">to =</span> tbl_fk_df<span class="op">$</span>fk_tbl_id,</a>
<a class="sourceLine" id="cb730-7" data-line-number="7">    <span class="dt">rel =</span> <span class="st">&quot;fk&quot;</span>,</a>
<a class="sourceLine" id="cb730-8" data-line-number="8">    <span class="dt">label =</span> tbl_fk_df<span class="op">$</span>constraint_name,</a>
<a class="sourceLine" id="cb730-9" data-line-number="9">    <span class="dt">fontsize =</span> <span class="dv">15</span></a>
<a class="sourceLine" id="cb730-10" data-line-number="10">  )</a>
<a class="sourceLine" id="cb730-11" data-line-number="11"><span class="co"># View(fk_edf)</span></a></code></pre></div>
<div class="sourceCode" id="cb731"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb731-1" data-line-number="1"><span class="kw">create_graph</span>(</a>
<a class="sourceLine" id="cb731-2" data-line-number="2">  <span class="dt">nodes_df =</span> table_nodes_ndf,</a>
<a class="sourceLine" id="cb731-3" data-line-number="3">  <span class="dt">edges_df =</span> fk_edf,</a>
<a class="sourceLine" id="cb731-4" data-line-number="4">  <span class="dt">graph_name =</span> <span class="st">&quot;Simple FK Graph&quot;</span></a>
<a class="sourceLine" id="cb731-5" data-line-number="5">) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb731-6" data-line-number="6"><span class="kw">render_graph</span>()</a></code></pre></div>
<div id="htmlwidget-aa83b18b48ec4ad64944" style="width:672px;height:480px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-aa83b18b48ec4ad64944">{"x":{"diagram":"digraph {\n\ngraph [layout = \"neato\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"circle\",\n      fixedsize = \"true\",\n      width = \"0.5\",\n      style = \"filled\",\n      fillcolor = \"aliceblue\",\n      color = \"gray70\",\n      fontcolor = \"gray50\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray80\",\n     arrowsize = \"0.5\"]\n\n  \"1\" [label = \"actor\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"2\" [label = \"address\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"3\" [label = \"category\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"4\" [label = \"city\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"5\" [label = \"country\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"6\" [label = \"customer\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"7\" [label = \"film\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"8\" [label = \"film_actor\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"9\" [label = \"film_category\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"10\" [label = \"inventory\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"11\" [label = \"language\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"12\" [label = \"payment\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"13\" [label = \"rental\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"14\" [label = \"staff\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"15\" [label = \"store\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n\"2\"->\"4\" [label = \"fk_address_city\", fontsize = \"15\"] \n\"4\"->\"5\" [label = \"fk_city\", fontsize = \"15\"] \n\"6\"->\"2\" [label = \"customer_address_id_fkey\", fontsize = \"15\"] \n\"7\"->\"11\" [label = \"film_language_id_fkey\", fontsize = \"15\"] \n\"8\"->\"1\" [label = \"film_actor_actor_id_fkey\", fontsize = \"15\"] \n\"8\"->\"7\" [label = \"film_actor_film_id_fkey\", fontsize = \"15\"] \n\"9\"->\"3\" [label = \"film_category_category_id_fkey\", fontsize = \"15\"] \n\"9\"->\"7\" [label = \"film_category_film_id_fkey\", fontsize = \"15\"] \n\"10\"->\"7\" [label = \"inventory_film_id_fkey\", fontsize = \"15\"] \n\"12\"->\"14\" [label = \"payment_staff_id_fkey\", fontsize = \"15\"] \n\"12\"->\"6\" [label = \"payment_customer_id_fkey\", fontsize = \"15\"] \n\"12\"->\"13\" [label = \"payment_rental_id_fkey\", fontsize = \"15\"] \n\"13\"->\"6\" [label = \"rental_customer_id_fkey\", fontsize = \"15\"] \n\"13\"->\"14\" [label = \"rental_staff_id_key\", fontsize = \"15\"] \n\"13\"->\"10\" [label = \"rental_inventory_id_fkey\", fontsize = \"15\"] \n\"14\"->\"2\" [label = \"staff_address_id_fkey\", fontsize = \"15\"] \n\"15\"->\"2\" [label = \"store_address_id_fkey\", fontsize = \"15\"] \n\"15\"->\"14\" [label = \"store_manager_staff_id_fkey\", fontsize = \"15\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb732"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb732-1" data-line-number="1"><span class="kw">dbDisconnect</span>(con)</a>
<a class="sourceLine" id="cb732-2" data-line-number="2"><span class="co"># system2(&#39;docker&#39;,&#39;stop sql-pet&#39;)</span></a></code></pre></div>
<!--chapter:end:190-drilling-into-db-environment.Rmd-->
</div>
</div>
<div id="chapter_explain-queries" class="section level1">
<h1><span class="header-section-number">30</span> Explain queries</h1>
<blockquote>
<p>This chapter demonstrates:</p>
<ul>
<li>How to investigate SQL query performance</li>
</ul>
</blockquote>
<div class="sourceCode" id="cb733"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb733-1" data-line-number="1"><span class="co"># These packages are called in almost every chapter of the book:</span></a>
<a class="sourceLine" id="cb733-2" data-line-number="2"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb733-3" data-line-number="3"><span class="kw">library</span>(DBI)</a>
<a class="sourceLine" id="cb733-4" data-line-number="4"><span class="kw">library</span>(RPostgres)</a>
<a class="sourceLine" id="cb733-5" data-line-number="5"><span class="kw">library</span>(glue)</a>
<a class="sourceLine" id="cb733-6" data-line-number="6"><span class="kw">library</span>(here)</a>
<a class="sourceLine" id="cb733-7" data-line-number="7"><span class="kw">require</span>(knitr)</a>
<a class="sourceLine" id="cb733-8" data-line-number="8"><span class="kw">library</span>(dbplyr)</a>
<a class="sourceLine" id="cb733-9" data-line-number="9"><span class="kw">library</span>(sqlpetr)</a></code></pre></div>
<ul>
<li>examining <code>dplyr</code> queries (<code>dplyr::show_query</code> on the R side v EXPLAIN on the PostgreSQL side)</li>
</ul>
<p>Start up the <code>docker-pet</code> container</p>
<div class="sourceCode" id="cb734"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb734-1" data-line-number="1"><span class="kw">sp_docker_start</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<p>now connect to the database with R</p>
<div class="sourceCode" id="cb735"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb735-1" data-line-number="1">con &lt;-<span class="st"> </span><span class="kw">sp_get_postgres_connection</span>(<span class="dt">user =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_USER_NAME&quot;</span>),</a>
<a class="sourceLine" id="cb735-2" data-line-number="2">                         <span class="dt">password =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_PASSWORD&quot;</span>),</a>
<a class="sourceLine" id="cb735-3" data-line-number="3">                         <span class="dt">dbname =</span> <span class="st">&quot;dvdrental&quot;</span>,</a>
<a class="sourceLine" id="cb735-4" data-line-number="4">                         <span class="dt">seconds_to_test =</span> <span class="dv">30</span>)</a></code></pre></div>
<div id="performance-considerations" class="section level2">
<h2><span class="header-section-number">30.1</span> Performance considerations</h2>
<div class="sourceCode" id="cb736"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb736-1" data-line-number="1"><span class="co">## Explain a `dplyr::join`</span></a>
<a class="sourceLine" id="cb736-2" data-line-number="2"></a>
<a class="sourceLine" id="cb736-3" data-line-number="3"><span class="co">## Explain the quivalent SQL join</span></a>
<a class="sourceLine" id="cb736-4" data-line-number="4">rs1 &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(con</a>
<a class="sourceLine" id="cb736-5" data-line-number="5">                 ,<span class="st">&quot;SELECT c.* </span></a>
<a class="sourceLine" id="cb736-6" data-line-number="6"><span class="st">                     FROM pg_catalog.pg_class c</span></a>
<a class="sourceLine" id="cb736-7" data-line-number="7"><span class="st">                     JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace</span></a>
<a class="sourceLine" id="cb736-8" data-line-number="8"><span class="st">                    WHERE  n.nspname = &#39;public&#39;</span></a>
<a class="sourceLine" id="cb736-9" data-line-number="9"><span class="st">                      AND  c.relname = &#39;cust_movies&#39;</span></a>
<a class="sourceLine" id="cb736-10" data-line-number="10"><span class="st">                      AND  c.relkind = &#39;r&#39;</span></a>
<a class="sourceLine" id="cb736-11" data-line-number="11"><span class="st">                   ;</span></a>
<a class="sourceLine" id="cb736-12" data-line-number="12"><span class="st">                 &quot;</span></a>
<a class="sourceLine" id="cb736-13" data-line-number="13">                 )</a>
<a class="sourceLine" id="cb736-14" data-line-number="14"><span class="kw">head</span>(rs1)</a></code></pre></div>
<pre><code>##  [1] relname             relnamespace        reltype            
##  [4] reloftype           relowner            relam              
##  [7] relfilenode         reltablespace       relpages           
## [10] reltuples           relallvisible       reltoastrelid      
## [13] relhasindex         relisshared         relpersistence     
## [16] relkind             relnatts            relchecks          
## [19] relhasoids          relhaspkey          relhasrules        
## [22] relhastriggers      relhassubclass      relrowsecurity     
## [25] relforcerowsecurity relispopulated      relreplident       
## [28] relispartition      relfrozenxid        relminmxid         
## [31] relacl              reloptions          relpartbound       
## &lt;0 rows&gt; (or 0-length row.names)</code></pre>
<p>This came from 14-sql_pet-examples-part-b.Rmd</p>
<div class="sourceCode" id="cb738"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb738-1" data-line-number="1">rs1 &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb738-2" data-line-number="2">                <span class="st">&quot;explain select r.*</span></a>
<a class="sourceLine" id="cb738-3" data-line-number="3"><span class="st">                   from rental r </span></a>
<a class="sourceLine" id="cb738-4" data-line-number="4"><span class="st">                 ;&quot;</span></a>
<a class="sourceLine" id="cb738-5" data-line-number="5">                )  </a>
<a class="sourceLine" id="cb738-6" data-line-number="6"><span class="kw">head</span>(rs1)</a></code></pre></div>
<pre><code>##                                                      QUERY PLAN
## 1 Seq Scan on rental r  (cost=0.00..310.44 rows=16044 width=36)</code></pre>
<div class="sourceCode" id="cb740"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb740-1" data-line-number="1">rs2 &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb740-2" data-line-number="2">                <span class="st">&quot;explain select count(*) count</span></a>
<a class="sourceLine" id="cb740-3" data-line-number="3"><span class="st">                   from rental r </span></a>
<a class="sourceLine" id="cb740-4" data-line-number="4"><span class="st">                        left outer join payment p </span></a>
<a class="sourceLine" id="cb740-5" data-line-number="5"><span class="st">                          on r.rental_id = p.rental_id  </span></a>
<a class="sourceLine" id="cb740-6" data-line-number="6"><span class="st">                    where p.rental_id is null</span></a>
<a class="sourceLine" id="cb740-7" data-line-number="7"><span class="st">                 ;&quot;</span>)</a>
<a class="sourceLine" id="cb740-8" data-line-number="8"><span class="kw">head</span>(rs2)</a></code></pre></div>
<pre><code>##                                                                                                QUERY PLAN
## 1                                                       Aggregate  (cost=2086.78..2086.80 rows=1 width=8)
## 2                                             -&gt;  Merge Anti Join  (cost=0.57..2066.73 rows=8022 width=0)
## 3                                                                 Merge Cond: (r.rental_id = p.rental_id)
## 4              -&gt;  Index Only Scan using rental_pkey on rental r  (cost=0.29..1024.95 rows=16044 width=4)
## 5         -&gt;  Index Only Scan using idx_fk_rental_id on payment p  (cost=0.29..819.23 rows=14596 width=4)</code></pre>
<div class="sourceCode" id="cb742"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb742-1" data-line-number="1">rs3 &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb742-2" data-line-number="2">                <span class="st">&quot;explain select sum(f.rental_rate) open_amt,count(*) count</span></a>
<a class="sourceLine" id="cb742-3" data-line-number="3"><span class="st">                   from rental r </span></a>
<a class="sourceLine" id="cb742-4" data-line-number="4"><span class="st">                        left outer join payment p </span></a>
<a class="sourceLine" id="cb742-5" data-line-number="5"><span class="st">                          on r.rental_id = p.rental_id </span></a>
<a class="sourceLine" id="cb742-6" data-line-number="6"><span class="st">                        join inventory i</span></a>
<a class="sourceLine" id="cb742-7" data-line-number="7"><span class="st">                          on r.inventory_id = i.inventory_id</span></a>
<a class="sourceLine" id="cb742-8" data-line-number="8"><span class="st">                        join film f</span></a>
<a class="sourceLine" id="cb742-9" data-line-number="9"><span class="st">                          on i.film_id = f.film_id</span></a>
<a class="sourceLine" id="cb742-10" data-line-number="10"><span class="st">                    where p.rental_id is null</span></a>
<a class="sourceLine" id="cb742-11" data-line-number="11"><span class="st">                 ;&quot;</span>)</a>
<a class="sourceLine" id="cb742-12" data-line-number="12"><span class="kw">head</span>(rs3)</a></code></pre></div>
<pre><code>##                                                                  QUERY PLAN
## 1                        Aggregate  (cost=2353.64..2353.65 rows=1 width=40)
## 2                  -&gt;  Hash Join  (cost=205.14..2313.53 rows=8022 width=12)
## 3                                        Hash Cond: (i.film_id = f.film_id)
## 4                   -&gt;  Hash Join  (cost=128.64..2215.88 rows=8022 width=2)
## 5                              Hash Cond: (r.inventory_id = i.inventory_id)
## 6               -&gt;  Merge Anti Join  (cost=0.57..2066.73 rows=8022 width=4)</code></pre>
<div class="sourceCode" id="cb744"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb744-1" data-line-number="1">rs4 &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(con,</a>
<a class="sourceLine" id="cb744-2" data-line-number="2">                <span class="st">&quot;explain select c.customer_id,c.first_name,c.last_name,sum(f.rental_rate) open_amt,count(*) count</span></a>
<a class="sourceLine" id="cb744-3" data-line-number="3"><span class="st">                   from rental r </span></a>
<a class="sourceLine" id="cb744-4" data-line-number="4"><span class="st">                        left outer join payment p </span></a>
<a class="sourceLine" id="cb744-5" data-line-number="5"><span class="st">                          on r.rental_id = p.rental_id  </span></a>
<a class="sourceLine" id="cb744-6" data-line-number="6"><span class="st">                        join inventory i</span></a>
<a class="sourceLine" id="cb744-7" data-line-number="7"><span class="st">                          on r.inventory_id = i.inventory_id</span></a>
<a class="sourceLine" id="cb744-8" data-line-number="8"><span class="st">                        join film f</span></a>
<a class="sourceLine" id="cb744-9" data-line-number="9"><span class="st">                          on i.film_id = f.film_id</span></a>
<a class="sourceLine" id="cb744-10" data-line-number="10"><span class="st">                        join customer c</span></a>
<a class="sourceLine" id="cb744-11" data-line-number="11"><span class="st">                          on r.customer_id = c.customer_id</span></a>
<a class="sourceLine" id="cb744-12" data-line-number="12"><span class="st">                  where p.rental_id is null</span></a>
<a class="sourceLine" id="cb744-13" data-line-number="13"><span class="st">                  group by c.customer_id,c.first_name,c.last_name</span></a>
<a class="sourceLine" id="cb744-14" data-line-number="14"><span class="st">                  order by open_amt desc</span></a>
<a class="sourceLine" id="cb744-15" data-line-number="15"><span class="st">                 ;&quot;</span></a>
<a class="sourceLine" id="cb744-16" data-line-number="16">                )  </a>
<a class="sourceLine" id="cb744-17" data-line-number="17"><span class="kw">head</span>(rs4)</a></code></pre></div>
<pre><code>##                                                          QUERY PLAN
## 1                  Sort  (cost=2452.49..2453.99 rows=599 width=260)
## 2                               Sort Key: (sum(f.rental_rate)) DESC
## 3     -&gt;  HashAggregate  (cost=2417.37..2424.86 rows=599 width=260)
## 4                                          Group Key: c.customer_id
## 5         -&gt;  Hash Join  (cost=227.62..2357.21 rows=8022 width=232)
## 6                        Hash Cond: (r.customer_id = c.customer_id)</code></pre>
</div>
<div id="clean-up-2" class="section level2">
<h2><span class="header-section-number">30.2</span> Clean up</h2>
<div class="sourceCode" id="cb746"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb746-1" data-line-number="1"><span class="co"># dbRemoveTable(con, &quot;cars&quot;)</span></a>
<a class="sourceLine" id="cb746-2" data-line-number="2"><span class="co"># dbRemoveTable(con, &quot;mtcars&quot;)</span></a>
<a class="sourceLine" id="cb746-3" data-line-number="3"><span class="co"># dbRemoveTable(con, &quot;cust_movies&quot;)</span></a>
<a class="sourceLine" id="cb746-4" data-line-number="4"></a>
<a class="sourceLine" id="cb746-5" data-line-number="5"><span class="co"># diconnect from the db</span></a>
<a class="sourceLine" id="cb746-6" data-line-number="6"><span class="kw">dbDisconnect</span>(con)</a>
<a class="sourceLine" id="cb746-7" data-line-number="7"></a>
<a class="sourceLine" id="cb746-8" data-line-number="8"><span class="kw">sp_docker_stop</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<!--chapter:end:200-explain-queries.Rmd-->
</div>
</div>
<div id="chapter_sql-queries-breakdown" class="section level1">
<h1><span class="header-section-number">31</span> SQL queries broken down</h1>
<blockquote>
<p>This chapter has two separate topics: SQL execution steps and passing values to SQL statements. Do they belong together? Does the chapter have the right title?</p>
</blockquote>
<blockquote>
<p>This chapter explains:</p>
<ul>
<li>Some details about how SQL queries work behind the scenes</li>
<li>SQL queries are executed behind the scenes</li>
<li>You can pass values to SQL queries</li>
</ul>
</blockquote>
<p>These packages are called in almost every chapter of the book:</p>
<div class="sourceCode" id="cb747"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb747-1" data-line-number="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb747-2" data-line-number="2"><span class="kw">library</span>(DBI)</a>
<a class="sourceLine" id="cb747-3" data-line-number="3"><span class="kw">library</span>(RPostgres)</a>
<a class="sourceLine" id="cb747-4" data-line-number="4"><span class="kw">library</span>(glue)</a>
<a class="sourceLine" id="cb747-5" data-line-number="5"><span class="kw">require</span>(knitr)</a>
<a class="sourceLine" id="cb747-6" data-line-number="6"><span class="kw">library</span>(dbplyr)</a>
<a class="sourceLine" id="cb747-7" data-line-number="7"><span class="kw">library</span>(sqlpetr)</a></code></pre></div>
<p>Start up the <code>docker-pet</code> container</p>
<div class="sourceCode" id="cb748"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb748-1" data-line-number="1"><span class="kw">sp_docker_start</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<p>Connect to the database with R:</p>
<div class="sourceCode" id="cb749"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb749-1" data-line-number="1">con &lt;-<span class="st"> </span><span class="kw">sp_get_postgres_connection</span>(<span class="dt">user =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_USER_NAME&quot;</span>),</a>
<a class="sourceLine" id="cb749-2" data-line-number="2">                         <span class="dt">password =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_PASSWORD&quot;</span>),</a>
<a class="sourceLine" id="cb749-3" data-line-number="3">                         <span class="dt">dbname =</span> <span class="st">&quot;dvdrental&quot;</span>,</a>
<a class="sourceLine" id="cb749-4" data-line-number="4">                         <span class="dt">seconds_to_test =</span> <span class="dv">30</span>)</a></code></pre></div>
<div id="sql-execution-steps" class="section level2">
<h2><span class="header-section-number">31.1</span> SQL Execution Steps</h2>
<ul>
<li>Parse the incoming SQL query</li>
<li>Compile the SQL query</li>
<li>Plan/optimize the data acquisition path</li>
<li>Execute the optimized query / acquire and return data</li>
</ul>
<blockquote>
<p>how do those steps map to the following code?</p>
</blockquote>
<div class="sourceCode" id="cb750"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb750-1" data-line-number="1"><span class="kw">dbWriteTable</span>(con, <span class="st">&quot;mtcars&quot;</span>, mtcars, <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb750-2" data-line-number="2"></a>
<a class="sourceLine" id="cb750-3" data-line-number="3">rs &lt;-<span class="st"> </span><span class="kw">dbSendQuery</span>(con, <span class="st">&quot;SELECT * FROM mtcars WHERE cyl = 4&quot;</span>)</a>
<a class="sourceLine" id="cb750-4" data-line-number="4"><span class="kw">dbFetch</span>(rs)</a></code></pre></div>
<pre><code>##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1  22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
## 2  24.4   4 146.7  62 3.69 3.190 20.00  1  0    4    2
## 3  22.8   4 140.8  95 3.92 3.150 22.90  1  0    4    2
## 4  32.4   4  78.7  66 4.08 2.200 19.47  1  1    4    1
## 5  30.4   4  75.7  52 4.93 1.615 18.52  1  1    4    2
## 6  33.9   4  71.1  65 4.22 1.835 19.90  1  1    4    1
## 7  21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
## 8  27.3   4  79.0  66 4.08 1.935 18.90  1  1    4    1
## 9  26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
## 10 30.4   4  95.1 113 3.77 1.513 16.90  1  1    5    2
## 11 21.4   4 121.0 109 4.11 2.780 18.60  1  1    4    2</code></pre>
<div class="sourceCode" id="cb752"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb752-1" data-line-number="1"><span class="kw">dbClearResult</span>(rs)</a></code></pre></div>
</div>
<div id="passing-values-to-sql-statements" class="section level2">
<h2><span class="header-section-number">31.2</span> Passing values to SQL statements</h2>
<div class="sourceCode" id="cb753"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb753-1" data-line-number="1"><span class="co">#Pass one set of values with the param argument:</span></a>
<a class="sourceLine" id="cb753-2" data-line-number="2">rs &lt;-<span class="st"> </span><span class="kw">dbSendQuery</span>(con,<span class="st">&quot;SELECT * FROM mtcars WHERE cyl = 4&quot;</span>)</a>
<a class="sourceLine" id="cb753-3" data-line-number="3"><span class="kw">dbFetch</span>(rs)</a></code></pre></div>
<pre><code>##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1  22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
## 2  24.4   4 146.7  62 3.69 3.190 20.00  1  0    4    2
## 3  22.8   4 140.8  95 3.92 3.150 22.90  1  0    4    2
## 4  32.4   4  78.7  66 4.08 2.200 19.47  1  1    4    1
## 5  30.4   4  75.7  52 4.93 1.615 18.52  1  1    4    2
## 6  33.9   4  71.1  65 4.22 1.835 19.90  1  1    4    1
## 7  21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
## 8  27.3   4  79.0  66 4.08 1.935 18.90  1  1    4    1
## 9  26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
## 10 30.4   4  95.1 113 3.77 1.513 16.90  1  1    5    2
## 11 21.4   4 121.0 109 4.11 2.780 18.60  1  1    4    2</code></pre>
<div class="sourceCode" id="cb755"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb755-1" data-line-number="1"><span class="kw">dbClearResult</span>(rs)</a></code></pre></div>
</div>
<div id="pass-multiple-sets-of-values-with-dbbind" class="section level2">
<h2><span class="header-section-number">31.3</span> Pass multiple sets of values with dbBind():</h2>
<div class="sourceCode" id="cb756"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb756-1" data-line-number="1">rs &lt;-<span class="st"> </span><span class="kw">dbSendQuery</span>(con, <span class="st">&quot;SELECT * FROM mtcars WHERE cyl = $1&quot;</span>)</a>
<a class="sourceLine" id="cb756-2" data-line-number="2"><span class="kw">dbBind</span>(rs, <span class="kw">list</span>(6L)) <span class="co"># cyl = 6</span></a>
<a class="sourceLine" id="cb756-3" data-line-number="3"><span class="kw">dbFetch</span>(rs)</a></code></pre></div>
<pre><code>##    mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
## 3 21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
## 4 18.1   6 225.0 105 2.76 3.460 20.22  1  0    3    1
## 5 19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
## 6 17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
## 7 19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6</code></pre>
<div class="sourceCode" id="cb758"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb758-1" data-line-number="1"><span class="kw">dbBind</span>(rs, <span class="kw">list</span>(8L)) <span class="co"># cyl = 8</span></a>
<a class="sourceLine" id="cb758-2" data-line-number="2"><span class="kw">dbFetch</span>(rs)</a></code></pre></div>
<pre><code>##     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1  18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
## 2  14.3   8 360.0 245 3.21 3.570 15.84  0  0    3    4
## 3  16.4   8 275.8 180 3.07 4.070 17.40  0  0    3    3
## 4  17.3   8 275.8 180 3.07 3.730 17.60  0  0    3    3
## 5  15.2   8 275.8 180 3.07 3.780 18.00  0  0    3    3
## 6  10.4   8 472.0 205 2.93 5.250 17.98  0  0    3    4
## 7  10.4   8 460.0 215 3.00 5.424 17.82  0  0    3    4
## 8  14.7   8 440.0 230 3.23 5.345 17.42  0  0    3    4
## 9  15.5   8 318.0 150 2.76 3.520 16.87  0  0    3    2
## 10 15.2   8 304.0 150 3.15 3.435 17.30  0  0    3    2
## 11 13.3   8 350.0 245 3.73 3.840 15.41  0  0    3    4
## 12 19.2   8 400.0 175 3.08 3.845 17.05  0  0    3    2
## 13 15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
## 14 15.0   8 301.0 335 3.54 3.570 14.60  0  1    5    8</code></pre>
<div class="sourceCode" id="cb760"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb760-1" data-line-number="1"><span class="kw">dbClearResult</span>(rs)</a></code></pre></div>
</div>
<div id="clean-up-3" class="section level2">
<h2><span class="header-section-number">31.4</span> Clean up</h2>
<div class="sourceCode" id="cb761"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb761-1" data-line-number="1"><span class="co"># dbRemoveTable(con, &quot;cars&quot;)</span></a>
<a class="sourceLine" id="cb761-2" data-line-number="2"><span class="kw">dbRemoveTable</span>(con, <span class="st">&quot;mtcars&quot;</span>)</a>
<a class="sourceLine" id="cb761-3" data-line-number="3"><span class="co"># dbRemoveTable(con, &quot;cust_movies&quot;)</span></a>
<a class="sourceLine" id="cb761-4" data-line-number="4"></a>
<a class="sourceLine" id="cb761-5" data-line-number="5"><span class="co"># diconnect from the db</span></a>
<a class="sourceLine" id="cb761-6" data-line-number="6"><span class="kw">dbDisconnect</span>(con)</a>
<a class="sourceLine" id="cb761-7" data-line-number="7"></a>
<a class="sourceLine" id="cb761-8" data-line-number="8"><span class="kw">sp_docker_stop</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<!--chapter:end:210-sql-query-steps.Rmd-->
</div>
</div>
<div id="chapter_writing-to-the-dbms" class="section level1">
<h1><span class="header-section-number">32</span> Writing to the DBMS</h1>
<p>This chapter demonstrates how to:</p>
<blockquote>
<ul>
<li>Set up and connect to a <code>cattle</code> database</li>
<li>Create, modify, and remove a database table</li>
</ul>
</blockquote>
<p>In a corporate setting, you may be creating your own tables or modifying existing tables less frequently than retrieving data. Nevertheless, in our sandbox you can easily do so.</p>
<p>The following packages are used in this chapter:</p>
<div class="sourceCode" id="cb762"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb762-1" data-line-number="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb762-2" data-line-number="2"><span class="kw">library</span>(DBI)</a>
<a class="sourceLine" id="cb762-3" data-line-number="3"><span class="kw">library</span>(RPostgres)</a>
<a class="sourceLine" id="cb762-4" data-line-number="4"><span class="kw">require</span>(knitr)</a>
<a class="sourceLine" id="cb762-5" data-line-number="5"><span class="kw">library</span>(sqlpetr)</a></code></pre></div>
<div id="set-up-a-cattle-container" class="section level2">
<h2><span class="header-section-number">32.1</span> Set up a <code>cattle</code> container</h2>
<p>Check that Docker is up and running:</p>
<div class="sourceCode" id="cb763"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb763-1" data-line-number="1"><span class="kw">sp_check_that_docker_is_up</span>()</a></code></pre></div>
<pre><code>## [1] &quot;Docker is up but running no containers&quot;</code></pre>
<div id="remove-previous-containers-if-they-exist-1" class="section level3">
<h3><span class="header-section-number">32.1.1</span> Remove previous containers if they exist</h3>
<p>Remove the <code>cattle</code> and <code>sql-pet</code> containers if they exist (e.g., from prior experiments).</p>
<div class="sourceCode" id="cb765"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb765-1" data-line-number="1"><span class="kw">sp_docker_remove_container</span>(<span class="st">&quot;cattle&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb767"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb767-1" data-line-number="1"><span class="kw">sp_docker_remove_container</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<p>Create a new <code>cattle</code> container:</p>
<div class="sourceCode" id="cb769"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb769-1" data-line-number="1"><span class="kw">sp_make_simple_pg</span>(<span class="st">&quot;cattle&quot;</span>)</a></code></pre></div>
<p>Show that we’re ready to connect:</p>
<div class="sourceCode" id="cb770"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb770-1" data-line-number="1"><span class="kw">sp_check_that_docker_is_up</span>()</a></code></pre></div>
<pre><code>## [1] &quot;Docker is up, running these containers:&quot;                                                                                                       
## [2] &quot;CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                  PORTS                    NAMES&quot;   
## [3] &quot;a4639b6d530b        postgres:10         \&quot;docker-entrypoint.s…\&quot;   1 second ago        Up Less than a second   0.0.0.0:5432-&gt;5432/tcp   cattle&quot;</code></pre>
</div>
<div id="connect-to-postgresql" class="section level3">
<h3><span class="header-section-number">32.1.2</span> Connect to PostgreSQL</h3>
<p>Connect to PostgreSQL using the <code>sp_get_postgres_connection</code> function:</p>
<div class="sourceCode" id="cb772"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb772-1" data-line-number="1">con &lt;-<span class="st"> </span><span class="kw">sp_get_postgres_connection</span>(<span class="dt">user =</span> <span class="st">&quot;postgres&quot;</span>,</a>
<a class="sourceLine" id="cb772-2" data-line-number="2">                         <span class="dt">password =</span> <span class="st">&quot;postgres&quot;</span>,</a>
<a class="sourceLine" id="cb772-3" data-line-number="3">                         <span class="dt">dbname =</span> <span class="st">&quot;postgres&quot;</span>,</a>
<a class="sourceLine" id="cb772-4" data-line-number="4">                         <span class="dt">seconds_to_test =</span> <span class="dv">30</span>)</a></code></pre></div>
</div>
</div>
<div id="interact-with-postgresql-1" class="section level2">
<h2><span class="header-section-number">32.2</span> Interact with PostgreSQL</h2>
<p>Check on the contents of the database.</p>
<div class="sourceCode" id="cb773"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb773-1" data-line-number="1">DBI<span class="op">::</span><span class="kw">dbListTables</span>(con)</a></code></pre></div>
<pre><code>## character(0)</code></pre>
<p>It does not contain any tables yet.</p>
<div id="create-a-new-table-in-the-database" class="section level3">
<h3><span class="header-section-number">32.2.1</span> Create a new table in the database</h3>
<p>This is an example from the DBI help file using the “cars” built-in dataset, not to be confused with mtcars:</p>
<div class="sourceCode" id="cb775"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb775-1" data-line-number="1"><span class="kw">dbWriteTable</span>(con, <span class="st">&quot;cars&quot;</span>, <span class="kw">head</span>(cars, <span class="dv">3</span>)) <span class="co">#</span></a></code></pre></div>
<p>The <code>cars</code> table has 3 rows:</p>
<div class="sourceCode" id="cb776"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb776-1" data-line-number="1"><span class="kw">dbReadTable</span>(con, <span class="st">&quot;cars&quot;</span>)  </a></code></pre></div>
<pre><code>##   speed dist
## 1     4    2
## 2     4   10
## 3     7    4</code></pre>
</div>
<div id="modify-an-existing-table" class="section level3">
<h3><span class="header-section-number">32.2.2</span> Modify an existing table</h3>
<p>To add additional rows or instances to the “cars” table, we will use INSERT command with their values.</p>
<p>There are two different ways of adding values: list them or pass values using the param argument.</p>
<div class="sourceCode" id="cb778"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb778-1" data-line-number="1"><span class="kw">dbExecute</span>(</a>
<a class="sourceLine" id="cb778-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb778-3" data-line-number="3">  <span class="st">&quot;INSERT INTO cars (speed, dist) VALUES (1, 1), (2, 2), (3, 3)&quot;</span></a>
<a class="sourceLine" id="cb778-4" data-line-number="4">)</a></code></pre></div>
<pre><code>## [1] 3</code></pre>
<p>Now it has 6 rows:</p>
<div class="sourceCode" id="cb780"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb780-1" data-line-number="1"><span class="kw">dbReadTable</span>(con, <span class="st">&quot;cars&quot;</span>)</a></code></pre></div>
<pre><code>##   speed dist
## 1     4    2
## 2     4   10
## 3     7    4
## 4     1    1
## 5     2    2
## 6     3    3</code></pre>
<p>Pass values using the param argument:</p>
<div class="sourceCode" id="cb782"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb782-1" data-line-number="1"><span class="kw">dbExecute</span>(</a>
<a class="sourceLine" id="cb782-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb782-3" data-line-number="3">  <span class="st">&quot;INSERT INTO cars (speed, dist) VALUES ($1, $2)&quot;</span>,</a>
<a class="sourceLine" id="cb782-4" data-line-number="4">  <span class="dt">param =</span> <span class="kw">list</span>(<span class="dv">4</span><span class="op">:</span><span class="dv">7</span>, <span class="dv">5</span><span class="op">:</span><span class="dv">8</span>)</a>
<a class="sourceLine" id="cb782-5" data-line-number="5">)</a></code></pre></div>
<pre><code>## [1] 4</code></pre>
<p>Now there are 10 rows:</p>
<div class="sourceCode" id="cb784"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb784-1" data-line-number="1"><span class="kw">dbReadTable</span>(con, <span class="st">&quot;cars&quot;</span>)</a></code></pre></div>
<pre><code>##    speed dist
## 1      4    2
## 2      4   10
## 3      7    4
## 4      1    1
## 5      2    2
## 6      3    3
## 7      4    5
## 8      5    6
## 9      6    7
## 10     7    8</code></pre>
</div>
<div id="remove-the-table" class="section level3">
<h3><span class="header-section-number">32.2.3</span> Remove the table</h3>
<p>Remove the “cars” table.</p>
<div class="sourceCode" id="cb786"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb786-1" data-line-number="1"><span class="kw">dbRemoveTable</span>(con, <span class="st">&quot;cars&quot;</span>)</a></code></pre></div>
</div>
</div>
<div id="clean-up-4" class="section level2">
<h2><span class="header-section-number">32.3</span> Clean up</h2>
<p>Disconnect from the database:</p>
<div class="sourceCode" id="cb787"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb787-1" data-line-number="1"><span class="kw">dbDisconnect</span>(con)</a></code></pre></div>
<p>Stop the <code>cattle</code> container, but leave it around for future use.</p>
<div class="sourceCode" id="cb788"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb788-1" data-line-number="1"><span class="kw">sp_docker_stop</span>(<span class="st">&quot;cattle&quot;</span>)</a></code></pre></div>
<!--chapter:end:220-write-to-the-database.Rmd-->
</div>
</div>
<div id="appendix-appendices" class="section level1 unnumbered">
<h1>(APPENDIX) Appendices</h1>
<!--chapter:end:900-appendices-section.Rmd-->
</div>
<div id="chapter_appendix-setup-instructions" class="section level1">
<h1><span class="header-section-number">33</span> Appendix A - Setup instructions</h1>
<blockquote>
<p>This appendix explains:</p>
<ul>
<li>Hardware and software prerequisites for setting up the sandbox used in this book</li>
<li>Documentation for all of the elements used in this sandbox</li>
</ul>
</blockquote>
<div id="sandbox-prerequisites" class="section level2">
<h2><span class="header-section-number">33.1</span> Sandbox prerequisites</h2>
<p>The sandbox environment requires:</p>
<ul>
<li>A computer running
<ul>
<li>Windows (Windows 7 64-bit or later - Windows 10-Pro is recommended),</li>
<li>MacOS, or</li>
<li>Linux (any Linux distro that will run Docker Community Edition, R and RStudio will work)</li>
</ul></li>
<li>Current versions of <a href="https://www.datacamp.com/community/tutorials/installing-R-windows-mac-ubuntu">R and RStudio</a> [<span class="citation">Vargas (<a href="#ref-Vargas2018">2018</a>)</span>) required.</li>
<li>Docker (instructions below)</li>
<li>Our companion package <code>sqlpetr</code> <span class="citation">(Borasky et al. <a href="#ref-Borasky2018a">2018</a>)</span></li>
</ul>
<p>The database we use is PostgreSQL 10, but you do not need to install it - it’s installed via a Docker image.</p>
<p>In addition to the current version of R and RStudio, you will need current versions of the following packages:</p>
<ul>
<li><code>DBI</code> <span class="citation">(R Special Interest Group on Databases (R-SIG-DB), Wickham, and Müller <a href="#ref-R-DBI">2018</a>)</span></li>
<li><code>DiagrammeR</code> <span class="citation">(Iannone <a href="#ref-R-DiagrammeR">2018</a>)</span></li>
<li><code>RPostgres</code> <span class="citation">(Wickham, Ooms, and Müller <a href="#ref-R-RPostgres">2018</a>)</span></li>
<li><code>dbplyr</code> <span class="citation">(Wickham and Ruiz <a href="#ref-R-dbplyr">2019</a>)</span></li>
<li><code>devtools</code> <span class="citation">(Wickham, Hester, and Chang <a href="#ref-R-devtools">2018</a>)</span></li>
<li><code>downloader</code> <span class="citation">(Chang <a href="#ref-R-downloader">2015</a>)</span></li>
<li><code>glue</code> <span class="citation">(Hester <a href="#ref-R-glue">2018</a>)</span></li>
<li><code>here</code> <span class="citation">(Müller <a href="#ref-R-here">2017</a>)</span></li>
<li><code>knitr</code> <span class="citation">(Xie <a href="#ref-R-knitr">2018</a><a href="#ref-R-knitr">b</a>)</span></li>
<li><code>skimr</code> <span class="citation">(McNamara et al. <a href="#ref-R-skimr">2019</a>)</span></li>
<li><p><code>tidyverse</code> <span class="citation">(Wickham <a href="#ref-R-tidyverse">2017</a>)</span></p></li>
<li><p><code>bookdown</code> <span class="citation">(Xie <a href="#ref-R-bookdown">2018</a><a href="#ref-R-bookdown">a</a>)</span> (for compiling the book, if you want to)</p></li>
</ul>
</div>
<div id="r-rstudio-and-git" class="section level2">
<h2><span class="header-section-number">33.2</span> R, RStudio and Git</h2>
<p>Most readers will probably have these already, but if not:</p>
<ol style="list-style-type: decimal">
<li>If you do not have R:
<ul>
<li>Go to <a href="https://cran.rstudio.com/" class="uri">https://cran.rstudio.com/</a> <span class="citation">(R Core Team <a href="#ref-RCT2018">2018</a>)</span>.</li>
<li>Select the download link for your system. For Linux, choose your distro. We recommend Ubuntu 18.04 LTS “Bionic Beaver”. It’s much easier to find support answers on the web for Ubuntu than other distros.</li>
<li>Follow the instructions.</li>
<li>Note: if you already have R, make sure it’s upgraded to R 3.5.1. We don’t test on older versions!</li>
</ul></li>
<li>If you do not have RStudio: go to <a href="https://www.rstudio.com/products/rstudio/download/#download" class="uri">https://www.rstudio.com/products/rstudio/download/#download</a>. Make sure you have version 1.1.463 or later.</li>
<li>If you do not have Git:
<ul>
<li>On Windows, go to <a href="https://git-scm.com/download/win" class="uri">https://git-scm.com/download/win</a> and follow instructions. There are a lot of options. Just pick the defaults!!!</li>
<li>On MacOS, go to <a href="https://sourceforge.net/projects/git-osx-installer/files/" class="uri">https://sourceforge.net/projects/git-osx-installer/files/</a> and follow instructions.</li>
<li>On Linux, install Git from your distribution.</li>
</ul></li>
</ol>
</div>
<div id="install-docker" class="section level2">
<h2><span class="header-section-number">33.3</span> Install Docker</h2>
<p>Installation depends on your operating system and we have found that it can be somewhat intricate. You will need Docker Community Edition (Docker CE):</p>
<ul>
<li>For Windows, <a href="#windows-tech-details">consider these issues and follow these instructions</a>: Go to <a href="https://store.docker.com/editions/community/docker-ce-desktop-windows" class="uri">https://store.docker.com/editions/community/docker-ce-desktop-windows</a>. If you don’t have a Docker Store log in, you’ll need to create one. Then:
<ul>
<li>If you have Windows 10 Pro, download and install Docker for Windows.</li>
<li>If you have an older version of Windows, download and install Docker Toolbox (<a href="https://docs.docker.com/toolbox/overview/" class="uri">https://docs.docker.com/toolbox/overview/</a>).</li>
<li>Note that both versions require 64-bit hardware and the virtualization needs to be enabled in the firmware.</li>
</ul></li>
<li><a href="https://docs.docker.com/docker-for-mac/install/">On a Mac</a> <span class="citation">(Docker <a href="#ref-Docker2018c">2018</a><a href="#ref-Docker2018c">c</a>)</span>: Go to <a href="https://store.docker.com/editions/community/docker-ce-desktop-mac" class="uri">https://store.docker.com/editions/community/docker-ce-desktop-mac</a>. If you don’t have a Docker Store login, you’ll need to create one. Then download and install Docker for Mac. Your MacOS must be at least release Yosemite (10.10.3).</li>
<li><a href="https://docs.docker.com/install/#supported-platforms">On UNIX flavors</a> <span class="citation">(Docker <a href="#ref-Docker2018b">2018</a><a href="#ref-Docker2018b">a</a>)</span>: note that, as with Windows and MacOS, you’ll need a Docker Store loin. Although most Linux distros ship with some version of Docker, chances are it’s not the same as the official Docker CE version.
<ul>
<li>Ubuntu: <a href="https://store.docker.com/editions/community/docker-ce-server-ubuntu" class="uri">https://store.docker.com/editions/community/docker-ce-server-ubuntu</a>,</li>
<li>Fedora: <a href="https://store.docker.com/editions/community/docker-ce-server-fedora" class="uri">https://store.docker.com/editions/community/docker-ce-server-fedora</a>,</li>
<li>Cent OS: <a href="https://store.docker.com/editions/community/docker-ce-server-centos" class="uri">https://store.docker.com/editions/community/docker-ce-server-centos</a>,</li>
<li>Debian: <a href="https://store.docker.com/editions/community/docker-ce-server-debian" class="uri">https://store.docker.com/editions/community/docker-ce-server-debian</a>.</li>
</ul></li>
</ul>
<p><strong><em>Note that on Linux, you will need to be a member of the <code>docker</code> group to use Docker.</em></strong> To do that, execute <code>sudo usermod -aG docker ${USER}</code>. Then, log out and back in again.</p>
<!--chapter:end:910-setup-instructions.Rmd-->
</div>
</div>
<div id="chapter_windows-tech-details" class="section level1">
<h1><span class="header-section-number">34</span> Appendix B - Additional technical details for Windows users</h1>
<blockquote>
<p>This chapter explains:</p>
<ul>
<li>How to setup your environment for Windows</li>
<li>How to use Git and GitHub effectively on Windows</li>
</ul>
</blockquote>
<p>Skip these instructions if your computer has either OSX or a Unix variant.</p>
<div id="hardware-requirements" class="section level2">
<h2><span class="header-section-number">34.1</span> Hardware requirements</h2>
<p>You will need an Intel or AMD processor with 64-bit hardware and the hardware virtualization feature. Most machines you buy today will have that, but older ones may not. You will need to go into the BIOS / firmware and enable the virtualization feature. You will need at least 4 gigabytes of RAM!</p>
</div>
<div id="software-requirements" class="section level2">
<h2><span class="header-section-number">34.2</span> Software requirements</h2>
<p>You will need Windows 7 64-bit or later. If you can afford it, I highly recommend upgrading to Windows 10 Pro.</p>
<div id="windows-7-8-8.1-and-windows-10-home-64-bit" class="section level3">
<h3><span class="header-section-number">34.2.1</span> Windows 7, 8, 8.1 and Windows 10 Home (64 bit)</h3>
<p>Install Docker Toolbox. The instructions are here: <a href="https://docs.docker.com/toolbox/toolbox_install_windows/" class="uri">https://docs.docker.com/toolbox/toolbox_install_windows/</a>. Make sure you try the test cases and they work!</p>
</div>
<div id="windows-10-pro" class="section level3">
<h3><span class="header-section-number">34.2.2</span> Windows 10 Pro</h3>
<p>Install Docker for Windows <em>stable</em>. The instructions are here: <a href="https://docs.docker.com/docker-for-windows/install/#start-docker-for-windows" class="uri">https://docs.docker.com/docker-for-windows/install/#start-docker-for-windows</a>. Again, make sure you try the test cases and they work.</p>
</div>
</div>
<div id="docker-for-windows-settings" class="section level2">
<h2><span class="header-section-number">34.3</span> Docker for Windows settings</h2>
<div id="shared-drives" class="section level3">
<h3><span class="header-section-number">34.3.1</span> Shared drives</h3>
<p>If you’re going to mount host files into container file systems (as we do in the following chapters), you need to set up shared drives. Open the Docker settings dialog and select <code>Shared Drives</code>. Check the drives you want to share. In this screenshot, the <code>D:</code> drive is my 1 terabyte hard drive.</p>
<p><img src="screenshots/2018-08-26_15_16_51-Shared_Drives.png" width="90%" style="display: block; margin: auto;" /></p>
</div>
<div id="kubernetes" class="section level3">
<h3><span class="header-section-number">34.3.2</span> Kubernetes</h3>
<p>Kubernetes is a container orchestration / cloud management package that’s a major DevOps tool. It’s heavily supported by Red Hat and Google, and as a result is becoming a required skill for DevOps.</p>
<p>However, it’s overkill for this project at the moment. So you should make sure it’s not enabled.</p>
<p>Go to the <code>Kubernetes</code> dialog and make sure the <code>Enable Kubernetes</code> checkbox is cleared.</p>
<p><img src="screenshots/2018-08-26_15_26_22-Kubernetes.png" width="90%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="git-github-and-line-endings" class="section level2">
<h2><span class="header-section-number">34.4</span> Git, GitHub and line endings</h2>
<p><a href="https://git-scm.com/">Git</a> was originally developed for Linux - in fact, it was created by Linus Torvalds to manage hundreds of different versions of the Linux kernel on different machines all around the world. As usage has grown, Git has achieved a huge following and is the version control system used by most large open source projects, including this one.</p>
<p>If you’re on Windows, there are some things about Git and GitHub you need to watch. First of all, there are quite a few tools for running Git on Windows, but the RStudio default and recommended one is Git for Windows (<a href="https://git-scm.com/download/win" class="uri">https://git-scm.com/download/win</a>).</p>
<p>By default, text files on Linux end with a single linefeed (<code>\n</code>) character. But on Windows, text files end with a carriage return and a line feed (<code>\r\n</code>). See <a href="https://en.wikipedia.org/wiki/Newline" class="uri">https://en.wikipedia.org/wiki/Newline</a> for the gory details.</p>
<p>Git defaults to checking files out in the native mode. So if you’re on Linux, a text file will show up with the Linux convention, and if you’re on Windows, it will show up with the Windows convention.</p>
<p>Most of the time this doesn’t cause any problems. But Docker containers usually run Linux, and if you have files from a repository on Windows that you’ve sent to the container, the container may malfunction or give weird results. <em>This kind of situation has caused a lot of grief for contributors to this project, so beware.</em></p>
<p>In particular, executable <code>sh</code> or <code>bash</code> scripts will fail in a Docker container if they have Windows line endings. You may see an error message with <code>\r</code> in it, which means the shell saw the carriage return (<code>\r</code>) and gave up. But often you’ll see no hint at all what the problem was.</p>
<p>So you need a way to tell Git that some files need to be checked out with Linux line endings. See <a href="https://help.github.com/articles/dealing-with-line-endings/" class="uri">https://help.github.com/articles/dealing-with-line-endings/</a> for the details. Summary:</p>
<ol style="list-style-type: decimal">
<li>You’ll need a <code>.gitattributes</code> file in the root of the repository.</li>
<li>In that file, all text files (scripts, program source, data, etc.) that are destined for a Docker container will need to have the designator <code>&lt;spec&gt; text eol=lf</code>, where <code>&lt;spec&gt;</code> is the file name specifier, for example, <code>*.sh</code>.</li>
</ol>
<p>This repo includes a sample: <a href="https://github.com/smithjd/sql-pet/blob/master/.gitattributes">.gitattributes</a></p>
<!--chapter:end:920-windows-tech-details.Rmd-->
</div>
</div>
<div id="chapter_appendix-postresql-authentication" class="section level1">
<h1><span class="header-section-number">35</span> Appendix C - PostgreSQL Authentication</h1>
<div id="introduction" class="section level2">
<h2><span class="header-section-number">35.1</span> Introduction</h2>
<p>PostgreSQL has a very robust and flexible set of authentication methods <span class="citation">(PostgreSQL Global Development Group <a href="#ref-PGDG2018a">2018</a><a href="#ref-PGDG2018a">a</a>)</span>. In most production environments, these will be managed by the database administrator (DBA) on a need-to-access basis. People and programs will be granted access only to a minimum set of capabilities required to function, and nothing more.</p>
<p>In this book, we are using a PostgreSQL Docker image <span class="citation">(Docker <a href="#ref-Docker2018">2018</a><a href="#ref-Docker2018">d</a>)</span>. When we create a container from that image, we use its native mechanism to create the <code>postgres</code> database superuser with a password specified in an R environment file <code>~/.Renviron</code>. See <a href="#chapter_dbms-login-credentials">Securing and using your dbms log-in credentials</a> for how we do this.</p>
<p>What that means is that you are the DBA - the database superuser - for the PostgreSQL database cluster running in the container! You can create and destroy databases, schemas, tables, views, etc. You can also create and destroy users - called <code>roles</code> in PostgreSQL, and <code>GRANT</code> or <code>REVOKE</code> their privileges with great precision.</p>
<p>You don’t have to do that to use this book. But if you want to experiment with it, feel free!</p>
</div>
<div id="password-authentication-on-the-postgresql-docker-image" class="section level2">
<h2><span class="header-section-number">35.2</span> Password authentication on the PostgreSQL Docker image</h2>
<p>Of the many PostgreSQL authentication mechanisms, the simplest that’s universallly available is <code>password authentication</code> <span class="citation">(PostgreSQL Global Development Group <a href="#ref-PGDG2018b">2018</a><a href="#ref-PGDG2018b">c</a>)</span>. That’s what we use for the <code>postgres</code> database superuser, and what we recommend for any roles you may create.</p>
<p>Once a role has been created, you need five items to open a connection to the PostgreSQL database cluster:</p>
<ol style="list-style-type: decimal">
<li>The <code>host</code>. This is a name or IP address that your network can access. In this book, with the database running in a Docker container, that’s usually <code>localhost</code>.</li>
<li>The <code>port</code>. This is the port the server is listening on. It’s usually the default, <code>5432</code>, and that’s what we use. But in a secure environment, it will often be some random number to lower the chances that an attacker can find the database server. And if you have more than one server on the network, you’ll need to use different ports for each of them.</li>
<li>The <code>dbname</code> to connect to. This database must exist or the connection attempt will fail.</li>
<li>The <code>user</code>. This user must exist in the database cluster and be allowed to access the database. We are using the database superuser <code>postgres</code> in this book.</li>
<li>The <code>password</code>. This is set by the DBA for the user. In this book we use the password defined in <a href="#chapter_dbms-login-credentials">Securing and using your dbms log-in credentials</a>.</li>
</ol>
</div>
<div id="adding-roles" class="section level2">
<h2><span class="header-section-number">35.3</span> Adding roles</h2>
<p>As noted above, PostgreSQL has a very flexible fine-grained access permissions system. We can’t cover all of it; see <span class="citation">PostgreSQL Global Development Group (<a href="#ref-PGDG2018c">2018</a><a href="#ref-PGDG2018c">b</a>)</span> for the full details. But we can give an example.</p>
<div id="setting-up-docker" class="section level3">
<h3><span class="header-section-number">35.3.1</span> Setting up Docker</h3>
<p>First, we need to make sure we don’t have any other databases listening on the default port <code>5432</code>.</p>
<div class="sourceCode" id="cb789"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb789-1" data-line-number="1">sqlpetr<span class="op">::</span><span class="kw">sp_check_that_docker_is_up</span>()</a></code></pre></div>
<pre><code>## [1] &quot;Docker is up but running no containers&quot;</code></pre>
<div class="sourceCode" id="cb791"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb791-1" data-line-number="1">sqlpetr<span class="op">::</span><span class="kw">sp_docker_remove_container</span>(<span class="st">&quot;cattle&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb793"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb793-1" data-line-number="1">sqlpetr<span class="op">::</span><span class="kw">sp_docker_remove_container</span>(<span class="st">&quot;sql-pet&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb795"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb795-1" data-line-number="1"><span class="co"># sqlpetr::sp_docker_stop(&quot;sql-pet&quot;)</span></a></code></pre></div>
</div>
<div id="creating-a-new-container" class="section level3">
<h3><span class="header-section-number">35.3.2</span> Creating a new container</h3>
<p>We’ll create a “cattle” container with a default PostgreSQL 10 database cluster.</p>
<div class="sourceCode" id="cb796"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb796-1" data-line-number="1">sqlpetr<span class="op">::</span><span class="kw">sp_make_simple_pg</span>(<span class="st">&quot;cattle&quot;</span>)</a>
<a class="sourceLine" id="cb796-2" data-line-number="2"></a>
<a class="sourceLine" id="cb796-3" data-line-number="3">cattle_conn &lt;-<span class="st"> </span>sqlpetr<span class="op">::</span><span class="kw">sp_get_postgres_connection</span>(</a>
<a class="sourceLine" id="cb796-4" data-line-number="4">  <span class="dt">host =</span> <span class="st">&quot;localhost&quot;</span>,</a>
<a class="sourceLine" id="cb796-5" data-line-number="5">  <span class="dt">port =</span> <span class="dv">5432</span>,</a>
<a class="sourceLine" id="cb796-6" data-line-number="6">  <span class="dt">dbname =</span> <span class="st">&quot;postgres&quot;</span>,</a>
<a class="sourceLine" id="cb796-7" data-line-number="7">  <span class="dt">user =</span> <span class="st">&quot;postgres&quot;</span>,</a>
<a class="sourceLine" id="cb796-8" data-line-number="8">  <span class="dt">password =</span> <span class="st">&quot;postgres&quot;</span>,</a>
<a class="sourceLine" id="cb796-9" data-line-number="9">  <span class="dt">seconds_to_test =</span> <span class="dv">30</span></a>
<a class="sourceLine" id="cb796-10" data-line-number="10">)</a></code></pre></div>
</div>
<div id="adding-a-role" class="section level3">
<h3><span class="header-section-number">35.3.3</span> Adding a role</h3>
<p>Now, let’s add a role. We’ll add a role that can log in and create databases, but isn’t a superuser. Since this is a demo and not a real production database cluster, we’ll specify a password in plaintext. And we’ll create a database for our new user.</p>
<p>Create the role:</p>
<div class="sourceCode" id="cb797"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb797-1" data-line-number="1"><span class="kw">CREATE</span> <span class="kw">ROLE</span> charlie LOGIN CREATEDB <span class="kw">PASSWORD</span> <span class="st">&#39;chaplin&#39;</span>;</a></code></pre></div>
<p>Create the database:</p>
<div class="sourceCode" id="cb798"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb798-1" data-line-number="1"><span class="kw">CREATE</span> <span class="kw">DATABASE</span> charlie OWNER = charlie;</a></code></pre></div>
</div>
<div id="did-it-work" class="section level3">
<h3><span class="header-section-number">35.3.4</span> Did it work?</h3>
<div class="sourceCode" id="cb799"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb799-1" data-line-number="1">DBI<span class="op">::</span><span class="kw">dbDisconnect</span>(cattle_conn)</a>
<a class="sourceLine" id="cb799-2" data-line-number="2"></a>
<a class="sourceLine" id="cb799-3" data-line-number="3">cattle_conn &lt;-<span class="st"> </span>sqlpetr<span class="op">::</span><span class="kw">sp_get_postgres_connection</span>(</a>
<a class="sourceLine" id="cb799-4" data-line-number="4">  <span class="dt">host =</span> <span class="st">&quot;localhost&quot;</span>,</a>
<a class="sourceLine" id="cb799-5" data-line-number="5">  <span class="dt">port =</span> <span class="dv">5432</span>,</a>
<a class="sourceLine" id="cb799-6" data-line-number="6">  <span class="dt">dbname =</span> <span class="st">&quot;charlie&quot;</span>,</a>
<a class="sourceLine" id="cb799-7" data-line-number="7">  <span class="dt">user =</span> <span class="st">&quot;charlie&quot;</span>,</a>
<a class="sourceLine" id="cb799-8" data-line-number="8">  <span class="dt">password =</span> <span class="st">&quot;chaplin&quot;</span>,</a>
<a class="sourceLine" id="cb799-9" data-line-number="9">  <span class="dt">seconds_to_test =</span> <span class="dv">30</span></a>
<a class="sourceLine" id="cb799-10" data-line-number="10">)</a>
<a class="sourceLine" id="cb799-11" data-line-number="11"><span class="kw">print</span>(cattle_conn)</a></code></pre></div>
<pre><code>## &lt;PqConnection&gt; charlie@localhost:5432</code></pre>
<p>OK, we can connect. Let’s do some stuff!</p>
<div class="sourceCode" id="cb801"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb801-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;iris&quot;</span>)</a></code></pre></div>
<p><code>dbCreateTable</code> creates the table with columns matching the data frame. But it does not send data to the table.</p>
<div class="sourceCode" id="cb802"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb802-1" data-line-number="1">DBI<span class="op">::</span><span class="kw">dbCreateTable</span>(cattle_conn, <span class="st">&quot;iris&quot;</span>, iris)</a></code></pre></div>
<p>To send data, we use <code>dbAppendTable</code>.</p>
<div class="sourceCode" id="cb803"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb803-1" data-line-number="1">DBI<span class="op">::</span><span class="kw">dbAppendTable</span>(cattle_conn, <span class="st">&quot;iris&quot;</span>, iris)</a></code></pre></div>
<pre><code>## Warning: Factors converted to character</code></pre>
<pre><code>## [1] 150</code></pre>
<div class="sourceCode" id="cb806"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb806-1" data-line-number="1">DBI<span class="op">::</span><span class="kw">dbListTables</span>(cattle_conn)</a></code></pre></div>
<pre><code>## [1] &quot;iris&quot;</code></pre>
<div class="sourceCode" id="cb808"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb808-1" data-line-number="1"><span class="kw">head</span>(DBI<span class="op">::</span><span class="kw">dbReadTable</span>(cattle_conn, <span class="st">&quot;iris&quot;</span>))</a></code></pre></div>
<pre><code>##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 1          5.1         3.5          1.4         0.2  setosa
## 2          4.9         3.0          1.4         0.2  setosa
## 3          4.7         3.2          1.3         0.2  setosa
## 4          4.6         3.1          1.5         0.2  setosa
## 5          5.0         3.6          1.4         0.2  setosa
## 6          5.4         3.9          1.7         0.4  setosa</code></pre>
<div class="sourceCode" id="cb810"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb810-1" data-line-number="1">DBI<span class="op">::</span><span class="kw">dbDisconnect</span>(cattle_conn)</a></code></pre></div>
</div>
<div id="remove-the-container" class="section level3">
<h3><span class="header-section-number">35.3.5</span> Remove the container</h3>
<div class="sourceCode" id="cb811"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb811-1" data-line-number="1">sqlpetr<span class="op">::</span><span class="kw">sp_docker_remove_container</span>(<span class="st">&quot;cattle&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<!--chapter:end:930-postgresql-authentication.Rmd-->
</div>
</div>
</div>
<div id="chapter_appendix-sql-quick-guide" class="section level1">
<h1><span class="header-section-number">36</span> APPENDIX D - Quick Guide to SQL</h1>
<p>SQL stands for Structured Query Language. It is a database language where we can perform certain operations on the existing database and we can use it create a new database. There are four main categories where the SQL commands fall into: DML, DDL, DCL, and TCL.</p>
<div id="data-manipulation-langauge-dml" class="section level2">
<h2><span class="header-section-number">36.1</span> Data Manipulation Langauge (DML)</h2>
<p>These four SQL commands deal with the manipulation of data in the database. For everyday analytical work, these are the commands that you will use the most.</p>
<pre><code>1. SELECT
2. INSERT
3. UPDATE
4. DELETE</code></pre>
</div>
<div id="data-definition-langauge-ddl" class="section level2">
<h2><span class="header-section-number">36.2</span> Data Definition Langauge (DDL)</h2>
<p>It consists of the SQL commands that can be used to define a database schema. The DDL commands include:</p>
<pre><code>1. CREATE 
2. ALTER
3. TRUNCATE
4. COMMENT
5. RENAME
6. DROP</code></pre>
</div>
<div id="data-control-language-dcl" class="section level2">
<h2><span class="header-section-number">36.3</span> Data Control Language (DCL)</h2>
<p>The DCL commands deals with user rights, permissions and other controls in database management system.</p>
<pre><code>1. GRANT
2. REVOKE</code></pre>
</div>
<div id="transaction-control-language-tcl" class="section level2">
<h2><span class="header-section-number">36.4</span> Transaction Control Language (TCL)</h2>
<p>These commands deal with the control over transaction within the database. Transaction combines a set of tasks into single execution.</p>
<pre><code>1. SET TRANSACTION
2. SAVEPOINT
3. ROLLBACK
4. COMMIT</code></pre>
<!--chapter:end:960-sqlguide.Rmd-->
</div>
</div>
<div id="chapter_appendix-dplyr-functions" class="section level1">
<h1><span class="header-section-number">37</span> Dplyr functions and SQL cross-walk</h1>
<p>Where are these covered and should they be included?</p>
<table style="width:100%;">
<colgroup>
<col width="26%" />
<col width="26%" />
<col width="26%" />
<col width="2%" />
<col width="18%" />
</colgroup>
<thead>
<tr class="header">
<th>Dplyr Function</th>
<th>description</th>
<th>SQL Clause</th>
<th>Where</th>
<th>Category</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>all_equal() <br />all.equal(<tbl_df>)</td>
<td>Flexible equality comparison for data frames</td>
<td></td>
<td></td>
<td>Two-table verbs</td>
</tr>
<tr class="even">
<td>all_vars() <br />any_vars()</td>
<td>Apply predicate to all variables</td>
<td></td>
<td></td>
<td>scoped-Operate on a selection of variables</td>
</tr>
<tr class="odd">
<td>arrange()</td>
<td>Arrange rows by variables</td>
<td>ORDER BY</td>
<td>13.1.4 (21)</td>
<td>Basic single-table verbs</td>
</tr>
<tr class="even">
<td>arrange_all() <br />arrange_at() <br />arrange_if()</td>
<td>Arrange rows by a selection of variables</td>
<td>ORDER BY</td>
<td></td>
<td>scoped-Operate on a selection of variables</td>
</tr>
<tr class="odd">
<td>auto_copy()</td>
<td>Copy tables to same source, if necessary</td>
<td></td>
<td></td>
<td>Remote tables</td>
</tr>
<tr class="even">
<td>between()</td>
<td>Do values in a numeric vector fall in specified range?</td>
<td></td>
<td></td>
<td>Vector functions</td>
</tr>
<tr class="odd">
<td>bind_rows() <br />bind_cols() <br />combine()</td>
<td>Efficiently bind multiple data frames by row and column</td>
<td></td>
<td></td>
<td>Two-table verbs</td>
</tr>
<tr class="even">
<td>case_when()</td>
<td>A general vectorised if</td>
<td></td>
<td></td>
<td>Vector functions</td>
</tr>
<tr class="odd">
<td>coalesce()</td>
<td>Find first non-missing element</td>
<td></td>
<td></td>
<td>Vector functions</td>
</tr>
<tr class="even">
<td>compute() <br />collect() <br />collapse()</td>
<td>Force computation of a database query</td>
<td></td>
<td></td>
<td>Remote tables</td>
</tr>
<tr class="odd">
<td>copy_to()</td>
<td>Copy a local data frame to a remote src</td>
<td></td>
<td></td>
<td>Remote tables</td>
</tr>
<tr class="even">
<td>cumall() <br />cumany() <br />cummean()</td>
<td>Cumulativate versions of any, all, and mean</td>
<td></td>
<td></td>
<td>Vector functions</td>
</tr>
<tr class="odd">
<td>desc()</td>
<td>Descending order</td>
<td></td>
<td></td>
<td>Vector functions</td>
</tr>
<tr class="even">
<td>distinct()</td>
<td>Return rows with matching conditions</td>
<td>SELECT distinct *</td>
<td></td>
<td>Basic single-table verbs</td>
</tr>
<tr class="odd">
<td>distinct()</td>
<td>Select distinct/unique rows</td>
<td>SELECT distinct {colname1,…colnamen}</td>
<td></td>
<td>Basic single-table verbs</td>
</tr>
<tr class="even">
<td>do()</td>
<td>Do anything</td>
<td>NA</td>
<td></td>
<td>Basic single-table verbs</td>
</tr>
<tr class="odd">
<td>explain() <br />show_query()</td>
<td>Explain details of a tbl</td>
<td></td>
<td></td>
<td>Remote tables</td>
</tr>
<tr class="even">
<td>filter_all() <br />filter_if() <br />filter_at()</td>
<td>Filter within a selection of variables</td>
<td></td>
<td></td>
<td>scoped-Operate on a selection of variables</td>
</tr>
<tr class="odd">
<td>funs()</td>
<td>Create a list of functions calls.</td>
<td></td>
<td></td>
<td>scoped-Operate on a selection of variables</td>
</tr>
<tr class="even">
<td>group_by() <br />ungroup()</td>
<td>Objects exported from other packages</td>
<td>GROUP BY no ungroup</td>
<td></td>
<td>Basic single-table verbs</td>
</tr>
<tr class="odd">
<td>group_by_all() group_by_at() group_by_if()</td>
<td>Group by a selection of variables</td>
<td></td>
<td></td>
<td>scoped-Operate on a selection of variables</td>
</tr>
<tr class="even">
<td>groups() <br />group_vars()</td>
<td>Return grouping variables</td>
<td></td>
<td></td>
<td>Metadata</td>
</tr>
<tr class="odd">
<td>ident()</td>
<td>Flag a character vector as SQL identifiers</td>
<td></td>
<td></td>
<td>Remote tables</td>
</tr>
<tr class="even">
<td>if_else()</td>
<td>Vectorised if</td>
<td></td>
<td></td>
<td>Vector functions</td>
</tr>
<tr class="odd">
<td>inner_join() <br />left_join() <br />right_join() <br />full_join() <br />semi_join() <br />anti_join()</td>
<td>Join two tbls together</td>
<td></td>
<td></td>
<td>Two-table verbs</td>
</tr>
<tr class="even">
<td>inner_join(<tbl_df>)<br />left_join(<tbl_df>) <br />right_join(<tbl_df>) <br />full_join(<tbl_df>) <br />semi_join(<tbl_df>) <br />anti_join(<tbl_df>)</td>
<td>Join data frame tbls</td>
<td></td>
<td></td>
<td>Two-table verbs</td>
</tr>
<tr class="odd">
<td>intersect() <br />union() <br />union_all() <br />setdiff() <br />setequal()</td>
<td>Set operations</td>
<td></td>
<td></td>
<td>Two-table verbs</td>
</tr>
<tr class="even">
<td>lead() lag()</td>
<td>Lead and lag.</td>
<td></td>
<td></td>
<td>Vector functions</td>
</tr>
<tr class="odd">
<td>mutate() <br />transmute()</td>
<td>Add new variables</td>
<td>SELECT computed_value computed_name</td>
<td>11.5.2 (13)</td>
<td>Basic single-table verbs</td>
</tr>
<tr class="even">
<td>n()</td>
<td>The number of observations in the current group.</td>
<td></td>
<td></td>
<td>Vector functions</td>
</tr>
<tr class="odd">
<td>n_distinct()</td>
<td>Efficiently count the number of unique values in a set of vector</td>
<td></td>
<td></td>
<td>Vector functions</td>
</tr>
<tr class="even">
<td>na_if()</td>
<td>Convert values to NA</td>
<td></td>
<td></td>
<td>Vector functions</td>
</tr>
<tr class="odd">
<td>near()</td>
<td>Compare two numeric vectors</td>
<td></td>
<td></td>
<td>Vector functions</td>
</tr>
<tr class="even">
<td>nth() <br />first() <br />last()</td>
<td>Extract the first, last or nth value from a vector</td>
<td></td>
<td></td>
<td>Vector functions</td>
</tr>
<tr class="odd">
<td>order_by()</td>
<td>A helper function for ordering window function output</td>
<td></td>
<td></td>
<td>Vector functions</td>
</tr>
<tr class="even">
<td>pull()</td>
<td>Pull out a single variable</td>
<td>SELECT column_name;</td>
<td></td>
<td>Basic single-table verbs</td>
</tr>
<tr class="odd">
<td>recode() <br />recode_factor()</td>
<td>Recode values</td>
<td></td>
<td></td>
<td>Vector functions</td>
</tr>
<tr class="even">
<td>row_number() <br />ntile() <br />min_rank() <br />dense_rank() percent_rank() <br />cume_dist()</td>
<td>Windowed rank functions.</td>
<td></td>
<td></td>
<td>Vector functions</td>
</tr>
<tr class="odd">
<td>rowwise()</td>
<td>Group input by rows</td>
<td></td>
<td></td>
<td>Other backends</td>
</tr>
<tr class="even">
<td>sample_n() <br />sample_frac()</td>
<td>Sample n rows from a table</td>
<td>ORDER BY RANDOM() LIMIT 10</td>
<td></td>
<td>Basic single-table verbs</td>
</tr>
<tr class="odd">
<td>select() <br />rename()</td>
<td>Select/rename variables by name</td>
<td>SELECT column_name alias_name</td>
<td>9.1.8 (11)</td>
<td>Basic single-table verbs</td>
</tr>
<tr class="even">
<td>select_all() <br />rename_all() <br />select_if() <br />rename_if() <br />select_at() <br />rename_at()</td>
<td>Select and rename a selection of variables</td>
<td></td>
<td></td>
<td>scoped-Operate on a selection of variables</td>
</tr>
<tr class="odd">
<td>slice()</td>
<td>Select rows by position</td>
<td>SELECT row_number() over (partition by expression(s) order_by exp)</td>
<td></td>
<td>Basic single-table verbs</td>
</tr>
<tr class="even">
<td>sql()</td>
<td>SQL escaping.</td>
<td></td>
<td></td>
<td>Remote tables</td>
</tr>
<tr class="odd">
<td>src_mysql() <br />src_postgres() <br />src_sqlite()</td>
<td>Source for database backends</td>
<td></td>
<td></td>
<td>Remote tables</td>
</tr>
<tr class="even">
<td>summarise_all() summarise_if() summarise_at() summarize_all() summarize_if() summarize_at() mutate_all() <br />mutate_if() <br />mutate_at() transmute_all() transmute_if() transmute_at()</td>
<td>Summarise and mutate multiple columns.</td>
<td></td>
<td></td>
<td>scoped-Operate on a selection of variables</td>
</tr>
<tr class="odd">
<td>summarize()</td>
<td>Reduces multiple values down to a single value</td>
<td>SELECT aggregate_functions GROUP BY</td>
<td>11.5.1 (13)</td>
<td>Basic single-table verbs</td>
</tr>
<tr class="even">
<td>tally()<br /> count()<br />add_tally() <br />add_count()</td>
<td>Count/tally observations by group</td>
<td>GROUP BY</td>
<td>9.1.6 (11)</td>
<td>Single-table helpers</td>
</tr>
<tr class="odd">
<td>tbl() <br />is.tbl() <br />as.tbl()</td>
<td>Create a table from a data source</td>
<td></td>
<td></td>
<td>Remote tables</td>
</tr>
<tr class="even">
<td>top_n()</td>
<td>Select top (or bottom) n rows (by value)</td>
<td>ORDER BY VALUE {DESC} LIMIT 10</td>
<td></td>
<td>Single-table helpers</td>
</tr>
<tr class="odd">
<td>vars()</td>
<td>Select variables</td>
<td></td>
<td></td>
<td>scoped-Operate on a selection of variables</td>
</tr>
</tbody>
</table>
<!--chapter:end:970-dplyr-sql-summary-table.Rmd-->
</div>
<div id="chapter_appendix-dbi-functions" class="section level1">
<h1><span class="header-section-number">38</span> DBI package functions - coverage</h1>
<p>Where are these covered and should the by included?</p>
<table>
<colgroup>
<col width="17%" />
<col width="11%" />
<col width="70%" />
</colgroup>
<thead>
<tr class="header">
<th>DBI</th>
<th>1st time</th>
<th>Call Example/Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>DBIConnct</td>
<td>6.3.2 (04)</td>
<td>in sp_get_postgres_connection</td>
</tr>
<tr class="even">
<td>dbAppendTable</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>dbCreateTable</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>dbDisconnect</td>
<td>6.4n (04)</td>
<td>dbDisconnect(con)</td>
</tr>
<tr class="odd">
<td>dbExecute</td>
<td>10.4.2 (13)</td>
<td>Executes a statement and returns the number of rows affected. dbExecute() comes with a default implementation (which should work with most backends) that calls dbSendStatement(), then dbGetRowsAffected(), ensuring that the result is always free-d by dbClearResult().</td>
</tr>
<tr class="even">
<td>dbExistsTable</td>
<td></td>
<td>dbExistsTable(con,‘actor’)</td>
</tr>
<tr class="odd">
<td>dbFetch</td>
<td>17.1 (72)</td>
<td>dbFetch(rs)</td>
</tr>
<tr class="even">
<td>dbGetException</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>dbGetInfo</td>
<td></td>
<td>dbGetInfo(con)</td>
</tr>
<tr class="even">
<td>dbGetQuery</td>
<td>10.4.1 (13)</td>
<td>dbGetQuery(con,‘select * from store;’)</td>
</tr>
<tr class="odd">
<td>dbIsReadOnly</td>
<td></td>
<td>dbIsReadOnly(con)</td>
</tr>
<tr class="even">
<td>dbIsValid</td>
<td></td>
<td>dbIsValid(con)</td>
</tr>
<tr class="odd">
<td>dbListFields</td>
<td>6.3.3 (04)</td>
<td>DBI::dbListFields(con, “mtcars”)</td>
</tr>
<tr class="even">
<td>dbListObjects</td>
<td></td>
<td>dbListObjects(con)</td>
</tr>
<tr class="odd">
<td>dbListTables</td>
<td>6.3.2 (04)</td>
<td>DBI::dbListTables(con, con)</td>
</tr>
<tr class="even">
<td>dbReadTable</td>
<td>8.1.2</td>
<td>DBI::dbReadTable(con, “rental”)</td>
</tr>
<tr class="odd">
<td>dbRemoveTable</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>dbSendQuery</td>
<td>17.1 (72)</td>
<td>rs &lt;- dbSendQuery(con, “SELECT * FROM mtcars WHERE cyl = 4”)</td>
</tr>
<tr class="odd">
<td>dbSendStatement</td>
<td></td>
<td>The dbSendStatement() method only submits and synchronously executes the SQL data manipulation statement (e.g., UPDATE, DELETE, INSERT INTO, DROP TABLE, …) to the database engine.</td>
</tr>
<tr class="even">
<td>dbWriteTable</td>
<td>6.3.3 (04)</td>
<td>dbWriteTable(con, “mtcars”, mtcars, overwrite = TRUE)</td>
</tr>
</tbody>
</table>
<!--chapter:end:980-dbi-summary-table.Rmd-->
</div>
<div id="chapter_appendix-additional-resources" class="section level1">
<h1><span class="header-section-number">39</span> Appendix Additional resources</h1>
<div id="editing-this-book" class="section level2">
<h2><span class="header-section-number">39.1</span> Editing this book</h2>
<ul>
<li>Here are instructions for <a href="https://github.com/smithjd/sql-pet/blob/master/Contributing.md">editing this book</a></li>
</ul>
</div>
<div id="docker-alternatives" class="section level2">
<h2><span class="header-section-number">39.2</span> Docker alternatives</h2>
<ul>
<li>Choosing <a href="https://medium.com/@Mahmoud_Zalt/vagrant-vs-docker-679c9ce4231b">between Docker and Vagrant</a> <span class="citation">(Zait <a href="#ref-Zait2017">2017</a>)</span></li>
</ul>
</div>
<div id="docker-and-r" class="section level2">
<h2><span class="header-section-number">39.3</span> Docker and R</h2>
<ul>
<li>Noam Ross’ <a href="https://www.youtube.com/watch?v=803oZI5dvAU&amp;t=1">talk on Docker for the UseR</a> <span class="citation">(Ross <a href="#ref-Ross2018">2018</a><a href="#ref-Ross2018">b</a>)</span> and his <a href="https://github.com/noamross/nyhackr-docker-talk">Slides</a> <span class="citation">(Ross <a href="#ref-Ross2018a">2018</a><a href="#ref-Ross2018a">a</a>)</span> give a lot of context and tips.</li>
<li>Good Docker tutorials
<ul>
<li><a href="https://docker-curriculum.com/">An introductory Docker tutorial</a> <span class="citation">(Srivastav <a href="#ref-Srivastav2018">2018</a>)</span></li>
<li><a href="https://katacoda.com/courses/docker">A Docker curriculum</a> <span class="citation">(Hall <a href="#ref-Hall2018">2018</a>)</span></li>
</ul></li>
<li>Scott Came’s materials about Docker and R <a href="http://www.cascadia-analytics.com/2018/07/21/docker-r-p1.html">on his website</a> <span class="citation">(Came <a href="#ref-Came2018">2018</a>)</span> and at the 2018 UseR Conference focus on <strong>R inside Docker</strong>.</li>
<li>It’s worth studying the <a href="https://ropenscilabs.github.io/r-docker-tutorial/">ROpensci Docker tutorial</a> <span class="citation">(ROpenSciLabs <a href="#ref-ROpenSciLabs2018">2018</a>)</span></li>
</ul>
</div>
<div id="documentation-for-docker-and-postgresql" class="section level2">
<h2><span class="header-section-number">39.4</span> Documentation for Docker and PostgreSQL</h2>
<ul>
<li><a href="https://docs.docker.com/samples/library/postgres/">The Postgres image documentation</a> <span class="citation">(Docker <a href="#ref-Docker2018">2018</a><a href="#ref-Docker2018">d</a>)</span></li>
<li>PostgreSQL &amp; Docker <a href="https://docs.docker.com/samples/library/postgres/#postgres_db">documentation</a> <span class="citation">(Docker <a href="#ref-Docker2018">2018</a><a href="#ref-Docker2018">d</a>)</span></li>
<li><a href="https://docs.docker.com/engine/examples/postgresql_service/">Dockerize PostgreSQL</a> <span class="citation">(Docker <a href="#ref-Docker2018a">2018</a><a href="#ref-Docker2018a">b</a>)</span></li>
<li>Usage examples of <a href="https://amattn.com/p/tutorial_postgresql_usage_examples_with_docker.html">PostgreSQL with Docker</a> WARNING-EXPIRED CERTIFICATE 2018-12-20</li>
</ul>
</div>
<div id="sql-and-dplyr" class="section level2">
<h2><span class="header-section-number">39.5</span> SQL and dplyr</h2>
<ul>
<li><a href="https://blog.exploratory.io/why-sql-is-not-for-analysis-but-dplyr-is-5e180fef6aa7">Why SQL is not for analysis but dplyr is</a> <span class="citation">(Nishida <a href="#ref-Nishida2016">2016</a>)</span></li>
<li><a href="https://www.listendata.com/2016/08/dplyr-tutorial.html">Data Manipulation with dplyr (With 50 Examples)</a> <span class="citation">(ListenData.com <a href="#ref-ListenData.com2016">2016</a>)</span></li>
</ul>
</div>
<div id="more-resources" class="section level2">
<h2><span class="header-section-number">39.6</span> More Resources</h2>
<ul>
<li>David Severski describes some <a href="https://github.com/davidski/database_connections">key elements of connecting to databases with R</a> for MacOS users <span class="citation">(Severski <a href="#ref-Severski2018">2018</a>)</span></li>
<li>This tutorial picks up ideas and tips from Ed Borasky’s <a href="https://github.com/znmeb/data-science-pet-containers">Data Science pet containers</a> <span class="citation">(Borasky <a href="#ref-Borasky2018">2018</a>)</span>, which creates a framework based on that <a href="https://github.com/hackoregon/data-science-pet-containers">Hack Oregon example</a> and explains why this repo is named pet-sql.</li>
</ul>
<!--chapter:end:997-additional-resources.Rmd-->
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1>References</h1>
<!--chapter:end:999-references.Rmd-->
<div id="refs" class="references">
<div id="ref-Baumer2018">
<p>Baumer, Benjamin S. 2018. “A Grammar for Reproducible and Painless Extract-Transform-Load Operations on Medium Data.” <em>Journal of Computational and Graphical Statistics</em>, August. Informa UK Limited, 1–9. <a href="https://doi.org/10.1080/10618600.2018.1512867">https://doi.org/10.1080/10618600.2018.1512867</a>.</p>
</div>
<div id="ref-Borasky2018">
<p>Borasky, M. Edward (Ed). 2018. “Data Science Pet Containers.” 2018. <a href="https://github.com/znmeb/data-science-pet-containers">https://github.com/znmeb/data-science-pet-containers</a>.</p>
</div>
<div id="ref-Borasky2018a">
<p>Borasky, M. Edward (Ed), John David Smith, Scott Came, Jim Tyhurst, Dipti Muni, Mary Anne Thygesen, Sophie Yang, and Ian Frantz. 2018. <em>Sqlpetr: Companion Package for R-Docker-Databases Book</em>. <a href="https://github.com/smithjd/sqlpetr">https://github.com/smithjd/sqlpetr</a>.</p>
</div>
<div id="ref-Came2018">
<p>Came, Scott. 2018. “Running R in Docker - Part 1 - Getting Started.” July 21, 2018. <a href="http://www.cascadia-analytics.com/2018/07/21/docker-r-p1.html">http://www.cascadia-analytics.com/2018/07/21/docker-r-p1.html</a>.</p>
</div>
<div id="ref-R-downloader">
<p>Chang, Winston. 2015. <em>Downloader: Download Files over Http and Https</em>. <a href="https://CRAN.R-project.org/package=downloader">https://CRAN.R-project.org/package=downloader</a>.</p>
</div>
<div id="ref-Docker2018b">
<p>Docker. 2018a. “Docker CE Supported Platforms.” 2018. <a href="https://docs.docker.com/install/#supported-platforms">https://docs.docker.com/install/#supported-platforms</a>.</p>
</div>
<div id="ref-Docker2018a">
<p>———. 2018b. “Dockerize Postgresql | Docker Documentation.” 2018. <a href="https://docs.docker.com/engine/examples/postgresql_service/">https://docs.docker.com/engine/examples/postgresql_service/</a>.</p>
</div>
<div id="ref-Docker2018c">
<p>———. 2018c. “Install Docker for Mac.” 2018. <a href="https://docs.docker.com/docker-for-mac/install/">https://docs.docker.com/docker-for-mac/install/</a>.</p>
</div>
<div id="ref-Docker2018">
<p>———. 2018d. “Postgres | Docker Documentation.” 2018. <a href="https://docs.docker.com/samples/library/postgres/">https://docs.docker.com/samples/library/postgres/</a>.</p>
</div>
<div id="ref-Docker2019a">
<p>———. 2019a. “Docker Documentation.” 2019. <a href="https://docs.docker.com/">https://docs.docker.com/</a>.</p>
</div>
<div id="ref-Docker2019e">
<p>———. 2019b. “Install Docker for Mac.” 2019. <a href="https://docs.docker.com/docker-for-mac/install/">https://docs.docker.com/docker-for-mac/install/</a>.</p>
</div>
<div id="ref-Docker2019c">
<p>———. 2019c. “Install Docker for Windows.” 2019. <a href="https://docs.docker.com/docker-for-windows/install/">https://docs.docker.com/docker-for-windows/install/</a>.</p>
</div>
<div id="ref-Docker2019d">
<p>———. 2019d. “Install Docker Toolbox on macOS.” 2019. <a href="https://docs.docker.com/toolbox/toolbox_install_mac/">https://docs.docker.com/toolbox/toolbox_install_mac/</a>.</p>
</div>
<div id="ref-Docker2019b">
<p>———. 2019e. “Install Docker Toolbox on Windows.” 2019. <a href="https://docs.docker.com/toolbox/toolbox_install_windows/">https://docs.docker.com/toolbox/toolbox_install_windows/</a>.</p>
</div>
<div id="ref-Hall2018">
<p>Hall, Ben. 2018. “Learn Docker &amp; Containers Using Interactive Browser-Based Scenarios.” 2018. <a href="https://katacoda.com/courses/docker">https://katacoda.com/courses/docker</a>.</p>
</div>
<div id="ref-R-glue">
<p>Hester, Jim. 2018. <em>Glue: Interpreted String Literals</em>. <a href="https://CRAN.R-project.org/package=glue">https://CRAN.R-project.org/package=glue</a>.</p>
</div>
<div id="ref-R-DiagrammeR">
<p>Iannone, Richard. 2018. <em>DiagrammeR: Graph/Network Visualization</em>. <a href="https://CRAN.R-project.org/package=DiagrammeR">https://CRAN.R-project.org/package=DiagrammeR</a>.</p>
</div>
<div id="ref-ListenData.com2016">
<p>ListenData.com. 2016. “Data Manipulation with Dplyr (with 50 Examples).” 2016. <a href="https://www.listendata.com/2016/08/dplyr-tutorial.html">https://www.listendata.com/2016/08/dplyr-tutorial.html</a>.</p>
</div>
<div id="ref-Makubuya2018">
<p>Makubuya, Aaron. 2018. “Using R with Databases.” 2018. <a href="https://github.com/Cascadia-R/Using_R_With_Databases">https://github.com/Cascadia-R/Using_R_With_Databases</a>.</p>
</div>
<div id="ref-R-skimr">
<p>McNamara, Amelia, Eduardo Arino de la Rubia, Hao Zhu, Shannon Ellis, and Michael Quinn. 2019. <em>Skimr: Compact and Flexible Summaries of Data</em>. <a href="https://CRAN.R-project.org/package=skimr">https://CRAN.R-project.org/package=skimr</a>.</p>
</div>
<div id="ref-R-here">
<p>Müller, Kirill. 2017. <em>Here: A Simpler Way to Find Your Files</em>. <a href="https://CRAN.R-project.org/package=here">https://CRAN.R-project.org/package=here</a>.</p>
</div>
<div id="ref-Nishida2016">
<p>Nishida, Kan. 2016. “Why Sql Is Not for Analysis, but Dplyr Is.” August 5, 2016. <a href="https://blog.exploratory.io/why-sql-is-not-for-analysis-but-dplyr-is-5e180fef6aa7">https://blog.exploratory.io/why-sql-is-not-for-analysis-but-dplyr-is-5e180fef6aa7</a>.</p>
</div>
<div id="ref-PGDG2018a">
<p>PostgreSQL Global Development Group. 2018a. “Chapter 20. Client Authentication.” 2018. <a href="https://www.postgresql.org/docs/10/client-authentication.html">https://www.postgresql.org/docs/10/client-authentication.html</a>.</p>
</div>
<div id="ref-PGDG2018c">
<p>———. 2018b. “Chapter 21. Database Roles.” 2018. <a href="https://www.postgresql.org/docs/10/user-manag.html">https://www.postgresql.org/docs/10/user-manag.html</a>.</p>
</div>
<div id="ref-PGDG2018b">
<p>———. 2018c. “Password Authentication.” 2018. <a href="https://www.postgresql.org/docs/10/auth-methods.html#AUTH-PASSWORD">https://www.postgresql.org/docs/10/auth-methods.html#AUTH-PASSWORD</a>.</p>
</div>
<div id="ref-RCT2018">
<p>R Core Team. 2018. <em>R: A Language and Environment for Statistical Computing</em>. Vienna, Austria: R Foundation for Statistical Computing. <a href="https://www.R-project.org/">https://www.R-project.org/</a>.</p>
</div>
<div id="ref-ROpenSciLabs2018">
<p>ROpenSciLabs. 2018. “R Docker Tutorial.” September 13, 2018. <a href="http://ropenscilabs.github.io/r-docker-tutorial/">http://ropenscilabs.github.io/r-docker-tutorial/</a>.</p>
</div>
<div id="ref-Ross2018a">
<p>Ross, Noam. 2018a. “Docker for the UseR - Slides.” July 10, 2018. <a href="https://github.com/noamross/nyhackr-docker-talk/blob/master/Noam_Ross_DockerForTheUseR_nyhackr_2018-07-10.pdf">https://github.com/noamross/nyhackr-docker-talk/blob/master/Noam_Ross_DockerForTheUseR_nyhackr_2018-07-10.pdf</a>.</p>
</div>
<div id="ref-Ross2018">
<p>———. 2018b. “Docker for the UseR - Video.” July 10, 2018. <a href="https://www.youtube.com/watch?v=803oZI5dvAU">https://www.youtube.com/watch?v=803oZI5dvAU</a>.</p>
</div>
<div id="ref-R-DBI">
<p>R Special Interest Group on Databases (R-SIG-DB), Hadley Wickham, and Kirill Müller. 2018. <em>DBI: R Database Interface</em>. <a href="https://CRAN.R-project.org/package=DBI">https://CRAN.R-project.org/package=DBI</a>.</p>
</div>
<div id="ref-RStudio2019">
<p>RStudio. 2019. “Tidyverse; R Packages for Data Science.” 2019. <a href="https://www.tidyverse.org">https://www.tidyverse.org</a>.</p>
</div>
<div id="ref-Ruiz2019">
<p>Ruiz, Edgar. 2019. “Big Data with R: RStudio 2019 Workshop.” RStudio. January 16, 2019. <a href="https://github.com/rstudio/bigdataclass">https://github.com/rstudio/bigdataclass</a>.</p>
</div>
<div id="ref-Severski2018">
<p>Severski, David. 2018. “Database Connections.” 2018. <a href="https://github.com/davidski/database_connections">https://github.com/davidski/database_connections</a>.</p>
</div>
<div id="ref-Srivastav2018">
<p>Srivastav, Prakhar. 2018. “A Docker Tutorial for Beginners.” 2018. <a href="https://docker-curriculum.com/">https://docker-curriculum.com/</a>.</p>
</div>
<div id="ref-Vargas2018">
<p>Vargas, Mauricio. 2018. “How to Install R on Windows, Mac Os X and Ubuntu.” May 17, 2018. <a href="https://www.datacamp.com/community/tutorials/installing-R-windows-mac-ubuntu">https://www.datacamp.com/community/tutorials/installing-R-windows-mac-ubuntu</a>.</p>
</div>
<div id="ref-Wickham2014">
<p>Wickham, Hadley. 2014. “Tidy Data.” <em>Journal of Statistical Software, Articles</em> 59 (10): 1–23. <a href="https://doi.org/10.18637/jss.v059.i10">https://doi.org/10.18637/jss.v059.i10</a>.</p>
</div>
<div id="ref-R-tidyverse">
<p>———. 2017. <em>Tidyverse: Easily Install and Load the ’Tidyverse’</em>. <a href="https://CRAN.R-project.org/package=tidyverse">https://CRAN.R-project.org/package=tidyverse</a>.</p>
</div>
<div id="ref-Wickham2018">
<p>———. 2018. “A Grammar of Data Manipulation • Dplyr.” <a href=""></a>. <a href="https://dplyr.tidyverse.org/">https://dplyr.tidyverse.org/</a>.</p>
</div>
<div id="ref-R-devtools">
<p>Wickham, Hadley, Jim Hester, and Winston Chang. 2018. <em>Devtools: Tools to Make Developing R Packages Easier</em>. <a href="https://CRAN.R-project.org/package=devtools">https://CRAN.R-project.org/package=devtools</a>.</p>
</div>
<div id="ref-R-RPostgres">
<p>Wickham, Hadley, Jeroen Ooms, and Kirill Müller. 2018. <em>RPostgres: ’Rcpp’ Interface to ’Postgresql’</em>. <a href="https://CRAN.R-project.org/package=RPostgres">https://CRAN.R-project.org/package=RPostgres</a>.</p>
</div>
<div id="ref-R-dbplyr">
<p>Wickham, Hadley, and Edgar Ruiz. 2019. <em>Dbplyr: A ’Dplyr’ Back End for Databases</em>. <a href="https://CRAN.R-project.org/package=dbplyr">https://CRAN.R-project.org/package=dbplyr</a>.</p>
</div>
<div id="ref-Wikipedia2019">
<p>Wikipedia. 2019. “Database Normalization.” 2019. <a href="https://en.wikipedia.org/wiki/Database_normalization">https://en.wikipedia.org/wiki/Database_normalization</a>.</p>
</div>
<div id="ref-Xie2016">
<p>Xie, Yihui. 2016. <em>Bookdown: Authoring Books and Technical Documents with R Markdown</em>. Boca Raton, Florida: Chapman; Hall/CRC. <a href="https://github.com/rstudio/bookdown">https://github.com/rstudio/bookdown</a>.</p>
</div>
<div id="ref-R-bookdown">
<p>———. 2018a. <em>Bookdown: Authoring Books and Technical Documents with R Markdown</em>. <a href="https://CRAN.R-project.org/package=bookdown">https://CRAN.R-project.org/package=bookdown</a>.</p>
</div>
<div id="ref-R-knitr">
<p>———. 2018b. <em>Knitr: A General-Purpose Package for Dynamic Report Generation in R</em>. <a href="https://CRAN.R-project.org/package=knitr">https://CRAN.R-project.org/package=knitr</a>.</p>
</div>
<div id="ref-Zait2017">
<p>Zait, Mahmoud. 2017. “Vagrant Vs Docker.” July 29, 2017. <a href="https://medium.com/@Mahmoud_Zalt/vagrant-vs-docker-679c9ce4231b">https://medium.com/@Mahmoud_Zalt/vagrant-vs-docker-679c9ce4231b</a>.</p>
</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p><a href="https://www.techopedia.com/definition/1245/structured-query-language-sql" class="uri">https://www.techopedia.com/definition/1245/structured-query-language-sql</a><a href="#fnref1" class="footnote-back">↩</a></p></li>
<li id="fn2"><p><a href="https://cran.r-project.org/doc/manuals/r-release/R-ints.html#Lazy-loading" class="uri">https://cran.r-project.org/doc/manuals/r-release/R-ints.html#Lazy-loading</a><a href="#fnref2" class="footnote-back">↩</a></p></li>
<li id="fn3"><p><a href="https://colinfay.me/lazyeval/" class="uri">https://colinfay.me/lazyeval/</a><a href="#fnref3" class="footnote-back">↩</a></p></li>
<li id="fn4"><p><a href="http://adv-r.had.co.nz/Functions.html#function-arguments" class="uri">http://adv-r.had.co.nz/Functions.html#function-arguments</a><a href="#fnref4" class="footnote-back">↩</a></p></li>
<li id="fn5"><p><a href="https://colinfay.me/tidyeval-1/" class="uri">https://colinfay.me/tidyeval-1/</a><a href="#fnref5" class="footnote-back">↩</a></p></li>
<li id="fn6"><p><a href="https://www.quora.com/What-is-a-lazy-query" class="uri">https://www.quora.com/What-is-a-lazy-query</a><a href="#fnref6" class="footnote-back">↩</a></p></li>
<li id="fn7"><p>From R’s perspective. Actually there are 4 steps behind the scenes.<a href="#fnref7" class="footnote-back">↩</a></p></li>
</ol>
</div>
<!--bookdown:body:end-->
            </section>

          </div>
        </div>
      </div>
<!--bookdown:link_prev-->
<!--bookdown:link_next-->
    </div>
  </div>
<!--bookdown:config-->

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
